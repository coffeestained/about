/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import t from"../config.js";import e from"./Error.js";import{L as n}from"../chunks/Logger.js";import{b as r,i as o,a as s}from"../chunks/maybe.js";import"./lang.js";import"../chunks/object.js";import"../chunks/string.js";const i=n.getLogger("esri.core.urlUtils"),u=t.request,c="esri/config: esriConfig.request.proxyUrl is not set.",l=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,f=/^\s*http:/i,a=/^\s*https:/i,h=/^\s*file:/i,p=/:\d+$/,d=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,g=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),m=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");class y{constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let e=r(this.uri.match(g));this.scheme=e[2]||(e[1]?"":null),this.authority=e[4]||(e[3]?"":null),this.path=e[5],this.query=e[7]||(e[6]?"":null),this.fragment=e[9]||(e[8]?"":null),null!=this.authority&&(e=r(this.authority.match(m)),this.user=e[3]||null,this.password=e[4]||null,this.host=e[6]||e[7],this.port=e[9]||null)}toString(){return this.uri}}const $={},x=new y(t.applicationUrl);let w=x;const O=function(){const t=r(w.path),e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${w.scheme}://${w.host}${null!=w.port?`:${w.port}`:""}${e}`}();let b=O;const U=()=>w,C=()=>b,q={setAppUrl:t=>w=t,setAppBaseUrl:t=>b=t,restoreUrls:()=>{w=x,b=O}};function R(t){const e={path:null,query:null},n=new y(t),r=t.indexOf("?");return null===n.query?e.path=t:(e.path=t.substring(0,r),e.query=j(n.query)),n.fragment&&(e.hash=n.fragment,null===n.query&&(e.path=e.path.substring(0,e.path.length-(n.fragment.length+1)))),e}function j(t){const e=t.split("&"),n={};for(const t of e){if(!t)continue;const e=t.indexOf("=");let r,o;e<0?(r=decodeURIComponent(t),o=""):(r=decodeURIComponent(t.slice(0,e)),o=decodeURIComponent(t.slice(e+1)));let s=n[r];"string"==typeof s&&(s=n[r]=[s]),Array.isArray(s)?s.push(o):n[r]=o}return n}function v(t){return t&&"object"==typeof t&&"toJSON"in t&&"function"==typeof t.toJSON}function L(t,e){return t?e&&"function"==typeof e?Object.keys(t).map((n=>encodeURIComponent(n)+"="+encodeURIComponent(e(n,t[n])))).join("&"):Object.keys(t).map((n=>{const r=t[n];if(null==r)return"";const o=encodeURIComponent(n)+"=",s=e&&e[n];return s?o+encodeURIComponent(s(r)):Array.isArray(r)?r.map((t=>v(t)?o+encodeURIComponent(JSON.stringify(t)):o+encodeURIComponent(t))).join("&"):v(r)?o+encodeURIComponent(JSON.stringify(r)):o+encodeURIComponent(r)})).filter((t=>t)).join("&"):""}function I(t=!1){let n,r=u.proxyUrl;if("string"==typeof t){n=ct(t);const e=E(t);e&&(r=e.proxyUrl)}else n=!!t;if(!r)throw i.warn(c),new e("urlutils:proxy-not-set",c);return n&&at()&&(r=ft(r)),R(r)}function k(t){const e=E(t);let n,r;if(e){const t=S(e.proxyUrl);n=t.path,r=t.query?j(t.query):null}if(n){const e=R(t);t=n+"?"+e.path;const o=L({...r,...e.query});o&&(t=`${t}?${o}`)}return t}const A={path:"",query:""};function S(t){const e=t.indexOf("?");return-1!==e?(A.path=t.slice(0,e),A.query=t.slice(e+1)):(A.path=t,A.query=null),A}function B(t){return(t=ht((e=t=S(t).path,t=e&&"/"===e[e.length-1]?e:`${e}/`),!0)).toLowerCase();var e}function P(t){const e={proxyUrl:t.proxyUrl,urlPrefix:B(t.urlPrefix)},n=u.proxyRules,r=e.urlPrefix;let o=n.length;for(let t=0;t<n.length;t++){const e=n[t].urlPrefix;if(0===r.indexOf(e)){if(r.length===e.length)return-1;o=t;break}0===e.indexOf(r)&&(o=t+1)}return n.splice(o,0,e),o}function E(t){const e=u.proxyRules,n=B(t);for(let t=0;t<e.length;t++)if(0===n.indexOf(e[t].urlPrefix))return e[t]}function J(t,e){return t=N(t),e=N(e),ht(t)===ht(e)}function N(t){const e=(t=Q(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function T(t){const e=e=>null==e||e instanceof RegExp&&e.test(t)||"string"==typeof e&&t.startsWith(e),n=u.interceptors;if(n)for(const t of n)if(Array.isArray(t.urls)){if(t.urls.some(e))return t}else if(e(t.urls))return t;return null}function W(t,e,n=!1){const r=yt(t),o=yt(e);return!(!n&&r.scheme!==o.scheme)&&null!=r.host&&null!=o.host&&r.host.toLowerCase()===o.host.toLowerCase()&&r.port===o.port}function z(t){if("string"==typeof t){if(!G(t))return!0;t=yt(t)}if(W(t,w))return!0;const e=u.trustedServers||[];for(let r=0;r<e.length;r++){const o=(n=e[r],$[n]||(ut(n)||it(n)?$[n]=[new y(D(n))]:$[n]=[new y(`http://${n}`),new y(`https://${n}`)]),$[n]);for(let e=0;e<o.length;e++)if(W(t,o[e]))return!0}var n;return!1}function D(t,e=b,n){return it(t)?n&&n.preserveProtocolRelative?t:"http"===w.scheme&&w.authority===F(t).slice(2)?`http:${t}`:`https:${t}`:ut(t)?t:r(_("/"===t[0]?function(t){const e=t.indexOf("//"),n=t.indexOf("/",e+2);return-1===n?t:t.slice(0,n)}(e):e,t))}function M(t,e=b,n){if(!G(t))return t;const r=Q(t),o=r.toLowerCase(),s=Q(e).toLowerCase().replace(/\/+$/,""),i=n?Q(n).toLowerCase().replace(/\/+$/,""):null;if(i&&0!==s.indexOf(i))return t;const u=(t,e,n)=>-1===(n=t.indexOf(e,n))?t.length:n;let c=u(o,"/",o.indexOf("//")+2),l=-1;for(;o.slice(0,c+1)===s.slice(0,c)+"/"&&(l=c+1,c!==o.length);)c=u(o,"/",c+1);if(-1===l)return t;if(i&&l<i.length)return t;t=r.slice(l);const f=s.slice(l-1).replace(/[^/]+/g,"").length;if(f>0)for(let e=0;e<f;e++)t=`../${t}`;else t=`./${t}`;return t}function Q(t){return function(t){const e=u.httpsDomains;if(!function(t){return f.test(t)||"http"===w.scheme&&it(t)}(t))return t;const n=t.indexOf("/",7);let r;if(r=-1===n?t:t.slice(0,n),r=r.toLowerCase().slice(7),p.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}return"http"!==w.scheme||r!==w.authority||d.test(t)?((at()&&r===w.authority||e&&e.some((t=>r===t||r.endsWith(`.${t}`)))||at()&&!E(t))&&(t=ft(t)),t):t}(t=function(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}(t=function(t){if(/^https?:\/\//i.test(t)){const e=S(t);t=(t=e.path.replace(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}(t=D(t=t.trim()))))}function _(...t){const e=t.filter(o);if(!e||!e.length)return;const n=[];if(G(e[0])){const t=e[0],o=t.indexOf("//");-1!==o&&(n.push(t.slice(0,o+1)),r=e[0],h.test(r)&&(n[0]+="/"),e[0]=t.slice(o+2))}else"/"===e[0][0]&&n.push("");var r;const s=e.reduce(((t,e)=>e?t.concat(e.split("/")):t),[]);for(let t=0;t<s.length;t++){const e=s[t];".."===e&&n.length>0&&".."!==n[n.length-1]?n.pop():(!e&&t===s.length-1||e&&("."!==e||0===n.length))&&n.push(e)}return n.join("/")}function F(t,e=!1){if(H(t)||K(t))return null;let n=t.indexOf("://");if(-1===n&&it(t))n=2;else{if(-1===n)return null;n+=3}const r=t.indexOf("/",n);return-1!==r&&(t=t.slice(0,r)),e&&(t=ht(t,!0)),t}function G(t){return it(t)||ut(t)}function H(t){return null!=t&&"blob:"===t.slice(0,5)}function K(t){return"data:"===t.slice(0,5)}function V(t){const e=Z(t);if(!e||!e.isBase64)return null;const n=atob(e.data),r=new Uint8Array(n.length);for(let t=0;t<n.length;t++)r[t]=n.charCodeAt(t);return r.buffer}function X(t){return btoa(String.fromCharCode.apply(null,t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const Y=/^data:(.*?)(;base64)?,(.*)$/;function Z(t){const e=t.match(Y);if(!e)return null;const[,n,r,o]=e;return{mediaType:n,isBase64:!!r,data:o}}function tt(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}function et(t){const e=V(t);if(!e)return null;const n=Z(t);return new Blob([e],{type:n.mediaType})}function nt(t,e){(function(t,e){const n=et(t);return!!n&&ot(n,e)})(t,e)||function(t,e){const n=et(t);if(!n)return!1;st(n,e)}(t,e)}function rt(t,e){ot(t,e)||st(t,e)}function ot(t,e){if(!t)return!1;const n=document.createElement("a");if(!("download"in n))return!1;const r=URL.createObjectURL(t);return n.download=e,n.href=r,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),!0}function st(t,e){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(t,e)}function it(t){return null!=t&&void 0!==t&&"/"===t[0]&&"/"===t[1]}function ut(t){return l.test(t)}function ct(t){return a.test(t)||"https"===w.scheme&&it(t)}function lt(t){return it(t)?`http:${t}`:t.replace(a,"http:")}function ft(t){return it(t)?`https:${t}`:t.replace(f,"https:")}function at(){return"https"===w.scheme}function ht(t,e=!1){return it(t)?t.slice(2):(t=t.replace(l,""),e&&t.length>1&&"/"===t[0]&&"/"===t[1]&&(t=t.slice(2)),t)}function pt(t){let e=0;if(G(t)){const n=t.indexOf("//");-1!==n&&(e=n+2)}const n=t.lastIndexOf("/");return n<e?t:t.slice(0,n+1)}function dt(t,e){if(!t)return"";const n=R(t).path.replace(/\/+$/,""),r=n.substring(n.lastIndexOf("/")+1);if(!e?.length)return r;const o=new RegExp(`.(${e.join("|")})$`,"ig");return r.replace(o,"")}function gt(t){return t.replace(/\/+$/,"")}function mt(t,e,n){if(!(e&&n&&t&&G(t)))return t;const r=t.indexOf("//"),o=t.indexOf("/",r+2),s=t.indexOf(":",r+2),i=Math.min(o<0?t.length:o,s<0?t.length:s);return t.slice(r+2,i).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,r+2)}${n}${t.slice(i)}`}function yt(t){return"string"==typeof t?new y(D(t)):(t.scheme||(t.scheme=w.scheme),t)}function $t(t){return qt.test(t)}function xt(t,e){const n=R(t),r=Object.keys(n.query||{});return r.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),n.path}function wt(t,e,n){const r=R(t),o=r.query||{};return o[e]=String(n),`${r.path}?${L(o)}`}function Ot(t,e){const n=R(t),r=n.query||{};for(const t in e)r[t]=e[t];const o=L(r);return o?`${n.path}?${o}`:n.path}function bt(t,e){const{path:n,query:r}=R(t);if(!r)return t;delete r[e];const o=L(r);return o?`${n}?${o}`:n}function Ut(t){if(s(t))return null;const e=t.match(Ct);return e?e[1]:null}const Ct=/.*?\.([^\/]*)$/,qt=/(^data:image\/svg|\.svg$)/i;export{y as Url,k as addProxy,P as addProxyRule,wt as addQueryParameter,Ot as addQueryParameters,X as base64UrlEncode,mt as changeDomain,Z as dataComponents,V as dataToArrayBuffer,et as dataToBlob,rt as downloadBlobAsFile,nt as downloadDataAsFile,C as getAppBaseUrl,U as getAppUrl,dt as getFilename,T as getInterceptor,F as getOrigin,Ut as getPathExtension,E as getProxyRule,I as getProxyUrl,ut as hasProtocol,W as hasSameOrigin,J as hasSamePortal,G as isAbsolute,at as isAppHTTPS,H as isBlobProtocol,K as isDataProtocol,ct as isHTTPSProtocol,it as isProtocolRelative,$t as isSVG,z as isTrustedServer,_ as join,D as makeAbsolute,tt as makeData,M as makeRelative,Q as normalize,L as objectToQuery,j as queryToObject,pt as removeFile,bt as removeQueryParameter,xt as removeQueryParameters,gt as removeTrailingSlash,q as test,lt as toHTTP,ft as toHTTPS,$ as trustedServersUrlCache,R as urlToObject};
