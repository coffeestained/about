/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as s}from"./tslib.es6.js";import e from"../core/Handles.js";import{i as t,f as i,p as n,d as a,a as r}from"./maybe.js";import{createTask as o,throwIfAborted as l,isAbortError as h,isAborted as c}from"../core/promiseUtils.js";import{watch as y,sync as w,syncAndInitial as p,whenOnce as _}from"../core/reactiveUtils.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./ensureType.js";import{subclass as V}from"../core/accessorSupport/decorators/subclass.js";import{I as u}from"./InteractiveToolViewModel.js";class m{constructor(s,e=null){this.screenPoint=s,this.result=e}}class v{constructor(s,e){this.scenePoint=s,this.mapPoint=e}}var O;!function(s){s[s.PENDING=0]="PENDING",s[s.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",s[s.RUNNING=2]="RUNNING"}(O||(O={}));let g=class extends u{constructor(s={}){super(s),this.analysisView=null,this._reconnectViewTask=null,this._analysisBaseHandles=new e,this._parentChangeFromReconnect=!1,this._startUserOperation=null;const i=s?.analysis;t(i)?this.analysis=i:(this._set("analysis",this.constructAnalysis()),this._set("isAnalysisOwner",!0))}normalizeCtorArgs(s){const{analysis:e,...t}=s;return t}initialize(){this._analysisBaseHandles.add([y((()=>i(this.analysis,(({parent:s})=>s))),(s=>{this._parentChangeFromReconnect||s===this.view||this._set("isAnalysisOwner",!1);const e=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,e&&this._scheduleViewReconnect()}),w),y((()=>({view:this.view,ready:t(this.view)&&this.view.ready,supported:this.supported})),(({view:s},{view:e})=>{s!==e&&(this._startUserOperation=n(this._startUserOperation),this._disconnectFromView(e)),this._scheduleViewReconnect()}),p),y((()=>this.analysis.isEditable),((s,e)=>{r(this.analysisView)||(s&&!e&&r(this.tool)?this.createTool():!s&&e&&t(this.tool)&&!this.tool.active&&this.removeTool())}))])}destroy(){this._analysisBaseHandles=a(this._analysisBaseHandles),this._reconnectViewTask=n(this._reconnectViewTask),this._startUserOperation=n(this._startUserOperation),t(this.analysisView)&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),t(this.analysis)&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))}set analysis(s){s!==this._get("analysis")&&(this._startUserOperation=n(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(s),this._scheduleViewReconnect())}get ready(){return t(this.analysisView)&&!this.connectingToView}get connectingToView(){return t(this._reconnectViewTask)}get isAnalysisOwner(){return this._get("isAnalysisOwner")}set visible(s){this._set("visible",s),t(this.analysisView)&&(this.analysisView.visible=s)}async start(){this.clear();const s={task:null,abort:null,state:O.PENDING},e=o((async e=>{s.state=O.WAIT_FOR_VIEW_READY,await _((()=>this.ready),e),s.state=O.RUNNING,this.createTool({interactive:!0})}));return s.task=e,s.abort=()=>e.abort(),this._startUserOperation=s,e.promise}clear(){this._startUserOperation=n(this._startUserOperation),this.removeTool(),this.analysis.clear()}onConnectToAnalysisView(s){}onDisconnectFromAnalysisView(){}_scheduleViewReconnect(){this._reconnectViewTask=n(this._reconnectViewTask);const s=o((async e=>{try{await this._reconnectView(e)}catch(s){if(l(e),!h(s))return void this.logger.warn("Failed to use analysis in view model",s);throw s}finally{s===this._reconnectViewTask&&(this._reconnectViewTask=null)}}));this._reconnectViewTask=s}async _reconnectView(s){const{view:e}=this,i=t(e)&&e.ready&&this.supported,n=this.analysis;if(this._startUserOperation=T(this._startUserOperation),this._disconnectFromView(e),i&&!r(e)&&!r(n)){if(this.isAnalysisOwner){if(t(n.parent))return void this.logError("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,e.analyses.add(n)}this.analysisView=await e.whenAnalysisView(n),c(s)?this._startUserOperation=T(this._startUserOperation):(this.analysisView.visible=this.visible,this.onConnectToAnalysisView(this.analysisView),this.createTool())}}_disconnectFromView(s){this.removeTool(),t(s)&&this.isAnalysisOwner&&(this._parentChangeFromReconnect=!0,s.analyses.remove(this.analysis),this.analysis.clear()),this.analysisView=null,this.onDisconnectFromAnalysisView()}_setExternalAnalysis(s){if(t(this.analysisView)&&!this.isAnalysisOwner&&(this.analysisView.visible=!0),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",s),this._parentChangeFromReconnect=!1,!s.isEditable){const e=s.nonEditableMessage;this.logger.warn(`The assigned ${s.type} analysis object will not be editable in the view. ${e}`)}}get testInfo(){return{analysisView:this.analysisView}}};function T(s){return t(s)&&s.state>=O.RUNNING?(s.abort(),null):s}s([d({nonNullable:!0})],g.prototype,"analysis",null),s([d()],g.prototype,"analysisView",void 0),s([d()],g.prototype,"ready",null),s([d()],g.prototype,"connectingToView",null),s([d({readOnly:!0})],g.prototype,"isAnalysisOwner",null),s([d({type:Boolean,value:!0})],g.prototype,"visible",null),s([d()],g.prototype,"_reconnectViewTask",void 0),g=s([V("esri.widgets.support.InteractiveAnalysisViewModel")],g);export{g as I,v as P,m as a};
