/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import t from"../Color.js";import s from"../core/Error.js";import{a as o,p as e}from"./screenUtils.js";import{i as r,e as i,m}from"./utils6.js";import{S as l,s as a,v as p,h as n}from"../symbols/support/symbolUtils.js";import{getColorLuminance as c}from"../views/support/colorUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./common.js";import"./maybe.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils.js";import"./parser2.js";import"./mat4f32.js";import"./mat4.js";import"./_commonjsHelpers.js";import"./assets.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./colorUtils2.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";const y=l.size,j=l.maxSize,u=l.maxOutlineSize,b=l.lineWidth,h=document.createElement("canvas");function d(t){const s=t?.size;return{width:null!=s&&"object"==typeof s&&"width"in s?o(s.width):null,height:null!=s&&"object"==typeof s&&"height"in s?o(s.height):null}}function f(t,s){return t>s?"dark":"light"}function g(t,s){const m="number"==typeof s?.size?s?.size:null,l=null!=m?o(m):null,p=null!=s?.maxSize?o(s.maxSize):null,n=null!=s?.rotation?s.rotation:"angle"in t?t.angle:null,c=r(t);let f=i(t);"dark"!==L(t,245)||s?.ignoreWhiteSymbols||(f={width:.75,...f,color:"#bdc3c7"});const g={shape:null,fill:c,stroke:f,offset:[0,0]};f?.width&&(f.width=Math.min(f.width,u));const S=f?.width||0;let v=null!=s?.size&&(null==s?.scale||s?.scale),w=0,M=0,k=!1;switch(t.type){case"simple-marker":{const s=t.style,e=Math.min(null!=l?l:o(t.size),p||j);switch(w=e,M=e,s){case"circle":g.shape={type:"circle",cx:0,cy:0,r:.5*e},v||(w+=S,M+=S);break;case"cross":g.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[w,.5*M]},{command:"M",values:[.5*w,0]},{command:"L",values:[.5*w,M]}]};break;case"diamond":g.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[.5*w,0]},{command:"L",values:[w,.5*M]},{command:"L",values:[.5*w,M]},{command:"Z",values:[]}]},v||(w+=S,M+=S);break;case"square":g.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[w,0]},{command:"L",values:[w,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},v||(w+=S,M+=S),n&&(k=!0);break;case"triangle":g.shape={type:"path",path:[{command:"M",values:[.5*w,0]},{command:"L",values:[w,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},v||(w+=S,M+=S),n&&(k=!0);break;case"x":g.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[w,M]},{command:"M",values:[w,0]},{command:"L",values:[0,M]}]},n&&(k=!0);break;case"path":g.shape={type:"path",path:t.path||""},v||(w+=S,M+=S),n&&(k=!0),v=!0}break}case"simple-line":{const{width:t,height:o}=d(s),e=null!=o?o:Math.min(null!=l?l:S,p||u),r=null!=t?t:b;f.width=e,w=r,M=e;const i=g?.stroke?.cap||"butt",m="round"===i;v=!0,g.stroke.cap="butt"===i?"square":i,g.shape={type:"path",path:[{command:"M",values:[m?e/2:0,M/2]},{command:"L",values:[m?w-e/2:w,M/2]}]};break}case"picture-fill":case"simple-fill":{const t="object"==typeof s?.symbolConfig&&s?.symbolConfig.isSquareFill,{width:o,height:e}=d(s);w=t&&null!=o?o:null!=l?l:y,M=t&&null!=e?e:w,v||(w+=S,M+=S),v=!0,g.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[w,0]},{command:"L",values:[w,M]},{command:"L",values:[0,M]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:a.fill[0];break}case"picture-marker":{let s=o(t.width),e=o(t.height);const r=null!=l?l:Math.max(s,e),i=s/e;s=i<=1?Math.ceil(r*i):r,e=i<=1?r:Math.ceil(r/i),w=Math.min(s,p||j),M=Math.min(e,p||j),g.shape={type:"image",x:-Math.round(w/2),y:-Math.round(M/2),width:w,height:M,src:t.url||""},n&&(k=!0);break}case"text":{const s=t,r=s.text||"Aa",i=s.font,m=Math.min(null!=l?l:o(i.size),p||j),a=function(t,s){const o=h.getContext("2d"),e=[];return s&&(s.weight&&e.push(s.weight),s.size&&e.push(s.size+"px"),s.family&&e.push(s.family)),o.font=e.join(" "),o.measureText(t).width}(r,{weight:i.weight,size:m,family:i.family}),n=/[\uE600-\uE6FF]/.test(r);w=n?m:a,M=m;let c=.25*function(t){if(0===t.length)return 0;if(t.length>2){const s=e(1),o=parseFloat(t);switch(t.slice(-2)){case"px":return o;case"pt":return o*s;case"in":return 72*o*s;case"pc":return 12*o*s;case"mm":return 2.8346456692913384*o*s;case"cm":return 28.346456692913385*o*s}}return parseFloat(t)}((i?m:0).toString());n&&(c+=5),g.shape={type:"text",text:r,x:s.xoffset||0,y:s.yoffset||c,align:"middle",alignBaseline:s.verticalAlignment,decoration:i&&i.decoration,rotated:s.rotated,kerning:s.kerning},g.font=i&&{size:m,style:i.style,decoration:i.decoration,weight:i.weight,family:i.family};break}}return{shapeDescriptor:g,size:[w,M],renderOptions:{node:s?.node,scale:v,opacity:s?.opacity,rotation:n,useRotationSize:k,effectView:s?.effectView}}}async function S(t,o){const{shapeDescriptor:e,size:r,renderOptions:i}=g(t,o);if(!e.shape)throw new s("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,s){const o=s.fill,e=t.color;if("pattern"===o?.type&&e&&"picture-fill"!==t.type){const t=await m(o.src,e.toCss(!0));o.src=t,s.fill=o}}(t,e);const l=[[e]];if("object"==typeof o?.symbolConfig&&o?.symbolConfig.applyColorModulation){const t=.6*r[0];l.unshift([{...e,offset:[-t,0],fill:p(e.fill,-.3)}]),l.push([{...e,offset:[t,0],fill:p(e.fill,.3)}]),r[0]+=2*t,i.scale=!1}return n(l,r,i)}function L(s,o=225){const e=r(s),m=i(s),l=!e||"type"in e?null:new t(e),a=m?.color?new t(m?.color):null,p=l?f(c(l),o):null,n=a?f(c(a),o):null;return n?p?p===n?p:o>=225?"light":"dark":n:p}export{L as getContrastingBackgroundTheme,g as getRenderSymbolParameters,S as previewSymbol2D};
