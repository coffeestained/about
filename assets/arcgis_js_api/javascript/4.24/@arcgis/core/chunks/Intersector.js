/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{i as t,e as r}from"./maybe.js";import{c as s}from"./mat4.js";import{c as i,I as e}from"./mat4f64.js";import{G as a,h as n,b as o,w as h,o as d,e as c,a as l,K as f,n as m,U as u}from"./mathUtils.js";import{c as y}from"./vec4f64.js";import{c as p,e as g,b as O}from"./ray.js";import{V as _}from"./ViewingMode.js";import{e as L}from"./boundedPlane.js";import{I as E,g as A}from"./verticalOffsetUtils.js";import{i as T}from"./utils4.js";var b,I;!function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL"}(b||(b={}));class j{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=I.ALL}}function v(r){return t(r)&&t(r.dist)}function w(t){return(r,s,i)=>(a(R,r,s,i),!L(t,R))}function M(t){return v(t)&&t.intersector===b.OBJECT&&!!t.target}function N(r){return v(r)&&r.intersector===b.HUD&&!!r.target&&t(r.target.center)}!function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"}(I||(I={}));const R=n(),U=1e-5;class x{constructor(t){this.options=new j,this._results=new V,this.transform=new E,this.tolerance=1e-5,this.verticalOffset=null,this._ray=p(),this._rayEnd=n(),this._rayBeginTransformed=n(),this._rayEndTransformed=n(),this.viewingMode=null==t?_.Global:t}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,r,s){this.resetWithRay(g(t,r,this._ray),s)}resetWithRay(t,r){this.camera=r,t!==this._ray&&O(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===_.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,o(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(r=null,s,i,e,a){this.point=s,this.filterPredicate=e,this.tolerance=null==i?1e-5:i;const n=A(this.verticalOffset);if(t(r)&&r.length>0){const s=a?t=>{a(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of r){const r=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();t(r)?(t(n)?r.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,n):r.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&r.forEachDegenerateObject(s)):i.objects.forAll((t=>s(t)))}}this.sortResults()}intersectObject(r){const s=r.geometryRecords;if(!s)return;const i=r.transformation,a=A(this.verticalOffset);for(const n of s){const{geometry:s,material:o,instanceParameters:d}=n;if(T(d))continue;const c=s.id;this.transform.setAndInvalidateLazyTransforms(i,n.getShaderTransformation()),h(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),h(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;t(a)&&(a.objectTransform=this.transform),o.intersect(s,d,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((s,i,a,n,o,h)=>{if(s>=0){if(t(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,s))return;const d=n?this._results.hud:this._results,f=n?n=>{const d={object:r,geometryId:c,triangleNr:a,center:t(h)?[h[0],h[1],h[2]]:null};n.set(b.HUD,d,s,i,e,o)}:t=>t.set(b.OBJECT,{object:r,geometryId:c,triangleNr:a},s,i,l,o);if((null==d.min.drapedLayerOrder||o>=d.min.drapedLayerOrder)&&(null==d.min.dist||s<d.min.dist)&&f(d.min),this.options.store!==I.MIN&&(null==d.max.drapedLayerOrder||o<d.max.drapedLayerOrder)&&(null==d.max.dist||s>d.max.dist)&&f(d.max),this.options.store===I.ALL)if(n){const t=new C(this._ray);f(t),this._results.hud.all.push(t)}else{const t=new D(this._ray);f(t),this._results.all.push(t)}}}),n.shaderTransformation)}}sortResults(t=this._results.all){t.sort(((t,s)=>t.dist!==s.dist?r(t.dist,0)-r(s.dist,0):t.drapedLayerOrder!==s.drapedLayerOrder?r(t.drapedLayerOrder,Number.MAX_VALUE)-r(s.drapedLayerOrder,Number.MAX_VALUE):r(s.drapedLayerGraphicOrder,Number.MIN_VALUE)-r(t.drapedLayerGraphicOrder,Number.MIN_VALUE)))}}function B(t){return new x(t)}class V{constructor(){this.min=new D(p()),this.max=new D(p()),this.hud={min:new C(p()),max:new C(p()),all:new Array},this.ground=new D(p()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class D{constructor(t){this.intersector=b.OBJECT,this.normal=n(),this.transformation=i(),this._ray=p(),this.init(t)}get ray(){return this._ray}get distanceInRenderSpace(){return t(this.dist)?(d(P,this.ray.direction,this.dist),c(P)):null}getIntersectionPoint(t){return!!v(this)&&(d(P,this.ray.direction,this.dist),o(t,this.ray.origin,P),!0)}getTransformedNormal(t){return l(S,this.normal),S[3]=0,f(S,S,this.transformation),l(t,S),m(t,t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=b.OBJECT,O(t,this._ray)}set(t,i,a,n,o,h,d){this.intersector=t,this.dist=a,l(this.normal,r(n,u)),s(this.transformation,r(o,e)),this.target=i,this.drapedLayerOrder=h,this.drapedLayerGraphicOrder=d}copy(t){O(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,l(this.normal,t.normal),s(this.transformation,t.transformation)}}class C extends D{constructor(){super(...arguments),this.intersector=b.HUD}}function G(t){return new D(t)}const P=n(),S=y();export{U as D,b as I,I as S,B as a,M as b,N as c,v as i,G as n,w as s};
