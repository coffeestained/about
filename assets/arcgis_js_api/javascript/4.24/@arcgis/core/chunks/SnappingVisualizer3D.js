/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../Color.js";import"../core/lang.js";import{d as t}from"./handleUtils.js";import{u as i,i as r,a as n,e as o}from"./maybe.js";import{h as s,f as a,z as l,a as c,n as d,d as h,B as m,m as u,b as p,G as _}from"./mathUtils.js";import{E as f,a as g}from"./ExtendedLineVisualElement.js";import v from"../core/Handles.js";import{watch as w}from"../core/reactiveUtils.js";import{b as x}from"./screenUtils.js";import{g as E,e as R,d as j,a as y,b as S}from"./vec2.js";import{f as O}from"./vec4f32.js";import{O as G}from"./Object3DVisualElement.js";import{G as H}from"./GeometryUtil.js";import{R as A}from"./Material.js";import{V as P}from"./VertexAttribute.js";import{R as b}from"./lineUtils.js";import{P as I}from"./PointVisualElement.js";import{R as V}from"./RightAngleQuadVisualElement.js";import{d as z}from"./Settings2.js";import{a as U}from"./RightAngleSnappingHint.js";import{a as F}from"./SnappingContext.js";import{a as T,c as L}from"./viewUtils.js";class M extends G{constructor(e){super(e),this._handles=new v,this._location=s(),this._direction=a(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=O(1,0,1,1),this._renderOccluded=A.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){l(this._location,e)||(c(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){l(this._direction,e)||(c(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){d(this._direction,h(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){m(e,this._color)||(u(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new b(this.materialParameters);this._handles.add(w((()=>this.view.state.camera),(()=>{this._updateGeometry()}))),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=H.createPolylineGeometry([s(),s()]),r=H.createPolylineGeometry([s(),s()]),n=i(this._externalResources).material;e.addGeometry(t,n),e.addGeometry(r,n),this._updateVertices(e)}forEachExternalMaterial(e){r(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){n(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;n(e)||this._updateVertices(e)}_updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,C),p(B,this.location,this.direction),t.projectToScreen(B,D),E(D,R(D,D,C)),this._updateVertexAttributes(t,e,0,C,D,1),this._updateVertexAttributes(t,e,1,C,D,-1)}_updateVertexAttributes(e,t,i,r,n,o){const s=t.geometryRecords[i],a=s.geometry.getMutableAttribute(P.POSITION).data,l=j(N,y(N,n[1]*o,n[0]*-o),this.offset+this.width/2),c=S(W,S(W,S(W,r,j(W,n,this.length/2)),l),l),d=S(q,c,j(q,n,-this.length));e.unprojectFromScreen(c,B),a[0]=B[0],a[1]=B[1],a[2]=B[2],e.unprojectFromScreen(d,B),a[3]=B[0],a[4]=B[1],a[5]=B[2],t.geometryVertexAttrsUpdated(s)}}const B=s(),C=x(),D=x(),N=x(),W=x(),q=x();class k extends F{visualizeIntersectionPoint(i,r){const{coordinateHelper:n,view:s}=r;return t(new I({view:s,primitive:"circle",geometry:n.vectorToPoint(i.intersectionPoint),elevationInfo:o(i.elevationInfo,r.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:e.toUnitRGBA(z.orange),pixelSnappingEnabled:!1}))}visualizePoint(i,r){const{coordinateHelper:n,view:s}=r;return t(new I({view:s,primitive:"circle",geometry:n.vectorToPoint(i.point),elevationInfo:o(i.elevationInfo,r.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:e.toUnitRGBA(z.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:r,view:n}=i;return t(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,r,o(e.elevationInfo,i.elevationInfo),n,e.fadeLeft,e.fadeRight))}visualizeParallelSign(i,r){const{coordinateHelper:n,view:s}=r,a=o(i.elevationInfo,r.elevationInfo),l=T(i.lineStart,n,a,r.view),c=T(i.lineEnd,n,a,r.view),d=_(c,l,c,.5),h=new M({view:s,attached:!1,offset:z.parallelLineHintOffset,length:z.parallelLineHintLength,width:z.parallelLineHintWidth,color:e.toUnitRGBA(z.orange),location:d,renderOccluded:A.Opaque});return h.setDirectionFromPoints(l,d),h.attached=!0,t(h)}visualizeRightAngleQuad(i,r){const{coordinateHelper:n,view:s}=r,a=o(i.elevationInfo,r.elevationInfo);return t(new V({view:s,attached:!0,color:e.toUnitRGBA(z.orange),renderOccluded:A.Transparent,outlineRenderOccluded:A.Opaque,outlineColor:e.toUnitRGBA(z.orange),outlineSize:z.rightAngleHintOutlineSize,size:z.rightAngleHintSize,geometry:{previous:T(i.previousVertex,n,a,s),center:T(i.centerVertex,n,a,s),next:T(i.nextVertex,n,a,s)}}))}_createLineSegmentHintFromMap(e,t,i,r,n,o,a=!0,l=!0){const c=s(),d=s();return L(t,i,r,n,o,c,d),this._createLineSegmentHint(e,o,c,d,a,l)}_createLineSegmentHint(t,i,r,n,o=!0,s=!0){const a=new f({view:i,extensionType:g.FADED,start:r,end:n,color:e.toUnitRGBA(z.orange),renderOccluded:A.Opaque});switch(t){case U.TARGET:a.width=z.lineHintWidthTarget,a.fadedExtensions={start:0,end:z.lineHintFadedExtensions};break;case U.REFERENCE_EXTENSION:a.width=z.lineHintWidthReference,a.fadedExtensions={start:0,end:0};break;case U.REFERENCE:a.width=z.lineHintWidthReference,a.fadedExtensions={start:o?z.lineHintFadedExtensions:0,end:s?z.lineHintFadedExtensions:0}}return a.attached=!0,a}}export{k as S};
