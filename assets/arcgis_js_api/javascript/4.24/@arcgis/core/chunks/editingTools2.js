/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{m as e,h as i,d as a,r as s}from"./handleUtils.js";import{a as o,i as r,f as n,d as l,u as p,r as h,e as c,q as u}from"./maybe.js";import{watch as d,on as m,initial as g,when as y,syncAndInitial as _,sync as v}from"../core/reactiveUtils.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import{h as M}from"../core/lang.js";import"./ensureType.js";import{subclass as b}from"../core/accessorSupport/decorators/subclass.js";import{g as S,i as x,b as j,d as E,c as O}from"./elevationInfoUtils.js";import{E as w}from"./ElevationInfo.js";import{b as A,d as T,s as G}from"./screenUtils.js";import"./Logger.js";import{X as D,h as I,B as R,m as P,s as L,g as V,b as z,o as C,f as U,R as k,d as N,n as F,j as H,k as Z,c as B,A as Y,p as X,e as q,G as W,q as Q,r as J,y as K,ah as $,Z as tt,a8 as et,a as it}from"./mathUtils.js";import at from"../core/Accessor.js";import{createTask as st,throwIfAborted as ot}from"../core/promiseUtils.js";import{e as rt}from"./quantityFormatUtils.js";import{n as nt,f as lt,t as pt}from"./unitUtils.js";import{s as ht,a as ct,g as ut,d as dt,l as mt,b as gt,p as yt,f as _t,w as vt,x as ft,e as Mt}from"./vec2.js";import{a as bt}from"./vec2f64.js";import{i as St}from"../geometry/Polygon.js";import{f as xt}from"./messages.js";import{T as jt}from"./TextOverlayItem.js";import{b as Et,D as Ot,S as wt,E as At,c as Tt,e as Gt,T as Dt,f as It,g as Rt,h as Pt,i as Lt}from"./drawSurfaces.js";import{v as Vt}from"./viewUtils.js";import{S as zt}from"./SnappingVisualizer3D.js";import{s as Ct,O as Ut,c as kt}from"./OutlineVisualElement.js";import{O as Nt}from"./Object3DVisualElement.js";import{E as Ft}from"./ElevationContext.js";import{g as Ht}from"./pointUtils.js";import{C as Zt}from"./basicInterfaces.js";import{G as Bt}from"./GeometryUtil.js";import{R as Yt}from"./Material.js";import{S as Xt,M as qt,a as Wt,g as Qt,e as Jt,p as Kt,b as $t}from"./manipulatorUtils.js";import{G as te}from"./GraphicState.js";import{D as ee,g as ie}from"./DrawGraphicTool.js";import ae from"../views/interactive/sketch/SketchLabelOptions.js";import se from"../views/interactive/sketch/SketchTooltipOptions.js";import oe from"../core/Collection.js";import re from"../core/Evented.js";import{HandleOwnerMixin as ne,HandleOwner as le}from"../core/HandleOwner.js";import{m as pe}from"./dehydratedFeatures.js";import{i as he,S as ce,g as ue,a as de}from"../widgets/Sketch/SketchViewModel.js";import{c as me}from"./manipulatorUtils2.js";import{E as ge}from"./ExtendedLineVisualElement.js";import{L as ye}from"./LaserlineVisualElement.js";import{projectVectorToVector as _e,projectPointToVector as ve}from"../geometry/projection.js";import{a as fe,g as Me,F as be}from"./aaBoundingBox.js";import{g as Se}from"./aaBoundingRect.js";import{P as xe}from"./PointVisualElement.js";import{e as je}from"./lineUtils.js";import Ee from"../core/Handles.js";import Oe from"../Color.js";import{f as we,a as Ae,m as Te,h as Ge,q as De,e as Ie,r as Re,b as Pe,u as Le,d as Ve}from"./mat4.js";import{c as ze,f as Ce,I as Ue}from"./mat4f64.js";import{s as ke,a as Ne,d as Fe}from"./vectorStacks.js";import{b as He,c as Ze,d as Be,e as Ye,f as Xe,g as qe,s as We}from"./dragEventPipeline3D.js";import{d as Qe,a as Je,c as Ke,b as $e,e as ti,f as ei,E as ii,g as ai,I as si,h as oi,i as ri}from"./dragEventPipeline.js";import{C as ni}from"./ColorMaterial.js";import{a as li,M as pi}from"./interfaces.js";import{d as hi}from"./colorUtils2.js";import{G as ci}from"./GraphicManipulator.js";import{E as ui,O as di,P as mi,A as gi,U as yi,M as _i,R as vi,S as fi,b as Mi}from"./EditGeometryOperations.js";import{S as bi}from"./SnappingContext.js";import{S as Si,v as xi,g as ji,h as Ei}from"./euclideanLengthMeasurementUtils.js";import{z as Oi,c as wi,d as Ai,m as Ti}from"./quantityUtils.js";import Gi from"../geometry/Polyline.js";import{n as Di,f as Ii,c as Ri,p as Pi,i as Li}from"./plane.js";import{j as Vi}from"./utils6.js";import{M as zi}from"./IViewEvents.js";import Ci from"../geometry/Point.js";import{V as Ui}from"./ViewingMode.js";import{a as ki}from"./Cyclical.js";import{addFrameTask as Ni}from"../core/scheduling.js";import{f as Fi}from"./vec4f64.js";import{w as Hi,d as Zi,c as Bi}from"./ray.js";import{b as Yi,e as Xi}from"./axisAngleDegrees.js";import{c as qi,u as Wi,a as Qi}from"./boundedPlane.js";import{C as Ji,c as Ki,O as $i,E as ta,e as ea,d as ia,F as aa,H as sa,J as oa,l as ra,R as na,q as la,t as pa,w as ha}from"./sliceToolUtils.js";import{g as ca}from"./Factory.js";import{a as ua}from"./ray2.js";import"./watch.js";import"./ArrayPool.js";import"./get.js";import"./utils.js";import"./tracking.js";import"../core/Error.js";import"./object.js";import"../config.js";import"./string.js";import"./nextTick.js";import"./metadata.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./Ellipsoid.js";import"./jsonMap.js";import"../core/JSONSupport.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./extentUtils.js";import"./common.js";import"./unitFormatUtils.js";import"./byteSizeEstimations.js";import"./number2.js";import"./locale.js";import"./projectionEllipsoid.js";import"./projector.js";import"./widgetUtils.js";import"./dehydratedFeatureComparison.js";import"./SnappingOperation.js";import"./Scheduler.js";import"./debugFlags.js";import"../intl.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./assets.js";import"../widgets/Widget.js";import"./domUtils.js";import"../core/Promise.js";import"./uuid.js";import"./jsxWidgetSupport.js";import"./shared.js";import"./SimpleObservable.js";import"./messageBundle.js";import"./jsxFactory.js";import"./euclideanAreaMeasurementUtils.js";import"./earcut.js";import"./triangle.js";import"./lineSegment.js";import"./measurementUtils2.js";import"../geometry/geometryEngine.js";import"./geometryEngineBase.js";import"./hydrated.js";import"../geometry/support/geodesicUtils.js";import"./geodesicConstants.js";import"./vec4f32.js";import"./VertexAttribute.js";import"./RightAngleQuadVisualElement.js";import"./glUtil3D.js";import"./Util.js";import"./geometryDataUtils.js";import"./BufferView.js";import"./enums.js";import"./Texture.js";import"./context-util.js";import"./mat4f32.js";import"./ShaderTechniqueConfiguration.js";import"./VertexElementDescriptor.js";import"./VertexArrayObject.js";import"./Settings2.js";import"./RightAngleSnappingHint.js";import"./lineStippleUtils.js";import"./Identifiable.js";import"./VisualElementResources.js";import"./CameraSpace.glsl.js";import"./sphere.js";import"./mathUtils2.js";import"./utils4.js";import"./doublePrecisionUtils.js";import"./Octree.js";import"./frustum.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"./colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./RenderSlot.js";import"./InterleavedLayout.js";import"./types.js";import"./Texture2.js";import"./compilerUtils.js";import"./requestImageUtils.js";import"./FramebufferObject.js";import"./RenderGeometry.js";import"./VisualElement.js";import"./vec3f32.js";import"./mat3.js";import"./quatf64.js";import"./ElevationProvider.js";import"./Camera.js";import"./OrderIndependentTransparency.js";import"../layers/GraphicsLayer.js";import"./GraphicsCollection.js";import"../layers/Layer.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser2.js";import"./_commonjsHelpers.js";import"../layers/mixins/ScaleRangeLayer.js";import"../geometry/Circle.js";import"./surfaceCoordinateSystems.js";import"./mat2df32.js";import"./mat2df64.js";import"./quat.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../views/DOMContainer.js";import"../widgets/Popup.js";import"./throttle.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../widgets/Feature.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"../widgets/Feature/FeatureViewModel.js";import"./languageUtils.js";import"./datetime.js";import"./number.js";import"./DataLayerSource.js";import"./executeQueryJSON.js";import"./utils5.js";import"./query.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./pbfQueryUtils.js";import"./pbf.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./queryZScale.js";import"./zscale.js";import"../rest/support/FeatureSet.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./timeUtils.js";import"../rest/support/StatisticDefinition.js";import"./featureConversionUtils.js";import"../rest/support/RelationshipQuery.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"./LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./sizeVariableUtils.js";import"./visualVariableUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"./DictionaryLoader.js";import"./LRUCache.js";import"./MemCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"./heatmapUtils.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils2.js";import"../renderers/support/jsonUtils.js";import"./MultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../geometry/HeightModelInfo.js";import"./FeatureIndex.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../layers/mixins/APIKeyMixin.js";import"./ArcGISService.js";import"./arcgisLayerUrl.js";import"../layers/mixins/CustomParametersMixin.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"./OperationalLayer.js";import"./commonProperties.js";import"../support/timeUtils.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"./asyncUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/TimeReference.js";import"./featureReductionUtils.js";import"./FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/AggregateField.js";import"../layers/support/OutStatistic.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"./defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"./fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"./labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./versionUtils.js";import"./styleUtils.js";import"../support/popupUtils.js";import"./Heading.js";import"../widgets/support/widget.js";import"./accessibleHandler.js";import"./vmEvent.js";import"./themeUtils.js";import"./utils13.js";import"./numberUtils.js";import"./ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"../widgets/Spinner/SpinnerViewModel.js";import"./AnchorElementViewModel.js";import"../widgets/Popup/PopupViewModel.js";import"../symbols/support/symbolUtils.js";import"./InputManager.js";import"./layerViewUtils.js";import"./actions.js";import"../widgets/support/GoTo.js";import"./keybindings.js";import"./SnappingManager.js";import"./QueryEngineResult.js";import"../core/sql/WhereClause.js";import"./utils11.js";import"./generateRendererUtils.js";import"./projectionSupport.js";import"./json.js";import"./utils18.js";import"./geometry2dUtils.js";import"../views/interactive/snapping/SnappingOptions.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./hitTestSelectUtils.js";import"./screenUtils2.js";import"./pe.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./glUtil.js";import"./Float3Uniform.js";import"./HUDMaterial.js";import"./VisualVariables.glsl.js";import"./Matrix4Uniform.js";import"./GLTextureMaterial.js";import"./floatRGBA.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./interfaces2.js";import"./vec2f32.js";import"./NestedMap.js";import"./Intersector.js";import"./verticalOffsetUtils.js";import"./drawUtils.js";import"./VertexColor.glsl.js";import"./drapedUtils.js";import"./PointSnappingHint.js";import"../analysis/SlicePlane.js";import"./persistable.js";import"./multiOriginJSONSupportUtils.js";import"./projectionUtils.js";import"./LineVisualElement.js";import"./RenderCoordsHelper.js";import"./spatialReferenceSupport.js";import"./ImageMaterial.js";import"./NativeLineMaterial.js";const da={default:15,far:25};let ma=class extends at{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=st((async t=>{const e=await xt("esri/core/t9n/Units");ot(t),this._messagesUnits=e})),i=()=>n(this.context,(t=>t.editGeometryOperations));this.own([d((()=>[r(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((t=>m(i,t,(()=>this._update())))),e((()=>t.abort()))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return o(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((t=>t.label.text))}}get _edgeDistancePixels(){return da[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(o(t))return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:a}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const s=e.length;for(let o=0;o<s;++o){const n=[];if(e[o].iterateVertices((t=>{n.push(a.toXYZ(t.pos))})),0===o&&r(this.stagedVertex)&&n.push(a.toXYZ(this.stagedVertex)),n.length<2)continue;const l=n[0],p=n[n.length-1];"polygon"===i.type&&n.length>2&&!D(l,p)&&n.push(l);const h=1===s&&!St(n,!1,!1);let c=_a,u=va;this.toScreenPointArray(t,l,c);for(let e=1;e<n.length;++e){const i=n[e-1],a=n[e];this.toScreenPointArray(t,a,u),this._addLabel(t,i,c,a,u,h),[c,u]=[u,c]}}this._destroyUnusedLabels()}_addLabel(t,e,i,a,s,o){const{label:n}=this._getOrCreateLabel(t);if(!this.visible||ht(i,s)<3025)return void(n.visible=!1);const l=r(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":S(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:p}=t.editGeometryOperations.data,h=Et(e,a,p,l),c=this._messagesUnits,u=nt(t.view);n.text=r(c)&&r(h)?rt(c,h,u):"",n.visible=!0;const d=s[0]-i[0],m=s[1]-i[1];o?ct(ga,-m,d):ct(ga,m,-d),ut(ga,ga),dt(ga,ga,this._edgeDistancePixels),mt(ya,i,s,.5),gt(ya,ya,ga),n.position=[ya[0],ya[1]],Math.abs(ga[0])>Math.abs(ga[1])?n.anchor=ga[0]>0?"left":"right":n.anchor=-ga[1]<0?"top":"bottom"}_getOrCreateLabel(t){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const e=new jt({fontSize:10,anchor:"center"});t.view.overlay.items.add(e);const i={label:e};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){n(this.context,(e=>e.view.overlay.items.remove(t))),t.destroy()}};t([f()],ma.prototype,"context",void 0),t([f()],ma.prototype,"stagedVertex",void 0),t([f()],ma.prototype,"visible",void 0),t([f()],ma.prototype,"edgeDistance",void 0),t([f()],ma.prototype,"updating",null),t([f()],ma.prototype,"_messagesUnits",void 0),t([f()],ma.prototype,"_edgeDistancePixels",null),ma=t([b("esri.views.interactive")],ma);const ga=bt(),ya=bt(),_a=A(),va=A();let fa=class extends ma{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,s=A()){const{spatialReference:o}=i.data.coordinateHelper;return Vt(a,o,e,t,Ma),t.state.camera.projectToScreen(Ma,s),s}};fa=t([b("esri.views.3d.interactive.SegmentLabels3D")],fa);const Ma=I();class ba extends Nt{constructor(t){super(t),this.view=null,this._renderOccluded=Yt.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=Ct.colorToVec4(Ct.reshapeManipulators.vertex.color),this._size=Ct.reshapeManipulators.vertex.size,this._outlineColor=Ct.colorToVec4(Ct.reshapeManipulators.vertex.outlineColor),this._outlineSize=Ct.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(t){this._vertices=t,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(t){this._spatialReference=t,this.recreateGeometry()}get color(){return this._color}set color(t){R(t,this._color)||(P(this._color,t),this._updateMaterial())}get size(){return this._size}set size(t){t!==this._size&&(this._size=t,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(t){R(t,this._outlineColor)||(P(this._outlineColor,t),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(t){t!==this._outlineSize&&(this._outlineSize=t,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const t=this.vertices;if(o(t)||0===t.length)return[];const e=Ht(t,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Ft.fromElevationInfo(this.elevationInfo)),i=[],a=e.numVertices,s=e.position;for(let t=0;t<a;++t){const e=L(Sa,s[3*t+0],s[3*t+1],s[3*t+2]),a=xa(.5,e),o=xa(.5,e);i.push({vertexGeometry:a,vertexOutlineGeometry:o})}return i}createGeometries(t){const e=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:a}of e)t.addGeometry(i,this.vertexMaterial),t.addGeometry(a,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new Xt({...this.vertexMaterialParameters,writeDepth:!0,cullFace:Zt.Back,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new Xt({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:Zt.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(t){t(this.vertexMaterial),t(this.vertexOutlineMaterial)}}const Sa=I();function xa(t,e){return Bt.createSphereGeometry(t,16,16,{offset:e})}let ja=class extends ee{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.labelOptions=new ae,this.tooltipOptions=new se,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new w({mode:t,offset:e})}normalizeCtorArgs(t){if(!t.elevationInfo){const e=t.hasZ??!0;return{...t,elevationInfo:{mode:e?"absolute-height":"on-the-ground",offset:0}}}return t}initializeGraphic(t){const e=this._createGraphicState=new te({graphic:t});return i([this.view.maskOccludee(t),this.view.trackGraphicState(e),d((()=>({element:this._outlineVisualElement,isDraped:e.isDraped})),(({element:t,isDraped:e})=>{n(t,(t=>t.isDraped=e))}),g)])}makeDrawOperation(){const{geometryType:t}=this,e="circle"!==t&&"rectangle"!==t;return new Ot({view:this.view,manipulators:this.manipulators,geometryType:ie(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new wt(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new At(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new zt,segmentLabels:e?new fa:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:r(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===x(this.hasZ,this.elevationInfo)})}onActiveVertexChanged(t){return r(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],null):(this._activeVertexVisualElement=new ba({view:this.view,spatialReference:this.view.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:Ct.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=Ct.colorToVec4(Ct.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,e((()=>{this._activeVertexVisualElement=l(this._activeVertexVisualElement)})))}onOutlineChanged(t){if(r(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const i=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Ut({view:this.view,geometry:t,elevationInfo:i,isDraped:r(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===x(this.hasZ,i),attached:!1}),Ct.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),Ct.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,e((()=>{this._outlineVisualElement=l(this._outlineVisualElement)}))}onRegularVerticesChanged(t){return r(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new ba({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:Ct.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,e((()=>{this._verticesVisualElement=l(this._verticesVisualElement)})))}};var Ea,Oa;t([f({constructOnly:!0})],ja.prototype,"elevationInfo",void 0),t([f({constructOnly:!0})],ja.prototype,"geometryType",void 0),t([f({constructOnly:!0,type:ae})],ja.prototype,"labelOptions",void 0),t([f({constructOnly:!0,type:se})],ja.prototype,"tooltipOptions",void 0),t([f()],ja.prototype,"type",void 0),t([f({constructOnly:!0})],ja.prototype,"view",void 0),ja=t([b("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],ja),function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"}(Ea||(Ea={})),function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"}(Oa||(Oa={}));class wa{constructor(){this.grabbingState=Oa.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=Oa.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator(((t,e)=>{if(e===Ea.TRANSLATE_Z&&(this.zManipulator=t),t instanceof qt&&(t.selected&&(0===this.numSelected&&(this.firstSelected=t),this.numSelected++),o(this.firstGrabbedXY)&&t.grabbing&&e===Ea.TRANSLATE_XY&&(this.firstGrabbedXY=t)),t.grabbing)switch(this.grabbingState|=Oa.ANY,e){case Ea.TRANSLATE_Z:this.grabbingState|=Oa.Z;break;case Ea.TRANSLATE_XY:this.grabbingState|=Oa.XY}}))}}function Aa(t){return r(t.geometry)&&("polygon"===t.geometry.type||"polyline"===t.geometry.type)}const Ta=I();function Ga(t){const{view:e,graphic:n}=t,l=new te({graphic:n}),p=[],h=function(t,e,i){const{view:o,graphic:n}=t,l=new xe({view:o,geometry:Da(n),elevationInfo:j(n),attached:!1});return function(t,e,i,a){(function(t,e,i,a){const{view:o,graphic:n}=t;let l=null;const p=()=>{const t=Da(n);(t=>{r(l)&&(l.remove(),l=null),i.isDraped&&r(t)&&(l=function(i,a,s){const o=i.elevationProvider.spatialReference;ve(a,Ia,o);const r=Ia[0],n=Ia[1];return i.elevationProvider.on("elevation-change",(i=>{Se(i.extent,r,n)&&(e.geometry=t)}))}(o,t))})(t),e.geometry=t};a.push(i.on("changed",p),s((()=>l))),p()})(t,e,i,a),Ct.visualElements.pointGraphics.outline.apply(e),a.push(d((()=>i.displaying),(()=>e.attached=i.displaying),g))}(t,l,e,i),i.push(a(l)),l}(t,l,p);return function(t,e,i,s){const{view:n,graphic:l}=t,p=new ge({view:n,extensionType:Ct.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Yt.OccludeAndTransparent});Ct.visualElements.zVerticalLine.apply(p);const h=new ye({view:n,intersectsLineInfinite:!0,attached:!1});Ct.visualElements.pointGraphics.shadowStyle.apply(h);const c=V(Ct.visualElements.heightPlaneAngleCutoff),u=new ye({view:n,attached:!1,angleCutoff:c});Ct.visualElements.heightPlane.apply(u);const m=j(t.graphic),g=Ft.fromElevationInfo(m),y="on-the-ground"===m.mode||!m.offset&&"absolute-height"!==m.mode,_=new wa;let v=1,f=1;const M=()=>{_.update(t);const i=Da(l),a=y&&(e.isDraped||o(i)||!i.hasZ);let c=!0;if(!a&&r(i)){const t=je(i,n.elevationProvider,g,n.renderCoordsHelper);L(Ia,i.x,i.y,t),_e(Ia,i.spatialReference,Ia,n.renderCoordsHelper.spatialReference),p.setStartEndFromWorldDownAtLocation(Ia),h.intersectsWorldUpAtLocation=Ia}else c=!1;const d=_.grabbingState&Oa.Z?Ct.visualElements.laserlineAlphaMultiplier:1;d!==v&&(v=d,Ct.visualElements.heightPlane.apply(u,d));const m=Me(Ra);!a&&e.displaying&&s.calculateMapBounds(m)&&_e(be(m,Ia),n.spatialReference,Ia,n.renderCoordsHelper.spatialReference)?(u.heightManifoldTarget=Ia,u.attached=!0):u.attached=!1;const M=_.grabbingState&Oa.XY?Ct.visualElements.laserlineAlphaMultiplier:1;M!==f&&(f=M,Ct.visualElements.pointGraphics.shadowStyle.apply(h,M));const b=c&&e.displaying&&!a;h.attached=b,p.attached=b};i.push(d((()=>[e.displaying,e.isDraped]),M),e.on("changed",M)),t.forEachManipulator((t=>{i.push(t.events.on("grab-changed",M))})),i.push(a(h)),i.push(a(p)),i.push(a(u)),M()}(t,l,p,h),p.push(e.trackGraphicState(l)),{visualElement:h,remove(){i(p).remove()}}}function Da(t){const e=t.geometry;return o(e)?null:"point"===e.type?e:"mesh"===e.type?e.anchor.clone():null}const Ia=I(),Ra=fe();function Pa(t){switch(p(t.graphic.geometry).type){case"point":case"mesh":return Ga(t);case"polygon":case"polyline":return function(t){const{view:e,graphic:o}=t,n=new te({graphic:o}),l=function(t,e){const{view:s,graphic:o}=t,r=new Ut({view:s,geometry:Aa(o)?o.geometry:null,elevationInfo:j(o),attached:!1});Ct.visualElements.lineGraphics.shadowStyle.apply(r);const n=()=>{r.attached=e.displaying};Ct.visualElements.lineGraphics.outline.apply(r);const l=[d((()=>e.displaying),n),d((()=>e.isDraped),(t=>{r.isDraped=t})),e.on("changed",(()=>r.geometry=Aa(o)?o.geometry:null)),a(r)];return n(),{visualElement:r,remove:()=>i(l).remove()}}(t,n),p=function(t,e,o){const{graphic:n,view:l}=t,p=[],h=j(n),c="on-the-ground"===h.mode||!h.offset&&"absolute-height"!==h.mode,u=new wa,m=new ge({view:l,extensionType:Ct.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Yt.OccludeAndTransparent});Ct.visualElements.pointGraphics.shadowStyle.apply(m);const g=V(Ct.visualElements.heightPlaneAngleCutoff),y=new ye({view:l,attached:!1,angleCutoff:g});Ct.visualElements.heightPlane.apply(y);let _=1,v=1;const f=()=>{if(u.update(t),!o.displaying||c&&(o.isDraped||!Aa(n)||!n.geometry.hasZ))return e.laserlineEnabled=!1,m.attached=!1,void(y.attached=!1);e.laserlineEnabled=!0;{const t=u.grabbingState&Oa.XY?Ct.visualElements.laserlineAlphaMultiplier:1;t!==_&&(_=t,Ct.visualElements.lineGraphics.shadowStyle.apply(e,t),Ct.visualElements.pointGraphics.shadowStyle.apply(m,t))}{const t=u.grabbingState&Oa.Z?Ct.visualElements.laserlineAlphaMultiplier:1;t!==v&&(v=t,Ct.visualElements.heightPlane.apply(y,t))}!function(t,e){const i=1===e.numSelected?e.firstSelected:e.numSelected>1&&r(e.firstGrabbedXY)?e.firstGrabbedXY:null;r(i)?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}(m,u),function(t,e,i,a){if(a.numSelected>0){L(Ta,0,0,0);let e=0;t.forEachManipulator(((t,i)=>{i===Ea.TRANSLATE_XY&&t.selected&&t instanceof qt&&(z(Ta,Ta,t.renderLocation),e++)})),e>0?(i.heightManifoldTarget=C(Ta,Ta,1/e),i.attached=!0):i.attached=!1}else{const a=e.attachmentOrigin;r(a)&&t.view.renderCoordsHelper.toRenderCoords(a,Ta)?(i.heightManifoldTarget=Ta,i.attached=!0):i.attached=!1}}(t,e,y,u)};Ct.visualElements.zVerticalLine.apply(m),p.push(o.on("changed",f),d((()=>o.displaying),f),e.events.on("attachment-origin-changed",f),a(m),a(y));const M=[],b=()=>{i(M).remove(),M.length=0,t.forEachManipulator((t=>M.push(t.events.on("grab-changed",f)))),t.forEachManipulator((t=>M.push(t.events.on("select-changed",f)))),f()};return b(),p.push(t.onManipulatorsChanged(b),s((()=>i(M)))),i(p)}(t,l.visualElement,n),h=[l,p,e.maskOccludee(o),e.trackGraphicState(n)];return{visualElement:l.visualElement,remove:()=>i(h).remove()}}(t);default:return null}}const La=[1,.5,0],Va=Math.ceil(70/3*2),za=5*Math.PI/12,Ca=1*Math.PI/3;class Ua{constructor(){this._available=!0}set location(t){this._forEachManipulator3D((e=>e.location=t))}set elevationAlignedLocation(t){this._forEachManipulator3D((e=>e.elevationAlignedLocation=t))}set elevationInfo(t){this._forEachManipulator3D((e=>e.elevationInfo=t))}get renderLocation(){let t;return this._forEachManipulator3D((e=>{t||(t=e.renderLocation)})),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D((e=>e.available=t))}get hovering(){return this.someManipulator((t=>t.hovering))}get grabbing(){return this.someManipulator((t=>t.grabbing))}get dragging(){return this.someManipulator((t=>t.dragging))}hasManipulator(t){return this.someManipulator((e=>e===t))}someManipulator(t){let e=!1;return this.forEachManipulator((i=>{!e&&t(i)&&(e=!0)})),e}_forEachManipulator3D(t){this.forEachManipulator(((e,i)=>{e instanceof qt&&t(e,i)}))}}function ka(t,e,i,a){const s=t.graphic,o=(t,i)=>e({action:t,graphic:s,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((t,e,i)=>{const r=e.next((t=>("start"===t.action&&o("start",t),t))).next(Qe(s,a)).next((t=>{switch(t.action){case"start":case"update":(t.translationX||t.translationY||t.translationZ)&&o("update",t);break;case"end":o("end",t)}return t}));return i.next(Je(s)).next((()=>{o("end",{screenDeltaX:0,screenDeltaY:0})})),r}))}function Na(t){if(o(t)||"polyline"!==t.type&&"polygon"!==t.type)return 0;const e=("polyline"===t.type?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],a=e[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class Fa extends Ua{constructor(t){super(),this._handles=new Ee,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=70,this._updateAfterDrag=!1,this.events=new re,this._tool=t.tool,this._view=t.view,null!=t.radius&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}set orthogonalAvailable(t){this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._handles=l(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:e}of this._arrowManipulatorInfos)t(e,Ea.TRANSLATE_XY)}createGraphicDragPipeline(t,e,i){const a=e.graphic,s=j(a),o=p(a.geometry).spatialReference;return ka(e,i,(e=>this.createDragPipeline(((i,a,s,o,r)=>e(i,t(i,a,s,o,r),s)),s,o,a)),this._view.state.viewingMode)}createDragPipeline(t,e,a,s){return i(this._arrowManipulatorInfos.map((({manipulator:i},o)=>Ke(i,((i,r,n,l,p)=>{const h=r.next((t=>({...t,manipulatorType:Ea.TRANSLATE_XY}))).next($e(this._view,i.elevationAlignedLocation)).next(He(this._view,i.elevationAlignedLocation,e,a,s)).next(ti(i.location,this.angle+(o+1)*Math.PI*.5)).next(ei());t(i,h,n,l,p)})))))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:e},i){const a=this._radius/70,s=54*a,o=s*Math.sqrt(3)/2,r=Bt.createExtrudedTriangle(o,s/2,s/2,.02);Bt.transformInPlace(r,we(Ne.get(),L(ke.get(),0,-o/3,0))),t.renderObjects=[{geometry:r,material:this._opaqueMaterial,stateMask:li.Focused},{geometry:r,material:this._transparentMaterial,stateMask:li.Unfocused}],t.radius=o/3*2*1.2;const n=Ae(Ne.get(),i*Math.PI/2),l=we(Ne.get(),L(ke.get(),0,100*a,0));Te(e,n,l)}_createManipulators(){for(let t=0;t<4;t++){const e=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(e)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,e=Ge(Ne.get(),t,U(0,0,1));if(o(e))return;const i=De(Ne.get(),L(ke.get(),this.displayScale,this.displayScale,this.displayScale)),a=Te(Ne.get(),i,e);for(const t of this._arrowManipulatorInfos){const e=Te(Ne.get(),a,t.transform);t.manipulator.modelTransform=e}}_createArrowManipulator(t){const e=new qt({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:U(0,0,1)}}),i={manipulator:e,transform:ze()};return this._updateArrowManipulator(i,t),this._handles.add(e.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}_createMaterial(t=1){const e=Oe.toUnitRGBA(kt.main);return e[3]*=t,new ni({color:e,transparent:1!==t,cullFace:Zt.Back,renderOccluded:Yt.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:t})=>t))}}}class Ha{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new ii,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&r(this.lastDragEvent)){const e=this.lastDragEvent.mapEnd,i=this._snap(this.lastDragEvent.screenEnd);if(r(i)){const a={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===t?i:e,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(a)}}this._enabled=t}_snap(t){const e=r(this.view)?this.view.toMap(t,{exclude:[]}):null;return r(e)&&r(this.view)&&(e.z=E(e,this.view,this.elevationInfo)),e}createDragEventPipelineStep(t,e){return this.view=t,this.elevationInfo=e,this.lastDragEvent=null,t=>{if(this.lastDragEvent="end"!==t.action?{...t}:null,this._enabled){const e=this._snap(t.screenEnd);return r(e)?{action:t.action,mapStart:t.mapStart,mapEnd:e,screenStart:t.screenStart,screenEnd:t.screenEnd}:null}return{action:t.action,mapStart:t.mapStart,mapEnd:t.mapEnd,screenStart:t.screenStart,screenEnd:t.screenEnd}}}}class Za extends Ua{constructor(t){super(),this._snapToScene=new Ha,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=70,this._view=t.view,this._tool=t.tool,null!=t.snapToScene&&(this.snapToScene=t.snapToScene),null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,Ea.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,e,i){const a=e.graphic,s=j(a),o=p(a.geometry).spatialReference;return ka(e,i,(e=>this.createDragPipeline(((i,a,s,o,r)=>e(i,t(i,a,s,o,r),s)),s,o,a)),this._view.state.viewingMode)}createDragPipeline(t,e,i,a){const s=this._view;return Ke(this._manipulator,((o,r,n,l,p)=>{const h=r.next($e(s,o.elevationAlignedLocation)).next(He(s,o.elevationAlignedLocation,e,i,a)).next(this._snapToScene.createDragEventPipelineStep(s,e),this._snapToScene.next).next((t=>({...t,manipulatorType:Ea.TRANSLATE_XY}))).next(ei());t(o,h,n,l,p)}))}_updateManipulatorTransform(){const t=De(Ne.get(),L(ke.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new qt({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:U(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=Bt.createCylinderGeometry(.02,1,128,U(0,0,1),U(0,0,0)),e=De(ze(),U(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:t,material:this._discMaterial,transform:e,stateMask:li.Focused},{geometry:t,material:this._discMaterialTransparent,transform:e,stateMask:li.Unfocused}],this._manipulator.radius=this._radius/70*80}_createMaterial(t=1){const e=Oe.toUnitRGBA(kt.main);return e[3]*=t,new ni({color:e,transparent:1!==t,cullFace:Zt.Back,renderOccluded:Yt.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Ba extends Ua{constructor(t){super(),this._radius=70,this.events=new re,this._tool=t.tool,this._view=t.view,null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,Ea.TRANSLATE_Z)}createGraphicDragPipeline(t,e,i){const a=p(e.graphic.geometry).spatialReference;return ka(e,i,(e=>this.createDragPipeline(((i,a,s,o,r)=>e(i,t(i,a,s,o,r),s)),a)),this._view.state.viewingMode)}createDragPipeline(t,e){const i=this._view;return Ke(this._manipulator,((a,s,o,r,n)=>{const l=s.next((t=>({...t,manipulatorType:Ea.TRANSLATE_Z}))).next(Ze(i,a.renderLocation,e)).next(ei());t(a,l,o,r,n)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._radius/70,e=Ct.zManipulator.height*t,i=Ct.zManipulator.coneHeight*t,a=Ct.zManipulator.coneWidth*t,s=Ct.zManipulator.width*t,o=[U(0,0,0),U(0,0,e)],r=Bt.createTubeGeometry(o,s/2,16,!1),n=Bt.createConeGeometry(i,a/2,16,!1),l=[U(0,0,0),U(0,0,e+i)],p=(t=>{const i=ze();return Ie(i,i,[0,0,e]),Re(i,i,Math.PI/2),i})(),h=(t,e)=>{const i=hi(Ct.zManipulator.color,e);return[i.r/255,i.g/255,i.b/255,Ct.zManipulator.color.a*t]},c=Wt(h(1,.25),Yt.Occlude),u=Wt(h(1,0),Yt.Occlude),d=Wt(h(.7,0),Ct.zManipulator.renderOccluded),m=Wt(h(.85,0),Ct.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:n,transform:p,material:c,stateMask:li.Unfocused},{geometry:r,material:c,stateMask:li.Unfocused},{geometry:n,transform:p,material:u,stateMask:li.Focused},{geometry:r,material:u,stateMask:li.Focused},{geometry:n,transform:p,material:d,stateMask:li.Unfocused},{geometry:r,material:d,stateMask:li.Unfocused},{geometry:n,transform:p,material:m,stateMask:li.Focused},{geometry:r,material:m,stateMask:li.Focused}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const t=new qt({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=t=>{const e=this._view.state.camera,i=Ya;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const a=k(e.eye,i),s=e.computeRenderPixelSizeAtDist(a),o=N(Xa,i,e.eye);F(o,o);const r=qa;this._view.renderCoordsHelper.worldUpAtPosition(Ya,r);const n=Math.abs(H(o,r)),l=Z(Xa,o,r),p=Z(Xa,l,r),h=B(n,.01,1),c=1-Math.sqrt(1-h*h)/h/e.fullWidth,u=this._radius/70,d=Ct.zManipulator.width*u;C(p,F(p,p),(1/c-1)*a+s*d),t[12]-=Xa[0],t[13]-=Xa[1],t[14]-=Xa[2]},this._manipulator=t,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const Ya=I(),Xa=I(),qa=I();class Wa extends Ua{constructor(t){super(),this._handles=new Ee,this._angleDeferred=null,this._interactive=!0;const{tool:e,view:i,snapToScene:a,radius:s}=t;this._view=i,this.xyManipulation=new Za({tool:e,view:i,snapToScene:a,radius:s}),this.xyAxisManipulation=new Fa({tool:e,view:i,radius:s}),this.zManipulation=new Ba({tool:e,view:i,radius:s}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator((t=>{this._handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,e,a){return i([this.xyManipulation.createGraphicDragPipeline(((e,i,a,s,o)=>t(Ja.XY,e,i,a,s,o)),e,a),this.xyAxisManipulation.createGraphicDragPipeline(((e,i,a,s,o)=>t(Ja.XY_AXIS,e,i,a,s,o)),e,a),this.zManipulation.createGraphicDragPipeline(((e,i,a,s,o)=>t(Ja.Z,e,i,a,s,o)),e,a)])}createDragPipeline(t,e,a,s){return i([this.xyManipulation.createDragPipeline(((e,i,a,s,o)=>t(Ja.XY,e,i,a,s,o)),e,a,s),this.xyAxisManipulation.createDragPipeline(((e,i,a,s,o)=>t(Ja.XY_AXIS,e,i,a,s,o)),e,a,s),this.zManipulation.createDragPipeline(((e,i,a,s,o)=>t(Ja.Z,e,i,a,s,o)),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this._angleDeferred=null,this.xyAxisManipulation.angle=t}set angleDeferred(t){this.xyAxisVisible?this.angle=t():this._angleDeferred=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator((e=>t(e,Ea.TRANSLATE_XY))),this.xyAxisManipulation.forEachManipulator((e=>t(e,Ea.TRANSLATE_XY))),this.zManipulation.forEachManipulator((e=>t(e,Ea.TRANSLATE_Z)))}get xyAxisVisible(){const t=this.xyManipulation.someManipulator((t=>t.focused))||this.xyAxisManipulation.someManipulator((t=>t.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(M("esri-mobile"))return;const i=[];e.forEachManipulator((t=>i.push(t))),t.forEachManipulator((t=>i.push(t)));const a=()=>{const e=[];this.xyAxisVisible?r(this._angleDeferred)&&(this.angle=this._angleDeferred()):t.forEachManipulator((t=>e.push(t.disableDisplay()))),this._handles.remove(Qa),this._handles.add(e,Qa)};for(const t of i)this._handles.add(t.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(y((()=>this._view.inputManager?.latestPointerType),a)),a()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator((e=>{e.interactive=!t&&this._interactive||e.grabbing}))}static radiusForSymbol(t){const e=r(t)&&"point-3d"===t.type&&t.symbolLayers;return e&&e.length>0&&e.some((t=>"icon"===t.type))?Va:70}}const Qa="disable-xy-axis-display";var Ja;!function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"}(Ja||(Ja={}));class Ka extends Ua{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,Ea.TRANSLATE_XY)}createGraphicDragPipeline(t){return ka(this._graphicState,t,(t=>this.createDragPipeline(t)),this._view.state.viewingMode)}createDragPipeline(t){const e=this._view,i=this._graphicState.graphic,a=r(i.geometry)?i.geometry.spatialReference:null;return Ke(this._manipulator,((s,o,r,n,l)=>{const p=o.next(Be(l,e,i,a)).next(ai()).next(ei());t(s,p,r,n,l)}))}_createManipulator(){const t=this._view,e=this._graphicState.graphic;this._manipulator=new ci({graphic:e,view:t,selectable:!0,cursor:"move"})}}let $a=class extends Tt{constructor(t){super(t),this.type="translate-graphic",this.distance=Oi}};t([f()],$a.prototype,"type",void 0),t([f()],$a.prototype,"distance",void 0),$a=t([b("esri.views.interactive.tooltip.TranslateGraphicTooltipInfo")],$a);let ts=class extends Tt{constructor(t){super(t),this.type="translate-z",this.distance=Oi}};t([f()],ts.prototype,"type",void 0),t([f()],ts.prototype,"distance",void 0),ts=t([b("esri.views.interactive.tooltip.TranslateZTooltipInfo")],ts);let es=class extends Tt{constructor(t){super(t),this.type="translate-vertex",this.distance=Oi,this.elevation=null,this.area=null,this.totalLength=null}};t([f()],es.prototype,"type",void 0),t([f()],es.prototype,"distance",void 0),t([f()],es.prototype,"elevation",void 0),t([f()],es.prototype,"area",void 0),t([f()],es.prototype,"totalLength",void 0),es=t([b("esri.views.interactive.tooltip.TranslateVertexTooltipInfo")],es);class is{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class as{constructor(t,e,i){this.dx=t,this.dy=e,this.allGraphics=i,this.type="graphic-move"}}class ss{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}let os=class extends(ne(re.EventedMixin(si))){constructor(t){super(t),this.graphics=new oe,this.enableZ=!0,this.tooltipOptions=new se,this.type="move-3d",this._snappingPipeline=new Si,this._tooltip=null}initialize(){const{graphics:t,view:e}=this;this.own([t.on("change",(()=>this._refreshManipulators())),d((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new Dt({view:e}):l(this._tooltip)}),_)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=l(this._tooltip),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter((t=>he(t)===ce.SUPPORTED)).map((t=>new rs(t)));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map((t=>this.view.trackGraphicState(t.state)))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new Ka({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator((t=>this.handles.add([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:i}=this;o(i)||("focus"===t?i.info=new $a({tooltipOptions:e}):i.clear())}))]))),this.handles.add(e.manipulationXY.createDragPipeline(((e,i,a,s)=>this._buildDragEventPipeline(t,Ja.XY,e,i,a,s))))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new Wa({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?Wa.radiusForSymbol(t[0].graphic.symbol):70});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(((t,i)=>{this.handles.add(t.events.on("immediate-click",(i=>{e.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()}))),i===Ea.TRANSLATE_XY&&this.handles.add(t.events.on("focus-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:i}=this;o(i)||("focus"===t?i.info=new $a({tooltipOptions:e}):i.clear())}))),i===Ea.TRANSLATE_Z&&this.handles.add(t.events.on("focus-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:i}=this;o(i)||("focus"===t?i.info=new ts({tooltipOptions:e}):i.clear())})))}));const i=()=>this._updateMoveManipulation(t);for(const e of t)this.handles.add([e.state.on("changed",i),d((()=>e.state.displaying),i)]);const a=t[t.length-1];this.handles.add(a.state.on("changed",(()=>this._updateMoveManipulationAngle(a)))),this.handles.add(e.createDragPipeline(((e,i,a,s,o)=>this._buildDragEventPipeline(t,e,i,a,s,o)),j(a.graphic),p(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(t){for(const i of t){const a=i.graphic,s=Pa({view:this.view,graphic:a,forEachManipulator:t=>{i.manipulationXY.forEachManipulator(t),this._moveManipulation.forEachManipulator(t)},onManipulatorsChanged:()=>e()});o(s)||(i.geometryRepresentation=s.visualElement,i.geometryRepresentation instanceof Ut&&this.handles.add([i.geometryRepresentation.events.on("attachment-origin-changed",(()=>{i.state.isDraped||this._updateMoveManipulation(t)})),d((()=>i.state.isDraped),(()=>this._updateMoveManipulation(t)))]),this.handles.add(s))}}_updateMoveManipulationAngle(t){this._moveManipulation.angleDeferred=()=>Na(t.graphic.geometry)}_updateMoveManipulation(t){const e=pe(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const s of t){if(!s.state.displaying)continue;const t=s.state.graphic;this.enableZ&&me(t)&&(a=!0);const o=s.geometryRepresentation instanceof Ut&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:Qt(this.view,t);r(o)&&(e.x+=o.x,e.y+=o.y,e.z+=o.z,i++)}i>0?(e.x/=i,e.y/=i,e.z/=i,s.location=e,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}_buildDragEventPipeline(t,e,i,a,s,o){const r=[],n=[];let l=null,p=null;const h=()=>{for(const t of r)t.dragging=!1;r.length=0,n.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(1===t.length&&e===Ja.XY){const e=t[0].graphic;a=this._buildSnappingPipelineSteps(e,j(e),a,s,o)}const c=a.next((e=>{if("start"===e.action){r.length=0,n.length=0;for(const e of t)e.dragging||!e.manipulationXY.hasManipulator(i)&&e.manipulationXY.grabbing||(r.push(e),n.push(e.graphic),e.dragging=!0);if(0!==n.length&&(this._moveManipulation.interactive=!1,l=oi(n,this.view.state.viewingMode),p=ri(n),this.emit("graphic-move-start",new is(n)),this.destroyed))return null}return 0!==n.length?e:null})).next((t=>l(t))).next((i=>this._updateMoveTooltip(i,e,t))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),a=i.x-e.x,s=i.y-e.y;if(this.emit("graphic-move",new as(a,s,n)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new ss(n)),this.destroyed)return null;h()}}));return s.next((t=>p(t))).next((()=>{if(this.emit("graphic-move-stop",new ss(n)),this.destroyed)return null;h()})),c}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:s}=this;if(o(s))return t;if(s.clear(),e===Ja.XY||e===Ja.XY_AXIS)if("end"===t.action)s.info=new $a({tooltipOptions:a});else{const e=0===i.length?"absolute-height":i[0].state.isDraped?"on-the-ground":"absolute-height",o=Gt(t.mapStart,t.mapEnd,e);r(o)&&(s.info=new $a({tooltipOptions:a,distance:o}))}return e===Ja.Z&&("end"===t.action?s.info=new ts({tooltipOptions:a}):n(xi(t.mapStart,t.mapEnd),(t=>{s.info=new ts({tooltipOptions:a,distance:t})}))),t}_buildSnappingPipelineSteps(t,e,i,a,s){const r=t.geometry;if(o(r)||"point"!==r.type&&"mesh"!==r.type)return i;const n=("point"===r.type?r:r.anchor).clone(),l=new bi({elevationInfo:e,pointer:s,editGeometryOperations:ui.fromGeometry(n,this.view.state.viewingMode),visualizer:new zt,excludeFeature:t}),p=this.snappingManager;return i.next((e=>(n.z=O(this.view,n,j(t),{mode:"absolute-height",offset:0}),{...e,snapOrigin:l.coordinateHelper.pointToVector(n)}))).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:l,snappingManager:p,cancel:a,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)}get test(){return{tooltip:this._tooltip}}};t([f({constructOnly:!0,nonNullable:!0})],os.prototype,"view",void 0),t([f()],os.prototype,"graphics",void 0),t([f({constructOnly:!0,nonNullable:!0})],os.prototype,"enableZ",void 0),t([f({constructOnly:!0,type:se})],os.prototype,"tooltipOptions",void 0),t([f({constructOnly:!0})],os.prototype,"snappingManager",void 0),t([f()],os.prototype,"type",void 0),t([f()],os.prototype,"updating",null),os=t([b("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],os);class rs{constructor(t){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new te({graphic:t})}get graphic(){return this.state.graphic}}function ns(t,e,i){const a="on-the-ground"===i.mode?mi.XY:mi.XYZ;return new di(t,a,e,0)}function ls(t,e,i){const a=I();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const s=ps(t,e,Di(i.plane)),r=ps(t,e,i.edgeDirection);if(o(s)||o(r))return null;const n=Z(I(),s,r);return Ii(a,n,Ri())}function ps(t,e,i){const a=pe(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),s=I(),o=I();return t.renderCoordsHelper.toRenderCoords(e,s)&&t.renderCoordsHelper.toRenderCoords(a,o)?Y(o,s,o):null}let hs=class extends Tt{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=Oi}};t([f()],hs.prototype,"type",void 0),t([f()],hs.prototype,"distance",void 0),hs=t([b("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],hs);let cs=class extends(re.EventedMixin(le)){constructor(t){super(t),this._vertexManipulatorMaterial=Wt(Ct.colorToVec4(Ct.reshapeManipulators.vertex.color),Ct.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Jt(Ct.colorToVec4(Ct.reshapeManipulators.vertex.outlineColor),Ct.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Jt(Ct.colorToVec4(Ct.reshapeManipulators.vertex.hoverOutlineColor),Ct.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=Wt(Ct.colorToVec4(Ct.reshapeManipulators.edge.color),Ct.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Jt(Ct.colorToVec4(Ct.reshapeManipulators.edge.outlineColor),Ct.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=Wt(Ct.colorToVec4(Ct.reshapeManipulators.edgeOffset.color),Ct.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Wt(Ct.colorToVec4(Ct.reshapeManipulators.edgeOffset.hoverColor),Ct.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=Wt(Ct.colorToVec4(Ct.reshapeManipulators.selected.color),Ct.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Jt(Ct.colorToVec4(Ct.reshapeManipulators.selected.outlineColor),Ct.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Jt(Ct.colorToVec4(Ct.reshapeManipulators.selected.hoverOutlineColor),Ct.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new Ee,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=ys.NONE,this._outlineVisualElement=null,this._segmentLabels=null,this.outputGeometry=null,this._snappingPipeline=new Si,this._snappingPipelineHandle=new Si,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._graphicState=new te({graphic:t});this._tooltip=new Dt({view:e}),this.own([d((()=>i.displaying),(t=>{for(const e of this._manipulatorInfos)e.manipulator.available=t})),d((()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset})),(({labels:t,enabled:e,edgeOffsetEnabled:i})=>{r(t)&&(t.visible=e,t.edgeDistance=i?"far":"default")}),g),y((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),g),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=l(this._segmentLabels),this._tooltip=l(this._tooltip),this._editGeometryOperations=l(this._editGeometryOperations),this._moveManipulation=l(this._moveManipulation),this._graphicMoveManipulation=l(this._graphicMoveManipulation),this._manipulatorHandles=l(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return r(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const t=this._manipulatorInfos.filter((t=>t.manipulator.selected&&"vertex"===t.type));this._removeVertices(t)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=l(this._moveManipulation),this._graphicMoveManipulation=l(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(o(this._editGeometryOperations))return;const t=j(this.graphic);for(const e of this._editGeometryOperations.data.components){for(const i of e.vertices)this._createVertexOrEdgeManipulator(i,t);for(const i of e.edges)this._createVertexOrEdgeManipulator(i,t)}this._createGraphicMoveManipulators(t)}get canRedo(){return r(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return r(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(o(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return r(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(o(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return r(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),o(t)||(l(this._editGeometryOperations),this._editGeometryOperations=ui.fromGeometry(t,this.view.state.viewingMode),this._createManipulators(),l(this._segmentLabels),this._segmentLabels=new fa({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:j(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))}_perGraphicManipulatorDragAction(t,e){if("end"===e.action)return e;let i=0;const a=[],s=this._manipulatorInfos.some((t=>"vertex"===t.type&&t.manipulator.selected)),o=t===_s.SELECTED_OR_ALL&&s;for(const t of this._manipulatorInfos)"vertex"===t.type&&(t.manipulator.grabbing||o&&!t.manipulator.selected||a.push(t),i++);if(0===a.length)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(ys.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(ys.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){let t=0;for(const e of this._manipulatorInfos)"vertex"===e.type&&e.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(ys.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const s=[];for(const e of this._manipulatorInfos)"vertex"===e.type&&(e.manipulator.selected&&!e.manipulator.grabbing||e===t.info)&&s.push(e);this._moveVertices(s,t,gi.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case ys.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case ys.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case ys.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case ys.MOVING:switch(this._reshapeEventState){case ys.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case ys.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case ys.RESHAPING:switch(this._reshapeEventState){case ys.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case ys.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulators(t){const{graphic:e,handles:i,tool:a,view:s}=this,o=this._graphicState;if(this._graphicMoveManipulation=new Ka({tool:a,view:s,graphicState:o}),this.enableMoveGraphic){let t=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,i,a)=>{i.next((t=>this._trackNumDragging(t))).next((e=>("start"===e.action&&(t=p(this._editGeometryOperations).createUndoGroup()),e))).next((t=>this._perGraphicManipulatorDragAction(_s.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(Ja.XY,t),t))).next((e=>{"end"===e.action&&(this._tooltip.clear(),t=h(t))})),a.next(this._cancelDragOperation((()=>t=h(t))))})))}else this._graphicMoveManipulation.forEachManipulator((t=>{t.grabbable=!1,t.cursor=null}));this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(t,!1),t.events.on("immediate-click",(t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))]))),this._moveManipulation=new Wa({tool:a,view:s,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&me(e),snapToScene:!1,radius:Wa.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(((t,a)=>{i.add([this._watchAndUpdateGrabState(t,!1),t.events.on("immediate-click",(i=>{this._moveManipulation.zManipulation.hasManipulator(t)||this._manipulatorInfos.some((t=>t.manipulator.selected))||this.emit("immediate-click",{...i,graphic:e}),i.stopPropagation()}))]),i.add(t.events.on("focus-changed",(({action:t})=>{"focus"===t&&this._tooltipOptions.enabled?this._updateTranslateTooltip(a===Ea.TRANSLATE_Z?Ja.Z:Ja.XY):this._tooltip.clear()})))})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const n=p(e.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline(((i,s,o,r,n)=>{const l=o.next((t=>this._trackNumDragging(t))).next((t=>{const e=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));return t.manipulatorType===Ea.TRANSLATE_XY&&1===e.length?{...t,info:e[0],snapOrigin:e[0].handle.pos}:{...t,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:t=>!!t.info,cancel:r,snappingManager:a.snappingManager,snappingContext:new bi({editGeometryOperations:p(this._editGeometryOperations),elevationInfo:t,pointer:n,excludeFeature:e,visualizer:new zt}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(ai()).next((t=>this._perGraphicManipulatorDragAction(_s.SELECTED_OR_ALL,t))).next((t=>(this._updateTranslateTooltip(i,t),t)));return r.next(this._cancelDragOperation()),l}),t,n,e),d((()=>o?.displaying),(()=>{this._updateMoveManipulationPosition()}),g),o.on("changed",(()=>this._updateMoveManipulationPosition())),d((()=>o?.isDraped),(t=>{const e="align-move-manipulation";t?i.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):i.remove(e)}),g)]),this._updateMoveManipulationPosition();const l=Pa({view:s,graphic:e,forEachManipulator:t=>{if(!this.destroyed){r(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(t);for(const e of this._manipulatorInfos)t(e.manipulator,Ea.TRANSLATE_XY);this._moveManipulation.forEachManipulator(t)}},onManipulatorsChanged:t=>this.on("manipulators-changed",t)});r(l)&&(this._outlineVisualElement=l.visualElement instanceof Ut?l.visualElement:null),r(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{o.isDraped||this._updateMoveManipulationPosition()})),d((()=>o.isDraped),(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(l)}_createEdgeOffsetManipulator(t,e=j(this.graphic)){const a=Ct.reshapeManipulators.edgeOffset,s=a.size/2,n=s+a.collisionPadding;if(o(this._edgeOffsetManipulatorGeometryInside)||o(this._edgeOffsetManipulatorGeometryOutside)){const t=s/n,e=t*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=Bt.createExtrudedTriangle(e,t/2,t/2,a.height,a.offset),this._edgeOffsetManipulatorGeometryOutside=Bt.createExtrudedTriangle(-e,t/2,t/2,a.height,-a.offset)}const l=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:li.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:li.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:li.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:li.Focused}],p=new qt({view:this.view,renderObjects:l,elevationInfo:"on-the-ground"!==e.mode||Vi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:U(0,0,1)},collisionPriority:1}),h=new qt({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),c={manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(c,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(c);const u=this._getManipulatorInfoFromHandle(c.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))),d=this._getManipulatorInfoFromHandle(c.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c)));c.locationUpdateHandle=i([u,d]),this._manipulatorHandles.add(c.locationUpdateHandle,p),this._manipulatorHandles.add([this._watchAndUpdateGrabState(p,!0),this._watchAndUpdateGrabState(h,!0)],p),this._manipulatorHandles.add(Ke(p,this._createEdgeOffsetPipeline(c,e)),p),this._manipulatorHandles.add(Ke(h,((t,i,a,s)=>{if("touch"===s)this._createEdgeOffsetPipeline(c,e)(t,i,a);else if(this.enableMoveGraphic){const s=this.graphic,o=r(s.geometry)?s.geometry.spatialReference:null;i.next((t=>this._trackNumDragging(t))).next($e(this.view,t.elevationAlignedLocation)).next(He(this.view,t.elevationAlignedLocation,e,o,s)).next(ei()).next(ai()).next((t=>this._perGraphicManipulatorDragAction(_s.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(Ja.XY,t),t))).next((t=>{"end"===t.action&&this._tooltip.clear()})),a.next(this._cancelDragOperation())}})),p);const m=t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()};return this._manipulatorHandles.add([p.events.on("immediate-click",m),h.events.on("immediate-click",m),p.events.on("focus-changed",(({action:t})=>{const e=this._tooltipOptions;"focus"===t&&e.enabled?this._tooltip.info=new hs({tooltipOptions:e}):this._tooltip.clear()}))],p),this._manipulatorInfos.push(c),this.manipulators.add(p),this.manipulators.add(h),this.emit("manipulators-changed"),c}_autoHideEdgeOffsetManipulator(t,e){const a=t.manipulator,s=t.edgeManipulator,o=()=>{h(t.visibilityHandle);const o=function(t,e,i){const a=i.projectToRenderScreen(t,T()),s=i.projectToRenderScreen(e,T());return r(a)&&r(s)?X(N(a,a,s)):0}(this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<e;(!a.focused&&!s.focused||o)&&(a.grabbable=!o,s.grabbable=!o,t.visibilityHandle=i([a.disableDisplay(),{remove:()=>{a.grabbable=!0,s.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([a.events.on("focus-changed",o),s.events.on("focus-changed",o),{remove:()=>{h(t.visibilityHandle),this.manipulators.remove(s)}}],a),o()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const e=p(this._editGeometryOperations).data.coordinateHelper,i=ls(this.view,t.manipulator.elevationAlignedLocation,ns(e,t.handle,p(t.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,o=r(i)?function(t,e,i){const a=Di(t),s=Y(I(),e,i),o=Z(I(),s,a),r=Z(I(),s,o);return Ce(s[0],s[1],s[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,0,0,0,1)}(i,a,s):Ue;t.manipulator.modelTransform=o,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=o;const n=q(N(ms,a,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-n,0,0],[n,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,s)=>{this._clearSelection();const{step:o,cleanup:r}=this._initializeEdgeOffset(t,e);a.next((t=>this._trackNumDragging(t))).next($e(this.view,i.elevationAlignedLocation)).next(o).next(Ye(this.view)).next(Xe(this.view,p(this._editGeometryOperations).data.spatialReference)).next(ai()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next((t=>{"end"===t.action&&r()})),s.next((t=>(r(),t))).next((t=>(this._tooltip.clear(),t))).next(this._cancelDragOperation())}}_initializeEdgeOffset(t,e){const s=p(this._editGeometryOperations),r=ns(s.data.coordinateHelper,t.handle,e),n=s.createUndoGroup(),l=ls(this.view,t.manipulator.elevationAlignedLocation,r);r.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge),1),r.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge),0);const c=()=>new Gi({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:p(this._editGeometryOperations).data.spatialReference}),u=new Ut({view:this.view,isDraped:this._graphicState.isDraped,geometry:c(),elevationInfo:t.elevationInfo,width:Ct.visualElements.lineGraphics.outline.width,color:Ct.colorToVec4(kt.main),attached:!0});let m;const g=()=>{this._cleanEdgeOffsetCollapsedEdges(t),m=h(m)},y=this.on("undo",g);return m=i([a(u),d((()=>this._graphicState.isDraped),(t=>u.isDraped=t)),this._graphicState.on("changed",(()=>u.geometry=c())),n,y]),{step:t=>o(r)||o(l)?(g(),null):{...t,operation:r,plane:l},cleanup:g}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||o(e.operation))return e;this._updateEventState(ys.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=e;return(i||a||s)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;if(o(e)||o(i))return t;const a=e.signedDistanceToPoint(i);return{...t,signedDistance:a}}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,s=this._tooltip,n=this._tooltipOptions;if(!n.enabled||o(i))return s.clear(),t;const l=function(t,e,i,a,s){if(t){const t=s.toXYZ(s.pointToVector(i)),o=Pi(a,t,ke.get()),n=Pt(o,t,s.spatialReference);if(r(n))return wi(n.value*Math.sign(e),n.unit)}return wi(e*lt(i.spatialReference),"meters")}(this._graphicState.isDraped,-i,e,a.plane,p(this._editGeometryOperations).data.coordinateHelper);return o(s.info)||"reshape-edge-offset"!==s.info.type?s.info=new hs({tooltipOptions:n,distance:l}):s.info.distance=l,t}}_cleanEdgeOffsetCollapsedEdges(t){const e=t.handle.leftVertex.leftEdge?.leftVertex,i=t.handle.leftVertex,a=t.handle.rightVertex.rightEdge?.rightVertex,s=t.handle.rightVertex,o=p(this._editGeometryOperations).data.coordinateHelper,r=1e-6,n=[];e&&o.distance(e.pos,i.pos)<r&&n.push(this._getManipulatorInfoFromHandle(i)),(o.distance(i.pos,s.pos)<r||a&&o.distance(a.pos,s.pos)<r)&&n.push(this._getManipulatorInfoFromHandle(s)),n.length&&this._removeVertices(n)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=j(this.graphic)){if("edge"===t.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(o(this._vertexManipulatorGeometry)||o(this._vertexManipulatorOutlineGeometry)){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(Ct.reshapeManipulators.vertex);this._vertexManipulatorGeometry=Bt.createSphereGeometry(t,16,16),this._vertexManipulatorOutlineGeometry=Bt.createSphereGeometry(e,16,16)}if(o(this._edgeManipulatorGeometry)||o(this._edgeManipulatorOutlineGeometry)){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(Ct.reshapeManipulators.edge);this._edgeManipulatorGeometry=Bt.createSphereGeometry(t,16,16),this._edgeManipulatorOutlineGeometry=Bt.createSphereGeometry(e,16,16)}const a=r(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:gs.Vertex|li.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:gs.Vertex|li.Unfocused|li.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:gs.Vertex|li.Focused|li.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:li.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:li.Selected|li.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:li.Selected|li.Focused}];this.enableMidpoints&&a.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:gs.Edge|li.Focused|li.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:gs.Edge|li.Focused|li.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:gs.Edge|li.Unfocused|li.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:gs.Edge|li.Unfocused|li.Unselected});const s=new qt({view:this.view,renderObjects:a,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(s,t,e);const n="edge"===t.type?{manipulator:s,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:s,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(n),this.manipulators.add(s),this._updateManipulatorPosition(n),"edge"===n.type){const t=this._getManipulatorInfoFromHandle(n.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(n))),e=this._getManipulatorInfoFromHandle(n.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(n)));n.locationUpdateHandle=i([t,e]),this._manipulatorHandles.add(n.locationUpdateHandle,s)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(s,!0),s);const l=Ke(s,((t,i,a,s)=>{let o=null;i.next((t=>this._trackNumDragging(t))).next((t=>{if("start"===t.action&&(o=p(this._editGeometryOperations).createUndoGroup()),"edge"===n.type){const e=this._splitEdgeManipulator(n);return{...t,info:e,snapOrigin:e.handle.pos}}return{...t,info:n,snapOrigin:n.handle.pos}})).next($e(this.view,t.elevationAlignedLocation)).next(qe(this.view,this.graphic,t.elevationAlignedLocation,t.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new bi({editGeometryOperations:p(this._editGeometryOperations),elevationInfo:e,pointer:s,excludeFeature:this.graphic,visualizer:new zt}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(ai()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(o=h(o)),this._updateTranslateVertexTooltip(t,Ja.XY,e)})),a.next(this._cancelDragOperation((()=>o=h(o))))}));return this._manipulatorHandles.add([l,s.events.on("immediate-click",(t=>this._manipulatorClickCallback(t,n))),s.events.on("select-changed",(()=>{n.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})),s.events.on("focus-changed",(({action:t})=>{"focus"===t&&"edge"!==n.type?this._updateTranslateVertexTooltip(s,Ja.XY):this._tooltip.clear()}))],s),this.emit("manipulators-changed"),n}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_cancelDragOperation(t){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=r(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,r(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case ys.NONE:break;case ys.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case ys.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(ys.NONE)}}_setTypeSpecificManipulatorSettings(t,e,i){switch(e.type){case"vertex":t.state=gs.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=Ct.reshapeManipulators.vertex.size/2+Ct.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=i,t.interactive=r(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":t.state=gs.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=Ct.reshapeManipulators.edge.size/2+Ct.reshapeManipulators.edge.collisionPadding,t.elevationInfo="on-the-ground"!==i.mode||Vi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",(i=>this._onGrabStateChanged(t,e,i.action,i.pointerType)))}_onGrabStateChanged(t,e,i,a="mouse"){if("start"===i)e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(ys.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==a||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((t=>{t.manipulator.interactive=!this._numGrabbing&&r(this.graphic.geometry)&&"point"!==this.graphic.geometry.type,"edgeManipulator"in t&&(t.edgeManipulator.interactive=!this._numGrabbing)})),p(this._graphicMoveManipulation).forEachManipulator((t=>t.interactive=!this._numGrabbing)))}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t&&(t.manipulator.grabbing&&this._onGrabStateChanged(t.manipulator,!1,"end"),this._manipulatorHandles.remove(t.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(t),1),this.manipulators.remove(t.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t)for(const e of this._manipulatorInfos)if(t===e.handle)return e;return null}_updateManipulatorPosition(t){if(!t)return;const e=p(this._editGeometryOperations);if("vertex"===t.type)t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,ds),t.manipulator.grabbing&&r(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if("edge"===t.type){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator;if(r(t.manipulator.elevationInfo)&&"on-the-ground"===t.manipulator.elevationInfo.mode){const s=i.location,o=a.location,r=.5,n=s.x+r*(o.x-s.x),l=s.y+r*(o.y-s.y),p=s.hasZ&&o.hasZ?0:void 0;t.manipulator.location=pe(n,l,p,e.data.spatialReference)}else W(ms,i.renderLocation,a.renderLocation,.5),t.manipulator.renderLocation=ms}}_splitEdgeManipulator(t,e=.5){const i=p(this._editGeometryOperations),a=p(i.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const s=j(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(t),o=this._createVertexOrEdgeManipulator(a)):(o=t,o.handle=a,o.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(o),this.enableEdgeOffset||this._updateTranslateVertexTooltip(o.manipulator,Ja.XY),this._updateSelection(t.manipulator);const r=this._updateEventState(ys.RESHAPING),n=i.data.coordinateHelper.vectorToArray(o.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:n,componentIndex:l,vertexIndex:p(a.index)}],added:n}),r&&this._updateEventState(ys.NONE),o}_updateMoveManipulationPosition(){const t=L(ms,0,0,0);let e=0,i=!1,a=null,s=null;for(const r of this._manipulatorInfos)"vertex"===r.type&&(r.manipulator.selected?(e++,z(t,t,r.manipulator.renderLocation),o(a)||r.selectedIndex>a.selectedIndex?(s=a,a=r):(o(s)||r.selectedIndex>s.selectedIndex)&&(s=r)):i=!0);if(0!==e){const t=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.zManipulation.available=t&&this.enableZVertex&&me(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t&&1!==e}else{const t=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t,this._moveManipulation.zManipulation.available=t&&this.enableZShape&&me(this.graphic)}if(0!==e){let t=0;if(r(a)){const e=a.handle.pos,i=r(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,n=o(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;i&&n?this._moveManipulation.xyAxisManipulation.available=!1:i?t=us(i,e):n&&(t=us(e,n))}this._moveManipulation.angle=t,this._moveManipulation.radius=Va}else this._moveManipulation.angleDeferred=()=>Na(p(this.graphic.geometry)),this._moveManipulation.radius=Wa.radiusForSymbol(this.graphic.symbol);0!==e&&i?(C(t,t,1/e),ds.spatialReference=p(this._editGeometryOperations).data.spatialReference,ds.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,ds),this._moveManipulation.elevationAlignedLocation=ds):r(this._outlineVisualElement)&&!this._graphicState.isDraped&&r(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Kt(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const e=[],i=p(this._editGeometryOperations);for(const a of t)if("vertex"===a.type&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const t=p(i.removeVertices([a.handle]).removedVertices[0].createdEdge);t&&this._createVertexOrEdgeManipulator(t)}if(e.length>0){const t=e.map((t=>{const e=i.data.components.indexOf(t.component);return{coordinates:i.data.coordinateHelper.vectorToArray(t.pos),componentIndex:e,vertexIndex:p(t.index)}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(ys.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:t.map((t=>t.coordinates)),vertices:t}),this.destroyed)return;if(a&&(this._updateEventState(ys.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=("start"===e.action?gi.NEW_STEP:gi.ACCUMULATE_STEPS)){const a=p(this._editGeometryOperations);a.moveVertices(t.map((t=>t.handle)),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const e of t)this._updateManipulatorPosition(e)}_offsetEdge(t,e){if(o(e.operation)||o(e.signedDistance))return;const i=p(this._editGeometryOperations),a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),"vertex"===e.type&&(e.manipulator.selected=!e.manipulator.selected,t.button===zi.Right&&this._removeVertices([e])),"edge"===e.type&&t.button===zi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));1===i.length?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const i=this._tooltipOptions;if(!i.enabled)return;const a=t===Ja.Z,s=a?new ts({tooltipOptions:i}):new $a({tooltipOptions:i});if(r(e)&&"end"!==e.action){const{mapStart:t,mapEnd:i}=e,o=a?xi(t,i):Gt(t,i,this._graphicState.isDraped?"on-the-ground":"absolute-height");s.distance=r(o)?o:Oi}this._tooltip.info=s}_updateTranslateVertexTooltip(t,e,i){const a=this._tooltipOptions;if(!a.enabled)return;const s=e===Ja.Z,o=new es({tooltipOptions:a});if(r(i)&&"end"!==i.action){const{mapStart:t,mapEnd:e}=i,a=s?xi(t,e):Gt(t,e,this._graphicState.isDraped?"on-the-ground":"absolute-height");o.distance=r(a)?a:Oi}const n=ji(t.elevationAlignedLocation);r(n)&&(o.elevation={mode:"absolute-height",...n});const{geometry:l}=this.graphic;r(l)&&!s&&(o.area="polygon"===l.type?It(l,this._graphicState.isDraped):null,o.totalLength="polyline"===l.type?Rt(l,this._graphicState.isDraped?"on-the-ground":"absolute-height"):null),this._tooltip.info=o}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function us(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}t([f()],cs.prototype,"_segmentLabels",void 0),t([f({constructOnly:!0})],cs.prototype,"tool",void 0),t([f()],cs.prototype,"_tooltip",void 0),t([f()],cs.prototype,"inputGeometry",null),t([f()],cs.prototype,"outputGeometry",void 0),t([f({readOnly:!0})],cs.prototype,"updating",null),t([f()],cs.prototype,"manipulators",null),t([f()],cs.prototype,"view",null),t([f()],cs.prototype,"graphic",null),t([f()],cs.prototype,"enableZShape",null),t([f()],cs.prototype,"enableZVertex",null),t([f()],cs.prototype,"enableMoveGraphic",null),t([f()],cs.prototype,"enableMidpoints",null),t([f()],cs.prototype,"enableEdgeOffset",null),t([f()],cs.prototype,"_labelOptions",null),t([f()],cs.prototype,"_tooltipOptions",null),cs=t([b("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],cs);const ds=pe(0,0,null,null),ms=I();var gs,ys,_s;!function(t){t.Vertex=pi.Custom1,t.Edge=pi.Custom2}(gs||(gs={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(ys||(ys={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(_s||(_s={}));let vs=class extends(re.EventedMixin(si)){constructor(t){super(t),this._handles=new Ee,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new ae,this.tooltipOptions=new se,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new cs({tool:this});this.own([t.on("reshape",(t=>{"reshape"===t.type&&this._onReshapeGeometryChanged(),this.emit("reshape",t)})),t.on("move",(t=>{"move"===t.type&&this._onReshapeGeometryChanged(),this.emit("move",t)})),t.on("vertex-add",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)})),t.on("vertex-remove",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)})),t.on("immediate-click",(t=>this.emit("immediate-click",t))),this.view.on("pointer-down",["Shift"],(t=>{t.stopPropagation()})),d((()=>this.graphic),(()=>this._updateGraphic()),_)]),this.finishToolCreation()}destroy(){this._handles=l(this._handles),this._reshapeOperation=l(this._reshapeOperation)}get updating(){return this._reshapeOperation?.updating??!1}_updateGeometry(){const t=ue(this.graphic);this._reshapeOperation.inputGeometry=r(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),de(this.graphic)!==ce.SUPPORTED)return;const t=d((()=>this.graphic?.geometry),(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),v);this._handles.add(t,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){o(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){r(this.snappingManager)&&this.snappingManager.doneSnapping(),r(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){r(this.snappingManager)&&this.snappingManager.doneSnapping(),r(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){"key-down"!==t.type||"Delete"!==t.key&&"Backspace"!==t.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};t([f()],vs.prototype,"_reshapeOperation",void 0),t([f({constructOnly:!0,nonNullable:!0})],vs.prototype,"view",void 0),t([f({constructOnly:!0})],vs.prototype,"graphic",void 0),t([f({constructOnly:!0,nonNullable:!0})],vs.prototype,"enableZShape",void 0),t([f({constructOnly:!0,nonNullable:!0})],vs.prototype,"enableZVertex",void 0),t([f({constructOnly:!0,nonNullable:!0})],vs.prototype,"enableMoveGraphic",void 0),t([f({constructOnly:!0,nonNullable:!0})],vs.prototype,"enableMidpoints",void 0),t([f({constructOnly:!0,nonNullable:!0})],vs.prototype,"enableEdgeOffset",void 0),t([f()],vs.prototype,"type",void 0),t([f({constructOnly:!0,type:ae})],vs.prototype,"labelOptions",void 0),t([f({constructOnly:!0,type:se})],vs.prototype,"tooltipOptions",void 0),t([f({constructOnly:!0})],vs.prototype,"snappingManager",void 0),t([f()],vs.prototype,"updating",null),t([f()],vs.prototype,"automaticManipulatorSelection",void 0),vs=t([b("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],vs);let fs=class extends Tt{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};t([f()],fs.prototype,"type",void 0),t([f()],fs.prototype,"rotation",void 0),t([f()],fs.prototype,"rotationPrecision",void 0),t([f()],fs.prototype,"orientation",void 0),t([f()],fs.prototype,"orientationPrecision",void 0),t([f()],fs.prototype,"rotationType",void 0),fs=t([b("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],fs);let Ms=class extends Tt{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};t([f()],Ms.prototype,"type",void 0),t([f()],Ms.prototype,"scale",void 0),t([f()],Ms.prototype,"size",void 0),t([f()],Ms.prototype,"sizeUnit",void 0),t([f()],Ms.prototype,"sizePrecision",void 0),Ms=t([b("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],Ms);let bs=class extends Tt{constructor(t){super(t),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};var Ss,xs;t([f()],bs.prototype,"type",void 0),t([f()],bs.prototype,"orientation",void 0),t([f()],bs.prototype,"orientationEnabled",void 0),t([f()],bs.prototype,"orientationPrecision",void 0),t([f()],bs.prototype,"rotationType",void 0),t([f()],bs.prototype,"size",void 0),t([f()],bs.prototype,"sizeUnit",void 0),t([f()],bs.prototype,"sizeEnabled",void 0),t([f()],bs.prototype,"sizePrecision",void 0),bs=t([b("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],bs),function(t){t.ScaleIn=pi.Custom2,t.ScaleOut=pi.Custom3,t.RotateLeft=pi.Custom4,t.RotateRight=pi.Custom5,t.Unlocked=pi.Custom7,t.DelayedFocused=pi.Custom8,t.TouchInput=pi.Custom12}(Ss||(Ss={}));class js{constructor({adapter:t,tooltipOptions:e,mode:i,tool:a}){this.mode=null,this._handles=new Ee,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new re,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>r(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1,this.tool=a,this.mode=i,this.adapter=t,this._tooltipOptions=e,this._tooltip=new Dt({view:a.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(y((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),g))}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}destroy(){r(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=l(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=l(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=Ni({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){r(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=l(this._activeAnimation))}forEachManipulator(t){t(this._ringManipulator,Ea.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.graphicState.graphic,i=Ke(t,((t,i,a)=>{this._scaleRotateDragData=null;const s=this.adapter.startInteraction(),o={mode:"none",origin:Q(t.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=o,this._updateDragState();const n=ke.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,n),i.next(We(this.tool.view,Ii(t.renderLocation,n,Ri()))).next((t=>{const i=Di(t.plane),a=$t(t.renderStart,t.renderEnd,o.origin,i),n=ki.shortestSignedDiff(o.angle,a);o.angleDir=B(o.angleDir+n,-.3,.3),o.angle=a;const l=function(t,e){const i=N(ke.get(),e.renderStart,t.origin),a=N(ke.get(),e.renderEnd,t.origin),s=q(i),o=q(a);return 0===s?0:o/s}(o,t),p=l-this.adapter.scale;if(o.scaleDir=B(o.scaleDir+p,-.2,.2),this._onScaleChanged(),"none"===o.mode){const i=this.mode||function(t,e,i,a){const{renderStart:s,renderEnd:o}=t,r=Es(s,a,ke.get()),n=Es(o,a,ke.get());if(K(r,n)<100)return null;const l=N(ke.get(),s,i),p=Z(ke.get(),l,Di(e)),h=s,c=z(ke.get(),h,p),u=Es(i,a,ke.get()),d=r,m=Es(c,a,ke.get()),g=N(ke.get(),m,d),y=N(ke.get(),r,u),_=Hi(d,g),v=Hi(u,y);return Zi(_,n)<Zi(v,n)?"rotate":"scale"}(t,t.plane,o.origin,this.tool.view.state.camera);if(r(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:e,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:e,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}o.mode=i}}switch(o.mode){case"rotate":s.state.angle=o.initialAngle+a;break;case"scale":s.state.scale=l,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:e,angle:J(o.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:e,xScale:l,yScale:l})}break;case"end":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:J(o.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:l,yScale:l})}}return"end"===t.action&&(this.startAnimation(Os(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),s.done()),t})).next(this._updateTooltipPipelineStep(o)),a.next((()=>{if(s.cancel(),r(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:1,yScale:1})}this.startAnimation(Os(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this._handles.add([i,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(function(t,e){let i=0,a=null;const s=()=>!1;return{start:()=>{a=t.getFocused,t.getFocused=s,i=0,e()},update:t=>(i+=t,!a()||i>200?xs.STOP:xs.CONTINUE),destroy:()=>{t.getFocused=a,e()}}}(this,(()=>this._updateDelayedFocusedState()))):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),d((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),g)])}_updateTooltipPipelineStep(t){return e=>{const i=this._tooltipOptions;if(!i.enabled)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const a=this._tooltip,s=this._tooltipOptions.visualVariables,o=r(s)?s.size:null,n=r(s)?s.rotation:null;switch(t.mode){case"scale":a.info=new Ms({tooltipOptions:i,scale:{value:this.adapter.scale},size:wi(c(this.adapter.size,-1),"meters"),sizeUnit:r(o)?o.unit:null,sizePrecision:r(o)?ws(o.valueType):null});break;case"rotate":{const t=r(n)?ws(n.valueType):null,e=r(n)?n.rotationType:"geographic";a.info=new fs({tooltipOptions:i,rotation:Ai(c(-this.adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:t,orientation:Ai(-this.adapter.angle,"radians","geographic"),orientationPrecision:t,rotationType:e})}}return e}}_updateFocusTooltip(){if(this._tooltipOptions.enabled)if(this.getFocused()){const t=this._tooltipOptions.visualVariables,e=r(t)?t.rotation:null,i=r(t)?t.size:null;this._tooltip.info=new bs({tooltipOptions:this._tooltipOptions,orientation:Ai(-this.adapter.angle,"radians","geographic"),orientationEnabled:null==this.mode||"rotate"===this.mode,orientationPrecision:r(e)?ws(e.valueType):null,rotationType:r(e)?e.rotationType:"geographic",size:wi(c(this.adapter.size,-1),"meters"),sizeUnit:r(i)?i.unit:null,sizeEnabled:null==this.mode||"scale"===this.mode,sizePrecision:r(i)?ws(i.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(Ss.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(Ss.Unlocked,!(r(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),r(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(Ss.ScaleIn|Ss.ScaleOut,!1),this._ringManipulator.updateStateEnabled(Ss.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(Ss.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(Ss.RotateLeft|Ss.RotateRight,!1),this._ringManipulator.updateStateEnabled(Ss.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(Ss.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(Ss.ScaleIn|Ss.ScaleOut|Ss.RotateLeft|Ss.RotateRight,!1)}_updateManipulatorTransform(){const t=Ge(Ne.get(),this.adapter.angle,U(0,0,1));if(o(t))return;const e=this.getScale(),i=De(Ne.get(),L(ke.get(),e,e,e));this._ringManipulator.modelTransform=Te(Ne.get(),i,t)}_createRingManipulator(){const t=(t,e,i)=>{const a=[],s=Math.ceil(128*(e-t)/(2*Math.PI));for(let o=0;o<s+1;o++){const r=t+o*(e-t)/s;a.push(U(i*Math.cos(r),i*Math.sin(r),0))}return a},e=e=>t(0,2*Math.PI,e),i=(t,e)=>Bt.createPathExtrusionGeometry((t=>[[-t/2,0],[t/2,0],[t/2,.25],[-t/2,.25]])(e),t,[],[],!1),a=e(160),s=i(a,24),o={left:[],right:[]},r=[];for(let e=0;e<2;e++){const a=e*Math.PI-Math.PI/4,s=Math.PI/2-za,n=a+s,l=a+Math.PI/2-s,p=t(n,l,190),h=i(p,9);r.push(p),r.push(t(n,l,201)),o.left.push(h),o.right.push(h);for(let t=0;t<2;t++){const e=0===t,i=ze();if(e){Pe(i,i,[1,-1,1]),Le(i,i,-n,[0,0,1]);const t=Math.round(.2*(p.length-1));i[12]=p[t][0],i[13]=p[t][1],i[14]=p[t][2]}else{Le(i,i,l,[0,0,1]);const t=Math.round(.8*(p.length-1));i[12]=p[t][0],i[13]=p[t][1],i[14]=p[t][2]}const a=Bt.createExtrudedTriangle(60,0,23,.5);Bt.transformInPlace(a,i),(e?o.left:o.right).push(a)}}const n=[];for(let e=0;e<2;e++){const a=e*Math.PI-Math.PI/4,s=Math.PI/2-Ca,o=a+s,r=a+Math.PI/2-s,l=t(o,r,213);n.push(i(l,9))}const l=e(190),p=e(213),h=i(l,9),c=i(p,9),u=e(130),d=e(107),m=i(u,9),g=i(d,9),y=this._createMaterial(),_=this._createMaterial(.66),v=this._createMaterial(.5),f=this._createMaterial(.33);let M=[{geometry:s,material:y,stateMask:Ss.DelayedFocused},{geometry:s,material:v,stateMask:li.None}];this.mode&&"scale"!==this.mode||(M=M.concat([{geometry:n,material:y,stateMask:Ss.DelayedFocused|Ss.Unlocked},{geometry:h,material:_,stateMask:Ss.DelayedFocused|Ss.ScaleIn},{geometry:c,material:f,stateMask:Ss.DelayedFocused|Ss.ScaleIn},{geometry:m,material:_,stateMask:Ss.DelayedFocused|Ss.ScaleOut},{geometry:g,material:f,stateMask:Ss.DelayedFocused|Ss.ScaleOut}])),this.mode&&"rotate"!==this.mode||(M=M.concat([{geometry:o.right,material:y,stateMask:Ss.DelayedFocused|Ss.Unlocked},{geometry:o.left,material:y,stateMask:Ss.DelayedFocused|Ss.RotateLeft},{geometry:o.right,material:y,stateMask:Ss.DelayedFocused|Ss.RotateRight}]));const b=[a,...r];return new qt({view:this.tool.view,renderObjects:M,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:j(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:b,direction:U(0,0,1)}})}_createMaterial(t=1){const e=Fi([...La,t]);return new ni({color:e,transparent:1!==t,cullFace:Zt.Back,renderOccluded:Yt.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function Es(t,e,i){return e.projectToScreen(t,As),L(i,As[0],As[1],0)}function Os(t,e){let i=null,a=1;const s=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=s,e()},update:t=>(a+=((a+1)/2-a)*Math.min(3*t,1),e(),Math.abs(a-1)<.01?xs.STOP:xs.CONTINUE),destroy:()=>{t.getScale=i,e()}}}function ws(t){switch(t){case"integer":case"long":return 0;default:return null}}!function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(xs||(xs={}));const As=A();function Ts(t){return r(t.geometry)&&"mesh"===t.geometry.type?(e=t.geometry,r(e.transform)?function(t,e){let i=e.clone(),a=null;return{undo:e=>{a=r(t.transform)?t.transform.clone():null,t.transform=i,e.notifyGeometryChanged()},redo:e=>{i=r(t.transform)?t.transform.clone():null,t.transform=a,e.notifyGeometryChanged()}}}(e,e.transform):function(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}(e)):function(t){let e=t.geometry,i=u;return{undo(t){i=t.geometry,t.geometry=e},redo(t){e=t.geometry,t.geometry=i}}}(t);var e}let Gs=class extends le{constructor(t){super(t),this.interactionState=null}initialize(){this.own([y((()=>r(this.interactionState)&&this.interactionState.angle!==this.interactionState.previousAngle?{interactionState:this.interactionState,angle:this.interactionState.state.angle}:null),(({interactionState:t})=>{this._updateMeshRotation(t)}),v),y((()=>r(this.interactionState)&&this.interactionState.scale!==this.interactionState.previousScale?{interactionState:this.interactionState,scale:this.interactionState.state.scale}:null),(({interactionState:t})=>{this._updateMeshSize(t)}),v)])}get angle(){const t=this.geometry.transform;if(o(t))return 0;const e=Yi(t.rotation)[2];return Math.abs(e)>.999999?V(Xi(t.rotation))*Math.sign(e):0}get scale(){return r(this.interactionState)?this.interactionState.scale:1}startInteraction(){const t=new Ds({angle:this.angle});this.interactionState=t;const e=()=>this.interactionState=null;return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return Ts(this.graphic)}_updateMeshRotation(t){const e=this.geometry.anchor,i=this.viewingMode===Ui.Global,{angle:a,previousAngle:s}=t;this.geometry.rotate(0,0,J(a-s),{origin:e,geographic:i}),t.previousAngle=a,r(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const e=this.geometry.anchor,i=this.viewingMode===Ui.Global,{scale:a,previousScale:s}=t;this.geometry.scale(a/s,{origin:e,geographic:i}),t.previousScale=a,r(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};t([f({constructOnly:!0})],Gs.prototype,"graphic",void 0),t([f({constructOnly:!0})],Gs.prototype,"geometry",void 0),t([f({constructOnly:!0})],Gs.prototype,"viewingMode",void 0),t([f()],Gs.prototype,"angle",null),t([f()],Gs.prototype,"scale",null),t([f()],Gs.prototype,"interactionState",void 0),Gs=t([b("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],Gs);let Ds=class extends at{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}cancel(){this.angle=this.initialAngle,this.scale=1}};t([f()],Ds.prototype,"angle",void 0),t([f()],Ds.prototype,"initialAngle",void 0),t([f()],Ds.prototype,"previousAngle",void 0),t([f()],Ds.prototype,"previousScale",void 0),t([f()],Ds.prototype,"scale",void 0),t([f()],Ds.prototype,"state",null),Ds=t([b("InteractionState")],Ds);let Is=class extends le{constructor(t){super(t),this.sizeAxis=null,this.interactionState=null}initialize(){this.own(y((()=>r(this.interactionState)?this.interactionState.state:null),(t=>{this._updateSymbol(t)}),v))}get angle(){return r(this.interactionState)?this.interactionState.angle:r(this._orientationReferenceSymbolLayer)?(t=this._orientationReferenceSymbolLayer.heading,-V(t)):0;var t}get scale(){return r(this.interactionState)?this.interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return r(this.interactionState)?this.interactionState.initialAngle:0}get size(){const t=this._sizeReferenceSymbolLayer;if(o(t))return null;const e=this.findLayerView(),i=this._graphicSymbol;if(o(e)||o(i)||"point-3d"!==i.type)return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&r(a.size))return a.size;const s=this.sizeAxis;return"width"in a&&r(a.width)&&(o(s)||"width"===s||"all"===s||"width-and-depth"===s)?a.width:"depth"in a&&r(t.depth)&&(o(s)||"depth"===s||"all"===s||"width-and-depth"===s)?a.depth:"height"in a&&r(t.height)&&(o(s)||"height"===s||"all"===s)?a.height:null}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return o(t)||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type))}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return o(t)||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type&&r(t.heading)))}get _graphicSymbol(){return r(this.graphic)&&r(this.graphic.symbol)&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(r(this.interactionState)||o(t)||o(e))return Rs;const i=t.symbolLayers.map((i=>"object"===i.type?e.getSymbolLayerSize(t,i):null)).toArray(),a=t.clone(),s=this.angle,n=new Ps({originalSymbol:a,angle:s,initialSizes:i});this.interactionState=n;const l=()=>this.interactionState=null;return{state:n,done:l,cancel:()=>{this._graphicSymbol=a,l()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const s=this._graphicSymbol;if(o(s)||"point-3d"!==s.type)return;const n=s.clone(),l=-J(e-this.initialAngle);let p=!1;this._forEachObjectSymbolLayerPair(i,n,((e,i,s)=>{const o=c(e.heading,0)+l;i.heading!==o&&(i.heading=o,p=!0);const n=a[s];if(r(n)&&"width"in n){n.width=this.sizeFilter(n.width),n.height=this.sizeFilter(n.height),n.depth=this.sizeFilter(n.depth);const e=n.width*t;i.width!==e&&(i.width=e,p=!0);const a=n.depth*t;i.depth!==a&&(i.depth=a,p=!0);const s=n.height*t;i.height!==s&&(i.height=s,p=!0)}})),p&&(this._graphicSymbol=n)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach(((t,a)=>{const s=e.symbolLayers.getItemAt(a);"object"===t.type&&"object"===s.type&&i(t,s,a)}))}};t([f()],Is.prototype,"angle",null),t([f()],Is.prototype,"scale",null),t([f()],Is.prototype,"relativeAngle",null),t([f()],Is.prototype,"initialAngle",null),t([f()],Is.prototype,"size",null),t([f()],Is.prototype,"sizeAxis",void 0),t([f({constructOnly:!0})],Is.prototype,"graphic",void 0),t([f()],Is.prototype,"interactionState",void 0),t([f({constructOnly:!0})],Is.prototype,"findLayerView",void 0),t([f({constructOnly:!0})],Is.prototype,"sizeFilter",void 0),t([f()],Is.prototype,"_sizeReferenceSymbolLayer",null),t([f()],Is.prototype,"_orientationReferenceSymbolLayer",null),t([f()],Is.prototype,"_graphicSymbol",null),Is=t([b("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],Is);const Rs={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let Ps=class extends at{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}}};t([f()],Ps.prototype,"originalSymbol",void 0),t([f()],Ps.prototype,"angle",void 0),t([f()],Ps.prototype,"initialAngle",void 0),t([f()],Ps.prototype,"initialSizes",void 0),t([f()],Ps.prototype,"scale",void 0),t([f()],Ps.prototype,"state",null),Ps=t([b("InteractionState")],Ps);let Ls=class extends(ne(re.EventedMixin(si))){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new se,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new Si,this._tooltip=null}initialize(){const{graphic:t,view:i}=this;this.graphicState=new te({graphic:t}),this.own(d((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new Dt({view:i}):l(this._tooltip)}),_)),this._moveManipulation=new Wa({tool:this,view:i,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&me(t),radius:Wa.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(((e,i)=>this.handles.add([e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:t}),e.stopPropagation()})),e.events.on("focus-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:a}=this;if(!o(a)&&(a.clear(),"focus"===t)){const t=i===Ea.TRANSLATE_Z?ts:$a;a.info=new t({tooltipOptions:e})}}))]))),this._moveManipulation.elevationInfo=j(t);const a=t.geometry;if(this._moveManipulation.createGraphicDragPipeline(((e,s,n,l,p)=>(r(a)&&e===Ja.XY&&(n=n.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new bi({elevationInfo:j(t),pointer:p,editGeometryOperations:ui.fromGeometry(new Ci({spatialReference:a.spatialReference}),i.state.viewingMode),visualizer:new zt,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:l}),this._snappingPipeline.next)),n.next((t=>{const{tooltipOptions:i,_tooltip:a}=this;if(o(a))return t;const{mapStart:s,mapEnd:n}=t;a.clear();const l=e===Ja.Z?ts:$a;if("end"===t.action)a.info=new l({tooltipOptions:i});else{const t=e===Ja.Z?xi(s,n):Gt(s,n,this.graphicState.isDraped?"on-the-ground":"absolute-height");r(t)&&(a.info=new l({tooltipOptions:i,distance:t}))}return t})))),this.graphicState,(t=>{const{action:e,graphic:i,dxScreen:a,dyScreen:s}=t,o={graphic:i,dxScreen:a,dyScreen:s};switch(e){case"start":this.emit("graphic-translate-start",o),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",o);break;case"end":this.emit("graphic-translate-stop",o)}})),this._moveManipulation.angle=r(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(d((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new js({tool:this,mode:t,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.handles.add([Pa({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>e()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),d((()=>i.scale),(()=>this._updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof qt&&this.handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}destroy(){this._tooltip=l(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=l(this._scaleRotate),this._scaleRotateAdapter=l(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){o(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return r(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new Gs({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new Is({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer)),sizeAxis:r(this.tooltipOptions.visualVariables)&&r(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),r(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return d((()=>this.graphicState.displaying),(t=>{this._forEachManipulator((e=>e.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&me(this.graphic)}))}_createGeometryUndoRecord(){return Ts(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,r(this._scaleRotate)&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,r(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){r(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(o(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===Ui.Local||this.view.scale<1e6?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){Kt(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:r(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};t([f({constructOnly:!0,nonNullable:!0})],Ls.prototype,"view",void 0),t([f({constructOnly:!0,nonNullable:!0})],Ls.prototype,"graphic",void 0),t([f({constructOnly:!0,nonNullable:!0})],Ls.prototype,"enableZ",void 0),t([f()],Ls.prototype,"enableRotation",void 0),t([f()],Ls.prototype,"enableScaling",void 0),t([f({constructOnly:!0,type:se})],Ls.prototype,"tooltipOptions",void 0),t([f()],Ls.prototype,"graphicState",void 0),t([f({value:!1})],Ls.prototype,"snapToScene",null),t([f({constructOnly:!0})],Ls.prototype,"snappingManager",void 0),t([f({readOnly:!0})],Ls.prototype,"type",void 0),t([f({readOnly:!0})],Ls.prototype,"updating",null),Ls=t([b("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Ls);class Vs{constructor(){this.lastDragEvent=null,this.next=new ii,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&r(this.lastDragEvent)){const e={...this.lastDragEvent,action:"update"};t&&this._adjustScaleFactors(e),this.next.execute(e)}this._enabled=t}createDragEventPipelineStep(){return this.lastDragEvent=null,t=>(this.lastDragEvent="end"!==t.action?{...t}:null,this._enabled&&this._adjustScaleFactors(t),t)}_adjustScaleFactors(t){const e=Ji(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):0===t.handle.direction[0]?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-e:e,t.factor2=t.factor2<0?-e:e}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}function zs(t,e){return Us(t,e,!1)}function Cs(t,e){return Us(t,e,!0)}function Us(t,e,i){if(t instanceof yi){if(t.operation instanceof _i)return function(t,e,i=!1){const a=i?-1:1,s=U(a*t.dx,a*t.dy,a*t.dz);z(e.origin,e.origin,s)}(t.operation,e,i),!0;if(t.operation instanceof vi)return function(t,e,i=!1){const a=i?-t.angle:t.angle;$(e.basis1,e.basis1,tt,a),$(e.basis2,e.basis2,tt,a)}(t.operation,e,i),!0;if(t.operation instanceof fi)return function(t,e,i=!1){const a=i?1/t.factor1:t.factor1,s=i?1/t.factor2:t.factor2;C(e.basis1,e.basis1,a),C(e.basis2,e.basis2,s),yt(e.origin,e.origin,t.origin,t.axis1,a),yt(e.origin,e.origin,t.origin,t.axis2,s)}(t.operation,e,i),!0}return!1}function ks(t,e,i,a){const s=ke.get();N(s,N(s,t.origin,t.basis1),t.basis2);const r=ke.get();et(r,s,t.basis1,2);const n=ke.get();et(n,r,t.basis2,2);const l=ke.get();et(l,s,t.basis2,2),s[2]=r[2]=n[2]=l[2]=e;const p=a?"on-the-ground":"absolute-height",h=Ti(Lt(s,r,i,p),Lt(l,n,i,p)),c=Ti(Lt(r,n,i,p),Lt(s,l,i,p));return o(c)||o(h)?null:[h,c]}let Ns=class extends Tt{constructor(t){super(t),this.type="extent-rotate",this.angle=0}};t([f()],Ns.prototype,"type",void 0),t([f()],Ns.prototype,"angle",void 0),Ns=t([b("esri.views.interactive.tooltip.ExtentRotateTooltipInfo")],Ns);let Fs=class extends Tt{constructor(t){super(t),this.type="extent-scale",this.xScale=0,this.yScale=0,this.xSize=Oi,this.ySize=Oi}};t([f()],Fs.prototype,"type",void 0),t([f()],Fs.prototype,"xScale",void 0),t([f()],Fs.prototype,"yScale",void 0),t([f()],Fs.prototype,"xSize",void 0),t([f()],Fs.prototype,"ySize",void 0),Fs=t([b("esri.views.interactive.tooltip.ExtentScaleTooltipInfo")],Fs);let Hs=class extends(re.EventedMixin(si)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new se,this._preserveAspectRatio=new Vs,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new Ee,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=qi(),this.mapBoundsStart=qi(),this.zmax=0,this.sizeStart=null,this.displayBounds=qi(),this.displayBoundsStart=qi(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=bt(),this._endScale=bt()}initialize(){const{view:t,graphic:i,manipulators:a,handles:s}=this,o=this.graphicState=new te({graphic:i}),n=i.geometry;this.editGeometryOperations=ui.fromGeometry(n,t.state.viewingMode),this.graphicMoveManipulation=new Ka({tool:this,view:t,graphicState:o}),this.moveZManipulator=Ki(t,$i.CENTER_ON_CALLOUT),this.moveZManipulator.state|=ta,s.add([this._createMoveXYGraphicDragPipeline(),d((()=>this.enableZ),(()=>this._updateManipulatorAvailability(this.moveZManipulator,Ea.TRANSLATE_Z))),this._createMoveZDragPipeline()]),a.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((e=>{const i=ea(t,e);return s.add([d((()=>this.enableScaling),(()=>this._updateManipulatorAvailability(i,Ea.SCALE))),i.events.on("grab-changed",(t=>this._onResizeGrab(t))),this._createResizeDragPipeline(i,e)]),i})),a.addMany(this.resizeManipulators),this.rotateManipulatorTexture=ca(t.toolViewManager.textures),this.rotateManipulator=ia(t,this.rotateManipulatorTexture.texture),s.add([d((()=>this.enableRotation),(()=>this._updateManipulatorAvailability(this.rotateManipulator,Ea.ROTATE))),this.rotateManipulator.events.on("grab-changed",(t=>{this._onRotateGrab(t)})),this._createRotateDragPipeline(this.rotateManipulator)]),a.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const l=Pa({view:t,graphic:i,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>e()});r(l)&&(this.outlineVisualElement=l.visualElement instanceof Ut?l.visualElement:null),r(this.outlineVisualElement)&&s.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this._updateDisplayBounds()))),s.add(l),s.add([o.on("changed",(()=>this._onGeometryChanged())),d((()=>o.displaying),(()=>this._updateAllManipulatorAvailability())),d((()=>o.isDraped),(()=>this._graphicDrapedChanged()),g),t.trackGraphicState(o)]);const p=t.pointsOfInterest;p&&s.add(d((()=>p.centerOnSurfaceFrequent.location),(()=>this._updateDisplayBounds()))),this._forEachManipulator((t=>{s.add(t.events.on("grab-changed",(()=>{this.grabbing=t.grabbing,this._updateAllManipulatorAvailability()})))})),this._forEachManipulator(((t,e)=>{s.add(t.events.on("immediate-click",(t=>{e===Ea.TRANSLATE_XY&&this.emit("immediate-click",{...t,graphic:i}),t.stopPropagation()})))})),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{handles:t,view:e}=this,i=this._tooltip=new Dt({view:e}),a=()=>{i.info=this._getUpdatedTooltipInfo()};t.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",(()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()})),this.on("graphic-rotate-start",(t=>{this._startAngle=t.angle,a()})),this.on("graphic-rotate",(t=>{this._endAngle=t.angle,a()})),this.on("graphic-rotate-stop",(()=>{this._startAngle=0,this._endAngle=0,a()})),this.on("graphic-scale-start",(t=>{ct(this._startScale,t.xScale,t.yScale),ct(this._endScale,t.xScale,t.yScale),a()})),this.on("graphic-scale",(t=>{ct(this._endScale,t.xScale,t.yScale),a()})),this.on("graphic-scale-stop",(()=>{ct(this._startScale,0,0),ct(this._endScale,0,0),a()}))]),this._forEachManipulator((e=>{t.add([e.events.on("focus-changed",a),e.events.on("grab-changed",a),e.events.on("drag",(t=>{"cancel"===t.action?this._tooltip.clear():a()}))])}))}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this.graphicMoveManipulation.grabbing||this.graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():this.rotateManipulator.focused?this._computeRotateTooltipInfo():this.resizeManipulators.some((t=>t.focused))?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=c(this._moveXYTooltipInfo,(()=>new $a({tooltipOptions:this.tooltipOptions})))}_computeMoveZTooltipInfo(){const t=this._moveZTooltipInfo=c(this._moveZTooltipInfo,(()=>new ts({tooltipOptions:this.tooltipOptions}))),e=this._moveUnit;if(this.moveZManipulator.dragging){const e=this.mapBoundsStart.origin,i=this.mapBounds.origin,a=Ei(e,i,this.view.spatialReference);if(o(a))return null;t.distance=a}else t.distance=wi(0,e);return t}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo=c(this._rotateTooltipInfo,(()=>new Ns({tooltipOptions:this.tooltipOptions})));return t.angle=this._startAngle-this._endAngle,t}_computeScaleTooltipInfo(){const t=this.graphic.geometry;if(o(t))return null;const e=this._scaleTooltipInfo=c(this._scaleTooltipInfo,(()=>new Fs({tooltipOptions:this.tooltipOptions}))),i=ks(this.mapBounds,this.zmax,t.spatialReference,this.graphicState.isDraped);return o(i)?null:(e.xSize=i[0],e.ySize=i[1],r(this.sizeStart)&&this.resizeManipulators.some((t=>t.dragging))?(e.xScale=i[0].value/this.sizeStart[0].value,e.yScale=i[1].value/this.sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_graphicDrapedChanged(){this.handles.remove(Zs),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(t=>{r(this.attachmentOrigin)&&Se(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()})),Zs)}_updateAllManipulatorAvailability(){this._forEachManipulator(((t,e)=>this._updateManipulatorAvailability(t,e)))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof qt){const a=this.graphicState.displaying,s=this.enableZ&&me(this.graphic);switch(e){case Ea.ROTATE:t.available=a&&this.enableRotation;break;case Ea.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||s),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?aa:sa;break;case Ea.TRANSLATE_Z:t.available=a&&s;break;default:t.available=a}}}_forEachManipulator(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach((e=>t(e,Ea.SCALE))),t(this.rotateManipulator,Ea.ROTATE),t(this.moveZManipulator,Ea.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get _moveUnit(){return c(pt(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this.editGeometryOperations.data,i=e.components[0].edges[0],a=Mt(Fe.get(),i.leftVertex.pos,i.rightVertex.pos);ut(a,a);const s=c(Qt(this.view,this.graphic),(()=>t.extent.center));let o=Ys*this.view.pixelSizeAt(s);const r=this.view.spatialReference,n=t.spatialReference;r.equals(n)||(o*=lt(r)/lt(n)),function(t,e,i,a){a||(a=qi());const s=ct(Fe.get(),t[1],-t[0]),o=ct(Fe.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=ct(Fe.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n=Fe.get();e.components.forEach((e=>e.vertices.forEach((e=>{const i=e.pos;ct(n,_t(t,i),_t(s,i)),vt(o,o,n),ft(r,r,n)}))));const l=1e-6,p=ct(Fe.get(),r[0]-o[0]<l?i/2:0,r[1]-o[1]<l?i/2:0);Mt(o,o,p),gt(r,r,p),dt(a.basis1,t,(r[0]-o[0])/2),dt(a.basis2,s,(r[1]-o[1])/2),ct(a.origin,o[0]*t[0]+o[1]*s[0],o[0]*t[1]+o[1]*s[1]),gt(a.origin,a.origin,a.basis1),gt(a.origin,a.origin,a.basis2)}(a,e,o,this.mapBounds),this._calculateZMax()}_calculateZMax(){const t=this.editGeometryOperations.data;if(!t.geometry.hasZ)return void(this.zmax=0);const e=t.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const t of a.vertices){const a=e.getZ(t.pos);i=Math.max(a,i)}this.zmax=i}_updateDisplayBounds(){const t=this.graphic.geometry;if(o(t))return;const e=r(this.outlineVisualElement)&&!this.graphicState.isDraped&&r(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Qt(this.view,this.graphic);this.attachmentOrigin=c(e,t.extent.center);const i=r(e)?e.z:je(this.mapBounds.origin,this.view.elevationProvider,Ft.fromElevationInfo(j(this.graphic)),this.view.renderCoordsHelper),a=Qi(this.mapBounds);a.origin[2]=i,function(t,e,i,a=0,s){s||(s=qi()),e.toRenderCoords(t.origin,i,s.origin);const o=ke.get();z(o,t.origin,t.basis1),z(o,o,t.basis2),e.toRenderCoords(o,i,o);const r=ke.get();z(r,t.origin,t.basis1),N(r,r,t.basis2),e.toRenderCoords(r,i,r);const n=ke.get();N(n,t.origin,t.basis1),N(n,n,t.basis2),e.toRenderCoords(n,i,n);const l=ke.get();N(l,t.origin,t.basis1),z(l,l,t.basis2),e.toRenderCoords(l,i,l);const p=W(ke.get(),o,r,.5);N(p,p,s.origin);const h=W(ke.get(),n,l,.5);N(h,s.origin,h),W(s.basis1,p,h,.5);const c=W(ke.get(),l,o,.5);N(c,c,s.origin);const u=W(ke.get(),r,n,.5);N(u,s.origin,u),W(s.basis2,c,u,.5);const d=Z(ke.get(),s.basis1,s.basis2),m=Z(d,d,s.basis1);F(m,m),C(s.basis2,m,H(s.basis2,m)),C(s.basis1,s.basis1,1+a/q(s.basis1)),C(s.basis2,s.basis2,1+a/q(s.basis2)),Wi(s)}(a,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return Bs*this.view.pixelSizeAt(e)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline(((t,e,i)=>this._applyGraphicMoveSteps(e,i,Ja.XY)))}_createMoveZDragPipeline(){const t=this.view,e=this.editGeometryOperations.data.spatialReference;return Ke(this.moveZManipulator,((i,a,s)=>{const o=Q(i.renderLocation),r=a.next(Ze(t,o,e)).next(ei());this._applyGraphicMoveSteps(r,s,Ja.Z)}))}_applyGraphicMoveSteps(t,e,i){const a=t.next((t=>("start"===t.action&&(this.inputState={type:"move"},Qi(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(ai()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||t.mapEnd.z-t.mapStart.z)&&this.emit("graphic-translate",e);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",e)}return t})).next((t=>this._updateMoveTooltip(t,i)));return e.next((()=>{r(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()})),a}_calculateSizeStart(){o(this.graphic.geometry)?this.sizeStart=null:this.sizeStart=ks(this.mapBoundsStart,this.zmax,this.graphic.geometry.spatialReference,this.graphicState.isDraped)}_moveDragUpdateGeometry(){return t=>{if(o(this.inputState)||"move"!==this.inputState.type)return t;const e=[];for(const t of this.editGeometryOperations.data.components)e.push(...t.vertices);const i="start"===t.action?gi.NEW_STEP:gi.ACCUMULATE_STEPS;return zs(this.editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_updateMoveTooltip(t,e){if(e===Ja.XY||e===Ja.XY_AXIS){const e=Gt(t.mapStart,t.mapEnd,this.graphicState.isDraped?"on-the-ground":"absolute-height");r(e)&&r(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=e)}return t}_onResizeGrab(t){if("start"!==t.action)return;const e=this._calculatePickRay(t.screenPoint);Li(this.displayBounds.plane,e,ke.get())&&(Qi(this.displayBounds,this.displayBoundsStart),Qi(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return Ke(t,((t,i,a)=>{o(this.inputState)||(i.next((t=>("start"===t.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),t))).next(We(this.view,this.displayBoundsStart.plane)).next((t=>({...t,handle:e}))).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,xScale:t.factor1,yScale:t.factor2};switch(t.action){case"start":case"update":this.emit("graphic-scale",e);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",e)}return t})),a.next((()=>{r(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()})))}))}_resizeDragRenderPlaneToFactors(){return t=>{const e=this.displayBoundsStart,i=t.handle.direction,a=this.displayBoundsMargin,s=this.displayBoundsMarginStart,o=it(ke.get(),e.origin);et(o,o,e.basis1,-i[0]),et(o,o,e.basis2,-i[1]);const r=N(ke.get(),t.renderEnd,o),n=N(ke.get(),t.renderStart,o),l=Ji(t.handle),p=oa(e),h=oa(this.displayBounds)/p,c=(t,e)=>{if(0===t)return 1;let i=q(e),o=.5*t*H(e,r)/i;const p=o<0?-1:1;l&&(o+=(i-.5*t*H(e,n)/i)*p*h);const c=i<1.5*s?1:Xs;return i=Math.max(i-s,Xs),p>0&&(o-=a),p*Math.max(p*(o/i),c)};return{...t,factor1:c(i[0],e.basis1),factor2:c(i[1],e.basis2)}}}_resizeDragUpdateGeometry(){return t=>{const e=it(I(),this.mapBoundsStart.origin);et(e,e,this.mapBoundsStart.basis1,-t.handle.direction[0]),et(e,e,this.mapBoundsStart.basis2,-t.handle.direction[1]);const i=ct(bt(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);ut(i,i);const a=[];for(const t of this.editGeometryOperations.data.components)a.push(...t.vertices);const s="start"===t.action?gi.NEW_STEP:gi.ACCUMULATE_STEPS,o=this.editGeometryOperations.scaleVertices(a,e,i,t.factor1,t.factor2,s,Mi.REPLACE);return Qi(this.mapBoundsStart,this.mapBounds),zs(o,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onRotateGrab(t){if("start"!==t.action)return;const e=ra(this.displayBounds,this.view.renderCoordsHelper,na.HEADING,Ri()),i=this._calculatePickRay(t.screenPoint);Li(e,i,ke.get())&&(Qi(this.displayBounds,this.displayBoundsStart),Qi(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.inputState={type:"rotate",rotatePlane:e})}_createRotateDragPipeline(t){return Ke(t,((t,e,i)=>{const a=this.inputState;o(a)||(e.next((t=>("start"===t.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),t))).next(We(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,angle:J(t.rotateAngle)};switch(t.action){case"start":case"update":this.emit("graphic-rotate",e);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",e)}return t})),i.next((()=>{r(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()})))}))}_rotateDragRenderPlaneToRotate(t){return e=>{const i=Di(t.rotatePlane),a=$t(e.renderStart,e.renderEnd,this.displayBounds.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return t=>{const e=it(I(),this.mapBoundsStart.origin),i=[];for(const t of this.editGeometryOperations.data.components)i.push(...t.vertices);const a="start"===t.action?gi.NEW_STEP:gi.ACCUMULATE_STEPS,s=this.editGeometryOperations.rotateVertices(i,e,t.rotateAngle,a,Mi.REPLACE);return Qi(this.mapBoundsStart,this.mapBounds),zs(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=Bi(),i=G(t);return ua(this.view.state.camera,i,e),F(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=la(this.displayBounds,Ne.get());pa(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach(((e,i)=>{ha(e,this.resizeHandles[i],t,this.displayBounds)}))}_updateZMoveHandle(t,e){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:N(ke.get(),i.origin,i.basis1),edge:2},s=Ne.get();Ve(s,e,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=a.position}_cancel(){const t=this.editGeometryOperations.lastOperation;o(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,Cs(t,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(r(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,Cs(p(t),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,zs(p(t),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator,tooltip:this._tooltip}}};t([f({constructOnly:!0,nonNullable:!0})],Hs.prototype,"view",void 0),t([f({constructOnly:!0,nonNullable:!0})],Hs.prototype,"graphic",void 0),t([f({constructOnly:!0,nonNullable:!0})],Hs.prototype,"enableZ",void 0),t([f()],Hs.prototype,"enableRotation",void 0),t([f()],Hs.prototype,"enableScaling",void 0),t([f({constructOnly:!0,type:se})],Hs.prototype,"tooltipOptions",void 0),t([f()],Hs.prototype,"preserveAspectRatio",null),t([f()],Hs.prototype,"grabbing",void 0),t([f()],Hs.prototype,"inputState",void 0),t([f({readOnly:!0})],Hs.prototype,"type",void 0),t([f()],Hs.prototype,"_moveUnit",null),Hs=t([b("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],Hs);const Zs="draped-elevation-changes",Bs=10,Ys=80,Xs=1e-6;export{ja as DrawGraphicTool3D,Hs as ExtentTransformTool,os as GraphicMoveTool,vs as GraphicReshapeTool,Ls as GraphicTransformTool};
