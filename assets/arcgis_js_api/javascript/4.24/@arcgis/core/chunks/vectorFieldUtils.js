/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{J as t}from"./jsonMap.js";import{a as e,u as n}from"./maybe.js";import r from"../layers/support/PixelBlock.js";import{i as o}from"./pixelUtils.js";const a=new Map;a.set("meter-per-second",1),a.set("kilometer-per-hour",.277778),a.set("knots",.514444),a.set("feet-per-second",.3048),a.set("mile-per-hour",.44704);const s=180/Math.PI,i=new t({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function h(t,e){return a.get(t)/a.get(e)||1}function l(t){return(450-t)%360}function c(t,e="geographic"){const[n,r]=t,o=Math.sqrt(n*n+r*r);let a=Math.atan2(r,n)*s;return a=(360+a)%360,"geographic"===e&&(a=l(a)),[o,a]}function u(t,e="geographic"){let n=t[1];"geographic"===e&&(n=l(n)),n%=360;const r=t[0];return[r*Math.cos(n/s),r*Math.sin(n/s)]}function f(t,r,a,s="geographic"){if(!o(t)||e(a))return t;const i="vector-magdir"===r?t.clone():n(p(t,r)),h=i.pixels[1];for(let t=0;t<h.length;t++)h[t]="geographic"===s?(h[t]+a[t]+270)%360:(h[t]+360-a[t])%360;return"vector-magdir"===r?i:p(i,"vector-magdir")}function p(t,e,n="geographic",a=1){if(!o(t))return t;const{pixels:s,width:i,height:h}=t,l=i*h,f=s[0],p=s[1],m=t.pixelType.startsWith("f")?t.pixelType:"f32",d=r.createEmptyBand(m,l),g=r.createEmptyBand(m,l);let M=0;for(let t=0;t<h;t++)for(let t=0;t<i;t++)"vector-uv"===e?([d[M],g[M]]=c([f[M],p[M]],n),d[M]*=a):([d[M],g[M]]=u([f[M],p[M]],n),d[M]*=a,g[M]*=a),M++;const x=new r({pixelType:m,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[d,g]});return x.updateStatistics(),x}function m(t,e,n=1){if(1===n||!o(t))return t;const r=t.clone(),{pixels:a,width:s,height:i}=r,h=a[0],l=a[1];let c=0;for(let t=0;t<i;t++)for(let t=0;t<s;t++)"vector-uv"===e?(h[c]*=n,l[c]*=n):h[c]*=n,c++;return r.updateStatistics(),r}function d(t,n,r,o,a){if(e(a)||!a.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(n/o),height:Math.round(r/o),resolution:t.width/n};const s=a.xmin,i=a.ymax,h=(t.xmax-t.xmin)/n*o,l=(t.ymax-t.ymin)/r*o,c=(h+l)/2;return t.xmin=s+Math.floor((t.xmin-s)/h)*h,t.xmax=s+Math.ceil((t.xmax-s)/h)*h,t.ymin=i+Math.floor((t.ymin-i)/l)*l,t.ymax=i+Math.ceil((t.ymax-i)/l)*l,{extent:t,width:Math.round(t.width/h),height:Math.round(t.height/l),resolution:c}}const g=function(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const o=r?-1:1,a=13*o,s=-7*o,i=-2*o,h=-16*o,l=21.75,[c,u]=x(0,e+a,n,l),[f,p]=x(t-5.5,e+s,n,l),[m,d]=x(t+5.5,e+s,n,l),[g,M]=x(t-1.5,e+i,n,l),[k,w]=x(t+1.5,e+i,n,l),[y,P]=x(t-1.5,e+h,n,l),[b,I]=x(t+1.5,e+h,n,l);return[c,u,f,p,g,M,k,w,m,d,y,P,b,I]}(0,0,0);function M(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=n?-1:1,o=5*r,a=20*r,s=25*r,i=45,h=2*r;let[l,c]=[5,0-a],[u,f]=[l+2,c],[p,m]=[u-0,f+h],[d,g]=[-5,0-s],[M,k]=[d+0,g-h],w=Math.ceil(t/5),y=Math.floor(w/10);w-=8*y;const P=[],b=[];for(let t=0;t<w/2;t++,y--){y<=0&&w%2==1&&t===(w-1)/2&&(d=0,M=d+0,g=(g+c)/2,k=g-h);const[n,r]=x(d,g,e,i);if(y>0){const[t,o]=x(u,g,e,i),[a,s]=x(l,c,e,i);P.push(t),P.push(o),P.push(n),P.push(r),P.push(a),P.push(s)}else{const[t,o]=x(u,f,e,i),[a,s]=x(p,m,e,i),[h,l]=x(M,k,e,i);b.push(n),b.push(r),b.push(h),b.push(l),b.push(a),b.push(s),b.push(t),b.push(o)}g+=o,c+=o,f+=o,m+=o,k+=o}const[I,v]=x(5,0+a,e,i),[A,_]=x(7,0+a,e,i),[U,S]=x(5,0-s,e,i),[D,F]=x(7,0-s,e,i);return{pennants:P,barbs:b,shaft:[I,v,A,_,U,S,D,F]}}function x(t,e,n,r=1){const o=Math.sqrt(t*t+e*e)/r,a=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[o,(2*Math.PI+a-n)%(2*Math.PI)]}const k=[0,1,3,6,10,16,21,27,33,40,47,55,63],w=[0,.5,1,1.5,2],y=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function P(t,e,n,r){const o=h(r||"knots",n);let a;for(a=1;a<e.length;a++)if(a===e.length-1){if(t<e[a]*o)break}else if(t<=e[a]*o)break;return Math.min(a-1,e.length-2)}function b(t,e,n,r,o){let a=0;switch(e){case"beaufort_kn":a=P(t,k,"knots",n);break;case"beaufort_km":a=P(t,k,"kilometer-per-hour",n);break;case"beaufort_ft":a=P(t,k,"feet-per-second",n);break;case"beaufort_m":a=P(t,k,"meter-per-second",n);break;case"classified_arrow":a=P(t,o,r,n);break;case"ocean_current_m":a=P(t,w,"meter-per-second",n);break;case"ocean_current_kn":a=P(t,y,"knots",n)}return a}const I=[];function v(t,e){let n=0,r=0;const{width:o,height:a,mask:s}=t,l=t.pixels[0],c=[],u=[],f=h(i.fromJSON(e.inputUnit),"knots"),p="wind_speed"===e.style?5:Number.MAX_VALUE;for(let t=0;t<a;t++)for(let e=0;e<o;e++){const i=l[t*o+e]*f;if((!s||s[t*o+e])&&i<p){for(let r=0;r<4;r++)c[n++]=(e+.5)/o,c[n++]=(t+.5)/a,c[n++]=r<2?-.5:.5,c[n++]=r%2==0?-.5:.5,c[n++]=0,c[n++]=i;const s=4*(n/24-1);u[r++]=s,u[r++]=s+1,u[r++]=s+2,u[r++]=s+1,u[r++]=s+2,u[r++]=s+3}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(u)}}function A(t,e){return"simple_scalar"===e.style?v(t,e):"wind_speed"===e.style?function(t,e){if(0===I.length)for(let t=0;t<30;t++)I.push(M(5*t,0));const n=h(i.fromJSON(e.inputUnit),"knots"),{width:r,height:o,mask:a}=t,s=t.pixels[0],l=t.pixels[1],c=[],u=[];let f=0,p=0;for(let t=0;t<o;t++)for(let e=0;e<r;e++){const i=t*r+e,h=s[i]*n;if((!a||a[t*r+e])&&h>=5){const n=(l[i]+360)%360/180*Math.PI??2*Math.PI*Math.random(),{pennants:a,barbs:s,shaft:m}=I[Math.min(Math.floor(h/5),29)];if(a.length+s.length===0)continue;let d=c.length/6;const g=(e+.5)/r,M=(t+.5)/o;for(let t=0;t<a.length;t+=2)c[f++]=g,c[f++]=M,c[f++]=a[t],c[f++]=a[t+1]+n,c[f++]=0,c[f++]=h;for(let t=0;t<s.length;t+=2)c[f++]=g,c[f++]=M,c[f++]=s[t],c[f++]=s[t+1]+n,c[f++]=0,c[f++]=h;for(let t=0;t<m.length;t+=2)c[f++]=g,c[f++]=M,c[f++]=m[t],c[f++]=m[t+1]+n,c[f++]=0,c[f++]=h;for(let t=0;t<a.length/6;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,d+=3;for(let t=0;t<s.length/8;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+2,u[p++]=d+3,d+=4;u[p++]=d+0,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+3,u[p++]=d+2,d+=4}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(u)}}(t,e):function(t,e){const{style:n,inputUnit:r,outputUnit:o,breakValues:a}=e,s=i.fromJSON(r),h=i.fromJSON(o);let l=0,c=0;const{width:u,height:f,mask:p}=t,m=t.pixels[0],d=t.pixels[1],M=p?p.filter((t=>t>0)).length:u*f,x=new Float32Array(42*M),k=new Uint32Array(15*M);for(let t=0;t<f;t++)for(let e=0;e<u;e++){const r=t*u+e;if(!p||p[t*u+e]){const o=(d[r]+360)%360/180*Math.PI??2*Math.PI*Math.random(),i=b(m[r],n,s,h,a);for(let n=0;n<g.length;n+=2)x[l++]=(e+.5)/u,x[l++]=(t+.5)/f,x[l++]=g[n],x[l++]=g[n+1]+o,x[l++]=i,x[l++]=m[r];const p=7*(l/42-1);k[c++]=p,k[c++]=p+1,k[c++]=p+2,k[c++]=p+0,k[c++]=p+4,k[c++]=p+3,k[c++]=p+0,k[c++]=p+2,k[c++]=p+3,k[c++]=p+2,k[c++]=p+5,k[c++]=p+3,k[c++]=p+5,k[c++]=p+6,k[c++]=p+3}}return{vertexData:x,indexData:k}}(t,e)}function _(t,e,n,o=[0,0],a=.5){const{width:s,height:i,mask:h}=t,[l,f]=t.pixels,[p,m]=o,d=Math.round((s-p)/n),g=Math.round((i-m)/n),M=d*g,x=new Float32Array(M),k=new Float32Array(M),w=new Uint8Array(M),y="vector-uv"===e;for(let t=0;t<g;t++)for(let e=0;e<d;e++){let r=0;const o=t*d+e,g=Math.max(0,t*n+m),M=Math.max(0,e*n+p),P=Math.min(i,g+n),b=Math.min(s,M+n);for(let t=g;t<P;t++)for(let e=M;e<b;e++){const n=t*s+e;if(!h||h[n]){r++;const t=y?[l[n],f[n]]:[l[n],(360+f[n])%360],[e,a]=y?t:u(t);x[o]+=e,k[o]+=a}}if(r>=(P-g)*(b-M)*(1-a)){w[o]=1;const[t,e]=c([x[o]/r,k[o]/r]);x[o]=t,k[o]=e}else w[o]=0,x[o]=0,k[o]=0}const P=new r({width:d,height:g,pixels:[x,k],mask:w});return P.updateStatistics(),P}export{i as a,m as b,p as c,f as d,A as e,v as f,h as g,_ as h,d as s,c as u};
