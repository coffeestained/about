/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import{L as a}from"./Logger.js";import{a as n,i as r,u as i}from"./maybe.js";import{createResolver as o}from"../core/promiseUtils.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import{clone as l}from"../core/lang.js";import"./ensureType.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{isDOMContainer as u}from"../views/DOMContainer.js";import{E as p}from"./interfaces.js";import h from"../core/Collection.js";import"../geometry.js";import{c as d,f as m}from"./mathUtils.js";import{f}from"./screenUtils.js";import{project as y}from"../geometry/projection.js";import{V as v}from"./ViewingMode.js";import{m as g}from"./drawUtils.js";import E from"../geometry/Point.js";var _;!function(t){t[t.WhenToolEditable=0]="WhenToolEditable",t[t.WhenToolNotEditable=1]="WhenToolNotEditable",t[t.Always=2]="Always"}(_||(_={}));class b{constructor(){this._isToolEditable=!0,this._manipulators=new h,this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=_.WhenToolEditable){return this.addMany([t],e)[0]}addMany(t,e=_.WhenToolEditable){return t.map((t=>{const a=this._nextManipulatorId++,n={id:a,manipulator:t,visibilityPredicate:e,attached:!1};return this._manipulators.add(n),this._attached&&this._updateManipulatorAttachment(n),a}))}remove(t){if("number"==typeof t){const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).id===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).manipulator===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this._manipulators.forEach((({manipulator:t})=>{t.destroy&&t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,(t=>{e(t)}))}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((e=>t.push(e.manipulator))),t}intersect(t,e){let a=null,n=Number.MAX_VALUE;return this._manipulators.forEach((({id:i,manipulator:o,attached:s})=>{if(!s||!o.interactive)return;const l=o.intersectionDistance(t,e);r(l)&&l<n&&(n=l,a={id:i,manipulator:o})})),a}findById(t){if(n(t))return null;for(const e of this._manipulators.items)if(t===e.id)return e.manipulator;return null}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===_.Always||(this._isToolEditable?t.visibilityPredicate===_.WhenToolEditable:t.visibilityPredicate===_.WhenToolNotEditable)}}const M=a.getLogger("esri.views.interactive.InteractiveToolBase");let x=class extends e{constructor(t){super(t),this.manipulators=new b,this.preferManipulatorCursor=!1,this.automaticManipulatorSelection=!0,this.hasFocusedManipulators=!1,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[p.MANAGER,!0],[p.USER,!0]]),this._creationFinishedResolver=o()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(p.USER)}set editable(t){this.setEditableFlag(p.USER,t)}get updating(){return!1}get cursor(){return null}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){n(this.view)?M.error("Can't activate tool if view is not defined."):(u(this.view)&&this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===p.USER&&this.notifyChange("editable"),this.onEditableChange()}getEditableFlag(t){return this._editableFlags.get(t)}whenCreated(){return this._creationFinishedResolver.promise}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(p.USER)&&this.getEditableFlag(p.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.constructed)if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};function S(t,e){return t.events.on("drag",function(t,e){let a=null,i=null;return o=>{if("cancel"===o.action)return void(r(i)&&(i.execute({action:"cancel"}),a=null,i=null));const s={action:o.action,screenStart:o.start,screenEnd:o.screenPoint};"start"===o.action&&n(a)&&(a=new U,i=new U,e(t,a,i,o.pointerType,s)),r(a)&&a.execute(s),"end"===o.action&&r(a)&&(a=null,i=null)}}(t,e))}function w(t,e){const a=[t.x,t.y,t.z],n=e,r=[Math.cos(n),Math.sin(n)],i=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(0===i)return null;r[0]/=i,r[1]/=i;const o=t=>{const e=(t.x-a[0])*r[0]+(t.y-a[1])*r[1];t.x=a[0]+e*r[0],t.y=a[1]+e*r[1]};return t=>(o(t.mapStart),o(t.mapEnd),t)}function A(t,e){let a=null;return i=>{if("start"===i.action&&(a=function(t,e,a){const i=t.geometry;if(n(i))return null;if("mesh"===i.type)return function(t,e,a,i){if(r(e.transform))return function(t,e,a,i){const o=R(a.getOriginPoint(e.spatialReference),i),s=e.spatialReference;return n(o)?null:{move:(e,n,i)=>{const l=g(o.clone(),e,n,i);if(l.spatialReference.equals(s))a.origin=m(l.x,l.y,l.z);else{const t=y(l,s);r(t)&&(a.origin=m(t.x,t.y,t.z))}t.notifyMeshTransformChanged(),t.notifyGeometryChanged()}}}(t,e,e.transform,a);if(!e.spatialReference.equals(a))return null;let o=0,s=0,l=0;return{move:(a,n,r)=>{const c=a-o,u=n-s,p=r-l;if(c||u||p){const h=new E(e.origin.x+c,e.origin.y+u,e.origin.z+p,e.origin.spatialReference);e.centerAt(h,{geographic:i===v.Global}),t.notifyGeometryChanged(),o=a,s=n,l=r}}}}(t,i,e,a);const o=R(i,e),s=i.spatialReference;return n(o)?null:{move:(e,a,n)=>{const r=g(o.clone(),e,a,n);r.spatialReference.equals(s)?t.geometry=r:t.geometry=y(r,s)}}}(t,i.mapStart.spatialReference,e)),n(a))return null;const o=i.mapEnd.x-i.mapStart.x,s=i.mapEnd.y-i.mapStart.y,l=i.mapEnd.z-i.mapStart.z;return a.move(o,s,l),{...i,translationX:o,translationY:s,translationZ:l}}}function R(t,e){return n(t)?null:t.spatialReference.equals(e)?t.clone():y(t,e)}function T(t,e=null,a){let i=null;const o=r(e)&&!t.spatialReference.equals(e)?t=>r(t)?y(t,e):t:t=>t,s={exclude:[],...a};return e=>{if("start"===e.action&&(i=o(t.toMap(e.screenStart,s))),n(i))return null;const a=o(t.toMap(e.screenEnd,s));return r(a)?{...e,mapStart:i,mapEnd:a}:null}}function j(t,e){const a=t.map((t=>i(A(t,e)))).filter((t=>r(t)));return t=>{const e=t.mapEnd.x-t.mapStart.x,n=t.mapEnd.y-t.mapStart.y,r=t.mapEnd.z-t.mapStart.z;return a.forEach((e=>e(t))),{...t,translationX:e,translationY:n,translationZ:r}}}function C(t,e){const a=new Map;for(const n of e)a.set(n,l(t[n]));return e=>(a.forEach(((e,a)=>{t[a]=e})),e)}function I(t){return r(t.geometry)&&"mesh"===t.geometry.type?function(t,e){const a=r(e.transform)?e.transform.clone():null,n=e.vertexAttributes.clonePositional();return r=>(e.transform=a,e.vertexAttributes=n,t.notifyGeometryChanged(),r)}(t,t.geometry):C(t,["geometry"])}function F(t){const e=t.map((t=>i(I(t)))).filter((t=>r(t)));return t=>(e.forEach((e=>e(t))),t)}function O(){let t=0,e=0,a=0;return n=>{"start"===n.action&&(t=n.mapStart.x,e=n.mapStart.y,a=n.mapStart.z);const r=n.mapEnd.x-t,i=n.mapEnd.y-e,o=n.mapEnd.z-a;return t=n.mapEnd.x,e=n.mapEnd.y,a=n.mapEnd.z,{...n,mapDeltaX:r,mapDeltaY:i,mapDeltaZ:o,mapDeltaSpatialReference:n.mapStart.spatialReference}}}function z(){let t=0,e=0;return a=>{"start"===a.action&&(t=a.screenStart.x,e=a.screenStart.y);const n=a.screenEnd.x-t,r=a.screenEnd.y-e;return t=a.screenEnd.x,e=a.screenEnd.y,{...a,screenDeltaX:n,screenDeltaY:r}}}function D(t,e){let a=null,n=0,r=0;return i=>{if("start"===i.action&&(a=t.toScreen(e),a.x<0||a.x>t.width||a.y<0||a.y>t.height?a=null:(n=i.screenStart.x-a.x,r=i.screenStart.y-a.y)),null==a)return null;const o=d(i.screenEnd.x-n,0,t.width),s=d(i.screenEnd.y-r,0,t.height),l=f(o,s);return i.screenStart=a,i.screenEnd=l,i}}t([s({constructOnly:!0})],x.prototype,"view",void 0),t([s({readOnly:!0})],x.prototype,"active",null),t([s({value:!0})],x.prototype,"visible",null),t([s({value:!0})],x.prototype,"editable",null),t([s({readOnly:!0})],x.prototype,"manipulators",void 0),t([s({readOnly:!0})],x.prototype,"updating",null),t([s()],x.prototype,"cursor",null),t([s({readOnly:!0})],x.prototype,"preferManipulatorCursor",void 0),t([s({readOnly:!0})],x.prototype,"automaticManipulatorSelection",void 0),t([s()],x.prototype,"hasFocusedManipulators",void 0),t([s({readOnly:!0})],x.prototype,"created",void 0),t([s({readOnly:!0})],x.prototype,"removeIncompleteOnCancel",void 0),x=t([c("esri.views.interactive.InteractiveToolBase")],x);class U{constructor(){this.execute=()=>{}}next(t,e=new U){return r(t)&&(this.execute=a=>{const n=t(a);r(n)&&e.execute(n)}),e}}export{U as E,x as I,b as M,I as a,D as b,S as c,A as d,w as e,z as f,O as g,j as h,F as i,C as r,T as s};
