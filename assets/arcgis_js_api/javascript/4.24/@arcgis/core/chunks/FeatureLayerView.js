/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{d as t,eachAlways as r}from"../core/promiseUtils.js";import i from"../core/Error.js";import{L as s}from"./Logger.js";import{i as o,a}from"./maybe.js";import{watch as n,syncAndInitial as l,on as u}from"../core/reactiveUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./ensureType.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{g as d}from"./commonProperties.js";import c from"../layers/support/FeatureEffect.js";import m from"../layers/support/FeatureFilter.js";import{fixFields as h,unpackFieldNames as y,collectLabelingFields as F,collectElevationFields as g,collectFilterFields as w,collectFeatureReductionFields as E,collectOrderByInfos as b,collectFields as x,collectField as v,featureHasFields as R}from"../layers/support/fieldUtils.js";import{a as j}from"./floorFilterUtils.js";import I from"../rest/support/Query.js";import{l as q}from"./arcadeOnDemand.js";import{g as _,a as P}from"./popupUtils.js";const O=s.getLogger("esri.views.layers.FeatureLayerView"),A=s=>{let A=class extends s{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([n((()=>{const e=this.layer;return[e?.elevationInfo?.featureExpressionInfo,e?.displayField,e?.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]}),(()=>this._handleRequiredFieldsChange()),l),u((()=>this.view?.floors),"change",(()=>this._handleRequiredFieldsChange())),u((()=>{const e=this.layer;return e&&"sublayers"in e&&e.sublayers}),"change",(()=>this._handleRequiredFieldsChange()))])}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?h(t,[...y(t,e.outFields),...r]):h(t,r)}set effect(e){t(O,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=e}get effect(){return t(O,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){void 0!==e?this._override("featureEffect",e):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){O.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=o(this.filter)?this.filter.createQuery(e):new I(e);if("feature"===this.layer.type){const e=j(this);o(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return o(this.timeExtent)&&(t.timeExtent=o(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeatures(e,t){const r=this.validateFetchPopupFeatures(t);if(r)throw r;return this.fetchClientPopupFeatures(t)}_loadArcadeModules(e){if(e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type)))return q()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:i,objectIdField:s}}=this,a="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,l=t.featureReduction,u=new Set,p=await r([a?a.collectRequiredFields(u,i):null,F(u,t),e?g(u,t):null,o(this.filter)?w(u,t,this.filter):null,o(this.featureEffect)?w(u,t,this.featureEffect.filter):null,l?E(u,t,l):null,n?b(u,t,n):null]);if(t.timeInfo&&this.timeExtent&&x(u,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&x(u,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){v(u,i,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(u,i),F(u,e)])));await r(e)}for(const e of p)e.error&&O.error(e.error);v(u,i,s),e&&"displayField"in t&&t.displayField&&v(u,i,t.displayField);const f=Array.from(u).sort();this._set("requiredFields",f)}validateFetchPopupFeatures(e){if(a(e))return null;for(const t of e.clientGraphics){const r=t.layer;if("popupEnabled"in r&&!r.popupEnabled)return new i("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r});if(t.isAggregate){if(!(r.featureReduction&&"popupTemplate"in r.featureReduction&&r.featureReduction.popupEnabled&&r.featureReduction.popupTemplate))return new i("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r})}else if("popupTemplate"in r&&!_(r,e))return new i("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:r})}}async fetchClientPopupFeatures(e){const t=o(e)?e.clientGraphics:null;if(!t||0===t.length)return[];const r=new Array(t.length),i=new Map,s=await this.createPopupQuery(e);for(let o=0;o<t.length;o++){const n=t[o];if(n.isAggregate){r[o]=n;continue}const{layer:l}=n;if(!("popupEnabled"in l))continue;const u=y(this.layer.fieldsIndex,s.outFields),p=_(l,e);if(a(p))continue;const f=await this._loadArcadeModules(p);f&&f.arcadeUtils.hasGeometryOperations(p)||!R(u,n)?i.set(n.getObjectId(),o):r[o]=n}if("stream"===this.layer.type||0===i.size)return r.filter(Boolean);s.objectIds=Array.from(i.keys());try{const e=await this.layer.queryFeatures(s);for(const t of e.features)r[i.get(t.getObjectId())]=t}catch{}return r.filter(Boolean)}async createPopupQuery(e){const t=this.layer.createQuery(),r=new Set;let i=!1;const s=o(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const t of s){if(!("popupEnabled"in t))continue;const s=_(t,e);if(a(s))continue;const o=await this._loadArcadeModules(s),n=o&&o.arcadeUtils.hasGeometryOperations(s);i=!("point"!==this.layer.geometryType&&!n);const l=await P(this.layer,s);for(const e of l)r.add(e)}if(t.returnGeometry=i,t.returnZ=i,t.returnM=i,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=j(this);o(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}canResume(){return!(!super.canResume()||o(this.timeExtent)&&this.timeExtent.isEmpty)}};return e([p()],A.prototype,"_updatingRequiredFieldsPromise",void 0),e([p({readOnly:!0})],A.prototype,"availableFields",null),e([p()],A.prototype,"effect",null),e([p({type:c})],A.prototype,"featureEffect",null),e([p({type:m})],A.prototype,"filter",void 0),e([p(d)],A.prototype,"timeExtent",void 0),e([p()],A.prototype,"layer",void 0),e([p({type:Number})],A.prototype,"maximumNumberOfFeatures",null),e([p({readOnly:!0,type:Boolean})],A.prototype,"maximumNumberOfFeaturesExceeded",null),e([p({readOnly:!0})],A.prototype,"requiredFields",void 0),e([p()],A.prototype,"suspended",void 0),e([p()],A.prototype,"view",void 0),A=e([f("esri.views.layers.FeatureLayerView")],A),A};export{A as F};
