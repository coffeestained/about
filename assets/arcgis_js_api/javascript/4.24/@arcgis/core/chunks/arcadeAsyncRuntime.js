/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{r as e,a as t,b as r,c as n,d as o,A as a,e as i,f as s}from"./arcadeUtils.js";import{a as c,g as l,h as u,r as f,b as p,d as m,n as w,D as h,F as d}from"./parser.js";import{p as g,i as E,q as y,N,X as v,Y as I,v as T,Z as S,_ as b,F as j,A as R,b as O,l as U,o as A,J as C,R as x,a as M,f as F,h as P,U as D,V as L,x as k,w as _,$ as V,j as Y,T as B}from"./languageUtils.js";import{registerFunctions as G}from"./geomasync.js";import z from"../geometry/Extent.js";import q from"../geometry/Geometry.js";import Z from"../geometry/Multipoint.js";import H from"../geometry/Point.js";import J from"../geometry/Polygon.js";import W from"../geometry/Polyline.js";import X from"../geometry/SpatialReference.js";import"../geometry.js";import"./ensureType.js";import"../core/lang.js";import"./maybe.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/Error.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"./writer.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"./reader.js";import"./zmUtils.js";import"../core/accessorSupport/decorators/cast.js";import"./extentUtils.js";import"./locale.js";import"./datetime.js";import"../kernel.js";import"../core/urlUtils.js";import"./unitUtils.js";import"./projectionEllipsoid.js";import"./number.js";import"./sizeVariableUtils.js";import"./featureConversionUtils.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../geometry/geometryEngineAsync.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"./assets.js";import"../request.js";import"../intl.js";import"./number2.js";import"./messages.js";function K(e){return e&&"function"==typeof e.then}async function Q(e,t){const r=[];for(let n=0;n<t.arguments.length;n++)r.push(await te(e,t.arguments[n]));return r}async function $(e,t,r){return!0===t.preparsed?r(e,null,t.arguments):r(e,t,await Q(e,t))}async function ee(e,t,r){if(!0===t.preparsed){const n=r(e,null,t.arguments);return K(n),n}const n=r(e,t,await Q(e,t));return K(n),n}async function te(e,t,r){if(t.breakpoint&&!0!==r){const r=t.breakpoint();return await r,te(e,t,!0)}switch(t.type){case"VariableDeclarator":return async function(e,t){let r=null;if(r=null===t.init?null:await te(e,t.init),null!==e.localScope){if(r===T&&(r=null),"Identifier"!==t.id.type)throw new Error("Can only assign a regular variable");const n=t.id.name.toLowerCase();return e.localScope[n]={value:r,valueset:!0,node:t.init},T}if("Identifier"!==t.id.type)throw new Error("Can only assign a regular variable");const n=t.id.name.toLowerCase();return r===T&&(r=null),e.globalScope[n]={value:r,valueset:!0,node:t.init},T}(e,t);case"VariableDeclaration":return ue(e,t,0);case"BlockStatement":return async function(e,t){return le(e,t,0)}(e,t);case"FunctionDeclaration":return async function(e,t){const r=t.id.name.toLowerCase();return e.globalScope[r]={valueset:!0,node:null,value:new j(t,e)},T}(e,t);case"ReturnStatement":return async function(e,t){if(null===t.argument)return new v(T);const r=await te(e,t.argument);return new v(r)}(e,t);case"IfStatement":return async function(e,t){if("AssignmentExpression"===t.test.type||"UpdateExpression"===t.test.type)throw new Error(w(t.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));const r=await te(e,t.test);if(!0===r)return te(e,t.consequent);if(!1===r)return null!==t.alternate?te(e,t.alternate):T;throw new Error(w(t.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))}(e,t);case"ExpressionStatement":return async function(e,t){if("AssignmentExpression"===t.expression.type)return te(e,t.expression);if("CallExpression"===t.expression.type){const r=await te(e,t.expression);return r===T?T:new I(r)}const r=await te(e,t.expression);return r===T?T:new I(r)}(e,t);case"UpdateExpression":return async function(e,t){const r=t.argument;if("MemberExpression"===r.type){const n={t:null},o=await te(e,r.object);let a=null;n.t=o,!0===r.computed?a=await te(e,r.property):"Identifier"===r.property.type&&(a=r.property.name);const i=n.t;let s;if(U(i)){if(!M(a))throw new Error("Invalid Parameter");if(a<0&&(a=i.length+a),a<0||a>=i.length)throw new Error("Assignment outside of array bounds");s=F(i[a]),i[a]="++"===t.operator?s+1:s-1}else if(i instanceof h){if(!1===O(a))throw new Error("Dictionary accessor must be a string");if(!0!==i.hasField(a))throw new Error("Invalid Parameter");s=F(i.field(a)),i.setField(a,"++"===t.operator?s+1:s-1)}else{if(!C(i))throw A(i)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===O(a))throw new Error("Feature accessor must be a string");if(!0!==i.hasField(a))throw new Error("Invalid Parameter");s=F(i.field(a)),i.setField(a,"++"===t.operator?s+1:s-1)}return!1===t.prefix?s:"++"===t.operator?s+1:s-1}const n="Identifier"===t.argument.type?t.argument.name.toLowerCase():"";if(!n)throw new Error("Invalid identifier");let o;if(null!==e.localScope&&void 0!==e.localScope[n])return o=F(e.localScope[n].value),e.localScope[n]={value:"++"===t.operator?o+1:o-1,valueset:!0,node:t},!1===t.prefix?o:"++"===t.operator?o+1:o-1;if(void 0!==e.globalScope[n])return o=F(e.globalScope[n].value),e.globalScope[n]={value:"++"===t.operator?o+1:o-1,valueset:!0,node:t},!1===t.prefix?o:"++"===t.operator?o+1:o-1;throw new Error("Variable not recognised")}(e,t);case"AssignmentExpression":return async function(e,t){const r=t.left;if("MemberExpression"===r.type){const n=await te(e,t.right),o=await te(e,r.object);let a=null;if(!0===r.computed)a=await te(e,r.property);else{if("Identifier"!==r.property.type)throw new Error("Expected computed or identifier for assignemnt target");a=r.property.name}if(U(o)){if(!M(a))throw new Error("Invalid Parameter");if(a<0&&(a=o.length+a),a<0||a>o.length)throw new Error("Assignment outside of array bounds");if(a===o.length){if("="!==t.operator)throw new Error("Invalid Parameter");o[a]=ce(n,t.operator,o[a],t)}else o[a]=ce(n,t.operator,o[a],t)}else if(o instanceof h){if(!1===O(a))throw new Error("Dictionary accessor must be a string");if(!0===o.hasField(a))o.setField(a,ce(n,t.operator,o.field(a),t));else{if("="!==t.operator)throw new Error("Invalid Parameter");o.setField(a,ce(n,t.operator,null,t))}}else{if(!C(o))throw A(o)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===O(a))throw new Error("Feature accessor must be a string");if(!0===o.hasField(a))o.setField(a,ce(n,t.operator,o.field(a),t));else{if("="!==t.operator)throw new Error("Invalid Parameter");o.setField(a,ce(n,t.operator,null,t))}}return T}const n=r.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[n]){const r=await te(e,t.right);return e.localScope[n]={value:ce(r,t.operator,e.localScope[n].value,t),valueset:!0,node:t.right},T}if(void 0!==e.globalScope[n]){const r=await te(e,t.right);return e.globalScope[n]={value:ce(r,t.operator,e.globalScope[n].value,t),valueset:!0,node:t.right},T}throw new Error("Cannot assign undeclared variable")}(e,t);case"ForStatement":return function(e,t){try{return null!==t.init?te(e,t.init).then((()=>new Promise(((r,n)=>{ne(e,t,{testResult:!0,lastAction:T},(e=>{r(e)}),(e=>{n(e)}),0)})))):new Promise(((r,n)=>{ne(e,t,{testResult:!0,lastAction:T},(e=>{r(e)}),(e=>{n(e)}),0)}))}catch(e){return Promise.reject(e)}}(e,t);case"ForInStatement":return async function(e,t){return new Promise(((r,n)=>{te(e,t.right).then((o=>{try{let a=null;a="VariableDeclaration"===t.left.type?te(e,t.left):Promise.resolve(),a.then((()=>{try{let a="";if("VariableDeclaration"===t.left.type){const e=t.left.declarations[0].id;"Identifier"===e.type&&(a=e.name)}else"Identifier"===t.left.type&&(a=t.left.name);if(!a)throw new Error(w(t,"RUNTIME","INVALIDVARIABLE"));a=a.toLowerCase();let i=null;if(null!==e.localScope&&void 0!==e.localScope[a]&&(i=e.localScope[a]),null===i&&void 0!==e.globalScope[a]&&(i=e.globalScope[a]),null===i)return void n(new Error(w(t,"RUNTIME","VARIABLENOTDECLARED")));U(o)||O(o)?ie(e,t,o,{reject:n,resolve:r},i):A(o)?function(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(T);ae(e,t,r,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(e){n.reject(e)}}(e,t,o,{reject:n,resolve:r},i):o instanceof h||C(o)?function(e,t,r,n,o){try{ie(e,t,r.keys(),n,o,"k")}catch(e){n.reject(e)}}(e,t,o,{reject:n,resolve:r},i):x(o)?se(o.iterator(e.abortSignal),e,t,o,i,(e=>{r(e)}),(e=>{n(e)}),0):ie(e,t,[],{reject:n,resolve:r},i)}catch(e){n(e)}}),n)}catch(e){n(e)}}),n)}))}(e,t);case"BreakStatement":return S;case"EmptyStatement":return T;case"ContinueStatement":return b;case"TemplateElement":return async function(e,t){return t.value?t.value.cooked:""}(0,t);case"TemplateLiteral":return async function(e,t){const r=[];for(let n=0;n<t.expressions.length;n++){const o=await te(e,t.expressions[n]);r[n]=P(o)}let n="",o=0;for(const e of t.quasis)n+=e.value?e.value.cooked:"",!1===e.tail&&(n+=r[o]?r[o]:"",o++);return n}(e,t);case"Identifier":return me(e,t);case"MemberExpression":return async function(e,t){const r=await te(e,t.object);if(null===r)throw new Error(w(t,"RUNTIME","NOTFOUND"));if(!1===t.computed){if("Identifier"===t.property.type){if(r instanceof h||C(r))return r.field(t.property.name);if(r instanceof q)return pe(r,t.property.name,0,t);throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}let n=await te(e,t.property);if(r instanceof h||C(r)){if(O(n))return r.field(n);throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}if(r instanceof q){if(O(n))return pe(r,n,0,t);throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}if(U(r)){if(M(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length+n),n>=r.length||n<0)throw new Error(w(t,"RUNTIME","OUTOFBOUNDS"));return r[n]}throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}if(A(r)){if(M(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length()+n),n>=r.length()||n<0)throw new Error(w(t,"RUNTIME","OUTOFBOUNDS"));return r.get(n)}throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}if(O(r)){if(M(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length+n),n>=r.length||n<0)throw new Error(w(t,"RUNTIME","OUTOFBOUNDS"));return r[n]}throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}throw new Error(w(t,"RUNTIME","INVALIDTYPE"))}(e,t);case"Literal":return t.value;case"CallExpression":return async function(e,t){if("Identifier"!==t.callee.type)throw new Error(w(t,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[t.callee.name.toLowerCase()]){const r=e.localScope[t.callee.name.toLowerCase()];if(r.value instanceof N)return r.value.fn(e,t);if(r.value instanceof j)return Ie(e,t,r.value.definition);throw new Error(w(t,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[t.callee.name.toLowerCase()]){const r=e.globalScope[t.callee.name.toLowerCase()];if(r.value instanceof N)return r.value.fn(e,t);if(r.value instanceof j)return Ie(e,t,r.value.definition);throw new Error(w(t,"RUNTIME","NOTAFUNCTION"))}throw new Error(w(t,"RUNTIME","NOTFOUND"))}(e,t);case"UnaryExpression":return async function(e,t){const r=await te(e,t.argument);if(E(r)){if("!"===t.operator)return!r;if("-"===t.operator)return-1*F(r);if("+"===t.operator)return 1*F(r);if("~"===t.operator)return~F(r);throw new Error(w(t,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))}if("-"===t.operator)return-1*F(r);if("+"===t.operator)return 1*F(r);if("~"===t.operator)return~F(r);throw new Error(w(t,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))}(e,t);case"BinaryExpression":return async function(e,t){const r=[];r[0]=await te(e,t.left),r[1]=await te(e,t.right);const n=r[0],o=r[1];switch(t.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return L(F(n),F(o),t.operator);case"==":return y(n,o);case"!=":return!y(n,o);case"<":case">":case"<=":case">=":return D(n,o,t.operator);case"+":return O(n)||O(o)?P(n)+P(o):F(n)+F(o);case"-":return F(n)-F(o);case"*":return F(n)*F(o);case"/":return F(n)/F(o);case"%":return F(n)%F(o);default:throw new Error(w(t,"RUNTIME","OPERATORNOTRECOGNISED"))}}(e,t);case"LogicalExpression":return async function(e,t){if("AssignmentExpression"===t.left.type||"UpdateExpression"===t.left.type)throw new Error(w(t.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("AssignmentExpression"===t.right.type||"UpdateExpression"===t.right.type)throw new Error(w(t.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));const r=await te(e,t.left);let n=null;if(!E(r))throw new Error(w(t,"RUNTIME","ONLYBOOLEAN"));switch(t.operator){case"||":if(!0===r)return r;if(n=await te(e,t.right),E(n))return n;throw new Error(w(t,"RUNTIME","ONLYORORAND"));case"&&":if(!1===r)return r;if(n=await te(e,t.right),E(n))return n;throw new Error(w(t,"RUNTIME","ONLYORORAND"));default:throw new Error(w(t,"RUNTIME","ONLYORORAND"))}}(e,t);case"ArrayExpression":return async function(e,t){const r=[];for(let n=0;n<t.elements.length;n++)r.push(await te(e,t.elements[n]));for(let e=0;e<r.length;e++){if(R(r[e]))throw new Error(w(t,"RUNTIME","FUNCTIONCONTEXTILLEGAL"));r[e]===T&&(r[e]=null)}return r}(e,t);case"ObjectExpression":return async function(e,t){const r=[];for(let n=0;n<t.properties.length;n++)r[n]=await te(e,t.properties[n]);const n={};for(let e=0;e<r.length;e++){const t=r[e];if(R(t.value))throw new Error("Illegal Argument");if(!1===O(t.key))throw new Error("Illegal Argument");t.value===T?n[t.key.toString()]=null:n[t.key.toString()]=t.value}const o=new h(n);return o.immutable=!1,o}(e,t);case"Property":return async function(e,t){const r=await te(e,t.value);return"Identifier"===t.key.type?{key:t.key.name,value:r}:{key:await te(e,t.key),value:r}}(e,t);default:throw new Error(w(t,"RUNTIME","UNREOGNISED"))}}async function re(e,t,r){const n=await te(e,t.body);return r.lastAction=n,r.lastAction===S||r.lastAction instanceof v?(r.testResult=!1,r):null!==t.update?(await te(e,t.update),r):r}function ne(e,t,r,n,o,a){try{(async function(e,t,r){if(null!==t.test){const n=await te(e,t.test);if(!0===e.abortSignal.aborted)throw new Error("Cancelled");if(r.testResult=n,!1===r.testResult)return r;if(!0!==r.testResult)throw new Error(w(t,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"));return re(e,t,r)}return re(e,t,r)})(e,t,r).then((()=>{try{!0===r.testResult?++a>100?(a=0,setTimeout((()=>{ne(e,t,r,n,o,a)}),0)):ne(e,t,r,n,o,a):r.lastAction instanceof v?n(r.lastAction):n(T)}catch(e){o(e)}}),(e=>{o(e)}))}catch(e){o(e)}}function oe(e,t,r,n,o,a,i,s,c,l){try{if(n<=a)return void s(T);o.value="k"===i?r[a]:a,te(e,t.body).then((u=>{try{u instanceof v?s(u):u===S?s(T):++l>100?(l=0,setTimeout((()=>{oe(e,t,r,n,o,a+1,i,s,c,l)}),0)):oe(e,t,r,n,o,a+1,i,s,c,l)}catch(e){c(e)}}),(e=>{c(e)}))}catch(e){c(e)}}function ae(e,t,r,n,o,a,i,s,c){try{if(r.length()<=o)return void i(T);n.value="k"===a?r.get(o):o,te(e,t.body).then((l=>{l instanceof v?i(l):l===S?i(T):++c>100?(c=0,setTimeout((()=>{ae(e,t,r,n,o+1,a,i,s,c)}),0)):ae(e,t,r,n,o+1,a,i,s,c)}),(e=>{s(e)}))}catch(e){s(e)}}function ie(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(T);oe(e,t,r,r.length,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(e){n.reject(e)}}function se(e,t,r,n,o,a,i,s){try{e.next().then((c=>{try{if(null===c)a(T);else{const l=d.createFromGraphicLikeObject(c.geometry,c.attributes,n);l._underlyingGraphic=c,o.value=l,te(t,r.body).then((c=>{try{c===S?a(T):c instanceof v?a(c):++s>100?(s=0,setTimeout((()=>{se(e,t,r,n,o,a,i,s)}),0)):se(e,t,r,n,o,a,i,s)}catch(e){i(e)}}),(e=>{i(e)}))}}catch(e){i(e)}}),(e=>{i(e)}))}catch(e){i(e)}}function ce(e,t,r,n){switch(t){case"=":return e===T?null:e;case"/=":return F(r)/F(e);case"*=":return F(r)*F(e);case"-=":return F(r)-F(e);case"+=":return O(r)||O(e)?P(r)+P(e):F(r)+F(e);case"%=":return F(r)%F(e);default:throw new Error(w(n,"RUNTIME","OPERATORNOTRECOGNISED"))}}async function le(e,t,r){if(r>=t.body.length)return T;const n=await te(e,t.body[r]);return n instanceof v||n===S||n===b||r===t.body.length-1?n:le(e,t,r+1)}async function ue(e,t,r){return r>=t.declarations.length||(await te(e,t.declarations[r]),r===t.declarations.length-1||await ue(e,t,r+1)),T}let fe=0;function pe(e,t,r,n){let o;switch(t=t.toLowerCase()){case"hasz":{const t=e.hasZ;return void 0!==t&&t}case"hasm":{const t=e.hasM;return void 0!==t&&t}case"spatialreference":{let t=e.spatialReference._arcadeCacheId;if(void 0===t){let r=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(r=!1),r&&(fe++,e.spatialReference._arcadeCacheId=fe,t=fe)}const r=new h({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==t&&(r._arcadeCacheId="SPREF"+t.toString()),r}}switch(e.type){case"extent":switch(t){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const r=e[t];return void 0!==r?r:null}case"type":return"Extent"}break;case"polygon":switch(t){case"rings":return o=e.cache._arcadeCacheId,void 0===o&&(fe++,o=fe,e.cache._arcadeCacheId=o),new V(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);case"type":return"Polygon"}break;case"point":switch(t){case"x":case"y":case"z":case"m":return void 0!==e[t]?e[t]:null;case"type":return"Point"}break;case"polyline":switch(t){case"paths":return o=e.cache._arcadeCacheId,void 0===o&&(fe++,o=fe,e.cache._arcadeCacheId=o),new V(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);case"type":return"Polyline"}break;case"multipoint":switch(t){case"points":return o=e.cache._arcadeCacheId,void 0===o&&(fe++,o=fe,e.cache._arcadeCacheId=o),new _(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,o,1);case"type":return"Multipoint"}}throw new Error(w(n,"RUNTIME","PROPERTYNOTFOUND"))}async function me(e,t){const r=t.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[r]){const t=e.localScope[r];if(!0===t.valueset)return t.value;if(null!==t.d)return t.d;t.d=te(e,t.node);const n=await t.d;return t.value=n,t.valueset=!0,n}if(void 0!==e.globalScope[r]){const t=e.globalScope[r];if(!0===t.valueset)return t.value;if(null!==t.d)return t.d;t.d=te(e,t.node);const n=await t.d;return t.value=n,t.valueset=!0,n}throw new Error(w(t,"RUNTIME","VARIABLENOTFOUND"))}const we={};function he(e){return null===e?"":U(e)||A(e)?"Array":Y(e)?"Date":O(e)?"String":E(e)?"Boolean":M(e)?"Number":e instanceof i?"Attachment":e instanceof s?"Portal":e instanceof h?"Dictionary":C(e)?"Feature":e instanceof H?"Point":e instanceof J?"Polygon":e instanceof W?"Polyline":e instanceof Z?"Multipoint":e instanceof z?"Extent":R(e)?"Function":x(e)?"FeatureSet":B(e)?"FeatureSetCollection":e===T?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}async function de(e,t,r,n){const o=await te(e,t.arguments[r]);if(y(o,n))return te(e,t.arguments[r+1]);const a=t.arguments.length-r;return 1===a?te(e,t.arguments[r]):2===a?null:3===a?te(e,t.arguments[r+2]):de(e,t,r+2,n)}async function ge(e,t,r,n){if(!0===n)return te(e,t.arguments[r+1]);if(3==t.arguments.length-r)return te(e,t.arguments[r+2]);const o=await te(e,t.arguments[r+2]);if(!1===E(o))throw new Error("WHEN needs boolean test conditions");return ge(e,t,r+2,o)}async function Ee(e,t){const r=e.length,n=Math.floor(r/2);if(0===r)return[];if(1===r)return[e[0]];const o=[Ee(e.slice(0,n),t),Ee(e.slice(n,r),t)],a=await Promise.all(o);return ye(a[0],a[1],t,[])}async function ye(e,t,r,n){const o=n;if(!(e.length>0||t.length>0))return n;if(e.length>0&&t.length>0){let a=await r(e[0],t[0]);return isNaN(a)&&(a=1),a<=0?(o.push(e[0]),e=e.slice(1)):(o.push(t[0]),t=t.slice(1)),ye(e,t,r,n)}return e.length>0?(o.push(e[0]),ye(e=e.slice(1),t,r,n)):t.length>0?(o.push(t[0]),ye(e,t=t.slice(1),r,n)):void 0}function Ne(e,t){const r=e.length,n=Math.floor(r/2);return t||(t=function(e,t){return e<t?-1:e===t?0:1}),0===r?[]:1===r?[e[0]]:function(e,t,r){const n=[];for(;e.length>0||t.length>0;)if(e.length>0&&t.length>0){let o=r(e[0],t[0]);isNaN(o)&&(o=1),o<=0?(n.push(e[0]),e=e.slice(1)):(n.push(t[0]),t=t.slice(1))}else e.length>0?(n.push(e[0]),e=e.slice(1)):t.length>0&&(n.push(t[0]),t=t.slice(1));return n}(Ne(e.slice(0,n),t),Ne(e.slice(n,r),t),t)}async function ve(e,t,r){const n=e.body;if(r.length!==e.params.length)throw new Error("Invalid Parameter calls to function.");for(let n=0;n<r.length;n++){const o=e.params[n];"Identifier"===o.type&&(t.localScope[o.name.toLowerCase()]={d:null,value:r[n],valueset:!0,node:null})}const o=await te(t,n);if(o instanceof v)return o.value;if(o===S)throw new Error("Cannot Break from a Function");if(o===b)throw new Error("Cannot Continue from a Function");return o instanceof I?o.value:o}function Ie(e,t,r){return ee(e,t,(function(t,n,o){const a={spatialReference:e.spatialReference,services:e.services,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,localScope:{},abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return ve(r,a,o)}))}function Te(e){return function(){const t={abortSignal:e.context.abortSignal,spatialReference:e.context.spatialReference,console:e.context.console,lrucache:e.context.lrucache,interceptor:e.context.interceptor,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(t.depthCounter>64)throw new Error("Exceeded maximum function depth");return ve(e.definition,t,arguments)}}e(we,$),t(we,$),r(we,$),n(we,$),o(we,$),G({functions:we,compiled:!1,signatures:null,evaluateIdentifier:null,arcadeCustomFunctionHandler:null,mode:"async",standardFunction:$,standardFunctionAsync:ee}),we.typeof=function(e,t){return $(e,t,(function(e,t,r){g(r,1,1);const n=he(r[0]);if("Unrecognised Type"===n)throw new Error("Unrecognised Type");return n}))},we.iif=async function(e,t){g(null===t.arguments?[]:t.arguments,3,3);const r=await te(e,t.arguments[0]);if(!1===E(r))throw new Error("IF Function must have a boolean test condition");const n=[];return n[0]=await te(e,t.arguments[1]),n[1]=await te(e,t.arguments[2]),r?n[0]:n[1]},we.decode=async function(e,t){if(t.arguments.length<2)throw new Error("Missing Parameters");if(2===t.arguments.length)return te(e,t.arguments[1]);if((t.arguments.length-1)%2==0)throw new Error("Must have a default value result.");return de(e,t,1,await te(e,t.arguments[0]))},we.when=async function(e,t){if(t.arguments.length<3)throw new Error("Missing Parameters");if(t.arguments.length%2==0)throw new Error("Must have a default value result.");const r=await te(e,t.arguments[0]);if(!1===E(r))throw new Error("WHEN needs boolean test conditions");return ge(e,t,0,r)},we.sort=function(e,t){return ee(e,t,(async function(e,t,r){g(r,1,2);let n=r[0];if(A(n)&&(n=n.toArray()),!1===U(n))throw new Error("Illegal Argument");if(r.length>1){if(!1===R(r[1]))throw new Error("Illegal Argument");return Ee(n,Te(r[1]))}let o=n;if(0===o.length)return[];const a={};for(let e=0;e<o.length;e++){const t=he(o[e]);""!==t&&(a[t]=!0)}if(!0===a.Array||!0===a.Dictionary||!0===a.Feature||!0===a.Point||!0===a.Polygon||!0===a.Polyline||!0===a.Multipoint||!0===a.Extent||!0===a.Function)return o.slice(0);let i=0,s="";for(const e in a)i++,s=e;return i>1||"String"===s?o=Ne(o,(function(e,t){if(null==e||e===T)return null==t||t===T?0:1;if(null==t||t===T)return-1;const r=P(e),n=P(t);return r<n?-1:r===n?0:1})):"Number"===s?o=Ne(o,(function(e,t){return e-t})):"Boolean"===s?o=Ne(o,(function(e,t){return e===t?0:t?-1:1})):"Date"===s&&(o=Ne(o,(function(e,t){return t-e}))),o}))};const Se={fixSpatialReference:k,parseArguments:Q,standardFunction:$,standardFunctionAsync:ee,evaluateIdentifier:me,arcadeCustomFunction:Te};for(const e in we)we[e]={value:new N(we[e]),valueset:!0,node:null};const be=function(){};function je(e){console.log(e)}(be.prototype=we).infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},be.prototype.pi={value:Math.PI,valueset:!0,node:null};const Re=Se;function Oe(e){const t={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:$,standardFunctionAsync:ee,evaluateIdentifier:me,arcadeCustomFunctionHandler:Te};for(let r=0;r<e.length;r++)e[r].registerFunctions(t);for(const e in t.functions)we[e]={value:new N(t.functions[e]),valueset:!0,node:null},be.prototype[e]=we[e];for(let e=0;e<t.signatures.length;e++)c(t.signatures[e],"async")}async function Ue(e,t){let r=t.spatialReference;null==r&&(r=new X({wkid:102100}));const n=function(e,t){const r=new be;null==e&&(e={}),null==t&&(t={});const n=new h({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});n.immutable=!1,r.textformatting={value:n,valueset:!0,node:null};for(const e in t)r[e]={value:new N(t[e]),native:!0,valueset:!0,node:null};for(const t in e)e[t]&&"esri.Graphic"===e[t].declaredClass?r[t]={value:d.createFromGraphic(e[t]),valueset:!0,node:null}:r[t]={value:e[t],valueset:!0,node:null};return r}(t.vars,t.customfunctions),o={spatialReference:r,services:t.services,abortSignal:void 0===t.abortSignal||null===t.abortSignal?{aborted:!1}:t.abortSignal,globalScope:n,console:t.console?t.console:je,lrucache:t.lrucache,interceptor:t.interceptor,localScope:null,depthCounter:1};let a=await te(o,e.body[0].body);if(a instanceof v&&(a=a.value),a instanceof I&&(a=a.value),a===T&&(a=null),a===S)throw new Error("Cannot return BREAK");if(a===b)throw new Error("Cannot return CONTINUE");if(a instanceof N)throw new Error("Cannot return FUNCTION");if(a instanceof j)throw new Error("Cannot return FUNCTION");return a}function Ae(e,t){return l(e)}function Ce(e,t){return u(e,t,"full")}function xe(e,t){return f(e,t)}function Me(e,t){return p(e,t)}function Fe(e){return m(e)}Oe([a]);export{Ue as executeScript,Oe as extend,Ae as extractFieldLiterals,Fe as findFunctionCalls,Re as functionHelper,Me as referencesFunction,xe as referencesMember,Ce as validateScript};
