/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{m as e}from"../core/lang.js";import{L as l}from"./Logger.js";import{o}from"./ensureType.js";import{f as n,c as t}from"./number2.js";import{f as a,r as i}from"./numberUtils.js";import r from"../renderers/visualVariables/support/ColorStop.js";import{g as s}from"./utils6.js";import u from"../Color.js";import"../symbols.js";import f from"../symbols/SimpleLineSymbol.js";import c from"../renderers/support/HeatmapColorStop.js";const m="<",p=">",A=t("short-date");function d(e,l,o,t){let i="";0===l?i="< ":l===o&&(i="> ");let r=null;return r=t?n(e,A):a(e),i+r}const g=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwcdIkqhiWn5fHwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6JrzFUAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwaeIkqhiWl5/HwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6sKxboAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwadJEqhiWl5fPwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu75+IUcAAAAASUVORK5CYII="];async function h(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const l=e.visualVariables.find((e=>"color"===e.type));if(!l)return null;let o=null,n=null;if(l.stops){if(1===l.stops.length)return l.stops[0].color;o=l.stops[0].value,n=l.stops[l.stops.length-1].value}const t=o+(n-o)/2,{getColor:a}=await import("./visualVariableUtils.js");return a(l,t)}async function y(e,l){const o=e.trailCap,n=e.trailWidth||1,t=l||await h(e)||e.color;return new f({cap:o,color:t,width:n})}const b=new u([64,64,64]);function v(e,l){const o=[],n=e.length-1;return 5===e.length?o.push(0,2,4):o.push(0,n),e.map(((e,t)=>o.includes(t)?d(e,t,n,l):null))}async function w(e,l,o){let n=!1,t=[],a=[];if(e.stops){const l=e.stops;t=l.map((e=>e.value)),n=l.some((e=>!!e.label)),n&&(a=l.map((e=>e.label)))}const i=t[0],r=t[t.length-1];if(null==i&&null==r)return null;const s=n?null:v(t,o),f=await Promise.all(t.map((async(o,t)=>{const i="opacity"===e.type?await async function(e,l,o=b){const n=new u(o),t=(await import("./visualVariableUtils.js")).getOpacity(l,e);return null!=t&&(n.a=t),n}(o,e,l):(await import("./visualVariableUtils.js")).getColor(e,o);return{value:o,color:i,label:n?a[t]:s[t]}})));return f.reverse()}function V(e){let l=!1,o=[],n=[];o=e.map((e=>e.value)),l=e.some((e=>!!e.label)),l&&(n=e.map((e=>e.label)));const t=o[0],a=o[o.length-1];if(null==t&&null==a)return null;const i=l?null:v(o,!1);return o.map(((o,t)=>({value:o,color:I(o,e),label:l?n[t]:i[t]}))).reverse()}function I(e,l){const{startIndex:o,endIndex:n,weight:t}=function(e,l){let o=0,n=l.length-1;return l.some(((l,t)=>e<l.value?(n=t,!0):(o=t,!1))),{startIndex:o,endIndex:n,weight:(e-l[o].value)/(l[n].value-l[o].value)}}(e,l);if(o===n)return l[o].color;const a=u.blendColors(l[o].color,l[n].color,t);return new u(a)}function E(e,l){let o=[];if(e&&"multipart"===e.type)e.colorRamps.reverse().forEach(((n,t)=>{0===t?o.push({value:l.max,color:new u(n.toColor),label:"high"}):o.push({value:null,color:new u(n.toColor),label:""}),t===e.colorRamps.length-1?o.push({value:l.min,color:new u(n.fromColor),label:"low"}):o.push({value:null,color:new u(n.fromColor),label:""})}));else{let n,t;e&&"algorithmic"===e.type?(n=e.fromColor,t=e.toColor):(n=[0,0,0,1],t=[255,255,255,1]),o=[{value:l.max,color:new u(t),label:"high"},{value:l.min,color:new u(n),label:"low"}]}return o}function x(e){if(!e.colorStops)return[];const l=[...e.colorStops].filter((e=>e.color?.a>0));let o=l.length-1;if(l&&l[0]){const e=l[o];e&&1!==e.ratio&&(l.push(new c({ratio:1,color:e.color})),o++)}return l.map(((l,n)=>{let t="";return 0===n?t=e.legendOptions?.minLabel||"low":n===o&&(t=e.legendOptions?.maxLabel||"high"),{color:l.color,label:t,ratio:l.ratio}})).reverse()}const C=l.getLogger("esri.renderers.support.utils"),j={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},B={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},F=t("short-date");function S(e,l,n){o(e,l,(()=>[])).push(...n)}async function z(l){const o=new Map;if("visualVariables"in l&&l.visualVariables){const e=l.visualVariables.filter((e=>"color"===e.type));for(const l of e){const e=l.field||l.valueExpression,n=(await w(l)).map((e=>e.color));S(o,e,n)}}if("heatmap"===l.type){const e=x(l).map((e=>e.color));S(o,l.field,e)}else if("pie-chart"===l.type){for(const e of l.attributes)S(o,e.field,[e.color]);S(o,null,[l?.othersCategory?.color,s(l.backgroundFillSymbol,null)])}else if("dot-density"===l.type){for(const e of l.attributes)S(o,e.field,[e.color]);S(o,null,[l.backgroundColor])}else if("unique-value"===l.type)if("predominance"===l.authoringInfo?.type)for(const e of l.uniqueValueInfos)S(o,e.value.toString(),[s(e.symbol,null)]);else{const e=l.uniqueValueInfos.map((e=>s(e.symbol,null))),{field:n,field2:t,field3:a,valueExpression:i}=l;(n||i)&&S(o,n||i,e),t&&S(o,t,e),a&&S(o,a,e)}else if("class-breaks"===l.type){const e=l.classBreakInfos.map((e=>s(e.symbol,null)));S(o,l.field||l.valueExpression,e)}else"simple"===l.type&&S(o,null,[s(l.symbol,null)]);return"defaultSymbol"in l&&l.defaultSymbol&&S(o,null,[s(l.defaultSymbol,null)]),o.forEach(((l,n)=>{const t=e(l.filter(Boolean),((e,l)=>JSON.stringify(e)===JSON.stringify(l)));o.set(n,t)})),o}function U(e){const{values:l,colors:o,labelIndexes:t,isDate:i,dateFormatOptions:s}=e;return l.map(((e,u)=>{let f=null;if(!t||t.includes(u)){let o;o=i?n(e,s):a(e),o&&(f=function(e,l,o){let n="";return 0===l?n="< ":l===o&&(n="> "),n+e}(o,u,l.length-1))}return new r({value:e,color:o[u],label:f})}))}function k(e){let l=e.minValue,o=e.maxValue;const n=e.isFirstBreak?"":"> ",t="percent-of-total"===e.normalizationType?"%":"";return l=null==l?"":a(l),o=null==o?"":a(o),n+l+t+" â€“ "+o+t}function q(e){const l=e.classBreakInfos,o=e.normalizationType;let n=[];if(l&&l.length)if("standard-deviation"!==e.classificationMethod)if(e.round){n.push(l[0].minValue);for(const e of l)n.push(e.maxValue);n=i(n),l.forEach(((e,l)=>{e.label=k({minValue:0===l?n[0]:n[l],maxValue:n[l+1],isFirstBreak:0===l,normalizationType:o})}))}else l.forEach(((e,l)=>{e.label=k({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===l,normalizationType:o})}));else C.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")}function M(e){const l=e.map((e=>new Date(e))),o=l.length;let n=1/0,t=null;for(let e=0;e<o-1;e++){const a=l[e];let i=1/0,r=null;for(let n=e+1;n<o;n++){const e=l[n],o=(a.getFullYear()!==e.getFullYear()?"year":a.getMonth()!==e.getMonth()&&"month")||a.getDate()!==e.getDate()&&"day"||a.getHours()!==e.getHours()&&"hour"||a.getMinutes()!==e.getMinutes()&&"minute"||a.getSeconds()!==e.getSeconds()&&"second"||"millisecond",t=j[o];t<i&&(i=t,r=o)}i<n&&(n=i,t=r)}return t}function N(e){const{value:l,domain:o,fieldInfo:i,dateFormatInterval:r}=e;let s=String(l);const u=o&&"codedValues"in o&&o.codedValues?o.getName(l):null;return u?s=u:"number"==typeof l&&(s=i&&"date"===i.type?n(l,r&&t(B[r])):a(l)),s}function O(e,l){return"normalizationField"in e&&e.normalizationField?{type:"normalized-field",field:e.field,normalizationField:e.normalizationField}:"field"in e&&e.field?Q(e.field):"valueExpression"in e&&e.valueExpression?{type:"expression",expression:e.valueExpression,title:e.valueExpressionTitle,returnType:l}:null}function Q(e){return{type:"field",field:e}}function R(l,o){const n=[];if("class-breaks"===l.type||"heatmap"===l.type)n.push(O(l,"number"));else if("unique-value"===l.type){const e=l.authoringInfo;if(e&&"relationship"===e.type){if(e.field1&&e.field2){const l=e.field1.field,o=e.field2.field,t=e.field1.normalizationField,a=e.field2.normalizationField;n.push(O({field:l,normalizationField:t})),n.push(O({field:o,normalizationField:a}))}}else{const e=l.uniqueValueInfos[0];let o=null;if(e&&e.value){const e=typeof l.uniqueValueInfos[0].value;"string"!==e&&"number"!==e||(o=e)}n.push(O(l,o)),[l.field2,l.field3].forEach((e=>e&&n.push(Q(e))))}}else"attributes"in l&&l.attributes.forEach((e=>n.push(O(e,"number"))));const t=o?o(l):"visualVariables"in l?l.visualVariables:null;return t&&t.forEach((e=>n.push(O(e,"number")))),e(n.filter(Boolean),((e,l)=>"field"===e.type&&"field"===l.type?e.field===l.field:"normalized-field"===e.type&&"normalized-field"===l.type?e.field===l.field&&e.normalizationField===l.normalizationField:"expression"===e.type&&"expression"===l.type&&e.expression===l.expression))}export{g as R,m as S,N as a,M as b,U as c,z as d,d as e,y as f,R as g,p as h,I as i,V as j,x as k,E as l,h as m,w as n,q as s,F as t};
