/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{Z as t}from"./vec4f64.js";import{S as e,d as s,a as r,T as a,O as o,j as i,g as n,m as l,C as p,F as u,k as c,s as h,c as d,P as f,l as g,n as m,o as v,R as _,D as y,G as T}from"./glUtil3D.js";import{T as C,C as O}from"./basicInterfaces.js";import{o as P,D as A,b as D}from"./CameraSpace.glsl.js";import{g as S,D as b,M as w,i as x,a as E}from"./Material.js";import{m as F,b as j,o as N,c as M,f as R,a as I,d as V,g as $,h as L}from"./OrderIndependentTransparency.js";import{R as G}from"./RenderSlot.js";import{V as H}from"./VertexColor.glsl.js";import{V as U}from"./VertexAttribute.js";import{_ as W}from"./tslib.es6.js";import{p as z}from"./ShaderTechniqueConfiguration.js";const q=Object.freeze(Object.defineProperty({__proto__:null,build:function(t){const d=new e,f=t.output===s.Depth,g=t.hasMultipassTerrain&&(t.output===s.Color||t.output===s.Alpha);r(d,t),d.include(a,{hasModelTransformation:!1,linearDepth:f}),d.include(H,t),d.attributes.add(U.POSITION,"vec3"),d.varyings.add("vpos","vec3"),g&&d.varyings.add("depth","float");const{vertex:m,fragment:v}=d;return f&&(d.include(o,t),m.uniforms.add(new i("nearFar",((t,e)=>e.camera.nearFar))),d.varyings.add("linearDepth","float")),m.code.add(S`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${g?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${f?S`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:S`transformPosition(proj, view, vpos);`}
    }
  `),d.include(n,t),g&&d.include(l,t),v.include(p),v.uniforms.add(new u("eColor",(t=>t.color))),t.output===s.Highlight&&d.include(c),v.code.add(S`
  void main() {
    discardBySlice(vpos);
    ${g?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${t.hasVertexColors?"vColor * eColor;":"eColor;"}

    if (fColor.a < ${S.float(h)}) {
      discard;
    }

    ${t.output===s.Alpha?S`gl_FragColor = vec4(fColor.a);`:""}

    ${t.output===s.Color?S`gl_FragColor = highlightSlice(fColor, vpos); ${t.transparencyPassType===C.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${t.output===s.Highlight?S`outputHighlight();`:""};
    ${t.output===s.Depth?S`outputDepth(linearDepth);`:""};
  }
  `),d}},Symbol.toStringTag,{value:"Module"}));class B extends d{initializeProgram(t){const e=B.shader.get().build(this.configuration);return new f(t.rctx,e,b)}_createPipeline(t,e){const r=this.configuration,a=t===C.NONE,o=t===C.FrontFace;return F({blending:r.output!==s.Color&&r.output!==s.Alpha||!r.transparent?null:a?j:N(t),culling:M(r.cullFace),depthTest:{func:R(t)},depthWrite:a||o?r.writeDepth&&I:null,colorWrite:V,stencilWrite:r.hasOccludees?g:null,stencilTest:r.hasOccludees?e?m:v:null,polygonOffset:a||o?r.polygonOffset&&Q:$(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,e){return e?this._occludeePipelineState:super.getPipelineState(t,e)}}B.shader=new _(q,(()=>Promise.resolve().then((()=>q))));const Q={factor:1,units:1};class k extends y{constructor(){super(...arguments),this.output=s.Color,this.cullFace=O.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=C.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}W([z({count:s.COUNT})],k.prototype,"output",void 0),W([z({count:O.COUNT})],k.prototype,"cullFace",void 0),W([z()],k.prototype,"hasSlicePlane",void 0),W([z()],k.prototype,"hasVertexColors",void 0),W([z()],k.prototype,"transparent",void 0),W([z()],k.prototype,"polygonOffset",void 0),W([z()],k.prototype,"enableOffset",void 0),W([z()],k.prototype,"writeDepth",void 0),W([z()],k.prototype,"hasOccludees",void 0),W([z({count:C.COUNT})],k.prototype,"transparencyPassType",void 0),W([z()],k.prototype,"hasMultipassTerrain",void 0),W([z()],k.prototype,"cullAboveGround",void 0);class Z extends w{constructor(t){super(t,new K),this.supportsEdges=!0,this._configuration=new k}getConfiguration(t,e){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=e.transparencyPassType,this._configuration.enableOffset=e.camera.relativeElevation<L,this._configuration.hasMultipassTerrain=e.multipassTerrain.enabled,this._configuration.cullAboveGround=e.multipassTerrain.cullAboveGround,this._configuration}intersect(t,e,s,r,a,o,i){x(t,e,r,a,o,void 0,i)}requiresSlot(t,e){return t===G.DRAPED_MATERIAL||(P(e)===s.Highlight?t===G.OPAQUE_MATERIAL:t===(this.parameters.transparent?this.parameters.writeDepth?G.TRANSPARENT_MATERIAL:G.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:G.OPAQUE_MATERIAL))}createGLMaterial(t){return t.output===s.Color||t.output===s.Alpha||t.output===s.Highlight||t.output===s.Depth&&this.parameters.writeLinearDepth?new J(t):null}createBufferWriter(){return new A(D)}}class J extends T{_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==s.Color&&this._output!==s.Alpha||this._updateOccludeeState(t),this.ensureTechnique(B,t)}}class K extends E{constructor(){super(...arguments),this.color=t,this.transparent=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=O.None,this.hasOccludees=!1}}export{Z as C};
