/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import"../core/lang.js";import{c as t}from"./mathUtils.js";import{a as i}from"./maybe.js";function h(i,h){const e=function(i,h){const{format:e,quality:a,rotation:n,disableDecorations:o}=i||{},r=M(i,h.padding),l=function(t,i){const h={x:0,y:0,width:i.width,height:i.height};if(t&&t.area){null!=t.area.x&&(h.x=Math.floor(t.area.x)),null!=t.area.y&&(h.y=Math.floor(t.area.y));const e=null!=t.area.width?Math.floor(t.area.width):null,a=null!=t.area.height?Math.floor(t.area.height):null;if(h.width=i.width-h.x,h.height=i.height-h.y,null!=e&&null!=a)h.width=Math.min(h.width,e),h.height=Math.min(h.height,a);else if(null==e&&null!=a){const t=Math.min(h.width,e);h.height=t/h.width*h.height,h.width=t}else if(null!=e&&null==a){const t=Math.min(h.height,a);h.width=t/h.height*h.width,h.height=t}}return function(t,i){const h=Math.floor(Math.max(t.x,0)),e=Math.floor(Math.max(t.y,0)),a={x:h,y:e,width:Math.floor(Math.min(t.width,i.width-h)),height:Math.floor(Math.min(t.height,i.height-e))},n=a.width/a.height,o=t.width/t.height;if(o===n)return a;if(o>n){const t=Math.floor(a.width/o),i=a.height-t;return{x:a.x,y:Math.floor(a.y+i/2),width:a.width,height:t}}const r=Math.floor(a.height*o),l=a.width-r;return{x:Math.floor(a.x+l/2),y:a.y,width:r,height:a.height}}(function(t,i){if(!i||null==i.width||null==i.height)return t;const h=i.width/i.height,e=t.width/t.height;if(e===h)return t;if(e<h){const i=Math.floor(t.height*h);return t.x-=(i-t.width)/2,t.width=i,t}const a=Math.floor(t.width/h);return t.y-=(a-t.height)/2,t.height=a,t}(h,t),i)}(i,{width:h.width-r.left-r.right,height:h.height-r.top-r.bottom}),{width:g,height:u}=function(t,i){if(!t)return i;const h=t.width,e=t.height;if(null!=h&&null!=e)return{width:Math.floor(h),height:Math.floor(e)};if(null==h&&null==e)return i;const a=i.width/i.height;return null==e?{width:Math.floor(h),height:Math.floor(h/a)}:{width:Math.floor(e*a),height:Math.floor(e)}}(i,l),f=p(e),d=b[f];return{format:f,quality:t(null!=a?a:d,0,100),area:l,width:g,height:u,rotation:n,disableDecorations:!!o,ignoreBackground:!(!i||!i.ignoreBackground),ignorePadding:!(!i||!i.ignorePadding)}}(i,h),a=e.area,n=e.width/a.width,o=M(e,h.padding),r=o.left+o.right,l=o.top+o.bottom,g=h.width-r,u=h.height-l,f=Math.floor(g*n+r),d=Math.floor(u*n+l),c=i&&i.layers?i.layers:[],s=e.ignoreBackground,w=e.ignorePadding;return{framebufferWidth:f,framebufferHeight:d,region:{x:Math.floor(a.x*n)+o.left,y:Math.floor(a.y*n)+o.top,width:e.width,height:e.height},format:e.format,quality:e.quality,rotation:e.rotation,pixelRatio:n,layers:c,disableDecorations:e.disableDecorations,ignoreBackground:s,ignorePadding:w}}function e(t,i,h){const{ctx:e,canvas:a}=n(t,h),r=e.getImageData(0,0,t.width,t.height),l=function(t,i){const h=y[i.format],e=i.quality/100;return t.toDataURL(h,e)}(a,i);return o(a),{dataUrl:l,data:r}}function a(t,i){const{ctx:h,canvas:e}=n(t,i),a=h.getImageData(0,0,t.width,t.height);return o(e),a}function n(t,h){const e=(i(r)&&(r=document.createElement("canvas")),r);h.premultipliedAlpha&&function(t){const i=t.data,h=i.length;for(let t=0;t<h;t+=4){const h=i[t+3];if(255!==h&&h>0){const e=255/h;i[t+0]=i[t+0]*e,i[t+1]=i[t+1]*e,i[t+2]=i[t+2]*e}}}(t),e.width=t.width,e.height=t.height;const a=e.getContext("2d");return a.putImageData(t,0,0),h.flipY&&function(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}(a),{ctx:a,canvas:e}}function o(t){t.width=0,t.height=0}let r=null;function l(i,h){const e=p(i),a=b[e];return{format:e,quality:t(null!=h?h:a,0,100)}}function g(t,i){return i/Math.max(t[0],t[1])}function u(t,i,h){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(m)try{return new ImageData(t,i)}catch(t){m=!1}return s(t,i,h)}function f(t,i,h,e){if(!i||!h)throw new Error("Cannot construct image data without dimensions");if(m)try{return new ImageData(t,i,h)}catch(t){m=!1}const a=s(i,h,e);return a.data.set(t,0),a}function d(t,i,h,e=0,a=0,n=t.width-e,o=t.height-a,r=!1){const{data:l}=t,{width:g,height:u,data:f}=i,d=n/g,c=o/u,s=Math.ceil(d/2),w=Math.ceil(c/2),m=t.width;for(let t=0;t<u;t++)for(let i=0;i<g;i++){const n=4*(i+(r?u-t-1:t)*g);let o=0,M=0,p=0,y=0,x=0,b=0;const j=(t+.5)*c;for(let n=Math.floor(t*c);n<(t+1)*c;n++){const t=Math.abs(j-(n+.5))/w,r=(i+.5)*d,g=t*t;for(let t=Math.floor(i*d);t<(i+1)*d;t++){const i=Math.abs(r-(t+.5))/s,u=Math.sqrt(g+i*i);if(u>=1)continue;let f=2*u*u*u-3*u*u+1;const d=4*(e+t+(a+n)*m);b+=f*l[d+3],M+=f,!h&&l[d+3]<255&&(f=f*l[d+3]/255),p+=f*l[d],y+=f*l[d+1],x+=f*l[d+2],o+=f}}f[n]=p/o,f[n+1]=y/o,f[n+2]=x/o,f[n+3]=b/M}return i}function c(t,i,h){if(!i)return t;const{framebufferWidth:e,framebufferHeight:a,pixelRatio:n,region:o}=t,r=M(t,h),l=r.left+r.right,g=r.top+r.bottom,u=e-l,f=a-g,d=Math.min(8,Math.min((2048-l)/u,(2048-g)/f));return d<1.5?t:{...t,framebufferWidth:Math.round(u*d)+l,framebufferHeight:Math.round(f*d)+g,pixelRatio:n*d,resample:{region:{x:Math.round((o.x-r.left)*d)+r.left,y:Math.round((o.y-r.top)*d)+r.top,width:Math.round(o.width*d),height:Math.round(o.height*d)},width:e,height:a}}}function s(t,i,h){return h||(w||(w=document.createElement("canvas"),w.width=1,w.height=1),h=w),h.getContext("2d").createImageData(t,i)}let w=null,m=!0;function M(t,i){return!i||t&&t.ignorePadding?j:i}function p(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return x}}const y={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},x="png",b={png:100,jpg:98,jpeg:98},j={top:0,right:0,bottom:0,left:0};export{a,l as b,u as c,e,g,d as r,c as s,h as t,f as w};
