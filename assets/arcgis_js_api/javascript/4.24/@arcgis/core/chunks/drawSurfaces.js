/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Evented.js";import{HandleOwner as i}from"../core/HandleOwner.js";import{clone as n}from"../core/lang.js";import{e as o,i as s,a as r,f as a,d as l,u as p,g as c}from"./maybe.js";import{ignoreAbortErrors as h}from"../core/promiseUtils.js";import{a as d,c as u}from"./quantityUtils.js";import{watch as m,syncAndInitial as g,initial as v}from"../core/reactiveUtils.js";import{f,b as y}from"./screenUtils.js";import{n as _,a as x}from"./unitUtils.js";import{property as w}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as T}from"../core/accessorSupport/decorators/subclass.js";import{p as b}from"./dehydratedFeatureComparison.js";import{c as O,d as S}from"./elevationInfoUtils.js";import{V}from"./ViewingMode.js";import{c as C,E as M,a as D,C as I}from"./EditGeometryOperations.js";import{c as L}from"./dragEventPipeline.js";import k from"../views/interactive/sketch/SketchLabelOptions.js";import E from"../views/interactive/sketch/SketchTooltipOptions.js";import{S as P}from"./SnappingContext.js";import{e as j,a as $,b as G,c as z,d as H,S as R}from"./euclideanLengthMeasurementUtils.js";import{S as U}from"./SnappingOperation.js";import Z from"../core/Accessor.js";import"./Logger.js";import"../intl.js";import{e as W,g as A,h as F,i as q,j as B,k as N,l as J}from"./quantityFormatUtils.js";import K from"../widgets/Widget.js";import{i as Q}from"./widgetUtils.js";import{m as X}from"./messageBundle.js";import{a as Y}from"./number2.js";import{t as tt}from"./jsxFactory.js";import{h as et,f as it}from"./mathUtils.js";import{e as nt,a as ot,c as st}from"./euclideanAreaMeasurementUtils.js";import"../geometry.js";import{geodesicArea as rt,geodesicLength as at}from"../geometry/geometryEngine.js";import{projectPolygonToWGS84ComparableLonLat as lt,projectVectorToWGS84ComparableLonLat as pt,projectPolylineToWGS84ComparableLonLat as ct}from"../geometry/projection.js";import{isSupported as ht,geodesicAreas as dt,inverseGeodeticSolver as ut,geodesicLengths as mt}from"../geometry/support/geodesicUtils.js";import gt,{l as vt,i as ft,e as yt}from"../geometry/SpatialReference.js";import{m as _t}from"./dehydratedFeatures.js";const xt=["freehand","hybrid","click"],wt="click";class Tt{constructor({grabbableForEvent:t}){this.events=new e,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=t}intersectionDistance(t,e){return 0}attach(){}detach(){}}let bt=class extends Z{constructor(t){super(t)}};t([w()],bt.prototype,"tooltipOptions",void 0),bt=t([T("esri.views.interactive.tooltip.SketchTooltipInfo")],bt);let Ot=class extends bt{constructor(t){super(t),this.type="draw-point"}};t([w()],Ot.prototype,"type",void 0),t([w()],Ot.prototype,"elevation",void 0),Ot=t([T("esri.views.interactive.tooltip.DrawPointTooltipInfo")],Ot);let St=class extends bt{constructor(t){super(t),this.type="draw-polyline"}};t([w()],St.prototype,"type",void 0),t([w()],St.prototype,"elevation",void 0),t([w()],St.prototype,"totalLength",void 0),St=t([T("esri.views.interactive.tooltip.DrawPolylineTooltipInfo")],St);let Vt=class extends bt{constructor(t){super(t),this.type="draw-polygon"}};t([w()],Vt.prototype,"type",void 0),t([w()],Vt.prototype,"elevation",void 0),t([w()],Vt.prototype,"area",void 0),Vt=t([T("esri.views.interactive.tooltip.DrawPolygonTooltipInfo")],Vt);const Ct="esri-tooltip",Mt=`${Ct}-content`;let Dt=class extends K{constructor(){super(...arguments),this._messagesUnits=null,this._messagesTooltip=null}get _units(){const t=_(this.tooltip.view);return{length:t,verticalLength:t,area:t}}_formatScale(t){return Y(t,{style:"percent",maximumFractionDigits:0})}_formatRelativeOrientation(t){return Y(t,{maximumFractionDigits:2,minimumFractionDigits:2,signDisplay:"exceptZero"})}_formatLength(t,e,i){return W(this._messagesUnits,t,o(e,this._units.length),i)}_formatRelativeLength(t){return A(this._messagesUnits,t,this._units.length)}_formatVerticalLength(t){return F(this._messagesUnits,t,this._units.verticalLength)}_formatRelativeVerticalLength(t){return q(this._messagesUnits,t,this._units.verticalLength)}_formatTotalLength(t){return W(this._messagesUnits,t,this._units.length)}_formatArea(t){return B(this._messagesUnits,t,this._units.area)}_formatPercentage(t){return Y(t.value,{style:"percent"})}};t([w()],Dt.prototype,"info",void 0),t([w()],Dt.prototype,"tooltip",void 0),t([w()],Dt.prototype,"_units",null),t([X("esri/core/t9n/Units"),w()],Dt.prototype,"_messagesUnits",void 0),t([X("esri/views/interactive/tooltip/t9n/Tooltip"),w()],Dt.prototype,"_messagesTooltip",void 0),Dt=t([T("esri.views.interactive.tooltip.content.TooltipContent")],Dt);const It=`${Ct}-field`,Lt={base:It,title:`${It}__title`,value:`${It}__value`};let kt=class extends K{render(){return tt("div",{class:Lt.base},tt("div",{class:Lt.title},this.title),tt("div",{class:Lt.value},this.value))}};t([w()],kt.prototype,"title",void 0),t([w()],kt.prototype,"value",void 0),kt=t([T("esri.views.interactive.tooltip.support.TooltipField")],kt);const Et={base:`${Mt} ${Mt}--draw-point`};let Pt=class extends Dt{render(){const{elevation:t}=this.info,e=this._messagesTooltip?.sketch;return tt("div",{class:Et.base},tt(kt,{title:e?.elevation,value:this._formatVerticalLength(t)}))}};Pt=t([T("esri.views.interactive.tooltip.content.TooltipContentDrawPoint")],Pt);const jt={base:`${Mt} ${Mt}--draw-polygon`};let $t=class extends Dt{render(){const{area:t,elevation:e}=this.info,i=this._messagesTooltip?.sketch;return tt("div",{class:jt.base},tt(kt,{title:i?.elevation,value:this._formatVerticalLength(e)}),tt(kt,{title:i?.area,value:this._formatArea(t)}))}};$t=t([T("esri.views.interactive.tooltip.content.TooltipContentDrawPolygon")],$t);const Gt={base:`${Mt} ${Mt}--draw-polyline`};let zt=class extends Dt{render(){const{elevation:t,totalLength:e}=this.info,i=this._messagesTooltip?.sketch;return tt("div",{class:Gt.base},tt(kt,{title:i?.elevation,value:this._formatVerticalLength(t)}),tt(kt,{title:i?.totalLength,value:this._formatLength(e)}))}};zt=t([T("esri.views.interactive.tooltip.content.TooltipContentDrawPolyline")],zt);const Ht={base:`${Mt} ${Mt}--extent-rotate`};let Rt=class extends Dt{render(){const{angle:t}=this.info,e=this._messagesTooltip?.sketch;return tt("div",{class:Ht.base},tt(kt,{title:e?.rotation,value:this._formatRelativeOrientation(t)}))}};Rt=t([T("esri.views.interactive.tooltip.content.TooltipContentExtentRotate")],Rt);const Ut={base:`${Ct}-value-by-value`};let Zt=class extends K{constructor(){super(...arguments),this.divider="Ã—"}render(){return tt("div",{class:Ut.base},tt("span",null,this.left),tt("span",null,this.divider),tt("span",null,this.right))}};t([w()],Zt.prototype,"left",void 0),t([w()],Zt.prototype,"divider",void 0),t([w()],Zt.prototype,"right",void 0),Zt=t([T("esri.views.interactive.tooltip.support.ValueByValue")],Zt);const Wt={base:`${Mt} ${Mt}--extent-scale`};let At=class extends Dt{render(){const{xScale:t,yScale:e,xSize:i,ySize:n}=this.info,o=this._messagesTooltip?.sketch;return tt("div",{class:Wt.base},tt(kt,{title:o?.size,value:tt(Zt,{left:this._formatLength(i),right:this._formatLength(n)})}),tt(kt,{title:o?.scale,value:tt(Zt,{left:this._formatScale(t),right:this._formatScale(e)})}))}};At=t([T("esri.views.interactive.tooltip.content.TooltipContentExtentScale")],At);const Ft={base:`${Mt} ${Mt}--reshape-edge-offset`};let qt=class extends Dt{render(){const{distance:t}=this.info,e=this._messagesTooltip?.sketch;return tt("div",{class:Ft.base},tt(kt,{title:e?.distance,value:this._formatRelativeLength(t)}))}};qt=t([T("esri.views.interactive.tooltip.content.TooltipContentReshapeEdgeOffset")],qt);const Bt={base:`${Mt} ${Mt}--reshape-move-graphic`};let Nt=class extends Dt{render(){const{distance:t}=this.info,e=this._messagesTooltip?.sketch;return tt("div",{class:Bt.base},tt(kt,{title:e?.distance,value:this._formatLength(t)}))}};Nt=t([T("esri.views.interactive.tooltip.content.TooltipContentReshapeMoveGraphic")],Nt);const Jt={base:`${Mt} ${Mt}--transform-absolute`};let Kt=class extends Dt{render(){const{orientation:t,orientationEnabled:e,orientationPrecision:i,rotationType:n,size:o,sizeEnabled:s,sizeUnit:r,sizePrecision:a}=this.info,l=this._messagesTooltip?.sketch;return tt("div",{class:Jt.base},e&&tt(kt,{title:l?.orientation,value:N(t,n,i)}),s&&tt(kt,{title:l?.size,value:this._formatLength(o,r,a)}))}};Kt=t([T("esri.views.interactive.tooltip.content.TooltipContentTransformAbsolute")],Kt);const Qt={base:`${Mt} ${Mt}--transform-rotate`};let Xt=class extends Dt{render(){const{rotation:t,rotationPrecision:e,orientation:i,orientationPrecision:n,rotationType:o}=this.info,s=this._messagesTooltip?.sketch;return tt("div",{class:Qt.base},tt(kt,{title:s?.rotation,value:J(t,o,e)}),tt(kt,{title:s?.orientation,value:N(i,o,n)}))}};Xt=t([T("esri.views.interactive.tooltip.content.TooltipContentTransformRotate")],Xt);const Yt={base:`${Mt} ${Mt}--transform-scale`};let te=class extends Dt{render(){const{scale:t,size:e,sizePrecision:i,sizeUnit:n}=this.info,o=this._messagesTooltip?.sketch;return tt("div",{class:Yt.base},tt(kt,{title:o?.scale,value:this._formatPercentage(t)}),tt(kt,{title:o?.size,value:this._formatLength(e,n,i)}))}};te=t([T("esri.views.interactive.tooltip.content.TooltipContentTransformScale")],te);const ee={base:`${Mt} ${Mt}--translate-vertex`};let ie=class extends Dt{render(){const{area:t,distance:e,elevation:i,totalLength:n}=this.info,o=this._messagesTooltip?.sketch;return tt("div",{class:ee.base},tt(kt,{title:o?.distance,value:this._formatLength(e)}),s(i)&&tt(kt,{title:o?.elevation,value:this._formatVerticalLength(i)}),s(t)&&tt(kt,{title:o?.area,value:this._formatArea(t)}),s(n)&&tt(kt,{title:o?.totalLength,value:this._formatLength(n)}))}};ie=t([T("esri.views.interactive.tooltip.content.TooltipContentTranslateVertex")],ie);const ne={base:`${Mt} ${Mt}--extent-move-z`};let oe=class extends Dt{render(){const{distance:t}=this.info,e=this._messagesTooltip?.sketch;return tt("div",{class:ne.base},tt(kt,{title:e?.distance,value:this._formatRelativeVerticalLength(t)}))}};oe=t([T("esri.views.interactive.tooltip.content.TooltipContentTranslateZ")],oe);const se={base:`${Ct}`};let re=class extends Z{constructor(t){super(t),this.info=null,this._contentContainer=(()=>{const t=document.createElement("div");return t.classList.add(se.base),t})(),this._contentWidget=null}initialize(){const t=this._contentContainer;this.own([m((()=>this.view.overlay?.surface),(e=>{t.remove(),a(e,(e=>e.appendChild(t)))}),g),m((()=>this.info),((e,i)=>{s(this._contentWidget)&&s(e)&&s(i)&&e.type===i.type?this._contentWidget.info=e:(this._contentWidget=l(this._contentWidget),a(function(t,e){if(r(e))return null;const i=document.createElement("div");switch(e.type){case"draw-point":return new Pt({tooltip:t,info:e,container:i});case"draw-polygon":return new $t({tooltip:t,info:e,container:i});case"draw-polyline":return new zt({tooltip:t,info:e,container:i});case"extent-rotate":return new Rt({tooltip:t,info:e,container:i});case"extent-scale":return new At({tooltip:t,info:e,container:i});case"reshape-edge-offset":return new qt({tooltip:t,info:e,container:i});case"transform-absolute":return new Kt({tooltip:t,info:e,container:i});case"transform-rotate":return new Xt({tooltip:t,info:e,container:i});case"transform-scale":return new te({tooltip:t,info:e,container:i});case"translate-graphic":return new Nt({tooltip:t,info:e,container:i});case"translate-vertex":return new ie({tooltip:t,info:e,container:i});case"translate-z":return new oe({tooltip:t,info:e,container:i})}}(this,e),(e=>{this._contentWidget=e,t.appendChild(e.container)})))}),g),m((()=>({container:this._contentContainer,contentWidget:this._contentWidget,screenPoint:this.view.inputManager?.latestPointerLocation})),ae,g)])}destroy(){this._contentWidget=l(this._contentWidget),this._contentContainer.remove()}clear(){this.info=null}get test(){return{contentContainer:this._contentContainer}}};function ae({container:t,contentWidget:e,screenPoint:i}){const{style:n}=t;if(s(i)&&s(e)){n.display="block";const e=Q(t),o=`translate(${Math.round(i.x)+le[0]*(e?-1:1)}px, ${Math.round(i.y)+le[1]}px)`;n.transform=e?`translate(-100%, 0) ${o}`:o}else n.display="none"}t([w({nonNullable:!0})],re.prototype,"view",void 0),t([w()],re.prototype,"info",void 0),t([w()],re.prototype,"_contentContainer",void 0),t([w()],re.prototype,"_contentWidget",void 0),re=t([T("esri.views.interactive.tooltip.Tooltip")],re);const le=[20,20];function pe(t,e,i,n,...o){return vt(t)&&ht(t)?e.apply(void 0,o):ft(t)?i.apply(void 0,o):n.apply(void 0,o)}function ce(t){return d(Math.abs(dt([t],"square-meters")[0]),"square-meters")}function he(t){try{return d(Math.abs(rt(t,"square-meters")),"square-meters")}catch(t){return null}}function de(t){const e=[];return lt(t,e)?d(Math.abs(dt([{type:"polygon",rings:e,spatialReference:gt.WGS84}],"square-meters")[0]),"square-meters"):null}function ue(t,e,i=st()){if(e){const e=function(t){const{spatialReference:e}=t;return pe(e,ce,he,de,t)}(t);return s(e)?e:nt(t,i)}return ot(t,i)}function me(t){const{spatialReference:e}=t;return pe(e,xe,we,Te,t)}function ge(t,e){if(!yt(t.spatialReference,e.spatialReference))return null;const{spatialReference:i}=t;return Oe[0]=t.x,Oe[1]=t.y,Oe[2]=t.hasZ?t.z:0,Se[0]=e.x,Se[1]=e.y,Se[2]=e.hasZ?e.z:0,ve(Oe,Se,i)}function ve(t,e,i){return pe(i,fe,ye,_e,t,e,i)}function fe(t,e,i){return u(ut(be,t,e,i).distance,"meters")}function ye(t,e,i){return u(at(function(t,e,i){return{type:"polyline",spatialReference:i,paths:[[[...t],[...e]]]}}(t,e,i),"meters"),"meters")}function _e(t,e,i){return pt(t,i,Ve)&&pt(e,i,Ce)?u(ut(be,Ve,Ce).distance,"meters"):null}function xe(t){return u(mt([t],"meters")[0],"meters")}function we(t){return u(at(t,"meters"),"meters")}function Te(t){const e=[];if(!ct(t,e))return null;let i=0;for(const t of e){let e=0;for(let i=1;i<t.length;++i)e+=ut(be,t[i-1],t[i]).distance;i+=e}return u(i,"meters")}const be={distance:null},Oe=et(),Se=et(),Ve=et(),Ce=et();function Me(t,e){return ke(z,me,G,e,t)}function De(t,e,i,n){return ke($,ve,j,n,t,e,i)}function Ie(t,e,i){return ke(H,ge,H,i,t,e)}function Le(t,e,i,n){return ke(j,ve,j,n,t,e,i)}function ke(t,e,i,n,...o){if("on-the-ground"===n){const t=e.apply(void 0,o);return s(t)?t:i.apply(void 0,o)}return t.apply(void 0,o)}const Ee=et();let Pe=class extends(e.EventedMixin(i)){constructor(t){super(t),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this._snappingPipeline=new R,this._tooltip=null,this._tooltipContext={calculateElevation:null,calculateTotalLength:null,calculateArea:null},this.isDraped=!0,this.labelOptions=new k,this.tooltipOptions=new E,this.snapToSceneEnabled=null,r(t.elevationInfo)&&(this.elevationInfo={mode:t.hasZ?"absolute-height":"on-the-ground",offset:0})}initialize(){const{geometryType:t,view:e}=this,{spatialReference:i}=e,n="viewingMode"in e.state?e.state.viewingMode:V.Local,o="segment"===t||"multipoint"===t?"polyline":t;this.coordinateHelper=C(this.hasZ,this.hasM,i),this._editGeometryOperations=new M(new D(o,this.coordinateHelper)),this._snappingOperation=new U({view:e}),this.handles.add(m((()=>this.stagedVertex),((t,e)=>{s(this._tooltip)&&(s(e)!==s(t)?this._tooltip.info=this._getTooltipInfo():this._updateTooltipInfo()),r(t)||this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(t)}],operation:"apply",type:"vertex-update"})}),{sync:!0,equals:(t,e)=>c(t,e,b)})),this._activeComponent=new I(i,n),this._editGeometryOperations.data.components.push(this._activeComponent);const p=this.segmentLabels;s(p)&&(p.context={view:e,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.handles.add([m((()=>this.labelOptions.enabled),(t=>{p.visible=t}),g),this.on("cursor-update",(()=>{const t=this.stagedVertex;p.stagedVertex=s(t)?this.coordinateHelper.pointToVector(t):null}))])),this.handles.add(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],(t=>{const e=t.vertices.map((t=>({componentIndex:0,vertexIndex:t.index,coordinates:this.coordinateHelper.vectorToArray(t.pos)}))),i=e.map((t=>t.coordinates));switch(t.type){case"vertex-add":this.emit(t.type,{...t,added:i,vertices:e});break;case"vertex-update":this.emit(t.type,{...t,updated:i,vertices:e});break;case"vertex-remove":this.emit(t.type,{...t,removed:i,vertices:e})}}))),this._manipulator=new Tt({grabbableForEvent:t=>"click"!==this.drawingMode||"touch"===t.pointerType&&this._snappingEnabled&&1===this._pointerDownStates.size}),this.manipulators.add(this._manipulator),this._manipulator.grabbable="point"!==t,this.handles.add([this._createManipulatorDragPipeline(this._manipulator),this._manipulator.events.on("immediate-click",(t=>this._onImmediateClick(t))),this._manipulator.events.on("immediate-double-click",(t=>this._onImmediateDoubleClick(t))),m((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new re({view:e,info:this._getTooltipInfo()}):l(this._tooltip)}),v),this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],(()=>a(this._tooltip,(t=>{t.info=this._getTooltipInfo()}))))])}destroy(){l(this.segmentLabels),l(this._snappingOperation),this._tooltip=l(this._tooltip),this._editGeometryOperations=l(this._editGeometryOperations)}get _snappingEnabled(){return s(this.snappingManager)&&this.snappingManager.options.effectiveEnabled}get _defaultElevation(){return u(this.defaultZ,"meters")}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map((t=>this.coordinateHelper.vectorToArray(t.pos)))}set drawingMode(t){this._set("drawingMode",t??"click")}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return s(this.stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get stagedVertex(){return this._snappingOperation.stagedPoint}set stagedVertex(t){this._snappingOperation.stagedPoint=n(t)}get updating(){return this.updatingHandles.updating}get vertices(){const t=this.committedVertices;return s(this.stagedVertex)&&t.push(this.coordinateHelper.pointToArray(this.stagedVertex)),t}get stagedOrLastVertex(){if(s(this.stagedVertex))return this.stagedVertex;const t=this._activeComponent.getLastVertex();return r(t)?null:this._editGeometryOperations.data.coordinateHelper.vectorToDehydratedPoint(t.pos)}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingOperation.abort(),s(this.stagedVertex)){const{stagedVertex:t}=this;this.stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t))}}complete(t){const e=t&&t.aborted||!1;this._snappingOperation.abort(),s(this.snappingManager)&&this.snappingManager.doneSnapping(),"segment"===this.geometryType||"point"===this.geometryType?this.commitStagedVertex():this.stagedVertex=null;const i="multipoint"===this.geometryType&&0===this.numVertices||"polyline"===this.geometryType&&this.numVertices<2||"polygon"===this.geometryType&&this.numVertices<3;this._createOperationCompleted=!i,(this.isCompleted||e)&&this.emit("complete",{vertices:this.vertices.map(((t,e)=>({componentIndex:0,vertexIndex:e,coordinates:t}))),aborted:e,type:"complete"})}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){s(this.snappingManager)&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(t){const e=this._activeComponent;if("polygon"===this.geometryType&&e.vertices.length>2){if(this._vertexWithinPointerDistance(e.vertices[0].pos,t))return 0;if(this._vertexWithinPointerDistance(e.vertices[e.vertices.length-1].pos,t))return e.vertices.length-1}return null}_createManipulatorDragPipeline(t){switch(p(this.drawingMode)){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return L(t,((t,e,i,n)=>{const o="touch"===n&&this._snappingEnabled;!this.isCompleted&&o&&(e.next(this._screenToMapDragEventStep()).next((t=>("start"===t.action&&(this.stagedVertex=t.mapStart,("segment"===this.geometryType||o&&0===this.numVertices)&&this.commitStagedVertex()),t))).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>o,cancel:i,snappingManager:this.snappingManager,snappingContext:new P({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:n,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next((t=>(o&&(this.stagedVertex=t.mapEnd,"end"===t.action&&this.commitStagedVertex()),t))).next((t=>("end"===t.action&&("segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()),t))),i.next((()=>{o&&s(this.snappingManager)&&this.snappingManager.doneSnapping()})))}))}_createManipulatorDragPipelineFreehand(t){return L(t,((t,e)=>{this.isCompleted||e.next(this._screenToMapDragEventStep()).next((t=>("start"===t.action&&(r(this.stagedVertex)&&(this.stagedVertex=t.mapStart),"segment"===this.geometryType&&this.commitStagedVertex()),t))).next((t=>{switch(t.action){case"start":case"update":this.stagedVertex=t.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":this.complete()}return t}))}))}_createManipulatorDragPipelineHybrid(t){return L(t,((t,e)=>{this.isCompleted||e.next(this._screenToMapDragEventStep()).next((t=>("start"===t.action&&(r(this.stagedVertex)&&(this.stagedVertex=t.mapStart),this.commitStagedVertex()),t))).next((t=>{switch(t.action){case"start":case"update":this.stagedVertex=t.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":"segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()}return t}))}))}_getDrawSurface(){if(r(this.elevationDrawSurface))return this.drawSurface;if(!this.coordinateHelper.hasZ)return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let t=this.defaultZ,e=!1;s(this.elevationInfo)&&"absolute-height"===this.elevationInfo.mode&&(e=!0),s(this.snapToSceneEnabled)&&(e=this.snapToSceneEnabled),s(this.elevationInfo)&&"on-the-ground"===this.elevationInfo.mode&&(e=!1);const i=this._activeComponent.vertices.length;return("segment"===this.geometryType||"polygon"===this.geometryType)&&i>0&&(t=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),e=!1),e?this.drawSurface:(this.elevationDrawSurface.defaultZ=t,this.elevationDrawSurface)}_mapToScreen(t){return this._getDrawSurface().mapToScreen(t)}_onHold(t){this._snappingOperation.abort(),"click"===this.drawingMode&&"touch"===t.pointerType&&this._snappingEnabled&&(this.stagedVertex=t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if("mouse"===t.pointerType&&2===t.button||this._manipulator.dragging)return;const e=this._activeComponent,i=this._closeOnClickVertexIndex(t.screenPoint);if(s(i))return t.stopPropagation(),void this.complete();const n=this._screenToMap(t.screenPoint);if(s(n))switch(this.drawingMode){case"freehand":"point"===this.geometryType&&(s(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),this.complete());break;case"click":case"hybrid":this._snappingOperation.abort(),s(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),("point"===this.geometryType||"segment"===this.geometryType&&2===e.vertices.length||"segment"===this.geometryType&&"hybrid"===this.drawingMode&&1===e.vertices.length)&&this.complete()}t.stopPropagation()}_onImmediateDoubleClick(t){this._manipulator.dragging||"point"===this.geometryType||(this.complete(),t.stopPropagation())}_onPointerMove(t){const e=f(t.x,t.y);if(this._manipulator.dragging||this._pointerDownStates.has(t.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return void this._snappingOperation.abort();t.stopPropagation();const i=this._closeOnClickVertexIndex(e);if(s(i))return this._closeOnVertex(i),void this._snappingOperation.abort();const n=this._screenToMap(e);if(this._manipulator.cursor=s(n)?"crosshair":null,r(n))return void this._snappingOperation.abort();if(r(this.snappingManager))return this.stagedVertex=n,void this._snappingOperation.abort();const o=this.snappingManager,a=new P({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t.pointerType,visualizer:this.snappingVisualizer});this.updatingHandles.addPromise(h(this._snappingOperation.snap(n,o,a)))}_closeOnVertex(t){this.stagedVertex=null;const e={componentIndex:0,vertexIndex:t,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[t].pos)};this.emit("cursor-update",{updated:null,vertices:[e],operation:"apply",type:"vertex-update"})}_screenToMap(t){return this._getDrawSurface().screenToMap(t)}_screenToMapDragEventStep(){let t=null;return e=>{if("start"===e.action&&(t=this._screenToMap(e.screenStart)),r(t))return null;const i=this._screenToMap(e.screenEnd);return s(i)?{...e,mapStart:t,mapEnd:i}:null}}_vertexWithinPointerDistance(t,e){const i=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return!!s(i)&&function(t,e,i){const n=t.x-e.x,o=t.y-e.y;return n*n+o*o<=25}(i,e)}_calculateVertexTooltipElevation(t){const{tooltipOptions:e,view:i}=this;if(r(t)||"2d"===i.type)return this._defaultElevation;const n=this.elevationInfo,o=e.elevation.mode,{spatialReference:s}=t,a=x(s),l=O(i,t,n,{mode:o,offset:0});return u(l*a,"meters")}_getTooltipInfo(){const{tooltipOptions:t,stagedOrLastVertex:e}=this;if(r(e))return null;this._tooltipContext.calculateElevation=t=>this._calculateVertexTooltipElevation(t);const i=this._elevationTooltipDetail(e);switch(this.geometryType){case"point":return new Ot({tooltipOptions:t,elevation:i});case"polyline":return this._tooltipContext.calculateTotalLength=function(t,e){const i=(t=>Me(t,e))(t),n=t.paths[0]?.[t.paths[0]?.length-1]??null,{hasZ:o,spatialReference:s}=t,a=n?it(n[0],n[1],o?n[2]:0):null;return t=>{if(r(t)||r(i)||r(a))return i;Ee[0]=t.x,Ee[1]=t.y,Ee[2]=o?t.z:0;const n=((t,i,n)=>De(t,Ee,n,e))(a,0,s);return r(n)?i:u(i.value+n.value,i.unit)}}(this._editGeometryOperations.data.geometry,this.isDraped?"on-the-ground":"absolute-height"),new St({tooltipOptions:t,elevation:i,totalLength:this._totalLengthTooltipDetail(e)});case"polygon":return this._tooltipContext.calculateArea=function(t,e){const i=st(),n=t=>ue(t,e,i);return e=>{if(r(e)||t.rings.length<1||t.rings[0].length<2)return n(t);const i=t.clone();return i.rings[0].push([e.x,e.y]),n(i)}}(this._editGeometryOperations.data.geometry,this.isDraped),new Vt({tooltipOptions:t,elevation:i,area:this._areaTooltipDetail(e)});default:return null}}_elevationTooltipDetail(t){return{mode:this.elevationInfo.mode,...p(this._tooltipContext.calculateElevation)(t)}}_totalLengthTooltipDetail(t){return{...o(p(this._tooltipContext.calculateTotalLength)(t),u(0,"meters"))}}_areaTooltipDetail(t){return{...o(p(this._tooltipContext.calculateArea)(t),d(0,"square-meters"))}}_updateTooltipInfo(){const t=this._tooltip;if(r(t))return;const{stagedOrLastVertex:e}=this,i=this._elevationTooltipDetail(e);switch(this.geometryType){case"point":t.info.elevation=i;break;case"polyline":{const n=t.info;n.elevation=i,n.totalLength=this._totalLengthTooltipDetail(e);break}case"polygon":{const n=t.info;n.elevation=i,n.area=this._areaTooltipDetail(e);break}}}get test(){return{tooltip:this._tooltip}}};t([w()],Pe.prototype,"_defaultElevation",null),t([w()],Pe.prototype,"defaultZ",void 0),t([w()],Pe.prototype,"isDraped",void 0),t([w({value:"click"})],Pe.prototype,"drawingMode",null),t([w({constructOnly:!0})],Pe.prototype,"elevationDrawSurface",void 0),t([w({constructOnly:!0})],Pe.prototype,"elevationInfo",void 0),t([w({constructOnly:!0,type:k})],Pe.prototype,"labelOptions",void 0),t([w({constructOnly:!0,type:E})],Pe.prototype,"tooltipOptions",void 0),t([w({constructOnly:!0})],Pe.prototype,"geometryType",void 0),t([w({constructOnly:!0})],Pe.prototype,"hasM",void 0),t([w({constructOnly:!0})],Pe.prototype,"hasZ",void 0),t([w({constructOnly:!0})],Pe.prototype,"manipulators",void 0),t([w({constructOnly:!0})],Pe.prototype,"drawSurface",void 0),t([w({constructOnly:!0})],Pe.prototype,"segmentLabels",void 0),t([w({constructOnly:!0})],Pe.prototype,"snappingManager",void 0),t([w({constructOnly:!0})],Pe.prototype,"snappingVisualizer",void 0),t([w()],Pe.prototype,"snapToSceneEnabled",void 0),t([w()],Pe.prototype,"_snappingOperation",void 0),t([w()],Pe.prototype,"stagedVertex",null),t([w()],Pe.prototype,"updating",null),t([w({constructOnly:!0})],Pe.prototype,"view",void 0),Pe=t([T("esri.views.draw.DrawOperation")],Pe);class je{constructor(t,e,i,n=null){this.elevationInfo=t,this.defaultZ=e,this.view=i,this.excludeGraphics=n}screenToMap(t){if(s(this.defaultZ))return this.view.sceneIntersectionHelper.intersectElevationFromScreen(y(t.x,t.y),this.elevationInfo,this.defaultZ,this.excludeGraphics);const e=this.view.sceneIntersectionHelper.intersectElevationFromScreen(y(t.x,t.y),this.elevationInfo,0,this.excludeGraphics);return s(e)&&(e.z=void 0),e}mapToScreen(t){const e=_t(t.x,t.y,O(this.view,t,this.elevationInfo),t.spatialReference);return this.view.toScreen(e)}}class $e{constructor(t,e,i=[]){this.view=t,this.elevationInfo=e,this.exclude=i}screenToMap(t){const e=this.view.toMap(t,{exclude:this.exclude});return s(e)&&(e.z=S(e,this.view,this.elevationInfo)),e}mapToScreen(t){let e=t;return s(this.elevationInfo)&&(e=_t(t.x,t.y,O(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(e)}}class Ge{constructor(t){this.view=t,this.screenToMap=e=>t.toMap(e),this.mapToScreen=e=>t.toScreen(e)}}export{Pe as D,je as E,Ge as M,$e as S,re as T,wt as a,De as b,bt as c,xt as d,Ie as e,ue as f,Me as g,ve as h,Le as i};
