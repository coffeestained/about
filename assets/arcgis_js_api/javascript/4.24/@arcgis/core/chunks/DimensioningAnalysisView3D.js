/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import i from"../core/Collection.js";import{a as s,i as o,p as r,f as n,d as a}from"./maybe.js";import{watch as p,sync as m,syncAndInitial as l,initial as d,on as u}from"../core/reactiveUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{k as j}from"./ensureType.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import{A as y}from"./AnalysisView3D.js";import{d as g,m as f}from"./handleUtils.js";import{s as v}from"./vectorStacks.js";import b from"../Color.js";import"../geometry.js";import{Clonable as w}from"../core/Clonable.js";import{c as S}from"./Cyclical.js";import{cast as _}from"../core/accessorSupport/decorators/cast.js";import C from"../geometry/Extent.js";import M from"../geometry/Point.js";import{HandleOwner as D}from"../core/HandleOwner.js";import V from"../core/Handles.js";import{ignoreAbortErrors as P}from"../core/promiseUtils.js";import{c as U}from"./CameraSpace.glsl.js";import{a as x}from"./screenUtils.js";import{d as T}from"./manipulatorUtils.js";import{S as R}from"./SnappingVisualizer3D.js";import{a as L,h as I}from"./dragEventPipeline3D.js";import{E as O,a as E,c as k}from"./EditGeometryOperations.js";import{c as F,r as A}from"./dragEventPipeline.js";import{n as H}from"./nextTick.js";import{S as z}from"./QueryEngineResult.js";import G from"../views/interactive/snapping/FeatureSnappingLayerSource.js";import{s as B}from"./RightAngleSnappingHint.js";import{$ as N}from"../views/SceneView.js";import{h as W,a8 as q,j as Q,t as Z,k as X,X as J,Z as K,a as Y,n as $}from"./mathUtils.js";import{W as tt}from"./WorkerHandle.js";import{f as et,A as it}from"./sphere.js";import{f as st}from"./elevationInfoUtils.js";import{E as ot,S as rt}from"./SnappingManager.js";import{V as nt}from"./VertexSnappingCandidate.js";import{a as at}from"./viewUtils.js";import{S as pt}from"./SnappingContext.js";import{S as mt,f as lt}from"./euclideanLengthMeasurementUtils.js";import{S as dt}from"./SnappingOperation.js";import{a as ut,S as ct}from"./Intersector.js";import{A as jt}from"./AnalysisToolBase.js";import{d as ht}from"./screenUtils2.js";import{t as yt}from"./quantityUtils.js";import{a as gt}from"./vec4f64.js";import{a as ft}from"./number2.js";import{E as vt,L as bt}from"./Segment.js";import{L as wt}from"./LineVisualElement.js";import{R as St}from"./Material.js";import{c as _t}from"./lineStippleUtils.js";import{c as Ct,r as Mt,a as Dt}from"./analysisViewUtils.js";import"./get.js";import"./utils.js";import"./metadata.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./ArrayPool.js";import"./tracking.js";import"./watch.js";import"../core/scheduling.js";import"../core/Error.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../core/Promise.js";import"./byteSizeEstimations.js";import"./quatf64.js";import"./mat4f64.js";import"./vec2f64.js";import"./colorUtils.js";import"./common.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"./mat4.js";import"./mathUtils2.js";import"./basicInterfaces.js";import"./Util.js";import"./utils4.js";import"./doublePrecisionUtils.js";import"./Octree.js";import"./frustum.js";import"./ray.js";import"./plane.js";import"../geometry/projection.js";import"./unitUtils.js";import"./projectionEllipsoid.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./aaBoundingBox.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../Graphic.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"./Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./VertexAttribute.js";import"./glUtil3D.js";import"./geometryDataUtils.js";import"./triangle.js";import"./lineSegment.js";import"./BufferView.js";import"./vec2.js";import"./enums.js";import"./Texture.js";import"./context-util.js";import"./mat4f32.js";import"./ShaderTechniqueConfiguration.js";import"./VertexElementDescriptor.js";import"./VertexArrayObject.js";import"./RenderSlot.js";import"./InterleavedLayout.js";import"./types.js";import"./compilerUtils.js";import"./mat3.js";import"./ElevationProvider.js";import"./ray2.js";import"./Camera.js";import"./ViewingMode.js";import"./interfaces.js";import"./GeometryUtil.js";import"./vec3f32.js";import"./ColorMaterial.js";import"./OrderIndependentTransparency.js";import"./VertexColor.glsl.js";import"./ExtendedLineVisualElement.js";import"./vec4f32.js";import"./LaserlineVisualElement.js";import"./VisualElement.js";import"./glUtil.js";import"./Float3Uniform.js";import"./Object3DVisualElement.js";import"./lineUtils.js";import"./triangulationUtils.js";import"./earcut.js";import"./deduplicate.js";import"./interfaces2.js";import"./vec2f32.js";import"./FramebufferObject.js";import"./NestedMap.js";import"./Matrix4Uniform.js";import"./MemCache.js";import"./requestImageUtils.js";import"./floatRGBA.js";import"./Scheduler.js";import"./debugFlags.js";import"./PointVisualElement.js";import"./VisualElementResources.js";import"./Texture2.js";import"./ElevationContext.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./HUDMaterial.js";import"./VisualVariables.glsl.js";import"./GLTextureMaterial.js";import"./RightAngleQuadVisualElement.js";import"./Settings2.js";import"./verticalOffsetUtils.js";import"./quat.js";import"./geometry2dUtils.js";import"../views/DOMContainer.js";import"./domUtils.js";import"./projector.js";import"./widgetUtils.js";import"../widgets/Popup.js";import"../intl.js";import"./messages.js";import"./throttle.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../widgets/Feature.js";import"../widgets/Widget.js";import"./uuid.js";import"./jsxWidgetSupport.js";import"../widgets/Attachments.js";import"./unitFormatUtils.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"./messageBundle.js";import"./jsxFactory.js";import"../widgets/Feature/FeatureViewModel.js";import"./languageUtils.js";import"./datetime.js";import"./number.js";import"./DataLayerSource.js";import"./executeQueryJSON.js";import"./utils5.js";import"./query.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./pbfQueryUtils.js";import"./pbf.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./queryZScale.js";import"../rest/support/FeatureSet.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./timeUtils.js";import"../rest/support/StatisticDefinition.js";import"./featureConversionUtils.js";import"../rest/support/RelationshipQuery.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"./LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./sizeVariableUtils.js";import"./visualVariableUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"./DictionaryLoader.js";import"./LRUCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"./heatmapUtils.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils2.js";import"../renderers/support/jsonUtils.js";import"./MultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../geometry/HeightModelInfo.js";import"../layers/Layer.js";import"./FeatureIndex.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../layers/mixins/APIKeyMixin.js";import"./ArcGISService.js";import"./arcgisLayerUrl.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser2.js";import"./_commonjsHelpers.js";import"../layers/mixins/CustomParametersMixin.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"./OperationalLayer.js";import"./commonProperties.js";import"../support/timeUtils.js";import"./ElevationInfo.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"./asyncUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/TimeReference.js";import"./featureReductionUtils.js";import"./FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/AggregateField.js";import"../layers/support/OutStatistic.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"./defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"./fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"./labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./versionUtils.js";import"./styleUtils.js";import"../support/popupUtils.js";import"./Heading.js";import"../widgets/support/widget.js";import"./accessibleHandler.js";import"./vmEvent.js";import"./themeUtils.js";import"./utils13.js";import"./numberUtils.js";import"./utils6.js";import"./ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"../widgets/Spinner/SpinnerViewModel.js";import"./AnchorElementViewModel.js";import"../widgets/Popup/PopupViewModel.js";import"../symbols/support/symbolUtils.js";import"./colorUtils2.js";import"./mat2df32.js";import"./InputManager.js";import"./layerViewUtils.js";import"./actions.js";import"../widgets/support/GoTo.js";import"./drawUtils.js";import"../core/sql/WhereClause.js";import"./utils11.js";import"./generateRendererUtils.js";import"./projectionSupport.js";import"./json.js";import"./utils18.js";import"../Camera.js";import"../Viewpoint.js";import"./GraphicsCollection.js";import"./boundedPlane.js";import"./RenderCoordsHelper.js";import"./spatialReferenceSupport.js";import"./scaleUtils.js";import"./layerUtils.js";import"../views/View.js";import"../Map.js";import"../Basemap.js";import"./loadAll.js";import"./writeUtils.js";import"../Ground.js";import"./CollectionFlattener.js";import"./basemapUtils.js";import"./collectionUtils2.js";import"../support/LayersMixin.js";import"../support/TablesMixin.js";import"../views/BasemapView.js";import"../views/Magnifier.js";import"./ViewEvents.js";import"./IViewEvents.js";import"../views/input/Input.js";import"../views/input/gamepad/GamepadSettings.js";import"../views/input/gamepad/GamepadInputDevice.js";import"../views/navigation/Navigation.js";import"../views/navigation/gamepad/GamepadSettings.js";import"./heightModelInfoUtils.js";import"../views/BreakpointsOwner.js";import"../views/GroundView.js";import"../layers/support/ElevationSampler.js";import"./TerrainConst.js";import"../layers/support/TileInfo.js";import"../layers/support/LOD.js";import"./WebGLRequirements.js";import"./capabilities2.js";import"../views/ViewAnimation.js";import"../views/3d/environment/SunLighting.js";import"../webscene/SunLighting.js";import"../views/3d/environment/VirtualLighting.js";import"../webscene/VirtualLighting.js";import"../webscene/Environment.js";import"../views/3d/environment/SunnyWeather.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"./lightingTypes.js";import"../webscene/background/Background.js";import"../webscene/background/ColorBackground.js";import"./earthUtils.js";import"./ShadowCastVisualizeTechniqueConfiguration.js";import"./ElevationQuery.js";import"./pointUtils.js";import"./vec3.js";import"./objectResourceUtils.js";import"./devEnvironmentUtils.js";import"./DefaultMaterial_COLOR_GAMMA.js";import"./Version.js";import"./callExpressionWithFeature.js";import"./RenderGeometry.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"./screenshotUtils.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"./projection.js";import"./NativeLineMaterial.js";import"./viewpointUtils.js";import"./RenderingContext.js";import"./ProgramCache.js";import"./Program.js";import"./DefaultVertexAttributeLayouts.js";import"./labelFormatUtils.js";import"./FeatureTileDescriptor3D.js";import"./geometryServiceUtils.js";import"./project.js";import"../rest/support/ProjectParameters.js";import"../views/3d/support/SceneViewPerformanceInfo.js";import"../views/3d/support/LayerPerformanceInfo.js";import"./terrainUtils.js";import"./ElevationQueryTileCache.js";import"./LercDecoder.js";import"./VectorTile.js";import"./mat3f32.js";import"./enums3.js";import"./config.js";import"./TiledDisplayObject.js";import"./DisplayObject.js";import"./TileKey.js";import"../views/2d/ViewState.js";import"./mat2df64.js";import"./I3SBinaryReader.js";import"./EdgeProcessingWorker.js";import"./intersectorUtilsConversions.js";import"./hitTestSelectUtils.js";import"../views/ui/DefaultUI.js";import"../views/ui/UI.js";import"../widgets/Attribution.js";import"../widgets/Attribution/AttributionViewModel.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";import"../views/interactive/snapping/SnappingOptions.js";import"./PointSnappingHint.js";import"./dehydratedFeatureComparison.js";import"./measurementUtils2.js";import"./TextOverlayItem.js";let Vt=class extends w{constructor(t){super(t),this.type="length",this.startPoint=null,this.endPoint=null,this.axis="horizontal",this.offset=0,this.heading=0}get extent(){if(s(this.startPoint))return null;const t=C.fromPoint(this.startPoint);return o(this.endPoint)&&t.union(C.fromPoint(this.endPoint)),t}};t([c({type:["length"]})],Vt.prototype,"type",void 0),t([c({type:M})],Vt.prototype,"startPoint",void 0),t([c({type:M})],Vt.prototype,"endPoint",void 0),t([c({type:["horizontal","vertical","direct"],nonNullable:!0})],Vt.prototype,"axis",void 0),t([c({type:Number,nonNullable:!0})],Vt.prototype,"offset",void 0),t([c({type:Number,nonNullable:!0}),_((t=>S.normalize(j(t),0,!0)))],Vt.prototype,"heading",void 0),t([c({readOnly:!0})],Vt.prototype,"extent",null),Vt=t([h("esri.analysis.LengthDimension")],Vt);const Pt=Vt,Ut={main:new b([255,127,0])};class xt{constructor(){this.color=Ut.main,this.opacity=.5,this.radius=5}}class Tt{constructor(){this.fontSize=14}get height(){return 1.5*x(this.fontSize)}get offset(){return this.height+20}}const Rt=new class{constructor(){this.pointManipulators=new xt,this.labels=new Tt}};let Lt=class extends D{constructor(t){super(t),this.availability=0,this._ids=new Set,this.tmpP=W()}destroy(){this.workerHandle.destroy(),this.workerHandle=null}initialize(){this.workerHandle=new It(this.schedule,{fetchAllEdgeLocations:(t,e)=>this._fetchAllEdgeLocations(t,e)})}async fetchCandidates(t,e){const i=t.coordinateHelper.toXYZ(t.point);this.view.renderCoordsHelper.toRenderCoords(i,t.coordinateHelper.spatialReference,i);const s="number"==typeof t.distance?t.distance:t.distance.pixelSize,o=await this.workerHandle.invoke({bounds:et(i[0],i[1],i[2],s),types:t.types},e),r=t.coordinateHelper;return o.candidates.sort(((t,e)=>t.distance-e.distance)),o.candidates.map((t=>this._convertCandidate(r,t)))}async add(t,e){this._ids.add(t.id),await this.workerHandle.invokeMethod("add",t,e)}async remove(t,e){this._ids.delete(t.id),await this.workerHandle.invokeMethod("remove",t,e)}_convertCandidate(t,e){switch(e.type){case"edge":return new ot({coordinateHelper:t,objectId:e.objectId,targetPoint:this._convertRenderCoordinate(t,e.target),edgeStart:this._convertRenderCoordinate(t,e.start),edgeEnd:this._convertRenderCoordinate(t,e.end),elevationInfo:st});case"vertex":return new nt({coordinateHelper:t,objectId:e.objectId,targetPoint:this._convertRenderCoordinate(t,e.target),elevationInfo:st})}}_convertRenderCoordinate(t,e){return this.view.renderCoordsHelper.fromRenderCoords(e,this.tmpP,t.spatialReference),t.fromXYZ(this.tmpP)}async _fetchAllEdgeLocations(t,e){const i=[],s=[];for(const{id:o,uid:r}of t.components)this._ids.has(o)&&i.push((async()=>{const t=await this.fetchEdgeLocations(o,e.signal);return s.push(t.locations.buffer),{id:o,uid:r,objectIds:t.objectIds,locations:t.locations.buffer,origin:t.origin,type:t.type}})());return{result:{components:(await Promise.all(i)).filter((({id:t})=>this._ids.has(t)))},transferList:s}}};t([c({constructOnly:!0})],Lt.prototype,"view",void 0),t([c({constructOnly:!0})],Lt.prototype,"fetchEdgeLocations",void 0),t([c({constructOnly:!0})],Lt.prototype,"schedule",void 0),t([c({readOnly:!0})],Lt.prototype,"availability",void 0),Lt=t([h("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],Lt);class It extends tt{constructor(t,e){super("SceneLayerSnappingSourceWorker","fetchCandidates",{},t,{strategy:"dedicated",client:e})}}let Ot=class extends D{constructor(t){super(t),this.availability=1,this.abortController=new AbortController}get updating(){return this.updatingHandles.updating}get layer(){return this.layerSource.layer}destroy(){this.abortController=r(this.abortController)}initialize(){const t=this.view.resourceController;this.edgeWorker=new N((e=>t.schedule(e))),this.workerHandle=new Lt({view:this.view,schedule:e=>t.schedule(e),fetchEdgeLocations:async(t,e)=>{if(s(this.tracker))throw new Error("tracker-not-initialized");return this.tracker.fetchEdgeLocations(t,this.edgeWorker,e)}}),this.updatingHandles.addPromise(this._setupLayerView()),this.handles.add([g(this.workerHandle),g(this.edgeWorker)])}async fetchCandidates(t,e){return this.workerHandle.fetchCandidates(t,e)}refresh(){}async _setupLayerView(){const t=await this.view.whenLayerView(this.layer);if("scene-layer-graphics-3d"===t.type)return;const e={add:(t,e)=>this.updatingHandles.addPromise(this.workerHandle.add({id:t,bounds:e},this.abortController.signal)),remove:t=>this.updatingHandles.addPromise(this.workerHandle.remove({id:t},this.abortController.signal))};this.tracker=t.trackSnappingSources(e),this.handles.add(this.tracker)}};t([c({constructOnly:!0})],Ot.prototype,"layerSource",void 0),t([c({constructOnly:!0})],Ot.prototype,"view",void 0),t([c({readOnly:!0})],Ot.prototype,"updating",null),t([c({readOnly:!0})],Ot.prototype,"availability",void 0),Ot=t([h("esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource")],Ot);let Et=class extends e{constructor(t){super(t),this.options=null,this._snappingSources=new i}initialize(){this.own([this.view.on("layerview-create",(({layerView:t})=>this._createSource(t))),this.view.on("layerview-destroy",(({layerView:t})=>this._removeSource(t)))]);for(const t of this.view.allLayerViews.items)this._createSource(t)}destroy(){this.options=null,this._snappingSources.drain((t=>t.destroy()))}get updating(){return this._snappingSources.some((t=>t.updating))}get _types(){return z.EDGE|z.VERTEX}async fetchCandidates(t,e,i){const{view:s,options:r}=this,{coordinateHelper:n,elevationInfo:a}=e,p=o(r)?r.distance:1,m=at(t,n,a,s,v.get()),l=p*s.state.camera.computeScreenPixelSizeAt(m),d=this._types,u=this._snappingSources.items.map((e=>e.fetchCandidates({point:t,coordinateHelper:n,distance:l,types:d},i))),c=(await Promise.all(u)).flat();return B(t,c),c}_createSource(t){if("scene-layer-3d"!==t.type)return;const e=new Ot({layerSource:new G({layer:t.layer}),view:this.view});this._snappingSources.push(e)}_removeSource(t){const e=this._snappingSources.findIndex((e=>e.layerSource.layer===t.layer));-1!==e&&this._snappingSources.removeAt(e).destroy()}};t([c({constructOnly:!0})],Et.prototype,"view",void 0),t([c()],Et.prototype,"updating",null),t([c()],Et.prototype,"options",void 0),t([c()],Et.prototype,"_snappingSources",void 0),Et=t([h("esri.views.interactive.snapping.SceneSnappingEngine")],Et);const kt=new Map;function Ft(t){return new rt({view:t,snappingEnginesFactory:(e,i)=>[new Et({view:t,options:i})]})}let At=class extends D{constructor(t){super(t),this.stagedDimension=null,this._dimensionManipulators=new Map,this._dimensionHandles=new V,this._snappingPipeline=new mt,this._snappingManagerResult=function(t){kt.has(t)||kt.set(t,{referenceCount:0,snappingManager:Ft(t)});const e=kt.get(t);e.referenceCount++;const i=f((()=>function(t,e){e.referenceCount--,e.referenceCount>0||H((()=>{0===e.referenceCount&&(e.snappingManager.destroy(),kt.delete(t))}))}(t,e)));return{snappingManager:e.snappingManager,...i}}(t.view),this.own(this._snappingManagerResult)}initialize(){this._snappingOperation=new dt({view:this.view}),this.own([this._dimensionHandles,p((()=>this._snappingOperation.stagedPoint),(t=>{o(this.stagedDimension)&&(this.stagedDimension.endPoint=n(t,(t=>U(t,new M))))}),m)])}destroy(){this._snappingOperation=a(this._snappingOperation)}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get _snappingManager(){return this._snappingManagerResult.snappingManager}addDimension(t,e){if(this._dimensionManipulators.has(t))return;const i=this._createPointManipulator(t,{isStart:!0}),s=this._createPointManipulator(t,{isStart:!1}),o={startManipulator:i,endManipulator:s};this._setupDimensionToManipulatorsSync(t,o),this._dimensionManipulators.set(t,o),e.add(i),e.add(s)}removeDimension(t,e){const i=this._dimensionManipulators.get(t);if(s(i))return;this._dimensionHandles.remove(t);const{startManipulator:o,endManipulator:r}=i;this._dimensionManipulators.delete(t),e.remove(o),e.remove(r)}getManipulatorsForDimension(t){return this._dimensionManipulators.get(t)}onDeactivate(){this._snappingManager.doneSnapping()}onUnstagedClick({mapPoint:t,pointerType:e}){const i=this._snappingContext(e),s=U(this._snappingManager.update(t,i),new M),o=new Pt({startPoint:s,endPoint:null});return this.stagedDimension=o,this._snappingManager.doneSnapping(),o}onStagedClick({mapPoint:t,pointerType:e}){if(s(this.stagedDimension))return;const i=this._snappingContext(e),o=U(this._snappingManager.update(t,i),new M);this.stagedDimension.endPoint=o,this.stagedDimension=null,this._snappingManager.doneSnapping()}onPointerMove({mapPoint:t,pointerType:e}){const i=this._snappingContext(e);this.updatingHandles.addPromise(P(this._snappingOperation.snap(t,this._snappingManager,i)))}_setupDimensionToManipulatorsSync(t,e){const{startManipulator:i,endManipulator:r}=e;this._dimensionHandles.add([p((()=>({startPoint:t.startPoint,endPoint:t.endPoint,stagedDimension:this.stagedDimension})),(({startPoint:e,endPoint:n,stagedDimension:a})=>{o(e)?(i.available=s(a)||a===t,i.location=e):i.available=!1,o(n)?(r.available=s(a),r.location=n):r.available=!1}),l)],t)}_createPointManipulator(t,e){const{isStart:i}=e,s=i?"startPoint":"endPoint",o=T(this.view,b.toUnitRGB(Rt.pointManipulators.color),Rt.pointManipulators.opacity);o.available=!1,o.radius=Rt.pointManipulators.radius;const r=F(o,((e,i,o,r)=>{const n=I(e);i.next(n).next(L(this.view)).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(r),snappingManager:this._snappingManager,cancel:o,updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next((e=>{const i=U(e.mapEnd,new M);t[s]=i})),o.next(n).next(A(t,[s]))}));return this._dimensionHandles.add(r,t),o}_snappingContext(t){return new pt({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new O(new E("point",k(!0,!1,this.view.spatialReference))),visualizer:new R})}};var Ht;t([c({constructOnly:!0,nonNullable:!0})],At.prototype,"view",void 0),t([c({readOnly:!0})],At.prototype,"updating",null),t([c()],At.prototype,"stagedDimension",void 0),At=t([h("esri.views.3d.analysis.Dimensioning.LengthDimensionSubTool")],At),function(t){t.Ready="ready",t.Creating="creating",t.Created="created"}(Ht||(Ht={}));let zt=class extends jt{constructor(t){super(t),this.preferManipulatorCursor=!0,this.analysisViewData=null}initialize(){this._intersector=ut(this.view.state.viewingMode),this._intersector.options.store=ct.MIN,this._lengthDimensionSubTool=new At({view:this.view}),this.own(g(this._lengthDimensionSubTool));for(const t of this.analysis.dimensions.items)this._addDimension(t);this.own(this.analysis.dimensions.on("change",(t=>{for(const e of t.added)this._addDimension(e);for(const e of t.removed)this._removeDimension(e)}))),this.own(p((()=>this.state),(t=>{t===Ht.Created&&this.finishToolCreation()}),l))}get state(){return this.analysis.dimensions.some((t=>"length"===t.type))?o(this._activeSubTool)?Ht.Creating:Ht.Created:Ht.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}getManipulatorsForDimension(t){return this._lengthDimensionSubTool.getManipulatorsForDimension(t)}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){o(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),o(this._activeSubTool.stagedDimension)&&(this.analysis.dimensions.remove(this._activeSubTool.stagedDimension),this._activeSubTool.stagedDimension=null),this._activeSubTool=null)}_clickHandler(t){if(s(this._activeSubTool))return;const e=this._intersectScreen(t);if(!s(e)){if(s(this._activeSubTool.stagedDimension)){const i=this._activeSubTool.onUnstagedClick({mapPoint:e,pointerType:t.pointerType});this.analysis.dimensions.add(i)}else this._activeSubTool.onStagedClick({mapPoint:e,pointerType:t.pointerType});t.stopPropagation()}}_doubleClickHandler(t){this.view.activeTool=null,t.stopPropagation()}_pointerMoveHandler(t){if(s(this._activeSubTool))return;if(this.hasFocusedManipulators)return;const e=this._intersectScreen(t);s(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_intersectScreen(t){const e=ht(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,s=v.get();return i.getIntersectionPoint(s)?this.view.renderCoordsHelper.fromRenderCoords(s,this.view.spatialReference):null}_addDimension(t){this._lengthDimensionSubTool.addDimension(t,this.manipulators)}_removeDimension(t){this._lengthDimensionSubTool.removeDimension(t,this.manipulators)}};t([c({constructOnly:!0})],zt.prototype,"view",void 0),t([c({constructOnly:!0})],zt.prototype,"analysis",void 0),t([c({readOnly:!0})],zt.prototype,"state",null),t([c({readOnly:!0})],zt.prototype,"updating",null),t([c({readOnly:!0})],zt.prototype,"cursor",null),t([c({readOnly:!0})],zt.prototype,"preferManipulatorCursor",void 0),t([c({constructOnly:!0})],zt.prototype,"analysisViewData",void 0),t([c()],zt.prototype,"_activeSubTool",void 0),t([c()],zt.prototype,"_lengthDimensionSubTool",void 0),zt=t([h("esri.views.3d.analysis.Dimensioning.DimensioningTool")],zt);let Gt=class extends e{constructor(t){super(t),this._directSegment=new vt,this._dimensionSegment=new vt,this._offsetAxis=W(),this._startOffsetSegment=new vt(this._directSegment.startRenderSpace,this._dimensionSegment.startRenderSpace),this._endOffsetSegment=new vt(this._directSegment.endRenderSpace,this._dimensionSegment.endRenderSpace),this._labelSegment=new vt,this._hasValidGeometry=!1;const e={view:t.view,attached:!0,width:1,color:gt(1,.5,0,1),renderOccluded:St.OccludeAndTransparent},i={...e,stipplePattern:_t(5)};this._dimensionVisualElement=new wt(e),this._startOffsetVisualElement=new wt(i),this._endOffsetVisualElement=new wt(i),this._label=new bt({view:t.view,attached:!0,distance:0,fontSize:Rt.labels.fontSize})}initialize(){this.own([g(this._dimensionVisualElement),g(this._startOffsetVisualElement),g(this._endOffsetVisualElement),g(this._label)]);const{computation:t,view:e}=this,{dimension:i}=t;this.own([p((()=>({startPoint:i.startPoint,endPoint:i.endPoint,offset:i.offset,axis:i.axis,heading:i.heading})),(t=>{this._updateGeometry(t),this._updateLines(),this._updateLabelGeometry(e.state.camera)}),d),p((()=>t.length),(t=>this._updateLabelContent(t)),d),p((()=>e.state.camera),(t=>this._updateLabelGeometry(t)),d)])}get testInfo(){return{dimensionVisualElement:this._dimensionVisualElement,label:this._label}}_updateGeometry({startPoint:t,endPoint:e,offset:i,axis:o}){const{renderCoordsHelper:r}=this.view,n=this._directSegment;if(s(t)||s(e)||!r.toRenderCoords(t,n.startRenderSpace)||!r.toRenderCoords(e,n.endRenderSpace))return void(this._hasValidGeometry=!1);const{startRenderSpace:a,endRenderSpace:p}=n,m=n.eval(.5,v.get()),l=r.worldUpAtPosition(m,v.get()),d=r.worldBasisAtPosition(m,it.X,v.get()),u=this._offsetAxis;!function(t,e,i,s,o,r){switch(o){case"horizontal":return Y(t,s);case"vertical":return Q(e,s)<Q(i,s)?Z(t,i,e):Z(t,e,i),X(t,t,s),J(t,K)?Y(t,r):(X(t,t,s),$(t,t),t);case"direct":Q(e,r)>Q(i,r)?Z(t,i,e):Z(t,e,i),X(t,t,s),J(t,K)?Y(t,r):$(t,t)}}(u,a,p,l,o,d);const c=i/r.unitInMeters,[j,h]=function(t,e,i,s=0){const o=Q(e,i),r=Q(t,i),n=Math.abs(o-r)+s;return o>r?[n,s]:[s,n]}(a,p,u,c),y=this._dimensionSegment;q(y.startRenderSpace,n.startRenderSpace,u,j),q(y.endRenderSpace,n.endRenderSpace,u,h),this._hasValidGeometry=!0}_updateLines(){if(!this._hasValidGeometry)return this._dimensionVisualElement.visible=!1,this._startOffsetVisualElement.visible=!1,void(this._endOffsetVisualElement.visible=!1);this._dimensionVisualElement.setGeometryFromSegment(this._dimensionSegment),this._startOffsetVisualElement.setGeometryFromSegment(this._startOffsetSegment),this._endOffsetVisualElement.setGeometryFromSegment(this._endOffsetSegment),this._dimensionVisualElement.visible=!0,this._startOffsetVisualElement.visible=!0,this._endOffsetVisualElement.visible=!0}_updateLabelContent(t){if(s(t)||!this._hasValidGeometry)return this._label.text="",void(this._label.visible=!1);const{value:e}=yt(t,"meters");this._label.text=`${ft(e,{minimumFractionDigits:2,maximumFractionDigits:2})} m`,this._label.visible=!0}_updateLabelGeometry(t){if(!this._hasValidGeometry)return void(this._label.visible=!1);const{offset:e}=this.computation.dimension,i=t.computeRenderPixelSizeAt(this._dimensionSegment.eval(.5,v.get())),s=(Math.sign(e)>=0?1:-1)*Rt.labels.offset*i;!function(t,e,i,s){q(t.startRenderSpace,e.startRenderSpace,i,s),q(t.endRenderSpace,e.endRenderSpace,i,s)}(this._labelSegment,this._dimensionSegment,this._offsetAxis,s),this._label.geometry={type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1}}};t([c({constructOnly:!0,nonNullable:!0})],Gt.prototype,"computation",void 0),t([c({constructOnly:!0,nonNullable:!0})],Gt.prototype,"view",void 0),Gt=t([h("esri.views.3d.analysis.Dimensioning.LengthDimensionVisualization")],Gt);let Bt=class extends e{constructor(t){super(t),this._dimensionVisualizations=new Map}initialize(){for(const t of this.computations)this._addComputation(t);this.own(this.computations.on("change",(({added:t,removed:e})=>{for(const t of e)this._removeComputation(t);for(const e of t)this._addComputation(e)})))}destroy(){this._dimensionVisualizations.forEach((t=>{t.destroy()})),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values())}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new Gt({computation:t,view:this.view}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);s(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}};t([c({constructOnly:!0,nonNullable:!0})],Bt.prototype,"view",void 0),t([c({constructOnly:!0,nonNullable:!0})],Bt.prototype,"computations",void 0),Bt=t([h("esri.views.3d.analysis.Dimensioning.DimensioningVisualization")],Bt);let Nt=class extends e{constructor(t){super(t),this.dimension=null}};t([c({constructOnly:!0,nonNullable:!0})],Nt.prototype,"dimension",void 0),Nt=t([h("esri.views.3d.analysis.LengthDimensionResult")],Nt);const Wt=Nt;let qt=class extends e{constructor(t){super(t)}initialize(){this._set("result",new Wt({dimension:this.dimension}))}get length(){const{startPoint:t,endPoint:e,axis:i}=this.dimension;if(s(t)||s(e))return null;const o=lt(t,e);return s(o)?null:o[i]}};t([c({constructOnly:!0,nonNullable:!0})],qt.prototype,"dimension",void 0),t([c({constructOnly:!0,nonNullable:!0})],qt.prototype,"result",void 0),t([c()],qt.prototype,"length",null),qt=t([h("esri.views.3d.analysis.LengthDimensionComputation")],qt);let Qt=class extends(y(e)){constructor(t){super(t),this.type="dimensioning-view-3d",this.tool=null,this._computations=new i,this._dimensionsToResults=new Map,this._placementTask=null}initialize(){this.own([Ct(this,zt),u((()=>this.analysis.dimensions),"change",(({added:t,removed:e})=>{for(const t of e)this._removeDimension(t);for(const e of t)this._addDimension(e)}),{onListenerAdd:t=>{for(const e of t)this._addDimension(e)},onListenerRemove:t=>{for(const e of t)this._removeDimension(e)}})]),this._analysisVisualization=new Bt({view:this.view,computations:this._computations})}destroy(){this._placementTask=r(this._placementTask),this._analysisVisualization=a(this._analysisVisualization),this._computations.drain((t=>t.destroy())),Mt(this)}get results(){return this.analysis.dimensions.map((t=>this._dimensionsToResults.get(t)))}get testInfo(){return{visualization:this._analysisVisualization}}async createLengthDimensions(t){return this._placementTask=r(this._placementTask),this._placementTask=Dt(this,zt,t),this._placementTask.promise}_addDimension(t){const e=this._dimensionsToResults;if(e.has(t))return;const i=this._computations,s=new qt({dimension:t});i.add(s),e.set(t,s.result)}_removeDimension(t){const e=this._computations,i=this._dimensionsToResults,s=e.findIndex((e=>e.dimension===t)),o=e.removeAt(s);i.delete(t),a(o)}};t([c({readOnly:!0})],Qt.prototype,"type",void 0),t([c({constructOnly:!0,nonNullable:!0})],Qt.prototype,"analysis",void 0),t([c()],Qt.prototype,"tool",void 0),t([c({readOnly:!0})],Qt.prototype,"results",null),t([c()],Qt.prototype,"_analysisVisualization",void 0),t([c()],Qt.prototype,"_computations",void 0),t([c()],Qt.prototype,"_dimensionsToResults",void 0),t([c()],Qt.prototype,"_placementTask",void 0),Qt=t([h("esri.views.3d.analysis.DimensioningAnalysisView3D")],Qt);const Zt=Qt;export{Zt as default};
