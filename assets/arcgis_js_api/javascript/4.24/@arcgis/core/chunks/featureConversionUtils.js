/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{L as t}from"./Logger.js";import{a as n,i as o}from"./maybe.js";import{isPoint as r,isPolygon as s,isPolyline as c,isMultipoint as u}from"../geometry/support/jsonUtils.js";import{O as l,a as i}from"./OptimizedGeometry.js";import{O as a}from"./OptimizedFeatureSet.js";function f(e,t){return e?t?4:3:t?3:2}const h=t.getLogger("esri.layers.graphics.featureConversionUtils"),g={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},d=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s},m=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+2]},y=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+3]},p=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+2],e[n+3]=t[o+3]};function b(e,t,n,o){if(e){if(n)return t&&o?p:m;if(t&&o)return y}else if(t&&o)return m;return d}function w({scale:e,translate:t},n){return Math.round((n-t[0])/e[0])}function I({scale:e,translate:t},n){return Math.round((t[1]-n)/e[1])}function G({scale:e,translate:t},n){return n*e[0]+t[0]}function M({scale:e,translate:t},n){return t[1]-n*e[1]}function T(e,t,n){return e?t?n?x(e):P(e):n?j(e):N(e):null}function N(e){const t=e.coords;return{x:t[0],y:t[1]}}function F(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function P(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function Z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function j(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function k(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function x(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function v(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function z(e,t){return e&&t?v:e?Z:t?k:F}function E(e,t,n,o,r){const s=z(n,o);for(const n of t){const{geometry:t,attributes:o}=n;let c;t&&(c=s(new l,t)),e.push(new i(c,o,null,o[r]))}return e}function L(e,t,n=z(null!=t.z,null!=t.m)){return n(e,t)}function U(e,t,o){if(n(e))return null;const r=f(t,o),s=[];for(let t=0;t<e.coords.length;t+=r){const n=[];for(let o=0;o<r;o++)n.push(e.coords[t+o]);s.push(n)}return t?o?{points:s,hasZ:t,hasM:o}:{points:s,hasZ:t}:o?{points:s,hasM:o}:{points:s}}function q(e,t,n,o,r){const s=f(n,o);for(const n of t){const t=n.geometry,o=n.attributes;let c;t&&(c=O(new l,t,s)),e.push(new i(c,o,null,o[r]))}return e}function O(e,t,n=f(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const o=e.coords;let r=0;for(const e of t.points)for(let t=0;t<n;t++)o[r++]=e[t];return e}function S(e,t,n){if(!e)return null;const o=f(t,n),{coords:r,lengths:s}=e,c=[];let u=0;for(const e of s){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<o;t++)e.push(r[u++]);t.push(e)}c.push(t)}return t?n?{paths:c,hasZ:t,hasM:n}:{paths:c,hasZ:t}:n?{paths:c,hasM:n}:{paths:c}}function A(e,t,n,o,r){const s=f(n,o);for(const n of t){const t=n.geometry,o=n.attributes;let c;t&&(c=$(new l,t,s)),e.push(new i(c,o,null,o[r]))}return e}function $(e,t,n=f(t.hasZ,t.hasM)){const{lengths:o,coords:r}=e;let s=0;for(const e of t.paths){for(const t of e)for(let e=0;e<n;e++)r[s++]=t[e];o.push(e.length)}return e}function R(e,t,n){if(!e)return null;const o=f(t,n),{coords:r,lengths:s}=e,c=[];let u=0;for(const e of s){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<o;t++)e.push(r[u++]);t.push(e)}c.push(t)}return t?n?{rings:c,hasZ:t,hasM:n}:{rings:c,hasZ:t}:n?{rings:c,hasM:n}:{rings:c}}function V(e,t,n,r,s){for(const c of t){const t=c.geometry,u=c.centroid,a=c.attributes;let f;t&&(f=Y(new l,t,n,r)),o(u)?e.push(new i(f,a,F(new l,u),a[s])):e.push(new i(f,a,null,a[s]))}return e}function Y(e,t,n=t.hasZ,o=t.hasM){return _(e,t.rings,n,o),e}function _(e,t,n,o){const r=f(n,o),{lengths:s,coords:c}=e;let u=0;s.length=c.length=0;for(const e of t){for(const t of e)for(let e=0;e<r;e++)c[u++]=t[e];s.push(e.length)}return e}const C=[],B=[];function D(e,t,n,o,r){C[0]=e;const[s]=H(B,C,t,n,o,r);return C.length=B.length=0,s}function H(t,n,o,r,s,c){if(t.length=0,!o){for(const e of n){const n=e.attributes[c];t.push(new i(null,e.attributes,null,n))}return t}switch(o){case"esriGeometryPoint":return E(t,n,r,s,c);case"esriGeometryMultipoint":return q(t,n,r,s,c);case"esriGeometryPolyline":return A(t,n,r,s,c);case"esriGeometryPolygon":return V(t,n,r,s,c);default:h.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${o}'`)),t.length=0}return t}function J(t,n,o,r,s,c){const u=t.length;switch(o){case"esriGeometryPoint":E(t,n,r,s,c);break;case"esriGeometryMultipoint":q(t,n,r,s,c);break;case"esriGeometryPolyline":A(t,n,r,s,c);break;case"esriGeometryPolygon":V(t,n,r,s,c);break;default:h.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${o}'`))}for(let e=0;e<n.length;e++)t[e+u].geometryType=o,t[e+u].insertAfter=n[e].insertAfter,t[e+u].groupId=n[e].groupId;return t}function K(e,t,n,o){B[0]=e,X(C,B,t,n,o);const r=C[0];return C.length=B.length=0,r}function Q(t,o,i){if(n(t))return null;const a=new l;return"hasZ"in t&&null==o&&(o=t.hasZ),"hasM"in t&&null==i&&(i=t.hasM),r(t)?z(null!=o?o:null!=t.z,null!=i?i:null!=t.m)(a,t):s(t)?Y(a,t,o,i):c(t)?$(a,t,f(o,i)):u(t)?O(a,t,f(o,i)):void h.error("convertFromGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${t}'`))}function W(t,o,r,s){const c=t&&("coords"in t?t:t.geometry);if(n(c))return null;switch(o){case"esriGeometryPoint":{let e=N;return r&&s?e=x:r?e=P:s&&(e=j),e(c)}case"esriGeometryMultipoint":return U(c,r,s);case"esriGeometryPolyline":return S(c,r,s);case"esriGeometryPolygon":return R(c,r,s);default:return void h.error("convertToGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${o}'`))}}function X(t,r,s,c,u){if(t.length=0,n(s))return function(e,t){for(const n of t)e.push({attributes:n.attributes});return e}(t,r);switch(s){case"esriGeometryPoint":return function(e,t,n,r){let s=N;n&&r?s=x:n?s=P:r&&(s=j);for(const n of t){const{geometry:t,attributes:r}=n,c=o(t)?s(t):null;e.push({attributes:r,geometry:c})}return e}(t,r,c,u);case"esriGeometryMultipoint":return function(e,t,n,o){for(const r of t){const{geometry:t,attributes:s}=r;let c;t&&(c=U(t,n,o)),e.push({attributes:s,geometry:c})}return e}(t,r,c,u);case"esriGeometryPolyline":return function(e,t,n,r){for(const s of t){const{geometry:t,attributes:c}=s;let u;o(t)&&(u=S(t,n,r)),e.push({attributes:c,geometry:u})}return e}(t,r,c,u);case"esriGeometryPolygon":return function(e,t,n,r){for(const s of t){const{geometry:t,attributes:c,centroid:u}=s;let l;if(o(t)&&(l=R(t,n,r)),o(u)){const t=N(u);e.push({attributes:c,centroid:t,geometry:l})}else e.push({attributes:c,geometry:l})}return e}(t,r,c,u);default:h.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${s}'`))}return t}function ee(e){const{objectIdFieldName:t,spatialReference:n,transform:o,fields:r,hasM:s,hasZ:c,features:u,geometryType:l,exceededTransferLimit:i,uniqueIdField:a,queryGeometry:f,queryGeometryType:h}=e,g={features:X([],u,l,c,s),fields:r,geometryType:l,objectIdFieldName:t,spatialReference:n,uniqueIdField:a,queryGeometry:W(f,h,!1,!1)};return o&&(g.transform=o),i&&(g.exceededTransferLimit=i),s&&(g.hasM=s),c&&(g.hasZ=c),g}function te(t,n){const o=new a,{hasM:r,hasZ:s,features:c,objectIdFieldName:u,spatialReference:l,geometryType:i,exceededTransferLimit:f,transform:g,fields:d}=t;return d&&(o.fields=d),o.geometryType=i,o.objectIdFieldName=u||n,o.spatialReference=l,o.objectIdFieldName?(c&&H(o.features,c,i,s,r,o.objectIdFieldName),f&&(o.exceededTransferLimit=f),r&&(o.hasM=r),s&&(o.hasZ=s),g&&(o.transform=g),o):(h.error(new e("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),o)}function ne(e){const{transform:t,features:n,hasM:r,hasZ:s}=e;if(!t)return e;for(const e of n)o(e.geometry)&&ie(e.geometry,e.geometry,r,s,t),o(e.centroid)&&ie(e.centroid,e.centroid,r,s,t);return e.transform=null,e}function oe(e,t){const{geometryType:n,features:o,hasM:r,hasZ:s}=t;if(!e)return t;for(let t=0;t<o.length;t++){const c=o[t],u=c.weakClone();u.geometry=new l,re(u.geometry,c.geometry,r,s,n,e),c.centroid&&(u.centroid=new l,re(u.centroid,c.centroid,r,s,"esriGeometryPoint",e)),o[t]=u}return t.transform=e,t}function re(e,t,o,r,s,c,u=o,l=r){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),n(t)||!t.coords.length)return null;const i=g[s],{coords:a,lengths:h}=t,d=f(o,r),m=f(o&&u,r&&l),y=b(o,r,u,l);if(!h.length)return y(e.coords,a,0,0,w(c,a[0]),I(c,a[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=d,e;let p,G,M,T,N=0,F=0,P=F;for(const t of h){if(t<i)continue;let n=0;F=P,M=p=w(c,a[N]),T=G=I(c,a[N+1]),y(e.coords,a,F,N,M,T),n++,N+=d,F+=m;for(let o=1;o<t;o++,N+=d)M=w(c,a[N]),T=I(c,a[N+1]),M===p&&T===G||(y(e.coords,a,F,N,M-p,T-G),F+=m,n++,p=M,G=T);n>=i&&(e.lengths.push(n),P=F)}return e.coords.length=P,e.coords.length?e:null}function se(e,t,n,o,r,s,c=n,u=o){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const l=g[r],{coords:i,lengths:a}=t,h=f(n,o),d=f(n&&c,o&&u),m=b(n,o,c,u);if(!a.length)return m(e.coords,i,0,0,i[0],i[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=h,e;let y=0;const p=s*s;for(const t of a){if(t<l){y+=t*h;continue}const n=e.coords.length/d,o=y,r=y+(t-1)*h;m(e.coords,i,e.coords.length,o,i[o],i[o+1]),ue(e.coords,i,h,p,m,o,r),m(e.coords,i,e.coords.length,r,i[r],i[r+1]);const s=e.coords.length/d-n;s>=l?e.lengths.push(s):e.coords.length=n*d,y+=t*h}return e.coords.length?e:null}function ce(e,t,n,o){const r=e[t],s=e[t+1],c=e[n],u=e[n+1],l=e[o],i=e[o+1];let a=c,f=u,h=l-a,g=i-f;if(0!==h||0!==g){const e=((r-a)*h+(s-f)*g)/(h*h+g*g);e>1?(a=l,f=i):e>0&&(a+=h*e,f+=g*e)}return h=r-a,g=s-f,h*h+g*g}function ue(e,t,n,o,r,s,c){let u,l=o,i=0;for(let e=s+n;e<c;e+=n)u=ce(t,e,s,c),u>l&&(i=e,l=u);l>o&&(i-s>n&&ue(e,t,n,o,r,s,i),r(e,t,e.length,i,t[i],t[i+1]),c-i>n&&ue(e,t,n,o,r,i,c))}function le(e,t,o,r){if(n(t)||!t.coords||!t.coords.length)return null;const s=f(o,r);let c=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=s){const n=e[t],o=e[t+1];c=Math.min(c,n),l=Math.max(l,n),u=Math.min(u,o),i=Math.max(i,o)}}return e[0]=c,e[1]=u,e[2]=l,e[3]=i,e}function ie(e,t,n,o,r){const{coords:s,lengths:c}=t,u=n?o?p:m:o?m:d,l=f(n,o);if(!s.length)return e!==t&&(e.lengths.length=0,e.coords.length=0),e;if(!c.length)return u(e.coords,s,0,0,G(r,s[0]),M(r,s[1])),e!==t&&(e.lengths.length=0,e.coords.length=l),e;const[i,a]=r.scale;let h=0;for(let t=0;t<c.length;t++){const n=c[t];e.lengths[t]=n;let o=G(r,s[h]),f=M(r,s[h+1]);u(e.coords,s,h,h,o,f),h+=l;for(let t=1;t<n;t++,h+=l)o+=s[h]*i,f-=s[h+1]*a,u(e.coords,s,h,h,o,f)}return e!==t&&(e.lengths.length=c.length,e.coords.length=s.length),e}function ae(e,t,n,o,r,s){const c=f(n,o),u=b(n,o,r,s),l=t.coords;e.coords.length=0,e.lengths.length=0,e.lengths.push(...t.lengths);for(let t=0;t<l.length;t+=c)u(e.coords,l,e.coords.length,t,l[t],l[t+1]);return e}function fe(e,t,n,o){let r=0,s=e[o*t],c=e[o*(t+1)];for(let u=1;u<n;u++){const n=s+e[o*(t+u)],l=c+e[o*(t+u)+1],i=(n-s)*(l+c);s=n,c=l,r+=i}return.5*r}function he(e,t){const{coords:n,lengths:o}=e;let r=0,s=0;for(let e=0;e<o.length;e++)s+=fe(n,r,o[e],t),r+=e;return Math.abs(s)}function ge(e,t){if(n(e))return null;const o=e.clone(),r=e.coords,s=e.lengths;let c=0;for(let e=0;e<s.length;e++){const n=s[e];let u=r[t*c],l=r[t*c+1];for(let e=1;e<n;e++){const n=u+r[t*(c+e)],s=l+r[t*(c+e)+1];o.coords[t*(c+e)]=n,o.coords[t*(c+e)+1]=s,u=n,l=s}c+=n}return o}export{L as A,ee as a,Q as b,W as c,_ as d,Y as e,T as f,se as g,S as h,R as i,U as j,le as k,ne as l,te as m,H as n,K as o,D as p,re as q,ae as r,oe as s,w as t,ie as u,I as v,he as w,J as x,$ as y,ge as z};
