/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{c as t,g as r,b as i,d as n}from"../geometry/Extent.js";import{isPolygon as s,isExtent as o,getJsonType as l}from"../geometry/support/jsonUtils.js";import{j as u}from"../geometry/SpatialReference.js";import{e as a}from"./featureConversionUtils.js";import{O as p}from"./OptimizedGeometry.js";import{c}from"./projectionSupport.js";import{g as f}from"./utils18.js";function m(e,t){return e?t?4:3:t?3:2}function y(e,t,r,i,n){if(!e)return!1;const s=m(t,r),{coords:o,lengths:l}=e;let u=!1,a=0;for(const e of l)u=R(u,o,s,a,e,i,n),a+=e*s;return u}function R(e,t,r,i,n,s,o){let l=e,u=i;for(let e=i,a=i+n*r;e<a;e+=r){u=e+r,u===a&&(u=i);const n=t[e],p=t[e+1],c=t[u],f=t[u+1];(p<o&&f>=o||f<o&&p>=o)&&n+(o-p)/(f-p)*(c-n)<s&&(l=!l)}return l}const S={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},g={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},d={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},h={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function I(e,l,u,c,R){if(s(l)&&"esriGeometryPoint"===u&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=a(new p,l,!1,!1);return Promise.resolve((t=>function(e,t,r,i){return y(e,!1,!1,i.coords[0],i.coords[1])}(e,0,0,t)))}if(s(l)&&"esriGeometryMultipoint"===u){const t=a(new p,l,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>function(e,t,r,i,n,s){const o=m(n,s),{coords:l,lengths:u}=i;if(!u)return!1;for(let t=0,r=0;t<u.length;t++,r+=o)if(!y(e,!1,!1,l[r],l[r+1]))return!1;return!0}(t,0,0,e,c,R)))}if(o(l)&&"esriGeometryPoint"===u&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>i(l,f(u,c,R,e))));if(o(l)&&"esriGeometryMultipoint"===u&&"esriSpatialRelContains"===e)return Promise.resolve((e=>n(l,f(u,c,R,e))));if(o(l)&&"esriSpatialRelIntersects"===e){const e=function(e){return"mesh"===e?t:r(e)}(u);return Promise.resolve((t=>e(l,f(u,c,R,t))))}return import("./geometryEngineJSON.js").then((e=>e.g)).then((t=>{const r=t[S[e]].bind(null,l.spatialReference,l);return e=>r(f(u,c,R,e))}))}async function v(t,r,i){const{spatialRel:n,geometry:s}=t;if(s){if(!0!==g[n])throw new e("feature-store:unsupported-query","Unsupported query spatial relationship",{query:t});if(u(s.spatialReference)&&u(i)){if(!function(e){return!0===d[l(e)]}(s))throw new e("feature-store:unsupported-query","Unsupported query geometry type",{query:t});if(!function(e){return!0===h[e]}(r))throw new e("feature-store:unsupported-query","Unsupported layer geometry type",{query:t});if(t.outSR)return c(t.geometry&&t.geometry.spatialReference,t.outSR)}}}function b(e){if(o(e))return!0;if(s(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}function G(e,t){if(!e)return null;const r=t.featureAdapter,{startTimeField:i,endTimeField:n}=e;let s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;if(i&&n)t.forEach((e=>{const t=r.getAttribute(e,i),l=r.getAttribute(e,n);null==t||isNaN(t)||(s=Math.min(s,t)),null==l||isNaN(l)||(o=Math.max(o,l))}));else{const e=i||n;t.forEach((t=>{const i=r.getAttribute(t,e);null==i||isNaN(i)||(s=Math.min(s,i),o=Math.max(o,i))}))}return{start:s,end:o}}function j(e,t,r){if(!t||!e)return null;const{startTimeField:i,endTimeField:n}=e;if(!i&&!n)return null;const{start:s,end:o}=t;return null===s&&null===o?null:void 0===s&&void 0===o?()=>!1:i&&n?function(e,t,r,i,n){return null!=i&&null!=n?s=>{const o=e.getAttribute(s,t),l=e.getAttribute(s,r);return(null==o||o<=n)&&(null==l||l>=i)}:null!=i?t=>{const n=e.getAttribute(t,r);return null==n||n>=i}:null!=n?r=>{const i=e.getAttribute(r,t);return null==i||i<=n}:void 0}(r,i,n,s,o):function(e,t,r,i){return null!=r&&null!=i&&r===i?i=>e.getAttribute(i,t)===r:null!=r&&null!=i?n=>{const s=e.getAttribute(n,t);return s>=r&&s<=i}:null!=r?i=>e.getAttribute(i,t)>=r:null!=i?r=>e.getAttribute(r,t)<=i:void 0}(r,i||n,s,o)}export{I as a,j as b,b as c,v as d,G as g};
