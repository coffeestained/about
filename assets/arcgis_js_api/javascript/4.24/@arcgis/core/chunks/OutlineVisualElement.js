/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../Color.js";import{t,c as s}from"./colorUtils2.js";import{f as r}from"./vec4f64.js";import{a as i}from"./ExtendedLineVisualElement.js";import{R as o}from"./Material.js";import{c as a}from"./lineStippleUtils.js";import n from"../core/Evented.js";import{i as l,a as h,u as c}from"./maybe.js";import{B as d,m as u,s as p,b as m,o as f,J as _,h as g}from"./mathUtils.js";import{f as w,a as y}from"./vec4f32.js";import{projectBuffer as O}from"../geometry/projection.js";import{a as C,g as v,n as R}from"./aaBoundingBox.js";import{m as b}from"./dehydratedFeatures.js";import{g as A}from"./elevationInfoUtils.js";import{E as P}from"./ElevationInfo.js";import{_ as G}from"./tslib.es6.js";import S from"../core/Accessor.js";import{I as E}from"./Identifiable.js";import{property as D}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./ensureType.js";import{subclass as j}from"../core/accessorSupport/decorators/subclass.js";import{a8 as T,M as W,R as F,a4 as I,a as M,c as x,a3 as z}from"./lineUtils.js";import{U as V}from"./basicInterfaces.js";import{L as U}from"./LaserlineVisualElement.js";import{V as B}from"./VisualElementResources.js";import{E as L}from"./ElevationContext.js";import{b as H}from"./geometryDataUtils.js";import{R as N}from"./RenderGeometry.js";import{V as q}from"./VertexAttribute.js";const Y={main:new e([255,127,0]),selected:new e([255,255,255]),staged:new e([12,207,255]),outline:new e([0,0,0,.5]),selectedOutline:new e([255,255,255])};function K(e,t){const s=e.clone();return s.a*=t,s}function k(e,r){const i=e.clone(),o=t(i);o.s*=r;const a=s(o);return i.r=a.r,i.g=a.g,i.b=a.b,i}function J(e,t){if(t)for(const s in t)e[s]=t[s]}class Q{constructor(e){this.color=Y.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=o.Opaque,J(this,e)}}class X{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=Y.main,this.outlineColor=Y.outline,this.renderOccluded=o.Opaque,this.hoverOutlineColor=Y.selectedOutline,J(this,e)}apply(e,t){const s=this[e];t.setParameters({color:ne(s),transparent:"color"!==e||s.a<1,renderOccluded:this.renderOccluded})}}class Z{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=K(Y.main,.5),this.hoverColor=Y.main,this.renderOccluded=o.Transparent,this.minSquaredEdgeLength=900,J(this,e)}apply(e,t){const s=this[e];t.setParameters({color:ne(s),transparent:s.a<1,renderOccluded:this.renderOccluded})}}class ${constructor(e){this.vertex=new X({color:Y.main,outlineColor:Y.outline}),this.edge=new X({color:k(K(Y.main,2/3),.5),outlineColor:K(Y.outline,.5),size:8,collisionPadding:8}),this.selected=new X({color:Y.selected,outlineColor:Y.outline}),this.edgeOffset=new Z,J(this,e)}}class ee{constructor(e){this.color=Y.selected,this.width=1.5,this.stipplePattern=a(5),this.stippleOffColor=Y.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=Y.selected,this.renderOccluded=o.OccludeAndTransparent,J(this,e)}apply(e){e.color=ne(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=ne(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=ne(this.innerColor),e.renderOccluded=this.renderOccluded}}class te{constructor(e){this.color=Y.selected,this.size=4,this.outlineSize=1,this.outlineColor=Y.outline,this.shape="square",J(this,e)}apply(e){e.color=ne(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=ne(this.outlineColor),e.primitive=this.shape}}class se{constructor(e){this.innerColor=Y.selected,this.innerWidth=1,this.glowColor=Y.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=Y.main,J(this,e)}apply(t,s=1){const r={glowColor:e.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:e.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*s,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=r:t.laserlineStyle=r}}class re{constructor(e){this.outline=new ee({color:Y.outline,renderOccluded:o.OccludeAndTransparentStencil,stippleOffColor:Y.selected,stipplePattern:a(5),width:1.5,innerWidth:0}),this.staged=new ee({color:Y.selected,renderOccluded:o.OccludeAndTransparentStencil,innerColor:Y.staged,stippleOffColor:Y.outline,stipplePattern:a(5),width:1.5}),this.shadowStyle=new se({globalAlpha:.3,glowColor:Y.main,glowFalloff:8,glowWidth:8,innerColor:Y.selected,innerWidth:1}),J(this,e)}}class ie{constructor(e){this.outline=new te({color:Y.selected,outlineColor:Y.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new se({globalAlpha:.3,glowColor:Y.main,glowFalloff:1.5,glowWidth:6,innerColor:Y.selected,innerWidth:1,radius:2}),J(this,e)}}class oe extends ee{constructor(e){super(),this.extensionType=i.GROUND_RAY,J(this,e)}}class ae{constructor(e){this.lineGraphics=new re,this.pointGraphics=new ie,this.heightPlane=new se({globalAlpha:.3,glowColor:Y.main,glowFalloff:8,glowWidth:8,innerColor:Y.selected,innerWidth:1}),this.heightBox=new se({globalAlpha:.3,glowColor:Y.main,glowFalloff:8,glowWidth:8,innerColor:Y.selected,innerWidth:0,heightFillColor:Y.main}),this.zVerticalLine=new oe({color:K(Y.main,.5),falloff:2,innerColor:K(Y.selected,0),renderOccluded:o.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:i.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,J(this,e)}}function ne(t){return r(e.toUnitRGBA(t))}const le=new class{constructor(e){this.visualElements=new ae,this.reshapeManipulators=new $,this.zManipulator=new Q,J(this,e)}colorToVec4(e){return ne(e)}};class he{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return l(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?h(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?h(this._resources)&&this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.createResources(),t=new ce({view:this.resourceFactory.view}),s=this.resourceFactory.view.basemapTerrain?.overlayManager;this._resources={layerView:new ce({view:this.resourceFactory.view}),external:e,geometriesAdded:!1},s&&(this._resources.drapeSourceRenderer=s.registerGeometryDrapeSource(t)),this._syncGeometriesToRenderer()}_destroyResources(){if(h(this._resources))return;this._ensureRenderGeometriesRemoved();const e=this.resourceFactory.view.basemapTerrain?.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){h(this._resources)||h(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,W.Geometry.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){h(this._resources)||h(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,W.Geometry.UPDATE),this._resources.geometriesAdded=!0)}}let ce=class extends(E(S)){constructor(e){super(e),this.drapeSourceType=T.Features,this.updatePolicy=V.SYNC}};G([D({constructOnly:!0})],ce.prototype,"view",void 0),G([D({readOnly:!0})],ce.prototype,"drapeSourceType",void 0),ce=G([j("DrapedVisualElementLayerView")],ce);class de{constructor(e){this.view=null,this._attachmentOrigin=b(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new n,this._isDraped=!1,this._geometry=null,this._width=1,this._color=w(1,0,1,1),this._innerWidth=0,this._innerColor=w(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=o.OccludeAndTransparentStencil,this.resources=new B({view:e.view,createResources:e=>this._createResources(e),recreateGeometry:(e,t)=>(e.geometries.length=0,this._recreateGeometry(t,e.material,e.geometries),e.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new he({view:e.view,createResources:()=>this._createDrapedResources(),recreateGeometry:e=>{e.geometries=this._createRenderGeometriesDraped(e.material),this._attachmentOriginChanged()}});let t=!0;this._laserline=new U({view:e.view});for(const s in e)s in this?"attached"===s?t=e[s]:this[s]=e[s]:console.error("Cannot set unknown property",s);this.attached=t}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this._updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&l(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this._updateAttached(e)}_updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){d(e,this._color)||(u(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){d(e,this._innerColor)||(u(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=l(e)!==l(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&d(e,this._stippleOffColor)||(this._stippleOffColor=e?y(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,l(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=l(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;p(me,0,0,0);let t=0;for(const s of e){const e=s.vertexAttributes.get(q.POSITION),r=s.indices.get(q.POSITION),i=c(this.resources.resources).material.isClosed(e.data,r);H(e,r,i,pe)&&(m(me,me,pe),t++)}return 0===t?null:(f(me,me,1/t),this.view.renderCoordsHelper.fromRenderCoords(me,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){l(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),l(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return l(this.geometry)&&"polygon"===this.geometry.type}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===o.OccludeAndTransparentStencil?o.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,t,s){const r=this._createRenderGeometries();for(const i of r)e.addGeometry(i,t),s.push(i);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(e){const t=new F(this.materialParameters),s=[];return this._recreateGeometry(e,t,s),{material:t,geometries:s,forEach:e=>{e(t),s.forEach(e)}}}_createDrapedResources(){const e=new F(this.materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const t=this.geometry;if(h(t))return[];const s=I(t,this.view.basemapTerrain.spatialReference),r=[];for(const{position:t}of s.lines){const s={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:t},removeDuplicateStartEnd:this.isClosed?M.REMOVE:M.KEEP},i=new N(x(s),e),o=v(ue);R(o,t),_(i.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),r.push(i)}return r}calculateMapBounds(e){if(h(this.resources.resources))return!1;const t=this.view.renderCoordsHelper;for(const s of this.resources.resources.geometries){const r=s.vertexAttributes.get(q.POSITION),i=new Float64Array(r.data.length);O(r.data,t.spatialReference,0,i,this.view.spatialReference,0,r.data.length/3),R(e,i)}return!0}_createRenderGeometries(){const e=this.geometry;if(h(e))return[];const t=z(e,this.view.elevationProvider,this.view.renderCoordsHelper,L.fromElevationInfo(this.elevationInfo??new P({mode:A(e,null)}))),s=[],r=[];for(const{position:e,mapPosition:i}of t.lines){const t={overlayInfo:null,attributeData:{position:e,mapPosition:i},removeDuplicateStartEnd:this.isClosed?M.REMOVE:M.KEEP};s.push(x(t)),r.push(e)}return this._laserline.pathVerticalPlane=r,s}}const ue=C(),pe=g(),me=g();export{de as O,Y as c,le as s};
