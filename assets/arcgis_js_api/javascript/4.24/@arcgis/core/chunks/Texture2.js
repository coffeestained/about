/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{n as e}from"./compilerUtils.js";import t from"../core/Error.js";import r from"../core/Evented.js";import{S as a,I as s}from"./mathUtils.js";import{a as i,i as o,r as n}from"./maybe.js";import{throwIfAborted as l,onAbort as h,createAbortError as m}from"../core/promiseUtils.js";import{n as d,o as _}from"../core/lang.js";import{isBlobProtocol as p,isDataProtocol as c}from"../core/urlUtils.js";import{r as u}from"./requestImageUtils.js";import{l as T}from"../request.js";import{a as g}from"./basicInterfaces.js";import{g as A}from"./assets.js";import{j as E,a as f,c as R,f as C,T as w,b as B,d as D,e as G,P as x}from"./enums.js";import{T as M,i as I}from"./Texture.js";import{a as S,v as F}from"./VertexArrayObject.js";import{C as y,b as P}from"./Material.js";import{L as N}from"./Logger.js";import{E as O}from"./glUtil3D.js";import{a as U}from"./Util.js";import{F as b}from"./FramebufferObject.js";let v;var L;!function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"}(L||(L={}));let H=null,V=null;async function j(){return i(V)&&(V=function(){if(i(v)){const e=e=>A(`esri/libs/basisu/${e}`);v=import("./basis_transcoder.js").then((e=>e.b)).then((({default:t})=>t({locateFile:e}).then((e=>(e.initializeBasis(),delete e.then,e)))))}return v}(),H=await V),V}function X(e,t,r,a,s){const i=S(t?E.COMPRESSED_RGBA8_ETC2_EAC:E.COMPRESSED_RGB8_ETC2),o=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*a*i*o)}function k(e){return e.getNumImages()>=1&&!e.isUASTC()}function q(e){return e.getFaces()>=1&&e.isETC1S()}function z(e,t,r,a,s,i,o,n){const{compressedTextureETC:l,compressedTextureS3TC:h}=e.capabilities,[m,d]=l?a?[L.ETC2_RGBA,E.COMPRESSED_RGBA8_ETC2_EAC]:[L.ETC1_RGB,E.COMPRESSED_RGB8_ETC2]:h?a?[L.BC3_RGBA,E.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[L.BC1_RGB,E.COMPRESSED_RGB_S3TC_DXT1_EXT]:[L.RGBA32,f.RGBA],_=t.hasMipmap?r:Math.min(1,r),p=[];for(let e=0;e<_;e++)p.push(new Uint8Array(o(e,m))),n(e,m,p[e]);const c=p.length>1,u=c?R.LINEAR_MIPMAP_LINEAR:R.LINEAR,T={...t,samplingMode:u,hasMipmap:c,internalFormat:d,width:s,height:i};return new M(e,T,{type:"compressed",levels:p})}const K=N.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function W(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Y=W("DXT1"),$=W("DXT3"),J=W("DXT5");class Q extends y{constructor(e,t){super(),this.data=e,this.type=P.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new r,this.params=t||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:C.REPEAT,t:C.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||g.STRETCH,this.estimatedTexMemRequired=Q._estimateTexMemRequired(this.data,this.params),this._startPreload()}_startPreload(){const e=this.data;i(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(p(e.src)||"auto"===e.preload&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const t=!e.paused;if(e.src=e.src,t&&e.autoplay){const t=()=>{e.removeEventListener("canplay",t),e.play()};e.addEventListener("canplay",t)}}}_startPreloadImageElement(e){c(e.src)||p(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static _getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static _estimateTexMemRequired(e,t){if(i(e))return 0;if(d(e)||_(e))return t.encoding===Q.KTX2_ENCODING?function(e,t){if(i(H))return e.byteLength;const r=new H.KTX2File(new Uint8Array(e)),a=q(r)?X(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),a}(e,t.mipmap):t.encoding===Q.BASIS_ENCODING?function(e,t){if(i(H))return e.byteLength;const r=new H.BasisFile(new Uint8Array(e)),a=k(r)?X(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),a}(e,t.mipmap):e.byteLength;const{width:r,height:a}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Q._getDataDimensions(e):t;return(t.mipmap?4/3:1)*r*a*(t.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(e){return{target:w.TEXTURE_2D,pixelFormat:f.RGBA,dataType:B.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?R.LINEAR_MIPMAP_LINEAR:R.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?e.parameters.maxMaxAnisotropy:1)}}get glTexture(){return this._glTexture}load(e,t){if(o(this._glTexture))return this._glTexture;if(o(this._loadingPromise))return this._loadingPromise;const r=this.data;return i(r)?(this._glTexture=new M(e,this._createDescriptor(e),null),this._glTexture):"string"==typeof r?this._loadFromURL(e,t,r):r instanceof Image?this._loadFromImageElement(e,t,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(e,t,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(e,r,t):(d(r)||_(r))&&this.params.encoding===Q.DDS_ENCODING?(this.data=void 0,this._loadFromDDSData(e,r)):(d(r)||_(r))&&this.params.encoding===Q.KTX2_ENCODING?(this.data=void 0,this._loadFromKTX2(e,r)):(d(r)||_(r))&&this.params.encoding===Q.BASIS_ENCODING?(this.data=void 0,this._loadFromBasis(e,r)):_(r)?this._loadFromPixelData(e,r):d(r)?this._loadFromPixelData(e,new Uint8Array(r)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(e,t,r){if(!(this.data instanceof HTMLVideoElement)||i(this._glTexture))return r;if(this.data.readyState<Z.HAVE_CURRENT_DATA||r===this.data.currentTime)return r;if(o(this._powerOfTwoStretchInfo)){const{framebuffer:r,vao:a,sourceTexture:s}=this._powerOfTwoStretchInfo;s.setData(this.data),this._drawStretchedTexture(e,t,r,a,s,this._glTexture)}else{const{videoWidth:e,videoHeight:t}=this.data,{width:r,height:a}=this._glTexture.descriptor;e!==r||t!==a?this._glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,a),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this.data.currentTime}_loadFromDDSData(e,t){return this._glTexture=function(e,t,r){const{textureData:s,internalFormat:i,width:o,height:n}=function(e,t){const r=new Int32Array(e,0,31);if(542327876!==r[0])return K.error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return K.error("Unsupported format, must contain a FourCC code"),null;const s=r[21];let i,o;switch(s){case Y:i=8,o=E.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case $:i=16,o=E.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case J:i=16,o=E.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return K.error("Unsupported FourCC code:",(n=s,String.fromCharCode(255&n,n>>8&255,n>>16&255,n>>24&255))),null}var n;let l=1,h=r[4],m=r[3];0==(3&h)&&0==(3&m)||(K.warn("Rounding up compressed texture size to nearest multiple of 4."),h=h+3&-4,m=m+3&-4);const d=h,_=m;131072&r[2]&&!1!==t&&(l=Math.max(1,r[7])),1===l||a(h)&&a(m)||(K.warn("Ignoring mipmaps of non power of two sized compressed texture."),l=1);let p,c,u=r[1]+4;const T=[];for(let t=0;t<l;++t)c=(h+3>>2)*(m+3>>2)*i,p=new Uint8Array(e,u,c),T.push(p),u+=c,h=Math.max(1,h>>1),m=Math.max(1,m>>1);return{textureData:{type:"compressed",levels:T},internalFormat:o,width:d,height:_}}(r,t.hasMipmap);return t.samplingMode=s.levels.length>1?R.LINEAR_MIPMAP_LINEAR:R.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=i,t.width=o,t.height=n,new M(e,t,s)}(e,this._createDescriptor(e),t),this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>async function(e,t,r){i(H)&&(H=await j());const a=new H.KTX2File(new Uint8Array(r));if(!q(a))return null;a.startTranscoding();const s=z(e,t,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),((e,t)=>a.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,r)=>a.transcodeImage(r,e,0,0,t,0,-1,-1)));return a.close(),a.delete(),s}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>async function(e,t,r){i(H)&&(H=await j());const a=new H.BasisFile(new Uint8Array(r));if(!k(a))return null;a.startTranscoding();const s=z(e,t,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),((e,t)=>a.getImageTranscodedSizeInBytes(0,e,t)),((e,t,r)=>a.transcodeImage(r,0,e,t,0,0)));return a.close(),a.delete(),s}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){U(this.params.width>0&&this.params.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this.params.components?f.LUMINANCE:3===this.params.components?f.RGB:f.RGBA,r.width=this.params.width,r.height=this.params.height,this._glTexture=new M(e,r,t),this._glTexture}_loadFromURL(e,t,r){return this._loadAsync((async a=>{const s=await u(r,{signal:a});return l(a),this._loadFromImage(e,s,t)}))}_loadFromImageElement(e,t,r){return r.complete?this._loadFromImage(e,r,t):this._loadAsync((async a=>{const s=await T(r,r.src,!1,a);return l(a),this._loadFromImage(e,s,t)}))}_loadFromVideoElement(e,t,r){return r.readyState>=Z.HAVE_CURRENT_DATA?this._loadFromImage(e,r,t):this._loadFromVideoElementAsync(e,t,r)}_loadFromVideoElementAsync(e,r,a){return this._loadAsync((s=>new Promise(((i,o)=>{const l=()=>{a.removeEventListener("loadeddata",d),a.removeEventListener("error",_),n(p)},d=()=>{a.readyState>=Z.HAVE_CURRENT_DATA&&(l(),i(this._loadFromImage(e,a,r)))},_=e=>{l(),o(e||new t("Failed to load video"))};a.addEventListener("loadeddata",d),a.addEventListener("error",_);const p=h(s,(()=>_(m())))}))))}_loadFromImage(e,t,r){const s=Q._getDataDimensions(t);this.params.width=s.width,this.params.height=s.height;const i=this._createDescriptor(e);return i.pixelFormat=3===this.params.components?f.RGB:f.RGBA,!this._requiresPowerOfTwo(e,i)||a(s.width)&&a(s.height)?(i.width=s.width,i.height=s.height,this._glTexture=new M(e,i,t),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,t,s,i,r),this._glTexture)}_loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const a=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(a,a),r}_requiresPowerOfTwo(e,t){const r=C.CLAMP_TO_EDGE,a="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return!I(e.gl)&&(t.hasMipmap||!a)}_makePowerOfTwoTexture(t,r,a,i,o){const{width:n,height:l}=a,h=s(n),m=s(l);let d;switch(i.width=h,i.height=m,this.params.powerOfTwoResizeMode){case g.PAD:i.textureCoordinateScaleFactor=[n/h,l/m],d=new M(t,i),d.updateData(0,0,0,n,l,r);break;case g.STRETCH:case null:case void 0:d=this._stretchToPowerOfTwo(t,r,i,o());break;default:e(this.params.powerOfTwoResizeMode)}return i.hasMipmap&&d.generateMipmap(),d}_stretchToPowerOfTwo(e,t,r,a){const s=new M(e,r),i=new b(e,{colorTarget:D.TEXTURE,depthStencilTarget:G.NONE},s),o=new M(e,{target:w.TEXTURE_2D,pixelFormat:r.pixelFormat,dataType:B.UNSIGNED_BYTE,wrapMode:C.CLAMP_TO_EDGE,samplingMode:R.LINEAR,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=O(e),l=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,a,i,n,o,s),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:n,sourceTexture:o,framebuffer:i}:(n.dispose(!0),o.dispose(),i.detachColorTexture(),i.dispose()),e.bindFramebuffer(l),s}_drawStretchedTexture(e,t,r,a,s,i){e.bindFramebuffer(r);const o=e.getViewport();e.setViewport(0,0,i.descriptor.width,i.descriptor.height);const n=e.bindTechnique(t);n.setUniform4f("uColor",1,1,1,1),n.bindTexture("tex",s),e.bindVAO(a),e.drawArrays(x.TRIANGLE_STRIP,0,F(a,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height)}unload(){if(o(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this._powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(o(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),o(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}var Z;Q.DDS_ENCODING="image/vnd-ms.dds",Q.KTX2_ENCODING="image/ktx2",Q.BASIS_ENCODING="image/x.basis",function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(Z||(Z={}));export{Q as T,j as l};
