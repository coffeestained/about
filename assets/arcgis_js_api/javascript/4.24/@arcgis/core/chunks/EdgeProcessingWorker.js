/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{d as e}from"./deduplicate.js";import{n as t}from"./InterleavedLayout.js";import{k as n,c as s,B as o,a as r,g as a,i,l as c,d as l,e as u,f,h as g,j as d,m as p,r as m,u as h,b as I,n as N,x as A,v as w,s as O,t as S,w as E,y as v,z as y,o as L,p as T,A as D,C as V,D as P,q as b,E as x,F as M,G as R,H as U,I as B,J as F}from"./BufferView.js";import{V as j}from"./VertexAttribute.js";import{g as C}from"./glUtil.js";import{R as k,A as W,B as X}from"../core/lang.js";import{b as G,n as H,h as _,g as z,s as K,a as q,j as $,u as J,A as Q,k as Y,d as Z,v as ee}from"./mathUtils.js";const te=t().vec3f(j.POSITION).u16(j.COMPONENTINDEX).u16(j.U16PADDING),ne=t().vec2u8(j.SIDENESS),se=C(ne),oe=t().vec3f(j.POSITION0).vec3f(j.POSITION1).u16(j.COMPONENTINDEX).u8(j.VARIANTOFFSET,{glNormalized:!0}).u8(j.VARIANTSTROKE).u8(j.VARIANTEXTENSION,{glNormalized:!0}).u8(j.U8PADDING,{glPadding:!0}).u16(j.U16PADDING,{glPadding:!0}),re=oe.clone().vec3f(j.NORMAL),ae=oe.clone().vec3f(j.NORMALA).vec3f(j.NORMALB),ie=new Map([[j.POSITION0,0],[j.POSITION1,1],[j.COMPONENTINDEX,2],[j.VARIANTOFFSET,3],[j.VARIANTSTROKE,4],[j.VARIANTEXTENSION,5],[j.NORMAL,6],[j.NORMALA,6],[j.NORMALB,7],[j.SIDENESS,8]]);function ce(e,t,n){const s=t/3,o=new Uint32Array(n+1),r=new Uint32Array(n+1),a=(e,t)=>{e<t?o[e+1]++:r[t+1]++};for(let t=0;t<s;t++){const n=e[3*t],s=e[3*t+1],o=e[3*t+2];a(n,s),a(s,o),a(o,n)}let i=0,c=0;for(let e=0;e<n;e++){const t=o[e+1],n=r[e+1];o[e+1]=i,r[e+1]=c,i+=t,c+=n}const l=new Uint32Array(6*s),u=o[n],f=(e,t,n)=>{if(e<t){const s=o[e+1]++;l[2*s]=t,l[2*s+1]=n}else{const s=r[t+1]++;l[2*u+2*s]=e,l[2*u+2*s+1]=n}};for(let t=0;t<s;t++){const n=e[3*t],s=e[3*t+1],o=e[3*t+2];f(n,s,t),f(s,o,t),f(o,n,t)}const g=(e,t)=>{const n=2*e,s=t-e;for(let e=1;e<s;e++){const t=l[n+2*e],s=l[n+2*e+1];let o=e-1;for(;o>=0&&l[n+2*o]>t;o--)l[n+2*o+2]=l[n+2*o],l[n+2*o+3]=l[n+2*o+1];l[n+2*o+2]=t,l[n+2*o+3]=s}};for(let e=0;e<n;e++)g(o[e],o[e+1]),g(u+r[e],u+r[e+1]);const d=new Int32Array(3*s),p=(t,n)=>t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1,m=(e,t)=>{const n=p(e,t);d[3*t+n]=-1},h=(e,t,n,s)=>{const o=p(e,t);d[3*t+o]=s;const r=p(n,s);d[3*s+r]=t};for(let e=0;e<n;e++){let t=o[e];const n=o[e+1];let s=r[e];const a=r[e+1];for(;t<n&&s<a;){const n=l[2*t],o=l[2*u+2*s];n===o?(h(e,l[2*t+1],o,l[2*u+2*s+1]),t++,s++):n<o?(m(e,l[2*t+1]),t++):(m(o,l[2*u+2*s+1]),s++)}for(;t<n;)m(e,l[2*t+1]),t++;for(;s<a;)m(l[2*u+2*s],l[2*u+2*s+1]),s++}return d}function le(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:fe(e.layout)}}function ue(e){const n=function(e){const n=t();return n.stride=e.stride,n.fieldNames=e.fieldNames,e.fields.forEach((e=>{return n.fields.set(e[0],{...e[1],constructor:(t=e[1].constructor,pe.get(t))});var t})),n}(e.layout);return n.createView(e.buffer)}function fe(e){const t=new Array;return e.fields.forEach(((e,n)=>{const s={...e,constructor:de(e.constructor)};t.push([n,s])})),{stride:e.stride,fields:t,fieldNames:e.fieldNames}}const ge=[n,s,o,r,a,i,c,l,u,f,g,d,p,m,h,I,N,A,w,O,S,E,v,y,L,T,D,V,P,b,x,M,R,U,B,F];function de(e){return`${e.ElementType}_${e.ElementCount}`}const pe=new Map;ge.forEach((e=>pe.set(de(e),e)));class me{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?we:Ae}write(e,t,n){const s=this.edgeHashFunction(n);ye.seed=s;const o=ye.getIntRange(0,255),r=ye.getIntRange(0,this.settings.variants-1),a=ye.getFloat(),i=255*(.5*function(e,t){const n=e<0?-1:1;return Math.abs(e)**1.2*n}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7))+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,o),e.variantStroke.set(t,r),e.variantExtension.set(t,i)}trim(e,t){return e.slice(0,t)}}const he=new Float32Array(6),Ie=new Uint32Array(he.buffer),Ne=new Uint32Array(1);function Ae(e){const t=he;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],Ne[0]=5381;for(let e=0;e<Ie.length;e++)Ne[0]=31*Ne[0]+Ie[e];return Ne[0]}function we(e){const t=he;t[0]=Oe(e.position0[0]),t[1]=Oe(e.position0[1]),t[2]=Oe(e.position0[2]),t[3]=Oe(e.position1[0]),t[4]=Oe(e.position1[1]),t[5]=Oe(e.position1[2]),Ne[0]=5381;for(let e=0;e<Ie.length;e++)Ne[0]=31*Ne[0]+Ie[e];return Ne[0]}function Oe(e){return Math.round(1e4*e)/1e4}class Se{constructor(){this.commonWriter=new me}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return re.createBuffer(e)}write(e,t,n){this.commonWriter.write(e,t,n),G(ve,n.faceNormal0,n.faceNormal1),H(ve,ve),e.normal.setVec(t,ve)}trim(e,t){return this.commonWriter.trim(e,t)}}Se.Layout=re,Se.glLayout=C(re,1);class Ee{constructor(){this.commonWriter=new me}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return ae.createBuffer(e)}write(e,t,n){this.commonWriter.write(e,t,n),e.normalA.setVec(t,n.faceNormal0),e.normalB.setVec(t,n.faceNormal1)}trim(e,t){return this.commonWriter.trim(e,t)}}Ee.Layout=ae,Ee.glLayout=C(ae,1);const ve=_(),ye=new k;var Le;function Te(e,t,n,s=Me){const o=e.vertices.position,r=e.vertices.componentIndex,a=z(s.anglePlanar),i=z(s.angleSignificantEdge),c=Math.cos(i),l=Math.cos(a),u=be.edge,f=u.position0,g=u.position1,d=u.faceNormal0,p=u.faceNormal1,m=function(e){const t=e.faces.length/3,n=e.vertices.position,s=e.faces,o=xe.v0,r=xe.v1,a=xe.v2,i=new Float32Array(3*t);for(let e=0;e<t;e++){const t=s[3*e+0],c=s[3*e+1],l=s[3*e+2];n.getVec(t,o),n.getVec(c,r),n.getVec(l,a),Z(r,r,o),Z(a,a,o),Y(o,r,a),H(o,o),i[3*e+0]=o[0],i[3*e+1]=o[1],i[3*e+2]=o[2]}return i}(e),h=function(e){const t=e.faces.length/3,n=e.faces,s=e.neighbors;let o=0;for(let e=0;e<t;e++){const t=s[3*e+0],r=s[3*e+1],a=s[3*e+2],i=n[3*e+0],c=n[3*e+1],l=n[3*e+2];o+=-1===t||i<c?1:0,o+=-1===r||c<l?1:0,o+=-1===a||l<i?1:0}const r=new Int32Array(4*o);let a=0;for(let e=0;e<t;e++){const t=s[3*e+0],o=s[3*e+1],i=s[3*e+2],c=n[3*e+0],l=n[3*e+1],u=n[3*e+2];(-1===t||c<l)&&(r[a++]=c,r[a++]=l,r[a++]=e,r[a++]=t),(-1===o||l<u)&&(r[a++]=l,r[a++]=u,r[a++]=e,r[a++]=o),(-1===i||u<c)&&(r[a++]=u,r[a++]=c,r[a++]=e,r[a++]=i)}return r}(e),I=h.length/4,N=t.allocate(I);let A=0;const w=I,O=n.allocate(w);let S=0,E=0,v=0;const y=W(0,I),L=new Float32Array(I);X(L,((e,t,n)=>{o.getVec(h[4*t+0],f),o.getVec(h[4*t+1],g),n[t]=ee(f,g)})),y.sort(((e,t)=>L[t]-L[e]));const T=new Array,D=new Array;for(let e=0;e<I;e++){const s=y[e],i=L[s],I=h[4*s+0],w=h[4*s+1],V=h[4*s+2],P=h[4*s+3],b=-1===P;if(o.getVec(I,f),o.getVec(w,g),b)K(d,m[3*V+0],m[3*V+1],m[3*V+2]),q(p,d),u.componentIndex=r.get(I),u.cosAngle=$(d,p);else{if(K(d,m[3*V+0],m[3*V+1],m[3*V+2]),K(p,m[3*P+0],m[3*P+1],m[3*P+2]),u.componentIndex=r.get(I),u.cosAngle=$(d,p),Ve(u,l))continue;u.cosAngle<-.9999&&q(p,d)}E+=i,v++,b||De(u,c)?(t.write(N,A++,u),T.push(i)):Pe(u,a)&&(n.write(O,S++,u),D.push(i))}const V=new Float32Array(T.reverse()),P=new Float32Array(D.reverse());return{regular:{instancesData:t.trim(N,A),lodInfo:{lengths:V}},silhouette:{instancesData:n.trim(O,S),lodInfo:{lengths:P}},averageEdgeLength:E/v}}function De(e,t){return e.cosAngle<t}function Ve(e,t){return e.cosAngle>t}function Pe(e,t){const n=J(e.cosAngle),s=be.fwd,o=be.ortho;return Q(s,e.position1,e.position0),n*($(Y(o,e.faceNormal0,e.faceNormal1),s)>0?-1:1)>t}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH"}(Le||(Le={}));const be={edge:{position0:_(),position1:_(),faceNormal0:_(),faceNormal1:_(),componentIndex:0,cosAngle:0},ortho:_(),fwd:_()},xe={v0:_(),v1:_(),v2:_()},Me={anglePlanar:4,angleSignificantEdge:35};class Re{async extract(e){const t=Be(e),n=Ue(t),s=[t.data.buffer],o=function(e,t){return t.push(e.regular.lodInfo.lengths.buffer),t.push(e.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:le(e.regular.instancesData,t),lodInfo:{lengths:e.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:le(e.silhouette.instancesData,t),lodInfo:{lengths:e.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:e.averageEdgeLength}}(n,s);return{result:o,transferList:s}}async extractComponentsEdgeLocations(e){const t=Be(e),n=[];return{result:le(Te(Fe(t.data,t.skipDeduplicate,t.indices,t.indicesLength),We,Xe).regular.instancesData,n),transferList:n}}async extractEdgeLocations(e){const t=Be(e),n=[];return{result:le(Te(Fe(t.data,t.skipDeduplicate,t.indices,t.indicesLength),ke,Xe).regular.instancesData,n),transferList:n}}}function Ue(e){const t=Fe(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return je.updateSettings(e.writerSettings),Ce.updateSettings(e.writerSettings),Te(t,je,Ce)}function Be(e){return{data:te.createView(e.dataBuffer),indices:"Uint32Array"===e.indicesType?new Uint32Array(e.indicesBuffer):"Uint16Array"===e.indicesType?new Uint16Array(e.indicesBuffer):void 0,indicesLength:e.indicesLength,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate}}function Fe(t,n,s,o){if(n)return{faces:s,facesLength:o,neighbors:ce(s,o,t.count),vertices:t};const r=e(t.buffer,t.stride/4,{originalIndices:s,originalIndicesLength:o}),a=ce(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:a,vertices:te.createView(r.buffer)}}const je=new Se,Ce=new Ee,ke=new class{allocate(e){return Ge.createBuffer(e)}trim(e,t){return e.slice(0,t)}write(e,t,n){e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1)}},We=new class{allocate(e){return He.createBuffer(e)}trim(e,t){return e.slice(0,t)}write(e,t,n){e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex)}},Xe={allocate:()=>null,write:()=>{},trim:()=>null},Ge=t().vec3f(j.POSITION0).vec3f(j.POSITION1),He=t().vec3f(j.POSITION0).vec3f(j.POSITION1).u16(j.COMPONENTINDEX).u16(j.U16PADDING,{glPadding:!0}),_e=Object.freeze(Object.defineProperty({__proto__:null,EdgeProcessingWorker:Re,extract:Ue,extractEdgeLocationsLayout:Ge,extractComponentsEdgeLocationsLayout:He,default:function(){return new Re}},Symbol.toStringTag,{value:"Module"}));export{te as E,Se as R,Ee as S,ne as V,ie as a,Ue as b,Le as c,_e as d,He as e,se as g,ue as u};
