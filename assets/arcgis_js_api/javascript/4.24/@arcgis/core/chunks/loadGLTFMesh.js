/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{o}from"./ensureType.js";import{f as r,ag as s}from"./mathUtils.js";import{u as i,f as n,i as a,a as m}from"./maybe.js";import{a as p}from"./mat3.js";import{b as c}from"./quatf64.js";import{a as l}from"./vec4f64.js";import u,{M as f}from"../geometry/support/MeshComponent.js";import j from"../geometry/support/MeshMaterialMetallicRoughness.js";import g from"../geometry/support/MeshTexture.js";import{e as d,B as y,a as x,b as h,c as b,s as v,u as w,v as M}from"./BufferView.js";import{t as A,a as C,n as E,f as T,s as S,c as R,b as U}from"./vec3.js";import{D as B,l as P,c as O,C as $,t as G,g as I,f as L,n as N,h as D,s as F,a as _,i as k,b as q,d as z,e as V}from"./DefaultMaterial_COLOR_GAMMA.js";import{a as J}from"./georeference.js";import{d as K}from"./geometryDataUtils.js";import{P as Q,f as H}from"./enums.js";import"./colorUtils.js";import"./common.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../core/promiseUtils.js";import"./tslib.es6.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./tracking.js";import"./ArrayPool.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/MeshMaterial.js";import"./reader.js";import"./writer.js";import"./persistableUrlUtils.js";import"./screenshotUtils.js";import"./vec2.js";import"./types.js";import"./asyncUtils.js";import"./mat4f64.js";import"./compilerUtils.js";import"./Version.js";import"./mat4.js";import"./quat.js";import"./unitUtils.js";import"./jsonMap.js";import"./projectionEllipsoid.js";import"../geometry/SpatialReference.js";import"./Ellipsoid.js";import"../geometry/projection.js";import"./SimpleObservable.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./pe.js";import"./assets.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./axisAngleDegrees.js";import"./projection.js";import"./triangle.js";import"./vectorStacks.js";import"./byteSizeEstimations.js";import"./vec2f64.js";import"./lineSegment.js";async function W(s,m,p){const c=new B(function(t){return t?.resolveFile?{busy:!1,request:async(o,r,s)=>{const i=t.resolveFile(o),n="image"===r?"image":"binary"===r?"array-buffer":"json";return(await e(i,{responseType:n,signal:a(s)?s.signal:null})).data}}:null}(p)),u=(await P(c,m,p,!0)).model,v=u.lods.shift(),w=new Map,M=new Map;u.textures.forEach(((t,e)=>{return w.set(e,new g({data:(r=t).data,wrap:(o=r.parameters.wrap,{horizontal:tt(o.s),vertical:tt(o.t)})}));var o,r})),u.materials.forEach(((e,o)=>M.set(o,function(e,o){const s=new t((m=e.color,p=e.opacity,l(et(m[0]),et(m[1]),et(m[2]),p))),a=e.emissiveFactor?new t(function(t){return r(et(t[0]),et(t[1]),et(t[2]))}(e.emissiveFactor)):null;var m,p;return new j({color:s,colorTexture:i(n(e.textureColor,(t=>o.get(t)))),normalTexture:i(n(e.textureNormal,(t=>o.get(t)))),emissiveColor:a,emissiveTexture:i(n(e.textureEmissive,(t=>o.get(t)))),occlusionTexture:i(n(e.textureOcclusion,(t=>o.get(t)))),alphaMode:Z(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:i(n(e.textureMetallicRoughness,(t=>o.get(t))))})}(e,w))));const A=function(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},s=new Map,i=new Map,n=[];for(const p of t.parts){const{attributes:{position:t,normal:c,color:l,tangent:u,texCoord0:f}}=p,j=`\n      ${X(t,s)}/\n      ${X(c,s)}/\n      ${X(l,s)}/\n      ${X(u,s)}/\n      ${X(f,s)}/\n      ${m=p.transform,a(m)?m.toString():"-"}\n    `;let g=!1;const d=o(i,j,(()=>(g=!0,{start:e,length:t.count})));g&&(e+=t.count),c&&(r.normal=!0),l&&(r.color=!0),u&&(r.tangent=!0),f&&(r.texCoord0=!0),n.push({gltf:p,writeVertices:g,region:d})}var m;return{vertexAttributes:{position:O(d,e),normal:r.normal?O(y,e):null,tangent:r.tangent?O(x,e):null,color:r.color?O(h,e):null,texCoord0:r.texCoord0?O(b,e):null},parts:n,components:[]}}(v);for(const t of A.parts)Y(A,t,M);const{position:C,normal:E,tangent:T,color:S,texCoord0:R}=A.vertexAttributes,U={position:C.typedBuffer,normal:a(E)?E.typedBuffer:null,tangent:a(T)?T.typedBuffer:null,uv:a(R)?R.typedBuffer:null,color:a(S)?S.typedBuffer:null},$=J(U,s,p);return{transform:$.transform,components:A.components,spatialReference:s.spatialReference,vertexAttributes:new f({position:$.vertexAttributes.position,normal:$.vertexAttributes.normal,tangent:$.vertexAttributes.tangent,color:U.color,uv:U.uv})}}function X(t,e){if(m(t))return"-";const r=t.typedBuffer;return`${o(e,r.buffer,(()=>e.size))}/${r.byteOffset}/${r.byteLength}`}function Y(t,e,o){e.writeVertices&&function(t,e){const{position:o,normal:r,tangent:i,color:n,texCoord0:m}=t.vertexAttributes,l=e.region.start,{attributes:u,transform:f}=e.gltf,j=u.position.count;if(A(o.slice(l,j),u.position,f),a(u.normal)&&a(r)){const t=p(c(),f),e=r.slice(l,j);C(e,u.normal,t),s(t)&&E(e,e)}else a(r)&&T(r,0,0,1,{dstIndex:l,count:j});if(a(u.tangent)&&a(i)){const t=p(c(),f),e=i.slice(l,j);G(e,u.tangent,t),s(t)&&I(e,e)}else a(i)&&L(i,0,0,1,1,{dstIndex:l,count:j});if(a(u.texCoord0)&&a(m)?N(m.slice(l,j),u.texCoord0):a(m)&&D(m,0,0,{dstIndex:l,count:j}),a(u.color)&&a(n)){const t=u.color,e=n.slice(l,j);if(4===t.elementCount)t instanceof x?F(e,t,255):t instanceof h?_(e,t):t instanceof v&&k(e,t,8);else{L(e,255,255,255,255);const o=w.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof y?S(o,t,255):t instanceof w?R(o,t):t instanceof M&&U(o,t,8)}}else a(n)&&L(n.slice(l,j),255,255,255,255)}(t,e);const r=e.gltf,i=function(t,e){switch(e){case Q.TRIANGLES:return V(t,K);case Q.TRIANGLE_STRIP:return z(t);case Q.TRIANGLE_FAN:return q(t)}}(r.indices||r.attributes.position.count,r.primitiveType),n=e.region.start;if(n)for(let t=0;t<i.length;t++)i[t]+=n;t.components.push(new u({faces:i,material:o.get(r.material),trustSourceNormals:!0}))}function Z(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function tt(t){switch(t){case H.CLAMP_TO_EDGE:return"clamp";case H.MIRRORED_REPEAT:return"mirror";case H.REPEAT:return"repeat"}}function et(t){return t**(1/$)*255}export{W as loadGLTFMesh};
