/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{i as t,a as r,h as e}from"./maybe.js";import{i as o}from"./multiOriginJSONSupportUtils.js";import{getPathExtension as i,isAbsolute as n,isBlobProtocol as s,join as p}from"../core/urlUtils.js";import{g as a}from"./uuid.js";import{g as c}from"./metadata.js";import{n as u}from"../core/Accessor.js";import{propertyJSONMeta as l}from"../core/accessorSupport/decorators/property.js";import{r as f,t as m,M as g,i as y,p as h}from"./persistableUrlUtils.js";function d(t){return v[function(t){return t instanceof Blob?t.type:function(t){const r=i(t);return U[r]||j}(t.url)}(t)]||w}const v={},j="text/plain",w=v[j],U={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(const t in U)v[U[t]]=t;function b(e){const p=t(e)&&e.origins?e.origins:[void 0];return(a,v)=>{const j=function(e,p,a){if(t(e)&&"resource"===e.type)return function(e,p,a){const l=c(p,a);return{type:String,read:(t,r,e)=>{const o=f(t,r,e);return l.type===String?o:"function"==typeof l.type?new l.type({url:o}):void 0},write:{writer(p,c,f,h){if(!h||!h.resources)return"string"==typeof p?void(c[f]=m(p,h)):void(c[f]=p.write({},h));const v=r(U=p)?null:"string"==typeof U?U:U.url,j=v?m(v,{...h,verifyItemRelativeUrls:h&&h.verifyItemRelativeUrls?{writtenUrls:h.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},g.NO):null,w=l.type!==String&&(!o(this)||h&&h.origin&&this.originIdOf(a)>u(h.origin));var U;h&&h.portalItem&&t(j)&&!n(j)?w?function(t,r,e,o,n,s,p,a){const c=p.portalItem.resourceFromPath(o),u=S(e,o,p);d(u)===i(c.path)?(I(t,r,c,u,p.resources.toUpdate),n[s]=o):x(t,r,e,o,n,s,p,a)}(this,a,p,j,c,f,h,e):function(t,r,e,o){o.resources.toKeep.push({resource:o.portalItem.resourceFromPath(t)}),r[e]=t}(j,c,f,h):h&&h.portalItem&&(r(j)||t(y(j))||s(j)||w)?x(this,a,p,j,c,f,h,e):c[f]=j}}}}(e,p,a);switch(t(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:t,write:r}=h;return{read:t,write:r}}}}(e,a,v);for(const t of p){const r=l(a,t,v);for(const t in j)r[t]=j[t]}}}function x(t,r,o,i,n,c,u,l){const f=a(),m=S(o,i,u),g=p(e(l,"prefix"),f),y=`${g}.${d(m)}`,h=u.portalItem.resourceFromPath(y);s(i)&&u.resources.pendingOperations.push(async function(t){const r=(await import("../request.js").then((t=>t.r))).default,{data:e}=await r(t,{responseType:"blob"});return e}(i).then((t=>{h.path=`${g}.${d(t)}`,n[c]=h.itemRelativeUrl})).catch((()=>{}))),I(t,r,h,m,u.resources.toAdd),n[c]=h.itemRelativeUrl}function I(t,r,e,o,i){i.push({resource:e,content:o,finish:e=>{!function(t,r,e){"string"==typeof t[r]?t[r]=e.url:t[r].url=e.url}(t,r,e)}})}function S(t,r,e){return"string"==typeof t?{url:r}:new Blob([JSON.stringify(t.toJSON(e))],{type:"application/json"})}export{b as p};
