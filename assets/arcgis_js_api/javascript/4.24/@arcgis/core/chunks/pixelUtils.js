/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{i as t,a as e}from"./maybe.js";import n from"../layers/support/PixelBlock.js";function i(e){return t(e)&&"esri.layers.support.PixelBlock"===e.declaredClass&&e.pixels&&e.pixels.length>0}function l(t,e){if(!e?.length||!i(t))return t;const l=t.pixels.length;return e&&e.some((t=>t>=l))||1===l&&1===e.length&&0===e[0]?t:l!==e.length||e.some(((t,e)=>t!==e))?new n({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:e.map((e=>t.pixels[e])),statistics:t.statistics&&e.map((e=>t.statistics[e]))}):t}function o(t){if(!t)return;const e=t.colormap;if(!e||0===e.length)return;const n=e.sort(((t,e)=>t[0]-e[0]));let i=0;n[0][0]<0&&(i=n[0][0]);const l=Math.max(256,n[n.length-1][0]-i+1),o=new Uint8Array(4*l),r=[];let s,a=0,h=0;const f=5===n[0].length;if(l>65536)return n.forEach((t=>{r[t[0]-i]=f?t.slice(1):t.slice(1).concat([255])})),{indexed2DColormap:r,offset:i,alphaSpecified:f};if(t.fillUnspecified)for(s=n[h],a=s[0]-i;a<l;a++)o[4*a]=s[1],o[4*a+1]=s[2],o[4*a+2]=s[3],o[4*a+3]=f?s[4]:255,a===s[0]-i&&(s=h===n.length-1?s:n[++h]);else for(a=0;a<n.length;a++)s=n[a],h=4*(s[0]-i),o[h]=s[1],o[h+1]=s[2],o[h+2]=s[3],o[h+3]=f?s[4]:255;return{indexedColormap:o,offset:i,alphaSpecified:f}}function r(t,e){if(!i(t))return t;if(!e&&(e.indexedColormap||e.indexed2DColormap))return t;const n=t.clone(),l=n.pixels;let o=n.mask;const r=n.width*n.height;if(1!==l.length)return t;const{indexedColormap:s,indexed2DColormap:a,offset:h,alphaSpecified:f}=e,c=s.length-1;let u=0;const p=l[0],x=new Uint8Array(p.length),m=new Uint8Array(p.length),d=new Uint8Array(p.length);let y,g=0;if(s)if(o)for(u=0;u<r;u++)o[u]&&(g=4*(p[u]-h),g<h||g>c?o[u]=0:(x[u]=s[g],m[u]=s[g+1],d[u]=s[g+2],o[u]=s[g+3]));else{for(o=new Uint8Array(r),u=0;u<r;u++)g=4*(p[u]-h),g<h||g>c?o[u]=0:(x[u]=s[g],m[u]=s[g+1],d[u]=s[g+2],o[u]=s[g+3]);n.mask=o}else if(o)for(u=0;u<r;u++)o[u]&&(y=a[p[u]],x[u]=y[0],m[u]=y[1],d[u]=y[2],o[u]=y[3]);else{for(o=new Uint8Array(r),u=0;u<r;u++)y=a[p[u]],x[u]=y[0],m[u]=y[1],d[u]=y[2],o[u]=y[3];n.mask=o}return n.pixels=[x,m,d],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=f,n}function s(t,e){if(!i(t))return null;const{pixels:l,mask:o}=t,r=t.width*t.height,s=l.length;let a=e.lut;const{offset:h}=e;let f,c;a&&1===a[0].length&&(a=l.map((()=>a)));const u=[];let p,x,m;if(h)if(null==o)for(f=0;f<s;f++){for(p=l[f],x=a[f],m=new Uint8Array(r),c=0;c<r;c++)m[c]=x[p[c]-h];u.push(m)}else for(f=0;f<s;f++){for(p=l[f],x=a[f],m=new Uint8Array(r),c=0;c<r;c++)o[c]&&(m[c]=x[p[c]-h]);u.push(m)}else if(null==o)for(f=0;f<s;f++){for(p=l[f],x=a[f],m=new Uint8Array(r),c=0;c<r;c++)m[c]=x[p[c]];u.push(m)}else for(f=0;f<s;f++){for(p=l[f],x=a[f],m=new Uint8Array(r),c=0;c<r;c++)o[c]&&(m[c]=x[p[c]]);u.push(m)}const d=new n({width:t.width,height:t.height,pixels:u,mask:o,pixelType:"u8"});return d.updateStatistics(),d}function a(t,e){if(!i(t))return null;const n=t.clone(),{pixels:l}=n,o=n.width*n.height,r=e.length,s=Math.floor(r/2),a=e[Math.floor(s)],h=l[0];let f,c,u,p,x,m,d=!1;const y=new Uint8Array(o),g=new Uint8Array(o),w=new Uint8Array(o);let k=n.mask;const M=4===e[0].mappedColor.length;for(k||(k=new Uint8Array(o),k.fill(M?255:1),n.mask=k),x=0;x<o;x++)if(k[x]){for(f=h[x],d=!1,m=s,c=a,u=0,p=r-1;p-u>1;){if(f===c.value){d=!0;break}f>c.value?u=m:p=m,m=Math.floor((u+p)/2),c=e[Math.floor(m)]}d||(f===e[u].value?(c=e[u],d=!0):f===e[p].value?(c=e[p],d=!0):f<e[u].value?(d=!1,c=null):f>e[u].value&&(f<e[p].value?(c=e[u],d=!0):p===r-1?(d=!1,c=null):(c=e[p],d=!0))),d?(y[x]=c.mappedColor[0],g[x]=c.mappedColor[1],w[x]=c.mappedColor[2],k[x]=c.mappedColor[3]):y[x]=g[x]=w[x]=k[x]=0}return n.pixels=[y,g,w],n.mask=k,n.pixelType="u8",n.maskIsAlpha=M,n}function h(t,n){if(!t||0===t.length)return null;const i=t.find((t=>t.pixelBlock));if(!i||e(i.pixelBlock))return null;const l=(i.extent.xmax-i.extent.xmin)/i.pixelBlock.width,o=(i.extent.ymax-i.extent.ymin)/i.pixelBlock.height,r=.01*Math.min(l,o),s=t.sort(((t,e)=>Math.abs(t.extent.ymax-e.extent.ymax)>r?e.extent.ymax-t.extent.ymax:Math.abs(t.extent.xmin-e.extent.xmin)>r?t.extent.xmin-e.extent.xmin:0)),a=Math.min.apply(null,s.map((t=>t.extent.xmin))),h=Math.min.apply(null,s.map((t=>t.extent.ymin))),f=Math.max.apply(null,s.map((t=>t.extent.xmax))),u=Math.max.apply(null,s.map((t=>t.extent.ymax))),p={x:Math.round((n.xmin-a)/l),y:Math.round((u-n.ymax)/o)},x={width:Math.round((f-a)/l),height:Math.round((u-h)/o)},m={width:Math.round((n.xmax-n.xmin)/l),height:Math.round((n.ymax-n.ymin)/o)};return Math.round(x.width/i.pixelBlock.width)*Math.round(x.height/i.pixelBlock.height)!==s.length||p.x<0||p.y<0||x.width<m.width||x.height<m.height?null:{extent:n,pixelBlock:c(s.map((t=>t.pixelBlock)),x,{clipOffset:p,clipSize:m})}}function f(t,e,n,i,l,o){const{width:r,height:s}=n.block,{x:a,y:h}=n.offset,{width:f,height:c}=n.mosaic,u=function(t,e,n,i,l,o,r,s){return{xmin:l<=n*t?0:l<n*t+t?l-n*t:t,ymin:o<=i*e?0:o<i*e+e?o-i*e:e,xmax:l+r<=n*t?0:l+r<n*t+t?l+r-n*t:t,ymax:o+s<=i*e?0:o+s<i*e+e?o+s-i*e:e}}(r,s,i,l,a,h,f,c);let p=0,x=0;if(o){const t=o.hasGCSSShiftTransform?360:o.halfWorldWidth,e=r*o.resolutionX,n=o.startX+i*e,l=n+e;n<t&&l>t?x=o.rightPadding:n>=t&&(p=o.leftMargin-o.rightPadding,x=0)}if(u.xmax-=x,"number"!=typeof e)for(let n=u.ymin;n<u.ymax;n++){const o=(l*s+n-h)*f+(i*r-a)+p,c=n*r;for(let n=u.xmin;n<u.xmax;n++)t[o+n]=e[c+n]}else for(let n=u.ymin;n<u.ymax;n++){const o=(l*s+n-h)*f+(i*r-a)+p;for(let n=u.xmin;n<u.xmax;n++)t[o+n]=e}}function c(l,o,r={}){const{clipOffset:s,clipSize:a,alignmentInfo:h,blockWidths:c}=r;if(c)return function(l,o,r){const s=l.find((e=>t(e)));if(e(s))return null;const a=l.some((e=>!t(e)||!!e.mask)),{width:h,height:f}=o,c=a?new Uint8Array(h*f):null,{blockWidths:u}=r,p=[],x=s.getPlaneCount(),m=n.getPixelArrayConstructor(s.pixelType);if(a)for(let t=0,e=0;t<l.length;e+=u[t],t++){const n=l[t];if(!i(n))continue;const o=n.mask;for(let i=0;i<f;i++)for(let l=0;l<u[t];l++)c[i*h+l+e]=null==o?255:o[i*n.width+l]}for(let t=0;t<x;t++){const e=new m(h*f);for(let n=0,o=0;n<l.length;o+=u[n],n++){const r=l[n];if(!i(r))continue;const s=r.pixels[t];if(null!=s)for(let t=0;t<f;t++)for(let i=0;i<u[n];i++)e[t*h+i+o]=s[t*r.width+i]}p.push(e)}const d=new n({width:h,height:f,mask:c,pixels:p,pixelType:s.pixelType});return d.updateStatistics(),d}(l,o,{blockWidths:c});const u=l.find((t=>i(t)));if(e(u))return null;const p=a?a.width:o.width,x=a?a.height:o.height,m=u.width,d=u.height,y=o.width/m,g=o.height/d,w={offset:s||{x:0,y:0},mosaic:a||o,block:{width:m,height:d}},k=u.pixelType,M=n.getPixelArrayConstructor(k),A=u.pixels.length,U=[];let C,T,S;for(let t=0;t<A;t++){T=new M(p*x);for(let e=0;e<g;e++)for(let n=0;n<y;n++){const o=l[e*y+n];i(o)&&(C=o.pixels[t],f(T,C,w,n,e,h))}U.push(T)}if(l.some((t=>e(t)||t.mask&&t.mask.length>0))){S=new Uint8Array(p*x);for(let e=0;e<g;e++)for(let n=0;n<y;n++){const i=l[e*y+n];f(S,(t(i)?i.mask:null)||(i?1:0),w,n,e,h)}}const B=new n({width:p,height:x,pixels:U,pixelType:k,mask:S});return B.updateStatistics(),B}function u(t,e,n){if(!i(t))return null;const{width:l,height:o}=t,r=e.x,s=e.y,a=n.width+r,h=n.height+s;if(r<0||s<0||a>l||h>o)return t;if(0===r&&0===s&&a===l&&h===o)return t;t.mask||(t.mask=new Uint8Array(l*o));const f=t.mask;for(let t=0;t<o;t++){const e=t*l;for(let n=0;n<l;n++)f[e+n]=t<s||t>=h||n<r||n>=a?0:1}return t.updateStatistics(),t}function p(t){if(0===t.size)return 0;let e=0,n=-1,i=0;const l=t.keys();let o=l.next();for(;!o.done;)i=t.get(o.value),i>e&&(n=o.value,e=i),o=l.next();return n}function x(t,e,n){if(0===n)return;const i=t.get(e);1===i?t.delete(e):t.set(e,i-1)}function m(t,e,n){0!==n&&t.set(e,t.has(e)?t.get(e)+1:1)}function d(t,e,l){let{x:o,y:r}=e;const{width:s,height:a}=l;if(0===o&&0===r&&a===t.height&&s===t.width)return t;const{width:h,height:f}=t,c=Math.max(0,r),u=Math.max(0,o),p=Math.min(o+s,h),x=Math.min(r+a,f);if(p<0||x<0||!i(t))return null;o=Math.max(0,-o),r=Math.max(0,-r);const{pixels:m,mask:d}=t,y=s*a,g=m.length,w=[];for(let e=0;e<g;e++){const i=m[e],l=n.createEmptyBand(t.pixelType,y);for(let t=c;t<x;t++){const e=t*h;let n=(t+r-c)*s+o;for(let t=u;t<p;t++)l[n++]=i[e+t]}w.push(l)}const k=new Uint8Array(y);for(let t=c;t<x;t++){const e=t*h;let n=(t+r-c)*s+o;for(let t=u;t<p;t++)k[n++]=d?d[e+t]:1}const M=new n({width:l.width,height:l.height,pixelType:t.pixelType,pixels:w,mask:k});return M.updateStatistics(),M}function y(t,e=!0){if(!i(t))return null;const{pixels:l,width:o,height:r,mask:s,pixelType:a}=t,h=[],f=Math.round(o/2),c=Math.round(r/2),u=r-1,p=o-1;for(let t=0;t<l.length;t++){const i=l[t],s=n.createEmptyBand(a,f*c);let x=0;for(let t=0;t<r;t+=2)for(let n=0;n<o;n+=2){const l=i[t*o+n];if(e){const e=n===p?l:i[t*o+n+1],r=t===u?l:i[t*o+n+o],a=n===p?r:t===u?e:i[t*o+n+o+1];s[x++]=(l+e+r+a)/4}else s[x++]=l}h.push(s)}let x=null;if(s){x=new Uint8Array(f*c);let t=0;for(let n=0;n<r;n+=2)for(let i=0;i<o;i+=2){const l=s[n*o+i];if(e){const e=i===p?l:s[n*o+i+1],r=n===u?l:s[n*o+i+o],a=i===p?r:n===u?e:s[n*o+i+o+1];x[t++]=l*e*r*a?1:0}else x[t++]=l}}return new n({width:f,height:c,pixelType:a,pixels:h,mask:x})}function g(t,e,n){if(!i(t))return null;const{width:l,height:o}=e;let{width:r,height:s}=t;const a=new Map,h={x:0,y:0},f=null==n?1:1+n;let c=t;for(let t=0;t<f;t++){const n=Math.ceil(r/l),i=Math.ceil(s/o);for(let r=0;r<i;r++){h.y=r*o;for(let i=0;i<n;i++){h.x=i*l;const n=d(c,h,e);a.set(`${t}/${r}/${i}`,n)}}t<f-1&&(c=y(c)),r=Math.round(r/2),s=Math.round(s/2)}return a}function w(t,e,n,i,l=.5){const{width:o,height:r}=t,{width:s,height:a}=e,h=i.cols,f=i.rows,c=Math.ceil(s/h-.1/h),u=Math.ceil(a/f-.1/f);let p,x,m,d,y,g,w;const k=c*h,M=k*u*f,A=new Float32Array(M),U=new Float32Array(M),C=new Uint32Array(M),T=new Uint32Array(M);let S,B,b=0;for(let t=0;t<u;t++)for(let e=0;e<c;e++){p=12*(t*c+e),x=n[p],m=n[p+1],d=n[p+2],y=n[p+3],g=n[p+4],w=n[p+5];for(let n=0;n<f;n++){b=(t*f+n)*k+e*h,B=(n+.5)/f;for(let t=0;t<n;t++)S=(t+.5)/h,A[b+t]=(x*S+m*B+d)*o-l,U[b+t]=(y*S+g*B+w)*r-l,C[b+t]=Math.round(A[b+t]),T[b+t]=Math.round(U[b+t])}p+=6,x=n[p],m=n[p+1],d=n[p+2],y=n[p+3],g=n[p+4],w=n[p+5];for(let n=0;n<f;n++){b=(t*f+n)*k+e*h,B=(n+.5)/f;for(let t=n;t<h;t++)S=(t+.5)/h,A[b+t]=(x*S+m*B+d)*o-l,U[b+t]=(y*S+g*B+w)*r-l,C[b+t]=Math.round(A[b+t]),T[b+t]=Math.round(U[b+t])}}return{offsets_x:A,offsets_y:U,offsets_xi:C,offsets_yi:T,gridWidth:k}}function k(t,e){const{coefficients:n,spacing:i}=e,{offsets_x:l,offsets_y:o,gridWidth:r}=w(t,t,n,{rows:i[0],cols:i[1]},.5),{width:s,height:a}=t,h=new Float32Array(s*a),f=180/Math.PI;for(let t=0;t<a;t++)for(let e=0;e<s;e++){const n=t*r+e,i=0===t?n:n-r,c=t===a-1?n:n+r,u=l[i]-l[c],p=o[c]-o[i];if(isNaN(u)||isNaN(p))h[t*s+e]=90;else{let n=Math.atan2(p,u)*f;n=(360+n)%360,h[t*s+e]=n}}return h}function M(t,e,l,o,r="nearest"){if(!i(t))return null;"majority"===r&&(t=function(t){if(!i(t))return null;const e=t.clone(),{width:n,height:l,pixels:o,mask:r}=t,s=o[0],a=e.pixels[0];for(let t=2;t<l-1;t++){const e=new Map;for(let i=t-2;i<t+2;i++)for(let t=0;t<4;t++){const l=i*n+t;m(e,s[l],r?r[l]:1)}a[t*n]=p(e),a[t*n+1]=a[t*n+2]=a[t*n];let i=3;for(;i<n-1;i++){let l=(t-2)*n+i+1;m(e,s[l],r?r[l]:1),l=(t-1)*n+i+1,m(e,s[l],r?r[l]:1),l=t*n+i+1,m(e,s[l],r?r[l]:1),l=(t+1)*n+i+1,m(e,s[l],r?r[l]:1),l=(t-2)*n+i-3,x(e,s[l],r?r[l]:1),l=(t-1)*n+i-3,x(e,s[l],r?r[l]:1),l=t*n+i-3,x(e,s[l],r?r[l]:1),l=(t+1)*n+i-3,x(e,s[l],r?r[l]:1),a[t*n+i]=p(e)}a[t*n+i+1]=a[t*n+i]}for(let t=0;t<n;t++)a[t]=a[n+t]=a[2*n+t],a[(l-1)*n+t]=a[(l-2)*n+t];return e.updateStatistics(),e}(t));const{pixels:s,mask:a,pixelType:h}=t,f=t.width,c=t.height,u=n.getPixelArrayConstructor(h),d=s.length,{width:y,height:g}=e;let k=!1;for(let t=0;t<l.length;t+=3)-1===l[t]&&-1===l[t+1]&&-1===l[t+2]&&(k=!0);const{offsets_x:M,offsets_y:A,offsets_xi:U,offsets_yi:C,gridWidth:T}=w({width:f,height:c},e,l,o,"majority"===r?0:.5);let S;const B=(t,e,n)=>{const i=t instanceof Float32Array||t instanceof Float64Array?0:.5;for(let l=0;l<g;l++){S=l*T;for(let o=0;o<y;o++){if(M[S]<0||A[S]<0)t[l*y+o]=0;else if(n)t[l*y+o]=e[U[S]+C[S]*f];else{const n=Math.floor(M[S]),r=Math.floor(A[S]),s=Math.ceil(M[S]),h=Math.ceil(A[S]),c=M[S]-n,u=A[S]-r;if(!a||a[n+r*f]&&a[n+r*f]&&a[n+h*f]&&a[s+h*f]){const a=(1-c)*e[n+r*f]+c*e[s+r*f],p=(1-c)*e[n+h*f]+c*e[s+h*f];t[l*y+o]=(1-u)*a+u*p+i}else t[l*y+o]=e[U[S]+C[S]*f]}S++}}},b=[];let v;for(let t=0;t<d;t++)v=new u(y*g),B(v,s[t],"nearest"===r||"majority"===r),b.push(v);const P=new n({width:y,height:g,pixelType:h,pixels:b});if(a)P.mask=new Uint8Array(y*g),B(P.mask,a,!0);else if(k){P.mask=new Uint8Array(y*g);for(let t=0;t<y*g;t++)P.mask[t]=M[t]<0||A[t]<0?0:1}return P.updateStatistics(),P}export{o as a,u as b,r as c,M as d,l as e,d as f,k as g,h,i,s as l,c as m,a as r,g as s};
