/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{a as t,i as e,e as s,d as r}from"./maybe.js";import{c as i,m as a,d as o,r as n,n as h}from"./mat4.js";import{c,b as m,I as l}from"./mat4f64.js";import{w as u,G as d,v as f,q as g,a as p,f as _,s as y,h as b,J as v,M as j,O as A}from"./mathUtils.js";import{c as x,b as S}from"./sphere.js";import{m as O}from"./mathUtils2.js";import{O as M,U as T,R}from"./basicInterfaces.js";import{C as L,b as V,g as P}from"./Material.js";import{O as w}from"./ArrayPool.js";import{g as I}from"./watch.js";import{a as E}from"./Util.js";import{a as U,r as B}from"./utils4.js";import C from"../core/Evented.js";import D from"../core/Handles.js";import{P as H}from"../core/scheduling.js";import{O as N}from"./Octree.js";import{d as W,O as z,c as G}from"./vec4f64.js";import{projectPoint as X}from"../geometry/projection.js";import{i as Z,m as q}from"./aaBoundingBox.js";import{c as F}from"./aaBoundingRect.js";import{g as k,a as Q,r as J}from"../geometry/Polygon.js";import{m as Y}from"./dehydratedFeatures.js";import $ from"../Graphic.js";import{clone as K,c as tt,d as et,t as st}from"../core/lang.js";import{fromJSON as rt}from"../geometry/support/jsonUtils.js";import{V as it}from"./VertexAttribute.js";import{d as at,w as ot,U as nt,F as ht,j as ct}from"./glUtil3D.js";import{a as mt}from"./RenderSlot.js";import{n as lt}from"./InterleavedLayout.js";import{a as ut}from"./vec2.js";import{a as dt}from"./vec2f64.js";function ft(t){return"declaredClass"in t}function gt(t){return"declaredClass"in t}function pt(t,e){if(!t)return null;if(function(t){return"declaredClass"in t}(t))return t;const s=new $({layer:e,sourceLayer:e});return s.visible=t.visible,s.symbol=K(t.symbol),s.attributes=K(t.attributes),s.geometry=_t(t.geometry),s}function _t(e){return t(e)?null:ft(e)?e:rt(function(t){const e=t.spatialReference.toJSON();switch(t.type){case"point":{const{x:s,y:r,z:i,m:a}=t;return{x:s,y:r,z:i,m:a,spatialReference:e}}case"polygon":{const{rings:s,hasZ:r,hasM:i}=t;return{rings:yt(s),hasZ:r,hasM:i,spatialReference:e}}case"polyline":{const{paths:s,hasZ:r,hasM:i}=t;return{paths:yt(s),hasZ:r,hasM:i,spatialReference:e}}case"extent":{const{xmin:s,xmax:r,ymin:i,ymax:a,zmin:o,zmax:n,mmin:h,mmax:c,hasZ:m,hasM:l}=t;return{xmin:s,xmax:r,ymin:i,ymax:a,zmin:o,zmax:n,mmin:h,mmax:c,hasZ:m,hasM:l,spatialReference:e}}case"multipoint":{const{points:s,hasZ:r,hasM:i}=t;return{points:vt(s)?bt(s):s,hasZ:r,hasM:i,spatialReference:e}}default:return}}(e))}function yt(t){return function(t){for(const e of t)if(0!==e.length)return vt(e);return!1}(t)?t.map((t=>bt(t))):t}function bt(t){return t.map((t=>st(t)))}function vt(t){return t.length&&(tt(t[0])||et(t[0]))}function jt(t,e){if(!t)return null;let s;if(gt(t)){if(null==e)return t.clone();if(gt(e))return e.copy(t)}return null!=e?(s=e,s.x=t.x,s.y=t.y,s.spatialReference=t.spatialReference,t.hasZ?(s.z=t.z,s.hasZ=t.hasZ):(s.z=null,s.hasZ=!1),t.hasM?(s.m=t.m,s.hasM=!0):(s.m=null,s.hasM=!1)):(s=Y(t.x,t.y,t.z,t.spatialReference),t.hasM&&(s.m=t.m,s.hasM=!0)),s}class At{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,e,s,r,i,a){this.id=I(),this.geometry=t,this.material=e,this.transformation=s,this.instanceParameters=r,this.origin=i,this._shaderTransformation=a,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return e(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(u(t,t,this.getStaticTransformation()),!0)}}At.pool=new w(At);class xt{constructor(t){this.channel=t,this.id=I()}}class St extends L{constructor(t={}){super(),this.type=V.Object,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=c(),this._bvObjectSpace=new Mt,this._bvWorldSpace=new Mt,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new Ot),this.transformation=c();const{geometries:e,materials:s,transformations:r,origins:i}=t;if(Array.isArray(e)){E(s.length===e.length,"Object3D: materials don't match geometries"),E(r.length===e.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=e.length,this._geometries.length=e.length;for(let t=0;t<e.length;t++)this._geometries[t]=e[t],this._geometryRecords[t]=At.pool.acquire(e[t],s[t],m(r[t]),{highlights:null,occludees:null,visible:this._visible},i&&i[t])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){i(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){E(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t,s,r,i,a){r=r||l,this._geometries.push(t);const o=At.pool.acquire(t,s,r,{highlights:null,occludees:null,visible:this._visible},i,a);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||e(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(t){const s=this._geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=e(s.shaderTransformation)?this._geometryRecords.some((t=>e(t.shaderTransformation))):this._hasVolatileTransformation,s.dispose(),this._geometries.splice(t,1),this._emit("objectGeometryRemoved",{object:this,record:s}),this._invalidateBoundingVolume(),s}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:t}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){if(this._visible!==t){this._visible=t;for(const t of this._geometryRecords)t.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new xt(M.MaskOccludee);for(const e of this._geometryRecords)e.instanceParameters.occludees=U(e.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const e of this._geometryRecords)e.instanceParameters.occludees=B(e.instanceParameters.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new xt(M.Highlight);for(const e of this._geometryRecords)e.instanceParameters.highlights=U(e.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const e of this._geometryRecords)e.instanceParameters.highlights=B(e.instanceParameters.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,e){return a(s(e,c()),this.transformation,t.getStaticTransformation())}_getCombinedShaderTransformation(t,e){return e=e||c(),a(e,this.transformation,t.getShaderTransformation()),e}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let t=0;t<this._geometryRecords.length;++t){const s=this._geometries[t],r=this._geometryRecords[t],i=s.boundingInfo;e(i)&&(this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,r.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this._getCombinedShaderTransformation(r)))}d(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),d(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const s=b(),r=b(),i=O(this.transformation);for(let e=0;e<this._geometryRecords.length;++e){const a=this._geometries[e].boundingInfo;if(t(a))continue;const o=this._geometryRecords[e].getShaderTransformation(),n=O(o);u(s,a.getCenter(),o);const h=f(s,this._bvObjectSpace.bounds),c=a.getBSRadius()*n;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],h+c),u(r,s,this.transformation);const m=f(r,this._bvWorldSpace.bounds),l=c*i;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],m+l)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,e,s){const r=t.getBBMin(),i=t.getBBMax(),a=g(r),o=g(i);u(a,a,s),u(o,o,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],a[t],o[t]),e.max[t]=Math.max(e.max[t],a[t],o[t]);for(let t=0;t<3;++t){p(a,r),p(o,i),a[t]=i[t],o[t]=r[t],u(a,a,s),u(o,o,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],a[t],o[t]),e.max[t]=Math.max(e.max[t],a[t],o[t])}}_invalidateBoundingVolume(){this._bvDirty=!0,e(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(t,s){e(this._parentLayer)&&this._parentLayer.events.emit(t,s)}get test(){const t=this;return{hasGeometry:e=>t._geometries.includes(e),getGeometryIndex:e=>t._geometries.indexOf(e)}}}class Ot{constructor(){this.min=_(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=_(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Mt extends Ot{constructor(){super(...arguments),this.bounds=x()}init(){y(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),y(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),S(this.bounds)}}const Tt=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];class Rt extends L{constructor(t,e=""){super(),this.apiLayerUid=e,this.type=V.Layer,this.events=new C,this.isSliceable=!1,this._objects=new H,this._stageHandles=new D,this.apiLayerUid=e,this.isVisible=t?.isVisible??!0,this.isPickable=t?.isPickable??!0,this.updatePolicy=t?.updatePolicy??T.ASYNC}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(t){this.detachStage(),this._stage=t;for(const e of Tt)this._stageHandles.add(this.events.on(e,(s=>t.handleEvent(e,s))))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(t){this._objects.push(t),t.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:t}),e(this._octree)&&this._octree.add([t])}remove(t){this._objects.removeUnordered(t)&&(t.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:t}),e(this._octree)&&this._octree.remove([t]))}addMany(t){this._objects.pushArray(t);for(const e of t)e.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:t}),e(this._octree)&&this._octree.add(t)}removeMany(t){const s=new Array;if(this._objects.removeUnorderedMany(t,t.length,s),0!==s.length){for(const t of s)t.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:s}),e(this._octree)&&this._octree.remove(s)}}sync(){e(this._stage)&&this.updatePolicy!==T.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(t,s){e(this._octree)&&this._octree.update(t,s)}getSpatialQueryAccelerator(){return t(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=r(this._octree)}_createOctree(){this._octree=new N((t=>t.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)}}function Lt(t){return e(t)&&t.type===V.Layer}function Vt(t,e){if("point"===t.type)return wt(t,e,!1);if(ft(t))switch(t.type){case"extent":return wt(t.center,e,!1);case"polygon":return wt(t.centroid,e,!1);case"polyline":return wt(Pt(t),e,!0);case"mesh":return wt(t.origin,e,!1)}else switch(t.type){case"extent":return wt(function(t){const e=isFinite(t.zmin);return Y(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),e?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}(t),e,!0);case"polygon":return wt(function(t){const e=t.rings[0];if(!e||0===e.length)return null;const s=J(t.rings,t.hasZ);return Y(s[0],s[1],s[2],t.spatialReference)}(t),e,!0);case"polyline":return wt(Pt(t),e,!0)}}function Pt(t){const e=t.paths[0];if(!e||0===e.length)return null;const s=k(e,Q(e)/2);return Y(s[0],s[1],s[2],t.spatialReference)}function wt(t,e,s){const r=s?t:jt(t);return e&&t?X(t,r,e)?r:null:r}function It(t,e,s,r=0){if(t){e||(e=F());const i=t;let a=.5*i.width*(s-1),o=.5*i.height*(s-1);return i.width<1e-7*i.height?a+=o/20:i.height<1e-7*i.width&&(o+=a/20),v(e,i.xmin-a-r,i.ymin-o-r,i.xmax+a+r,i.ymax+o+r),e}return null}function Et(t,e){for(let s=0;s<t.geometries.length;++s){const r=t.geometries[s].getMutableAttribute(it.AUXPOS1);r&&r.data[3]!==e&&(r.data[3]=e,t.geometryVertexAttrsUpdated(t.geometryRecords[s]))}}function Ut(t,s){const r=W(z);return e(t)&&(r[0]=t[0],r[1]=t[1],r[2]=t[2]),e(s)?r[3]=s:e(t)&&t.length>3&&(r[3]=t[3]),r}function Bt(t,s,r,i,a,o=[0,0,0,0]){for(let s=0;s<3;++s)e(t)&&null!=t[s]?o[s]=t[s]:e(r)&&null!=r[s]?o[s]=r[s]:o[s]=a[s];return e(s)?o[3]=s:e(i)?o[3]=i:o[3]=a[3],o}function Ct(e=A,s,r,i=1){const a=new Array(3);if(t(s)||t(r))a[0]=1,a[1]=1,a[2]=1;else{let t,i=0;for(let o=2;o>=0;o--){const n=e[o];let h;const c=null!=n,m=0===o&&!t&&!c,l=r[o];"symbol-value"===n||m?h=0!==l?s[o]/l:1:c&&"proportional"!==n&&isFinite(n)&&(h=0!==l?n/l:1),null!=h&&(a[o]=h,t=h,i=Math.max(i,Math.abs(h)))}for(let e=2;e>=0;e--)null==a[e]?a[e]=t:0===a[e]&&(a[e]=.001*i)}for(let t=2;t>=0;t--)a[t]/=i;return j(a)}function Dt(t){return null!=t.isPrimitive&&(t=[t.width,t.depth,t.height]),Ht(t)?null:"Symbol sizes may not be negative values"}function Ht(t){if(Array.isArray(t)){for(const e of t)if(!Ht(e))return!1;return!0}return null==t||t>=0}function Nt(t,e,s,r=c()){const i=t||0,a=e||0,m=s||0;return 0!==i&&o(r,r,-i/180*Math.PI),0!==a&&n(r,r,a/180*Math.PI),0!==m&&h(r,r,m/180*Math.PI),r}function Wt(t,e){return null!=e.minDemResolution?e.minDemResolution:Z(t)?e.minDemResolutionForPoints:.01*q(t)}class zt{constructor(t,e){this._material=t,this._repository=e,this._map=new Map}destroy(){this._map.forEach(((t,s)=>{e(t)&&this._repository.release(this._material,Gt(s))}))}load(t,s){this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,Gt(s)));const r=this._map.get(s);if(e(r)){if(r.ensureResources(t)===R.LOADED)return r;this._repository.requestRender()}return null}}function Gt(t){switch(t){case mt.MATERIAL:return at.Color;case mt.MATERIAL_ALPHA:return at.Alpha;case mt.MATERIAL_DEPTH:return at.Depth;case mt.MATERIAL_NORMAL:return at.Normal;case mt.MATERIAL_DEPTH_SHADOWMAP_ALL:return at.Shadow;case mt.MATERIAL_HIGHLIGHT:return at.Highlight;case mt.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:case mt.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return at.Shadow}}const Xt=lt().vec3f(it.POSITION),Zt=lt().vec3f(it.POSITION).vec2f(it.UV0),qt=lt().vec3f(it.POSITION).vec4u8(it.COLOR);class Ft{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(it.POSITION).length}write(t,e,s,r){ot(e,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,s,r)}}class kt extends nt{constructor(t){super(t,"float")}}class Qt extends nt{constructor(t){super(t,"sampler2D")}}class Jt extends nt{constructor(t){super(t,"vec4")}}function Yt(t,e=!0){t.attributes.add(it.POSITION,"vec2"),e&&t.varyings.add("uv","vec2"),t.vertex.code.add(P`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e?P`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}function $t(t){t.fragment.uniforms.add(new ht("projInfo",((t,e)=>function(t){const e=t.camera.projectionMatrix;return 0===e[11]?v(Kt,2/(t.camera.fullWidth*e[0]),2/(t.camera.fullHeight*e[5]),(1+e[12])/e[0],(1+e[13])/e[5]):v(Kt,-2/(t.camera.fullWidth*e[0]),-2/(t.camera.fullHeight*e[5]),(1-e[8])/e[0],(1-e[9])/e[5])}(e)))),t.fragment.uniforms.add(new ct("zScale",((t,e)=>te(e)))),t.fragment.code.add(P`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}const Kt=G();function te(t){return 0===t.camera.projectionMatrix[11]?ut(ee,0,1):ut(ee,1,0)}const ee=dt();export{$t as C,Ft as D,kt as F,zt as G,St as O,Zt as P,Yt as S,Qt as T,Rt as W,Vt as a,qt as b,jt as c,Xt as d,Jt as e,pt as f,te as g,_t as h,At as i,Lt as j,Wt as k,xt as l,Ut as m,Ct as n,Gt as o,Nt as p,Ht as q,It as r,Bt as s,Et as u,Dt as v};
