/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{n as t}from"./compilerUtils.js";import{r as s,p as r,d as n,i,a}from"./maybe.js";import{f as o,h as l,m as u,b as c}from"../geometry/SpatialReference.js";import{g as h}from"./layerUtils.js";import{V as f}from"./ViewingMode.js";import{_ as m}from"./tslib.es6.js";import p from"../request.js";import d from"../core/Accessor.js";import{r as g,clone as _}from"../core/lang.js";import T from"../core/Error.js";import{createResolver as k,onAbort as S,createAbortError as y,throwIfAborted as E,isAbortError as b}from"../core/promiseUtils.js";import{property as O}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as w}from"../core/accessorSupport/decorators/subclass.js";import{a as W}from"./Util.js";import{T as L}from"./Scheduler.js";import{N}from"./interfaces2.js";import{h as A,a as R,d as x,j as I,b as j,o as D}from"./mathUtils.js";import{canProjectToWGS84ComparableLonLat as C}from"../geometry/projection.js";import{k as H,l as v,f as Q,c as U}from"./aaBoundingRect.js";import{g as q,T as M,M as z}from"./TerrainConst.js";class F{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new G}}class G{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class V{constructor(e,t,s,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=r.map((e=>new F(e)))}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,W(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}let B=class extends d{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,s){this._loadQueue=new V(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),s&&(this._frameTask=s.registerTask(L.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=s(this._frameTask),this._tasks.forEach((e=>r(e.abortController))),this._loadQueue=n(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,s,r={}){const n=k();n.__signal=i(r)?r.signal:null;const a=this._createOrUpdateTask(e,t,s,r,n);return S(r,(()=>this._cancelRequest(a,n))),n.promise}_createTask(e,t,s,r,n,i){const a=new $(e,t,s,r,n);return this._updateTask(a,i),this._tasks.set(n,a),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,t){g(e.resolvers,t),t.reject(y()),0===e.resolvers.length&&(e.status===J.DOWNLOADING&&(e.status=J.CANCELLED,this._loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=J.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,s,r,n){const a=function(e,t,s){return`${e}:${t}:${s}`}(i(r)&&r.uid||e,t,s),o=this._tasks.get(a);return o?(this._updateTask(o,n),o):this._createTask(e,r,t,s,a,n)}_doneLoadingCB(e,t){this._loadQueue&&(W(e.status===J.DOWNLOADING),e.status=J.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();E(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==J.DOWNLOADED&&(t.err=t.err||y()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!b(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)b(t)?r.reject(t):r.reject(new T("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s<=0?e.result:_(e.result);r.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===J.CANCELLED)return!1;let s,r;switch(e.startTime=performance.now(),e.status=J.DOWNLOADING,e.docType){case"binary":r="array-buffer",s=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=p(e.url,{...e.options,responseType:r,timeout:s,signal:n});let i=()=>{};const a=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},o=s=>{e.status===J.DOWNLOADING&&t(e,s),i()};return"image+type"!==e.docType?(e.request.then((e=>a(e.data)),o),!0):(e.request.then((t=>{const l=t.data,u=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(l);if(r="image",e.size=l.byteLength,"unknown"===u)return e.request=p(e.url,{responseType:r,timeout:s,signal:n}),void e.request.then((e=>a(e.data)),o);const c=new Blob([l],{type:u}),h=window.URL.createObjectURL(c);i=()=>window.URL.revokeObjectURL(h),e.request=p(h,{responseType:r,timeout:s,signal:n}),e.request.then((e=>a(new P(e.data,u,i))),o)}),o),!0)}get test(){return{loadQueue:this._loadQueue}}};m([O({readOnly:!0})],B.prototype,"updating",void 0),B=m([w("esri.views.3d.support.StreamDataLoader")],B);class P{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}class $ extends class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}{constructor(e,t,s,r,n){super(r),this.url=e,this.options=t,this.docType=s,this.key=n,this.result=null,this.status=J.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=0}}var J;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(J||(J={}));const K=A(),X=A(),Y=A(),Z=A();function ee(e,t,s,r){R(K,s),K[r]=t[r];const n=x(K,K,t),i=x(X,e,t),a=I(i,n),o=I(n,n);let l;l=a<=0?t:o<=a?s:j(K,t,D(n,n,a/o));const u=x(K,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}const te=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:function(e,t,s=0){const r=e.extent;if(a(r))return!1;if(0===s)return H(r,t);const n=Math.min(r[2]-r[0],r[3]-r[1]);return v(r,t,s*n)},tiltToExtentEdge:function(e,t,s){const r=e.extent;if(a(r))return 0;Y[0]=r[0],Y[1]=r[1],Y[2]=s,Z[0]=r[2],Z[1]=r[3],Z[2]=s;let n=1/0,i=1/0;return t[0]<Y[0]?n=ee(t,Y,Z,0):t[0]>Z[0]&&(n=ee(t,Z,Y,0)),t[1]<Y[1]?i=ee(t,Y,Z,1):t[1]>Z[1]&&(i=ee(t,Z,Y,1)),Math.min(n,i)},checkIfTileInfoSupportedForViewSR:function(e,t,s){if(a(e))return q();if(e.spatialReference.isGeographic&&!C(e.spatialReference))return new T("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=M.checkUnsupported(e);if(i(r))return r;if(a(s))return new T("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const n=function(e,t){const s=e.lods,r=s[0].resolution*2**s[0].level,n=[r*e.size[0],r*e.size[1]],i=[e.origin.x,e.origin.y],a=Q(t),o=U();M.computeRowColExtent(a,n,i,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>z){const t=s[0].scale*2**s[0].level;let n=Math.max((a[3]-a[1])/e.size[1],(a[2]-a[0])/e.size[0])*t/r;const i=Math.floor(Math.log(n)/Math.log(10));return n=Math.ceil(n/10**i)*10**i,new T("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+n.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:n,requiredNumRootTiles:l,allowedNumRootTiles:z})}return null}(e,s);if(n)return n;const o=e.spatialReference;return i(t)&&!(o.equals(t)||t.isWGS84&&o.isWebMercator)?new T("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}},Symbol.toStringTag,{value:"Module"})),se=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){if(a(e))return q();const s=e.lods.length-1,r=e.spatialReference,n=C(r)||o(r)||l(r);if(r.isWebMercator){if(!M.makeWebMercatorAuxiliarySphere(s).compatibleWith(e))return new T("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!n)return new T("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!M.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e))return e.spatialReference.isWGS84?new T("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new T("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return i(t)&&!e.spatialReference.equals(t)?new T("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}},Symbol.toStringTag,{value:"Module"})),re={[f.Global]:se,[f.Local]:te};function ne(e,t){e||console.warn("Terrain: "+t)}function ie(e,t){}function ae(e){return le(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function oe(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function le(e){return"imagery-tile-3d"===e?.type}function ue(e){return"tile-3d"===e?.type}function ce(e){return"vector-tile-3d"===e?.type}function he(e){return"wmts-3d"===e?.type}function fe(e){return"elevation-3d"===e?.type}function me(e){return"group"===e?.type}function pe(e){return e&&(ue(e)||he(e)||le(e)||ce(e))}function de(e){return e&&(ue(e)||le(e)||ce(e)||he(e))}function ge(e){return de(e)||fe(e)}function _e(e){switch(e.type){case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"line-of-sight":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return t(e.type),!1}}function Te(e){const t=e?.sourceLayerInfo?.data;return i(t)&&"type"in t&&"raster-tile"===t.type}function ke(e){const t=e?.sourceLayerInfo?.data;return i(t)&&"type"in t&&"vector-tile"===t.type}function Se(e){const t=e?.sourceLayerInfo?.data;return i(t)&&"type"in t&&"tile-texture"===t.type}function ye(e){const t=e?.sourceLayerInfo?.data;return t instanceof HTMLImageElement||t instanceof P||t instanceof HTMLCanvasElement||t instanceof ImageData}function Ee(e){return i(e)&&"release"in e&&e.release(),null}function be(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function Oe(e,t,s,r){return re[r].checkIfTileInfoSupportedForViewSR(e,s,t)}function we(e,t,s){let r=null,n=null;if("wmts"===e?.type){const i=We(e,t,s);r=i.tileInfo,n=i.fullExtent}else{n=oe(e)?e.getCompatibleFullExtent(t):e.fullExtent;const i=s===f.Local;if(oe(e))r=e.getCompatibleTileInfo(t,n,i);else if("vector-tile"===e?.type){const s=i&&!Le(t)||Ne.force512VTL,n=e.tileInfo.spatialReference.isGeographic;r=s?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,n?1:2)}else r=e.tileInfo}return i(r)&&i(n)&&null==Oe(r,n,t,s)?{tileInfo:r,fullExtent:n}:null}function We(t,s,r){const n=h(t);if(i(n)){if(!e.isCollection(n))return{tileInfo:n.tileInfo,fullExtent:n.fullExtent};{const e=n.find((e=>null==Oe(e.tileInfo,e.fullExtent,s,r)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function Le(e){return e.isWGS84||e.isWebMercator||u(e)||!c(e)}const Ne={force512VTL:!1};function Ae(e){return e===N.NORTH_EAST?N.SOUTH_WEST:e===N.NORTH_WEST?N.SOUTH_EAST:e===N.SOUTH_WEST?N.NORTH_EAST:N.NORTH_WEST}function Re(e){return e===N.NORTH?N.SOUTH:e===N.EAST?N.WEST:e===N.SOUTH?N.NORTH:N.EAST}function xe(e){return e===N.NORTH_WEST||e===N.SOUTH_WEST}function Ie(e){return e===N.NORTH_WEST||e===N.NORTH_EAST}function je(e){return e===N.NORTH_WEST||e===N.WEST||e===N.SOUTH_WEST}function De(e){return e===N.NORTH_EAST||e===N.EAST||e===N.SOUTH_EAST}function Ce(e){return e===N.SOUTH_EAST||e===N.SOUTH||e===N.SOUTH_WEST}function He(e){return e===N.NORTH_EAST||e===N.NORTH||e===N.NORTH_WEST}const ve=[N.NORTH,N.EAST,N.SOUTH,N.WEST],Qe=[N.NORTH_EAST,N.SOUTH_EAST,N.SOUTH_WEST,N.NORTH_WEST];export{fe as A,be as B,le as C,ue as D,Oe as E,We as F,Le as G,Ne as H,P as I,B as S,ge as a,oe as b,ie as c,ae as d,pe as e,ve as f,we as g,Re as h,_e as i,He as j,Ce as k,je as l,De as m,Qe as n,Ae as o,xe as p,Ie as q,Ee as r,me as s,ce as t,ke as u,Te as v,ne as w,ye as x,Se as y,de as z};
