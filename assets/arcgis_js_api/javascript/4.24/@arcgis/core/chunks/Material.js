/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{a as e,i as t}from"./maybe.js";import{g as a}from"./watch.js";import{V as r}from"./VertexAttribute.js";import{u as i}from"../core/lang.js";import{H as n,g as s,c as l,s as o,k as c,n as u,h as d}from"./mathUtils.js";import{a as f,b as m,d as h}from"./aaBoundingBox.js";import{P as p}from"./basicInterfaces.js";import{V as g}from"./ViewingMode.js";import{a as v}from"./Util.js";import{i as O}from"./utils4.js";class x{constructor(){this.id=a()}unload(){}}var P;!function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry",e[e.Material=3]="Material",e[e.Texture=4]="Texture",e[e.COUNT=5]="COUNT"}(P||(P={}));class M{}function A(e,...t){let a="";for(let r=0;r<t.length;r++)a+=e[r]+t[r];return a+=e[e.length-1],a}!function(e){e.int=function(e){return Math.round(e).toString()},e.float=function(e){return e.toPrecision(8)}}(A||(A={}));const b=new Map([[r.POSITION,0],[r.NORMAL,1],[r.UV0,2],[r.COLOR,3],[r.SIZE,4],[r.TANGENT,4],[r.AUXPOS1,5],[r.SYMBOLCOLOR,5],[r.AUXPOS2,6],[r.FEATUREATTRIBUTE,6],[r.INSTANCEFEATUREATTRIBUTE,6],[r.INSTANCECOLOR,7],[r.MODEL,8],[r.MODELNORMAL,12],[r.MODELORIGINHI,11],[r.MODELORIGINLO,15]]);function F(e,t){return new y(e,N,t)}function T(e,t){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:i}=N;return new y(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:R.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:R.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:i,minPixelSize:R.minPixelSize},t)}function S(e,t,a){const r=a.parameters,i=a.paddingPixelsOverride;return D.scale=Math.min(r.divisor/(t-r.offset),1),D.factor=function(e){return Math.abs(e*e*e)}(e),D.minPixelSize=r.minPixelSize,D.paddingPixels=i,D}function C(e,t){return 0===e?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function _(e,t){return Math.max(n(e*t.scale,e,t.factor),C(e,t))}function I(e,t,a,r){r.scale=function(e,t,a){const r=S(e,t,a);return r.minPixelSize=0,r.paddingPixels=0,_(1,r)}(e,t,a),r.factor=0,r.minPixelSize=a.parameters.minPixelSize,r.paddingPixels=a.paddingPixelsOverride}function L(e,t,a=[0,0]){const r=Math.min(Math.max(t.scale,C(e[1],t)/Math.max(1e-5,e[1])),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}class y{constructor(e,t,a,r={camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0},i){this.viewingMode=e,this.description=t,this.ellipsoidRadius=a,this.parameters=r,this._paddingPixelsOverride=i,this.viewingMode===g.Local?(this.coverageCompensation=this._surfaceCoverageCompensationLocal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this.coverageCompensation=this._surfaceCoverageCompensationGlobal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this.ellipsoidRadius,this.parameters),0))}overridePadding(e){return e!==this.paddingPixelsOverride?new y(this.viewingMode,this.description,this.ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,a){const{scaleStart:r,scaleFallOffRange:i,minPixelSize:n}=this.description,{fovY:s,distance:l}=e,o=this.calculateCurvatureDependentParameters(e,t),c=this.coverageCompensation(e,t,o),{tiltAngle:u,scaleFallOffFactor:d}=o,f=Math.sin(u)*l,m=.5*Math.PI-u-s*(.5-r*c),h=f/Math.cos(m),p=m+s*i*c,g=(h-d*(f/Math.cos(p)))/(1-d);return a.camera.fovY=e.fovY,a.camera.distance=e.distance,a.offset=g,a.divisor=h-g,a.minPixelSize=n,a}_calculateCurvatureDependentParametersLocal(e,t,a=E){return a.tiltAngle=this.description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this.description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(e,t,a=E){const r=this.description.curvatureDependent,i=1+e.distance/t,s=Math.sqrt(i*i-1),[o,c]=[r.min.curvature,r.max.curvature],u=l((s-o)/(c-o),0,1),[d,f]=[r.min,r.max];return a.tiltAngle=n(d.tiltAngle,f.tiltAngle,u),a.scaleFallOffFactor=n(d.scaleFallOffFactor,f.scaleFallOffFactor,u),a}_surfaceCoverageCompensationLocal(e,t,a){return(e.fovY-a.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,t,a){const r=t*t,i=a.tiltAngle+.5*Math.PI,{fovY:n,distance:s}=e,l=s*s+r-2*Math.cos(i)*s*t,o=Math.sqrt(l),c=Math.sqrt(l-r);return(Math.acos(c/o)-Math.asin(t/(o/Math.sin(i)))+.5*n)/n}}const N={curvatureDependent:{min:{curvature:s(10),tiltAngle:s(12),scaleFallOffFactor:.5},max:{curvature:s(70),tiltAngle:s(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},R={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14},D={scale:0,factor:0,minPixelSize:0,paddingPixels:0},E={tiltAngle:0,scaleFallOffFactor:0},z=f();function V(e,t,a,i,n,s,l){if(!O(t))if(e.boundingInfo){v(e.primitiveType===p.Triangle);const t=a.tolerance;U(e.boundingInfo,i,n,t,s,l)}else{const t=e.indices.get(r.POSITION),a=e.vertexAttributes.get(r.POSITION);w(i,n,0,t.length/3,t,a,void 0,s,l)}}const j=d();function U(a,r,i,n,s,l){if(e(a))return;const o=W(r,i,j);if(m(z,a.getBBMin()),h(z,a.getBBMax()),t(s)&&s.applyToAabb(z),k(z,r,o,n)){const{primitiveIndices:e,indices:t,position:o}=a,c=e?e.length:t.length/3;if(c>ee){const e=a.getChildren();if(void 0!==e){for(let t=0;t<8;++t)void 0!==e[t]&&U(e[t],r,i,n,s,l);return}}w(r,i,0,c,t,o,e,s,l)}}const Y=d();function w(e,a,r,i,n,s,l,o,c){if(l)return function(e,a,r,i,n,s,l,o,c){const u=s.data,d=s.stride||s.size,f=e[0],m=e[1],h=e[2],p=a[0]-f,g=a[1]-m,v=a[2]-h;for(let e=r;e<i;++e){const a=l[e];let r=3*a,i=d*n[r++],s=u[i++],O=u[i++],x=u[i];i=d*n[r++];let P=u[i++],M=u[i++],A=u[i];i=d*n[r];let b=u[i++],F=u[i++],T=u[i];t(o)&&([s,O,x]=o.applyToVertex(s,O,x,e),[P,M,A]=o.applyToVertex(P,M,A,e),[b,F,T]=o.applyToVertex(b,F,T,e));const S=P-s,C=M-O,_=A-x,I=b-s,L=F-O,y=T-x,N=g*y-L*v,R=v*I-y*p,D=p*L-I*g,E=S*N+C*R+_*D;if(Math.abs(E)<=Number.EPSILON)continue;const z=f-s,V=m-O,j=h-x,U=z*N+V*R+j*D;if(E>0){if(U<0||U>E)continue}else if(U>0||U<E)continue;const w=V*_-C*j,B=j*S-_*z,G=z*C-S*V,W=p*w+g*B+v*G;if(E>0){if(W<0||U+W>E)continue}else if(W>0||U+W<E)continue;const k=(I*w+L*B+y*G)/E;k>=0&&c(k,q(S,C,_,I,L,y,Y),a,!1)}}(e,a,r,i,n,s,l,o,c);const u=s.data,d=s.stride||s.size,f=e[0],m=e[1],h=e[2],p=a[0]-f,g=a[1]-m,v=a[2]-h;for(let e=r,a=3*r;e<i;++e){let r=d*n[a++],i=u[r++],s=u[r++],l=u[r];r=d*n[a++];let O=u[r++],x=u[r++],P=u[r];r=d*n[a++];let M=u[r++],A=u[r++],b=u[r];t(o)&&([i,s,l]=o.applyToVertex(i,s,l,e),[O,x,P]=o.applyToVertex(O,x,P,e),[M,A,b]=o.applyToVertex(M,A,b,e));const F=O-i,T=x-s,S=P-l,C=M-i,_=A-s,I=b-l,L=g*I-_*v,y=v*C-I*p,N=p*_-C*g,R=F*L+T*y+S*N;if(Math.abs(R)<=Number.EPSILON)continue;const D=f-i,E=m-s,z=h-l,V=D*L+E*y+z*N;if(R>0){if(V<0||V>R)continue}else if(V>0||V<R)continue;const j=E*S-T*z,U=z*F-S*D,w=D*T-F*E,B=p*j+g*U+v*w;if(R>0){if(B<0||V+B>R)continue}else if(B>0||V+B<R)continue;const G=(C*j+_*U+I*w)/R;G>=0&&c(G,q(F,T,S,C,_,I,Y),e,!1)}}const B=d(),G=d();function q(e,t,a,r,i,n,s){return o(B,e,t,a),o(G,r,i,n),c(s,B,G),u(s,s),s}function W(e,t,a){return o(a,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function k(e,t,a,r){return H(e,t,a,r,1/0)}function H(e,t,a,r,i){const n=(e[0]-r-t[0])*a[0],s=(e[3]+r-t[0])*a[0];let l=Math.min(n,s),o=Math.max(n,s);const c=(e[1]-r-t[1])*a[1],u=(e[4]+r-t[1])*a[1];if(o=Math.min(o,Math.max(c,u)),o<0)return!1;if(l=Math.max(l,Math.min(c,u)),l>o)return!1;const d=(e[2]-r-t[2])*a[2],f=(e[5]+r-t[2])*a[2];return o=Math.min(o,Math.max(d,f)),!(o<0)&&(l=Math.max(l,Math.min(d,f)),!(l>o)&&l<i)}function X(e,a,r,i,n){let s=(r.screenLength||0)*e.pixelRatio;t(n)&&(s=function(e,t,a,r){return _(e,S(t,a,r))}(s,i,a,n));const o=s*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return l(o*a,r.minWorldLength||0,null!=r.maxWorldLength?r.maxWorldLength:1/0)}function Z(e,t){const a=t?Z(t):{};for(const t in e){let r=e[t];r&&r.forEach&&(r=Q(r)),null==r&&t in a||(a[t]=r)}return a}function J(e,t){let a=!1;for(const r in t){const n=t[r];void 0!==n&&(Array.isArray(n)?null===e[r]?(e[r]=n.slice(),a=!0):i(e[r],n)&&(a=!0):e[r]!==n&&(a=!0,e[r]=n))}return a}function K(e,t,a,i,n,s){if(!t.options.selectionMode)return;const o=e.vertexAttributes.get(r.POSITION).data,c=e.vertexAttributes.get(r.SIZE),u=c&&c.data[0],d=i[0],f=i[1],m=((u+n)/2+4)*e.screenToWorldRatio;let h=Number.MAX_VALUE,p=0;for(let e=0;e<o.length-5;e+=3){const t=o[e],a=o[e+1],r=d-t,i=f-a,n=o[e+3]-t,s=o[e+4]-a,c=l((n*r+s*i)/(n*n+s*s),0,1),u=n*c-r,m=s*c-i,g=u*u+m*m;g<h&&(h=g,p=e/3)}h<m*m&&s(a.dist,a.normal,p,!1)}function Q(e){const t=[];return e.forEach((e=>t.push(e))),t}const $={multiply:1,ignore:2,replace:3,tint:4},ee=1e3;class te extends x{constructor(e,t){super(),this.type=P.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=b,this._parameters=Z(e,t),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){J(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleInPass(e.pass)&&0!=(this.renderOccluded&e.renderOccludedMask)}isVisibleInPass(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){t(this.repository)&&this.repository.materialChanged(this)}}var ae;!function(e){e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"}(ae||(ae={}));class re extends M{constructor(){super(...arguments),this.renderOccluded=ae.Occlude}}export{x as C,b as D,te as M,M as N,ae as R,re as a,P as b,K as c,Z as d,_ as e,L as f,A as g,F as h,V as i,T as j,H as k,q as l,w as m,W as n,k as o,I as p,$ as q,J as u,X as v};
