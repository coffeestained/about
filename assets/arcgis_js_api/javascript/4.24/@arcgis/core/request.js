/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"./config.js";import{id as r}from"./kernel.js";import t from"./core/Error.js";import{h as s,clone as o}from"./core/lang.js";import{i as n,u as a}from"./chunks/maybe.js";import{isAborted as i,onAbort as l,isAbortError as c,createAbortError as u}from"./core/promiseUtils.js";import{getOrigin as d,hasSameOrigin as p,getAppUrl as m,urlToObject as h,isDataProtocol as f,isBlobProtocol as y,normalize as w,getInterceptor as g,isTrustedServer as b,toHTTPS as q,addQueryParameter as T,objectToQuery as k,getProxyRule as O,getProxyUrl as v,addQueryParameters as C,addProxyRule as E}from"./core/urlUtils.js";import"./chunks/object.js";import"./chunks/Logger.js";import"./chunks/string.js";const S=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function L(e){const r=d(e,!0);return r&&r.endsWith(".arcgis.com")&&!S.includes(r)&&!e.endsWith("/sharing/rest/generateToken")}function x(e,r,t=!1,o){return new Promise(((a,l)=>{if(i(o))return void l(j());let c=()=>{p(),l(new Error(`Unable to load ${r}`))},u=()=>{const r=e;p(),a(r)},d=()=>{if(!e)return;const r=e;p(),r.src="",l(j())};const p=()=>{s("esri-image-decode")||(e.removeEventListener("error",c),e.removeEventListener("load",u)),c=null,u=null,e=null,n(o)&&o.removeEventListener("abort",d),d=null,t&&URL.revokeObjectURL(r)};n(o)&&o.addEventListener("abort",d),s("esri-image-decode")?e.decode().then(u,c):(e.addEventListener("error",c),e.addEventListener("load",u))}))}function j(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}async function D(o,n){const c=f(o),u=y(o);u||c||(o=w(o));const p={url:o,requestOptions:{...a(n)}};let m=g(o);if(m){const e=await async function(e,r){if(null!=e.responseData)return e.responseData;if(e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers}),e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query}),e.before){let s,o;try{o=await e.before(r)}catch(e){s=H("request:interceptor",e,r)}if((o instanceof Error||o instanceof t)&&(s=H("request:interceptor",o,r)),s)throw e.error&&e.error(s),s;return o}}(m,p);if(null!=e)return{data:e,getHeader:A,requestOptions:p.requestOptions,url:p.url};m.after||m.error||(m=null)}if(o=p.url,"image"===(n=p.requestOptions).responseType){if(s("host-webworker")||s("host-node"))throw H("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),p)}else if(c)throw H("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+n.responseType),p);if("head"===n.method){if(n.body)throw H("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),p);if(c||u)throw H("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),p)}if(await async function(){s("host-webworker")?U||(U=await import("./chunks/request.js")):D._abortableFetch||(D._abortableFetch=globalThis.fetch.bind(globalThis))}(),U)return U.execute(o,n);const h=new AbortController;l(n,(()=>h.abort()));const q={controller:h,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:m,params:p,redoRequest:!1,useIdentity:P.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},T=await async function(t){let s,o;await async function(t){const s=t.params.url,o=t.params.requestOptions,n=t.controller.signal,a=o.body;let l=null,c=null;if(_&&"HTMLFormElement"in globalThis&&(a instanceof FormData?l=a:a instanceof HTMLFormElement&&(l=new FormData(a))),"string"==typeof a&&(c=a),t.fetchOptions={cache:o.cacheBust&&!D._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:o.headers||{},method:"head"===o.method?"HEAD":"GET",mode:"cors",priority:P.priority,redirect:"follow",signal:n},(l||c)&&(t.fetchOptions.body=l||c),"anonymous"===o.authMode&&(t.useIdentity=!1),t.hasToken=!!(/token=/i.test(s)||o.query?.token||l?.get("token")),!t.hasToken&&e.apiKey&&L(s)&&(o.query||(o.query={}),o.query.token=e.apiKey,t.hasToken=!0),t.useIdentity&&!t.hasToken&&!t.credentialToken&&!$(s)&&!i(n)){let e;"immediate"===o.authMode?(await B(),e=await r.getCredential(s,{signal:n}),t.credential=e):"no-prompt"===o.authMode?(await B(),e=await r.getCredential(s,{prompt:!1,signal:n}).catch((()=>{})),t.credential=e):r&&(e=r.findCredential(s)),e&&(t.credentialToken=e.token,t.useSSL=!!e.ssl)}}(t);try{do{[s,o]=await W(t)}while(!await G(t,s,o))}catch(e){const r=H("request:server",e,t.params,s);throw r.details.ssl=t.useSSL,t.interceptor&&t.interceptor.error&&t.interceptor.error(r),r}const n=t.params.url;if(o&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(n)){if(!t.hasToken&&!t.credentialToken&&o.user?.username&&!b(n)){const e=d(n,!0);e&&P.trustedServers.push(e)}Array.isArray(o.authorizedCrossOriginNoCorsDomains)&&function(r){e.request.crossOriginNoCorsDomains||(e.request.crossOriginNoCorsDomains={});const t=e.request.crossOriginNoCorsDomains;for(let e of r)e=e.toLowerCase(),/^https?:\/\//.test(e)?t[d(e)]=0:(t[d("http://"+e)]=0,t[d("https://"+e)]=0)}(o.authorizedCrossOriginNoCorsDomains)}const a=t.credential;if(a&&r){const e=r.findServerInfo(a.server);let t=e&&e.owningSystemUrl;if(t){t=t.replace(/\/?$/,"/sharing");const e=r.findCredential(t,a.userId);e&&-1===r._getIdenticalSvcIdx(t,e)&&e.resources.unshift(t)}}return{data:o,getHeader:s?e=>s.headers.get(e):A,requestOptions:t.params.requestOptions,ssl:t.useSSL,url:t.params.url}}(q);return m?.after?.(T),T}let U;const P=e.request,_="FormData"in globalThis,M=[499,498,403,401],N=["COM_0056","COM_0057","SB_0008"],R=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],A=()=>null,F=Symbol();function I(e){const r=d(e);return!r||r.endsWith(".arcgis.com")||D._corsServers.includes(r)||b(r)}function H(e,r,s,n){let a="Error";const i={url:s.url,requestOptions:s.requestOptions,getHeader:A,ssl:!1};if(r instanceof t)return r.details?(r.details=o(r.details),r.details.url=s.url,r.details.requestOptions=s.requestOptions):r.details=i,r;if(r){const e=n&&(e=>n.headers.get(e)),t=n&&n.status,s=r.message;s&&(a=s),e&&(i.getHeader=e),i.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,i.subCode=r.subcode,i.messageCode=r.messageCode,"string"==typeof r.details?i.messages=[r.details]:i.messages=r.details,i.raw=F in r?r[F]:r}return c(r)?u():new t(e,a,i)}async function B(){r||await import("./identity/IdentityManager.js")}function $(e){return R.some((r=>r.test(e)))}async function W(t){let o=t.params.url;const n=t.params.requestOptions,a=t.fetchOptions,i=y(o)||f(o),l=n.responseType||"json",c=i?0:null!=n.timeout?n.timeout:P.timeout;let w=!1;if(!i){t.useSSL&&(o=q(o)),n.cacheBust&&"default"===a.cache&&(o=T(o,"request.preventCache",Date.now()));let i={...n.query};t.credentialToken&&(i.token=t.credentialToken);let l=k(i);s("esri-url-encodes-apostrophe")&&(l=l.replace(/'/g,"%27"));const c=o.length+1+l.length;let u;w="delete"===n.method||"post"===n.method||"put"===n.method||!!n.body||c>P.maxUrlLength;const f=n.useProxy||!!O(o);if(f){const e=v(o);u=e.path,!w&&u.length+1+c>P.maxUrlLength&&(w=!0),e.query&&(i={...e.query,...i})}if("HEAD"===a.method&&(w||f)){if(w){if(c>P.maxUrlLength)throw H("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params);throw H("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params)}if(f)throw H("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}if(w?(a.method="delete"===n.method?"DELETE":"put"===n.method?"PUT":"POST",n.body?o=C(o,i):(a.body=k(i),a.headers["Content-Type"]="application/x-www-form-urlencoded")):o=C(o,i),f&&(t.useProxy=!0,o=`${u}?${o}`),i.token&&_&&a.body instanceof FormData&&!/\/(sharing|usrsvcs)\/(appservices|servers)\//i.test(o)&&a.body.set("token",i.token),n.hasOwnProperty("withCredentials"))t.withCredentials=n.withCredentials;else if(!p(o,m()))if(b(o))t.withCredentials=!0;else if(r){const e=r.findServerInfo(o);e&&e.webTierAuth&&(t.withCredentials=!0)}t.withCredentials&&(a.credentials="include",function(r){const t=e.request.crossOriginNoCorsDomains;if(t){let e=d(r);if(e)return e=e.toLowerCase(),!p(e,m())&&t[e]<Date.now()-36e5}return!1}(o)&&await async function(r){const t=e.request.crossOriginNoCorsDomains;t&&(t[d(r).toLowerCase()]=Date.now());const s=h(r);r=s.path,"json"===s.query?.f&&(r+="?f=json");try{await fetch(r,{mode:"no-cors",credentials:"include"})}catch{}}(w?C(o,i):o))}let g,S,L=0,x=!1;c>0&&(L=setTimeout((()=>{x=!0,t.controller.abort()}),c));try{if("native-request-init"===n.responseType)S=a,S.url=o;else if("image"!==n.responseType||"default"!==a.cache||"GET"!==a.method||w||function(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}(n.headers)||!i&&!t.useProxy&&P.proxyUrl&&!I(o)){if(g=await D._abortableFetch(o,a),t.useProxy||function(e){const r=d(e);r&&!D._corsServers.includes(r)&&D._corsServers.push(r)}(o),"native"===n.responseType)S=g;else if("HEAD"!==a.method)if(g.ok){switch(l){case"array-buffer":S=await g.arrayBuffer();break;case"blob":case"image":S=await g.blob();break;default:S=await g.text()}if(L&&(clearTimeout(L),L=0),"json"===l||"xml"===l||"document"===l)if(S)switch(l){case"json":S=JSON.parse(S);break;case"xml":S=z(S,"application/xml");break;case"document":S=z(S,"text/html")}else S=null;if(S){if("array-buffer"===l||"blob"===l){const e=g.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&S["blob"===l?"size":"byteLength"]<=750)try{const e=await new Response(S).json();e.error&&(S=e)}catch{}}"image"===l&&S instanceof Blob&&(S=await K(URL.createObjectURL(S),t,!0))}}else S=await g.text()}else S=await K(o,t)}catch(e){if("AbortError"===e.name){if(x)throw new Error("Timeout exceeded");throw u("Request canceled")}if(!(!g&&e instanceof TypeError&&P.proxyUrl)||n.body||"delete"===n.method||"head"===n.method||"post"===n.method||"put"===n.method||t.useProxy||I(o))throw e;t.redoRequest=!0,E({proxyUrl:P.proxyUrl,urlPrefix:d(o)})}finally{L&&clearTimeout(L)}return[g,S]}function z(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}async function G(e,t,s){if(e.redoRequest)return e.redoRequest=!1,!1;const o=e.params.requestOptions;if(!t||"native"===o.responseType||"native-request-init"===o.responseType)return!0;let n,a,i,l;if(!t.ok)throw n=new Error(`Unable to load ${t.url} status: ${t.status}`),n[F]=s,n;s?.error&&(n=s.error),n&&(a=Number(n.code),i=n.hasOwnProperty("subcode")?Number(n.subcode):null,l=n.messageCode,l=l&&l.toUpperCase());const c=o.authMode;if(403===a&&(4===i||n.message&&n.message.toLowerCase().includes("ssl")&&!n.message.toLowerCase().includes("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==c||498===a)&&M.includes(a)&&!$(e.params.url)&&(403!==a||!N.includes(l)&&(null==i||2===i&&e.credentialToken))){await B();try{const t=await r.getCredential(e.params.url,{error:H("request:server",n,e.params),prompt:"no-prompt"!==c,signal:e.controller.signal,token:e.credentialToken});return e.credential=t,e.credentialToken=t.token,e.useSSL=e.useSSL||t.ssl,!1}catch(r){if("no-prompt"===c)return e.credential=null,e.credentialToken=null,!1;n=r}}if(n)throw n;return!0}function K(e,r,t=!1){const s=r.controller.signal,o=new Image;return r.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.fetchPriority=P.priority,o.src=e,x(o,e,t,s)}D._abortableFetch=null,D._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];const J=Object.freeze(Object.defineProperty({__proto__:null,default:D},Symbol.toStringTag,{value:"Module"}));export{D as default,x as l,J as r,L as s};
