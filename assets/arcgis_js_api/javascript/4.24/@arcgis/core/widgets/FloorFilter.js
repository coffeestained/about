/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{substitute as t}from"../intl.js";import{e as s}from"../core/promiseUtils.js";import{watch as i}from"../core/reactiveUtils.js";import{aliasOf as l}from"../core/accessorSupport/decorators/aliasOf.js";import"../core/lang.js";import"../chunks/ensureType.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import n from"./Widget.js";import a from"./FloorFilter/FloorFilterViewModel.js";import{H as c,i as h}from"../chunks/Heading.js";import{i as d,s as u}from"../chunks/widgetUtils.js";import{m}from"../chunks/messageBundle.js";import{t as v}from"../chunks/jsxFactory.js";import"../chunks/number2.js";import"../chunks/jsonMap.js";import"../chunks/object.js";import"../chunks/locale.js";import"../chunks/maybe.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/string.js";import"../chunks/messages.js";import"../core/Error.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/assets.js";import"../chunks/handleUtils.js";import"../chunks/watch.js";import"../chunks/ArrayPool.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/tracking.js";import"../chunks/metadata.js";import"../chunks/domUtils.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/Collection.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../core/Promise.js";import"../chunks/uuid.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/projector.js";import"../chunks/jsxWidgetSupport.js";import"../core/HandleOwner.js";import"../chunks/Widgets.js";import"../core/JSONSupport.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../TimeInterval.js";import"./support/GoTo.js";import"../chunks/mathUtils.js";import"../chunks/common.js";const f="esri-floor-filter__button-info",p="esri-floor-filter__button-label",_=["ArrowUp","ArrowDown","End","Home"];let g=class extends n{constructor(e,t){super(e,t),this._activeMenu=null,this._activeMenuIndex={levels:-1,menuItems:-1},this._baseNode=null,this._facilitiesListNode=null,this._levelsListNode=null,this._sitesListNode=null,this._searchInput=null,this.enabled=null,this.longNames=null,this.minimized=null,this.pinnedLevels=null,this.site=null,this.facility=null,this.level=null,this.view=null,this.viewModel=new a,this.messages=null,this.messagesCommon=null,this.goToOverride=null,this.headingLevel=2,this._resizeObserver=new ResizeObserver((()=>this.scheduleRender())),this.own(i((()=>this._searchInput),(()=>this._focusSearch())))}destroy(){this._resizeObserver.disconnect()}updateWebDocument(){}render(){const{longNames:e}=this,t=e&&this.viewModel.isNormalMode?"expanded":"collapsed",s=this.renderButtons(),i=this.renderFilterMenu(),l=v("div",{class:this.classes("esri-floor-filter__separator")}),o=this._getComponentPosition(),r=this._getPosition(o),n="top-right"===o||"bottom-right"===o,a="top-left"===o||"bottom-left"===o,c=d(this.container),h=c&&a||!c&&n?i:s,u=c&&a||!c&&n?s:i;return v("div",{afterCreate:this._afterBaseNodeCreate,key:"floor-filter-menu",class:this.classes("esri-floor-filter","esri-widget",`esri-floor-filter__layout--${t}`,`esri-floor-filter__position--${r}`)},h,this.viewModel?.filterMenuOpen&&l,u)}renderButtons(){const e=this._getComponentPosition(),t=[];return"top"===this._getPosition(e)?(t.push(this.renderBrowseButton()),t.push(this.renderLevelButtons()),t.push(this.renderCloseLevelsButton()),t.push(this.renderZoomButton()),t.push(this.renderCollapseToggleButton())):(t.push(this.renderCollapseToggleButton()),t.push(this.renderZoomButton()),t.push(this.renderCloseLevelsButton()),t.push(this.renderLevelButtons()),t.push(this.renderBrowseButton())),v("div",{key:"button-container",class:this.classes("esri-widget","esri-floor-filter__button-container")},t)}renderBrowseButton(){const{longNames:e,messages:t}=this;return v("button",{key:"browse-button",title:t.buttons.browse,bind:this,class:this.classes("esri-widget","esri-widget--button","esri-interactive",("loading"===this.viewModel.state||"disabled"===this.viewModel.state)&&"esri-button--disabled","esri-floor-filter__browse-button",this.viewModel?.filterMenuOpen&&"esri-widget--button-active"),"aria-expanded":this.viewModel.filterMenuOpen.toString(),"aria-label":t.buttons.browse,onclick:this._toggleFilterMenu,type:"button"},v("div",{class:this.classes(f)},v("span",{class:this.classes("esri-icon","esri-icon-urban-model")}),v("span",{class:this.classes(p)},e&&this.viewModel.isNormalMode&&t.buttons.browse)))}renderLevelButtons(){if(!this.viewModel?.filterFeatures?.levels?.levelsInfo||!this.facility)return null;const{facility:e,messagesCommon:s,messages:i}=this,l=this.viewModel?.getFacility(e),o=this.viewModel?.getFacilityLevels(e),r=o.map((e=>this.renderLevelButton(e)));if(!r.length)return null;const n=l&&t(i.selector.levelsLabel,{name:`"${l.name}"`});if(this._isWebScene(this.view.map)&&r?.length>1){const t={id:`all--${e}`,facilityId:e,shortName:s.all,longName:s.all,levelNumber:null,verticalOrder:null},i=this.renderLevelButton(t);r.push(i)}return v("ul",{key:"levels-button-container",class:this.classes("esri-floor-filter__levels-container"),bind:this,"data-id":"levels",afterCreate:u,"data-node-ref":"_levelsListNode","aria-label":n,onkeydown:this._handleListKeydown},r)}renderLevelButton(e){const{longNames:t}=this,{shortName:s,longName:i,id:l}=e,o=`levels--${l}`,r=this.level===l,n=t&&this.viewModel.isNormalMode?i:s;return this.viewModel.isNormalMode||r||this.viewModel.levelsExpanded?v("li",{key:o},v("button",{"data-id":l,"data-list-id":"levels",bind:this,class:this.classes("esri-widget--button",r?"esri-widget--button-active":null,"esri-interactive","esri-floor-filter__level-button"),onclick:this._levelSelected,onfocus:this._onItemFocus,type:"button"},n)):null}renderCloseLevelsButton(){if(!this.level||this.viewModel.isNormalMode||!this.viewModel.levelsExpanded)return null;const{messagesCommon:e}=this;return v("button",{key:"close-levels-button",title:e.close,bind:this,class:this.classes("esri-widget","esri-widget--button","esri-interactive","esri-floor-filter__close-levels-button"),"aria-label":e.close,onclick:this._closeLevels,type:"button"},v("div",{class:this.classes(f)},v("span",{class:this.classes("esri-icon","esri-icon-close")})))}renderZoomButton(){const{longNames:e,messages:t,facility:s,site:i}=this,l=this.viewModel?.filterMenuType,o=this.viewModel?.filterMenuOpen,r=this.viewModel?.getSite(i),n=this.viewModel?.getFacility(s),a="site"===l&&o?!r:!n;return v("button",{key:"zoom-button",title:t.buttons.zoomTo,bind:this,class:this.classes("esri-widget","esri-widget--button",a&&"esri-button--disabled","esri-interactive",this.viewModel?.getFacilityLevels(s).length>0?"esri-floor-filter__zoom-button--levels":"esri-floor-filter__zoom-button"),"aria-label":t.buttons.zoomTo,onclick:this._zoomToClicked,type:"button"},v("div",{class:this.classes(f)},v("span",{class:this.classes("esri-icon","esri-icon-zoom-to-object")}),v("span",{class:this.classes(p)},e&&this.viewModel.isNormalMode&&t.buttons.zoomTo)))}renderCollapseToggleButton(){const{longNames:e,messagesCommon:t}=this,s=e?"esri-icon-collapse":"esri-icon-expand",i=this.classes("esri-icon",s),l=e?t.collapse:t.expand;return v("button",{key:"minimize-toggle-button",title:l,bind:this,class:this.classes("esri-widget","esri-widget--button","esri-interactive","esri-floor-filter__minimize-toggle-button"),"aria-label":l,onclick:this._toggleCollapsed,type:"button"},v("div",{class:this.classes(f)},v("span",{class:i}),v("span",{class:this.classes(p)},e&&this.viewModel.isNormalMode&&t.collapse)))}renderFilterMenu(){return this.viewModel?.filterMenuOpen?"site"===this.viewModel?.filterMenuType?this.renderSiteFilterMenu():"facility"===this.viewModel?.filterMenuType?this.renderFacilityFilterMenu():null:null}renderSiteFilterMenu(){const{messages:e,messagesCommon:t}=this,s=this.site?this.viewModel?.getSite(this.site)?.name:e.selector.selectSite,i=v("div",{key:"filter-menu-site-header",class:this.classes("esri-floor-filter__filter-menu-header")},v("div",{class:this.classes("esri-floor-filter__filter-menu-header-text-group")},v(c,{level:this.headingLevel,class:this.classes("esri-floor-filter__filter-menu-header-text")},s)),v("button",{bind:this,title:t.close,class:this.classes("esri-icon","esri-icon-close"),onclick:this._closeClicked,type:"button"})),l=this.renderSearchInput(),o=this.renderSiteItems();return v("div",{key:"filter-menu-site",class:this.classes("esri-floor-filter__filter-menu")},i,l,o)}renderFacilityFilterMenu(){const{messages:e,messagesCommon:t,site:s}=this,i=this.viewModel?.getSite(s)?.name,l=this.facility&&this.viewModel?.getFacility(this.facility)?.name||e.selector.selectFacility,o=this.viewModel.hasMultipleSites?v("button",{bind:this,title:t.back,class:this.classes("esri-floor-filter__filter-menu-header-back"),onclick:this._backClicked,type:"button"},v("span",{class:this.classes(d(this.container)?"esri-icon-right":"esri-icon-left")})):null,r=this.viewModel.hasMultipleSites?v(c,{level:h(this.headingLevel),class:this.classes("esri-floor-filter__filter-menu-header-subtext")},i):null,n=v("div",{key:"filter-menu-site-header",class:this.classes("esri-floor-filter__filter-menu-header")},o,v("div",{class:this.classes("esri-floor-filter__filter-menu-header-text-group")},v(c,{level:this.headingLevel,class:this.classes("esri-floor-filter__filter-menu-header-text")},l),r),v("button",{bind:this,title:t.close,class:this.classes("esri-icon","esri-icon-close"),onclick:this._closeClicked,type:"button"})),a=this.renderSearchInput(),u=this.renderFacilityItems();return v("div",{key:"filter-menu-facility",class:this.classes("esri-floor-filter__filter-menu")},n,a,u)}renderSearchInput(){const{messagesCommon:e}=this;return v("div",{key:"filter-menu-search",class:this.classes("esri-floor-filter__filter-menu-search")},v("span",{class:this.classes("esri-icon","esri-icon-search")}),v("input",{bind:this,key:"filter-menu-search__input",afterCreate:u,"data-node-ref":"_searchInput",class:this.classes("esri-floor-filter__filter-menu-search-input"),placeholder:e.search,oninput:this._onSearchChange,onpaste:this._onSearchChange,value:this.viewModel.searchTerm}))}renderBlueCircle(){return v("span",{key:"floor-filter__selected-item-circle",class:this.classes("esri-floor-filter__selected-item-circle")})}renderSiteItems(){if(!this.viewModel?.filterFeatures?.sites?.sitesInfo)return null;const{messages:e}=this,t=this.viewModel.filterFeatures.sites.sitesInfo,s=this.viewModel.filterSites(t).map((e=>this.renderSiteItem(e))),i=0===s.length&&this.viewModel?.searchTerm&&v("div",{class:this.classes("esri-widget__content--empty")},e.noResults);return v("ul",{key:"filter-menu-items--sites",class:this.classes("esri-floor-filter__filter-menu-items"),bind:this,afterCreate:u,"data-node-ref":"_sitesListNode","data-id":"sites",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":e.selector.sitesLabel},s,i)}renderSiteItem(e){const{name:t,id:s}=e,i=`filter-menu-site--${s}`,l=this.site===s;return v("li",{key:i},v("button",{"data-id":s,"data-list-id":"sites",bind:this,class:this.classes("esri-floor-filter__filter-menu-site"),onclick:this._siteSelected,onfocus:this._onItemFocus,type:"button"},l&&this.renderBlueCircle(),v("span",{class:this.classes(l?"esri-floor-filter__filter-menu-item-name--selected":"esri-floor-filter__filter-menu-item-name")},t),v("span",{class:this.classes(d(this.container)?"esri-icon-left":"esri-icon-right")})))}renderFacilityItems(){if(!this.viewModel?.filterFeatures?.facilities?.facilitiesInfo)return null;const{messages:e,site:s}=this,i=this.viewModel.getSite(s),l=this.viewModel.filterFeatures.facilities.facilitiesInfo,o=this.viewModel.filterFacilities(l).map((e=>this.renderFacilityItem(e))),r=0===o.length&&this.viewModel?.searchTerm&&v("div",{class:this.classes("esri-widget__content--empty")},e.noResults),n=i?t(e.selector.siteFacilitiesLabel,{name:`"${i.name}"`}):e.selector.facilitiesLabel;return v("ul",{key:"filter-menu-items--facilities",class:this.classes("esri-floor-filter__filter-menu-items"),bind:this,afterCreate:u,"data-node-ref":"_facilitiesListNode","data-id":"facilities",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":n},o,r)}renderFacilityItem(e){const{name:t,id:s}=e,i=`filter-menu-facility--${s}`,l=this.facility===s;return v("li",{key:i},v("button",{"data-id":s,"data-list-id":"facilities",bind:this,class:this.classes("esri-floor-filter__filter-menu-facility"),onclick:this._facilitySelected,onfocus:this._onItemFocus,type:"button"},l&&this.renderBlueCircle(),v("span",{class:this.classes(l?"esri-floor-filter__filter-menu-item-name--selected":"esri-floor-filter__filter-menu-item-name")},t)))}_afterBaseNodeCreate(e){this._baseNode&&this._resizeObserver?.unobserve(this._baseNode),this._baseNode=e,this._resizeObserver?.observe(this._baseNode)}_toggleCollapsed(){this.longNames=!this.longNames}_toggleFilterMenu(){const e=this.viewModel?.filterMenuOpen??!1;this.viewModel.filterMenuOpen=!e}_setFilterMenuType(e){this.viewModel.filterMenuType=e}_zoomToClicked(){if(this.site&&"site"===this.viewModel?.filterMenuType&&this.viewModel?.filterMenuOpen){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}else if(this.facility){const e=this.viewModel?.getFacility(this.facility);this.viewModel.goTo(e)}else if(this.site){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}}_onSearchChange(e){const t=e.target;""===t.value?this.viewModel.searchTerm=null:t.value&&this.viewModel?.searchTerm!==t.value&&(this.viewModel.searchTerm=t.value.toLowerCase().trim())}_closeClicked(){this.viewModel.searchTerm=null,this.viewModel.filterMenuOpen=!1}_backClicked(){this._setFilterMenuType("site"),this.viewModel.searchTerm=null}_siteSelected(e){const t=e.currentTarget.getAttribute("data-id"),s=this.viewModel.getSite(t);let i=!1;this.site!==t&&(this.facility=void 0,this.level=void 0,i=!0,this.viewModel.levelsExpanded=!1),this.site=t,this.viewModel.searchTerm=null,this._setFilterMenuType("facility"),this.viewModel.goTo(s),i&&this.viewModel.setFloors(null)}_facilitySelected(e){const t=e.currentTarget.getAttribute("data-id"),s=this.viewModel.getFacility(t);let i=!1;if(this.facility!==t){if("base-floors"===this.viewModel.filterMode){const e=this.viewModel?.getBaseLevel(s);this.level=e?e.id:void 0}else this.level=void 0;i=!0,this.viewModel.levelsExpanded=!1}if(this.facility=t,this.viewModel.goTo(s),i){const e=this.viewModel.getLevel(this.level);this.viewModel.setFloors(e)}this.viewModel.isNormalMode||this.viewModel.getFacilityLevels(t)?.length>1&&(this.viewModel.levelsExpanded=!0),setTimeout((()=>{this._focusActiveLevel()}),50)}_levelSelected(e){const t=e.currentTarget.getAttribute("data-id");this.level=t}_closeLevels(){this.viewModel.levelsExpanded=!1}_isWebScene(e){return"esri.WebScene"===e.declaredClass}_getComponentPosition(){return this.view?.ui?.getPosition(this.container)}_getPosition(e){switch(e){case"bottom-right":case"bottom-left":return"bottom";default:return"top"}}_handleListKeydown(e){const t=e.currentTarget.getAttribute("data-id");let i=null;"sites"===t||"facilities"===t?(this._activeMenu!==t&&(this._activeMenuIndex.menuItems=-1),this._activeMenu=t,i="menuItems"):"levels"===t&&(i="levels");const l="sites"===t?this._sitesListNode:"facilities"===t?this._facilitiesListNode:"levels"===t?this._levelsListNode:null,o=s(e),r="Tab"===o,n=_.includes(o);n&&e.preventDefault();const a=l?.getElementsByTagName("li");a&&0!==a.length&&(n||r)&&this._handleItemNavigation(o,e.shiftKey,a,r,i)}_handleItemNavigation(e,t,s,i,l){if(!l)return;this._activeMenuIndex[l]===s.length&&this._activeMenuIndex[l]--,-1===this._activeMenuIndex[l]&&this._activeMenuIndex[l]++;const o=this._activeMenuIndex[l];switch(e){case"Home":this._activeMenuIndex[l]=0;break;case"End":this._activeMenuIndex[l]=s.length-1;break;case"ArrowUp":this._activeMenuIndex[l]=this._activeMenuIndex[l]<=0?s.length-1:this._activeMenuIndex[l]-1;break;case"ArrowDown":this._activeMenuIndex[l]=this._activeMenuIndex[l]===s.length-1?0:this._activeMenuIndex[l]+1}if("Tab"===e&&t&&this._activeMenuIndex[l]>=0&&this._activeMenuIndex[l]--,"Tab"===e&&!t&&this._activeMenuIndex[l]<s.length&&this._activeMenuIndex[l]++,o!==this._activeMenuIndex[l]&&this._activeMenuIndex[l]>-1&&this._activeMenuIndex[l]<s.length&&!i){const e=s[this._activeMenuIndex[l]].getElementsByTagName("button");(1===e?.length&&e[0])?.focus()}}_focusSearch(){this._searchInput?.focus()}_focusActiveLevel(){const{level:e}=this,t=this._levelsListNode,s=t?.getElementsByTagName("li");if(!e||!t||!s)return;const i=this._facilitiesListNode?.getElementsByTagName("li");this._activeMenuIndex.menuItems=i?i.length-1:-1;const l=[];for(let e=0;e<s.length;e++){const t=s[e].getElementsByTagName("button");1===t?.length&&l.push(t[0])}l.forEach(((t,s)=>{t.getAttribute("data-id")===e&&(t.focus(),this._activeMenuIndex.levels=s)}))}_onItemFocus(e){const t=e.currentTarget,s=t.getAttribute("data-list-id"),i=t.getAttribute("data-id"),l="sites"===s?this._sitesListNode:"facilities"===s?this._facilitiesListNode:"levels"===s?this._levelsListNode:null;if(!l)return;const o=l?.getElementsByTagName("li");if(!o)return;const r=[];Array.from(o).forEach((e=>{const t=e.getElementsByTagName("button");1===t?.length&&r.push(t[0])}));let n=null;switch(s){case"sites":case"facilities":n="menuItems";break;case"levels":n="levels"}n&&r.forEach(((e,t)=>{e.getAttribute("data-id")===i&&this._activeMenuIndex[n]!==t&&(this._activeMenuIndex[n]=t)}))}};e([o()],g.prototype,"_searchInput",void 0),e([l("viewModel.enabled")],g.prototype,"enabled",void 0),e([l("viewModel.longNames")],g.prototype,"longNames",void 0),e([l("viewModel.minimized")],g.prototype,"minimized",void 0),e([l("viewModel.pinnedLevels")],g.prototype,"pinnedLevels",void 0),e([l("viewModel.site")],g.prototype,"site",void 0),e([l("viewModel.facility")],g.prototype,"facility",void 0),e([l("viewModel.level")],g.prototype,"level",void 0),e([l("viewModel.view")],g.prototype,"view",void 0),e([o({type:a})],g.prototype,"viewModel",void 0),e([o(),m("esri/widgets/FloorFilter/t9n/FloorFilter")],g.prototype,"messages",void 0),e([o(),m("esri/t9n/common")],g.prototype,"messagesCommon",void 0),e([l("viewModel.goToOverride")],g.prototype,"goToOverride",void 0),e([o()],g.prototype,"headingLevel",void 0),e([l("viewModel.updateWebDocument")],g.prototype,"updateWebDocument",null),g=e([r("esri.widgets.FloorFilter")],g);const M=g;export{M as default};
