/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{clone as t}from"../../core/lang.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";import s from"./SearchSource.js";import{substitute as o}from"../../intl.js";import n from"../../core/Error.js";import{L as l}from"../../chunks/Logger.js";import{i as a}from"../../chunks/maybe.js";import{f as c}from"../../chunks/unitUtils.js";import u from"../../geometry/Polygon.js";import{c as d,s as p}from"../../chunks/geometryUtils3.js";import{f as m}from"../../chunks/number2.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/tracking.js";import"../../chunks/Identifiable.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../chunks/ArrayPool.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/promiseUtils.js";import"../../chunks/locale.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../chunks/jsonMap.js";import"../../chunks/projectionEllipsoid.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/zmUtils.js";import"../../geometry.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/scaleUtils.js";const h=/https?:\/\/services.*\.arcgis\.com/i,f=/(?:\{([^}]+)\})/g,g=l.getLogger("esri.widgets.Search.support.layerSearchUtils");function y(e,t){const{filter:i,withinViewEnabled:r}=e,s=t&&t.extent;return i&&i.geometry||(r&&s?s:void 0)}function j(e){return e&&e.includes("*")}async function F(e){e&&await e.load()}function x(e){return e?.capabilities?.query?.supportsPagination??!1}function v(e){return e.displayField||e.layer.displayField||(e.layer?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??"")}function w(e,t){return!(!e||!t)&&t.every((t=>S(e,t)))}function S(e,t){return!!e.getField(t)}function k(e){return e.replace(/\'/g,"''")}function b(e,t){const i=t&&t.where;return i?`(${e}) AND (${i})`:e}function $({searchTerm:e,layer:t,searchFields:i,filter:r,exactMatch:s,type:o}){const{definitionExpression:n,url:l}=t;let a="";return e&&i&&i.forEach((i=>{const n=t.getField(i),c="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),u=c&&"coded-value"===c.type?function(e,t,i){let r=null;const{codedValues:s}=e;return s&&s.some((e=>{const s=e.name,o=i?s:s.toLowerCase();return(i?t:t.toLowerCase())===o&&(r=e.code.toString(),!0)})),r}(c,e,s):null,d=u||e||null;if(null!==d){const e=function({currentTerm:e,field:t,filter:i,exactMatch:r,url:s,type:o}){const n=t.type,l=t.name;if("string"===n||"date"===n||"global-id"===n){const t=h.test(s),n=t&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";if(r&&"search"===o)return b(`${l} = ${n}'${e}'`,i);const a=t?l:`UPPER(${l})`,c=t?e:e.toUpperCase();return b(`${a} LIKE ${n}${r?`'${c}%'`:`'%${c}%'`}`,i)}if("oid"===n||"small-integer"===n||"integer"===n||"single"===n||"double"===n){const t=Number(e);return isNaN(t)?null:b(`${l} = ${t}`,i)}return b(`${l} = ${e}`,i)}({currentTerm:d,field:n,filter:r,exactMatch:s,url:l,type:o});e&&(a+=function(e,t){return e?` OR (${t})`:`(${t})`}(a,e))}})),n?`(${n}) AND (${a})`:a}function T(e,t,i){const r=e.sourceLayer,{attributes:s}=e,n="function"==typeof r.getFieldDomain&&r.getFieldDomain(i);if(t)return o(t,s);if(i&&s){const e=r.getField(i),t=(a=i,(l=s)[Object.keys(l).find((e=>e.toLowerCase()===a.toLowerCase()))]);return null==t?"":n&&"coded-value"===n.type?function(e,t){let i=null;const{codedValues:r}=e;return r&&r.length&&r.some((e=>e.code===t&&(i=e.name,!0))),i}(n,t):"date"===e?.type?m(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var l,a;return""}var E;let I=E=class extends s{constructor(e){super(e),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(e,i)=>function(e,i){const{exactMatch:r=!1,location:s,maxResults:o,spatialReference:l,source:m,sourceIndex:h,suggestResult:f,view:b}=e,{layer:E,filter:I,zoomScale:M}=m,R=b&&b.scale,L=y(m,b),U=i&&i.signal;return F(E).then((()=>{const e=E.popupTemplate;return e?e.getRequiredFields(E.fieldsIndex):null})).then((e=>{const{objectIdField:i,returnZ:y}=E,F=v(m);if(!S(E,F))throw g.error("invalid-field: displayField is invalid."),new n("getResults():invalid-field","displayField is invalid.");const _=e&&e.length?e:[F],D=m.outFields||_,N=j(D);if(D.includes(i)||N||D.push(i),E.floorInfo?.floorField&&D.push(E.floorInfo.floorField),!N&&!w(E,D))throw g.error("invalid-field: outField is invalid."),new n("getResults():invalid-field","outField is invalid.");const C=E.createQuery(),{orderByFields:P}=m;if(P&&(C.orderByFields=P),l){C.outSpatialReference=l;const e=1/c(l);e&&(C.maxAllowableOffset=e)}const A="mesh"===E.geometryType||"multipatch"===E.geometryType,B=E.capabilities?.data?.supportsZ&&!A;if(C.returnZ=B&&!1!==y,C.returnGeometry=!0,C.multipatchOption=A?"xyFootprint":null,D&&(C.outFields=D),s)C.geometry=s;else if(f.key)C.objectIds=[f.key];else{const e=m.searchFields||[F];if(!w(E,e))throw g.error("invalid-field: search field is invalid."),new n("getResults():invalid-field","search field is invalid.");if(x(E)&&(C.num=o),L&&(C.geometry=L),!f.text.trim())return[];const{prefix:t="",suffix:i=""}=m,s=$({searchTerm:k(`${t}${f.text}${i}`),layer:E,searchFields:e,filter:I,exactMatch:r,type:"search"});if(!s)return[];C.where=s}return E.queryFeatures(C,{signal:U}).then((e=>function(e,i,r,s,o,n,l){return e.features.map((e=>function(e,i,r,s,o,n,l){const c=e.clone(),m=e.sourceLayer,h=m&&m.objectIdField,f=h&&e.attributes[h],g=T(e,r.searchTemplate,o),y=d(c.geometry,i,n),j="number"==typeof l?p(t(y),i,l):y,F=e.clone();return a(j)&&(F.geometry=u.fromExtent(j)),{extent:j,target:F,feature:c,key:f,name:g,sourceIndex:s}}(e,i,r,s,o,n,l)))}(e,b,m,h,F,R,M)))}))}({source:this,...e},i),this.getSuggestions=(e,t)=>function(e,t){const{source:i,spatialReference:r,view:s,suggestTerm:o,maxSuggestions:l,sourceIndex:a,exactMatch:c}=e,{layer:u,filter:d}=i,p=t&&t.signal,m=y(i,s);return F(u).then((()=>{if(!x(u))return[];const e=v(i),t=i.searchFields||[e],s=[];i.suggestionTemplate?i.suggestionTemplate.replace(f,((e,t)=>(s.push(t),e))):s.push(e);const h=j(s);s.includes(u.objectIdField)||h||s.push(u.objectIdField);const y=S(u,e),F=h||w(u,s),b=w(u,t);if(!y)throw g.error("invalid-field: displayField is invalid."),new n("getSuggestions():invalid-field","displayField is invalid.");if(!F)throw g.error("invalid-field: outField is invalid."),new n("getSuggestions():invalid-field","outField is invalid.");if(!b)throw g.error("invalid-field: search field is invalid."),new n("getSuggestions():invalid-field","search field is invalid.");const E=u.createQuery(),{orderByFields:I}=i;if(I&&(E.orderByFields=I),E.outSpatialReference=r,E.returnGeometry=!1,E.num=l,E.outFields=s,m&&(E.geometry=m),!o.trim())return[];const{prefix:M="",suffix:R=""}=i,L=$({searchTerm:k(`${M}${o}${R}`),layer:u,searchFields:t,filter:d,exactMatch:c,type:"suggest"});return L?(E.where=L,u.queryFeatures(E,{signal:p}).then((t=>function(e,t,i,r){return e.features.map((e=>function(e,t,i,r){const s=e.sourceLayer,{attributes:o}=e,{objectIdField:n}=s,l=o[n];return{text:T(e,t.suggestionTemplate,r),key:l,sourceIndex:i}}(e,t,i,r)))}(t,i,a,e)))):[]}))}({source:this,...e},t)}set layer(e){this._set("layer",e),e&&e.load().catch((()=>{}))}get name(){return this._getLayerTitle()||""}set name(e){void 0!==e?this._override("name",e):this._clearOverride("name")}clone(){return new E({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?t(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?t(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){return this.layer.fieldsIndex.fields.find((e=>"string"===e.type))?.name??""}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){const{layer:e,searchFields:t}=this;return e.loaded?`: ${(t||[this._getDisplayField()]).map((t=>{const i=e.getField(t);return i&&i.alias||t})).join(", ")}`:""}_getLayerTitle(){const{layer:e}=this;if(!e)return;const{title:t}=e;return t?`${t}${this._getSearchFieldsString()}`:void 0}};e([i({json:{read:{source:"field.name"},write:{target:"field.name"}}})],I.prototype,"displayField",void 0),e([i({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],I.prototype,"exactMatch",void 0),e([i({value:null})],I.prototype,"layer",null),e([i()],I.prototype,"name",null),e([i({type:[String],json:{write:!0}})],I.prototype,"orderByFields",void 0),e([i()],I.prototype,"searchFields",void 0),e([i()],I.prototype,"searchTemplate",void 0),e([i()],I.prototype,"suggestionTemplate",void 0),I=E=e([r("esri.widgets.Search.LayerSearchSource")],I);const M=I;export{M as default};
