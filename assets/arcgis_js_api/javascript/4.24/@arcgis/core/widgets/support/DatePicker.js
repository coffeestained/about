/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../intl.js";import{p as t,e as s}from"../../core/promiseUtils.js";import{L as i}from"../../chunks/Logger.js";import{a}from"../../chunks/maybe.js";import{watch as r,sync as o}from"../../core/reactiveUtils.js";import{aliasOf as n}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/lang.js";import"../../chunks/ensureType.js";import{property as l}from"../../core/accessorSupport/decorators/property.js";import{subclass as d}from"../../core/accessorSupport/decorators/subclass.js";import c from"../Widget.js";import h from"../../core/Error.js";import{g as u,f as p}from"../../chunks/number2.js";import{a as _,g as m}from"../../chunks/locale.js";import k from"./DatePickerViewModel.js";import{P as v}from"../../chunks/Popover.js";import{a as y}from"../../chunks/accessibleHandler.js";import{m as g}from"../../chunks/messageBundle.js";import{t as f}from"../../chunks/jsxFactory.js";import{s as w,m as D,i as b}from"../../chunks/widgetUtils.js";import{D as j,I as M,a as P}from"../../chunks/datetime.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/messages.js";import"../../request.js";import"../../config.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../chunks/jsonMap.js";import"../../chunks/handleUtils.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/tracking.js";import"../../chunks/metadata.js";import"../../chunks/domUtils.js";import"../../core/Evented.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../core/Collection.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../core/Promise.js";import"../../chunks/uuid.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/projector.js";import"../../chunks/jsxWidgetSupport.js";import"./DateTimeElementViewModel.js";function O(e){const t=[/٠/g,/١/g,/٢/g,/٣/g,/٤/g,/٥/g,/٦/g,/٧/g,/٨/g,/٩/g];for(let s=0;s<10;s++)e=e.replace(t[s],s.toString());return Number(e)}function C(e){return new h(`could not parse date input, expecting the following format: ${p(Date.now(),e)}`)}const x={ar:6,"ar-dz":6,"ar-kw":6,"ar-ly":6,"ar-ma":1,"ar-sa":7,"ar-tn":1,bg:1,bs:1,ca:1,cs:1,da:1,de:1,"de-at":1,"de-ch":1,el:1,"en-au":1,"en-ca":7,"en-gb":1,"en-ie":1,"en-il":7,"en-in":7,"en-nz":1,"en-sg":7,es:1,"es-do":7,"es-mx":7,"es-us":7,et:1,fi:1,fr:1,"fr-ca":7,"fr-ch":1,he:7,hr:1,hu:1,id:7,it:1,"it-ch":1,ja:7,ko:7,lt:1,lv:1,nb:1,nl:1,"nl-be":1,pl:1,pt:7,"pt-br":7,ro:1,ru:1,sk:1,sl:1,sr:1,"sr-cyrl":1,sv:1,th:7,tr:1,uk:1,vi:1,"zh-cn":7,"zh-hk":7,"zh-mo":7,"zh-tw":7},I="Locale"in Intl&&"weekInfo"in Intl.Locale.prototype;function N(e){if(e=e.toLowerCase(),x[e])return x[e];if(I)try{const t=new Intl.Locale(e).weekInfo.firstDay;return x[e]=t,t}catch{}const t=_(e);return x[t]?x[t]:7}const S="esri-date-picker__week-item",T="esri-date-picker__day-item",K="esri-date-picker__year-picker-item",Y={year:"numeric",month:"2-digit",day:"2-digit"},A=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],$=i.getLogger("esri.widgets.support.DatePicker");let E=class extends c{constructor(e,t){super(e,t),this._activeDate=null,this._calendarNode=null,this._calendarPopover=new v({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._inputOrButtonNode=null,this._isOpen=!1,this._requestDayPickerFocusOnCreate=!1,this._rootNode=null,this.dateInputEnabled=!1,this.label=void 0,this.messages=null,this.value=null,this.commitOnMonthChange=!1,this.viewModel=new k,this.disabled=!1,this._toggle=this._toggle.bind(this)}initialize(){this.own(r((()=>({viewModel:this.viewModel,value:this.viewModel?.value})),(({viewModel:e,value:t})=>{this.destroyed||!e||a(this.onChange)||this.onChange(t)}),o))}destroy(){this._calendarPopover.destroy()}render(){return f("div",{afterCreate:w,bind:this,class:this.classes("esri-date-picker","esri-widget"),"data-node-ref":"_rootNode"},this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())}renderButtonOnlyMode(){const e=p(this.viewModel.value,Y),{disabled:t,_isOpen:s,messages:i}=this;return f("div",{key:`date-button-${t}`,afterCreate:w,"aria-controls":s?this._getCalendarId():null,"aria-expanded":s.toString(),"aria-haspopup":"true","aria-label":i.setDate,"aria-pressed":s.toString(),bind:this,class:this.classes("esri-widget--button","esri-select","esri-date-picker__calendar-toggle"),"data-node-ref":"_inputOrButtonNode",onclick:this._toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:t?null:0},f("span",{class:"esri-date-picker__date"},e))}renderInputAndButtonMode(){const e=p(this.viewModel.value,Y),{_isOpen:t,messages:s}=this;return f("div",{class:this.classes("esri-date-picker__input")},f("input",{afterCreate:w,"data-node-ref":"_inputOrButtonNode","aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":s.setDate,bind:this,class:this.classes("esri-date-picker__text-input","esri-input"),key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),f("span",{"aria-hidden":"true",class:this.classes("esri-date-picker__icon--leading","esri-icon-calendar")}))}_handleDateInputClick(){this._open(this.viewModel.value,!1)}_handleDateInputKeyDown(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this._close():"ArrowDown"===t&&(this._open(this.viewModel.value),e.preventDefault())}_handleDateButtonKeyDown(e){const{key:t,shiftKey:s}=e;this._isOpen&&"Tab"===t&&s?this._close():D(t)&&this._toggle()}_handleDateInputBlur(e){this._isOpen||this._handleDateText(e)}_handleDateText(e){const t=e.currentTarget;let s;try{s=function(e,t){const s=u(t),i=Date.now(),a=s.formatToParts(i),r=new Set;a.filter((({type:e})=>"literal"===e)).forEach((({value:e})=>r.add(e)));let o=0;const n={};for(;a.length>0;){const{type:t,value:s}=a.shift();for(let i=0;i<s.length;i++,o++){const s=e.charAt(o);if(r.has(s)){o++;break}if("literal"===t)break;n[t]||(n[t]=[]),n[t].push(s)}}const l={};try{l.day=O(n.day.join("")),l.month=O(n.month.join("")),l.year=O((n.year||n.relatedYear).join(""))}catch(e){throw C(t)}if(isNaN(l.day)||isNaN(l.month)||isNaN(l.year))throw C(t);return l}(t.value,Y)}catch(e){return $.warn(e),void(t.value=p(this.viewModel.value,Y))}const i=j.fromObject(s);i.isValid?(this.viewModel.value=i.toJSDate(),this._activeDate=i):t.value=p(this.viewModel.value,Y)}_handleDatePickerKeydown(e){"Escape"===s(e)&&(this._close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate,t=j.fromJSDate(this.viewModel.value);return f("div",{afterCreate:w,bind:this,class:this.classes("esri-date-picker__calendar","esri-widget"),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_renderMonthPicker(e){const t=b(this.container),s=t?"esri-icon-right":"esri-icon-left",i=t?"esri-icon-left":"esri-icon-right",a=M.months("long",{locale:m()}).map(((t,s)=>{const i=e.month-1===s;return f("option",{selected:i,value:s.toString()},t)})),{disabled:r,messages:o}=this;return f("div",{class:"esri-date-picker__month-picker"},f("div",{key:`previous-month-${r}`,"aria-label":o.goToPreviousMonth,bind:this,class:"esri-widget--button",onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:r?null:0,title:o.goToPreviousMonth},f("span",{"aria-hidden":"true",class:s})),f("select",{"aria-live":"assertive","aria-label":o.selectMonth,bind:this,class:this.classes("esri-date-picker__month-dropdown","esri-select"),disabled:r,id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:o.selectMonth},a),f("div",{key:`next-month-${r}`,"aria-label":o.goToNextMonth,bind:this,class:"esri-widget--button",onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:r?null:0,title:o.goToNextMonth},f("span",{"aria-hidden":"true",class:i})))}_renderDayPicker(e,t){const s=this._getWeekLabels(),i=this._getDayId(e),a=this._renderMonth(e,t),{id:r,disabled:o}=this;return f("div",{key:`day-picker-${o}`,afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":`${r}__month-picker ${r}__selected-year`,bind:this,class:"esri-date-picker__day-picker",id:`${r}__day-picker`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:o?null:0},f("div",{class:S,role:"row"},s.map((e=>f("div",{"aria-label":e.name,class:this.classes(T,"esri-date-picker__day-item--header"),role:"columnheader",title:e.name},e.abbr)))),a)}_getDayId(e){return`${this.id}__${p(e.valueOf(),Y)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(){const e=[],t={weekday:"long"},s={weekday:"narrow"};let i=j.now().set({weekday:N(m())});for(let a=0;a<7;a++)e.push({name:p(i.valueOf(),t),abbr:p(i.valueOf(),s)}),i=i.plus({day:1});return e}_handleDayPickerKeydown(e){const{ctrlKey:t,shiftKey:i}=e,a=s(e);if(!A.includes(a))return;let r=this._activeDate;if("ArrowLeft"===a)r=r.minus({day:1});else if("ArrowRight"===a)r=r.plus({day:1});else if("ArrowUp"===a)r=r.minus({week:1});else if("ArrowDown"===a)r=r.plus({week:1});else if("PageUp"===a){const e=i?"year":"month";r=r.minus({[e]:1})}else if("PageDown"===a){const e=i?"year":"month";r=r.plus({[e]:1})}else if("Home"===a){const e=t?"year":"month";r=r.startOf(e)}else if("End"===a){const e=t?"year":"month";r=r.endOf(e)}else D(a)&&(this.viewModel.value=r.toJSDate(),this._close());this._activeDate=r,e.preventDefault(),e.stopPropagation()}_renderMonth(e,t){const s=j.now(),i=e.startOf("month"),a=e.endOf("month");var r,o;let n=i.minus({day:(r=m(),o=i.weekday,(o+7-N(r))%7)});const l=[];for(let r=0;r<6;r++){const r=[];for(let o=0;o<7;o++){const o=n.day,l=n.hasSame(e,"day"),d=n.hasSame(t,"day"),c=this._getDayId(n),h={"esri-date-picker__day-item--nearby-month":!P.fromDateTimes(i,a).contains(n),"esri-date-picker__day-item--today":n.hasSame(s,"day"),"esri-date-picker__day-item--active":l,"esri-date-picker__day-item--selected":d};r.push(f("div",{"aria-label":o.toString(),"aria-selected":l.toString(),bind:this,class:this.classes(T,h),"data-iso-date":n.toISO(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},o)),n=n.plus({day:1})}l.push(f("div",{class:S,role:"row"},r))}return l}_renderYearPicker(e){const t={year:"numeric"},s=e,i=p(s.valueOf(),t),a=p(s.plus({year:1}).valueOf(),t),r=p(s.minus({year:1}).valueOf(),t),{disabled:o,messages:n}=this;return f("div",{class:"esri-date-picker__year-picker"},f("div",{key:`previous-year-${o}`,"aria-label":n.goToPreviousYear,bind:this,class:K,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:o?null:0,title:n.goToPreviousYear},r),f("div",{class:this.classes(K,"esri-date-picker__year-picker-item--selected"),id:`${this.id}__selected-year`},i),f("div",{key:`next-year-${o}`,"aria-label":n.goToNextYear,bind:this,class:K,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:o?null:0,title:n.goToNextYear},a))}_toggle(){this._isOpen?this._close():this._open(this.viewModel.value)}_setMonth(e){const t=e.target,s=Number(t.value)+1;this._activeDate=this._activeDate.set({month:s}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())}_close(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,this.pageClickHandler.pause(),e&&this._inputOrButtonNode.focus()}_open(e,s=!0){this._activeDate=j.fromJSDate(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=s,this.pageClickHandler||(this.pageClickHandler=t(document,"click",(({target:e})=>{this._calendarNode?.contains(e)||this._rootNode?.contains(e)||this._close()})),this.own(this.pageClickHandler)),this.pageClickHandler.resume()}_setPreviousMonth(){this._activeDate=this._activeDate.minus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())}_handlePreviousMonthKeyDown(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this._close();D(e.key)&&this._setPreviousMonth()}_setNextMonth(){this._activeDate=this._activeDate.plus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())}_setPreviousYear(){this._activeDate=this._activeDate.minus({year:1})}_setNextYear(){this._activeDate=this._activeDate.plus({year:1})}_handleNextYearKeyDown(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this._close();D(e.key)&&this._setNextYear()}_handleSelectedDate(e){const t=e.target;this.viewModel.value=j.fromISO(t.getAttribute("data-iso-date")).toJSDate(),this._close()}};e([l()],E.prototype,"dateInputEnabled",void 0),e([l({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],E.prototype,"label",void 0),e([l(),g("esri/widgets/support/t9n/DatePicker")],E.prototype,"messages",void 0),e([n("viewModel.value")],E.prototype,"value",void 0),e([l()],E.prototype,"commitOnMonthChange",void 0),e([l({type:k})],E.prototype,"viewModel",void 0),e([l()],E.prototype,"onChange",void 0),e([l()],E.prototype,"disabled",void 0),e([y()],E.prototype,"_setNextMonth",null),e([y()],E.prototype,"_setPreviousYear",null),e([y()],E.prototype,"_handleSelectedDate",null),E=e([d("esri.widgets.support.DatePicker")],E);const B=E;export{B as default};
