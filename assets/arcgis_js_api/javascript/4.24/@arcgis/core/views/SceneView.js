/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Camera.js";import"../geometry.js";import i from"../Graphic.js";import r from"../Viewpoint.js";import s,{O as a}from"../core/Collection.js";import{b as n}from"../chunks/domUtils.js";import o from"../core/Error.js";import{createResolver as l,createAbortError as h,createTask as c,isAborted as d,isAbortError as u,throwIfAborted as p,after as m,onAbort as g,eachAlways as f,isPromiseLike as _,o as y}from"../core/promiseUtils.js";import{t as v,m as b,h as x}from"../chunks/handleUtils.js";import{clone as w,h as T,r as C,e as S,q as P,v as R,w as A,x as O,y as M,z as E,s as D,j as I,u as L}from"../core/lang.js";import N,{e as F}from"../core/Accessor.js";import{L as V}from"../chunks/Logger.js";import{i as U,a as z,r as j,d as k,p as G,k as q,j as B,e as H,m as W,f as Q,u as Z,h as X}from"../chunks/maybe.js";import{on as Y,watch as K,initial as $,syncAndInitial as J,when as ee,sync as te,whenOnce as ie}from"../core/reactiveUtils.js";import{schedule as re,s as se,M as ae,S as ne,m as oe,P as le,addFrameTask as he,a as ce,setFrameDuration as de}from"../core/scheduling.js";import{b as ue,s as pe,d as me,f as ge,c as fe,g as _e}from"../chunks/screenUtils.js";import{initialize as ye}from"../core/workers/workers.js";import{property as ve}from"../core/accessorSupport/decorators/property.js";import{cast as be}from"../core/accessorSupport/decorators/cast.js";import{subclass as xe}from"../core/accessorSupport/decorators/subclass.js";import{e as we,s as Te,j as Ce}from"../chunks/ensureType.js";import{c as Se,g as Pe,r as Re,f as Ae,h as Oe,s as Me,e as Ee,a as De,H as Ie,a2 as Le,k as Ne,n as Fe,X as Ve,o as Ue,d as ze,j as je,G as ke,b as Ge,v as qe,p as Be,A as He,u as We,w as Qe,i as Ze,q as Xe,F as Ye,y as Ke,L as $e,Z as Je,J as et,K as tt,a3 as it,I as rt,M as st,z as at,P as nt,a4 as ot,a5 as lt,t as ht,m as ct,T as dt,C as ut,E as pt,a6 as mt,a7 as gt,a8 as ft,a9 as _t,aa as yt,ab as vt,ac as bt,l as xt,B as wt}from"../chunks/mathUtils.js";import{o as Tt}from"../chunks/GraphicsCollection.js";import Ct from"../geometry/HeightModelInfo.js";import{canProjectToWGS84ComparableLonLat as St,projectPointToWGS84ComparableLonLat as Pt,projectBoundingRect as Rt,projectWithoutEngine as At,projectVectorToVector as Ot,lonLatToSphericalPCPF as Mt,projectPointToVector as Et,computeTranslationToOriginAndRotation as Dt,projectBoundingSphere as It,canProjectWithoutEngine as Lt,projectBuffer as Nt,project as Ft}from"../geometry/projection.js";import{c as Vt,e as Ut,o as zt,w as jt,m as kt,n as Gt,p as qt,q as Bt,r as Ht,i as Wt,a as Qt,N as Zt,s as Xt,f as Yt,u as Kt,v as $t,x as Jt,h as ei,y as ti,z as ii,A as ri,t as si}from"../chunks/aaBoundingRect.js";import{e as ai,c as ni,a as oi,t as li,d as hi,B as ci}from"../chunks/boundedPlane.js";import{c as di,v as ui,r as pi,R as mi}from"../chunks/RenderCoordsHelper.js";import{b as gi}from"../chunks/scaleUtils.js";import{b as fi,c as _i,d as yi,e as vi,f as bi}from"../chunks/layerUtils.js";import xi,{T as wi,A as Ti}from"./View.js";import{BreakpointsOwner as Ci}from"./BreakpointsOwner.js";import{DOMContainer as Si}from"./DOMContainer.js";import Pi from"./GroundView.js";import{e as Ri,h as Ai,a as Oi,i as Mi,j as Ei,D as Di,B as Ii,I as Li,P as Ni,S as Fi,c as Vi,d as Ui,f as zi,g as ji}from"../chunks/WebGLRequirements.js";import ki from"./ViewAnimation.js";import{V as Gi,s as qi,v as Bi}from"../chunks/ViewingMode.js";import{HandleOwner as Hi,W as Wi}from"../core/HandleOwner.js";import{e as Qi,m as Zi,a as Xi}from"../chunks/Ellipsoid.js";import{c as Yi,d as Ki,b as $i,e as Ji,m as er}from"../chunks/mathUtils2.js";import tr from"./3d/environment/SunLighting.js";import ir from"./3d/environment/VirtualLighting.js";import rr from"../webscene/Environment.js";import sr from"../webscene/SunLighting.js";import ar from"../webscene/VirtualLighting.js";import nr from"../Color.js";import or from"../core/Evented.js";import lr from"../core/Handles.js";import{c as hr,a as cr,f as dr,Z as ur,d as pr}from"../chunks/vec4f64.js";import mr,{f as gr,h as fr,b as _r,k as yr}from"../geometry/SpatialReference.js";import{g as vr,c as br}from"../chunks/projectionEllipsoid.js";import{a as xr,j as wr,c as Tr,e as Cr}from"../chunks/vec2.js";import{a as Sr,Z as Pr,f as Rr}from"../chunks/vec2f64.js";import{j as Ar,u as Or,z as Mr,c as Er,l as Dr,m as Ir,d as Lr,h as Nr,e as Fr,i as Vr,v as Ur}from"../chunks/mat4.js";import{c as zr,f as jr,I as kr}from"../chunks/mat4f64.js";import{T as Gr,i as qr,E as Br,e as Hr,P as Wr,M as Qr,j as Zr,f as Xr,k as Yr,A as Kr,l as $r,B as Jr,I as es,F as ts,m as is,R as rs,n as ss,N as as,o as ns,p as os,q as ls,r as hs,s as cs,d as ds,t as us,u as ps,g as ms,w as gs,x as fs,y as _s,z as ys,C as vs,h as bs,D as xs}from"../chunks/Matrix4Uniform.js";import{S as ws,M as Ts,h as Cs,z as Ss,j as Ps,R as Rs,c as As,P as Os,E as Ms,Q as Es,C as Ds,t as Is,T as Ls,p as Ns,F as Fs,b as Vs,V as Us,W as zs,U as js,B as ks,X as Gs,I as qs,d as Bs,g as Hs,O as Ws,k as Qs,Y as Zs,D as Xs,Z as Ys,s as Ks,m as $s,l as Js,_ as ea,o as ta,q as ia,$ as ra,a0 as sa,a1 as aa,a2 as na,H as oa}from"../chunks/glUtil3D.js";import{F as la,G as ha,C as ca,b as da,d as ua,f as pa,B as ma,A as ga,g as fa,t as _a,O as ya,S as va,h as ba,i as xa,W as wa,N as Ta,o as Ca,j as Sa,D as Pa,M as Ra,k as Aa,l as Oa,n as Ma,p as Ea,q as Da,r as Ia,s as La,u as Na,v as Fa,w as Va,x as Ua,y as za,T as ja,z as ka,E as Ga,H as qa,I as Ba,J as Ha,K as Wa}from"../chunks/lineUtils.js";import{F as Qa}from"../chunks/Float3Uniform.js";import{F as Za,e as Xa,T as Ya,S as Ka,f as $a,W as Ja,i as en,j as tn,C as rn,O as sn}from"../chunks/CameraSpace.glsl.js";import{g as an,D as nn,N as on,f as ln,b as hn,h as cn,j as dn,k as un,l as pn,R as mn,m as gn,n as fn,o as _n}from"../chunks/Material.js";import{V as yn}from"../chunks/VertexAttribute.js";import{B as vn,C as bn,P as xn,d as wn,T as Tn,a as Cn,b as Sn,f as Pn,c as Rn,U as An,e as On,g as Mn,D as En,m as Dn,k as In,i as Ln}from"../chunks/enums.js";import{m as Nn,s as Fn,d as Vn,i as Un,j as zn,a as jn,b as kn,o as Gn,c as qn,f as Bn,O as Hn}from"../chunks/OrderIndependentTransparency.js";import{p as Wn,S as Qn}from"../chunks/ShaderTechniqueConfiguration.js";import{h as Zn,k as Xn,l as Yn,m as Kn,n as $n,t as Jn,c as eo,o as to,e as io,a as ro,g as so}from"../chunks/sphere.js";import{c as ao,a as no,s as oo}from"../chunks/vectorStacks.js";import{w as lo}from"../chunks/weather.js";import{f as ho,t as co,e as uo,g as po,h as mo}from"../chunks/mat3.js";import{f as go}from"../chunks/vec2f32.js";import{f as fo,z as _o,c as yo,a as vo,b as bo}from"../chunks/vec3f32.js";import{b as xo,d as wo}from"../chunks/quatf64.js";import{F as To,R as Co}from"../chunks/FramebufferObject.js";import{T as So,S as Po,n as Ro,I as Ao,a as Oo}from"../chunks/Scheduler.js";import{r as Mo}from"../chunks/requestImageUtils.js";import{g as Eo}from"../chunks/glUtil.js";import{n as Do}from"../chunks/InterleavedLayout.js";import{G as Io}from"../chunks/GeometryUtil.js";import{v as Lo,V as No,B as Fo,b as Vo,u as Uo,g as zo}from"../chunks/VertexArrayObject.js";import{T as jo}from"../chunks/Texture.js";import{p as ko,a as Go}from"../chunks/Util.js";import{f as qo,g as Bo}from"../chunks/assets.js";import{A as Ho,H as Wo,a as Qo}from"../chunks/HUDMaterial.js";import{R as Zo,a as Xo}from"../chunks/RenderSlot.js";import{p as Yo}from"../chunks/earthUtils.js";import{c as Ko,C as $o,a as Jo,S as el,b as tl}from"../chunks/ShadowCastVisualizeTechniqueConfiguration.js";import il from"../webscene/background/ColorBackground.js";import{w as rl,c as sl}from"../chunks/ray.js";import{c as al,V as nl,a as ol,G as ll,b as hl,T as cl,h as dl,v as ul,t as pl,d as ml,e as gl,m as fl,F as _l,f as yl,E as vl,g as bl,i as xl,j as wl}from"../chunks/ElevationQuery.js";import{s as Tl,h as Cl,c as Sl,e as Pl,a as Rl,b as Al,i as Ol,t as Ml,d as El,f as Dl,g as Il,j as Ll,k as Nl,O as Fl,l as Vl,m as Ul,z as zl,n as jl,o as kl}from"../chunks/viewpointUtils.js";import{n as Gl}from"../chunks/compilerUtils.js";import{C as ql,P as Bl}from"../chunks/Camera.js";import{a as Hl,D as Wl,S as Ql,i as Zl,I as Xl,s as Yl,n as Kl}from"../chunks/Intersector.js";import{a as $l,C as Jl}from"../chunks/Cyclical.js";import{c as eh,i as th,t as ih,f as rh,n as sh,s as ah,u as nh,v as oh,j as lh,k as hh}from"../chunks/plane.js";import{b as ch,a as dh,c as uh}from"../chunks/ray2.js";import{T as ph,a as mh,b as gh}from"../chunks/verticalOffsetUtils.js";import{I as fh,a as _h,V as yh,P as vh}from"../chunks/InputManager.js";import{F as bh,M as xh,Z as wh,R as Th,P as Ch,l as Sh,a as Ph}from"../chunks/RenderingContext.js";import{f as Rh,r as Ah}from"../chunks/asyncUtils.js";import{createLabelFunction as Oh}from"../chunks/labelFormatUtils.js";import{b as Mh}from"../chunks/Symbol3DVerticalOffset.js";import{a as Eh,c as Dh,o as Ih,g as Lh,w as Nh,f as Fh,p as Vh}from"../chunks/aaBoundingBox.js";import{g as Uh,c as zh,N as jh}from"../chunks/watch.js";import{l as kh,D as Gh}from"../chunks/DefaultMaterial_COLOR_GAMMA.js";import{l as qh,H as Bh,E as Hh,a as Wh,p as Qh,C as Zh,D as Xh,N as Yh,M as Kh,F as $h,b as Jh,c as ec,e as tc}from"../chunks/objectResourceUtils.js";import{F as ic,V as rc}from"../chunks/FeatureTileDescriptor3D.js";import{j as sc,c as ac,k as nc,f as oc,l as lc,i as hc,m as cc,n as dc,o as uc,p as pc,P as mc,q as gc,N as fc,a as _c}from"../chunks/frustum.js";import{b as yc}from"../chunks/triangle.js";import{O as vc}from"../chunks/ArrayPool.js";import bc from"../geometry/Extent.js";import xc from"../geometry/Point.js";import{canProject as wc,y2lat as Tc}from"../geometry/support/webMercatorUtils.js";import{f as Cc}from"../chunks/unitUtils.js";import{g as Sc}from"../chunks/ElevationProvider.js";import{f as Pc,c as Rc}from"../chunks/vec4f32.js";import{getGeometryServiceURL as Ac}from"../chunks/geometryServiceUtils.js";import{p as Oc}from"../chunks/project.js";import Mc from"../rest/support/ProjectParameters.js";import{M as Ec,b as Dc}from"../chunks/MemCache.js";import Ic,{i as Lc}from"./3d/support/SceneViewPerformanceInfo.js";import{S as Nc,g as Fc,b as Vc,c as Uc,d as zc,r as jc,w as kc,I as Gc,e as qc,o as Bc,n as Hc,f as Wc,h as Qc,j as Zc,k as Xc,l as Yc,m as Kc,p as $c,q as Jc,s as ed,t as td,u as id,v as rd,x as sd,y as ad,a as nd,z as od,A as ld,B as hd,C as cd,D as dd,E as ud}from"../chunks/terrainUtils.js";import{isSVG as pd}from"../core/urlUtils.js";import{a as md,b as gd,V as fd,S as _d,C as yd,A as vd,T as bd,c as xd,D as wd,R as Td,U as Cd}from"../chunks/basicInterfaces.js";import{T as Sd}from"../chunks/Texture2.js";import"../symbols.js";import"../geometry/Polygon.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/PolygonSymbol3D.js";import Pd from"../symbols/PointSymbol3D.js";import Rd from"../symbols/IconSymbol3DLayer.js";import Ad from"../symbols/TextSymbol3DLayer.js";import{C as Od}from"../chunks/CollectionFlattener.js";import{aliasOf as Md}from"../core/accessorSupport/decorators/aliasOf.js";import{isRefreshableLayer as Ed}from"../layers/mixins/RefreshableLayer.js";import{E as Dd}from"../chunks/ElevationQueryTileCache.js";import{a as Id}from"../chunks/LercDecoder.js";import{V as Ld,p as Nd}from"../chunks/VectorTile.js";import{E as Fd,W as Vd,G as Ud,a as zd,b as jd,P as kd,c as Gd,T as qd,M as Bd,d as Hd,e as Wd,f as Qd}from"../chunks/TerrainConst.js";import{O as Zd,T as Xd,L as Yd,N as Kd,P as $d,R as Jd}from"../chunks/interfaces2.js";import{E as eu}from"../chunks/common.js";import{c as tu,g as iu,e as ru,f as su,h as au,a as nu,b as ou}from"../chunks/DefaultVertexAttributeLayouts.js";import{B as lu,b as hu}from"../chunks/BufferView.js";import cu from"./2d/ViewState.js";import{R as du}from"../chunks/RenderGeometry.js";import{a as uu,c as pu}from"../chunks/mat3f32.js";import{c as mu,a as gu}from"../chunks/vec3.js";import fu from"../request.js";import{c as _u,a as yu,m as vu}from"../chunks/quat.js";import{c as bu,a as xu,b as wu,r as Tu}from"../chunks/I3SBinaryReader.js";import Cu from"../rest/support/Query.js";import{g as Su}from"../chunks/geometryDataUtils.js";import{p as Pu,u as Ru}from"../chunks/floatRGBA.js";import{V as Au}from"../chunks/VertexColor.glsl.js";import{e as Ou,E as Mu,a as Eu,b as Du,u as Iu,V as Lu,c as Nu,g as Fu,R as Vu,S as Uu}from"../chunks/EdgeProcessingWorker.js";import{O as zu}from"../chunks/Octree.js";import{C as ju,a as ku}from"../chunks/context-util.js";import{W as Gu}from"../chunks/WorkerHandle.js";import{o as qu}from"../chunks/utils.js";import{c as Bu,r as Hu,e as Wu,a as Qu,t as Zu,s as Xu}from"../chunks/screenshotUtils.js";import{b as Yu,c as Ku}from"../chunks/intersectorUtilsConversions.js";import{h as $u}from"../chunks/hitTestSelectUtils.js";import{o as Ju}from"../chunks/layerViewUtils.js";import{i as ep,a as tp}from"../chunks/screenUtils2.js";import{i as ip}from"../chunks/spatialReferenceSupport.js";import rp from"./ui/DefaultUI.js";import"../core/Clonable.js";import"../chunks/get.js";import"../chunks/metadata.js";import"../chunks/tracking.js";import"../chunks/object.js";import"../config.js";import"../chunks/string.js";import"../chunks/nextTick.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polyline.js";import"../chunks/extentUtils.js";import"../chunks/typeUtils.js";import"../chunks/jsonMap.js";import"../geometry/support/jsonUtils.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number2.js";import"../chunks/locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"../chunks/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../chunks/colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../symbols/Font.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../chunks/Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"../chunks/messages.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/lineSegment.js";import"../Map.js";import"../Basemap.js";import"../chunks/loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/writeUtils.js";import"../Ground.js";import"../chunks/basemapUtils.js";import"../chunks/collectionUtils2.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../support/TablesMixin.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"./BasemapView.js";import"./Magnifier.js";import"../chunks/ViewEvents.js";import"../chunks/IViewEvents.js";import"../chunks/interfaces.js";import"./input/Input.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"./navigation/Navigation.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/heightModelInfoUtils.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/debugFlags.js";import"../chunks/projector.js";import"../chunks/widgetUtils.js";import"../widgets/Popup.js";import"../chunks/throttle.js";import"../widgets/Feature.js";import"../widgets/Widget.js";import"../chunks/uuid.js";import"../chunks/jsxWidgetSupport.js";import"../widgets/Attachments.js";import"../chunks/unitFormatUtils.js";import"../chunks/byteSizeEstimations.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"../chunks/messageBundle.js";import"../chunks/jsxFactory.js";import"../widgets/Feature/FeatureViewModel.js";import"../chunks/languageUtils.js";import"../chunks/datetime.js";import"../chunks/number.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/DataLayerSource.js";import"../chunks/executeQueryJSON.js";import"../chunks/utils5.js";import"../chunks/query.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/pbfQueryUtils.js";import"../chunks/pbf.js";import"../chunks/OptimizedGeometry.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/queryZScale.js";import"../rest/support/FeatureSet.js";import"../chunks/featureConversionUtils.js";import"../rest/support/RelationshipQuery.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../rest/support/StatisticDefinition.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties2.js";import"../symbols/support/jsonUtils.js";import"../chunks/symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"../chunks/DictionaryLoader.js";import"../chunks/LRUCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../chunks/heatmapUtils.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils2.js";import"../renderers/support/jsonUtils.js";import"../chunks/MultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../chunks/FeatureIndex.js";import"../layers/mixins/APIKeyMixin.js";import"../chunks/ArcGISService.js";import"../layers/mixins/BlendLayer.js";import"../chunks/jsonUtils.js";import"../chunks/parser2.js";import"../chunks/mat4f32.js";import"../chunks/_commonjsHelpers.js";import"../layers/mixins/CustomParametersMixin.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../chunks/OperationalLayer.js";import"../chunks/commonProperties.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/TimeReference.js";import"../chunks/featureReductionUtils.js";import"../chunks/FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/AggregateField.js";import"../layers/support/OutStatistic.js";import"../layers/support/LabelClass.js";import"../chunks/labelUtils.js";import"../chunks/defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../chunks/fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"../chunks/labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../chunks/versionUtils.js";import"../chunks/styleUtils.js";import"../support/popupUtils.js";import"../chunks/Heading.js";import"../widgets/support/widget.js";import"../chunks/accessibleHandler.js";import"../chunks/vmEvent.js";import"../chunks/themeUtils.js";import"../chunks/utils13.js";import"../chunks/numberUtils.js";import"../chunks/utils6.js";import"../chunks/ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils7.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../chunks/AnchorElementViewModel.js";import"../widgets/Popup/PopupViewModel.js";import"../symbols/support/symbolUtils.js";import"../chunks/colorUtils2.js";import"../chunks/mat2df32.js";import"../chunks/actions.js";import"../widgets/support/GoTo.js";import"../layers/support/ElevationSampler.js";import"../layers/support/TileInfo.js";import"../layers/support/LOD.js";import"../chunks/capabilities2.js";import"./3d/environment/SunnyWeather.js";import"../chunks/lightingTypes.js";import"../webscene/background/Background.js";import"../chunks/VertexElementDescriptor.js";import"../chunks/triangulationUtils.js";import"../chunks/earcut.js";import"../chunks/deduplicate.js";import"../chunks/NestedMap.js";import"../chunks/utils4.js";import"../chunks/doublePrecisionUtils.js";import"../chunks/dehydratedFeatures.js";import"../chunks/quantizationUtils.js";import"./3d/environment/CloudyWeather.js";import"./3d/environment/FoggyWeather.js";import"./3d/environment/RainyWeather.js";import"./3d/environment/SnowyWeather.js";import"../chunks/types.js";import"../chunks/VisualVariables.glsl.js";import"../chunks/GLTextureMaterial.js";import"../chunks/ElevationContext.js";import"../chunks/pointUtils.js";import"../chunks/callExpressionWithFeature.js";import"../chunks/lineStippleUtils.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"../chunks/projection.js";import"../chunks/NativeLineMaterial.js";import"../chunks/ColorMaterial.js";import"../chunks/ProgramCache.js";import"../chunks/Program.js";import"../chunks/Version.js";import"../chunks/devEnvironmentUtils.js";import"./3d/support/LayerPerformanceInfo.js";import"../chunks/enums3.js";import"../chunks/config.js";import"../chunks/TiledDisplayObject.js";import"../chunks/DisplayObject.js";import"../chunks/TileKey.js";import"../chunks/mat2df64.js";import"./ui/UI.js";import"../widgets/Attribution.js";import"../widgets/Attribution/AttributionViewModel.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";const sp=()=>import("../chunks/TileLayerView3D.js"),ap=()=>import("../chunks/ElevationLayerView3D.js"),np={"base-dynamic":()=>import("../chunks/BaseDynamicLayerView3D.js"),"base-elevation":ap,"base-tile":sp,"bing-maps":sp,"building-scene":()=>import("../chunks/BuildingSceneLayerView3D.js"),csv:()=>import("../chunks/CSVLayerView3D.js"),elevation:ap,feature:()=>import("../chunks/FeatureLayerView3D.js"),geojson:()=>import("../chunks/GeoJSONLayerView3D.js"),graphics:()=>import("../chunks/GraphicsLayerView3D.js"),group:()=>import("../chunks/GroupLayerView.js"),imagery:()=>import("../chunks/ImageryLayerView3D.js"),"integrated-mesh":()=>import("../chunks/IntegratedMeshLayerView3D.js"),"line-of-sight":()=>import("../chunks/LineOfSightLayerView3D.js"),"map-image":()=>import("../chunks/MapImageLayerView3D.js"),media:()=>import("../chunks/MediaLayerView3D.js"),"ogc-feature":()=>import("../chunks/OGCFeatureLayerView3D.js"),"open-street-map":sp,"point-cloud":()=>import("../chunks/PointCloudLayerView3D.js"),voxel:()=>import("../chunks/VoxelLayerView3D.js"),route:()=>import("../chunks/RouteLayerView3D.js"),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import("../chunks/SceneLayerView3D.js"):import("../chunks/SceneLayerGraphicsView3D.js"),stream:()=>import("../chunks/StreamLayerView3D.js"),tile:sp,"imagery-tile":()=>import("../chunks/ImageryTileLayerView3D.js"),"vector-tile":()=>import("../chunks/VectorTileLayerView3D.js"),wcs:()=>import("../chunks/ImageryTileLayerView3D.js"),"web-tile":sp,wfs:()=>import("../chunks/WFSLayerView3D.js"),wms:()=>import("../chunks/WMSLayerView3D.js"),wmts:()=>import("../chunks/WMTSLayerView3D.js"),"geo-rss":null,kml:null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null},op=V.getLogger("esri.views.3d.analysis.AnalysisViewManager3D");var lp,hp;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(lp||(lp={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(hp||(hp={}));let cp=class extends Hi{constructor(e){super(e),this._allAnalysisViews=new s,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=l(),this._analysisModules={"area-measurement":{module:null},dimensioning:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(h("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(h()),this._attachedToViewResolver=l(),this._attachedToViewResolver.promise.catch((()=>{}))}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(z(t)||t.state.list===hp.REMOVED)throw new o("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),"analyses-owner-handles")}_disconnectOwners(){this.handles.remove("analyses-owner-handles"),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return{remove:()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}}}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:lp.PENDING,list:hp.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=c((e=>this._createAnalysisViewPromise(t,e)))}else t.state.list=hp.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=hp.REMOVED,this._scheduleUpdate()):op.error("Trying to remove analysis which was not added")}_scheduleUpdate(){U(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=re((()=>this._update())))}_update(){this._scheduledUpdateHandle=j(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list===hp.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case lp.PENDING:e.createAnalysisViewTask=G(e.createAnalysisViewTask);break;case lp.CREATED:U(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=k(e.view),e.createAnalysisViewTask=null)}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,z(s.module))try{s.module=await this._loadAnalysisModule(r)}catch(e){throw this._creatingViewCount-=1,e}if(d(t))throw this._creatingViewCount-=1,h("AnalysisView creation aborted");const a=new s.module.default({analysis:i,view:this.view});try{await a.when()}catch(e){throw this._creatingViewCount-=1,e}if(d(t))throw this._creatingViewCount-=1,a.destroy(),h("AnalysisView creation aborted");return e.view=a,e.state.view=lp.CREATED,this._allAnalysisViews.add(a),this._creatingViewCount-=1,a}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./3d/analysis/AreaMeasurementAnalysisView3D.js");case"dimensioning":return import("../chunks/DimensioningAnalysisView3D.js");case"direct-line-measurement":return import("./3d/analysis/DirectLineMeasurementAnalysisView3D.js");case"line-of-sight":return import("./3d/analysis/LineOfSightAnalysisView3D.js");case"slice":return import("./3d/analysis/SliceAnalysisView3D.js")}}};e([ve()],cp.prototype,"updating",null),e([ve({constructOnly:!0})],cp.prototype,"view",void 0),e([ve()],cp.prototype,"_allAnalysisViews",void 0),e([ve()],cp.prototype,"_creatingViewCount",void 0),cp=e([xe("esri.views.3d.analysis.AnalysisViewManager3D")],cp);const dp=cp,up=V.getLogger("esri.views.3d.state.Constraints");let pp=class extends N{constructor(e){super(e),this.collision=new _p,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return this.mode===Gi.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Gi.Local?this._set("altitude",e):up.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?Se(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Se(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Gi.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=fp)=>(i.min=gp.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?Yi([[4e3,gp.max],[1e4,Pe(88)],[6e6,Pe(88)]]):()=>gp.max;return(t,i=fp)=>(i.min=gp.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?Yi([[4e3,gp.max],[5e4,Pe(88)],[6e6,Pe(88)],[2e7,gp.min]]):Yi([[3e5,gp.max],[3e6,Pe(88)],[6e6,Pe(88)],[2e7,gp.min]]);return(t,i=fp)=>(i.min=gp.min,i.max=e(t),i)}};e([ve()],pp.prototype,"altitude",null),e([ve({readOnly:!0})],pp.prototype,"collision",void 0),e([ve()],pp.prototype,"distance",void 0),e([ve({readOnly:!0})],pp.prototype,"minimumPoiDistance",void 0),e([ve()],pp.prototype,"tilt",void 0),e([ve({constructOnly:!0})],pp.prototype,"mode",void 0),pp=e([xe("esri.views.3d.state.Constraints")],pp);const mp={min:-2e5,max:4*Qi.radius},gp={min:Pe(.5),max:Pe(179.5)},fp={min:0,max:0};let _p=class extends N{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};e([ve({type:Boolean})],_p.prototype,"enabled",void 0),e([ve({type:Number})],_p.prototype,"elevationMargin",void 0),_p=e([xe("esri.views.3d.state.Constraints.CollisionConstraint")],_p);let yp=class extends N{constructor(){super(...arguments),this.min=mp.min,this.max=mp.max}};e([ve({type:Number})],yp.prototype,"min",void 0),e([ve({type:Number})],yp.prototype,"max",void 0),yp=e([xe("esri.views.3d.constraints.AltitudeConstraint")],yp);let vp=class extends N{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};e([ve({type:Number,value:1e-8})],vp.prototype,"near",null),e([be("near")],vp.prototype,"castNear",null),e([ve({type:Number,value:1e-8})],vp.prototype,"far",null),e([be("far")],vp.prototype,"castFar",null),e([ve({type:["auto","manual"]})],vp.prototype,"mode",void 0),vp=e([xe("esri.views.3d.constraints.ClipDistanceConstraint")],vp);const bp={min:Re(gp.min),max:Re(gp.max)};let xp=class extends N{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Se(e,bp.min,bp.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};e([ve({type:["auto","manual"]})],xp.prototype,"mode",void 0),e([ve({type:Number,value:bp.max})],xp.prototype,"max",null),e([be("max")],xp.prototype,"castMax",null),xp=e([xe("esri.views.3d.constraints.TiltConstraint")],xp);let wp=class extends N{constructor(){super(...arguments),this.tilt=new xp,this.altitude=new yp,this.clipDistance=new vp}};e([ve({type:xp})],wp.prototype,"tilt",void 0),e([ve({type:yp})],wp.prototype,"altitude",void 0),e([ve({type:vp})],wp.prototype,"clipDistance",void 0),wp=e([xe("esri.views.3d.constraints.Constraints")],wp);const Tp={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:tr,virtual:ir}};var Cp;let Sp=Cp=class extends N{set quality(e){["low","high"].includes(e)&&this._set("quality",e)}clone(){return new Cp({quality:this.quality})}};var Pp;e([ve({type:["low","high"],value:"low"})],Sp.prototype,"quality",null),Sp=Cp=e([xe("esri.views.3d.environment.SceneViewAtmosphere")],Sp);let Rp=Pp=class extends rr{constructor(e){super(e),this.atmosphere=new Sp,this.lighting=new tr}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Pp({...t,lighting:"virtual"===t.lighting.type?ir.fromWebsceneLighting(t.lighting):tr.fromWebsceneLighting(t.lighting)})}castLighting(e){return this._convertLighting(e)}applyLighting(e){this.lighting=this._convertLighting(e)}_convertLighting(e){return e?e instanceof tr||e instanceof ir?e:e instanceof sr?this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new tr(e.cloneConstructProperties()):e instanceof ar?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new ir(e.cloneConstructProperties()):we(Tp,e):new tr}clone(){return new Pp({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:w(this.background)})}cloneWithWebsceneEnvironment(e){return new Pp({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:w(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){return"sun"===e.lighting.type?this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):tr.fromWebsceneLighting(e.lighting):"virtual"===e.lighting.type?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):ir.fromWebsceneLighting(e.lighting):tr.fromWebsceneLighting(e.lighting)}};e([ve({type:Sp,json:{read:!1},nonNullable:!0})],Rp.prototype,"atmosphere",void 0),e([ve({nonNullable:!0})],Rp.prototype,"lighting",void 0),e([be("lighting")],Rp.prototype,"castLighting",null),Rp=Pp=e([xe("esri.views.3d.environment.SceneViewEnvironment")],Rp);const Ap=Rp;function Op(e){return Math.min(1,Math.max(0,(e-1e5)/9e5))}const Mp=Ae(5802e-9,13558e-9,331e-7),Ep=Ae(3*65e-8,5643e-9,255e-9),Dp=zr(),Ip=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new ws;t.attributes.add(yn.POSITION,"vec2"),t.include(Gr,{textureCoordinateType:qr.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:r}=t;return i.uniforms.add([new Ts("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new Ts("inverseViewMatrix",((e,t)=>Ar(Dp,t.camera.viewMatrix)))]),i.code.add(an`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add([new Cs("lightingMainDirection",((e,t)=>t.lighting.lightingMainDirection)),new la("radii"),new Za("scaleHeight"),new Qa("cameraPosition"),new Xa("heightParameters"),new Za("innerFadeDistance"),new Za("altitudeFade"),new Ya("depthTex"),new Qa("betaRayleigh"),new Qa("betaCombined"),new Za("betaMie"),new Za("hazeStrength")]),t.include(ha),e.haze&&(r.include(Ss),r.uniforms.add(new Ps("nearFar",((e,t)=>t.camera.nearFar)))),r.code.add(an`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(an`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),r.code.add(an`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),r.code.add(an`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${e.haze?an`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${e.haze?an``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${e.haze?"":an`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.05968310365 * mumu;

      ${e.haze?an`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:an`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${e.haze?an`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:an`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${e.haze?an`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:an`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${e.haze?"":an`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class Lp extends As{initializeProgram(e){const t=Lp.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return this.configuration.haze?Nn({blending:Fn(vn.ONE,vn.ZERO,vn.ONE_MINUS_SRC_COLOR,vn.ONE),colorWrite:Vn}):Nn({blending:Fn(vn.SRC_ALPHA,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),depthTest:{func:bn.LEQUAL},colorWrite:Vn})}}Lp.shader=new Rs(Ip,(()=>Promise.resolve().then((()=>Ip))));class Np extends Qn{constructor(){super(...arguments),this.haze=!1}}e([Wn()],Np.prototype,"haze",void 0);class Fp{constructor(e){this._view=e,this.type="realistic",this.canRender=!0,this._cameraPosition=Oe(),this._heightParameters=hr(),this._betasRayleigh=Oe(),this._betasCombined=Oe(),this._scaleHeight=0,this._radii=Sr(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=Qi.radius,this._hazeStrength=1,this._darkenHaze=!1,this._updateRadius(Qi.radius)}destroy(){this._atmosphereTechnique=q(this._atmosphereTechnique),this._atmosphereHazeTechnique=q(this._atmosphereHazeTechnique),this._vao=B(this._vao),this._handles=k(this._handles)}when(){return Promise.resolve()}initializeRenderContext(e){const t=e.renderContext.rctx,i=this._handles=new lr,r=this._view.basemapTerrain;U(r.rootTiles)&&this._updateElevation({spatialReference:r.spatialReference,tile:r.rootTiles[0],extent:r.rootTiles[0].extent,context:"ground"}),i.add(Y((()=>this._view.basemapTerrain),"elevation-change",(e=>this._updateElevation(e)),{onListenerAdd:()=>this._updateElevation()})),i.add(Y((()=>this._view.basemapTerrain),"elevation-bounds-change",(()=>this._updateVisibleElevationBounds())));const s=new Np;s.haze=!1,this._atmosphereTechnique=e.shaderTechniqueRepository.acquire(Lp,s),s.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRepository.acquire(Lp,s),this._vao=Ms(t,Es),this._scaleHeight=8500,Me(this._betasRayleigh,Mp[0],Mp[1],Mp[2]),Me(this._betasCombined,Mp[0]+Ep[0],Mp[1]+Ep[1],Mp[2]+Ep[2])}render(e){this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}renderHaze(e,t){this._darkenHaze=t,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}_render(e,t,i){this._update(e.bindParameters.camera);const r=e.rctx.bindTechnique(t,Vp,e.bindParameters);e.offscreenRenderingHelper.renderDepthDetached((()=>{r.bindTexture("depthTex",i),this._renderCommon(t.program,e)}))}_renderCommon(e,t){if(z(this._vao))return;const i=t.rctx;e.setUniform4fv("heightParameters",this._heightParameters),e.setUniform3fv("cameraPosition",this._cameraPosition),e.setUniform2fv("radii",this._radii),e.setUniform1f("scaleHeight",this._scaleHeight),e.setUniform1f("betaMie",3996e-9),e.setUniform3fv("betaRayleigh",this._betasRayleigh),e.setUniform3fv("betaCombined",this._betasCombined),e.setUniform1f("innerFadeDistance",this._innerFadeDistance),e.setUniform1f("altitudeFade",this._altitudeFade),e.setUniform1f("hazeStrength",this._hazeStrength),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(xn.TRIANGLE_STRIP,0,4)}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateElevation(e){const t=e?e.tile:H(this._view.basemapTerrain.rootTiles,[null])[0];if(z(t)||0!==t.level)return;const i=this._adjustRadiusForTesselation(Qi.radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(Qi.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,xr(this._radii,e,e+1e5),this._innerFadeDistance=2*Math.sqrt(1e4*(2*e-1e4))}_update(e){if(z(e))return;this._cameraHeight=Ee(e.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const t=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/1e5));this._heightParameters=cr(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,t),De(this._cameraPosition,e.eye),this._altitudeFade=Op(this._cameraHeight-this._lowerBoundEarthRadius),this._hazeStrength=this._darkenHaze?Ie(.6,1,Le(9500,10500,this._cameraHeight-Qi.radius)):1}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const Vp=new on;function Up(e=kp){return[e[0],e[1],e[2],e[3]]}function zp(e,t){return function(e,t,i,r,s=Up()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}(e[0],e[1],e[2],t,ao.get())}function jp(e,t,i=Up()){return Ne(i,e,t),Fe(i,i),i[3]=Zn(e,t),i}const kp=[0,0,1,0],Gp=zr(),qp=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new ws;e.attributes.add(yn.POSITION,"vec2"),e.varyings.add("worldRay","vec3");const{vertex:t,fragment:i}=e;return t.uniforms.add([new Ts("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new Ts("inverseViewMatrix",((e,t)=>Ar(Gp,t.camera.viewMatrix)))]),t.code.add(an`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),i.include(Ds),i.include(Is),e.include(Br,{pbrMode:Hr.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(Wr),e.include(ha),e.include(Qr,{isGround:!1}),e.include(ca,{instancedDoublePrecision:!1,isGround:!1}),i.uniforms.add([new Cs("cameraPosition",((e,t)=>t.camera.eye))]),i.code.add(an`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}},Symbol.toStringTag,{value:"Module"}));class Bp extends As{constructor(e){super(e,null,(()=>this.destroy()))}initializeProgram(e){const t=Bp.shader.get().build();return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Un(vn.ONE,vn.SRC_ALPHA),depthTest:{func:bn.LEQUAL},colorWrite:Vn})}}function Hp(e){return U(e)&&!e.running}Bp.shader=new Rs(qp,(()=>Promise.resolve().then((()=>qp))));let Wp=class extends N{constructor(e){super(e),this._technique=new Bp(e),this._vao=Ms(e.rctx)}destroy(){this._technique=q(this._technique),this._vao=B(this._vao)}render(e,t){const i=e.bindParameters.clouds;if(z(this._vao)||z(i.data))return;if(!this._technique.compiled)return void this.requestRender();this._setParallaxParameters(i,e.bindParameters.camera.eye,t);const r=e.rctx.bindTechnique(this._technique,im,e.bindParameters);e.rctx.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(xn.TRIANGLE_STRIP,0,4),function(e){return e.crossFade.enabled||e.fadeInOut.stage!==da.FINISHED||e.fadeIn.stage!==ua.FINISHED||e.fadeInOutHeight.stage!==pa.FINISHED}(i)&&this.requestRender()}_setFadeInStage(e,t){const i=performance.now(),r=e.parallax.anchorPointClouds;e.fadeIn.stage===ua.FINISHED&&(e.fadeIn.factor=1,De(r,Xp),e.fadeIn.stage=ua.CHANGE_ANCHOR,e.crossFade.enabled=!1,e.fadeInOut.stage=da.FINISHED);const s=tm(e,t);e.fadeIn.stage===ua.CHANGE_ANCHOR&&s&&Hp(e.data)&&(De(r,Xp),e.fadeIn.stage=ua.FADE_IN,e.startTime=i),e.fadeIn.factor>0&&e.fadeIn.stage===ua.FADE_IN&&(e.fadeIn.factor=1-(i-e.startTime)/Kp),e.fadeIn.factor<=0&&e.fadeIn.stage===ua.FADE_IN&&(e.fadeIn.stage=ua.FINISHED,e.fadeIn.factor=0)}_setCrossFadingStage(e){const t=performance.now(),{crossFade:i}=e,r=e.parallax.anchorPointClouds;e.crossFade.enabled||(De(e.parallaxNew.anchorPointClouds,Xp),e.startTime=t,i.factor=0,e.crossFade.enabled=!0),i.factor<1&&e.crossFade.enabled&&(i.factor=(t-e.startTime)/Jp),i.factor>=1&&e.crossFade.enabled&&(e.crossFade.enabled=!1,i.factor=1,De(r,e.parallaxNew.anchorPointClouds))}_setFadeInOutStage(e,t){const i=performance.now(),{fadeInOut:r,crossFade:s}=e;r.stage===da.FINISHED&&(e.startTime=i,r.factor=0,r.stage=da.FADE_OUT),r.factor<1&&r.stage===da.FADE_OUT&&(r.factor=(i-e.startTime)/$p),r.factor>=1&&r.stage===da.FADE_OUT&&(r.factor=1,De(e.parallax.anchorPointClouds,Xp)),r.factor>=1&&r.stage===da.FADE_OUT&&tm(e,t)&&(r.factor=1,r.stage=da.SWITCH,e.crossFade.enabled=!1,s.factor=1),Hp(e.data)&&r.stage===da.SWITCH&&(e.startTime=i,r.factor=1,r.stage=da.FADE_IN,De(e.parallax.anchorPointClouds,Xp),e.crossFade.enabled=!1,s.factor=1),r.factor>0&&r.stage===da.FADE_IN&&(r.factor=1-(i-e.startTime)/Kp),r.factor<=0&&r.stage===da.FADE_IN&&(r.stage=da.FINISHED,r.factor=0)}_setFadeInOutHeight(e,t){const i=performance.now(),r=e.fadeInOutHeight,s=(i-(r.stage===pa.FINISHED?i:e.startTimeHeightFade))/em;r.factor+=t?-s:s,e.startTimeHeightFade=i,r.factor=Se(r.factor,0,1),r.stage=pa.HEIGHT_FADE}_setParallaxParameters(e,t,i){const{parallax:r}=e;e.fadeInOutHeight.factor<0&&(e.fadeInOutHeight.factor=Ee(t)-this.planetRadius>lo?1:0),Fe(Xp,t),Ue(Xp,Xp,this.planetRadius),0===r.anchorPointClouds[0]&&0===r.anchorPointClouds[1]&&0===r.anchorPointClouds[2]&&De(r.anchorPointClouds,Xp);const s=Ee(ze(Yp,r.anchorPointClouds,Xp));let a=!0;s>e.fadeIn.distanceThresholdFactor*r.cloudsHeight||e.fadeIn.stage!==ua.FINISHED?this._setFadeInStage(e,t):s>e.fadeInOut.distanceThresholdFactor*r.cloudsHeight||e.fadeInOut.stage!==da.FINISHED?this._setFadeInOutStage(e,t):s>e.crossFade.distanceThresholdFactor*r.cloudsHeight&&!i||e.crossFade.enabled?this._setCrossFadingStage(e):a=!1;const n=Ee(t),o=n-this.planetRadius;if((o>1.7*lo||o<-lo)&&e.fadeInOutHeight.factor<1?e.fadeInOutHeight.factor=1:(o>lo||o<-.35*lo)&&e.fadeInOutHeight.factor<1?this._setFadeInOutHeight(e,!1):o<lo&&o>-.35*lo&&e.fadeInOutHeight.factor>0?this._setFadeInOutHeight(e,!0):e.fadeInOutHeight.stage=pa.FINISHED,r.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(n*n-this.planetRadius*this.planetRadius,0))/n,jp(Qp,r.anchorPointClouds,Zp),r.transform=zr(),Or(r.transform,r.transform,Zp[3],Zp),a){const{parallaxNew:t}=e;jp(Qp,t.anchorPointClouds,Zp),t.transform=zr(),Or(t.transform,t.transform,Zp[3],Zp)}De(e.cameraPositionLastFrame,t)}};e([ve({constructOnly:!0})],Wp.prototype,"rctx",void 0),e([ve({constructOnly:!0})],Wp.prototype,"viewingMode",void 0),e([ve({constructOnly:!0})],Wp.prototype,"planetRadius",void 0),e([ve({constructOnly:!0})],Wp.prototype,"requestRender",void 0),Wp=e([xe("esri.views.3d.environment.CloudsComposition")],Wp);const Qp=Ae(0,0,1),Zp=Up(),Xp=Oe(),Yp=Oe(),Kp=500,$p=250,Jp=500,em=500;function tm(e,t){return Ve(e.cameraPositionLastFrame,t)}const im=new on;var rm;!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(rm||(rm={}));class sm extends Qn{constructor(){super(...arguments),this.steps=rm.SIXTEEN}}e([Wn({count:rm.COUNT})],sm.prototype,"steps",void 0);const am=T("esri-mobile")?64:128,nm=am/128,om=Math.ceil(Math.sqrt(am)),lm=(am+2)*om,hm=lm/1560;class cm extends on{constructor(){super(...arguments),this.viewMatrix=xo()}}const dm=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:cm,build:function(e){const t=new ws;return t.include(Ka,!1),t.fragment.uniforms.add(new Za("cloudRadius")),t.fragment.uniforms.add(new Za("halfCubeMapSize")),t.fragment.uniforms.add(new Za("power")),t.fragment.uniforms.add(new Za("sigmaE")),t.fragment.uniforms.add(new Za("density")),t.fragment.uniforms.add(new Za("cloudSize")),t.fragment.uniforms.add(new Za("detailSize")),t.fragment.uniforms.add(new Za("smoothness")),t.fragment.uniforms.add(new Za("cloudHeight")),t.fragment.uniforms.add(new Za("coverage")),t.fragment.uniforms.add(new Zr("view",(e=>e.viewMatrix))),t.fragment.uniforms.add(new Ya("cloudShapeTexture")),t.fragment.code.add(an`
    const int STEPS = ${e.steps===rm.SIXTEEN?an`16`:e.steps===rm.HUNDRED?an`100`:an`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.fragment.code.add(an`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${an.float(lm)};
      const float dataWidth = ${an.float(lm)};
      const float tileRows = ${an.float(om)};
      const vec3 atlasDimensions = vec3(${an.float(am)}, ${an.float(am)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${an.float(nm)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Non-power-of-two textures can't be tiled using WebGL1
      // Get fractional part of uv to tile
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = fract((${an.float(hm)} * p) / ${an.float(lm)} + 0.5);

      return texture2D(cloudShapeTexture, uv).a;
    }
    `),t.fragment.code.add(an`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.fragment.code.add(an`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),t.fragment.code.add("\n    vec3 multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      vec3 luminance = vec3(0);\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),t.fragment.code.add(an`vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.fragment.code.add(an`vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return vec3(0);
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
vec3 color = vec3(0.0);
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return color;
}`),t.fragment.code.add(an`void main() {
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
if (hitsPlanet) {
gl_FragColor = vec4(vec3(0), 1);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
float totalTransmittance = 1.0;
vec3 sunDirection = normalize(vec3(0, 0, 1));
vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;
gl_FragColor = vec4(col, totalTransmittance);
}`),t}},Symbol.toStringTag,{value:"Module"}));class um{constructor(e,t,i,r,s,a,n,o,l=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=s,this.smoothness=a,this.cloudHeight=n,this.raymarchingStepType=o,this.median=l}}const pm={sunny:new um([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],rm.SIXTEEN),cloudy:new um([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],rm.TWOHUNDRED,.6),rainy:new um([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],rm.TWOHUNDRED,.4),snowy:new um([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],rm.HUNDRED,.65),foggy:new um([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],rm.SIXTEEN)};class mm extends As{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){const t=mm.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Fn(vn.ONE,vn.ONE,vn.ZERO,vn.ZERO),depthTest:{func:bn.LEQUAL},colorWrite:Vn})}}var gm;mm.shader=new Rs(dm,(()=>Promise.resolve().then((()=>dm)))),function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(gm||(gm={}));class fm extends Qn{constructor(){super(...arguments),this.mode=gm.Full}}e([Wn({count:gm.COUNT})],fm.prototype,"mode",void 0);const _m=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new ws;if(t.include(Ka,!1),t.fragment.code.add(an`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),t.fragment.uniforms.add(new la("weatherTile")),e.mode===gm.Full){const e=2,i=8;t.fragment.code.add(an`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${an.float(om)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${an.float(i)});

      float worley0 = worley(p, ${an.float(e)} * 2.0);
      float worley1 = worley(p, ${an.float(e)} * 8.0);
      float worley2 = worley(p, ${an.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${an.float(e)});
      float worley1 = worley(p, ${an.float(e)} * 2.0);
      float worley2 = worley(p, ${an.float(e)} * 4.0);
      float worley3 = worley(p, ${an.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.code.add(an`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${an.float(128)});

      // Get global coordinates of p
      p += weatherTile * ${an.float(128)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${an.float(1e5)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),t.fragment.code.add(an`void main() {`),e.mode===gm.Full&&t.fragment.code.add(an`
        float padWidth = 1.0;
        float paddedSize = ${an.float(am)} + 2.0 * padWidth;
        float tileCount = ${an.float(om)} * ${an.float(om)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${an.float(am)};
          }

          if (startPadY) {
            pixel.y += ${an.float(am)};
          }

          if (endPadX) {
            pixel.x -= ${an.float(am)};
          }

          if (endPadY) {
            pixel.y -= ${an.float(am)};
          }

          uv = vec2(pixel.xy / ${an.float(am)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${an.float(am)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${an.float(om)} * ${an.float(om)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${an.float(om)} * ${an.float(om)});
        p = p_;
        p.z /= (${an.float(om)} * ${an.float(om)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),t.fragment.code.add(an`
      vec2 mapUV = ${an.float(128)} * (gl_FragCoord.xy / ${an.float(lm)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${e.mode===gm.Full?an`gl_FragColor.ba = vec2(0.0, map);`:an`gl_FragColor = vec4(map);`};
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class ym extends As{initializeProgram(e){const t=ym.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:this.configuration.mode===gm.Full?Un(vn.ONE,vn.ZERO):Fn(vn.ZERO,vn.ONE,vn.ONE,vn.ZERO),depthTest:{func:bn.ALWAYS},colorWrite:Vn})}}ym.shader=new Rs(_m,(()=>Promise.resolve().then((()=>_m))));class vm extends N{constructor(e){let t;super(e),this._weatherTile=go(0,0),this._needsRender=!0,this._frameBuffer=new To(e.context.renderContext.rctx,{colorTarget:wn.TEXTURE,width:lm,height:lm},{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:Rn.LINEAR,hasMipmap:!1,width:lm,height:lm}),this._vao=Ms(e.context.renderContext.rctx),this._shaderTechniqueRepository=e.context.shaderTechniqueRepository,this._ensureRendered=()=>(U(t)?U(this.weatherMapTechnique)&&this.weatherMapTechnique.compiled&&this._needsRender&&(t=this._render(e.context.renderContext.rctx,gm.WeatherMap)):U(this.fullTechnique)&&this.fullTechnique.compiled&&(t=this._render(e.context.renderContext.rctx,gm.Full)),t)}get textureAtlas(){return this._ensureRendered()}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._weatherTile[0]===e[0]&&this._weatherTile[1]===e[1]||(this._weatherTile=e,this._setDirty())}destroy(){this._fullTechnique=q(this._fullTechnique),this._weatherMapTechnique=q(this._weatherMapTechnique),this._frameBuffer=B(this._frameBuffer),this._vao=B(this._vao)}get fullTechnique(){if(z(this._fullTechnique)){const e=new fm;e.mode=gm.Full,this._fullTechnique=this._shaderTechniqueRepository.acquire(ym,e)}return this._fullTechnique}get weatherMapTechnique(){if(z(this._weatherMapTechnique)){const e=new fm;e.mode=gm.WeatherMap,this._weatherMapTechnique=this._shaderTechniqueRepository.acquire(ym,e)}return this._weatherMapTechnique}_render(e,t){if(z(this._vao)||z(this._frameBuffer))return null;const i=t===gm.Full?this.fullTechnique:this.weatherMapTechnique;if(z(i))return null;const r=e.getViewport();e.setViewport(0,0,lm,lm),e.bindFramebuffer(this._frameBuffer);const s=e.bindTechnique(i);return s.setUniform2f("weatherTile",this._weatherTile[0],this._weatherTile[1]),e.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4),e.setViewport(r.x,r.y,r.width,r.height),this._needsRender=!1,this._frameBuffer.colorTexture}}e([ve({constructOnly:!0})],vm.prototype,"context",void 0);let bm=class extends N{constructor(e){super(e),this._frameTask=null,this._handles=new lr,this._cubeMapSize=T("esri-mobile")?1024:2048,this._techniques=[],this._techniqueConfiguration=new sm,this._bindParameters=new ma(null,null,null),this._drawParameters=new cm,this._weatherTile=go(0,0),this._weatherTileCount=128,this.coverage=Ie(Cm.coverage[0],Cm.coverage[1],.5),this.density=Ie(Cm.density[0],Cm.density[1],.5),this.absorption=Ie(Cm.absorption[0],Cm.absorption[1],.5),this.cloudSize=Ie(Cm.cloudSize[0],Cm.cloudSize[1],.5),this.detailSize=Ie(Cm.detailSize[0],Cm.detailSize[1],.5),this.smoothness=Ie(Cm.smoothness[0],Cm.smoothness[1],.5),this.cloudHeight=Ie(Cm.cloudHeight[0],Cm.cloudHeight[1],.5),this.raymarchingStepType=Cm.raymarchingStepType,this._cloudRadius=0,this._viewMatrix=zr(),this._cameraPositionLastFrame=Oe(),this.running=!1}_getTechnique(e){return this._techniques[e]||(this._techniqueConfiguration.steps=e,this._techniques[e]=new mm({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[e])}_getWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;let i=go((e+90)/180,(t+180)/360);const r=Math.floor(this._weatherTileCount*Math.abs(2*i[0]-1));i=go(Math.floor(2*this._weatherTileCount*i[0]),Math.floor(4*(this._weatherTileCount-r)*i[1]));let s=0,a=0;if(U(this.view.environment)&&"sun"===this.view.environment.lighting.type&&U(this.view.environment.lighting.date)){const e=new Date(this.view.environment.lighting.date);e.setUTCHours(this.view.environment.lighting.date.getUTCHours()+this.view.environment.lighting.displayUTCOffset),s=31*e.getUTCMonth()+e.getUTCDate(),a=e.getUTCFullYear()}return i[0]=(i[0]+s)%(2*this._weatherTileCount),i[1]=(i[1]+a%100)%(4*this._weatherTileCount),i}initialize(){this._vao=Ms(this.context.renderContext.rctx);const e=vr(this.view.spatialReference);this._cloudRadius=.5*e.radius,this.setDirty(),this._weatherTile=this._getWeatherTile(),this._frameTask=this.view.resourceController.scheduler.registerTask(So.CLOUDS_GENERATOR,this),this._handles.add(this._frameTask),this._handles.add(K((()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingStepType]),(()=>this.setDirty()),$))}destroy(){this._handles.destroy(),this._techniques.forEach((e=>q(e))),this._techniques=null,this._frameBufferCube=B(this._frameBufferCube),this._vao=B(this._vao),this._noiseTexture=k(this._noiseTexture)}_ensureNoiseTexture(){if(z(this._noiseTexture)){const e=this.context;this._noiseTexture=new vm({context:e}),this._noiseTexture.updateWeatherMap(this._weatherTile)}return this._noiseTexture.textureAtlas}ensureWeatherTile(){const e=this._getWeatherTile();U(this._noiseTexture)&&U(this.context)&&this._noiseTexture.updateWeatherMap(e),e[0]===this._weatherTile[0]&&e[1]===this._weatherTile[1]||(this._weatherTile=e,this.setDirty())}get frameBufferCube(){if(z(this._frameBufferCube)){const e={target:Tn.TEXTURE_CUBE_MAP,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:Rn.LINEAR,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new To(this.context.renderContext.rctx,{colorTarget:wn.CUBEMAP,width:this._cubeMapSize,height:this._cubeMapSize},e)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}isFading(e){return e.crossFade.enabled||e.fadeInOut.stage===da.FADE_OUT||e.fadeInOutHeight.stage!==pa.FINISHED}applyPreset(e,t){const i=e.median,r=e=>{const r=Ie(e[0],e[1],i);return t<.5?Ie(e[0],r,2*t):Ie(r,e[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingStepType=e.raymarchingStepType}setDirty(){this.running=!0}runTask(e){if(0===this.coverage||z(this._vao))return void(this.running=!1);const t=this._getTechnique(this.raymarchingStepType);if(!t.compiled)return;if(!Ve(this._cameraPositionLastFrame,this.context.renderContext.bindParameters.camera.eye)||this.isFading(this.context.renderContext.bindParameters.clouds))return void De(this._cameraPositionLastFrame,this.context.renderContext.bindParameters.camera.eye);this.ensureWeatherTile();const i=this._ensureNoiseTexture();if(z(i))return;const r=this.context.renderContext.rctx,s=r.bindTechnique(t),a=1+this.absorption,n=Ie(35,120,this.absorption);s.bindTexture("cloudShapeTexture",i),s.setUniform1f("cloudRadius",this._cloudRadius),s.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),s.setUniform1f("power",n),s.setUniform1f("sigmaE",a),s.setUniform1f("density",Ie(0,.3,this.density)),s.setUniform1f("cloudSize",Ie(0,.02,Math.max(.01,1-this.cloudSize))),s.setUniform1f("detailSize",Ie(0,.2,Math.max(.01,1-this.detailSize))),s.setUniform1f("smoothness",Ie(0,.5,1-this.smoothness)),s.setUniform1f("cloudHeight",Ie(0,1500,this.cloudHeight)),s.setUniform1f("coverage",this.coverage),r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const o=r.getViewport();r.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),r.bindFramebuffer(this.frameBufferCube);for(let e=0;e<5;e++){const t=xm[e],i=wm[e];Mr(this._viewMatrix,Tm,t,i),ho(this._drawParameters.viewMatrix,this._viewMatrix);const a=Tn.TEXTURE_CUBE_MAP_POSITIVE_X+e;this.frameBufferCube.setColorTextureTarget(a),s.bindDraw(this._drawParameters,this._bindParameters),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.gl.flush()}this.running=!1,r.setViewport(o.x,o.y,o.width,o.height),this.requestRender(),e.madeProgress()}};e([ve({constructOnly:!0})],bm.prototype,"context",void 0),e([ve({constructOnly:!0})],bm.prototype,"view",void 0),e([ve({constructOnly:!0})],bm.prototype,"requestRender",void 0),e([ve()],bm.prototype,"_frameTask",void 0),e([ve()],bm.prototype,"coverage",void 0),e([ve()],bm.prototype,"density",void 0),e([ve()],bm.prototype,"absorption",void 0),e([ve()],bm.prototype,"cloudSize",void 0),e([ve()],bm.prototype,"detailSize",void 0),e([ve()],bm.prototype,"smoothness",void 0),e([ve()],bm.prototype,"cloudHeight",void 0),e([ve()],bm.prototype,"raymarchingStepType",void 0),e([ve()],bm.prototype,"running",void 0),bm=e([xe("esri.views.3d.environment.CloudsGenerator")],bm);const xm=[fo(1,0,0),fo(-1,0,0),fo(0,1,0),fo(0,-1,0),fo(0,0,1)],wm=[fo(0,1,0),fo(0,1,0),fo(0,0,-1),fo(0,0,1),fo(0,1,0)],Tm=_o(),Cm=pm.sunny,Sm=zr(),Pm=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new ws;t.attributes.add(yn.POSITION,"vec2"),t.include(Gr,{textureCoordinateType:qr.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:r}=t;return i.uniforms.add([new Ts("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new Ts("inverseViewMatrix",((e,t)=>Ar(Sm,t.camera.viewMatrix)))]),i.code.add(an`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add(new Za("atmosphereC")),r.uniforms.add(new Qa("cameraPosition")),r.uniforms.add(new Ps("nearFar",((e,t)=>t.camera.nearFar))),r.uniforms.add(new Ya("depthTex")),r.uniforms.add(new Za("fogStrength")),r.uniforms.add(new Za("fogAmount")),r.uniforms.add(new Qa("fogColor")),t.include(ha),r.include(Ss),r.code.add(an`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(an`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),r.code.add(an`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${e.haze?an`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class Rm extends As{initializeProgram(e){const t=Rm.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return this.configuration.haze?Nn({blending:Fn(vn.ONE,vn.ZERO,vn.ONE_MINUS_SRC_COLOR,vn.ONE),colorWrite:Vn}):Nn({blending:Fn(vn.SRC_ALPHA,vn.ZERO,vn.ONE_MINUS_SRC_ALPHA,vn.ONE),colorWrite:Vn})}}Rm.shader=new Rs(Pm,(()=>Promise.resolve().then((()=>Pm))));class Am extends Qn{constructor(){super(...arguments),this.haze=!1}}e([Wn()],Am.prototype,"haze",void 0);let Om=class extends N{constructor(e){super(e),this._fogColor=yo(),this._fogColorAtNight=yo(),this._cameraDirection=yo(),this._foggyFadeStart=.95,this._foggyFadeEnd=1,this._hazeFadeStart=.7,this._hazeFadeEnd=1,this._strength=4e-6;const t=e.context.renderContext.rctx;this._vao=Ms(t,Es);const i=vr(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+1e5}destroy(){this._hazeFogTechnique=q(this._hazeFogTechnique),this._thickFogTechnique=q(this._thickFogTechnique),this._vao=B(this._vao)}get _shaderTechniqueRepository(){return this.context.shaderTechniqueRepository}set strength(e){this._strength=e}get strength(){return this._strength}get thickFogTechnique(){if(z(this._thickFogTechnique)){const e=new Am;e.haze=!1,this._thickFogTechnique=this._shaderTechniqueRepository.acquire(Rm,e)}return this._thickFogTechnique}get hazeFogTechnique(){if(z(this._hazeFogTechnique)){const e=new Am;e.haze=!0,this._hazeFogTechnique=this._shaderTechniqueRepository.acquire(Rm,e)}return this._hazeFogTechnique}when(){return Promise.resolve()}render(e,t,i){if(0===this.view.basemapTerrain.baseOpacity&&!t)return;if(this._update(e,t,i),this._fogAmount<=0)return;const r=t?this.thickFogTechnique:this.hazeFogTechnique;if(!r.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper,a=e.rctx.bindTechnique(r,Mm,e.bindParameters);s.renderDepthDetached((()=>{a.bindTexture("depthTex",s.depthTexture),this._renderFog(r.program,e)}))}_renderFog(e,t){if(z(this._vao))return!1;const i=t.rctx,r=t.bindParameters.camera;return e.setUniform3fv("cameraPosition",r.eye),e.setUniform1f("atmosphereC",this._atmosphereC),e.setUniform1f("fogStrength",this._strength),e.setUniform1f("fogAmount",this._fogAmount),e.setUniform3fv("fogColor",this._fogColor),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(xn.TRIANGLE_STRIP,0,4),!0}_update(e,t,i){const r=e.bindParameters.camera,s=t?.1:0;i?Me(this._fogColor,.5,.5,.5):t?Me(this._fogColor,1.5,1.5,1.5):Me(this._fogColor,.24,.44,.8),Ue(this._fogColorAtNight,this._fogColor,s),Fe(this._cameraDirection,r.eye);const a=Math.max(0,je(this._cameraDirection,e.bindParameters.lighting.lightingMainDirection));ke(this._fogColor,this._fogColorAtNight,this._fogColor,a);const n=Ee(r.eye),o=n*n;this._atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=t?1-Le(this._foggyFadeStart*lo,this._foggyFadeEnd*lo,Math.abs(n-this._planetRadius)):1-Le(this._hazeFadeStart*lo,this._hazeFadeEnd*lo,Math.abs(n-this._planetRadius))}static isSupported(e){return e.capabilities.depthTexture}};e([ve({constructOnly:!0})],Om.prototype,"context",void 0),e([ve({constructOnly:!0})],Om.prototype,"view",void 0),Om=e([xe("esri.views.3d.environment.Fog")],Om);const Mm=new on;var Em;!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(Em||(Em={}));class Dm extends Qn{constructor(){super(...arguments),this.geometry=Em.Cone}}e([Wn({count:Em.COUNT})],Dm.prototype,"geometry",void 0);class Im extends on{}const Lm=Object.freeze(Object.defineProperty({__proto__:null,SimpleAtmospherePassParameters:Im,build:function(e){const t=new ws,{vertex:i,fragment:r}=t;if(e.geometry===Em.Underground)t.attributes.add(yn.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add([new Cs("lightingMainDirection",((e,t)=>t.lighting.lightingMainDirection)),new Qa("cameraPosition"),new Za("undergroundFadeAlpha")]),i.code.add(an`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.code.add(an`void main() {
gl_FragColor = color;
}`);else{t.include(Ls),t.attributes.add(yn.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=e.geometry===Em.Cylinder;i.uniforms.add([new Ts("proj",((e,t)=>t.camera.projectionMatrix)),new Xr("view"),new Cs("lightingMainDirection",((e,t)=>t.lighting.lightingMainDirection))]),s||(t.varyings.add("innerFactor","float"),i.uniforms.add(new Qa("silCircleCenter")),i.uniforms.add(new Qa("silCircleV1")),i.uniforms.add(new Qa("silCircleV2")),i.uniforms.add(new la("texV")),i.uniforms.add(new Za("innerScale")));const a=6.2831853,n=1/128;i.code.add(an`
		void main(void) {
      ${s?an`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:an`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${an.float(a*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${an.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.uniforms.add(new Ns("tex",(e=>e.texture))),s||r.uniforms.add(new Za("altitudeFade")),r.code.add(an`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${s?an`gl_FragColor = atmosphereColor;`:an`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}},Symbol.toStringTag,{value:"Module"}));class Nm extends As{initializeProgram(e){const t=Nm.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return this.configuration.geometry===Em.Cylinder?Nn({blending:Fn(vn.SRC_ALPHA,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),culling:zn,depthTest:{func:bn.LEQUAL},colorWrite:Vn}):Nn({blending:Fn(vn.SRC_ALPHA,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),depthTest:{func:bn.LEQUAL},colorWrite:Vn})}}Nm.shader=new Rs(Lm,(()=>Promise.resolve().then((()=>Lm))));const Fm="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=",Vm=V.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class Um{constructor(){this.type="panoramic",this._techniqueConfig=new Dm,this._passParameters=new Im,this._readyResolver=l(),this._readyController=new AbortController}destroy(){this._readyResolver.reject(),this._passParameters.texture=B(this._passParameters.texture),this._vao=B(this._vao),this._readyController=G(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(e){this._techniqueConfig.geometry=Em.Cylinder,this._technique=e.shaderTechniqueRepository.acquire(Nm,this._techniqueConfig);const t=e.renderContext.rctx;this._vao=this._createVertexArrayObject(t),this._vaoCount=Lo(this._vao,"geometry"),Mo(Fm,{signal:this._readyController.signal}).then((i=>{this._passParameters.texture=new jo(t,{pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:Rn.LINEAR,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{u(e)||Vm.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject()}))}get canRender(){return null!=this._passParameters.texture}render(e){const t=e.rctx,i=t.bindTechnique(this._technique,this._passParameters,e.bindParameters);var r,s;r=zm,s=e.bindParameters.camera.viewMatrix,Er(r,s),r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.setUniformMatrix4fv("view",zm),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(xn.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const t=Io.createPolySphereGeometry(1,2,!1),i=t.indices.get(yn.POSITION);for(let e=0;e<i.length;e+=3){const t=i[e];i[e]=i[e+2],i[e+2]=t}const r=t.vertexAttributes.get(yn.POSITION).data,s=jm.createBuffer(i.length),a=s.position;for(let e=0;e<i.length;++e){const t=3*i[e];a.set(e,0,r[t]),a.set(e,1,r[t+1]),a.set(e,2,r[t+2])}return new No(e,nn,{geometry:Eo(jm)},{geometry:Fo.createVertex(e,An.STATIC_DRAW,s.buffer)})}}const zm=zr(),jm=Do().vec3f(yn.POSITION);var km;!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(km||(km={}));class Gm extends Qn{constructor(){super(...arguments),this.type=km.Rain}}e([Wn({count:km.COUNT})],Gm.prototype,"type",void 0);const qm=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new ws;return t.attributes.add(yn.POSITION,"vec3"),t.attributes.add(yn.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new Qa("cameraPosition")),t.vertex.uniforms.add(new Qa("offset")),t.vertex.uniforms.add(new Za("width")),t.vertex.uniforms.add(new Ts("proj",((e,t)=>t.camera.projectionMatrix))),t.vertex.uniforms.add(new Xr("view")),t.vertex.uniforms.add(new Za("time")),t.varyings.add("vUv","vec2"),t.vertex.code.add(an`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===km.Rain?an`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:an`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),t.fragment.uniforms.add(new Za("opacity")),t.fragment.uniforms.add(new Qa("particleColor")),t.fragment.code.add(an`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${e.type===km.Rain?an`d = 0.35 * smoothstep(0.5, 0.0, d);`:an`d = smoothstep(0.5, 0.1, d);`}
      gl_FragColor = opacity * vec4(particleColor * d, d);
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class Bm extends on{constructor(){super(...arguments),this.time=0,this.radius=1}}class Hm extends As{initializeProgram(e){const t=Hm.shader.get().build(this.configuration);return new Os(e.rctx,t,Hm.attributeLocation)}initializePipeline(){return Nn({blending:Fn(vn.ONE,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),depthTest:{func:bn.LEQUAL},colorWrite:Vn})}}Hm.shader=new Rs(qm,(()=>Promise.resolve().then((()=>qm)))),Hm.attributeLocation=new Map([[yn.POSITION,0],[yn.INSTANCEFEATUREATTRIBUTE,1]]);let Wm=class extends N{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._opacity=1,this._width=500,this._offset=Oe(),this._tile=Oe(),this._particleColor=yo(),this._particleColorAtNight=yo(),this._nightMultiplier=.7,this._cameraDirection=yo(),this._renderParameters=new Bm,this._animation=new ga,this._updatingTracking=new Wi,this._renderParameters.time=0,this._renderParameters.radius=vr(e.view.spatialReference).radius,this._shaderTechniqueRepository=e.context.shaderTechniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechnique=q(this._snowTechnique),this._rainTechnique=q(this._rainTechnique),this._vao=B(this._vao),this._instanceIdBuffer=B(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get rainTechnique(){if(z(this._rainTechnique)){const e=new Gm;e.type=km.Rain,this._rainTechnique=this._shaderTechniqueRepository.acquire(Hm,e)}return this._rainTechnique}get snowTechnique(){if(z(this._snowTechnique)){const e=new Gm;e.type=km.Snow,this._snowTechnique=this._shaderTechniqueRepository.acquire(Hm,e)}return this._snowTechnique}update(e){return this._animation.advance(e)}render(e,t,i){const r="rainy"===i,s=r?this.rainTechnique:this.snowTechnique;if(!s.compiled)return void this.context.requestRender();const a=e.rctx;if(this._ensureResources(a),z(s)||z(this._vao)||z(this._instanceIdBuffer))return;if(U(e.bindParameters.clouds.data)&&(this._opacity=1-e.bindParameters.clouds.fadeInOutHeight.factor),this._opacity<=0)return;t=t<.5?Ie(0,.35,2*t):Ie(.35,1,2*(t-.5));const n=a.bindTechnique(s);this._renderParameters.camera=e.bindParameters.camera,this._renderParameters.time=(r?this._rainSpeed:this._snowSpeed)*se(this._animation.time),this._renderParameters.time=this._renderParameters.time%1e5,this._update(n,i,e),a.bindVAO(this._vao);const o=Hm.attributeLocation;n.assertCompatibleVertexAttributeLocations(this._vao),Vo(a,o,this._instanceIdBuffer,Zm,0),a.capabilities.instancing.drawArraysInstanced(xn.TRIANGLES,0,3,this._numParticles*t),Uo(a,o,this._instanceIdBuffer,Zm)}_update(e,t,i){const r=i.bindParameters.camera,s=r.eye;this._tile[0]=Math.floor((s[0]+.5*this._width)/this._width),this._tile[1]=Math.floor((s[1]+.5*this._width)/this._width),this._tile[2]=Math.floor((s[2]+.5*this._width)/this._width),this._offset[0]=s[0]-this._tile[0]*this._width,this._offset[1]=s[1]-this._tile[1]*this._width,this._offset[2]=s[2]-this._tile[2]*this._width,e.setUniform1f("width",this._width),e.setUniform3fv("offset",this._offset),e.setUniformMatrix4fv("view",r.viewMatrix),e.setUniform3fv("cameraPosition",s),e.bindPass(null,i.bindParameters),e.setUniform1f("time",this._renderParameters.time),"rainy"===t?Me(this._particleColor,.85,.85,.85):Me(this._particleColor,1,1,1),Ue(this._particleColorAtNight,this._particleColor,this._nightMultiplier),Fe(this._cameraDirection,s);const a=Math.max(0,je(this._cameraDirection,i.bindParameters.lighting.lightingMainDirection));ke(this._particleColor,this._particleColorAtNight,this._particleColor,a),e.setUniform3fv("particleColor",this._particleColor),e.setUniform1f("opacity",this._opacity)}_ensureResources(e){z(this._vao)&&(this._vao=this._createVertexArrayObject(e)),z(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let e=0;e<this._numParticles;e++)t.push(e);return Fo.createVertex(e,An.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new No(e,Hm.attributeLocation,{geometry:Eo(Qm)},{geometry:Fo.createVertex(e,An.STATIC_DRAW,t)})}};e([ve({constructOnly:!0})],Wm.prototype,"context",void 0),e([ve({constructOnly:!0})],Wm.prototype,"view",void 0),e([ve({readOnly:!0})],Wm.prototype,"updating",null),e([ve()],Wm.prototype,"_updatingTracking",void 0),Wm=e([xe("esri.views.3d.environment.Precipitation")],Wm);const Qm=Do().vec3f(yn.POSITION),Zm=Eo(Do().f32(yn.INSTANCEFEATUREATTRIBUTE),1),Xm=V.getLogger("esri.views.3d.environment.SimpleAtmosphere"),Ym=Yi([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class Km{constructor(e){this.view=e,this.type="simple",this._renderData={texV:Sr(),silCircleCenter:Oe(),silCircleV1:Oe(),silCircleV2:Oe(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._passParameters=new Im,this._fadeVaoCount=0,this._readyResolver=l(),this._readyController=new AbortController,this.texV1=1,this.canRender=!0,this.isOnMars=gr(e.spatialReference);const t=vr(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+-1e4)/this.planetRadius,this.middleRimFactor=(this.planetRadius+0)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=0/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}destroy(){this._readyResolver.reject(),this._cameraChangeHandle=j(this._cameraChangeHandle),this._passParameters.texture=B(this._passParameters.texture),this._fadeVao=B(this._fadeVao),this._vao=B(this._vao),this._readyController=G(this._readyController)}when(){return this._readyResolver.promise}async initializeRenderContext(e){this._shaderTechniqueRepository=e.shaderTechniqueRepository;const t=e.renderContext.rctx;this._cameraChangeHandle=K((()=>this.view.state?.camera),(()=>e.requestRender()),J),this._vao=this._createRibbon(t),this._vaoCount=Lo(this._vao,"geometry"),this._fadeVao=Ms(t),this._fadeVaoCount=Lo(this._fadeVao,"geometry");const i=this.isOnMars?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==":Fm,r=this._readyController.signal;try{const s=await Mo(i,{signal:r});p(r),this._passParameters.texture=new jo(t,{pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:Rn.LINEAR,flipped:!0},s),e.requestRender(),this._readyController=null,this._readyResolver.resolve()}catch(e){u(e)||Xm.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject(e)}}get coneTechnique(){if(z(this._coneTechnique)){const e=new Dm;e.geometry=Em.Cone,this._coneTechnique=this._shaderTechniqueRepository.acquire(Nm,e)}return this._coneTechnique}get undergroundTechnique(){if(z(this._undergroundTechnique)){const e=new Dm;e.geometry=Em.Underground,this._undergroundTechnique=this._shaderTechniqueRepository.acquire(Nm,e)}return this._undergroundTechnique}render(e){const t=e.bindParameters.camera;this._update(t);const i=e.rctx;if(this._renderData.undergroundFadeAlpha<1){const r=i.bindTechnique(this.coneTechnique,this._passParameters,e.bindParameters);r.setUniformMatrix4fv("proj",t.projectionMatrix),r.setUniformMatrix4fv("view",t.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),i.bindVAO(this._vao),i.drawArrays(xn.TRIANGLES,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const r=i.bindTechnique(this.undergroundTechnique,this._passParameters,e.bindParameters);r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),r.setUniform3fv("cameraPosition",t.eye),i.bindVAO(this._fadeVao),i.drawArrays(xn.TRIANGLE_STRIP,0,this._fadeVaoCount)}}renderHaze(){return!1}_update(e){const t=Oe(),i=this.planetRadius,r=Ee(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._renderData.undergroundFadeAlpha=e}else this._renderData.undergroundFadeAlpha=0;const a=Math.max(50,s),n=i+-1e4;var o,l,h;this._renderData.innerScale=(l=i,h=n,(o=i+a)*o/(Math.sqrt(o*o-l*l)*Math.sqrt(o*o-h*h)+l*h)-1),this._renderData.altitudeFade=Op(s),Ue(t,e.eye,(i+50)/r),$m(t,e.center,e.up,i,this._renderData);const c=this._computeScreenRimWidth(e,t,e.up,this._renderData),d=1-511/512,u=Ym(s);let p=this.texV0+d*this.texVScale,m=this.texV0+c*u*this.texVScale;if(s>50){$m(e.eye,e.center,e.up,i,this._renderData);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),r=Se((t-1.5)/(c-1.5),0,1);p=this.texV0+r*d*this.texVScale,m=this.texV0+Ie(this.texV1,c*u,r)*this.texVScale}xr(this._renderData.texV,p,m)}_createRibbon(e){const t=new Float32Array(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const r=9*e+3;t[r+0]=e,t[r+1]=this.innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this.middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this.outerRimFactor,t[r+8]=1;const s=3*e+1,a=127===e?1:s+3,n=15*e;i[n+0]=s,i[n+1]=s+1,i[n+2]=a+1,i[n+3]=a+1,i[n+4]=a,i[n+5]=s,i[n+6]=s+1,i[n+7]=s+2,i[n+8]=a+2,i[n+9]=a+2,i[n+10]=a+1,i[n+11]=s+1,i[n+12]=s,i[n+13]=a,i[n+14]=0}const r=ig.createBuffer(i.length),s=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];s.set(e,0,t[r]),s.set(e,1,t[r+1]),s.set(e,2,t[r+2])}return new No(e,nn,{geometry:Eo(ig)},{geometry:Fo.createVertex(e,An.STATIC_DRAW,r.buffer)})}_computeScreenRimWidth(e,t,i,r){return Ge(eg,r.silCircleCenter,r.silCircleV2),Ue(tg,eg,this.outerRimFactor),Dr(Jm,t,eg,i),ko(eg,Jm,e.projectionMatrix,e.viewport),ko(tg,Jm,e.projectionMatrix,e.viewport),qe(eg,tg)/e.height}}function $m(e,t,i,r,s){const a=Ee(e),n=r*Math.sqrt(a*a-r*r)/a,o=Math.sqrt(r*r-n*n),l=s.silCircleV1,h=s.silCircleV2;return Ue(s.silCircleCenter,e,o/a),Ne(l,e,t),Be(l)<1&&Ne(l,e,i),Ue(l,l,n/Ee(l)),Ne(h,l,e),Ue(h,h,n/Ee(h)),n}const Jm=zr(),eg=Oe(),tg=Oe(),ig=Do().vec3f(yn.POSITION),rg=zr(),sg=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new ws;return e.attributes.add(yn.POSITION,"vec3"),e.attributes.add(yn.COLOR,"vec4"),e.attributes.add(yn.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add([new Ts("transform",((e,t)=>function(e,t){const i=24e-8;return Er(rg,t.camera.projectionMatrix),rg[10]=i-1,rg[11]=-1,rg[14]=(i-2)*t.camera.near,Ir(rg,rg,t.camera.viewMatrix),Ir(rg,rg,e.modelMatrix)}(e,t))),new Fs("viewport",((e,t)=>t.camera.fullViewport)),new Vs("pixelRatio",((e,t)=>t.camera.pixelRatio))]),e.include(Ho),e.vertex.code.add(an`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(an`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),e}},Symbol.toStringTag,{value:"Module"}));class ag extends on{constructor(){super(...arguments),this.modelMatrix=zr()}}class ng extends As{constructor(e){super(e,null,(()=>this.destroy()))}initializeProgram(e){const t=ng.shader.get().build();return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Fn(vn.SRC_ALPHA,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),depthTest:{func:bn.LEQUAL},colorWrite:Vn})}}ng.shader=new Rs(sg,(()=>Promise.resolve().then((()=>sg))));const og=V.getLogger("esri.views.3d.environment.Stars");let lg=class extends N{constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter=new ag,this._updatingTracking=new Wi}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return U(this._loadDataTask)&&!this._loadDataTask.finished}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=G(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=q(this._technique),this._vao=B(this._vao)}render(e){const{rctx:t}=e;if(this._ensureResources(t),z(this._technique)||z(this._vao))return;if(!this._technique.compiled)return void this.requestRender();const i=t.bindTechnique(this._technique,this._renderParameter,e.bindParameters);t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(xn.POINTS,0,this._numPoints)}_ensureResources(e){if(U(this._technique)||z(mg))return;this._technique=new ng({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=mg.byteLength/ug;const t=new Float32Array(mg,0,2*this._numPoints),i=new Uint8Array(mg,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add((()=>"sun"===this.view.environment.lighting.type?this.view.environment.lighting.date:null),(e=>this._update(e)),$)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=Er(this._renderParameter.modelMatrix,dg);Lr(r,r,-i*Math.PI),Ir(r,cg,r),Lr(r,r,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=pg.createBuffer(r),a=s.position,n=s.color,o=s.size;for(let e=0;e<r;e++){const r=t[2*e+0],s=t[2*e+1];a.set(e,0,-Math.cos(r)*Math.sin(s)),a.set(e,1,-Math.sin(r)*Math.sin(s)),a.set(e,2,-Math.cos(s));const l=this._unpackUint8Attributes(i[e]),h=this._hexToRGB(hg[l[1]]);n.set(e,0,255*h[0]),n.set(e,1,255*h[1]),n.set(e,2,255*h[2]),n.set(e,3,255),o.set(e,l[0])}return new No(e,nn,{geometry:Eo(pg)},{geometry:Fo.createVertex(e,An.STATIC_DRAW,s.buffer)})}_createLoadDataTask(){if(U(mg))return null;const e=c((async e=>{const{data:t}=await qo("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),mg=t}));return e.promise.catch((e=>{u(e)||og.error(e)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new o("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/ug;if(t%1!=0||t>5e4||t<5e3)throw new o("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e([ve({constructOnly:!0})],lg.prototype,"view",void 0),e([ve({constructOnly:!0})],lg.prototype,"requestRender",void 0),e([ve({readOnly:!0})],lg.prototype,"updating",null),e([ve()],lg.prototype,"_loadDataTask",void 0),e([ve()],lg.prototype,"_updatingTracking",void 0),lg=e([xe("esri.views.3d.environment.Stars")],lg);const hg=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],cg=jr(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),dg=jr(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),ug=9,pg=Do().vec3f(yn.POSITION).vec4u8(yn.COLOR).f32(yn.SIZE);let mg=null;var gg;const fg=[Zo.POSTPROCESSING_ENVIRONMENT_OPAQUE,Zo.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let _g,yg=gg=class extends N{constructor(e){super(e),this._handles=new lr,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null}initialize(){this.view._stage.addRenderPlugin(fg,this)}destroy(){this._pendingAtmosphere=k(this._pendingAtmosphere),null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this),this._handles=k(this._handles),this._set("view",null)}get atmosphereType(){return U(this._pendingAtmosphere)?this._pendingAtmosphere.type:U(this._atmosphere)?this._atmosphere.type:"none"}get canRender(){return!!this.view.basemapTerrain?.renderer.canRender||"global"!==this.view.viewingMode}get needsLinearDepth(){return"realistic"===this._selectAtmosphereType()}updateAnimation(e){return!!U(this._precipitation)&&this._precipitation.update(e)}get updating(){return U(this._pendingAtmosphere)||U(this._stars)&&this._stars.updating||U(this._clouds)&&this._clouds.running}get weatherVisible(){return Ee(this.view.state.camera.eye)-vr(this.view.spatialReference).radius<=lo}get _stars(){const e=this.view,t=e.environment?.starsEnabled??!1,i=this._get("_stars");return!t||z(this._context)?(k(i),null):U(i)?i:new lg({view:e,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||z(this._context))return k(e),null;const t=this.view,i=this._context;return U(e)&&e.context===i?e:(k(e),new Wm({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||z(this._context))return k(e),null;if(U(e))return e;const t=this.view,i=this._context;return k(e),new bm({context:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||z(this._context))return k(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,r=vr(this.view.spatialReference).radius;return U(e)&&e.viewingMode===t&&e.planetRadius===r?e:(k(e),new Wp({rctx:i,viewingMode:t,planetRadius:r,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||z(this._context))return k(e),null;if(U(e))return e;const t=this.view,i=this._context;return k(e),new Om({context:i,view:t})}get weatherEnabled(){return!!this.view?.environmentManager?.weatherEnabled}get _precipitationEnabled(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}initializeRenderContext(e=null){this._context=e,this._handles.add([ee((()=>this.view?.basemapTerrain),(()=>this._updateBasemapTerrain()),J),K((()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality})),(()=>this._updateAtmosphere()),J),K((()=>this._stars),(()=>this._setNeedsRender())),K((()=>this._clouds),(()=>this._updateWeather(this._weatherUpdateParameters)),$),K((()=>this._precipitation),(()=>this._setNeedsRender())),K((()=>this._fog),(()=>this._updateFog(this._weatherUpdateParameters)),$),K((()=>this._weatherUpdateParameters),(e=>{this._updateWeather(e),this._updateFog(e)}),J)])}uninitializeRenderContext(){this._context=null,this._atmosphere=k(this._atmosphere),this._set("_stars",k(this._stars)),this._set("_precipitation",k(this._precipitation)),this._set("_clouds",k(this._clouds)),this._set("_cloudsComposition",k(this._cloudsComposition)),this._set("_fog",k(this._fog))}prepareRender(e){var t;e.bindParameters.clouds.data=(t=this._clouds,U(t)&&U(t.cubeMap)&&t.coverage>0?this._clouds:null)}render(e){if(e.pass===Xo.MATERIAL)switch(e.bindParameters.slot){case Zo.POSTPROCESSING_ENVIRONMENT_OPAQUE:U(this._stars)&&this._stars.render(e),U(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(e),U(this._cloudsComposition)&&U(e.bindParameters.clouds.data)&&(this.weatherVisible&&U(this._clouds)&&this._clouds.ensureWeatherTile(),this._cloudsComposition.render(e,U(this.view.animation))));break;case Zo.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(U(this._atmosphere)&&this._atmosphere.canRender){const t=this.weatherEnabled?this.view.environment.weather.type:"disabled";if(this._atmosphere.renderHaze(e,"rainy"===t),U(this._fog)){const i="foggy"===t||"rainy"===t||"snowy"===t;(i||"realistic"!==this._selectAtmosphereType())&&this._fog.render(e,i,"rainy"===t)}if(U(this._precipitation)){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return z(e)?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}_updateWeather(e){z(e)||z(this._clouds)||(this._clouds.applyPreset(pm[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){U(this._context)&&this._context.requestRender()}_updateFog(e){if(!z(this._fog)&&!z(e))switch(e.type){case"foggy":this._fog.strength=Ie(3e-5,.005,e.weatherAdjustment**3),this._setNeedsRender();break;case"rainy":case"snowy":this._fog.strength=Ie(4e-6,2e-4,e.effect**3),this._setNeedsRender();break;default:this._fog.strength=4e-6,this._setNeedsRender()}}_updateAtmosphere(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;U(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return U(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);U(this._context)&&i.initializeRenderContext(this._context),z(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then((()=>{U(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)}))}_getAtmosphereClass(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return Fp;case"panoramic":return Um;case"simple":return Km;default:return}}_selectAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||null==t||fr(this.view.spatialReference)?"none":"local"===i?"panoramic":"high"===t&&U(this._context)&&Fp.isSupported(this._context)&&_r(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=U(this._atmosphere)&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType(),stubGetAtmosphereClass:e=>{_g=gg.prototype._getAtmosphereClass,gg.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{gg.prototype._getAtmosphereClass=_g}}}};e([ve({constructOnly:!0})],yg.prototype,"view",void 0),e([ve({type:Boolean,readOnly:!0})],yg.prototype,"updating",null),e([ve({readOnly:!0})],yg.prototype,"weatherVisible",null),e([ve()],yg.prototype,"_context",void 0),e([ve()],yg.prototype,"_pendingAtmosphere",void 0),e([ve({readOnly:!0})],yg.prototype,"_stars",null),e([ve({readOnly:!0})],yg.prototype,"_precipitation",null),e([ve({readOnly:!0})],yg.prototype,"_clouds",null),e([ve({readOnly:!0})],yg.prototype,"_cloudsComposition",null),e([ve({readOnly:!0})],yg.prototype,"_fog",null),e([ve({readOnly:!0})],yg.prototype,"weatherEnabled",null),e([ve({readOnly:!0})],yg.prototype,"_precipitationEnabled",null),e([ve({readOnly:!0})],yg.prototype,"_weatherUpdateParameters",null),yg=gg=e([xe("esri.views.3d.environment.EnvironmentRenderer")],yg);let vg=class extends or.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new lr,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new Yr,this._ambientLight=new Kr,this._moonLight=new $r,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){return this._renderer?.view}get updating(){return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!this._renderer?.updating)}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===Gi.Global&&_r(this._view.spatialReference)}get weatherVisible(){return this.weatherEnabled&&this._renderer?.weatherVisible}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new yg({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler(),r=()=>this._updateLighting();this._viewHandles.add([K((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),te),K((()=>"sun"===e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),te),K((()=>e.stationary),(()=>this._interactingStationaryHandler())),K((()=>e.environment.lighting.directShadowsEnabled),t,te),K((()=>e.environment.lighting.ambientOcclusionEnabled),t,te),K((()=>e.environment.lighting.waterReflectionEnabled),t,te),K((()=>e.environment.background?.color),t,te),K((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),te),K((()=>e.environment.weather.type),r,te),K((()=>this.weatherEnabled),r,te),K((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),J),K((()=>"sun"===e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),J),K((()=>e.state.camera),i,J),K((()=>this.disableQueries),i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=k(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("sun"===e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("sun"===e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"sun"===e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!St(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),U(this._referencePosWGS84Comparable)){const e=Yo(this._referencePosWGS84Comparable,Tg);U(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"sun"===this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){const i=_r(this._view.spatialReference);if(i&&!St(this._view.spatialReference))return!1;const r=e.position;return z(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=Oe()),i?Pt(r,this._referencePosWGS84Comparable):Me(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e){const t=this._view,i=e||("sun"===t.environment.lighting.type?t.environment.lighting.date:null),r=this._referencePosWGS84Comparable,s=U(r)?bg:xg;if(U(r)){const e=this.weatherVisible?t.environment.weather.type:"disabled";Ko(i,r,t.state.viewingMode,e,t.state.camera,t.environment.lighting.type,s)}const a=this._mainLight,n=s.direct;Ue(a.intensity,n.color,n.intensity*Math.PI),De(a.direction,n.directionToLightSource),a.specularStrength=s.specularStrength,a.environmentStrength=s.environmentStrength;const o=this._ambientLight;Ue(o.intensity,s.ambient.color,s.ambient.intensity);const l=this._moonLight;ke(l.intensity,Cg,Sg,s.globalFactor);const h=(1-.5*s.globalFactor)*(1-.4*s.noonFactor*(1-s.globalFactor));Ue(l.intensity,l.intensity,h),De(l.direction,n.directionToLightSource),t._stage.renderView.updateLightSources([a,o,l],1-s.noonFactor,s.globalFactor),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||z(e))return!1;const i=wg;i.setTime((t||this._view.environment.lighting.date).getTime());const r=Yo(e,Tg);if(z(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const a=i.getUTCHours()-(r.hours-s.hours),n=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(a),i.setUTCMinutes(n),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=W(this._referencePosWGS84Comparable,!0,(e=>Jo(e[2],this._view.state.viewingMode))),i=this._view.environment.background,r=i instanceof il?{type:"color",color:dr(nr.toUnitRGBA(i.color))}:{type:"color",color:cr(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,background:r,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=m(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=m(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};e([ve({type:Boolean,readOnly:!0})],vg.prototype,"updating",null),e([ve()],vg.prototype,"disableQueries",void 0),e([ve()],vg.prototype,"_disableWeather",void 0),e([ve()],vg.prototype,"weatherEnabled",null),e([ve()],vg.prototype,"weatherVisible",null),e([ve()],vg.prototype,"referencePositionWGS84Comparable",null),e([ve()],vg.prototype,"_renderer",void 0),e([ve()],vg.prototype,"_referencePosWGS84Comparable",void 0),vg=e([xe("esri.views.3d.environment.SceneViewEnvironmentManager")],vg);const bg=new $o,xg=new $o,wg=new Date,Tg={hours:0,minutes:0,seconds:0},Cg=Ae(.22,.22,.33),Sg=Ae(.22,.22,.22);function Pg(e,t){return 0!=(e&t)}function Rg(e,t,i,r,s,a){0!==e&&(i?(a.min=Math.min(a.min,t),a.max=Math.max(a.max,t)):null!=r?(a.min-=Math.max(0,(t-a.min)*(1-r)),a.max+=Math.max(0,(t-a.max)*(1-r))):s&&(a.min-=Math.max(0,t-a.min-s),a.max+=Math.max(0,t-a.max-s)))}var Ag,Og,Mg;!function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(Ag||(Ag={})),function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(Og||(Og={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(Mg||(Mg={}));const Eg={selection:Og.NONE,interactionType:Ag.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Mg.TUMBLE};function Dg(e,t,i,r){return t=t||e.viewForward,De(r,t),Ue(r,r,Math.sign(je(t,i))),r}function Ig(e,t,i=Eg){if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i||t.interactionType===Ag.TUMBLE&&Pg(t.selection,Og.TILT))}(e,i))return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,Lg);!function(e,t,i){const r=t.interactionType;if(r===Ag.NONE)return;const{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=t,l=r===Ag.TUMBLE||r===Ag.ZOOM,h=Ig(e,n),c=0===h?0:e.renderCoordsHelper.getAltitude(n.eye);i.min=s,i.max=a,Rg(h,c,l,o,.05*c,i)}(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),a=Se(s,r.min,r.max)-s;return Math.abs(a)<=1e-6?0:a}const Lg={min:0,max:0},Ng=Oe(),Fg=Oe(),Vg=Oe(),Ug=Oe();function zg(e,t,i=Eg){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;kg.min=0,kg.max=r,function(e,t,i){const r=t.interactionType;if(r===Ag.NONE)return;const{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=t,l=r===Ag.ZOOM||r===Ag.PAN,h=zg(e,n),c=0===h?0:jg(e,n);i.min=s,i.max=a,Rg(h,c,l,o,.05*c,i)}(e,i,kg);const s=jg(e,t),a=kg.max-s;return a>=-1e-6?0:a}function jg(e,t){const i=e.pointsOfInterest.surfaceOrigin;return qe(t.eye,i.renderLocation)}const kg={min:0,max:0},Gg=Oe(),qg=Oe(),Bg=Oe(),Hg=Oe(),Wg=Oe();function Qg(e,t,i=Zg.EYE){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=Tl(e,t.eye),a=e.renderCoordsHelper.getAltitude(t.eye),n=s+r.collision.elevationMargin;if(a>=n)return!1;const o=Ee(t.eye);if(ze(Xg,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Yg,n,t.eye),i===Zg.EYE_AND_CENTER)t.center=Ge(Xg,t.eye,Xg);else if(i===Zg.EYE_AND_CENTER_SCALE){const e=(o-a+n)/o;t.center=Ue(Xg,t.center,e)}return!0}var Zg;!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(Zg||(Zg={}));const Xg=Oe(),Yg=Oe();function Kg(e,t,i){e.worldUpAtPosition(t,$g),ze(Jg,i,t);const r=Ee(Jg);return 0===r?0:We(je(Jg,$g)/r)}const $g=Oe(),Jg=Oe();function ef(e,t,i=Eg,r=Eg,s){if(!e.state.constraints.tilt)return 0;const a=t.distance,n=e.state.constraints.tilt(a,cf);return function(e,t,i){if(t.interactionType===Ag.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=t,{min:a,max:n}=i,o=ef(e,r,Eg,t),l=0===o?0:Kg(e.renderCoordsHelper,r.center,r.eye);i.min=a,i.max=n,t.interactionType===Ag.TUMBLE?(Pg(t.selection,Og.ALTITUDE)&&af(e,r,i),Rg(o,l,!0,s,hf,i)):Rg(o,l,!1,s,hf,i)}(e,i,n),r.interactionType===Ag.TUMBLE&&Pg(r.selection,Og.ALTITUDE)&&af(e,r.interactionStartCamera,n),i.tiltMode===Mg.LOOK_AROUND||r.tiltMode===Mg.LOOK_AROUND?function(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,r){const s=tf(e,t,df),a=Se(s.tiltAtCenter,i.min,i.max);if(!rf(s.tiltAtCenter-a))return 0;let n,o;return s.centerIsOnSurface?(n=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,a=t.clampTilt(i,r);const n=sf(e,a);if(t.clampTilt(n,r)===a)return a;let o=0;for(;o<10&&rf(a-s);){const i=(s+a)/2,r=sf(e,i);rf(t.clampTilt(r,i)-i)?s=i:a=i,o++}return a}(s),o=function(e,t){const i=Ze(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=Ze(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}(s,n)):(n=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&n<Math.PI/2&&(r.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(s,n)),r&&(r.eyeCenterDistance=sf(s,n)),o}(e,t,i,r);case"local":return function(e,t,i,r){const s=Kg(e.renderCoordsHelper,t.center,t.eye),a=Se(s,i.min,i.max),n=s-a;if(!rf(n))return 0;if(r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=e.renderCoordsHelper.getAltitude(t.eye)-i,n=Math.cos(a);Math.abs(n)>1e-4?r.eyeCenterDistance=s/n:r.eyeCenterDistance=t.distance}return n}(e,t,i,r);default:return void Gl(e.viewingMode)}}(e,t,n,s):function(e,t,i){const r=Kg(e.renderCoordsHelper,t.center,t.eye),s=r-Se(r,i.min,i.max);return rf(s)?s:0}(e,t,n)}function tf(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+vr(e.spatialReference).radius,a=e.renderCoordsHelper.intersectManifold(t.ray,r,lf);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,U(a)?(i.eyeCenterDistance=qe(t.eye,a),i.tiltAtCenter=Kg(e.renderCoordsHelper,a,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=Kg(e.renderCoordsHelper,t.center,t.eye):(Kn($n(Jn,s),t.ray,lf),i.eyeCenterDistance=qe(t.eye,lf),i.tiltAtCenter=We(-je(t.viewForward,Fe(lf,lf)))),i.radius=s,i.eyeRadius=Ee(t.eye),i.constraints=e.state.constraints,i}function rf(e){return Math.abs(e)>1e-9}function sf(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-Se(t,0,Math.PI),r=Ze(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,a=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&a>1){const t=Math.PI-r,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return a*e.eyeRadius}function af(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const s=Be(t.center),a=Math.sqrt(s),n=t.distance,o=vr(e.spatialReference).radius,l=r.altitude.min+o,h=r.altitude.max+o,c=(l*l-n*n-s)/(-2*a*n),d=(h*h-n*n-s)/(-2*a*n);i.min=Math.max(i.min,Math.min(Math.PI-We(d),i.max)),i.max=Math.min(i.max,Math.PI-We(c))}const nf=Oe(),of=zr(),lf=Oe(),hf=Pe(5),cf={min:0,max:0},df={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},uf={eyeCenterDistance:0,requiresTwoSteps:!1},pf=e=>e*e,mf=e=>1-pf(1-e),gf=e=>e*e*e,ff=e=>1-gf(1-e),_f=e=>e<.5?gf(2*e)/2:(ff(2*(e-.5))+1)/2,yf=e=>e*e*e*e,vf=e=>1-yf(1-e),bf=e=>e*e*e*e*e,xf=e=>1-bf(1-e),wf=e=>1-Math.cos(e*Math.PI/2),Tf=e=>1-wf(1-e),Cf=e=>2**(10*(e-1)),Sf=e=>1-Cf(1-e),Pf=e=>-(Math.sqrt(1-e*e)-1),Rf=e=>1-Pf(1-e);function Af(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Of(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const Mf=Of(Af(1),1),Ef=Of(Af(1),0),Df=Of(Af(1),.5),If=Of(Af(2),1),Lf=Of(Af(2),0),Nf=Of(Af(2),.5),Ff=Of(Af(3),1),Vf=Of(Af(3),0),Uf=Of(Af(3),.5),zf=Of(Af(4),1),jf=Of(Af(4),0),kf=Of(Af(4),.5),Gf={linear:function(e){return e},"in-quad":pf,"out-quad":mf,"in-out-quad":e=>e<.5?pf(2*e)/2:(mf(2*(e-.5))+1)/2,"in-coast-quad":Mf,"out-coast-quad":Ef,"in-out-coast-quad":Df,"in-cubic":gf,"out-cubic":ff,"in-out-cubic":_f,"in-coast-cubic":If,"out-coast-cubic":Lf,"in-out-coast-cubic":Nf,"in-quart":yf,"out-quart":vf,"in-out-quart":e=>e<.5?yf(2*e)/2:(vf(2*(e-.5))+1)/2,"in-coast-quart":Ff,"out-coast-quart":Vf,"in-out-coast-quart":Uf,"in-quint":bf,"out-quint":xf,"in-out-quint":e=>e<.5?bf(2*e)/2:(xf(2*(e-.5))+1)/2,"in-coast-quint":zf,"out-coast-quint":jf,"in-out-coast-quint":kf,"in-sine":wf,"out-sine":Tf,"in-out-sine":e=>e<.5?wf(2*e)/2:(Tf(2*(e-.5))+1)/2,"in-expo":Cf,"out-expo":Sf,"in-out-expo":e=>e<.5?Cf(2*e)/2:(Sf(2*(e-.5))+1)/2,"in-circ":Pf,"out-circ":Rf,"in-out-circ":e=>e<.5?Pf(2*e)/2:(Rf(2*(e-.5))+1)/2};function qf(e,t,i=Wf,r=t){let s=!1;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(let t=0;t<Qf;t++){let t=0;for(const a of Hf)if(Pg(i.selection,a.type)){const n=Math.abs(a.error(e,r,i));a.apply(e,r,i)&&(s=!0,t+=n)}if(0===t)break}const a=Pg(i.selection,Og.COLLISION),n=function(e,t){switch(e){case Ag.PAN:return Zg.EYE_AND_CENTER;case Ag.ASCEND:return t.state.isGlobal?Zg.EYE_AND_CENTER_SCALE:Zg.EYE_AND_CENTER;default:return Zg.EYE}}(i.interactionType,e);return a&&Qg(e,r,n)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function Bf(e,t){const i="number"==typeof e?e:wr(e,t),r=Math.min(1,i/150);return _f(r)}const Hf=[{type:Og.TILT,error:function(e,t,i){return ef(e,t,i)*t.distance},apply:function e(t,i,r=Eg,s=!0){uf.eyeCenterDistance=0,uf.requiresTwoSteps=!1;const a=ef(t,i,r,void 0,uf);if(0===a)return!1;switch(Nr(of,-a,i.viewRight),r.tiltMode){case Mg.LOOK_AROUND:Qe(nf,i.viewForward,of),Ue(nf,nf,uf.eyeCenterDistance),i.center=Ge(lf,i.eye,nf);break;case Mg.TUMBLE:ze(nf,i.center,i.eye),Qe(nf,nf,of),i.eye=ze(lf,i.center,nf);break;default:Gl(r.tiltMode)}return i.up=Qe(lf,i.up,of),!uf.requiresTwoSteps||!s||e(t,i,r,!1)}},{type:Og.ALTITUDE,error:Ig,apply:function(e,t,i=Eg){const r=Ig(e,t,i);if(0===r)return!1;const s=e.renderCoordsHelper,a=s.getAltitude(t.eye)+r,n=Dg(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),Ue(r,r,i),r}(e,t,Math.sign(r),Fg),Ng),o=De(Vg,t.viewForward),l=s.intersectInfiniteManifold(rl(t.eye,n),a,Ug);return t.eye=U(l)?l:s.setAltitude(Ug,a,t.eye),t.center=al(Ug,t.eye,o,t.center),!0}},{type:Og.DISTANCE,error:zg,apply:function(e,t,i=Eg){const r=zg(e,t,i);if(0===r)return!1;const s=e.pointsOfInterest.surfaceOrigin,a=jg(e,t)+r,n=De(Gg,t.eye),o=Dg(t,i.interactionDirection,function(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return He(i,t.eye,r.renderLocation)}(e,t,Hg),Bg);if(!Xn(Yn(s.renderLocation,a),rl(t.eye,o),Wg))return!1;t.eye=Wg;const l=ze(qg,t.eye,n);t.center=Ge(Wg,t.center,l);const h=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,h,Wg);return U(c)&&(t.center=c),!0}}],Wf={selection:Og.ALL,interactionType:Ag.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Mg.TUMBLE},Qf=5,Zf=Oe(),Xf=Oe(),Yf=Oe(),Kf=Oe(),$f=Oe(),Jf=Oe(),e_={upward:Ae(0,0,1),forward:Ae(0,1,0),sideway:Ae(1,0,0)},t_=xo();class i_{constructor(e=Gi.Global){this.viewingMode=e,this.center=Oe(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=Xe(e_.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Gi.Global){const i=(Ee(this.center)+Ee(e.center))/2;t.pan=Ki(this.center,e.center)*i}else t.pan=qe(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,r),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){this.viewingMode===Gi.Global?$i(e.center,t.center,i.pan,this.center):ke(this.center,e.center,t.center,i.pan),this.distance=Ie(e.distance,t.distance,i.zoom),this.pitch=Ie(e.pitch,t.pitch,i.rotate);let r=e.yaw;const s=t.yaw;Math.abs(s-r)>=Math.PI&&(r+=2*(r<s?1:-1)*Math.PI),this.yaw=Ie(r,s,i.rotate)}copyFrom(e){De(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,De(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,t_);De(this.center,e.center),ze(Kf,e.center,e.eye),Ye(Kf,Kf,t),Ye($f,e.up,t),this.distance=Ee(Kf),Kf[0]/=this.distance,Kf[1]/=this.distance,Kf[2]/=this.distance,this.pitch=this._eyeUpToPitch(Kf),this.yaw=this._eyeUpToYaw(Kf,$f),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,t_);co(t,t),this._axisAngleVec3(e_.sideway,this.pitch-Math.PI/2,e_.forward,Kf),this._axisAngleVec3(e_.upward,this.yaw,Kf),this._axisAngleVec3(e_.sideway,this.pitch-Math.PI/2,e_.upward,$f),this._axisAngleVec3(e_.upward,this.yaw,$f),Ue(Kf,Kf,this.distance),Ye(Kf,Kf,t),Ye($f,$f,t),e.center=this.center,e.eye=ze(Kf,this.center,Kf),e.up=$f}_axisAngleVec3(e,t,i,r=i){const s=Math.cos(t),a=Math.sin(t);return Ue(Zf,i,s),Ne(Xf,e,i),Ue(Xf,Xf,a),Ue(Yf,e,(1-s)*je(e,i)),Ge(r,Ge(r,Zf,Xf),Yf)}_lookAtOrientation(e,t=xo()){return this._upAtLookAt(e,Yf),Ne(Zf,this.lookAtDirection,Yf),Fe(Zf,Zf),0===Zf[0]&&0===Zf[1]&&0===Zf[2]&&De(Zf,e_.sideway),Ne(Xf,Yf,Zf),Fe(Xf,Xf),t[0]=Zf[0],t[1]=Xf[0],t[2]=Yf[0],t[3]=Zf[1],t[4]=Xf[1],t[5]=Yf[1],t[6]=Zf[2],t[7]=Xf[2],t[8]=Yf[2],t}_upAtLookAt(e,t){return this.viewingMode===Gi.Local?De(t,e_.upward):Fe(t,e)}_eyeUpToPitch(e){return Math.PI-Ki(e_.upward,e)}_eyeUpToYaw(e,t){const i=Jf;return Math.abs(t[2])<.5?(De(i,t),e[2]>0&&Ue(i,i,-1)):De(i,e),Ne(Xf,i,e_.upward),Fe(Xf,Xf),Ki(e_.sideway,Xf,e_.upward)}}const r_=ae(500),s_=ae(8e3);class a_{constructor(e){this.createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:2},this.source=e(),this.target=e()}clone(){const e=new a_(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:2,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class n_{constructor(e){e&&this.update(e)}get time(){return this._time}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const s=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(r))/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:s}=this.definition;let a=0,n=0;i&&(r&&(a=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(n=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&r&&s){const e=a+n+a*n;this._zoomPixelFlow=a*n/e*o,this._panPixelFlow=n/e*o,this._rotatePixelFlow=a/e*o}else if(i&&r){const e=1+a;this._zoomPixelFlow=a/e*o,this._panPixelFlow=1/e*o}else if(i&&s){const e=1+n;this._zoomPixelFlow=n/e*o,this._rotatePixelFlow=1/e*o}else if(r&&s){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else r?this._panPixelFlow=o:i?this._zoomPixelFlow=o:s&&(this._rotatePixelFlow=o);this._time=s?this.rotateTime:i?this.zoomTime:r?this.panTime:ne(0)}get rotateTime(){return this.definition.hasRotate?ne(this._rotatePixels/this._rotatePixelFlow):ne(0)}get zoomTime(){return this.definition.hasZoom?ne(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):ne(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return ne(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return ne(this._panPixelsAtSource/this._panPixelFlow)}return ne(0)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),r=this._interpolateComponentsPan(e),s=this._interpolateComponentsRotate(e);return t?(t.zoom=i,t.pan=r,t.rotate=s):t={zoom:i,pan:r,rotate:s},t}}function o_(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function l_(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),a=1/e.desiredPixelFlow,n=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,h=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*a*n*l*h-e.halfWindowSize*s*a*n*l+e.halfWindowSize*s*a*n*h/(o*o)}function h_(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,a=1/t,n=Math.log(e.compared.sourceZoom*a),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*a*o+2*s*n+2*a-2*n*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function c_(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function d_(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function u_(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function p_(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function m_(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,a=1/Math.LN2,n=-t+e.compared.targetZoom,o=1/n,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*a*o+e.halfWindowSize*r*s*a*l/(n*n)+e.halfWindowSize*s*a*o*l/t}function g_(e,t,i){const r=t-e.compared.targetZoom,s=1/r,a=1/t,n=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*a*o-2*s*n+2*a+2*n*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function f_(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function __(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function y_(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}class v_ extends class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((e,t)=>ne(e+t.time)),ne(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const s=this.definition;for(let a=0;a<this.segments.length;a++){const n=this.segments[a],o=n.definition;if(e<=n.time||a===this.segments.length-1){t=this.segmentInterpolateComponentsAt(n,e/n.time,t),s.hasPan?t.pan=(i+o.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate?t.rotate=(r+o.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1;const a=t.zoom*(o.compared.targetZoom-o.compared.sourceZoom)+o.compared.sourceZoom,l=this.segments[0].definition.compared.sourceZoom,h=this.segments[this.segments.length-1].definition.compared.targetZoom;return s.hasZoom?t.zoom=(a-l)/(h-l):t.zoom=1,t}e-=n.time,i+=o.compared.pan,r+=o.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){return e.interpolateComponentsAt(t,i)}}{constructor(e,t){super(),this._preallocSegments=[new n_,new n_,new n_],this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;t&&t.apex&&(i=function(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}(e,t);const r={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},s=0===r.ascensionFactor,a=0===r.descensionFactor,n=s?c_:o_,o=s?d_:l_,l=s?u_:h_,h=a?f_:p_,c=a?__:m_,d=a?y_:g_,u=t=>n(e,t,r)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,r)+h(e,t,r),p=t=>o(e,t,r)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,r)+c(e,t,r),m=t=>l(e,t,r)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,r)+d(e,t,r);let g=u(i);const f=function(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-r):s*(t+r)}(e);let _;const y=t.maximumIterations||20,v=null!=t.maximumDistance?t.maximumDistance:1/0;for(_=0;_<y;_++){const t=1e-6,r=(p(i)+t)/m(i);if(isNaN(r)||i>=v&&r<0){if(!isFinite(v))return null;i=v,g=u(i);break}if(i-=r,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const s=u(i);if(Math.abs(s-g)/g<=.005)break;g=s}return g>.7*f||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,t.apex)}segmentInterpolateComponentsAt(e,t,i){return i=e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=mf(i.zoom):e===this._descensionSegment&&(i.zoom=pf(i.zoom)),i}_updateWithApex(e,t){const[i,r,s]=this._preallocSegments,a=null!=t.ascensionFactor?t.ascensionFactor:.5,n=Math.min(1-a,null!=t.ascensionFactor?t.descensionFactor:.5),o=1-a-n;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*a,i.definition.compared.rotate=this.definition.compared.rotate*a,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this.segments.push(r)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*n,s.definition.compared.rotate=this.definition.compared.rotate*n,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const b_={zoom:0,pan:0,rotate:0};class x_{constructor(e){this.createCamera=e,this._time=ae(0),this.definition=new a_(e),this.path=new v_}get time(){return this._time}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(oe(this.path.time),i),this._easing=i.easing?i.easing:this._time>=1e3?Df:Sf}cameraAt(e,t){t=t||this.createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,b_);return t.interpolate(this.definition.source,this.definition.target,i),t}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e=ae(e/i));const r=null!=t.minDuration?t.minDuration:r_/i,s=null!=t.maxDuration?t.maxDuration:s_/i;return ae(Math.min(Math.max(r,e),s))}}const w_=Oe();class T_{constructor(e){this.currentTime=ae(0),this._animation=new x_((()=>new i_(e))),this._current=new i_(e)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(e,t,i){const r=this._animation.definition.source,s=this._animation.definition.target,a=ze(w_,t.center,e.center),n=Ee(a);n>=1e-5?(a[0]/=n,a[1]/=n,a[2]/=n):(a[0]=0,a[1]=1,a[0]=0),De(r.lookAtDirection,a),De(s.lookAtDirection,a),r.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,s,i),this.currentTime=ae(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new ql,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=ae(this.currentTime+oe(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}var C_;!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(C_||(C_={}));let S_=class extends N{constructor(){super(...arguments),this.state=C_.Ready}get active(){return this.state===C_.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=C_.Stopped,!0)}finishController(){this.state=C_.Finished}get steppingFinished(){return!1}};e([ve({readOnly:!0})],S_.prototype,"active",null),e([ve()],S_.prototype,"state",void 0),S_=e([xe("esri.views.3d.state.controllers.CameraController")],S_);let P_=class extends S_{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(h()),this._asyncResult=null),this.state===C_.Finished||this.state===C_.Stopped?this.state===C_.Finished?e.resolve():e.reject(h()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=C_.Running,U(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!U(this.viewAnimation)||this.state!==C_.Ready&&this.state!==C_.Running||(this.viewAnimation.state===ki.State.FINISHED?this.finish():this.viewAnimation.state===ki.State.STOPPED&&(this.state=C_.Stopped))}onControllerEnd(){U(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===C_.Finished?this.viewAnimation.finish():this.state===C_.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===C_.Finished?this._asyncResult.resolve():this._asyncResult.reject(h()))}finish(){this.finishController()}};P_=e([xe("esri.views.3d.state.controllers.AnimationController")],P_);let R_=class extends P_{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new T_(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new ki}get isInteractive(){return"interaction"===this.mode}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);A_.copyFrom(this.view.state.camera);const r=Hl(this.view.state.viewingMode);this.intersectionHelper.intersectRay(A_.ray,r,O_)&&(A_.center=O_),this.animation.update(A_,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?Gf[e.easing]:e.easing}}};e([ve({constructOnly:!0})],R_.prototype,"view",void 0),e([ve({constructOnly:!0})],R_.prototype,"mode",void 0),R_=e([xe("esri.views.3d.state.controllers.PointToPointAnimationController")],R_);const A_=new ql,O_=Oe();function M_(e,t,i,r){const s=ch(t,i,E_);return Xn(e,s,r)}const E_=sl();var D_;!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(D_||(D_={}));const I_=[1,3e8];function L_(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function N_(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function F_(e,t,i){const r=Nr(no.get(),i[3],i);z(r)||(ze(Cy,e.eye,t),Qe(Cy,Cy,r),e.eye=Ge(Cy,Cy,t),ze(Cy,e.center,t),Qe(Cy,Cy,r),e.center=Ge(Cy,Cy,t),e.up=Qe(Cy,e.up,r))}function V_(e,t,i,r){return th(e,ch(t,i,Oy),r)}function U_(e,t,i,r){const s=oo.get();let a=1-i;ze(s,t,e.eye);const n=Ee(s);let o=n*(1-a);a>=0&&o<r&&(o=r,a=-(o-n)/n),Math.abs(n-o)<1e-6||(Ue(s,s,a),e.eye=Ge(Cy,e.eye,s),e.center=ke(Cy,e.center,t,a))}function z_(e,t,i){t.getScreenCenter(j_),M_(e,t,j_,Cy)&&(t.center=Cy);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const a=Ue(oo.get(),t.viewForward,s);t.eye=ze(Cy,t.center,a)}const j_=ue();function k_(e,t){Me(t,0,0,0);for(const i of e)Ge(t,t,i);Ue(t,t,1/e.length)}function G_(e,t,i,r){return Math.sin(e/Ee(t))*(i+r.radius)}function q_(e,t,i,r){return G_(Math.PI/2,t,i,r)+(e-Math.PI/2)}var B_;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(B_||(B_={}));const H_=Pe(6),W_={Pole:.95,Angle:Pe(18),Tilt:45},Q_=Pe(80);function Z_(e,t,i,r,s,a){const n=Oe(),o=eo();let l=!0,h=!0;return e.intersectScreen(i,n,a)?o[3]=Ee(n):(h=!1,t.aboveGround&&s!==D_.Ellipsoid?o[3]=Math.max(Ee(t.center),.9*r.radius):o[3]=Ee(t.eye)-t.relativeElevation,s===D_.Silhouette?$_(o,t,i,n):l=M_(o,t,i,n)),{sphere:o,scenePickPoint:l?n:null,hasGeometryIntersection:h}}function X_(e,t,i,r){return Ee(e.eye)-r.radius>3e4?B_.Horizontal:i?(ch(e,t,My),-Math.sign(e.relativeElevation)*(.5*Math.PI+Zn(e.eye,My.direction))<H_?B_.Vertical:B_.Horizontal):B_.Vertical}function Y_(e,t,i){ze(K_,i,t),e.eye=ze(Cy,e.eye,K_),e.center=ze(Cy,e.center,K_)}const K_=Oe();function $_(e,t,i,r){const s=ch(t,i,Oy);return!(z(s)||(Kn(e,s,J_),Xn(e,s,r)?Ke(J_,s.origin)<Ke(r,s.origin)&&(De(r,J_),1):(ze(ey,t.eye,t.center),Fe(ey,ey),ih(ey,-je(Fe(ey,ey),J_),ty),th(ty,s,r),1)))}const J_=Oe(),ey=Oe(),ty=eh();function iy(e,t,i,r,s,a){let n;if(Ne(Ry,e,t),ze(Sy,e,t),Ee(e)<=s||!r.aboveGround){Ne(i,Sy,r.eye);const o=je(e,t)/(Ee(e)*Ee(t)),l=Math.cos(Se($l.normalize(Pe(a)),0,Q_));n=-We(o)-Math.max(0,Ee(t)-s)/(l*s)}else ze(ry,r.eye,r.center),Ne(i,Sy,ry),n=-Ee(Sy)/s;return Fe(i,i),Ue(i,i,Ee(Ry)),n}const ry=Oe();function sy(e,t,i,r){let s,a;const n=Math.cos(Se($l.normalize(Pe(r)),0,Q_));return s=t>i?-(t-i)/(n*i):t<-i?Math.PI-(t+i)/(n*i):We(t/i),a=e>i?-(e-i)/(n*i):e<-i?Math.PI-(e+i)/(n*i):We(e/i),(a-s)*i}function ay(e,t,i,r,s,a,n,o,l,h){Ne(Ry,e,t),di(a.up,a.eye,py,my,gy),di([0,0,1],a.eye,cy,dy,uy),De(i,dy),De(r,cy),Fe(i,i),Ue(i,i,Ee(Ry)),ui(e,Fe(my,my),Fe(gy,gy),Fe(py,py),fy),ui(t,my,gy,py,_y),function(e,t,i,r,s,a,n,o,l,h){const c=sy(e[2],t[2],n[3],l),d=h?sy(e[0],t[0],n[3],180):t[0]-e[0],u=Math.sin(o)*d-Math.cos(o)*c,p=Math.cos(o)*d+Math.sin(o)*c;Fe(Cy,s);const m=h?u/Math.sqrt(Math.abs(n[3]**2-je(i,Cy)**2)):u/n[3],g=p/Math.sqrt(Math.abs(n[3]**2-je(i,r)**2));xr(a,m,g)}(fy,_y,e,cy,dy,s,n,o,l,h)}function ny(e,t,i,r,s,a){Nr(by,r,i),Nr(xy,a,s),Ir(wy,by,xy),ze(Cy,e.eye,t),Qe(Cy,Cy,wy),e.eye=Ge(Cy,Cy,t),ze(Cy,e.center,t),Qe(Cy,Cy,wy),e.center=Ge(Cy,Cy,t),ze(Cy,e.up,t),Qe(Cy,Cy,wy),e.up=Ge(Cy,Cy,t)}function oy(e,t,i,r,s,a,n=W_.Pole,o=W_.Angle){const l=Math.abs(r)>Math.PI-o||Math.abs(r)<o,h=Math.abs(e[2])<i*n||Math.abs(t)>i;return!!(l&&h&&a.aboveGround&&s<W_.Tilt)}function ly(e,t,i,r,s,a){if(a)jp(i,r,vy),F_(t,e,vy);else{const a=iy(i,r,Ay,t,e[3],s);F_(t,e,zp(Ay,a))}}function hy(e,t,i,r,s,a,n){const o=n?20:1;let l,h;De(Ty,r),Py.copyFrom(t);for(let r=0;r<o&&Ke(i,Ty)>1e-12&&(l=Ke(i,Ty),ay(i,Ty,dy,cy,yy,Py,e,s,a,n),ny(Py,e,cy,yy[1],dy,yy[0]),c=Ty,d=Ty,u=e,p=cy,m=yy[1],g=dy,f=yy[0],Nr(by,m,p),Nr(xy,f,g),Ir(wy,by,xy),ze(d,c,u),Qe(d,d,wy),Ge(d,d,u),h=Ke(i,Ty),h<l||0===r);r++)t.copyFrom(Py);var c,d,u,p,m,g,f}const cy=Oe(),dy=Oe(),uy=Oe(),py=Oe(),my=Oe(),gy=Oe(),fy=Oe(),_y=Oe(),yy=Sr(),vy=Up(),by=zr(),xy=zr(),wy=zr(),Ty=Oe(),Cy=Oe(),Sy=Oe(),Py=new ql,Ry=Oe(),Ay=Oe(),Oy={origin:Oe(),direction:Oe()},My={origin:Oe(),direction:Oe()};let Ey=class extends R_{constructor(){super(...arguments),this.zoomLocation=Oe(),this.tmpCamera=new ql,this.tmpViewDir=Oe(),this.tmpRayDir={origin:Oe(),direction:Oe()},this.targetOnSphere=Oe(),this.tmpCenter=Oe(),this.constraintOptions={selection:Og.ALL_EXCEPT_COLLISION,interactionType:Ag.ZOOM,interactionFactor:null,interactionStartCamera:new ql,interactionDirection:null,tiltMode:Mg.TUMBLE},this.sphere=eo()}initialize(){this.intersector=Hl(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,a=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation,0===this.view.map.ground.opacity?Ly:{})&&(s=e>0,a=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:De(this.zoomLocation,this.tmpCamera.center),this._updateCamera(this.tmpCamera,e,this.zoomLocation,t,a),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:ae(600),easing:Sf}}_updateCamera(e,t,i,r,s){const a=X_(e,r,s,vr(this.view.spatialReference));let n;this.view.camera.position.hasZ&&(n=Math.abs(this.view.camera.position.z)),Fe(Iy,e.eye),Ue(Iy,Iy,-1),ch(e,r,this.tmpRayDir),Fe(this.tmpRayDir.direction,this.tmpRayDir.direction);const o=Math.max(Math.min(12,1/Math.abs(je(Iy,this.tmpRayDir.direction)))*n,200);if(a===B_.Horizontal){let s=.6**t;this.sphere[3]=Ee(i),ze(this.tmpViewDir,e.center,e.eye);const a=Math.min(Ee(this.tmpViewDir),o);let n=a*s;if(s<=1&&n<4&&(n=4,s=n/a),Math.abs(a-n)<1e-6)return;const m=Ee(e.center);if(this.sphere[3]!==m){const t=this.sphere[3]+s*(m-this.sphere[3]);e.center=Ue(Dy,e.center,t/m)}Ue(this.tmpViewDir,this.tmpViewDir,-s),e.eye=Ge(Dy,e.center,this.tmpViewDir),qf(this.view,e,this.constraintOptions),Ke(i,e.center)>1e-12&&M_(this.sphere,e,r,this.targetOnSphere)&&(l=this.sphere,h=e,c=i,d=this.targetOnSphere,u=this.view.camera.heading,p=this.view.camera.tilt,oy(c,je(h.up,c),l[3],-$l.normalize(Pe(u)),p,h,W_.Pole,W_.Angle)?hy(l,h,c,d,-$l.normalize(Pe(u)),p,!0):ly(l,h,c,d,p,!0))}else{let a=.6**Math.abs(t);const n=t>0?1:-1;ze(this.tmpViewDir,i,e.eye);const l=Ee(this.tmpViewDir),h=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,60);let c=h?Math.min(o,h):o;c=s?Math.min(c,l):c,Ue(this.tmpRayDir.direction,this.tmpRayDir.direction,c),Ge(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let d=c*a;const u=Math.max(4,1.01*e.nearFar[0]);if(t>0&&d<u&&(d=u,a=d/c),Math.abs(c-d)<1e-6)return;Ue(this.tmpRayDir.direction,this.tmpRayDir.direction,n*(1-a)),e.eye=Ge(Dy,e.eye,this.tmpRayDir.direction),e.center=Ge(Dy,e.center,this.tmpRayDir.direction)}var l,h,c,d,u,p;Qg(this.view,e)}};Ey=e([xe("esri.views.3d.state.controllers.global.ZoomStepController")],Ey);const Dy=Oe(),Iy=Oe(),Ly={exclude:new Set([ph])};let Ny=class extends R_{constructor(){super(...arguments),this.zoomLocation=Oe(),this.tmpCamera=new ql,this.tmpRayDir=Oe(),this.tmpCenter=Oe(),this.constraintOptions={selection:Og.ALL,interactionType:Ag.ZOOM,interactionFactor:null,interactionStartCamera:new ql,interactionDirection:null,tiltMode:Mg.TUMBLE}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=Hl(this.view.state.viewingMode);e>0?(0===this.view.map.ground.opacity?this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation,zy):this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:De(this.zoomLocation,this.tmpCamera.center);const a=.6**e;let n=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],this.view.state.camera,60);ze(Uy,this.tmpCamera.eye,this.zoomLocation),Fe(Uy,Uy);const o=Math.max(Math.min(14,1/Math.abs(je(Vy,Uy)))*Math.abs(this.view.camera.position.z),200);if(n=n?Math.min(n,o):o,n){const e=Oe();ze(e,this.zoomLocation,this.tmpCamera.eye),n<Ee(e)&&(Fe(e,e),Ge(this.zoomLocation,this.tmpCamera.eye,Ue(e,e,n)))}this._updateCamera(this.tmpCamera,a,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:ae(600),easing:Sf}}_updateCamera(e,t,i){ze(this.tmpRayDir,i,e.eye);const r=Ee(this.tmpRayDir);let s=r*t;const a=t<=1,n=Math.max(4,1.01*e.nearFar[0]);a&&s<n&&(s=n,t=s/r),Math.abs(r-s)<1e-6||(Ue(this.tmpRayDir,this.tmpRayDir,t),e.eye=ze(Fy,i,this.tmpRayDir),e.center=ke(Fy,e.center,i,1-t),qf(this.view,e,this.constraintOptions))}};Ny=e([xe("esri.views.3d.state.controllers.local.ZoomStepController")],Ny);const Fy=Oe(),Vy=Ae(0,0,1),Uy=Oe(),zy={exclude:new Set([ph])};class jy extends fh{constructor(e,t){super(!0),this.view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if(Ri(t,"primary")){const i=this.view.state.isGlobal?new Ey({view:this.view,mode:"animation"}):new Ny({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),ue(t.x,t.y)),e.stopPropagation()}}}let ky=class extends S_{constructor(){super(...arguments),this.startCamera=new ql,this.currentCamera=new ql}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=C_.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};var Gy;ky=e([xe("esri.views.3d.state.controllers.InteractiveController")],ky),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(Gy||(Gy={}));let qy=class extends ky{constructor(e){super(e),this.view=null,this.pivot=Gy.CENTER,this.lastPoint=Sr(),this.tmpWorldUp=Oe(),this.tmpViewDir=Oe(),this.tmpRotCurPoint=Sr(),this.tmpTransf=zr(),this.tmpAxis=Oe(),this.tmpPivotPoint=Oe(),this.pivotPos=Oe(),this.constraintOptions={selection:Og.ALL,interactionType:Ag.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Mg.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=this.pivot===Gy.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case Gy.EYE:De(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=Ag.LOOK_AROUND,this.constraintOptions.tiltMode=Mg.LOOK_AROUND,this.constraintOptions.selection=Og.NONE;break;case Gy.CENTER:{const t=this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos);t||De(this.pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=Ag.TUMBLE,this.constraintOptions.tiltMode=Mg.TUMBLE,this.constraintOptions.selection=Og.ALL&~Og.DISTANCE;break}}this.constraintOptions.interactionStartCamera=this.startCamera,L_(this.startCamera,e,this.lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=Oe();ze(r,this.pivotPos,i.eye);const s=Ee(r);let a=Math.min(s,7*Math.abs(this.view.camera.position.z));const n=vr(this.view.spatialReference),o=ue(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=X_(this.startCamera,o,!0,n);let h=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,225,90),c=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],i,90);void 0===h&&void 0===c||(h=void 0===h?c:h,c=void 0===c||l===B_.Horizontal?h:c,a=h>c?c:h,a=t?Math.min(a,s):a),Fe(r,r),De(this.pivotPos,Ge(this.tmpPivotPoint,i.eye,Ue(this.tmpPivotPoint,r,a)))}update(e){if(this.active){switch(this.pivot){case Gy.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this.pivotPos);break;case Gy.CENTER:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this.pivotPos)}qf(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),L_(e,t,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,a=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;ze(this.tmpViewDir,i,r);const n=Ee(this.tmpViewDir),o=We(je(this.tmpViewDir,this.tmpWorldUp)/n);if(this.pivot===Gy.EYE){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}return s=Se(s+o,gp.min,gp.max)-o,Ne(this.tmpAxis,e.up,this.tmpViewDir),this.pivot===Gy.CENTER&&(a=-a),Nr(this.tmpTransf,a,this.tmpWorldUp),Or(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),Qe(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),e.up=Qe(By,e.up,this.tmpTransf),Ge(By,r,this.tmpViewDir),Tr(this.lastPoint,this.tmpRotCurPoint),By}};e([ve({constructOnly:!0})],qy.prototype,"view",void 0),e([ve()],qy.prototype,"pivot",void 0),qy=e([xe("esri.views.3d.state.controllers.RotateController")],qy);const By=Oe();class Hy extends fh{constructor(e,t,i,r){super(!0),this.view=e,this.pointerAction=t,this.pivot=i,this.registerIncoming("drag",r,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Ai(e.data,this.pointerAction))return;const i=ue(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new qy({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}let Wy=class extends ky{constructor(e){super(e),this.view=null,this.pickPoint=Oe(),this.tmpP0=Sr(),this.panAxisAngle=Up(),this.tmpRayDir=Oe(),this.tmpRayDirPick=Oe(),this.targetOnSphere=Oe(),this.tmpRay={origin:Oe(),direction:Oe()},this.dragBeginPoint=ue(),this.normalizedAnchorPoint=Sr(),this.constraintOptions={selection:Og.ALL_EXCEPT_COLLISION,interactionType:Ag.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Mg.TUMBLE},this.sphere=eo(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Tr(this.dragBeginPoint,e),L_(this.startCamera,e,this.normalizedAnchorPoint);const t=vr(this.view.spatialReference),i=Z_(this.intersectionHelper,this.startCamera,e,t,D_.Ellipsoid,0===this.view.map.ground.opacity?Zy:{});if(this.navMode=X_(this.startCamera,e,i.hasGeometryIntersection,t),this.navMode===B_.Horizontal)this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let t,r;ch(this.startCamera,e,this.tmpRay),Fe(this.tmpRay.direction,this.tmpRay.direction),i.scenePickPoint&&(ze(this.tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),r=Ee(this.tmpRayDirPick)),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let s=Se(30*t,I_[0],I_[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,70);s=a?Math.min(s,a):s,s=i.scenePickPoint?Math.min(s,r):s,this.hasPickPoint=!0,Ue(this.tmpRay.direction,this.tmpRay.direction,s),Ge(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===B_.Horizontal){ze(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=Ee(this.tmpRayDir);L_(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this.sphere[3]/Ee(this.currentCamera.center));this.currentCamera.center=Ue(Qy,this.currentCamera.center,e)}Ue(this.tmpRayDir,this.tmpRayDir,-r/t),this.currentCamera.eye=Ge(Qy,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=Bf(this.dragBeginPoint,e),qf(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&($_(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),jp(this.pickPoint,this.targetOnSphere,this.panAxisAngle),F_(this.currentCamera,this.sphere,this.panAxisAngle))}else{const t=Ee(this.tmpRay.direction);L_(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;Ue(this.tmpRayDir,this.tmpRay.direction,1-r/t),this.currentCamera.eye=Ge(Qy,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=Ge(Qy,this.currentCamera.center,this.tmpRayDir)}Qg(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};e([ve({constructOnly:!0})],Wy.prototype,"view",void 0),Wy=e([xe("esri.views.3d.state.controllers.global.ZoomController")],Wy);const Qy=Oe(),Zy={exclude:new Set([ph])};let Xy=class extends ky{constructor(e){super(e),this.view=null,this.tmpP=Oe(),this.tmpDir=Oe(),this.tmpN=Oe(),this.tmpP0=Sr(),this.tmpPoi=Oe(),this.tmpRayDir=Oe(),this.dragBeginPoint=ue(),this.normalizedAnchorPoint=Sr(),this.constraintOptions={selection:Og.ALL,interactionType:Ag.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:Oe(),tiltMode:Mg.TUMBLE},this.plane=eh()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Tr(this.dragBeginPoint,e),L_(this.startCamera,e,this.normalizedAnchorPoint);const t=this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP,0===this.view.map.ground.opacity?Ky:{});ze(this.tmpDir,this.tmpP,this.startCamera.eye);const i=Ee(this.tmpDir);let r;Fe(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let s=Se(30*r,I_[0],I_[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,70);s=a?Math.min(s,a):s,s=t?Math.min(s,i):s,Ue(this.tmpDir,this.tmpDir,s),Ge(this.tmpP,this.startCamera.eye,this.tmpDir),ze(this.tmpN,this.startCamera.eye,this.startCamera.center),Fe(this.tmpN,this.tmpN),this.tmpN[1]<0&&$e(this.tmpN,this.tmpN),rh(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;(function(e,t,i,r){return th(e,dh(t,i,Oy),r)})(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||De(this.tmpPoi,this.currentCamera.center),L_(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);Tr(this.normalizedAnchorPoint,this.tmpP0),ze(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=Ee(this.tmpRayDir);let r=i*(1-t);De(this.constraintOptions.interactionDirection,this.tmpRayDir),Ue(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Math.sign(t)/i);const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(Ue(this.tmpRayDir,this.tmpRayDir,t),this.currentCamera.eye=Ge(Yy,this.currentCamera.eye,this.tmpRayDir),ke(Yy,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.startCamera.center[2]?Yy[2]=Math.max(this.startCamera.center[2],Yy[2]):Yy[2]=Math.min(this.startCamera.center[2],Yy[2]),this.currentCamera.center=Yy,this.constraintOptions.interactionFactor=Bf(this.dragBeginPoint,e),qf(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};e([ve({constructOnly:!0})],Xy.prototype,"view",void 0),Xy=e([xe("esri.views.3d.state.controllers.local.ZoomController")],Xy);const Yy=Oe(),Ky={exclude:new Set([ph])};class $y extends fh{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Ai(e.data,this.pointerAction))return;const i=ue(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new Wy({view:this.view}):this.cameraController=new Xy({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}let Jy=class extends ky{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new ql,this.constraintOptions={selection:Og.ALL,interactionType:Ag.NONE,interactionStartCamera:new ql,interactionFactor:0,interactionDirection:null,tiltMode:Mg.LOOK_AROUND}}handleEventGamepad(e){const t=Oi(e,this.view.navigation.gamepad,this.transformation);("end"===e.action||Mi(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,Ei(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=Ei(this.keysButtonState,this.transformation);Mi(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,ov),this._applyDisabledMovementTypes(ov),this._applyPan(ov.pan),this._applyRotate(ov.rotate),this._applyZoom(ov.zoom),this._applyAscend(ov.ascend),this.constraintOptions.interactionType=Ag.NONE,this.constraintOptions.selection=Og.COLLISION,qf(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;ze(lv,t.center,t.eye),Qe(lv,lv,e.matrix),t.center=Ge(lv,lv,t.eye),t.up=Qe(lv,t.up,e.matrix),this.constraintOptions.interactionType=Ag.LOOK_AROUND,this.constraintOptions.selection=Og.ALL_EXCEPT_COLLISION,qf(this.view,t,this.constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=Qe(lv,t.eye,e.matrix),t.center=Qe(lv,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Qe(lv,t.up,e.matrix)),this.constraintOptions.interactionType=Ag.PAN,this.constraintOptions.selection=Og.ALL,qf(this.view,t,this.constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=Ge(lv,this.currentCamera.eye,Ue(oo.get(),t,e)),De(hv,t),$e(hv,hv),this.constraintOptions.interactionDirection=hv,this.constraintOptions.interactionType=Ag.ZOOM,this.constraintOptions.selection=Og.ALL_EXCEPT_COLLISION,qf(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,oo.get());if(this.constraintOptions.interactionDirection=De(hv,t),this.view.state.isGlobal){const t=Ee(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=Ue(lv,this.currentCamera.eye,i),this.currentCamera.center=Ue(lv,this.currentCamera.center,i)}else{const i=Ue(oo.get(),t,e);this.currentCamera.eye=Ge(lv,this.currentCamera.eye,i),this.currentCamera.center=Ge(lv,this.currentCamera.center,i)}this._updateCameraCenter(),this.constraintOptions.interactionType=Ag.ASCEND,this.constraintOptions.selection=Og.COLLISION,qf(this.view,this.currentCamera,this.constraintOptions)&&this._updateCameraCenter(),this.constraintOptions.selection=Og.ALL_EXCEPT_COLLISION,qf(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Vr(e.pan.matrix),e.rotate.enabled=!1,Vr(e.rotate.matrix)}(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,lv)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,a=this.transformation,n=this.view.navigation.gamepad,o=Me(oo.get(),s[0],s[1],0);Fe(o,o);const l=a.translation[0]*e.pan;if(0!==l){const e=Ue(oo.get(),r,l);Fr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(n.mode){case"pan":{const t=-a.translation[1]*e.pan;if(0!==t){const e=Ue(oo.get(),o,t);Fr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=a.zoom*e.zoom;break}case"zoom":i.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:Gl(n.mode)}const h=a.translation[2]*e.ascend;i.ascend=h;const c=-a.heading*e.rotate;0!==c&&(Or(i.rotate.matrix,i.rotate.matrix,c,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,oo.get())),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=Kg(this.view.renderCoordsHelper,t.center,t.eye),p=Se(u+d,gp.min,gp.max)-u;p&&(Or(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,a=this.transformation,n=this.view.navigation.gamepad,o=Ne(oo.get(),s,r);Fe(o,o),$e(o,o),function(e,t,i,r,s,a,n,o,l){oy(e.center,je(e.up,e.center),Ee(e.center),-$l.normalize(Pe(a)),n,t)?function(e,t,i,r,s,a){const{eye:n}=e;di([0,0,1],n,cy,dy,uy);const o=t.translation[0]*i.pan,l="zoom"===s.mode?0:t.translation[1]*i.pan,h=Math.max(Math.sqrt(Math.abs(1-je(e.center,cy)**2/Ee(e.center)**2)),.5),c=(Math.sin(a)*l+Math.cos(a)*o)/h,d=-Math.cos(a)*l+Math.sin(a)*o;switch(Or(r.pan.matrix,r.pan.matrix,c,cy),r.pan.enabled=!0,s.mode){case"pan":Or(r.pan.matrix,r.pan.matrix,d,dy),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-$l.normalize(Pe(s))):function(e,t,i,r,s){const{eye:a,viewRight:n}=e,o=Ne(oo.get(),n,a),l=t.translation[0]*i.pan;switch(0!==l&&(Or(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&(Or(r.pan.matrix,r.pan.matrix,e,n),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}(this.startCamera,t,a,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,n),this.tmpCamera.copyFrom(this.currentCamera),this._applyPan(ov.pan,this.tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=a.translation[2]*e.ascend;i.ascend=h;const c=-a.heading*e.rotate;0!==c&&(Or(i.rotate.matrix,i.rotate.matrix,c,this.tmpCamera.eye),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=this._clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&(Or(i.rotate.matrix,i.rotate.matrix,u,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=a.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=vr(this.view.spatialReference),s=G_(gp.min,t.origin,i,r);let a=0,n=0;const o=oo.get();return this.view.renderCoordsHelper.intersectManifold(t,i,o)?(a=G_(Kg(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),n=G_(gp.max,t.origin,i,r)):(Kn($n(Jn,i+r.radius),t,o),a=q_(We(-je(t.direction,Fe(o,o))),t.origin,i,r),n=q_(gp.max,t.origin,i,r)),Se(a+e,s,n)-a}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),a=t+Math.abs(s-t);return r.setAltitude(i,a,e),a}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=Cl(this.view,t,0,tv,cv),a=i.intersectManifoldClosestSilhouette(rl(t,s),e,oo.get()),n=qe(t,a),o=i.intersectManifoldClosestSilhouette(rl(t,He(oo.get(),t,r.center)),e,oo.get()),l=qe(t,o);return Math.min(n,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,a=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,oo.get());if(s){const t=ze(oo.get(),e,a),i=Ee(t);Ue(t,t,1/i);const r=Fe(oo.get(),e),s=We(je(r,t));return i*Math.sin(Math.min(iv,s))}{const i=De(oo.get(),e);return t.setAltitude(i,this.filteredSurfaceElevation),qe(a,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:sv}_computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+vr(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,a=oo.get(),n=this._getPointAbsoluteSurfaceElevation(r.eye,t,a),o=this._clampedDistanceToSurface(t,a),l=r.width/2,h=rv*r.width,c=rv*r.width,d=o*Math.tan(.5*r.fovX)/l,u=d/i,p=d/this._computeHeadingRotateRadius(a),m=n-t;return{pan:(s?u:d)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/l)*m-m),zoom:2**(h*e/l)*o-o,rotate:Se(p*c,av,nv)*e}}_applyDisabledMovementTypes(e){!U(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Vr(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Vr(e.rotate.matrix))}static activatesFor(e,t){const i=Oi(t,e.navigation.gamepad,ev);return!("end"===t.action||Mi(i))}};e([ve({constructOnly:!0})],Jy.prototype,"view",void 0),e([ve({constructOnly:!0})],Jy.prototype,"gamepadDevice",void 0),e([ve({constructOnly:!0})],Jy.prototype,"disableMovements",void 0),Jy=e([xe("esri.views.3d.state.controllers.GamepadKeyboardController")],Jy);const ev={translation:[0,0,0],heading:0,tilt:0,zoom:0},tv=80,iv=Pe(tv),rv=.75,sv=5,av=Pe(30),nv=Pe(80),ov={zoom:0,ascend:0,pan:{enabled:!1,matrix:zr()},rotate:{enabled:!1,matrix:zr()}},lv=Oe(),hv=Oe(),cv=Sl();class dv extends fh{constructor(e){super(!0),this.view=e,this.watchHandles=new lr,this.handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this.handle.pause()}onInstall(e){super.onInstall(e),this.watchHandles.add([K((()=>this.view.navigation.gamepad.enabled),(e=>{e?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))}),$),K((()=>this.view.navigation.gamepad.device),(e=>{this.cameraControllerGamepad&&e&&this.cameraControllerGamepad.gamepadDevice!==e&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)}))])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this.view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(i||Jy.activatesFor(this.view,e.data)){if(!i){const t=new Jy({view:this.view,gamepadDevice:e.data.device});this.view.state.switchCameraController(t)&&(this.cameraControllerGamepad=t)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===e.data.device&&this.cameraControllerGamepad.handleEventGamepad(e.data)}}}var uv;!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(uv||(uv={}));class pv extends fh{constructor(e,t){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Gi.Local},this.keyToNumber={[t.left]:uv.LEFT,[t.right]:uv.RIGHT,[t.forward]:uv.FORWARD,[t.backward]:uv.BACKWARD,[t.up]:uv.UP,[t.down]:uv.DOWN,[t.headingLeft]:uv.HEADINGLEFT,[t.headingRight]:uv.HEADINGRIGHT,[t.tiltUp]:uv.TILTUP,[t.tiltDown]:uv.TILTDOWN,[t.zoomIn]:uv.ZOOMIN,[t.zoomOut]:uv.ZOOMOUT},this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleBlur()))}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new Jy({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class mv extends fh{constructor(e,t){super(!0),this.view=e,this.registerIncoming("mouse-wheel",t,(e=>this._handleMouseWheel(e)))}_handleMouseWheel(e){if(!this.view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new Ey({view:this.view,mode:"interaction"}):new Ny({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*t.deltaY,ue(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class gv{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let fv=class extends P_{constructor(e){super(e),this.view=null,this.beginCamera=new ql,this.elapsedTimeSec=0,this.constraintOptions={selection:Og.ALL,interactionType:Ag.PAN,interactionFactor:0,interactionStartCamera:new ql,interactionDirection:null,tiltMode:Mg.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ki}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),qf(this.view,t,this.constraintOptions)}};e([ve({constructOnly:!0})],fv.prototype,"view",void 0),fv=e([xe("esri.views.3d.state.controllers.momentum.MomentumController")],fv);let _v=class extends fv{constructor(e){super(e),this.interactionType=Ag.PAN,this.tmpPan=Oe()}momentumStep(e,t){const i=this.momentum.value(e);Ue(this.tmpPan,this.momentum.direction,i),t.eye=ze(yv,t.eye,this.tmpPan),t.center=ze(yv,t.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};e([ve({constructOnly:!0})],_v.prototype,"momentum",void 0),_v=e([xe("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],_v);const yv=Oe(),vv=Oe(),bv=Oe();let xv=class extends fv{constructor(e){super(e),this.interactionType=Ag.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);De(bv,t.eye),Fe(bv,bv),Ne(this.momentum.axis2,bv,this.momentum.axis1),ny(t,vv,this.momentum.axis1,i,this.momentum.axis2,r)}};e([ve({constructOnly:!0})],xv.prototype,"momentum",void 0),xv=e([xe("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],xv);let wv=class extends fv{constructor(e){super(e),this.interactionType=Ag.TUMBLE}set center(e){this._set("center",Xe(e))}set axis(e){this._set("axis",Xe(e))}momentumStep(e,t){const i=this.momentum.value(e);F_(t,this.center,zp(this.axis,i))}};e([ve({constructOnly:!0})],wv.prototype,"momentum",void 0),e([ve({constructOnly:!0})],wv.prototype,"center",null),e([ve({constructOnly:!0})],wv.prototype,"axis",null),wv=e([xe("esri.views.3d.state.controllers.momentum.MomentumController")],wv);let Tv=class extends fv{constructor(e){super(e),this.interactionType=Ag.ZOOM,this.constraintOptions.interactionDirection=Oe()}set zoomCenter(e){this._set("zoomCenter",Xe(e))}momentumStep(e,t){De(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);U_(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=He(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};e([ve({constructOnly:!0})],Tv.prototype,"momentum",void 0),e([ve({constructOnly:!0})],Tv.prototype,"zoomCenter",null),Tv=e([xe("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Tv);let Cv=class extends fv{constructor(e){super(e),this.interactionType=Ag.ZOOM,this.radius=0,this.tmpSceneCenter=Oe(),this.tmpZoomAxisAngle=Up(),this.sphere=eo()}set screenCenter(e){this._set("screenCenter",ue(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Xe(e))}initialize(){this.sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);z_(this.sphere,t,i),this.constraintOptions.interactionType=Ag.ZOOM,qf(this.view,t,this.constraintOptions),$_(this.sphere,t,this.screenCenter,this.tmpSceneCenter),jp(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),F_(t,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=Ag.PAN}};e([ve({constructOnly:!0})],Cv.prototype,"momentum",void 0),e([ve({constructOnly:!0})],Cv.prototype,"screenCenter",null),e([ve({constructOnly:!0})],Cv.prototype,"sceneCenter",null),e([ve({constructOnly:!0})],Cv.prototype,"radius",void 0),Cv=e([xe("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Cv);class Sv{constructor(e){this.gain=e}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}class Pv extends xh{constructor(e,t,i,r,s,a=0,n){super(e,t,i),this.angularVelocity1=r,this.axis1=s,this.angularVelocity2=a,this.axis2=n}value1(e){return super.valueFromInitialVelocity(this.angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class Rv{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.tmpAxis1=Oe(),this.tmpAxis2=Oe(),this.tmpAngles=Sr(),this.time=new bh(.3),this.screen=[new bh(.4),new bh(.4)],this.angle1=new Sv(.6),this.angle2=new Sv(.6),this.axis1=Oe(),this.axis2=Oe(),this.lastScene=Oe()}addMomentumDirectRotation(e,t,i,r,s,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;let e=iy(this.lastScene,t,this.tmpAxis2,r,s,a);this.angle2.update(0),Be(this.tmpAxis2)<1e-5?e=0:Fe(this.axis1,this.tmpAxis2),this.angle1.update(e),De(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,a,n){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;ay(this.lastScene,t,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,r,s,a,n,!1),Be(this.tmpAxis2)<1e-5?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),Fe(this.axis1,this.tmpAxis1),Fe(this.axis2,this.tmpAxis2)),De(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){const r=this.angle1.filteredValue/this.time.filteredDelta,s=this.angle2.filteredValue/this.time.filteredDelta;return new Pv(e,t,i,r,this.axis1,s,this.axis2)}}let Av=class extends ky{constructor(e){super(e),this.view=null,this.smoothRotation=new gv(.05),this.rotationAxis=Oe(),this.panningPlane=eh(),this.smoothScaling=new gv(.05),this.zoomCenterScreen=ue(),this.zoomMomentumEstimator=new wh,this.rotationMomentumEstimator=new Th,this.panSphericalMomentumEstimator=new Rv,this.panPlanarMomentumEstimator=new Ch,this.adjustedSphere=eo(),this.tmp3d=Oe(),this.tmpScreenPointArray=ue(),this.beginScreenPoint=ue(),this.beginScenePoint=Oe(),this.screenPickPoint=ue(),this.navMode=B_.Horizontal,this.tmpInteractionDirection=Oe(),this.constraintOptions={selection:Og.ALL,interactionType:Ag.NONE,interactionFactor:0,interactionStartCamera:new ql,interactionDirection:null,tiltMode:Mg.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-$l.normalize(Pe(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),pe(e.center,this.screenPickPoint),Tr(this.beginScreenPoint,this.screenPickPoint);const i=vr(this.view.spatialReference),r=Z_(this.intersectionHelper,this.startCamera,this.screenPickPoint,i,D_.Silhouette);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,De(this.beginScenePoint,this.scenePickPoint),this.navMode=X_(this.startCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===B_.Vertical&&this._preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}_preparePlanarPanMode(e){const t=$e(this.tmp3d,this.startCamera.viewForward);rh(this.scenePickPoint,t,this.panningPlane);const i=ue(this.screenPickPoint[0],0),r=Oe(),s=Ee(this.startCamera.eye);this.adjustedSphere[3]=s<this.sphere[3]?s-100:this.sphere[3],$_(this.adjustedSphere,this.startCamera,i,r);const a=me();this.startCamera.projectToRenderScreen(r,a);const n=.9*a[1];this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],n);const o=this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint);o&&rh(this.scenePickPoint,sh(this.panningPlane),this.panningPlane);const l=Oe(),h=Oe(),c=Oe();ze(l,this.scenePickPoint,this.currentCamera.eye);const d=Ee(l);Fe(l,l);const u=5*Math.max(Math.abs(this.view.camera.position.z),50),p=this.view._stage.renderView.getMinimalDepthForArea(null,this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,80);let m=p?Math.min(p,u):u;m=o?Math.min(m,d):m,De(c,Ge(h,this.currentCamera.eye,Ue(h,l,m))),this.panningPlane[3]=-je(this.panningPlane,c),this.startCamera.center=Ge(h,this.startCamera.eye,Ue(h,this.startCamera.viewForward,m));const g=pe(e.center,this.tmpScreenPointArray);V_(this.panningPlane,this.startCamera,g,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this.navMode===B_.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e))}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===B_.Horizontal?new Cv({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new Tv({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new wv({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===B_.Horizontal){const e=this.panSphericalMomentumEstimator.evaluateMomentum();if(e)return new xv({view:this.view,momentum:e})}else{const e=this.panPlanarMomentumEstimator.evaluateMomentum();if(e)return new _v({view:this.view,momentum:e})}return null}_zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),z_(this.sphere,this.currentCamera,this.smoothScaling.value),pe(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=Ag.ZOOM,this.constraintOptions.interactionFactor=Bf(e.radius-this.beginRadius),qf(this.view,this.currentCamera,this.constraintOptions)}_panningSpherical(e){const t=pe(e.center,this.tmpScreenPointArray);$_(this.sphere,this.currentCamera,t,this.tmp3d),oy(this.beginScenePoint,je(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(hy(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(ly(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=Ag.PAN,this.constraintOptions.interactionFactor=Bf(this.screenPickPoint,t),qf(this.view,this.currentCamera,this.constraintOptions)}_rotateSpherical(e){Fe(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||$e(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+N_(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*e.timestamp),F_(this.currentCamera,this.sphere,zp(this.rotationAxis,s)),this.constraintOptions.interactionType=Ag.TUMBLE,this.constraintOptions.interactionFactor=Bf(e.radius*i),qf(this.view,this.currentCamera,this.constraintOptions)}_panningPlanar(e){const t=pe(e.center,this.tmpScreenPointArray);V_(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(Y_(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=Ag.PAN,this.constraintOptions.interactionFactor=Bf(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),qf(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),U_(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=Ag.ZOOM,this.constraintOptions.interactionFactor=Bf(e.radius-this.beginRadius),qf(this.view,this.currentCamera,this.constraintOptions)}_rotatePlanar(e){De(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||$e(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=N_(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const a=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(a,.001*e.timestamp),F_(this.currentCamera,this.sphere,zp(this.rotationAxis,a)),this.constraintOptions.interactionType=Ag.TUMBLE,this.constraintOptions.interactionFactor=Bf(e.radius*a),qf(this.view,this.currentCamera,this.constraintOptions)}};e([ve({constructOnly:!0})],Av.prototype,"view",void 0),Av=e([xe("esri.views.3d.state.controllers.global.PinchAndPanController")],Av);const Ov=Ae(0,0,1),Mv=16/180*Math.PI;let Ev=class extends ky{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new gv(.05),this.scalingValueSmooth=new gv(.05),this.planeHorizontal=eh(),this.planeVertical=eh(),this.rotationMomentumEstimator=new Th,this.panMomentumEstimator=new Ch(300,12,.9),this.zoomMomentumEstimator=new wh,this.beginCenter=Oe(),this.tmpPoints=[],this.beginCenterScreen=ue(),this.tmpCentroid3d=Oe(),this.tmpCentroid2d=ue(),this.tmp2d=ue(),this.constraintOptions={selection:Og.ALL,interactionType:Ag.NONE,interactionFactor:0,interactionStartCamera:new ql,interactionDirection:null,tiltMode:Mg.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),pe(e.center,this.beginCenterScreen),ih(Ov,0,this.planeHorizontal);const i=Oe(),r=this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i),s=Oe();$e(s,this.startCamera.viewForward);const a=Oe();De(a,Ov);const n=je(s,a),o=Ze(n<0?-n:n);if(this.panMode=o>=Mv?B_.Horizontal:B_.Vertical,ah(this.planeHorizontal,this.planeHorizontal,i),this.startCamera.aboveGround||nh(this.planeHorizontal,this.planeHorizontal),this.panMode===B_.Vertical){Ue(a,a,n),ze(this.planeVertical,s,a),Fe(this.planeVertical,this.planeVertical),ah(this.planeVertical,this.planeVertical,i);const t=Oe(),o=Oe(),l=Oe();ze(t,i,this.currentCamera.eye);const h=Ee(t);Fe(t,t);const c=5*Math.max(Math.abs(this.view.camera.position.z),50),d=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,80);let u=d?Math.min(d,c):c;u=r?Math.min(u,h):u,De(l,Ge(o,this.currentCamera.eye,Ue(o,t,u))),this.planeVertical[3]=-je(this.planeVertical,l),this.computePlanePoints(e.pointers,this.planeVertical,this.startCamera,this.tmpPoints),k_(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),k_(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this.panMode===B_.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=i,this.scalingValueSmooth.update(t),U_(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=Ag.ZOOM,this.constraintOptions.interactionFactor=Bf(Math.abs(e.radius-this.beginRadius)),qf(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),k_(this.tmpPoints,this.tmpCentroid3d),pe(e.center,this.tmpCentroid2d),Y_(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=Ag.PAN,this.constraintOptions.interactionFactor=Bf(this.beginCenterScreen,this.tmpCentroid2d),qf(this.view,this.currentCamera,this.constraintOptions),t){const t=this.planeHorizontal,i=r,s=this.rotationValueSmooth.value,a=s+N_(e.angle-s),n=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=n,this.rotationValueSmooth.update(a);const o=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(o,.001*e.timestamp),F_(this.currentCamera,i,zp(t,o)),this.constraintOptions.interactionType=Ag.TUMBLE,this.constraintOptions.interactionFactor=Bf(Math.abs(e.radius*o)),qf(this.view,this.currentCamera,this.constraintOptions)}}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new Tv({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new wv({view:this.view,momentum:i,center:this.beginCenter,axis:sh(this.planeHorizontal)});const r=this.panMomentumEstimator.evaluateMomentum();return r?new _v({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const s=this.tmp2d;let a=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[a]&&(r[a]=Oe()),V_(t,i,s,r[a]),a+=1})),r}};e([ve({constructOnly:!0})],Ev.prototype,"view",void 0),Ev=e([xe("esri.views.3d.state.controllers.local.PinchAndPanController")],Ev);class Dv extends fh{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!Ai(e.data,this.pointerAction))return;const t=e.timestamp-this.lastEndTimestamp,i=this.momentum&&this.momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this.controller&&this.controller.active?e.data.timestamp-this.lastTimestamp>2&&(this.controller.update(e.data),this.lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this.controller&&this.controller.active){this.lastEndTimestamp=e.timestamp;const i=this.controller.end(e.data);t&&i&&(this.momentum=i,this.view.state.switchCameraController(this.momentum))}this.controller=null}_startController(e){this.controller=this._createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(e.data),this.lastTimestamp=e.timestamp}_createController(){return this.view.state.isGlobal?new Av({view:this.view}):new Ev({view:this.view})}}class Iv extends fh{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Lv extends fh{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class Nv extends Lv{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class Fv extends Lv{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class Vv extends fh{constructor(e,t=!1){super(!0),this.view=e,this.invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){const t=this.invert?-1:1,i=ue(0,e.data.delta*t);switch(e.data.action){case"begin":this.cameraController?.end(),this.cameraController=new qy({view:this.view,pivot:Gy.CENTER}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController?.update(i);break;case"end":this.cameraController?.end(),this.cameraController=null}}}class Uv extends fh{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new Di({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this.dragEventSeparator.handle(e)))}get failed(){return"failed"===this.state}_observeStart(e,t){1===e&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this.state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this.state&&2===e)return"active"===this.state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this.state="failed")}_observeEnd(e){"active"===this.state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,a=1/0;t.pointers.forEach((e=>{i=Math.max(i,e.x),r=Math.min(r,e.x),s=Math.max(s,e.y),a=Math.min(a,e.y)}));let n=-1/0,o=1/0,l=-1/0,h=1/0;e.pointers.forEach((e=>{n=Math.max(n,e.x),o=Math.min(o,e.x),l=Math.max(l,e.y),h=Math.min(h,e.y)}));const c=i-r,d=s-a,u=n-o,p=l-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-c)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let zv=class extends N{constructor(){super(...arguments),this._handles=new lr}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get hasPendingInputs(){return this._inputManager?.hasPendingInputs}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new Ii(this.view.surface,e.input);const t=[new Li,new Ni,new Fi,new Vi(this.view.navigation),new Uv],i=new _h({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Ui],yh.INTERNAL),this._modeDragPan=new Dv(e,"primary"),this._modeDragRotate=new Hy(e,"secondary",Gy.CENTER),this._modeDragZoom=new $y(e,"tertiary"),i.installHandlers("navigation",[new Iv(e),new jy(e),new dv(e),new pv(e,{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"}),new mv(e),new Fv(e,"p"),new Nv(e,"n"),new Hy(e,"primary",Gy.EYE,["b"]),new Hy(e,"secondary",Gy.CENTER,["b"]),new Dv(e,"tertiary",["b"]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Vv(e)],yh.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this._handles.add(K((()=>this.view.navigation?.browserTouchPanEnabled),(e=>{this._source.browserTouchPanningEnabled=!e}),$))}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=jv.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};e([ve()],zv.prototype,"view",void 0),e([ve({value:"pan"})],zv.prototype,"primaryDragAction",null),e([ve({value:"default"})],zv.prototype,"mode",null),e([ve({readOnly:!0})],zv.prototype,"hasPendingInputs",null),e([ve()],zv.prototype,"latestPointerType",null),e([ve()],zv.prototype,"latestPointerLocation",null),e([ve()],zv.prototype,"_inputManager",void 0),zv=e([xe("esri.views.3d.input.SceneInputManager")],zv);const jv=new Map,kv=new Map,Gv=new Map;kv.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),kv.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Gv.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Gv.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),jv.set("default",kv),jv.set("pro",Gv);const qv=zv;let Bv,Hv,Wv=!1,Qv=!1,Zv=!1,Xv=!1,Yv=null;function Kv(){Yv&&(Yv(),Yv=null)}function $v(e,t,i,r,s){Kv();const a=Bv.height,n=Hv;n.beginPath(),n.lineWidth=1,n.strokeStyle=s,n.moveTo(e,a-i),n.lineTo(t,a-i),n.stroke(),n.lineTo(t,a-r),n.stroke(),n.lineTo(t,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.closePath()}function Jv(e,t){Wv&&(t&&Zv||!t&&Xv)&&$v(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}const eb=Oe(),tb=hr(),ib=hr(),rb=Oe(),sb=zr(),ab=eo(),nb=sl(),ob=Oe(),lb=Vt();class hb{constructor(){this.aabr=Vt(),this.distance=0,this.culled=!1,this.visible=!1}}class cb{constructor(e,t,i={}){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info=i}}class db{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class ub{}class pb{constructor(){this.sortArray=new le({allocator:e=>e||new ub})}}var mb;!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(mb||(mb={}));class gb{constructor(){this.camera=new ql,this.slicePlane=ni(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),oi(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let fb=class extends N{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new gb,this._state=mb.Idle,this.graphics=new db,this.iterators=new pb,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==mb.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/mb.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case mb.Idle:this._startUpdate(),e.madeProgress();case mb.Process:if(this._state=mb.Process,!this._processActiveGraphics(e))return;case mb.Sort:if(this._state=mb.Sort,!this._sortVisibleGraphics(e))return;case mb.Deconflict:if(this._state=mb.Deconflict,!this._deconflictVisibleGraphics(e))return;default:!function(e,t){if(!Qv||!Hv)return;Kv();const i=Hv;let r=0;for(let t=0;t<e.accBinsNumX;t++)for(let s=0;s<e.accBinsNumY;s++){const a=e.accBins[t][e.accBinsNumY-1-s];r+=a.length;const n=t*e.accBinsSizeX,o=(t+1)*e.accBinsSizeX,l=s*e.accBinsSizeY,h=(s+1)*e.accBinsSizeY;i.fillText(a.length.toFixed(),n+5,l+15),$v(n,o,l,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}(this,this.graphics.visible),this._state=mb.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){if(z(e)||"object3d"!==e.type)return!1;const t=e.stageObject;return 1===(t?t.geometryRecords.length:0)&&t.geometryRecords[0].material instanceof Wo}_startUpdate(){var e;e=this.view,Zv=fa.DECONFLICTOR_SHOW_VISIBLE,Xv=fa.DECONFLICTOR_SHOW_INVISIBLE,Wv=Zv||Xv,Qv=fa.DECONFLICTOR_SHOW_GRID,Yv=null,Wv||Qv?Yv=()=>function(e){null==Bv&&(Bv=document.createElement("canvas"),Bv.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Bv));const{state:t}=e,{camera:i,pixelRatio:r}=t,{width:s,height:a}=i,n=s*r,o=a*r;Bv.setAttribute("width",`${n}px`),Bv.setAttribute("height",`${o}px`),Bv.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${a}px`),Hv=Bv.getContext("2d"),Hv.clearRect(0,0,s,a),Hv.font="12px Arial"}(e):Bv&&(Bv.parentElement.removeChild(Bv),Bv=null),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:i}=this._runningViewState.camera;this._initBins(t,i),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new hb,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._removeFromVisibleGraphics(e),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(ol.DECONFLICTION,t)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}_removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=Ar(sb,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?ab:null;let s=0;for(U(r)&&(Qe(r,Je,this._runningViewState.camera.viewMatrix),r[3]=vr(this.view.spatialReference).radius,s=to(r,Je));!e.done;){e.madeProgress();const a=t.next();if(!0===a.done)return this._resetActiveGraphicsIterator(),!0;const n=a.value,o=n&&n.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(n,i,r,s),o.culled?this._removeFromVisibleGraphics(n):this._addToVisibleGraphics(n))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),!0===i.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===nl.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(!0===r.done)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,a=s.info[this.visibilityGroup];if(!a||a.culled)continue;const n=s.graphics3DGraphic,o=(!i||n.isVisible())&&!this._isConflicted(s);o&&this._addToBins(s),a.visible=o,this._setGraphicVisibility(s,o),Jv(a,o)}return!1}_resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}_ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=_b(this.graphics.active)),this.iterators.active}_resetActiveGraphicsIterator(){this.iterators.active=null}_ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=_b(this.graphics.visible)),this.iterators.visible}_resetVisibleGraphicsIterator(){this.iterators.visible=null}_ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,r)=>{const s=t.pushNew();s.id=r,s.prio=e.info?-e.info[i].distance:Number.MAX_VALUE})),yield;const r=t.iterableSort(((e,t)=>t.prio-e.prio));for(let e=r.next();!e.done;e=r.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}_resetSortGraphicsIterator(){this.iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const a=e.info[this.visibilityGroup];if(!s.isVisible(nl.GRAPHIC,ol.DECONFLICTION))return void(a.culled=!0);const n=this.getGraphicsLayers(s);Ut(a.aabr);let o=null;for(const s of n){if(!this.layerSupportsDeconfliction(s))continue;const n=s.stageObject.geometryRecords[0].material;if(z(o)){if(o=this._getProjectionInfo(s,t,vb),o.isOutsideScreen||this._isCulledBySlice(e,eb)||U(i)&&this._isCulledByHorizon(o,i,r))return void(a.culled=!0);!fa.TESTS_DISABLE_OPTIMIZATIONS&&a.visible&&(o.distance*=.7)}this._expandBoundingRect(a,s,n,o)}z(o)?a.culled=!0:(a.distance=o.distance,a.culled=!1)}_getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,a=s.geometryRecords[0],n=a.material,o=io(s.boundingVolumeWorldSpace.bounds);Qe(eb,o,r.viewMatrix);const l=a.geometry.vertexAttributes,h=l.get(yn.NORMAL).data,c=l.get(yn.AUXPOS1).data;return n.applyShaderOffsetsView(eb,h,s.transformation,c,r,i.scaleInfo,eb),et(tb,eb[0],eb[1],eb[2],1),tt(ib,tb,r.projectionMatrix),Ue(i.positionNDC,ib,1/ib[3]),n.applyShaderOffsetsNDC(i.positionNDC,c,r,i.positionNDC,rb),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(rb[2]),i.distance=rb[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),et(ib,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),tt(tb,ib,t),it(tb,tb,1/tb[3]),Me(i.positionView,eb[0],eb[1],eb[2]),i}_isCulledByHorizon(e,t,i){return De(nb.direction,e.positionView),Me(nb.origin,0,0,0),!!Xn(t,nb,ob)&&e.distanceWithoutPolygonOffset>i}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&ai(this._runningViewState.slicePlane,t)}_expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const a=this._runningViewState.camera,n=t.getScreenSize(yb);ln(n,s.factor,n),n[0]*=a.pixelRatio,n[1]*=a.pixelRatio;const o=zt(i.calculateRelativeScreenBounds(n,s.factorAlignment.scale,lb),Ie(0,a.fullWidth,.5+.5*r[0]),Ie(0,a.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(0!==l){const e=l*Math.min(jt(o),kt(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}Gt(e.aabr,o,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let e=Math.floor(i.aabr[0]/this.accBinsSizeX);e<=Math.floor(i.aabr[2]/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(let r=Math.floor(i.aabr[1]/this.accBinsSizeY);r<=Math.floor(i.aabr[3]/this.accBinsSizeY);r++){if(r<0||r>=this.accBinsNumY)continue;const s=this.accBins[e][r];for(let e=0;e<s.length;e++){const r=s.data[e],a=r.info[this.visibilityGroup];if(a&&a.visible&&r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,qt(a.aabr,i.aabr)))return!0}}return!1}_initBins(e,t){if(null==this.accBins){this.accBins=[];for(let e=0;e<this.accBinsNumX;e++){this.accBins.push([]);const e=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)e.push(new le)}}else for(let e=0;e<this.accBinsNumX;e++)for(let t=0;t<this.accBinsNumY;t++)this.accBins[e][t].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),s=Math.floor(t.aabr[1]/this.accBinsSizeY),a=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let t=i;t<=r;t++)if(!(t<0||t>=this.accBinsNumX))for(let i=s;i<=a;i++)i<0||i>=this.accBinsNumY||this.accBins[t][i].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(ol.DECONFLICTION,t,this.visibilityGroup),this.visibilityGroup===nl.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*_b(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}e([ve({constructOnly:!0})],fb.prototype,"view",void 0),e([ve({type:Boolean,readOnly:!0})],fb.prototype,"updating",null),fb=e([xe("esri.views.3d.layers.graphics.Deconflictor")],fb);const yb=Sr(),vb=new class{constructor(){this.positionView=Oe(),this.positionNDC=Oe(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let bb=class extends fb{constructor(){super(...arguments),this.visibilityGroup=nl.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return;const t=performance.now();(e.state===Po.IDLE||t-this._lastDeconfliction>2e3)&&(super.runTask(e),this.state===mb.Idle&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};e([ve({constructOnly:!0})],bb.prototype,"parent",void 0),bb=e([xe("esri.views.3d.layers.graphics.LabelDeconflictor")],bb);let xb=class extends fb{constructor(){super(...arguments),this._handles=new lr,this._contexts=new Map,this._viewState=new gb,this.visibilityGroup=nl.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([K((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),K((()=>this.view?.map?.ground?.opacity),((e,t)=>{1!==e&&1!==t||this.setDirty()})),K((()=>this.view?.slicePlane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),$)]),this._frameTask=this.view.resourceController.scheduler.registerTask(So.GRAPHICS_DECONFLICTOR,this),this._labels=new bb({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&wb(e));t.setVisibilityFlag(ol.DECONFLICTION,i,nl.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;U(e)&&li(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=U(e)}_slicePlaneChanged(){Te(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new cb(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),wb(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=wb(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(ol.DECONFLICTION)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e.graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.graphics;if(!t||!t.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}};function wb(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function Tb(e){return e instanceof ll?e.graphics3DSymbol:e instanceof hl?e:null}xb=e([xe("esri.views.3d.layers.graphics.GraphicsDeconflictor")],xb);const Cb=V.getLogger("esri.views.3d.layers.graphics.labelPlacement");function Sb(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=Tb(r.graphics3DSymbol),a=Q(s,(e=>"point-3d"===e.symbol.type?e.symbol:null)),n=Eb[t]||Ab(e);return U(a)&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Mb(a.verticalOffset),anchor:null,normalizedOffset:null}:i&&i.hasVisibleVerticalOffset()&&(z(a)||!a.supportsCallout()||!a.verticalOffset||r.isDraped)?"above-center"===n.placement?{placement:"above-center",verticalOffset:Mb(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(Cb.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}(e);if(z(t))return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Eb[i],s=r||Ab(e);return i&&!r&&Cb.warnOncePerTick(`the requested label placement '${i}' is currently unsupported in SceneView.`),function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(z(i))return null;if(U(t.disablePlacement))return t.labelClass.labelPlacement?(Cb.warnOncePerTick(Rb(e.placement,t.disablePlacement.logEntityDescription)),Ab(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return Cb.warnOncePerTick(Rb(e.placement,`'${r}' geometries`)),Ab(t);break;case"point":case"mesh":return e}return e}(s,e)}(e,t);if(z(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return function(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(z(r))return null;switch(r.type){case"point":!function(e,t,i){const r=Pb(i);if(z(r))return;const s=i.graphics3DGraphic.graphics[0];switch(U(s)?s.getCenterObjectSpace(e.translation):Me(e.translation,0,0,0),r.type){case"icon":case"text":!function(e,t,i,r){const{graphics3DGraphic:s}=i,a=U(r)?r.getScreenSize():null;if(!s.isDraped&&U(a)){const r=function(e,t=Lb){const{graphics3DGraphic:i}=e,r=i.graphics[0],s=U(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof Wo){const e=s.parameters.anchorPosition;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(i);Ib[0]=a[0]/2*(t.normalizedOffset[0]-r[0]),Ib[1]=a[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=Ib[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=Ib[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=Ib[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(Eb[i.labelClass.labelPlacement]&&Cb.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}(e,t,i,s);break;case"object":Ob(e,t,s)}}(e,t,i);break;case"polygon":!function(e,t,i){const r=Pb(i);if(!z(r))switch(r.type){case"extrude":{const r=i.graphics3DGraphic.graphics[0];U(r)?(r.getBoundingBoxObjectSpace(Nb),Dh(Nb,e.translation),e.translation[2]=Ih(Nb)/2):Me(e.translation,0,0,0),Ob(e,t,r);break}}}(e,t,i);break;case"mesh":Ob(e,t,i.graphics3DGraphic.graphics[0])}return e}({anchor:r,verticalOffset:t.verticalOffset,screenOffset:Sr(),centerOffset:cr(0,0,0,-1),centerOffsetUnits:"world",translation:Oe(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function Pb(e){const t=Tb(e.graphics3DGraphic.graphics3DSymbol);return U(t)?t.symbol.symbolLayers.getItemAt(0):null}function Rb(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function Ab(e){const t=e.graphics3DGraphic.graphic.geometry;if(z(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=Pb(e);return U(t)&&"extrude"===t.type?Eb["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Eb["above-center"];default:return}}function Ob(e,t,i){const r=U(i)?i.getBoundingBoxObjectSpace(Nb):Nb,s=Ae(r[3]-r[0],r[4]-r[1],r[5]-r[2]),a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];const n=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=n+o;const l=Ee(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function Mb(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Eb={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Db={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in Db){const t=Db[e],i=Eb[e];t.forEach((e=>{Eb[e]=i}))}Object.freeze&&(Object.freeze(Eb),Object.keys(Eb).forEach((e=>{Object.freeze(Eb[e]),Object.freeze(Eb[e].normalizedOffset)})));const Ib=[0,0],Lb=[0,0],Nb=Eh();class Fb{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}let Vb=class extends N{constructor(e){super(e),this.type=hn.Texture,this.id=Uh(),this.events=new or,this._glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this._create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=B(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,flipped:!0,samplingMode:Rn.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return U(this._glTexture)||(this._glTexture=new jo(e,this._createDescriptor(e),this.canvas),this.frameWorker=this.view.resourceController.scheduler.registerTask(So.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=j(this.frameWorker),this._glTexture&&(this.stage.remove(this),this._glTexture=B(this._glTexture)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",512..toString()),e.setAttribute("height",512..toString()),e}_update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}_createAtlasRegion(e=512){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=rt(i),i=Math.min(i,4096),i}_resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,U(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this.atlas;e.cursor.x=Ub,e.cursor.y=Ub+zb,e.lineHeight=0,this.needsClear=!0}_getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this._getAtlasUsage()/i*(i+t-e)}_addAtlasElement(e,t,i,r){const s=this.atlas,{renderedWidth:a,renderedHeight:n,displayWidth:o,displayHeight:l}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,e.placement.size.width=a,e.placement.size.height=n,e.placement.size.displayWidth=o,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/s.size.width,1-(e.placement.offset.y+n)/s.size.height,(e.placement.offset.x+a)/s.size.width,1-e.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(t,e)}_removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}_ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].vertexAttributes.get(yn.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometryRecords[0]))}_processAddition(e,t){const i=this.atlas,r=e.textId,s=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,n=s+Ub,o=a+Ub+zb;if(i.cursor.x+n<i.size.width&&i.cursor.y+o<i.size.height)this._addAtlasElement(e,r,n,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+o+i.lineHeight<i.size.height)){const e=this._getExpectedAtlasUsage(),r=e>.85&&i.size.width<4096;return r&&this._resizeAtlas(2*i.size.width,2*i.size.height),!t||!r&&e>.95&&4096===i.size.width?(this._processRemovals(),jb.OK):(this._repack(),jb.REPACK)}i.cursor.x=Ub,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,r,n,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return jb.OK}_processRemovals(){this.elementsToRemove.forEach(((e,t)=>{const i=this.stageObjects.get(t);i&&0!==i.size||this._removeAtlasElement(e),i&&0===i.size&&this.stageObjects.delete(t)})),this.elementsToRemove.clear()}_repack(){this._processRemovals(),this.elements.forEach(((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)})),this.elements.clear(),this._resetAtlasCursor(),this.elementsToRender.clear()}_processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].vertexAttributes.get(yn.UV0).data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get(yn.SIZE).data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(t.geometryRecords[0])})),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(!this._glTexture)return;let i=!1;if(Te(this.elementsToAddOrUpdate,((e,r)=>{const s=this.elements.get(r);if(s&&s.rendered){const e=this.stageObjects.get(r);return e&&e.forEach((e=>{const t=e.geometries[0].vertexAttributes,i=this.elements.get(r);t.get(yn.UV0).data=new Float32Array(i.placement.uvMinMax),t.get(yn.SIZE).data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(e.geometryRecords[0])})),this.elementsToAddOrUpdate.delete(r),!1}return this._processAddition(this.elementsToAddOrUpdate.get(r),t)===jb.REPACK&&(i=!0,!0)})),i)return void this.runTask(Ro,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),Te(this.elementsToRender,((t,i)=>(this._processRenderingRequest(t),this.elementsToRender.delete(i),r=!0,e.madeProgress(),e.done))),r&&U(this._glTexture)&&this._glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&_a.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this._addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this._removeStageObject(i,t)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(0===this.elements.size)return;const e=[];this.elements.forEach(((t,i)=>e.push({element:t,key:i})));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this.elements.clear();for(const{element:t,key:i}of e)this.elements.set(i,t);this._repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,_resizeAtlas:(e,t)=>s._resizeAtlas(e,t),run:(e,t)=>s.runTask(e,t)}}};e([ve({constructOnly:!0})],Vb.prototype,"view",void 0),e([ve({type:Boolean})],Vb.prototype,"updating",void 0),Vb=e([xe("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Vb);const Ub=2,zb=2;var jb;!function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"}(jb||(jb={}));const kb=V.getLogger("esri.views.3d.layers.graphics.Labeler");let Gb=class extends N{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new lr,this._handles.add([K((()=>this.view.state?.camera),(()=>this.setDirty())),K((()=>this.view.state?.pixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(So.LABELER,this)]),this._textTextureAtlas=new Vb({view:this.view}),this._hudMaterialCollection=new Fb(this.view._stage),this._calloutMaterialCollection=new Fb(this.view._stage)}dispose(){this._handles=k(this._handles),this._textTextureAtlas=B(this._textTextureAtlas),this._hudMaterialCollection=B(this._hudMaterialCollection),this._calloutMaterialCollection=B(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(ol.USER_SETTING,!0,nl.LABEL)})),e.active=!0}_deactivateLabelingContext(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(ol.USER_SETTING,!1,nl.LABEL),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];U(i)&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];U(i)&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}get running(){return this.view.ready&&(this._dirty||this._textTextureAtlas?.updating||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(qb(t)){if(!Hb(t)){if(Wb(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),Bb(t)){this._dirty=!0;continue}if(!Hb(t))continue}Te(t.labelsToInitialize,((i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textTextureResources.initialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),p(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter((e=>!!e.symbol));if(!s||0===s.length)return;const a=new Array(s.length);let n=!1;await Rh(s,(async(r,s)=>{const o=r.symbol,l=Tb(i.getOrCreateGraphics3DSymbol(o));if(z(l))return void kb.error("Failed to create Graphics3DSymbol for label");await l.load(),p(t);let h=null;Mh(o)&&o.hasVisibleCallout()&&(h=fl(o,i.symbolCreationContext),await h.load(),p(t));const c=await Ah(Oh(r,e.layer.fieldsIndex,this.view.spatialReference));if(p(t),!0===c.ok){const e=await this._createTextRenderParameters(l.symbol);p(t),a[s]={labelClass:r,labelFunction:c.value,graphics3DSymbol:l,graphics3DCalloutSymbolLayer:h,calloutSymbolLayerIndex:0,textRenderParameters:e}}else kb.error(`Label expression failed to evaluate: ${c.error}`),n=!0})),p(t),n||(e.labelClassContexts=a)}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(u(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?cl.fromSymbol(t,this.view.state.pixelRatio):null}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced,t.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s){const a={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,centerOffsetUnits:i.centerOffsetUnits,horizontalPlacement:dl(i.anchor),verticalPlacement:ul(i.anchor),verticalOffset:i.verticalOffset,debugDrawLabelBorder:fa.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return Qb.graphic=t,Qb.renderingInfo=null,Qb.layer=r,s.createLabel(Qb,a,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,i,r,s){const a={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return Qb.graphic=e,Qb.renderingInfo=a,Qb.layer=s,i.createGraphics3DGraphic(Qb)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const{textTextureResources:i}=e,r=e.labelingContext,s=r.labelClassContexts;if(!s||0===s.length||!r.emptySymbolLabelSupported&&0===t.graphics.length)return!1;let a=!1;const n=t.graphic,o=r.layer,l=fi(r.layer),h=this.view._stage;for(let e=0;e<s.length;e++){const c=i.textRenderers[e],d=i.labelPlacements[e];if(z(c)||z(d))continue;const u=s[e],p=u.graphics3DSymbol,m=p.symbol&&"label-3d"===p.symbol.type?p.symbol:null,g=p.symbolLayers[0];if(!g)continue;g.setElevationInfoOverride(r.elevationInfoOverride);const f=this._createTextSymbolGraphic(c,n,d,o,g);if(!f)return!1;f._labelClass=u.labelClass,f._labelIndex=e,t.addLabelGraphic(f,h,r.stageLayer),t.setVisibilityFlag(ol.USER_SETTING,l,nl.LABEL),t.clearVisibilityFlag(ol.SCALE_RANGE,nl.LABEL),t.setVisibilityFlag(ol.DECONFLICTION,!1,nl.LABEL),a=!0;const _=u.graphics3DCalloutSymbolLayer;if(_&&d.hasLabelVerticalOffset){_.setElevationInfoOverride(r.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,m,_,d,o);U(e)&&(u.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,h,r.stageLayer))}break}return r.scaleVisibility&&a&&r.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){const{textTextureResources:t}=e;if(t.initialized)return;const i=e.labelingContext,r=i.labelClassContexts;if(!r||0===r.length)return;const s=e.graphics3DGraphic.graphic;for(let a=0;a<r.length;a++){const n=r[a];if(t.textRenderers[a]=null,t.labelPlacements[a]=null,!n.textRenderParameters)continue;const o=n.labelFunction;let l;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?$a(s,i.layer):s;l=o.evaluate(e)}catch(e){l=null}else l=o.evaluate(s);if(z(l)||""===l||/^\s+$/.test(l))continue;const h=n.graphics3DSymbol,c=h.symbol&&"label-3d"===h.symbol.type?h.symbol:null;if(!h.symbolLayers[0])continue;const d=Sb({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:c,labelClass:n.labelClass,disablePlacement:i.disablePlacement});if(z(d))continue;const u=dl(d.anchor),p=pl(u);t.textRenderers[a]=new ml(l,p,n.textRenderParameters),t.labelPlacements[a]=d}t.initialized=!0}_destroyTextTextureResources(e){const{textTextureResources:t}=e;t.initialized=!1,t.textRenderers=[],t.labelPlacements=[]}_addGraphic(e,t){const i={hasGraphics3DResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextureResources:{initialized:!1,textRenderers:[],labelPlacements:[]}},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this._destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textTextureResources.initialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.labels.get(i);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;r.set(t.graphic.uid,t)}));const s=e=>e.labelGraphics[0];if(Z(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.labels.forEach(((t,i)=>{this._destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,a=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const n=e.layer,o={graphics3DCore:e,layer:n,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:a,active:n.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new Ja({isPickable:!0},n.uid)};return this.view._stage.add(o.stageLayer),this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>fi(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.textTextureResources.initialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>Bb(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(Bb(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function qb(e){return e.active&&fi(e.layer)}function Bb(e){return e.labelClassPromise&&!!e.labelClassAbortController}function Hb(e){return e.labelClassContexts&&e.labelClassContexts.length}function Wb(e){return null===e.labelClassContexts}e([ve({constructOnly:!0})],Gb.prototype,"view",void 0),e([ve({constructOnly:!0})],Gb.prototype,"deconflictor",void 0),e([ve()],Gb.prototype,"_textTextureAtlas",void 0),e([ve({type:Boolean,readOnly:!0})],Gb.prototype,"updating",null),Gb=e([xe("esri.views.3d.layers.graphics.Labeler")],Gb);const Qb=new gl(null,null,null);class Zb{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new lr}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`;return this._fromCache(this.gltfCache,r,(t=>kh(new Gh(t.streamDataRequester),e,t,i)),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`;return this._fromCache(this.wosrCache,i,(t=>qh(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}_fromCache(e,t,i,r){return new Promise(((s,a)=>{if(d(r))return void a(h());const n=g(r,(()=>{this._remove(e,t),a(h())})),o=e.get(t);if(o)return this.evictHandles.remove(t),o.refCount++,void o.item.then(s,a);const l=new AbortController,c={...r,signal:l.signal},u={refCount:1,abortController:l,item:i(c).then((i=>(u.abortController=null,i.remove=()=>this._remove(e,t),i)))};e.set(t,u),u.item.then((e=>{U(n)&&n.remove(),s(e)}),(e=>{U(n)&&n.remove(),a(e)}))}))}_remove(e,t){const i=e.get(t);i&&(i.refCount--,0===i.refCount&&this.evictHandles.add(v((()=>{e.delete(t),U(i.abortController)&&i.abortController.abort()}),Xb),t))}}let Xb=1e4;class Yb{constructor(e){this.renderCoordsHelper=e,this.frustum=ac(),this._points=nc(),this.lines=new Array(12),this._origin=Oe(),this._direction=Oe(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:Oe(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(e){oc(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),De(this._origin,e.eye),De(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)De(this._points[t],e[t]);lc(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return hc(this.frustum,e)}intersectsRay(e){return cc(this.frustum,e)}intersectsLineSegment(e,t){return dc(this.frustum,e,t)}intersectsPoint(e){return uc(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;Kb(this.lines[t],e[t],e[i]),Kb(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),Kb(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}}function Kb(e,t,i){e.origin=t,e.endpoint=i,He(e.direction,t,i)}Yb.planePointIndices=pc,Yb.nearFarLineIndices=[[sc.NEAR_BOTTOM_LEFT,sc.FAR_BOTTOM_LEFT],[sc.NEAR_BOTTOM_RIGHT,sc.FAR_BOTTOM_RIGHT],[sc.NEAR_TOP_RIGHT,sc.FAR_TOP_RIGHT],[sc.NEAR_TOP_LEFT,sc.FAR_TOP_LEFT]];class $b{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new Yb(e),this.extendedFrustum=new Yb(e),this.intersector=new _l({renderCoordsHelper:e}),this.renderCoordsHelper=e}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this._shortenFrustumFarPlane(this.frustum),this._updateExtendedFrustum(e)}end(){this.cache.clear()}calculate(e){if(this.allTilesInvisible)return rc.INVISIBLE;const t=this.renderCoordsHelper.viewingMode===Gi.Global&&e.lij[0]>=Jb&&e.lij[0]<ex,i=this._getOrCalculateSingleTileVisibility(e,!t);return i!==rc.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):i}_shortenFrustumFarPlane(e){const t=Yb.nearFarLineIndices,i=e.mutablePoints;for(const e of t){const[t,r]=e,s=i[t],a=i[r];ze(sx,a,s),Ue(sx,sx,ix),Ge(i[r],s,sx)}e.updatePoints(i)}_calculateAggregatedChildrenVisibility(e){let t=rc.INVISIBLE;const i=this.cache.get(e.id);if(null!=i)return i;const r=ox.acquire();e.getChildren(r);for(const e of r){const i=this.calculate(e);if(i!==rc.INVISIBLE&&(t=i,i===rc.VISIBLE_ON_SURFACE))break}return ox.release(r),this.cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const r=this._calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,r),r}_calculateSingleTileVisibility(e){return!this.aboveGround&&this.renderCoordsHelper.viewingMode===Gi.Global&&e.lij[0]<tx?this._calculateSingleTileVisibilitySided(e,!1)===rc.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this.aboveGround)}_calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=vr(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?rc.VISIBLE_ON_SURFACE:rc.VISIBLE_WHEN_EXTENDED:rc.INVISIBLE}_updateExtendedFrustum(e){this.extendedFrustum.update(e),this._shortenFrustumFarPlane(this.extendedFrustum);const t=this.renderCoordsHelper.worldUpAtPosition(e.eye,sx);this.aboveGround||$e(t,t);const i=We(-je(t,e.viewForward));if(this.allTilesInvisible=i>(Math.PI+e.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=i>e.fovY/2,!this.hasExtendedFrustum)return;const r=this._extendedFrustumParameters(),s=this.extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=r.pointIndices[e],i=s[t],a=this.renderCoordsHelper.getAltitude(i);if(r.needsAltitudeAdjustment(a)){switch(this.renderCoordsHelper.worldUpAtPosition(i,sx),t){case sc.FAR_BOTTOM_LEFT:case sc.FAR_TOP_LEFT:case sc.NEAR_BOTTOM_LEFT:case sc.NEAR_TOP_LEFT:oh(this.extendedFrustum.planes[mc.LEFT],sx,sx);break;case sc.FAR_BOTTOM_RIGHT:case sc.FAR_TOP_RIGHT:case sc.NEAR_BOTTOM_RIGHT:case sc.NEAR_TOP_RIGHT:oh(this.extendedFrustum.planes[mc.RIGHT],sx,sx)}Ue(sx,sx,r.direction),this.renderCoordsHelper.intersectInfiniteManifold(rl(i,sx),r.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(s),lh(s[sc.NEAR_BOTTOM_LEFT],s[sc.NEAR_BOTTOM_RIGHT],s[sc.NEAR_TOP_RIGHT],ax),lh(s[sc.NEAR_BOTTOM_RIGHT],s[sc.NEAR_TOP_RIGHT],s[sc.NEAR_TOP_LEFT],nx),je(sh(ax),sh(nx))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[sc.NEAR_BOTTOM_LEFT],e[sc.NEAR_BOTTOM_RIGHT]]=[e[sc.NEAR_BOTTOM_RIGHT],e[sc.NEAR_BOTTOM_LEFT]]:[e[sc.NEAR_TOP_LEFT],e[sc.NEAR_TOP_RIGHT]]=[e[sc.NEAR_TOP_RIGHT],e[sc.NEAR_TOP_LEFT]],this.extendedFrustum.updatePoints(e)}}_extendedFrustumParameters(){return this.aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-rx;return{zWithMargin:e,pointIndices:Yb.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+rx;return{zWithMargin:e,pointIndices:Yb.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const Jb=2,ex=6,tx=12,ix=.95,rx=1,sx=Oe(),ax=eh(),nx=eh(),ox=new vc(Array,(e=>{4!==e.length&&(e[0]=new ic,e[1]=new ic,e[2]=new ic,e[3]=new ic)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));class lx{constructor(e){this.camera=new ql,this.focusOnMap=[0,0],this.screenRect=Vt(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new $b(e.renderCoordsHelper)}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,Bt(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)}end(){this.visibility.end()}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=Ht(e.extent,this.focusOnMap),e.measures.visibility!==rc.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=cx,i=1<<t,r=e.measures.screenRect;Ut(r);let s=0;const a=e.lij[0]+t,n=e.lij[1]<<t,o=e.lij[2]<<t,l=this._tileSizeWithBias(e),h=l*l;for(let t=0;t<i;t++)for(let l=0;l<i;l++)if(s+=this._computeScreenArea(e,a,n+t,o+l,r),s>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===rc.VISIBLE_WHEN_EXTENDED?this.tileSize*dx:this.tileSize}_computeScreenArea(e,t,i,r,s){const a=e.measures.visibility===rc.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,i,r,a,ux),Ut(hx);for(let e=0;e<4;e++)Wt(hx,ux[e]);return Gt(s,hx,s),yc(ux[0],ux[1],ux[2])+yc(ux[0],ux[2],ux[3])}_projectToScreen(e,t,i,r,s){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,px),this._toRenderCoords(px,0,3,gx[0]),this._toRenderCoords(px,2,3,gx[1]),this._toRenderCoords(px,2,1,gx[2]),this._toRenderCoords(px,0,1,gx[3]),r&&(this._projectToPlane(gx,this.camera.frustum[mc.NEAR]),this._projectToPlane(gx,this.camera.frustum[mc.TOP]),this._projectToPlane(gx,this.camera.frustum[mc.BOTTOM]));for(let e=0;e<4;e++)this.camera.projectToRenderScreen(gx[e],_x),this.camera.renderToScreen(_x,s[e])}_projectToPlane(e,t){for(let i=0;i<4;i++)fx[i]=hh(t,e[i]);const i=Math.max(fx[0],fx[1],fx[2],fx[3]);if(i>0){const r=Ue(mx,sh(t),-i);for(let t=0;t<4;t++)Ge(e[t],e[t],r)}}_toRenderCoords(e,t,i,r){return mx[0]=e[t],mx[1]=e[i],mx[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(mx,this.tilingScheme.spatialReference,r),r}}const hx=Vt(),cx=2,dx=5,ux=[ue(),ue(),ue(),ue()],px=Vt(),mx=Oe(),gx=[Oe(),Oe(),Oe(),Oe()],fx=[0,0,0,0],_x=me(),yx=V.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let vx=class extends N{constructor(e){super(e),this.tiles=new s,this.tileSize=512,this._idToTile=new Map,this._handles=new lr,this._clients=new Set,this._dirty=!1,this._newTiles=new le}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(U(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void yx.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||U(t)&&e&&t.equals(e))return;const i=U(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(z(this.filterExtent)||!this.tilingScheme)return null;const e=Vt();return yl(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add([K((()=>[this.tilingScheme,this.tileSize]),(()=>this._reset()),te),K((()=>[this.tileSize,this.cameraOnSurface?.location,this.tilingScheme,this.viewState?.contentCamera,this.focus?.location]),(()=>this._setDirty()),J)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(So.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=j(this._frameWorker),this._handles=k(this._handles)}addClient(){const e=bx++;return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Ro))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),U(this._frameWorker)&&(this._frameWorker.priority=So.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&U(this._frameWorker)&&(this._frameWorker.priority=So.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new lx({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map((e=>new ic(e[0],e[1],e[2],this.tilingScheme)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])})),Ut(xx);for(let t=0;t<e.length;t++)if(Gt(xx,e.data[t].measures.screenRect,xx),kt(xx)>wx)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!qt(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),t.measures.visibility!==rc.INVISIBLE&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const e of this.tiles.items)e.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===rc.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};e([ve({constructOnly:!0})],vx.prototype,"scheduler",void 0),e([ve({constructOnly:!0})],vx.prototype,"renderCoordsHelper",void 0),e([ve({constructOnly:!0})],vx.prototype,"tilingSchemeOwner",void 0),e([ve({constructOnly:!0})],vx.prototype,"cameraOnSurface",void 0),e([ve({constructOnly:!0})],vx.prototype,"focus",void 0),e([ve({constructOnly:!0})],vx.prototype,"viewState",void 0),e([ve({constructOnly:!0})],vx.prototype,"terrain",void 0),e([ve()],vx.prototype,"tiles",void 0),e([ve()],vx.prototype,"tileSize",void 0),e([ve({readOnly:!0})],vx.prototype,"tilingScheme",null),e([ve()],vx.prototype,"filterExtent",null),e([ve({readOnly:!0})],vx.prototype,"filterExtentRect",null),e([ve({readOnly:!0})],vx.prototype,"rootTileIds",null),e([ve({value:!1})],vx.prototype,"suspended",null),e([ve({readOnly:!0})],vx.prototype,"updating",null),vx=e([xe("esri.views.3d.layers.support.FeatureTileTree3D")],vx);let bx=0;const xx=Vt(),wx=10;let Tx=class extends N{constructor(){super(...arguments),this._propertiesPool=new vh({camera:ql},this),this._lastSeenCameraProjectionValues=new ql,this.events=new or,this.viewingMode=Gi.Global,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new pp({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new vh({camera:ql},this)}createInitialCamera(){if(this.viewingMode===Gi.Global){const e=vr(this.spatialReference).radius;this.camera=new ql(Ae(4*e,0,0),Ae(e,0,0),Ae(0,0,1))}else this.camera=new ql(Ae(0,0,100),Ae(0,0,0),Ae(0,1,0))}get animation(){return this.cameraController instanceof P_&&U(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==Sx&&Sx.copyFrom(e),Sx.computeUp(this.viewingMode),Px.camera=Sx,this.events.emit("before-camera-change",Px);const t=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Sx)&&(this._lastSeenCameraProjectionValues.copyFrom(Sx),Rx.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",Rx)),(!t||!t.equals(Sx))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(Sx)),this._cameraChanged=!t||!t.almostEquals(Sx),this._cameraChanged)){const e=zh((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get contentCamera(){return U(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=U(e)?e.clone():null}get fixedContentCamera(){return U(this._contentCamera)}get isGlobal(){return this.viewingMode===Gi.Global}get isLocal(){return this.viewingMode===Gi.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(this.own(K((()=>e.state),(t=>{t!==C_.Finished&&t!==C_.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))))}),te)),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=C_.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==C_.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();Sx.copyFrom(this._get("camera")),e(Sx),this.camera=Sx,this.processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Bl.TOP]!==t.padding[Bl.TOP]||e.padding[Bl.RIGHT]!==t.padding[Bl.RIGHT]||e.padding[Bl.BOTTOM]!==t.padding[Bl.BOTTOM]||e.padding[Bl.LEFT]!==t.padding[Bl.LEFT]}};e([ve({readOnly:!0,type:ki})],Tx.prototype,"animation",null),e([ve({type:ql})],Tx.prototype,"camera",null),e([ve()],Tx.prototype,"pixelRatio",null),e([ve({})],Tx.prototype,"_contentCamera",void 0),e([ve({type:ql})],Tx.prototype,"contentCamera",null),e([ve({readOnly:!0})],Tx.prototype,"fixedContentCamera",null),e([ve({readOnly:!0})],Tx.prototype,"constraints",void 0),e([ve({readOnly:!0})],Tx.prototype,"events",void 0),e([ve({readOnly:!0})],Tx.prototype,"isGlobal",null),e([ve({readOnly:!0})],Tx.prototype,"isLocal",null),e([ve({readOnly:!0})],Tx.prototype,"viewingMode",void 0),e([ve({readOnly:!0})],Tx.prototype,"spatialReference",void 0),e([ve({readOnly:!0})],Tx.prototype,"navigating",null),e([ve({readOnly:!0})],Tx.prototype,"stationary",null),e([ve()],Tx.prototype,"_cameraChanged",void 0),e([ve()],Tx.prototype,"cameraController",null),Tx=e([xe("esri.views.3d.state.ViewState")],Tx);const Cx=Tx,Sx=new ql,Px={camera:null},Rx={camera:null};class Ax{constructor(e,t){this.elevationProvider=e,this._referenceEllipsoid=vr(t),this.unitInMeters=Cc(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,s){s||(s={near:0,far:0});let a=e[2]*this.unitInMeters;const n=a,o=a-r,l=this.elevationProvider?this.elevationProvider.elevationBounds:null;l&&(a=o>=0?n-this.unitInMeters*l.min:this.unitInMeters*l.max-n);const h={x:(i=U(i)?i:new bc({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},c=Math.max(h.x,h.y,h.z);ze(Fx,t,e),Nx[0]=Fx[0]>0?i.xmax:i.xmin,Nx[1]=Fx[1]>0?i.ymax:i.ymin,Nx[2]=Fx[2]>0?c/2:-c/2,ze(Nx,Nx,e),Fe(Fx,Fx);const d=1.1*je(Nx,Fx)*this.unitInMeters,u=Math.sqrt(a*(a+2*this._referenceEllipsoid.radius)),p=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=p*Ix*this.unitInMeters,g=p*Lx*this.unitInMeters;let f=Se((a-g)/(m-g),0,1);f*=f*f;let _=Ie(u,d,f);return _*=Math.max(Math.log(Math.abs(o)),1),_=Math.min(_,Math.max(34064e4,c)),_/=this.unitInMeters,Mx(_,Ex,this.unitInMeters,s)}}class Ox{constructor(e){this._referenceEllipsoid=vr(e)}compute(e,t,i,r,s){s||(s={near:0,far:0});const a=Ee(e)-this._referenceEllipsoid.radius,n=this._referenceEllipsoid.radius+Math.min(0,r),o=Math.abs(a-r),l=Math.max(o,Math.abs(a));return Mx(1.2*Math.sqrt(l*(l+2*n)),Se(2e4-(Math.log(l)-7.983)/9.011*19e3,1e3,2e4),1,s)}}function Mx(e,t,i,r){const s=Dx/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const Ex=2e4,Dx=2,Ix=.001,Lx=1e-4,Nx=Oe(),Fx=Oe();let Vx=class extends N{constructor(e){super(e),this.handles=new lr}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;Pl(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>{Qg(this.view,e,Zg.EYE_AND_CENTER)}))}};e([ve({constructOnly:!0})],Vx.prototype,"view",void 0),Vx=e([xe("esri.views.3d.state.ElevationCollisionConstraint")],Vx);let Ux=class extends N{constructor(e){var t,i,r;super(e),this._handles=new lr,this.nearFarHeuristic=(t=e.view.state.viewingMode,i=e.view.basemapTerrain,r=e.view.renderCoordsHelper.spatialReference,t===Gi.Global?new Ox(r):new Ax(i,r))}initialize(){this._handles.add([K((()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far]),(()=>this._clipDistanceNearFarChanged())),K((()=>this.view.constraints?.clipDistance?.mode),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e.camera))),K((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),te),K((()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max]),(()=>this._updateAltitude()),te),K((()=>this.view.constraints?.tilt?.max),(()=>this._updateTiltMax()),te),K((()=>this.view.constraints?.tilt?.mode),(()=>this._updateTilt()),te),K((()=>this.view.state?.camera),(()=>this._updateTiltAutoMax()),te),K((()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled]),(()=>this._updateCollision()),te)]),this.view.state.isLocal&&this._handles.add(K((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),$)),this._updateNearFar(),this.view.state.viewingMode!==Gi.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Vx({view:this.view}))}destroy(){this._handles=k(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>(this._updateCameraNearFarManual(t,e),!0)))}_updateNearFar(){this.view.state.updateCamera((e=>(this._updateCameraNearFar(e),!0)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,Tl(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(Og.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Gi.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Pe(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Re(i))}}_updateLocalSurfaceDistance(e){if(z(e))return;let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=Og.ALL){this.view.state.updateCamera((t=>qf(this.view,t,{selection:e,interactionType:Ag.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:Mg.TUMBLE})))}};e([ve({constructOnly:!0})],Ux.prototype,"view",void 0),e([ve({readOnly:!0})],Ux.prototype,"surfaceCollisionConstraint",void 0),Ux=e([xe("esri.views.3d.state.ConstraintsManager")],Ux);let zx=class extends S_{constructor(e){super(e),this.handles=new lr}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=C_.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){Pl(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),Qg(this.view,e,Zg.EYE_AND_CENTER)||this.constraintEnabled||(this.state=C_.Stopped)}))}};e([ve({constructOnly:!0})],zx.prototype,"view",void 0),e([ve({constructOnly:!0})],zx.prototype,"desiredCamera",null),zx=e([xe("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],zx);class jx{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise(((e,t)=>{this.resolveCallback=e,this.rejectCallback=t;const i=new AbortController;U(this.options.signal)&&g(this.options.signal,(()=>{this.abort()})),this.abortController=i,this.waitForReady()}))}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}resolve(e){return this.state="finished",this.resolveCallback(e)}reject(e){return this.state="finished",this.rejectCallback(e)}abort(e=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(h());break;case"wait-for-animation-finish":!e&&U(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(h())}}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await ie((()=>this.view.ready),this.abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this._getAnimationController():null,Rl(this.view,this.target,this.abortController.signal).then((e=>{if("finished"===this.state)return;const t=this._getCameraFromViewpoint(e);if(!z(t))if(this.options.animate){if(z(this.animationController))return;this.startAnimation(t,this.animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}),(e=>{this.reject(e)})))}_getCameraFromViewpoint(e){const i=!!(this.target instanceof r&&this.target.camera||this.target instanceof t),s=e.camera;if(z(s))return null;if(!this.view.stateManager.isCompatible(s)){const e=s.position,t=e&&e.spatialReference,i=t?t.wkid:"none",r=this.view.spatialReference.wkid;return this.reject(new o("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${i}, view: ${r})`,{camera:s})),null}const a=Al(this.view,s);return z(a)?(this.reject(new o("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:a,isFullySpecified:i}}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(z(i))return void this.reject(new o("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||z(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new zx({view:this.view,desiredCamera:e.camera}),Qg(this.view,e.camera,Zg.EYE_AND_CENTER)):qf(this.view,e.camera),t.begin(e.camera,this.options);const s=e=>{if(!z(this.view.state))switch(t.state){case C_.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case C_.Ready:case C_.Rejected:case C_.Running:case C_.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;r&&(i&&i.active?i instanceof R_&&U(i.viewAnimation)&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):U(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(this.view.state.cameraController=r))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}_getAnimationController(){let e,t=null;const i=this.view.state.cameraController;return i instanceof R_&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new R_({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(U(t)&&t.stop(),this.reject(new o("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const kx=V.getLogger("esri.views.3d.state.ViewStateManager");let Gx=class extends N{constructor(e){super(e),this.propertiesPool=new vh({frustum:Yb},this),this.handles=new lr,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._maximumPixelRatioOverride=null,this.test={contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,setMaximumPixelRatio:e=>this._maximumPixelRatioOverride=e}}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Ol(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(Al(this.view,e),{applyConstraints:!1})||kx.error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Ol(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Al(this.view,e);z(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=st(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.handles.add([K((()=>this.contentCamera),(()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())})),K((()=>this.zoom),(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})),K((()=>this.view.state.camera),(e=>{const t=Ke(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():kx.error("#center=","Invalid center",e):kx.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):kx.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=Ml(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return U(t)?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||kx.error("#extent=","Invalid extent",e):kx.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):kx.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return El(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||kx.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[Bl.TOP]/i),a=Math.round(t[Bl.RIGHT]/i),n=Math.round(t[Bl.BOTTOM]/i),o=Math.round(t[Bl.LEFT]/i);return null!=r&&r.top===s&&r.right===a&&r.bottom===n&&r.left===o?r:{top:s,right:a,bottom:n,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,Xx),this.view.state.updateCamera((e=>e.padding=Xx)))}_paddingToArray(e,t,i){e?et(i,e.top||0,e.right||0,e.bottom||0,e.left||0):et(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return ge((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?Dl(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||kx.error("#viewpoint=","Invalid viewpoint",e);else{const t=U(e.camera)?e.camera.position:e.targetGeometry,i=U(t)&&t.spatialReference;kx.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else kx.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Il(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||kx.error("#zoom=","Invalid zoom",e)}get maximumPixelRatio(){if(U(this._maximumPixelRatioOverride))return this._maximumPixelRatioOverride;let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.view.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.view.width,this.view.height);e=Math.min(e,t)}return e}get _devicePixelRatio(){return z(this._devicePixelRatioOverride)?Math.min(this._windowDevicePixelRatio,this.maximumPixelRatio):this._devicePixelRatioOverride}initialize(){this.handles.add([Y((()=>this.view.state.events),"before-camera-change",(e=>this._updateElevation(e.camera)))]),K((()=>this.view.state.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.handles.add(he({prepare:()=>this._prepareFrame()})),this.handles.add(K((()=>this.view.state.cameraController),(()=>{this.cameraSetByUser=!0,this.handles.remove(Yx)}))),this.handles.add(Y((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale"))))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new Ux({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===Gi.Local&&this.handles.add(ee((()=>this.view.basemapTerrain.ready),(()=>{this.handles.remove(Yx),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),Yx)}}deinit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(Yx),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i={animate:!0,...t};return U(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new jx(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(Ll(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t)})),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){U(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of Hx){const s=e.has(i),a=this._isOverridden(i);!s&&a&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||a)&&r.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(z(e)||this.cameraSetByUser)return;if(e instanceof t)return void this.setStateCamera(Al(this.view,e),{applyConstraints:!1});if(e instanceof r){if(e.targetGeometry instanceof bc){const t=Nl(this.view,e.targetGeometry,0,.5,Fl.LOCKED);return void(U(t)&&this.setStateCamera(Al(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const i=Nl(this.view,e,0,.5,Fl.LOCKED);U(i)&&this.setStateCamera(Al(this.view,i),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Bx.includes(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!z(e)&&(e instanceof r?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof t?this.isCompatible(e.position):e.spatialReference&&wc(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=Wx){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=Zx){const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),a=Vl(this.view,r,s,e,t,Fl.ADJUST);return z(a)?null:(i.copyFrom(this.view.state.camera),i.eye=a.eye,i.center=a.center,i.up=a.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=Nl(this.view,e,t,i,Fl.ADJUST,Qx);return U(r)?Al(this.view,r):null}_scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,s=Ul(this.view,e,r);return this._centerPointAtDistanceToCamera(i,s)}_zoomToCamera(e){return this._scaleToCamera(zl(this.view,e))}_viewpointToCamera(e){return Al(this.view,jl(this.view,e))}setStateCamera(e,t){return!(z(e)||!this.view.state.stopActiveCameraController()||(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&qf(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new zx({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._devicePixelRatio,r=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(0!==r&&0!==s&&(t.width===r&&t.height===s||(t.width=r,t.height=s),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===s&&e.pixelRatio===i||(Zx.copyFrom(e),Zx.pixelRatio!==i&&(this._paddingToArray(this.padding,i,Xx),Zx.padding=Xx),Zx.fullWidth=r,Zx.fullHeight=s,Zx.pixelRatio=i,this.view.state.camera=Zx)}}_updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?Tl(this.view,e.eye):0;e.relativeElevation=i-r}};e([ve({type:t,dependsOn:["view.state.camera","ready"]})],Gx.prototype,"camera",null),e([ve({type:t,dependsOn:["view.state.contentCamera","ready"]})],Gx.prototype,"contentCamera",null),e([ve({type:xc})],Gx.prototype,"center",null),e([ve({type:bc})],Gx.prototype,"extent",null),e([ve({readOnly:!0})],Gx.prototype,"frustum",null),e([ve({readOnly:!0})],Gx.prototype,"hasInitialView",null),e([ve({readOnly:!0,type:Boolean})],Gx.prototype,"ready",void 0),e([ve({type:Number})],Gx.prototype,"scale",null),e([ve()],Gx.prototype,"padding",null),e([ve({readOnly:!0})],Gx.prototype,"screenCenter",null),e([ve({constructOnly:!0})],Gx.prototype,"view",void 0),e([ve({type:r})],Gx.prototype,"viewpoint",null),e([ve({type:Number})],Gx.prototype,"zoom",null),e([ve()],Gx.prototype,"maximumPixelRatio",null),e([ve()],Gx.prototype,"_devicePixelRatio",null),e([ve()],Gx.prototype,"_windowDevicePixelRatio",void 0),e([ve()],Gx.prototype,"_devicePixelRatioOverride",void 0),e([ve()],Gx.prototype,"_maximumPixelRatioOverride",void 0),Gx=e([xe("esri.views.3d.state.ViewStateManager")],Gx);const qx=Gx,Bx=["camera","viewpoint","extent","scale","center","zoom"],Hx=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Wx={heading:0,tilt:0},Qx=new t,Zx=new ql,Xx=hr(),Yx="pending-initial-view";class Kx{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this.view=i,this.externalIntersectionHandlers=new le,this.tolerance=Wl,this.tmpRay=sl(),this.tmpRegion=Vt(),this.validateHUDIntersector=Hl(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this.tmpRay),iw(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this.tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,iw(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=Ql.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(nw,i,r),nw[0]+=.0466,nw[1]-=.0123,uh(e,nw,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this.tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.opaque||Zl(r)&&r.intersector!==Xl.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=Wl){this.tolerance=e}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort(((e,t)=>e.type===Xl.TERRAIN?1:t.type===Xl.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this.externalIntersectionHandlers.removeUnordered(e)&&this.externalIntersectionHandlers.sort(((e,t)=>e.type===Xl.TERRAIN?1:t.type===Xl.TERRAIN?-1:0))}_getPickRay(e,t){const i=this.view.state.camera;return dh(i,e,t)}_intersectRayFreePointLocal(e,t){if(this.viewingMode!==Gi.Local||z(e))return!1;const i=this.view.renderDataExtent;if(z(i))return Ge(t,e.origin,Fe(oo.get(),e.direction)),!0;const r={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},s=Math.max(r.x,r.y,r.z);if(0===s)return Ge(t,e.origin,Fe(oo.get(),e.direction)),!0;const a=this.view.state.camera,n=Math.max(0,i.xmin-a.eye[0],a.eye[0]-i.xmax),o=Math.max(0,i.ymin-a.eye[1],a.eye[1]-i.ymax),l=Math.sqrt(n*n+o*o),h=Math.abs(a.relativeElevation)+Number.MIN_VALUE,c=Math.max(0,Math.log(s/h))**2;let d=s/Math.max(1,c);d=Math.max(d,Math.min(l,s));const u=Ue(oo.get(),e.direction,d/Ee(e.direction));return Ge(t,e.origin,u),!0}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this.tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(z(e))return null;const s=U(t)?t.mode:"absolute-height",a=U(t)?H(t.offset,0):0,n="on-the-ground"!==s?a+i:0,o=n/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===s){if(this.view.renderCoordsHelper.intersectInfiniteManifold(e,n,aw)){const e=this.view.computeMapPointFromVec3d(aw);return e.z-=a,e}return null}const l=this.view.state.camera,h=fe(oo.get());l.projectToRenderScreen(e.origin,h);const c=new rw(null,this._forEachLayer),d=this.view.slicePlane,u=U(d)?Yl(d):null,p=Hl(this.viewingMode);p.options.store=Ql.MIN,p.options.verticalOffset=o;const m=e.origin,g=Ge(oo.get(),m,e.direction);p.reset(m,g,l),p.point=h;const f=U(r)?"type"in r&&"graphics"===r.type?e=>e.metadata.layerUid!==r.uid:e=>e.metadata.graphicUid!==r.uid:null;switch(s){case"relative-to-scene":{const e=e=>(z(f)||f(e))&&e.metadata&&e.metadata.isElevationSource;p.intersect(c.layers,h,this.tolerance,null,e),this.externalIntersectionHandlers.forAll((e=>{if(e.type===Xl.I3S||e.type===Xl.TERRAIN){const t=e.slicePlaneEnabled?u:null;e.intersect(p,t,p.rayBegin,p.rayEnd,h)}}))}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?u:null;e.intersect(p,t,p.rayBegin,p.rayEnd,h)}}))}if(p.results.min.getIntersectionPoint(aw)){const e=this.view.computeMapPointFromVec3d(aw);return e.z=i,e}return null}computeIntersection(e,t,i){if(z(e))return;const r=this.view.state.camera,s=fe(oo.get());r.projectToRenderScreen(e.origin,s);const a=new rw(i,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const n=e.origin,o=Ge(oo.get(),e.origin,e.direction);t.reset(n,o,r),t.intersect(a.layers,s,this.tolerance);const l=this.view.slicePlane,h=U(l)?Yl(l):null;t.intersect(a.sliceableLayers,s,this.tolerance,h);const c=i&&(i.requiresGroundFeedback||i.enableDraped);this.externalIntersectionHandlers.forAll((e=>{if(t.options.isFiltered=!a.filterLayerUid(e.layerUid),e.isGround&&c||!t.options.isFiltered){const i=e.slicePlaneEnabled?h:null;e.intersect(t,i,n,o,s)}}));const d=oo.get();if(i&&i.enableDraped&&t.results.ground.getIntersectionPoint(d)){const e=this.view.basemapTerrain,i=e.overlayManager.renderer,r=this.view.renderCoordsHelper.spatialReference,s=oo.get();this.view.renderCoordsHelper.fromRenderCoords(d,s,e.spatialReference),s[2]=H(this.view.elevationProvider.getElevation(d[0],d[1],d[2],r,"ground"),0),i.intersect(t,s,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;Qt(this.tmpRegion,Zt);const i=this.view.state.camera,r=[],s=this.tmpRegion,a=e=>{const t=new ew(e);i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),r.push(t),Wt(s,t.screenPoint)};e.sortResults(t.all),U(t.min.dist)&&a(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&a(e);if(U(t.max.dist)&&t.max.target.object!==t.min.target.object&&a(t.max),!r.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const n=i.fullWidth,o=i.fullHeight,l=Math.max(0,s[0]-$x),h=Math.max(0,s[1]-$x),c=Math.min(jt(s)+2*$x,n-l),d=Math.min(kt(s)+2*$x,o-h),u=new Uint8Array(c*d*4);this.view._stage.renderView.readHUDVisibility(l,h,c,d,u);let p=!0;const m=z(e.results.max.dist);let g=0;for(const t of r)for(const i of Jx)if(u[4*(Math.min(t.screenPoint[0]+i[0],n)-s[0]+(Math.min(t.screenPoint[1]+i[1],o)-s[1])*c)]){p&&(e.results.min.copy(t.result),p=!1),m&&e.results.max.copy(t.result),e.options.store===Ql.ALL&&e.results.all.splice(g++,0,t.result);break}}}const $x=1,Jx=(()=>{const e=[],t=$x;for(let i=-t;i<=t;i++)for(let r=-t;r<=t;r++)e.push([r+t,i+t]);return e})();class ew{constructor(e){this.result=e,this.screenPoint=me()}}let tw;function iw(e){return tw&&tw.viewingMode===e||(tw=Hl(e)),tw}class rw{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.isPickable&&this.filterLayerUid(e.apiLayerUid)&&(e.isSliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerUid(e){const{include:t,exclude:i}=this;return z(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function sw(e){return"object"==typeof e&&"intersect"in e}const aw=Oe(),nw=me();let ow=class extends(or.EventedMixin(N)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=k(this._elevationQuery)}get elevationQuery(){return z(this._elevationQuery)&&(this._elevationQuery=new vl(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,i,r,s){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const a=this.lastElevationQuery;if(e===a.x&&t===a.y&&i===a.z&&r.equals(a.spatialReference)&&s===a.queryContext)return a.result}let a=null;return a=lw(a,this.im,e,t,i,r,s),z(a)&&(a=lw(a,this.ground,e,t,i,r,s)),"scene"===s&&(a=lw(a,this.scene,e,t,i,r,s)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:a}),a}queryElevation(e,t,i,r,s,a=null,n=0){const o=l();return this.elevationQuery.queryElevation(e,t,a,n).then((a=>{"scene"===s&&(a=lw(a,this.scene,e,t,i,r,s)),o.resolve(a)})).catch((a=>{u(a)?o.reject(a):o.resolve(this.getElevation(e,t,i,r,s))})),o.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function lw(e,t,i,r,s,a,n){for(const o of t){const t=o.getElevation(i,r,s,a,n);U(t)&&(e=U(e)?Math.max(t,e):t)}return e}e([ve({constructOnly:!0})],ow.prototype,"view",void 0),e([ve({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],ow.prototype,"spatialReference",void 0),ow=e([xe("esri.views.3d.support.CombinedElevationProvider")],ow);class hw{static isValidProfile(e){return e in hw.profiles}static getDefaultProfile(){return T("trident")||T("esri-iPhone")?"low":"medium"}static apply(e,t){const i=hw.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable;{const e=t.sceneService["3dObject"],r=i.sceneService["3dObject"];e.lodFactor=r.lodFactor,e.lodCrossfadeinDuration=r.lodCrossfadeinDuration,e.lodCrossfadeoutDuration=r.lodCrossfadeoutDuration,e.lodCrossfadeUncoveredDuration=r.lodCrossfadeUncoveredDuration}t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumRenderResolution=i.maximumRenderResolution,t.maximumPixelRatio=i.maximumPixelRatio}}function cw(){const e=!!T("esri-mobile"),t=!!T("ios");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!T("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!T("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}hw.debug={reset(){const e=cw();for(const t in e)hw.profiles[t]=e[t]}},function(e){e.profiles=cw()}(hw||(hw={}));const dw=hw;let uw=class extends N{constructor(){super(...arguments),this.color=new nr([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new nr([0,0,0]),this.shadowDifference=.2}static toEngineOptions(e){const t=nr.toUnitRGBA(e.color),i=U(e.haloColor)?nr.toUnitRGBA(e.haloColor):t,r=nr.toUnitRGBA(e.shadowColor);return{color:Pc(t[0],t[1],t[2],t[3]),haloColor:Pc(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:cr(r[0],r[1],r[2],r[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}};e([ve({type:nr})],uw.prototype,"color",void 0),e([ve({type:nr})],uw.prototype,"haloColor",void 0),e([ve()],uw.prototype,"haloOpacity",void 0),e([ve()],uw.prototype,"fillOpacity",void 0),e([ve()],uw.prototype,"shadowOpacity",void 0),e([ve({type:nr})],uw.prototype,"shadowColor",void 0),e([ve()],uw.prototype,"shadowDifference",void 0),uw=e([xe("esri.views.3d.support.HighlightOptions")],uw);const pw=uw;class mw{constructor(e,t){this.spatialReference=t,this.unitInMeters=Cc(this.spatialReference,vr(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=Ac(e&&e.get("portalItem")).catch((()=>{throw new o("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}async toGeographic(e){const t=await this._geometryServiceURLPromise;let i,r=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],r=!1);const s=i.map((e=>e instanceof xc?e:new xc(e,this.spatialReference))),a=new Mc({geometries:s,outSpatialReference:mr.WGS84}),n=(await Oc(t,a)).map((e=>"point"===e.type?[e.x,e.y]:void 0));return r?n:n[0]}}let gw=class extends N{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1}};e([ve()],gw.prototype,"minTotalNumberOfFeatures",void 0),e([ve()],gw.prototype,"maxTotalNumberOfFeatures",void 0),e([ve()],gw.prototype,"maxTotalNumberOfPrimitives",void 0),e([ve()],gw.prototype,"snapshotAvailable",void 0),e([ve()],gw.prototype,"polygonLodFactor",void 0),e([ve()],gw.prototype,"polylineLodFactor",void 0),gw=e([xe("esri.views.3d.support.QualitySettings.Graphics3DSettings")],gw);let fw=class extends N{constructor(){super(...arguments),this.lodFactor=1}};e([ve()],fw.prototype,"lodFactor",void 0),fw=e([xe("esri.views.3d.support.QualitySettings.LoDFactorSettings")],fw);let _w=class extends fw{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};_w=e([xe("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],_w);let yw=class extends N{constructor(){super(...arguments),this["3dObject"]=new _w,this.point=new fw,this.integratedMesh=new fw,this.pointCloud=new fw,this.uncompressedTextureDownsamplingEnabled=!1}};e([ve({type:_w})],yw.prototype,"3dObject",void 0),e([ve({type:fw})],yw.prototype,"point",void 0),e([ve({type:fw})],yw.prototype,"integratedMesh",void 0),e([ve({type:fw})],yw.prototype,"pointCloud",void 0),e([ve()],yw.prototype,"uncompressedTextureDownsamplingEnabled",void 0),yw=e([xe("esri.views.3d.support.QualitySettings.SceneServiceSettings")],yw);let vw=class extends N{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};e([ve()],vw.prototype,"lodBias",void 0),e([ve()],vw.prototype,"angledSplitBias",void 0),e([ve()],vw.prototype,"reduceTileLevelDifferences",void 0),e([ve()],vw.prototype,"textureFadeDuration",void 0),vw=e([xe("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],vw);let bw=class extends N{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};e([ve()],bw.prototype,"pixelRatio",void 0),e([ve()],bw.prototype,"maxTotalNumberOfFeatures",void 0),bw=e([xe("esri.views.3d.support.QualitySettings.HeatmapSettings")],bw);let xw=class extends N{constructor(){super(...arguments),this.graphics3D=new gw,this.sceneService=new yw,this.tiledSurface=new vw,this.heatmap=new bw,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};e([ve({type:gw})],xw.prototype,"graphics3D",void 0),e([ve({type:yw})],xw.prototype,"sceneService",void 0),e([ve({type:vw})],xw.prototype,"tiledSurface",void 0),e([ve({type:bw})],xw.prototype,"heatmap",void 0),e([ve()],xw.prototype,"antialiasingEnabled",void 0),e([ve()],xw.prototype,"physicallyBasedRenderingEnabled",void 0),e([ve()],xw.prototype,"highQualityTransparency",void 0),e([ve()],xw.prototype,"memoryLimit",void 0),e([ve()],xw.prototype,"additionalCacheMemory",void 0),e([ve()],xw.prototype,"frameRate",void 0),e([ve()],xw.prototype,"maximumRenderResolution",void 0),e([ve()],xw.prototype,"maximumPixelRatio",void 0),xw=e([xe("esri.views.3d.support.QualitySettings.QualitySettings")],xw);const ww=xw;var Tw;!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(Tw||(Tw={}));const Cw=(()=>{const e=new Array;return e[Tw.ELEVATION]=10,e[Tw.BASEMAP]=10,e[Tw.I3S_INDEX]=10,e[Tw.I3S_DATA]=10,e[Tw.SYMBOLOGY]=5,e})(),Sw=30,Pw=V.getLogger("esri.views.3d.support.MemoryController");let Rw=class extends N{constructor(e){super(e),this._quality=1,this._memoryUsed=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new Ec,this._numQualityChanges=0,this._maxMemory=500,this._additionalCacheMemory=100}destroy(){this._cacheStorage.destroy()}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}newCache(e,t){return new Dc(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){let e=0,t=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(e+=this.view.basemapTerrain.getUsedMemory());const i=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderView.edgeView;U(i)&&(e+=i.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach((i=>{if(Lc(i)){const r=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*r,t+=i.getUnloadedMemory()*r}}));const r=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(e>s&&r){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);Pw.warn(`Memory Limit exceeded! Limit: ${i(s)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${r}%`)}this._memoryUsed=e/s,this._memoryPredicted=(e+t)/s;const a=s-e;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}};e([ve({constructOnly:!0})],Rw.prototype,"view",void 0),e([ve()],Rw.prototype,"maxMemory",null),e([ve()],Rw.prototype,"additionalCacheMemory",null),e([ve()],Rw.prototype,"memoryFactor",null),e([ve()],Rw.prototype,"updating",null),e([ve()],Rw.prototype,"usedMemory",null),e([ve()],Rw.prototype,"_quality",void 0),e([ve()],Rw.prototype,"_memoryUsed",void 0),e([ve()],Rw.prototype,"_updating",void 0),e([ve()],Rw.prototype,"_stableQuality",void 0),e([ve()],Rw.prototype,"_maxMemory",void 0),e([ve()],Rw.prototype,"_additionalCacheMemory",void 0),Rw=e([xe("esri.views.3d.support.MemoryController")],Rw);let Aw=class extends N{constructor(){super(...arguments),this.updating=!1}};var Ow;e([ve({readOnly:!0})],Aw.prototype,"updating",void 0),Aw=e([xe("esri.views.3d.support.ResourceController")],Aw),function(t){let i=class extends Aw{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._scheduleTask=Ao,this._cameraChangeTime=0,this._handles=new lr,this._frameTask=null,this._state=Po.IDLE}initialize(){var e;this._cameraChangeTime=performance.now(),this._scheduler=Oo(),this._memoryController=(e=this.view,new Rw({view:e})),this._streamDataLoader=new Nc,this._streamDataLoader.setup(30,Cw,this._scheduler),this._handles.add([K((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),te),K((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=he({update:e=>this._frame(e)}),this._scheduleTask=this._scheduler.registerTask(So.RESOURCE_CONTROLLER)}destroy(){this._handles=k(this._handles),this._scheduleTask.remove(),this._frameTask=j(this._frameTask),this._streamDataLoader=k(this._streamDataLoader),this._memoryController=k(this._memoryController),this._scheduler=k(this._scheduler)}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._scheduleTask?.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(e,t,i){return this._scheduleTask.schedule(e,t,i)}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(se(e.deltaTime)),!this._scheduler)||(this._updateState(),this._scheduler.state=this._state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateState(),this._scheduler.state=this._state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}_updateState(){this.view.animation?this._state=Po.ANIMATING:this.view.interacting?this._state=Po.INTERACTING:(this._state===Po.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=r?this._state=Po.INTERACTING:this._state=Po.IDLE)}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this._state}}};e([ve({constructOnly:!0})],i.prototype,"view",void 0),e([ve()],i.prototype,"_scheduler",void 0),e([ve()],i.prototype,"_memoryController",void 0),e([ve()],i.prototype,"_streamDataLoader",void 0),e([ve()],i.prototype,"_scheduleTask",void 0),e([ve({readOnly:!0})],i.prototype,"updating",null),i=e([xe("esri.views.3d.support.ResourceController")],i),t.ResourceController=i;const r=300}(Ow||(Ow={}));class Mw extends wi{constructor(e,t,i,r){super(t,r),this._streamDataRequester=e,this._parameters=i}async fromUrl(e,t,i){p(i);const r=U(i)&&i.signal,s=this.makeUid(e,t);let a=this._textureRequests.get(s);if(!a){const i=new AbortController,r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});a={referenceCount:0,texture:null,textureAsync:null,abortController:i},this._textureRequests.set(s,a),a.textureAsync=r.then((async i=>{const r=this._createTexture(e,i,t);return a.texture=r,a.abortController=null,this._stage.add(r),await this._stage.load(r),{uid:s,texture:r,release:()=>this._release(s)}}),(e=>{throw a.abortController=null,e}))}return a.referenceCount++,new Promise(((e,t)=>{g(r,(()=>{t(h())})),a.textureAsync.then(e,t)})).catch((e=>{throw this._release(s),e}))}_createTexture(e,t,i){const r={...this._parameters,powerOfTwoResizeMode:md.PAD};if(pd(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(r.preMultiplyAlpha=!1)}return r.width=t.width,r.height=t.height,new Sd(t,r)}}class Ew{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(Tw.SYMBOLOGY),this.textures=new Mw(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:Pn.CLAMP_TO_EDGE,t:Pn.CLAMP_TO_EDGE}},e.resourceController.scheduler);const t=vr(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=cn(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=dn(e.viewingMode,t)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return b();this.graphicsOwners.push(e);const t=K((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),b((()=>{t.remove(),C(this.graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new lr;const e=()=>this._updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([K((()=>this.pointsOfInterest.centerOnSurfaceInfrequent.distance),e,te),this.viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else!e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}_updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;Dw.distance=e.centerOnSurfaceInfrequent.distance,Dw.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(Dw),this.screenSizePerspectiveSettingsLabels.update(Dw),this.view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this.screenSizePerspectiveHandles}}}const Dw={distance:0,fovY:0};class Iw{constructor(e,t,i=""){this.graphics=e,this._symbol=new Pd({symbolLayers:[new Rd({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Ad({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})]})}show(e,t){if(z(t))return;this.hide();const r=new xc({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new i({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){U(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let Lw=class extends N{constructor(e){super(e),this.handles=new lr}destroy(){this.handles.destroy()}};e([ve({constructOnly:!0})],Lw.prototype,"renderCoordsHelper",void 0),e([ve({constructOnly:!0})],Lw.prototype,"surface",void 0),e([ve({constructOnly:!0})],Lw.prototype,"state",void 0),Lw=e([xe("esri.views.3d.support.PointOfInterest")],Lw);const Nw=Array;let Fw=class extends Lw{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new vh({location:xc,renderLocation:Nw},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=Oe(),this.tmpPoint=new xc}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(Y((()=>this.map?.ground?.layers),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=qe(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return El(i,t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let e=new AbortController;this.map.ground.queryElevation(this.tmpPoint,{signal:e.signal,cache:this.cache}).then((e=>this._updateSurfaceAltitude(e.geometry.z))).catch((e=>{u(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null})),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(Vw,this._estimatedSurfaceAltitude,this._camera.eye),at(this._get("renderLocation"),Vw)||this._set("renderLocation",De(this._propertiesPool.get("renderLocation"),Vw))}};e([ve({constructOnly:!0})],Fw.prototype,"scheduler",void 0),e([ve({constructOnly:!0})],Fw.prototype,"cache",void 0),e([ve({constructOnly:!0})],Fw.prototype,"task",void 0),e([ve({constructOnly:!0})],Fw.prototype,"cameraName",void 0),e([ve({readOnly:!0})],Fw.prototype,"location",null),e([ve({constructOnly:!0})],Fw.prototype,"map",void 0),e([ve({readOnly:!0})],Fw.prototype,"renderLocation",void 0),e([ve({readOnly:!0})],Fw.prototype,"scale",null),e([ve({readOnly:!0})],Fw.prototype,"updating",null),Fw=e([xe("esri.views.3d.support.CameraOnSurface")],Fw);const Vw=Oe(),Uw=Array;let zw=class extends Lw{constructor(e){super(e),this._propertiesPool=new vh({location:xc,renderLocation:Uw},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=Oe(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=j(this._frameWorker),this._propertiesPool=k(this._propertiesPool)}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const e=kw;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=Gw;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(De(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=qe(this._camera.eye,e):(Ue(e,this._camera.viewForward,this._get("distance")),Ge(e,e,this._camera.eye)),at(this._get("renderLocation"),e)||this._set("renderLocation",De(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=vr(this.renderCoordsHelper.spatialReference).radius,s=r+e,a=Be(i.eye),n=a<s*s,o=qe(i.eye,t);if(n&&o>r/4){const e=s-Math.sqrt(a);return Ue(t,i.viewForward,e),Ge(t,t,i.eye),!0}}else{const e=this.surface.ready?this.surface.extent:null;U(e)&&Rt(e,this.surface.spatialReference,qw,this.renderCoordsHelper.spatialReference)&&(t[0]=Se(t[0],qw[0],qw[2]),t[1]=Se(t[1],qw[1],qw[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(fa.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=qe(i,e),s=qe(i,t);if(Math.abs(s-r)/r>jw)return!0}return!1}};e([ve({constructOnly:!0})],zw.prototype,"scheduler",void 0),e([ve({constructOnly:!0})],zw.prototype,"task",void 0),e([ve({constructOnly:!0})],zw.prototype,"cameraName",void 0),e([ve()],zw.prototype,"distance",void 0),e([ve({constructOnly:!0})],zw.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e([ve({readOnly:!0})],zw.prototype,"location",null),e([ve({readOnly:!0})],zw.prototype,"renderLocation",void 0),e([ve()],zw.prototype,"updating",void 0),zw=e([xe("esri.views.3d.support.CenterOnSurface")],zw);const jw=.05,kw=Oe(),Gw=Oe(),qw=Vt();class Bw{constructor(e){this.handles=new lr,this.events=new or,this.contentLayerViews=e.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",(e=>this._layerViewsChanged(e)))),this._layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this.handles.add(e.on("visible-geometry-changed",(()=>this._contentChanged())),e.uid)})),e.removed.forEach((e=>this.handles.remove(e.uid)))}_contentChanged(){this.events.emit("request-update",Hw)}}const Hw={},Ww=Array;let Qw=class extends Lw{constructor(e){super(e),this._propertiesPool=new vh({location:xc,renderLocation:Ww},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([K((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),K((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(So.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,Zw);const s=Math.max(0,(Math.acos(je(Zw,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!Ve(e,t)){const e=this._propertiesPool.get("renderLocation");De(e,t),this._set("renderLocation",e)}return}const a=1-Se(s/(.5*Math.PI),0,1),n=a*a*a;this._calculateScreenHorizontalEdgeOnSurface(Yw);const o=this._propertiesPool.get("renderLocation");ke(o,t,Yw,n),e&&Ve(e,o)||this._set("renderLocation",o)}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(me());if(i[1]=t.aboveGround?t.padding[Bl.BOTTOM]:t.fullHeight-t.padding[Bl.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,Xw)){ze(Xw,Xw,t.eye);const i=Fe(Xw,Xw);if(this.renderCoordsHelper.intersectManifold(rl(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};e([ve()],Qw.prototype,"_dirty",void 0),e([ve({constructOnly:!0})],Qw.prototype,"scheduler",void 0),e([ve({constructOnly:!0})],Qw.prototype,"centerOnSurface",void 0),e([ve({constructOnly:!0})],Qw.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e([ve({readOnly:!0})],Qw.prototype,"updating",null),e([ve({readOnly:!0})],Qw.prototype,"location",null),e([ve({readOnly:!0})],Qw.prototype,"renderLocation",void 0),Qw=e([xe("esri.views.3d.support.CenterOnSurface")],Qw);const Zw=Oe(),Xw=Oe(),Yw=Oe();let Kw=class extends N{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new lr}get renderLocation(){if(!this.location)return null;const e=Oe();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([K((()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent]),(()=>this._update())),Y((()=>this.surface?.layers),"change",(()=>this._update()))]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||z(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const e=Xt(this.surfaceView.extent),t=new xc({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{u(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",t)}};e([ve({constructOnly:!0})],Kw.prototype,"view",void 0),e([ve({constructOnly:!0})],Kw.prototype,"cache",void 0),e([ve({readOnly:!0,aliasOf:"view.map.ground"})],Kw.prototype,"surface",void 0),e([ve({readOnly:!0,aliasOf:"view.basemapTerrain"})],Kw.prototype,"surfaceView",void 0),e([ve({readOnly:!0})],Kw.prototype,"location",void 0),e([ve({readOnly:!0})],Kw.prototype,"renderLocation",null),Kw=e([xe("esri.views.3d.terrain.StableSurfaceCenter")],Kw);let $w=class extends N{constructor(){super(...arguments),this.handles=new lr,this._tileGeometryUpdateExtent=Ut(),this._tileGeometryUpdateSpatialReference=null,this.events=new or,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(So.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles=k(this.handles)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Jw),Ut(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,Gt(this._tileGeometryUpdateExtent,e.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=iT,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,eT,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,tT,t),eT[0]<tT[0]?(r[0]=eT[0],r[2]=tT[0]):(r[0]=tT[0],r[2]=eT[0]),eT[1]<tT[1]?(r[1]=eT[1],r[3]=tT[1]):(r[1]=tT[1],r[3]=eT[1]),qt(r,e)}};e([ve({constructOnly:!0})],$w.prototype,"state",void 0),e([ve({constructOnly:!0})],$w.prototype,"centerOnSurfaces",void 0),e([ve({constructOnly:!0})],$w.prototype,"renderCoordsHelper",void 0),e([ve({constructOnly:!0})],$w.prototype,"scheduler",void 0),e([ve({constructOnly:!0})],$w.prototype,"surface",void 0),e([ve({readOnly:!0})],$w.prototype,"updating",void 0),$w=e([xe("esri.views.3d.support.SurfaceGeometryUpdates")],$w);const Jw={},eT=Oe(),tT=Oe(),iT=Ut();let rT=class extends N{constructor(e){super(e),this._handles=new lr,this._tmpRay=sl(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new vh({renderPointOfView:sT},this),this.renderPointOfView=Oe(),this._pois=new Array,this._debugCenters=new Map}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=Hl(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Ql.MIN,this._contentIntersector=Hl(e.viewingMode);const s=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,n=Z(this.view.basemapTerrain?.elevationQueryCache),o={state:e,scheduler:a,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new zw({...o,task:So.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new zw({...o,task:So.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("contentCenterOnSurface",new zw({...o,task:So.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s,cameraName:"contentCamera"})),this._set("centerOnContent",new zw({...o,task:So.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Fw({...o,cache:n,task:So.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("contentCameraOnSurface",new Fw({...o,cache:n,task:So.POINT_OF_INTEREST_INFREQUENT,map:r,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new $w({...o,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new Bw({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new Kw({cache:n,view:this.view})),this._set("focus",new Qw({state:e,scheduler:a,surface:t,renderCoordsHelper:i,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const l=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Iw(l,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Iw(l,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Iw(l,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new Iw(l,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Iw(l,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new Iw(l,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new Iw(l,"green","Focus")),this._handles.add([K((()=>e.camera),(e=>this._cameraChanged(e)),te),K((()=>t.extent),(()=>this._updateCenterPointsOfInterest())),ee((()=>!t.updating),(()=>this._updateCenterPointsOfInterest()),te),Y((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),Y((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),ee((()=>fa.SHOW_POI),(e=>this._setDebug(e)),$)]),this._cameraChanged(this.view.state.camera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some((e=>e.updating)))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return z(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,aT,oT)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(aT):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(z(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=Ge(aT,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(aT)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(aT)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=uh(t,e,nT);if(z(r))return null;const s=r.origin,a=Ge(aT,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,a),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;at(this.renderPointOfView,t)||this._set("renderPointOfView",De(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this._handles.remove("debug");for(const e of this._pois)this._handles.add(K((()=>e.renderLocation),(t=>this._debugCenters.get(e).show(t,e.renderCoordsHelper.spatialReference)),$),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};e([ve({readOnly:!0})],rT.prototype,"centerOnContent",void 0),e([ve({readOnly:!0})],rT.prototype,"centerOnSurfaceFrequent",void 0),e([ve({readOnly:!0})],rT.prototype,"centerOnSurfaceInfrequent",void 0),e([ve({readOnly:!0})],rT.prototype,"contentCenterOnSurface",void 0),e([ve({readOnly:!0})],rT.prototype,"cameraOnSurface",void 0),e([ve({readOnly:!0})],rT.prototype,"contentCameraOnSurface",void 0),e([ve({readOnly:!0})],rT.prototype,"focus",void 0),e([ve({readOnly:!0})],rT.prototype,"renderPointOfView",void 0),e([ve({readOnly:!0})],rT.prototype,"surfaceOrigin",void 0),e([ve({readOnly:!0})],rT.prototype,"contentGeometryUpdates",void 0),e([ve({readOnly:!0})],rT.prototype,"surfaceGeometryUpdates",void 0),e([ve({constructOnly:!0})],rT.prototype,"view",void 0),e([ve({readOnly:!0})],rT.prototype,"updating",null),rT=e([xe("esri.views.3d.support.PointsOfInterest")],rT);const sT=Array,aT=Oe(),nT=sl(),oT={exclude:new Set([ph])},lT={value:.5,readOnly:!0},hT={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};class cT{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class dT{constructor(e,t,i){this.type="elevation",this.samplerData=null,this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t;const r=i.noDataValue,s=i.values;let a=1/0,n=-1/0,o=!0,l=!1;for(let e=0;e<s.length;e++){const t=s[e];t!==r?(a=t<a?t:a,n=t>n?t:n,o=!1):l=!0}o&&(a=0,n=0),n=n>-3e38?n:0,this.samplerData={pixelData:i.values,width:i.width,height:i.height,noDataValue:r,safeWidth:.99999999*(i.width-1),dx:(i.width-1)/(t[2]-t[0]),dy:(i.width-1)/(t[3]-t[1]),x0:t[0],y1:t[3]},this.bounds=[a,n],this.hasNoDataValues=l}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const a=2**s;if(Math.floor(t/a)!==this.i||Math.floor(i/a)!==this.j)return r;let n=1/0,o=-1/0;const l=this.samplerData.width,h=this.samplerData.pixelData,c=.5*Fd;let d=(l-1)/a,u=(i-this.j*a)*d,p=(t-this.i*a)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,s=h[i],a=h[i+1],n=h[i+l],o=h[i+l+1];if(s+a+n+o<c){const i=u-e,l=p-t,h=Ji(s,a,n,o,i,l),c=Ji(s,a,n,o,i+d,l),m=Ji(s,a,n,o,i,l+d),g=Ji(s,a,n,o,i+d,l+d);return r.min=Math.min(h,c,m,g),r.max=Math.max(h,c,m,g),r}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let e=u;e<=u+d;e++)for(let t=p;t<=p+d;t++){const i=h[e+t*l];i<c?(n=Math.min(n,i),o=Math.max(o,i)):r.hasNoDataValues=!0}return r.min=n,r.max=o,r}}function uT(e,t,i){if(z(i))return null;for(const r of i){if(!r)continue;const i=r.safeWidth;let s=Se(r.dy*(r.y1-t),0,i),a=Se(r.dx*(e-r.x0),0,i);const n=Math.floor(s),o=Math.floor(a),l=r.width,h=n*l+o,c=r.pixelData,d=c[h],u=c[h+1],p=h+l,m=c[p],g=c[p+1];if(d+m+u+g<.5*Fd){s-=n,a-=o;const e=d+(u-d)*a;return e+(m+(g-m)*a-e)*s}}return null}function pT(e,t,i){const r=uT(e,t,i);return U(r)?r:0}let mT=class extends N{constructor(e){super(e),this._handles=new lr}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("IntegratedMeshLayer"===i.operationalLayerType&&null!=this.viewSpatialReference){const t=_T(i.fullExtent,this.viewSpatialReference);U(t)&&e.push(Yt(t))}})),e}};e([ve({readOnly:!0})],mT.prototype,"layerViewsExtent",null),e([ve({readOnly:!0})],mT.prototype,"tiledLayersExtent",null),e([ve({readOnly:!0})],mT.prototype,"stencilEnabledExtents",null),e([ve()],mT.prototype,"viewSpatialReference",void 0),e([ve()],mT.prototype,"tilingScheme",void 0),e([ve()],mT.prototype,"defaultTiledLayersExtent",void 0),e([ve({constructOnly:!0})],mT.prototype,"layers",void 0),e([ve({constructOnly:!0})],mT.prototype,"layerViews",void 0),mT=e([xe("esri.views.3d.terrain.ExtentHelper")],mT);let gT=class extends mT{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Vd:Ud}};gT=e([xe("esri.views.3d.terrain.ExtentHelperGlobal")],gT);let fT=class extends mT{_computeLayerViewsExtent(){const e=Ut(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=_T("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);Gt(e,r,e)}}));const i=Kt(e)?e:null,r=this._get("layerViewsExtent");return $t(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=Ut();this.layers.forEach((r=>{if(r.loaded&&_i(r)){const s=Fc(r,t,Gi.Local);if(z(s))return;const{tileInfo:a,fullExtent:n}=s;U(a)&&U(n)&&(Vc(r)||e.compatibleWith(a)&&n.spatialReference.equals(e.spatialReference))&&Gt(i,n,i)}})),Gt(i,this.defaultTiledLayersExtent,i);const r=Kt(i)?i:null,s=this._get("tiledLayersExtent");return $t(r,s)?s:r}};function _T(e,t){return U(e)&&!e.spatialReference.equals(t)?At(e,e.spatialReference,t):e}var yT;fT=e([xe("esri.views.3d.terrain.ExtentHelperLocal")],fT),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(yT||(yT={}));const vT=[yT.ELEVATION,yT.MAP];function bT(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)-1!==i.search(".glsl")&&delete e[i]}}const xT=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let wT,TT=class extends N{constructor(e){super(e),this._handles=new lr,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=T("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||fa.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return U(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?vr(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view;this.renderer=new ya({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=Hl(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(()=>{this.setDrawTexturesDirty(),this.notifyChange("hasHighlights")})),this.renderer.events.on("has-water",(t=>e._stage?.renderView.setRenderParameters({hasOverlayWater:t}))),this.renderer.events.on("renders-occluded",(()=>{this.setDrawTexturesDirty(),this.notifyChange("rendersOccluded")})),this.renderer.events.on("content-changed",(()=>this.setDrawTexturesDirty())),this.renderer.events.on("textures-disposed",(()=>this.updateOverlayResult())),K((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),K((()=>e.state?.pixelRatio),(()=>this.setPlacementDirty()),te),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),he({preRender:e=>{this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays&&(this._dispatchAnimationUpdate(e),this._drawOverlayTextures(this.renderer.overlays,gd.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),e.resourceController.scheduler.registerTask(So.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(e,gd.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,gd.BACKGROUND,e)}))])}destroy(){this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),U(wT)&&(wT.hide(),wT=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;U(e)&&U(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new Jl(-20037508.342787,20037508.342787):new Jl(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,va)}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&U(e.setDrapingExtent)&&U(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateOverlayResult(){this.view._stage?.renderView.setRenderParameters({overlays:this.renderer.overlays})}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera,gd.UPDATE)}_updateOverlays(e,t){if(!this._spatialReference)return;const i=ba(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,i,PT);const r=jt(PT.inner)/jt(PT.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this._updateOverlay(Zd.INNER,PT.inner,i,1*PT.pixelRatioAdjustment,PT.mapUnitsPerPixel),a=this._updateOverlay(Zd.OUTER,PT.outer,i,r*PT.pixelRatioAdjustment,PT.mapUnitsPerPixel);s!==MT.EXTENT&&a!==MT.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(t)),s===MT.NONE&&a===MT.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1}_updateOverlay(e,t,i,r,s){if(0===this.renderer.overlays.length)return MT.NONE;const a=this.renderer.overlays[e],n=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=s,a.pixelRatio=r,function(e,t){const i=fa.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}(t,a.extent)&&i===a.resolution)return n===s?MT.NONE:MT.RERENDER_ONLY;Qt(a.extent,t),a.resolution=i;const o=Xt(a.extent);return a.renderLocalOrigin=xa(o[0],o[1],0,"OV_"+this._latestOriginId++),MT.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Zd.INNER],r=this.renderer.overlays[Zd.OUTER],s=Jt(e.extent,this.surface.extent,RT);this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,Zd.INNER,t),this._setTileOverlayData(s,Zd.OUTER,t)):(this._clearTileOverlayData(Zd.INNER,t),this._clearTileOverlayData(Zd.OUTER,t))}else this._clearTileOverlayData(Zd.INNER,t),this._clearTileOverlayData(Zd.OUTER,t)}overlayPixelSizeInMapUnits(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[Zd.INNER],i=this.renderer.overlays[Zd.OUTER],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent,s=jt(r),a=kt(r);let n=e[0];if(this._longitudeCyclical){n=this._longitudeCyclical.minimalMonotonic(r[0],n);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);n>t&&(n=t-(e[2]-e[0]))}i.setScale(t,jt(e)/s,kt(e)/a),i.setOffset(t,(n-r[0])/s,(e[1]-r[1])/a)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){bT(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask()}_dispatchAnimationUpdate(e){const t=ae(e.time-this._animationTimeLast);(t>=this.surface.view._stage.renderView.animationTimestep||U(this.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty)&&(this.renderer.updateAnimation({dt:t,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e.time)}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,OT,t,i);if(z(s))return!1;const a=s.origin,n=Ge(ST,s.origin,s.direction);return this._groundIntersector.reset(a,n,e),this._groundIntersector.intersect([],null),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,n),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,n=1e-5,o=Se(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+n,e.aboveGround?s-n:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=ST;Kn($n(Jn,vr(this.view.spatialReference).radius+o),rl(e.eye,e.viewForward),t),ze(t,t,e.eye);const s=$l.normalize(ro(e.viewForward,t,e.viewRight))/e.fovY+.5,a=s<=0||s>=1?.5:r;i=l?a*s:s+a*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),a=cr(0,s,1,0),n=tt(a,a,e.projectionMatrix)[1],o=Se(.5+.5*n,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&nt(t,e.eye)<a.distance*a.distance}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=Oe();this._findHorizonBasedPointOfInterest(e,s)||De(s,r);const a=Math.max(.1,qe(e.eye,s)),n=Kg(this.view.renderCoordsHelper,r,e.eye),o=Math.PI/2-Math.abs(n-Math.PI/2);fa.OVERLAY_SHOW_CENTER?(z(wT)&&(wT=new Iw(this.view.graphics,"red")),wT.show(s,this._renderSR)):U(wT)&&wT.hide(),this._overlaySREqualsRenderSR||Ot(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,h=!this._isSpherical&&U(this._spatialReference)&&this._spatialReference.isGeographic,c=h&&U(this._spatialReference)?1/vr(this._spatialReference).metersPerDegree:1,d=e.perRenderPixelRatio*a*c;i.mapUnitsPerPixel=d/this._worldToPCSRatio;let u=t*d/2,p=!1,m=h?90:1/0;this._isSpherical&&U(l)&&U(this._spatialReference)&&(this._spatialReference.isWebMercator?(u/=Math.cos(Tc(s[1])),m=l[3]):(p=!0,u/=vr(this._spatialReference).metersPerDegree,m=90),u>=m&&(u=m,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let g=1;p&&(g=1/Math.max(.2,Math.cos(Math.abs(Pe(s[1])))),u*g>180&&(g=180/u),i.mapUnitsPerPixel*=g);const f=Math.log(2)/12;u=Math.exp(Math.round(Math.log(u)/f)*f);const _=u*g,y=.5*t/(32*_),v=.5*t/(32*u);s[0]=Math.round(s[0]*y)/y,s[1]=Math.round(s[1]*v)/v;const b=i.inner;b[0]=s[0]-_,b[1]=s[1]-u,b[2]=s[0]+_,b[3]=s[1]+u,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,m);const x=i.outer;if(6*_>jt(l))Qt(x,Z(l));else if(o<=.25*Math.PI)x[0]=b[0]-_,x[1]=b[1]-u,x[2]=b[2]+_,x[3]=b[3]+u;else{Ot(e.eye,this._renderSR,ST,this._spatialReference),Cr(CT,s,ST);let t=-Math.atan2(CT[1],CT[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));it(CT,xT[i],2*u),CT[0]*=g,CT[2]*=g,ot(x,b,CT)}if(this._isSpherical)x[0]=this._longitudeCyclical.clamp(x[0]),x[2]=this._longitudeCyclical.clamp(x[2]),x[1]=Math.max(x[1],-m),x[3]=Math.min(x[3],m);else{const e=Jt(b,l,RT),t=Jt(x,l,AT);ei(e,t)&&(x[2]=x[0],x[3]=x[1])}const w=Math.abs(b[2]-b[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,w),i.pixelRatioAdjustment=i.mapUnitsPerPixel/w}_drawOverlayTextures(e,t,i=this.view.state.camera){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const r=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const s=this._drawOverlay(e[Zd.INNER],i),a=this._drawOverlay(e[Zd.OUTER],i);s!==fd.CHANGED&&a!==fd.CHANGED||this.surface.updateTileOverlayParams(gd.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),r?(this.surface.requestRender(t),t===gd.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(gd.BACKGROUND)}_drawOverlay(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return!z(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):qt(e,t))}_rectInsideRect(e,t){return!z(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:ei(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),zt(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};e([ve()],TT.prototype,"_spatialReference",void 0),e([ve({readOnly:!0})],TT.prototype,"running",null),e([ve()],TT.prototype,"_placementDirty",void 0),e([ve()],TT.prototype,"_contentUpdated",void 0),e([ve()],TT.prototype,"_isSpherical",null),e([ve()],TT.prototype,"_worldToPCSRatio",null),e([ve()],TT.prototype,"renderer",void 0),e([ve({constructOnly:!0})],TT.prototype,"surface",void 0),e([ve({readOnly:!0,aliasOf:"surface.suspended"})],TT.prototype,"suspended",void 0),e([ve({readOnly:!0})],TT.prototype,"updating",null),e([ve({type:Boolean})],TT.prototype,"hasHighlights",null),e([ve({type:Boolean})],TT.prototype,"rendersOccluded",null),TT=e([xe("esri.views.3d.terrain.OverlayManager")],TT);const CT=hr(),ST=Oe(),PT={inner:Vt(),outer:Vt(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},RT=Vt(),AT=Vt(),OT=sl();var MT;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(MT||(MT={}));class ET{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map}acquire(e){if(!ET.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(t){const i=window.performance&&window.performance.memory;let r="";throw i&&(r=`\n  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+t+r),t}}release(e){if(ET.test.disabled)return;const t=this._lengthCallback(e);let i=this._pool.get(t);i||(i=new le({shrink:!0}),this._pool.set(t,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}ET.test={disabled:!1};class DT{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Lh(),this.indexCount=0,this.numVerticesPerSide=0,this.uvOffsetAndScale=hr(),this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]}}class IT{constructor(e,t,i,r,s){this._buf=e,this._localOrigin=t,this.offset0=i,this.stride=r,this.count=s}getVertexOffset(e){return Uc(0<=e&&e<this.count),this.offset0+this.stride*e}getVertex(e,t){const i=this.getVertexOffset(t)*zd;e[0]=this._buf[i+0]+this._localOrigin[0],e[1]=this._buf[i+1]+this._localOrigin[1],e[2]=this._buf[i+2]+this._localOrigin[2]}getVertexZ(e){const t=this.getVertexOffset(e)*zd;return this._buf[t+2]+this._localOrigin[2]}setVertex(e,t,i,r){const s=this.getVertexOffset(e)*zd;this._buf[s+0]=t[0]-this._localOrigin[0],this._buf[s+1]=t[1]-this._localOrigin[1],this._buf[s+2]=t[2]-this._localOrigin[2],this._buf[s+3]=i,this._buf[s+4]=r}getNormal(e,t){const i=this.getVertexOffset(t)*zd;e[0]=this._buf[i+5],e[1]=this._buf[i+6],e[2]=this._buf[i+7]}setVertexRawXYZUV(e,t,i,r,s,a){const n=this.getVertexOffset(e)*zd;this._buf[n+0]=t,this._buf[n+1]=i,this._buf[n+2]=r,this._buf[n+3]=s,this._buf[n+4]=a}setVertexRawXYZUVN(e,t,i,r,s,a,n,o,l){const h=this.getVertexOffset(e)*zd;this._buf[h+0]=t,this._buf[h+1]=i,this._buf[h+2]=r,this._buf[h+3]=s,this._buf[h+4]=a,this._buf[h+5]=n,this._buf[h+6]=o,this._buf[h+7]=l}setVertexRawNormal(e,t,i,r){const s=this.getVertexOffset(e)*zd;this._buf[s+5]=t,this._buf[s+6]=i,this._buf[s+7]=r}getVertexRawNormal(e,t){const i=this.getVertexOffset(t)*zd;e[0]=this._buf[i+5],e[1]=this._buf[i+6],e[2]=this._buf[i+7]}}const LT=Do().vec3f(yn.POSITION).vec2f(yn.UV0).vec3f(yn.NORMAL),NT=new ET((e=>LT.createBuffer(e)),(e=>e.count));function FT(e){return NT.acquire(e)}class VT{constructor(){this.elevation=0,this.normal=[0,0,1],this.cornerTiles=[null,null,null,null]}}class UT{constructor(){this.edgeNeighbours=[null,null,null,null],this.cornerNeighborData=[new VT,new VT,new VT,new VT],this.edgeResolutions=[1,1,1,1],this.modifiedEdgeResolutions=[!1,!1,!1,!1]}}class zT{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.samplerDataVersion=0,this.neighborData=new UT}}class jT{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=k(this._current),this._next=k(this._next),this._waiting=k(this._waiting),this._delayed=k(this._delayed)}get current(){if(z(this._current))return null;if(!this._isFadingEnabled){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=jT.test.fadeMoment;if(U(this._delayed)&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,kT.Immediate),this._delayed=null)),U(this._next)){e=e||performance.now();const t=this._fadeDuration,i=U(this._current)&&this._next.texture===this._current.texture,r=this._next.type!==Xd.FADING,s=e-this._fadeStart>=t;(i||r||s)&&(k(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(z(this._next))return 1;const e=jT.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return U(this._next)||U(this._delayed)}push(e,t=kT.Immediate){this._delayed=k(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),z(this._current))return void(this._current=e);const i=jT.test.fadeMoment||performance.now();return t!==kT.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):z(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(z(e)||(k(this._waiting),this._waiting=e))}get _fadeDuration(){return z(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}}var kT;jT.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(kT||(kT={}));class GT{constructor(){this._queue=new le,this._last=null,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=null}reset(e=null){this._queue.clear(),U(e)&&this._queue.pushArray(e),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class qT{constructor(){this.q=new le}get done(){return 0===this.q.length}reset(e){if(this.q.clear(),!z(e)){this.q.pushArray(e);for(let e=0;e<this.q.length;++e){const t=this.q.data[e];t.isLeaf||this.q.pushArray(t.children)}}}next(){return this.q.pop()}}function BT(e,t,i){if(z(t)||z(t.fullExtent))return!1;const r=t.fullExtent,s=e.extent;if(i){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale;return!(t.minScale>0&&a>1.00000001*t.minScale||t.maxScale>0&&a<.99999999*t.maxScale)}function HT(e,t){return e.lij[0]-t.lij[0]||e.lij[1]-t.lij[1]||e.lij[2]-t.lij[2]}function WT(e,t){t.sort(((t,i)=>QT(t,i,e)))}function QT(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:HT(e,t)}function ZT(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,a=1<<s[0]-r[0];return Math.floor(s[1]/a)===r[1]&&Math.floor(s[2]/a)===r[2]}class XT{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,Xd.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return U(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),r=zc(i),{minLevel:s,maxLevel:a}=i.dataLevelRange,n=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+n,l=this._scaleRangeEnabled?BT:()=>!0;let h=this.tile;const c=h.level;let d;const u=this._tileLayerInfo.upsampleInfo,p=U(u)?u.tile.level:-1,m=!!U(u)&&p-c>=n,g=X(r,"tilemapCache");for(;h&&l(h,r,!1)&&h.level>=s;){const i=h.level,r=c-i,l=h.layerInfo[t][e];if(l.data&&r>=n){(!m||i>p)&&this._setUpsampleTile(h),l.dataInvalidated&&(d=h);break}if((z(g)||"unavailable"!==g.getAvailability(h.lij[0],h.lij[1],h.lij[2]))&&i<=a&&!l.data&&!l.dataMissing&&((z(d)||h.level===s||i%kd==0||c-d.level<n)&&(d=h),r>=o))break;h=h.parent}return U(d)&&c-d.level<n&&this._tileLayerInfo.upsampleInfo&&(d=null),d}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,Xd.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const YT=new Error("Abstract method called on TileAgent"),KT=new class extends XT{get _desiredMinLevelDelta(){throw YT}get _progressiveLevelModulo(){throw YT}dispose(){}};class $T extends XT{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return Gd(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class JT extends XT{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return kd}}var eC,tC,iC,rC;!function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(eC||(eC={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(tC||(tC={})),function(e){e[e.OneMinusSourceAlpha=0]="OneMinusSourceAlpha",e[e.SourceAlpha=1]="SourceAlpha",e[e.COUNT=2]="COUNT"}(iC||(iC={})),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(rC||(rC={}));const sC={normal:rC.Normal,average:rC.Average,lighten:rC.Lighten,lighter:rC.Lighter,screen:rC.Screen,plus:rC.Plus,"color-dodge":rC.ColorDodge,darken:rC.Darken,multiply:rC.Multiply,"color-burn":rC.ColorBurn,overlay:rC.Overlay,"soft-light":rC.SoftLight,"hard-light":rC.HardLight,"vivid-light":rC.VividLight,hue:rC.Hue,saturation:rC.Saturation,luminosity:rC.Luminosity,color:rC.Color,difference:rC.Difference,exclusion:rC.Exclusion,minus:rC.Minus,invert:rC.Invert,reflect:rC.Reflect,"destination-over":rC.DestinationOver,"destination-atop":rC.DestinationAtop,"destination-in":rC.DestinationIn,"destination-out":rC.DestinationOut,"source-atop":rC.SourceAtop,"source-in":rC.SourceIn,"source-out":rC.SourceOut,xor:rC.Xor};function aC(e){return e===rC.DestinationOver||e===rC.DestinationAtop||e===rC.DestinationIn||e===rC.DestinationOut||e===rC.SourceAtop||e===rC.SourceIn||e===rC.SourceOut||e===rC.Xor}function nC(e){e.fragment.uniforms.add([new Ns("u_colormap",(e=>e.u_colormap)),new Vs("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new Vs("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new Vs("u_opacity",(e=>e.common.u_opacity))]),e.fragment.code.add(an`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
result = texture2D(u_colormap, clrPosition);
}
return result;
}`)}function oC(e){e.fragment.uniforms.add(new Ns("u_transformGrid",(e=>e.u_transformGrid))),e.fragment.uniforms.add(new Ps("u_transformSpacing",(e=>e.common.u_transformSpacing))),e.fragment.uniforms.add(new Ps("u_transformGridSize",(e=>e.common.u_transformGridSize))),e.fragment.uniforms.add(new Ps("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add(an`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}class lC extends on{constructor(){super(...arguments),this.scale=1,this.offset=Pr}}function hC(e){e.attributes.add(yn.POSITION,"vec2"),e.attributes.add(yn.UV0,"vec2"),e.vertex.uniforms.add(new Vs("scale",(e=>e.scale))),e.vertex.uniforms.add(new Ps("offset",(e=>e.offset))),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.code.add(an`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}class cC extends lC{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function dC(e){e.include(oC),e.fragment.uniforms.add([new Ns("u_image",(e=>e.u_image)),new Jr("u_flipY",(e=>e.common.u_flipY)),new Jr("u_applyTransform",(e=>e.common.u_applyTransform))]),e.fragment.code.add(an`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}function uC(e){e.code.add(an`
    float lineFactorAtPosition(float value) {
      float pos = value * ${an.float(257)};
      if(pos < 0.5 || pos > ${an.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec4 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec4(vec3(1.0, 0.972, 0.918) * line, 1.0);
    }`)}var pC,mC,gC;function fC(e,t){const i=t.blendMode;i!==rC.Normal&&(i===rC.Reflect&&e.code.add(an`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==rC.ColorDodge&&i!==rC.VividLight||e.code.add(an`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==rC.ColorBurn&&i!==rC.VividLight||e.code.add(an`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===rC.Overlay&&e.code.add(an`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===rC.HardLight&&e.code.add(an`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===rC.SoftLight&&e.code.add(an`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===rC.VividLight&&e.code.add(an`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==rC.Hue&&i!==rC.Saturation&&i!==rC.Color&&i!==rC.Luminosity||(e.code.add(an`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==rC.Hue&&i!==rC.Saturation||e.code.add(an`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(an`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===rC.Multiply?an`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Average?an`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Lighten?an`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Darken?an`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Lighter?an`return vec4(cl * ol + cb * ob, ol + ob);`:i===rC.Plus?an`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===rC.Minus?an`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===rC.Screen?an`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Difference?an`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Invert?an`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===rC.DestinationOver?an`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===rC.DestinationAtop?an`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===rC.DestinationOut?an`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===rC.SourceAtop?an`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===rC.SourceOut?an`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===rC.Xor?an`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===rC.DestinationIn?an`return vec4(cb * ob * ol, ol * ob);`:i===rC.SourceIn?an`return vec4(cl * ol * ob, ol * ob);`:i===rC.Hue?an`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Saturation?an`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Color?an`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Luminosity?an`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Exclusion?an`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Reflect?an`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.ColorDodge?an`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.ColorBurn?an`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.Overlay?an`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.SoftLight?an`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.HardLight?an`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===rC.VividLight?an`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:an``}
    }
  `))}!function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(pC||(pC={})),function(e){e[e.Composite=0]="Composite",e[e.ColorOnly=1]="ColorOnly",e[e.GridOnly=2]="GridOnly",e[e.ColorComposite=3]="ColorComposite",e[e.GridComposite=4]="GridComposite",e[e.COUNT=5]="COUNT"}(mC||(mC={})),function(e){e[e.One=0]="One",e[e.OnBackground=1]="OnBackground",e[e.OnBaseLayer=2]="OnBaseLayer",e[e.COUNT=3]="COUNT"}(gC||(gC={}));const _C=Object.freeze(Object.defineProperty({__proto__:null,get BlendLayersOutput(){return mC},get BaseOpacityMode(){return gC},build:function(e){const t=new ws,i=e.output===mC.GridOnly,r=e.output===mC.GridComposite,s=r||i,a=e.output===mC.ColorOnly,n=e.output===mC.ColorComposite,o=n||a,l=r||n;if(t.include(hC),o&&t.fragment.uniforms.add(new Cs("backgroundColor",(e=>e.backgroundColor))),e.baseOpacityMode!==gC.One&&t.fragment.uniforms.add(new Vs("baseOpacity",(e=>e.baseOpacity))),s&&(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(uC)),i||a)return t.fragment.code.add(an`
    void main() {
      gl_FragColor = ${a?an`vec4(backgroundColor, 1.0)`:an`gridColor(uv)`};
    }
  `),t;const h=e.blendMode!==rC.Normal,c=e.baseOpacityMode===gC.OnBaseLayer,d=e.baseOpacityMode===gC.OnBackground||e.baseOpacityMode===gC.OnBaseLayer,u=e.premultipliedSource;return t.fragment.uniforms.add(new Ns("tex",(e=>e.texture))),t.fragment.uniforms.add(new Vs("opacity",(e=>e.opacity))),(h||c||u)&&(t.fragment.uniforms.add(new Ns("fboColor",(e=>e.fboTexture))),t.fragment.uniforms.add(new Vs("tileSize",(e=>U(e.fboTexture)?e.fboTexture.descriptor.width:1)))),t.fragment.include(fC,e),t.fragment.code.add(an`
    void main() {
      ${l||c||u?an`
      vec4 bgColor = ${n?an`vec4(backgroundColor, 1.0)`:r?an`gridColor(uv)`:an`texture2D(fboColor, gl_FragCoord.xy / tileSize)`};
      ${d?an`bgColor *= baseOpacity;`:""}`:""}
      vec4 colorLayer = texture2D(tex, uv);
      ${h?an`
          vec4 fboTex = ${l?an`bgColor;`:an`texture2D(fboColor, gl_FragCoord.xy / tileSize) ${c?" * baseOpacity":""};`}
          vec3 Cb = fboTex.a == 0.0 ? fboTex.rgb : vec3(fboTex.rgb * fboTex.a);
          gl_FragColor = applyBlendMode(colorLayer.rgb, colorLayer.a * opacity, Cb, fboTex.a);`:an`
          vec4 pmColorLayer = vec4(colorLayer.xyz, 1.0);
          float composeAlpha = colorLayer.a * opacity;
          gl_FragColor = ${u?an`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`:l||c?an`mix(bgColor, pmColorLayer, composeAlpha);`:an`pmColorLayer * composeAlpha;`}`}
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class yC extends cC{constructor(e,t,i,r,s,a){super(e,r,s),this.colormap=t,this.symbolizer=i,this.u_colormap=a,this.backgroundColor=Je,this.fboTexture=null,this.baseOpacity=1}}const vC=Object.freeze(Object.defineProperty({__proto__:null,ColorizerUniforms:yC,ColorizerStretchUniforms:class extends yC{},ColorizerHillshadeUniforms:class extends yC{},build:function(e){const t=new ws;t.include(hC),t.include(dC),t.include(nC),e.tileBlendInput===pC.GridComposite&&(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(uC));const i=e.tileBlendInput===pC.ColorComposite;i&&t.fragment.uniforms.add(new Cs("backgroundColor",(e=>e.backgroundColor))),e.baseOpacityMode!==gC.One&&t.fragment.uniforms.add(new Vs("baseOpacity",(e=>e.baseOpacity)));const r=e.baseOpacityMode===gC.OnBaseLayer,s=e.baseOpacityMode===gC.OnBackground||e.baseOpacityMode===gC.OnBaseLayer,a=e.blendMode!==rC.Normal;t.fragment.include(fC,e);const n=e.tileBlendInput!==pC.LayerOnly;return(a&&!n||r)&&(t.fragment.uniforms.add(new Ns("fboColor",(e=>e.fboTexture))),t.fragment.uniforms.add(new Vs("tileSize",(e=>U(e.fboTexture)?e.fboTexture.descriptor.width:1)))),t.fragment.code.add(an`
    vec4 applyBackgroundBlend(vec4 layerColor) {
      ${n||r?an`
          vec4 bgColor = ${r?an`texture2D(fboColor, gl_FragCoord.xy / tileSize)`:i?an`vec4(backgroundColor, 1.0)`:an`gridColor(vuv)`};
          ${s?an`bgColor *= baseOpacity;`:""}`:""}
      ${a?an`
            vec3 pmColorLayer = layerColor.rgb * layerColor.a;
            vec4 fboTex = ${n?an`bgColor;`:an`texture2D(fboColor, gl_FragCoord.xy / tileSize) ${r?" * baseOpacity":""};`}
            vec3 Cb = fboTex.a == 0.0 ? fboTex.rgb : vec3(fboTex.rgb * fboTex.a);
            return applyBlendMode(pmColorLayer.rgb, layerColor.a * u_opacity, Cb, fboTex.a);`:n||r?an`
            float composeAlpha = layerColor.a * u_opacity;
            vec4 pmColorLayer = vec4(layerColor.rgb, 1.0);
            return mix(bgColor, pmColorLayer, composeAlpha);`:an`
            return layerColor * layerColor.a * u_opacity;`}
    }
  `),e.colorizerType===eC.Stretch?function(e,t){e.fragment.uniforms.add([new es("u_bandCount",(e=>e.symbolizer.u_bandCount)),new ts("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new ts("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new ts("u_factor",(e=>e.symbolizer.u_factor),3),new Vs("u_minOutput",(e=>e.symbolizer.u_minOutput)),new Vs("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new Jr("u_useGamma",(e=>e.symbolizer.u_useGamma)),new ts("u_gamma",(e=>e.symbolizer.u_gamma),3),new ts("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new Vs("u_opacity",(e=>e.common.u_opacity))]),e.fragment.code.add(an`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?an`gl_FragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:an`gl_FragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.code.add(an`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${t.stretchType===tC.Noop?an`
        gl_FragColor = applyBackgroundBlend(currentPixel);`:an`
        if (currentPixel.a == 0.0) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}(t,e):e.colorizerType===eC.Lut?function(e){e.fragment.code.add(an`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}(t):e.colorizerType===eC.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add([new Ns("u_image",(e=>e.u_image)),new es("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new ts("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new ts("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new ts("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new ts("u_weights",(e=>e.symbolizer.u_weights),6),new Ps("u_factor",(e=>e.symbolizer.u_factor)),new Vs("u_minValue",(e=>e.symbolizer.u_minValue)),new Vs("u_maxValue",(e=>e.symbolizer.u_maxValue)),new Ps("u_srcImageSize",(e=>e.common.u_srcImageSize))]),i.include(Ds),i.code.add(an`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec3 hsv = rgb2hsv(colormap(vec4(val, val, val, 1.0), false).rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),i.code.add(an`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?an`gl_FragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:an`hillshade *= alpha;
gl_FragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.code.add(an`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}
    }
  `)}(t,e),t}},Symbol.toStringTag,{value:"Module"})),bC={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class xC{constructor(e,t,i=null,r=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=e,this.source=t,this.width=i||t.width,this.height=r||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=B(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...bC,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||bC}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){U(e)&&e.length>0?this._bandIds&&e.every(((e,t)=>!!this._bandIds[t]&&e===this._bandIds[t]))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,U(this._rasterTexture)){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?Rn.LINEAR:Rn.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=B(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((z(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(e,this.bandIds),U(this._rasterTexture)&&(this._updateColormapTexture(e),this.transformGrid&&z(this._transformGridTexture)&&(this._transformGridTexture=tu(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:r,opacity:s}=this,a=iu(t,[i,r],[this.source.width,this.source.height],s),n=ru(e.colormap,e.colormapOffset),o="stretch"===this.symbolizerParameters.type?su(this.symbolizerParameters):null,l="hillshade"===this.symbolizerParameters.type?au(this.symbolizerParameters):null;return new yC(a,n,o||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get memoryUsage(){if(z(this._memoryUsed)){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map((e=>U(e)?e.descriptor.width*e.descriptor.height*4:0)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=B(this._rasterTexture),this._transformGridTexture=B(this._transformGridTexture),this._colormapTexture=B(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=B(this._rasterTexture));const r=z(t)&&z(this.bandIds)||U(t)&&U(this.bandIds)&&t.join("")===this.bandIds.join("");if(U(this._rasterTexture)&&r)return;this._rasterTexture=B(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=nu(e,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some(((e,i)=>e!==t[i]))?(this._colormapTexture=B(this._colormapTexture),this._colormapTexture=ou(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=ou(e,i),void(this._colormap=i)):(this._colormapTexture=B(this._colormapTexture),void(this._colormap=null))}}class wC{constructor(){this.waitingAgents=new le,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=TC.acquire();return t._init(e),t}release(){this.dispose(),CC.delete(this),TC.release(this)}dispose(){this.loadingAgent=B(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=jc(this._data)}static prune(){TC.prune(0)}_init(e){this.waitingAgents.clear(),this._data=jc(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=G(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){U(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e===t||z(t))this._unsetUpsampleInfo();else{if(z(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),function(e,t,i){let r=1,s=0,a=0;for(;e!==t;)if(r*=.5,s*=.5,a*=.5,1&e.lij[2]&&(s+=.5),0==(1&e.lij[1])&&(a+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,a,r)}(e,t,this._upsampleInfo)}}get data(){return this._data}set data(e){jc(this._data),this._data=e}}const TC=new vc(wC,null,(()=>{})),CC=new Map;class SC{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}var PC;!function(e){e[e.NONE=0]="NONE",e[e.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",e[e.SPLIT=2]="SPLIT",e[e.VSPLITMERGE=4]="VSPLITMERGE",e[e.MERGE=8]="MERGE",e[e.RENDERDATA=16]="RENDERDATA",e[e.GEOMETRY=32]="GEOMETRY",e[e.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=128]="TEXTURE_FADING"}(PC||(PC={}));const RC=Oe(),AC=Oe(),OC=Oe();class MC{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class EC{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=Vt(),this._elevationBounds=Sr(),this.layerInfo=[[],[]],this.extentInRadians=Vt(),this.centerAtSeaLevel=Oe(),this._center=[Oe(),eo(),Oe()],this.up=lt(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){LC.prune(0),NC.prune(0),wC.prune()}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[VC.MIDDLE][3]}get screenDepth(){return this._screenDepth}get visible(){return this._dirty&&this.computeVisibility(),this._visible}computeVisibility(){this._dirty=!1;const e=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return!1;if(this._surface.lodSnapping===Yd.ON){const e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=vr(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[VC.MIDDLE][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?Tr(this._elevationBounds,t.elevationBounds):xr(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const e of vT){const t=i.numLayers(e),r=this.layerInfo[e];for(const e of r)e.release();r.length=t;for(let i=0;i<t;i++)r[i]=wC.acquire(this._surface.upsampleInfoPool),e===yT.ELEVATION&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,jd)}release(){kc(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of vT){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null,this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this.isCached){this.setMemoryDirty();const e=this.cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this.isCached?0:this._mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[yT.MAP].reduce(((e,t)=>e+(t instanceof Ld?t.memoryUsage:0)),this._mapTileMemory)}get cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(U(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemory=0;let e=0;for(const{data:t}of this.layerInfo[yT.MAP])t instanceof Ld?e+=this._getTerrainDataMemory(t):this._mapTileMemory+=this._getTerrainDataMemory(t);const t=this.cpuImageMemorySize;for(const e of this.layerInfo[yT.ELEVATION])this._usedMemory+=e.data?t:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=zo(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemory+e),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?e===yT.MAP?this.isCached?0:this._getTerrainDataMemory(i.data):e===yT.ELEVATION?this.cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof SC?zo(e.texture):e instanceof HTMLImageElement||e instanceof Gc?this.cpuImageMemorySize:e instanceof Ld||e instanceof xC?e.memoryUsage:0}updateScreenDepth(e){const t=this._center[VC.MIDDLE],i=e,r=t[0],s=t[1],a=t[2],n=i[2]*r+i[6]*s+i[10]*a+i[14];this._screenDepth=n<0?0:n/(i[3]*r+i[7]*s+i[11]*a+i[15])}shouldSplit(e,t,i){if(U(e.frustum)&&(!this._intersectsClippingArea||!this._isVisible(e.frustum)))return PC.NONE;const r=this.level;ze(RC,this._center[VC.MIDDLE],t);let s=Be(RC),a=VC.MIDDLE;ze(AC,this._center[VC.TOP],t);const n=Be(AC);n<s&&(s=n,a=VC.TOP),ze(AC,this._center[VC.BOTTOM],t);const o=Be(AC);if(o<s&&(s=o,a=VC.BOTTOM),this._edgeLen2>s&&r<e.maxLod)return PC.SPLIT;const l=Math.sqrt(s),h=e.fovX*l*2,c=this._edgeLen/h,d=()=>{const t=r+Math.ceil(-Math.log2(e.relativeWidthLimit/c));return t!==this.vlevel?(this.vlevel=t,PC.VSPLITMERGE):PC.NONE_HIT_MAXLOD};if(i===Yd.ON&&1==this._surface.snapLevel-r)return r>=e.maxLod?d():PC.SPLIT;const u=je(this.up,RC),p=this._elevationBounds[1]-this._elevationBounds[0],m=p/this.edgeLen;if(e.aboveGround&&u>0&&m<.001&&u/l-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-m>0)return PC.NONE;if(c<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,PC.VSPLITMERGE):PC.NONE;if(r>=e.maxLod)return d();if(r>6){ze(AC,this._center[a],t),Ue(OC,this.up,u),ze(OC,OC,AC);const i=Be(OC);if(i>this.radius*this.radius){Ue(OC,OC,this.radius/Math.sqrt(i)),Ge(OC,OC,this._center[a]),ze(OC,t,OC);const r=Math.min(1,(Math.abs(je(OC,this.up))+.5*p+this._curvatureHeight)/Ee(OC)),s=.1/e.angledSplitBias,n=e.fovY*l*2;if(r*(this._edgeLen/n)<s*e.relativeHeightLimit)return PC.NONE}}return PC.SPLIT}setChildren(e,t,i,r){kc(!!(e&&t&&i&&r),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){return this.renderData?.hasGeometry??!1}prepareToLoad(e){this.refMapData();for(const e of vT)this._createOrUpdateAgents(0,e);e.updateTileGeometryState(this)}load(e){this.prepareToLoad(e),this.loadPrepared(e)}loadPrepared(e){e.loadTile(this)}unload(e){e.unloadTile(this);for(const e of vT){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==KT&&(IC(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(PC.GEOMETRY),this.resetPendingUpdate(PC.TEXTURE_NOFADING),this.resetPendingUpdate(PC.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[yT.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==KT&&(IC(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if($t(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;U(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._isWithinClippingArea,s=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(PC.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of vT){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==KT&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(PC.SPLIT)||e!==yT.ELEVATION&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,e===PC.SPLIT||e===PC.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(r.requestPromise)return!0;G(r.requestAbort),r.requestAbort=new AbortController;const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const a=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(a,a),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){return this.hasLij(e)?this:this.isLeaf?null:this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e)||null}distanceToSquared(e){return Be(ze(OC,this._center[VC.MIDDLE],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents,a=null!=s.removeUnordered(i);kc(a,"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll((e=>e.dataArrived(this))),r.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll((e=>e.dataMissing())),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t){switch(e){case yT.MAP:return this._updateTexture(t);case yT.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===Xd.FADING?PC.TEXTURE_NOFADING:PC.TEXTURE_FADING),this.setPendingUpdate(e===Xd.FADING?PC.TEXTURE_FADING:PC.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(PC.GEOMETRY);for(const e of this.layerInfo[yT.ELEVATION])e.pendingUpdates|=PC.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBounds;xr(e,Number.MAX_VALUE,-Number.MAX_VALUE);const t=this.layerInfo[yT.ELEVATION];let i=!0;for(const r of t)U(r.elevationBounds)&&(e[0]=Math.min(e[0],r.elevationBounds.min),e[1]=Math.max(e[1],r.elevationBounds.max),r.elevationBounds.hasNoDataValues||(i=!1));i&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const e=this._elevationBounds,t=.5*(e[0]+e[1]);Ue(OC,this.up,t),Ge(this._center[VC.MIDDLE],this.centerAtSeaLevel,OC),Ue(OC,this.up,e[0]),Ge(this._center[VC.TOP],this.centerAtSeaLevel,OC),Ue(OC,this.up,e[1]),Ge(this._center[VC.BOTTOM],this.centerAtSeaLevel,OC)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[yT.ELEVATION][e];if(U(i.elevationBounds)&&i.elevationBounds.level>=t)return;const r=this._surface.layerViewByIndex(e,yT.ELEVATION);if(!BT(this,zc(r),!1))return;const s=FC;let a=!1;if(i.data){const e=i.data;s.min=e.bounds[0],s.max=e.bounds[1],s.hasNoDataValues=e.hasNoDataValues,s.level=this.level,a=!0}else{let t,i,r=0;for(let s=this._parent;s&&(!i||r<Gd(this.level))&&(r=this.vlevel-s.level,t=i||t,i=s.layerInfo[yT.ELEVATION][e].data,!(!i&&t&&r>=Gd(this.level)));s=s.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],s),s.min!==1/0&&(s.level=i.level,a=!0))}a&&(z(i.elevationBounds)&&(i.elevationBounds=new cT),i.elevationBounds.copyFrom(s))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==KT&&(IC(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].release();const s=new Array(...r),a=t.length;r.length=a;for(let e=0;e<a;e++){const i=t[e];r[e]=i>-1?s[i]:wC.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,Xd.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===KT&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of vT){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==KT&&(i.loadingAgent.setSuspension(t),i.loadingAgent===KT&&this.updateRenderData(e,Xd.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==KT&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=KT,!i.data&&z(i.upsampleInfo)&&this._createOrUpdateAgents(e+1,t)}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const r=(()=>{for(let r=e;r<i.length;++r){const e=this._surface.layerViewByIndex(r,t);if(qc(e)&&"normal"!==e.layer.blendMode)return!0}return!1})(),s=this._isSuspended(t);for(let a=e;a<i.length;++a){const e=i[a];let n=!1;const o=this._surface.layerViewByIndex(a,t),l=zc(o);if(e.loadingAgent?BT(this,l,!1)?(e.loadingAgent!==KT&&e.loadingAgent.setSuspension(s),e.loadingAgent!==KT&&(n=e.loadingAgent.update())):e.dispose():BT(this,l,!1)&&(e.loadingAgent=DC(this,a,t,s),n=e.loadingAgent.startLoading(),n?e.loadingAgent===KT&&this.setPendingUpdate(PC.GEOMETRY):(IC(e.loadingAgent),e.loadingAgent=KT)),e.loadingAgent===KT&&this.updateRenderData(t,Xd.FADING),!r&&n&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationBasedVerticesPerSide(e){const t=this.vlevel-this.level,i=Math.max(this.level-e,Gd(this.level)-t);return Se(1+(this.maxTesselation>>i),2,this.maxTesselation+1)}get test(){return{cachedMemory:this.cachedMemory}}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(U(i))for(const r of i)if(UC(r,e)){let i=r,s=e[0]-i.level-1;for(;s>=0&&!i.isLeaf&&!t(i);){const t=e[1]>>s&1,r=e[2]>>s&1;i=i.children[2*t+r],s--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this.lij,r=this.getNeighborLIJ(i,e);return r?(a=r,(s=i)[0]===a[0]&&s[1]===a[1]&&s[2]===a[2]?t(this)?this:null:this._findLIJ(r,t)):null;var s,a}findCorner(e,t){const i=e===Kd.NORTH_EAST?1:e===Kd.NORTH_WEST?0:e===Kd.SOUTH_WEST?2:3;let r=this;for(;!(r.isLeaf||t&&t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner(Bc(e),t)}forAllSubtreeOnSide(e,t){const i=e===Kd.NORTH?[0,1]:e===Kd.NORTH_EAST?[1]:e===Kd.EAST?[1,3]:e===Kd.SOUTH_EAST?[3]:e===Kd.SOUTH?[2,3]:e===Kd.SOUTH_WEST?[2]:e===Kd.WEST?[0,2]:[0],r=e=>{t(e)||e.isLeaf||i.forEach((t=>r(e.children[t])))};r(this)}forallNeighbors(e){Hc.forEach((t=>this.findNeighborCornerTileExact(t,e))),Wc.forEach((t=>this.findNeighborTile(t,(t=>t.level===this.level||e(t)))?.forAllSubtreeOnSide(Qc(t),e)))}getNeighborEdgeStartVertexIndex(e,t){const i=t??this.findNeighborTile(Wc[e],(e=>e.isLoaded));if(!i||!this.isLoaded||!i.isLoaded)return 0;const r=this.level-i.level;if(0===r)return 0;const s=2**r,a=1==(1&e),n=a?0:1,o=i.lij[n+1]*s,l=this.lij[n+1]-o;return a?s-1-l:l}_updateNeighborsWithChangedEdgeResolution(){for(let e=0;e<4;++e)if(this.renderData.geometryState.neighborData.modifiedEdgeResolutions[e]){const t=Wc[e],i=this.findNeighborTile(t,(e=>e.isLoaded||e.level===this.level));if(!i)continue;if(!i.isLoaded){Uc(!i.isLeaf);const r=(e+2)%4,s=Qc(t);i.forAllSubtreeOnSide(s,(e=>e.isLoaded?(e.updateEdgeAfterResolutionChange(r),!0):(Uc(!e.isLeaf),!1)))}this.renderData.geometryState.neighborData.modifiedEdgeResolutions[e]=!1}}updateNeighborDataAndGeometryIfNeeded(){this.isLoaded&&this.renderData.updateNeighborDataAndGeometryIfNeeded()}updateNeighborsAfterGeometryChange(e=this.level){this.forEachLoadedNeighbor((e=>this._updateNeighbor(e))),Wc.forEach((t=>{this.findNeighborTile(t,(t=>t.isLoaded&&t.level<e))?.updateNeighborsWithChangedEdgeResolution()}))}updateNeighborsWithChangedEdgeResolution(){this.isLoaded&&this._updateNeighborsWithChangedEdgeResolution()}updateEdgeAfterResolutionChange(e){this.renderData.updateEdgeAfterResolutionChange(e)}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.isLoaded;Wc.forEach(((t,r)=>{const s=this.findNeighborTile(t,i);null!=s&&s!==this&&s.forAllSubtreeOnSide(Qc(t),(t=>!!t.isLoaded&&(e(t),!0)));const a=this.renderData?.geometryState?.neighborData;a&&(a.modifiedEdgeResolutions[r]=!1)})),Hc.forEach((t=>{const r=this.findNeighborTile(t,i)?.findCorner(Bc(t),(e=>e.isLoaded));Uc(!r||function(e,t,i){return!z(e)&&!z(t)&&t!==e&&(e.level>=t.level?jC(e,t,i):jC(t,e,Bc(i)))}(this,r,t)),r?.isLoaded&&e(r)}))}_updateNeighbor(e){e?.isLoaded&&e.updateNeighborDataAndGeometryIfNeeded()}getNeighborLIJ(e,t){const i=Zc(t)?-1:Xc(t)?1:0,r=Yc(t)?-1:Kc(t)?1:0,s=[e[0],e[1]+i,e[2]+r];return s[1]<0?null:this.surface.isGlobal?this.wrapLIJ(s):s[2]<0?null:s}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return 0===this.lij[2]}get isNorthEnd(){return 0===this.lij[1]}get isSouthEnd(){return this.extent[1]+eu>=this.surface.extent[1]}compareLIJs(e){const t=this.lij,i=t[0],r=e[0];if(i===r)return[t,e];const s=i-r;if(s<0){const i=2**-s;return[[r,t[1]*i,t[2]*i],e]}{const r=2**s;return[t,[i,e[1]*r,e[2]*r]]}}checkGeometryWaterproofness(){}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if(Zc(e)&&t[3]+r>=i[3])return!1;if(Xc(e)&&t[1]-r<=i[1])return!1;const s=this.surface.isGlobal;return!(!s&&Yc(e)&&t[0]-r<=i[0]||!s&&Kc(e)&&t[2]+r>=i[2])}}function DC(e,t,i,r){const s=i===yT.ELEVATION?NC.acquire():LC.acquire();return s.init(e,t,i,r),s}function IC(e){e.dispose(),e instanceof $T?NC.release(e):e instanceof JT&&LC.release(e)}const LC=new vc(JT),NC=new vc($T),FC=new cT;var VC;function UC(e,t){const i=e.level,r=t[0];if(i>r)return!1;const s=r-i,a=Math.floor(t[1]/2**s),n=Math.floor(t[2]/2**s);return a===e.lij[1]&&n===e.lij[2]}function zC(e,t,i){return Math.abs(e-t)<=i}function jC(e,t,i){Uc(e.level>=t.level);const r=$c(i),s=Jc(i),a=e.extent,n=t.extent,o=[r?a[0]:a[2],s?a[3]:a[1]],l=[r?n[2]:n[0],s?n[1]:n[3]],h=1e-5*(a[2]-a[0]),c=zC(o[0],l[0],h)||e.surface.isGlobal&&zC(o[0],-l[0],h),d=zC(o[1],l[1],h);return!(!c||!d)||e.level!==t.level&&!(!c&&!d)&&(c?kC(n[1],n[3],a[1],a[3],h):kC(n[0],n[2],a[0],a[2],h))}function kC(e,t,i,r,s=eu){return e-s<=i&&i<=r&&r<=t+s}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(VC||(VC={}));class GC{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}class qC{constructor(){this.geometryInfo=new DT,this.intersectionData=null,this.geometryState=null,this._textureRef=new jT((()=>this.tile.surface.textureFadeDuration)),this.overlay=new GC,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._edgeResolutionChanged=!1,this._edgeNeighborChanged=!1,this._cornerElevationChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1}get tile(){return this._tile}init(e){this._tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,Lh(t.boundingBox),t.indexCount=0,t.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new zT,this.localOrigin=null,this.overlay.clear()}clear(){this._releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometryIfChanged(e,t){const i=this.updateGeometryStateAndPrepareForGeometryGeneration(t);return this._hasGeometry=!0,this.updateNeighborDataAndGeometryIfNeeded(i,e)}updateNeighborDataAndGeometryIfNeeded(e=!1,t=this.vao.context){const i=this._updateNeighborData(),r=e||this._geometryStateChangedSinceLastUpdate||i;return r&&(this._updateGeometry(t),this._geometryStateChangedSinceLastUpdate=!1),r}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const t=i.surface.extent;if(U(t)&&(0===e&&i.extent[3]>t[3]||1===e&&i.extent[2]>t[2]||2===e&&i.extent[1]<t[1]||3===e&&i.extent[0]<t[0]))return r}const s=i.level,a=Wc[e],n=t||i.findNeighborTile(a,(e=>e.isLoaded||e.level===s));if(!n||n.isLeaf&&!n.isLoaded)return Uc(z(i.surface?.rootTiles)||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(a)),r;if(n.isLoaded){const t=n,i=t.renderData.geometryState,a=s-t.level;if(0===a){const e=i.numVerticesPerSide-1;return Math.max(e,r)}const o=2**a,l=i.neighborData.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}Uc(!n.isLeaf);let o=r;return n.forAllSubtreeOnSide(Qc(a),(e=>e===i||(e.isLoaded?(o=Math.max(o,2**(e.level-s)),!0):(Uc(!e.isLeaf),!1)))),o}_updateNeighborData(){const e=this.tile,t=t=>t.isLoaded||t.level===e.level,i=e=>e.isLoaded,r=[null,null,null,null],s=[null,null,null,null];(()=>{for(let i=0;i<4;++i){const a=e.findNeighborTile(Wc[i],t);r[i]=a,s[i]=a?.isLoaded?a:null}})();const a=[null,null,null,null];(()=>{for(let t=0;t<4;++t)a[t]=e.findNeighborTile(Hc[t],i)})();const n=this.geometryState.neighborData;let o=!1;return(()=>{for(let t=0;t<4;++t){const i=n.edgeResolutions[t],s=r[t],a=this._calculateEdgeResolution(t,s);n.edgeResolutions[t]=a,i!==a&&(o=!0,this._edgeResolutionChanged=!0,s&&s!==e&&!s.isLoaded&&s.level===e.level&&(n.modifiedEdgeResolutions[t]=!0))}})(),(()=>{const t=n.cornerNeighborData,i=(i,r)=>{const s=t[i],a=s.cornerTiles;for(let t=0;t<4;++t){const i=Hc[t],s=r[t]?.findCorner(Bc(i),(t=>t?.isLoaded||t===e));a[t]=s}const n=((t,i)=>{const r=t.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);for(let r=0;r<4;++r){const s=t[(r+3)%4],a=t[r];if(s&&s.level<e.level&&s===a){const t=s,a=1==(1&r),n=(e.getNeighborEdgeStartVertexIndex(r,t)+(0===i||1===i&&!a||3===i&&a?1:0))/2**(e.level-t.level);return pT(a?0===i||1===i?t.extent[0]:t.extent[2]:Ie(t.extent[0],t.extent[2],n),a?Ie(t.extent[1],t.extent[3],n):0===i||3===i?t.extent[1]:t.extent[3],t.renderData.geometryState.samplerData)}}let s=0,a=0;for(let e=0;e<4;++e){const i=t[e];if(i&&i.level===r){const t=0===e||1===e,r=0===e||3===e,n=i.extent;a+=pT(n[t?0:2],n[r?1:3],i.renderData?.geometryState?.samplerData),s++}}return s?a/s:0})(a,i);return s.elevation!==n&&(s.elevation=n,!0)};for(let t=0;t<4;++t){const r=a[t],n=s[t],l=[r,s[(t+1)%4],e,n],h=l.map(((e,i)=>l[(i+4-t)%4]));i(t,h)&&(this._cornerElevationChanged=!0,o=!0)}})(),(()=>{const t=(t,i)=>{if(!t?.isLoaded||t.lij[0]>e.lij[0])return null;const r=t.renderData.geometryState;return{neighborSamplerData:r.samplerData,neighborEdgeOverlapResolution:r.neighborData.edgeResolutions[i+2],version:r.samplerDataVersion,neighborVerticesPerSide:r.numVerticesPerSide,neighborTile:t}},i=n.edgeNeighbours;for(let r=0;r<4;++r){const a=s[r];a&&(Uc(a?.isLoaded),Uc(a?.lij[0]<=e.lij[0]));const n=i[r],l=n?.version,h=t(a,r),c=h?.version??null,d=null!=n!=(null!=h),u=n&&h&&l!==c,p=n&&h&&n?.neighborTile!==h?.neighborTile,m=d||u||p;this._edgeNeighborChanged||(this._edgeNeighborChanged=m),o||(o=m),!m&&l||(i[r]=h)}})(),o}updateEdgeAfterResolutionChange(e){const t=this._calculateEdgeResolution(e),i=this.geometryState.neighborData.edgeResolutions,r=i[e];Uc((this.geometryState.neighborData.edgeNeighbours[e]?.neighborTile.level??0)<=this.tile.level),t!==r&&(i[e]=t,this._edgeResolutionChanged=!0,qC.deferTileNeighborUpdate?qC.neighborTilesToUpdate.add(this.tile):this._updateGeometry(this.vao.context))}_updateGeometry(e){this.intersectionData=null;const t=this.tile,i=t.lij,r=qC.updatedGeometryTiles.get(i)||0;qC.updatedGeometryTiles.set(i,r+1);const s=this._vao,a=this.geometryInfo.vertexAttributes,n=!s||!a||this._wireframeChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._edgeResolutionChanged,o=!n&&this._edgeNeighborChanged,l=!o&&this._cornerElevationChanged;this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._edgeResolutionChanged=!1,this._edgeNeighborChanged=!1,this._cornerElevationChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,n?(this._releaseGeometry(),this._createGeometry(e)):o?t.updateEdgeElevations():l?t.updateCornerElevations():console.warn("Update for no reason?")}releaseGeometry(){return this._releaseGeometry()}get hasGeometry(){return this._hasGeometry}ensureTexture(e,t){return U(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),z(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){U(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}updateGeometryStateAndPrepareForGeometryGeneration(e){const t=this._getElevationInfo(),i=t.samplerData?this.tile.getElevationBasedVerticesPerSide(t.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel(),r=Math.max(i,5);let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const a=this.geometryState;let n=!1;return a.numVerticesPerSide!==r&&(this._numVerticesPerSideChanged=!0,a.numVerticesPerSide=r,a.samplerDataVersion++,n=!0),t.changed&&(this._samplerDataChanged=!0,a.samplerData=t.samplerData,a.samplerDataVersion++,n=!0),S(a.clippingArea,s)||(this._clippingAreaChanged=!0,a.clippingArea=s,n=!0),a.wireframe!==e&&(this._wireframeChanged=!0,a.wireframe=e,n=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=n),this._hasGeometry=!0,n}_createGeometry(e){this.tile.createGeometry();const t=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,r=e.gl;this._vao=new No(e,nn,{geometry:Eo(t.layout)},{geometry:Fo.createVertex(e,r.STATIC_DRAW,t.buffer)},Fo.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}_releaseGeometry(){return this._hasGeometry=!1,!!this._vao&&(this._vao.dispose(),this._vao=null,e=this.geometryInfo,NT.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null,!0);var e}get vao(){return this._vao}setTextureReference(e,t=kT.Immediate){U(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[yT.ELEVATION],i=t.length;let r=new Array(i),s=0,a=0,n=!1;for(let o=0;o<i;o++){const i=t[o];if(U(i.upsampleInfo)){const t=i.upsampleInfo.tile,l=t.layerInfo[yT.ELEVATION][o].data,h=l&&l.samplerData;e&&e[s]===h||(n=!0),r[s++]=h,a=Math.max(a,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,yT.ELEVATION);if(BT(this.tile,t.layer,!1)){const t=i.data;e&&e[s]===t.samplerData||(n=!0),r[s++]=t.samplerData,a=this.tile.level}}}return U(e)&&e.length!==s&&(n=!0),s>0?r.length=s:r=null,{changed:n,samplerData:r,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){const e=W(this.intersectionData,0,(e=>e.estimatedMemoryUsage));return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+e}get textureDescriptor(){return U(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}checkGeometryWaterproofness(){}}function BC(e,t,i,r,s,a){const n=t-1,o=e.vertexAttributes.count,l=2*(Math.min(t-2,r[1])-Math.max(1,r[0]))*(Math.min(t-2,s[1])-Math.max(1,s[0])),h=Wc.map(((e,i)=>0===i&&s[1]<t-2||1===i&&r[1]<t-2||2===i&&s[0]>1||3===i&&r[0]>1)),c=3*(l+e.outerEdges.reduce(((e,t,i)=>e+(h[i]?0:n-2+t.count-1)),0)+i.reduce(((e,t)=>e+n*(2*(t.latitudeResolution-1)+1)),0))*(a?2:1),d=new(o>65536?Uint32Array:Uint16Array)(c);let u=0;const p=a?(e,t,i)=>{d[u++]=e,d[u++]=t,d[u++]=t,d[u++]=i,d[u++]=i,d[u++]=e}:(e,t,i)=>{d[u++]=e,d[u++]=t,d[u++]=i},m=t-2,g=n-2;(()=>{for(let e=Math.max(s[0],1)-1;e<Math.min(s[1],t-2)-1;++e)for(let i=Math.max(r[0],1)-1;i<Math.min(r[1],t-2)-1;++i){const t=e*m+i,r=t+1,s=r+m,a=s-1;p(t,r,s),p(s,a,t)}})(),(()=>{for(let t=0;t<4;++t){if(h[t])continue;const i=e.outerEdges[t],r=e.innerEdges[t];let s=0,a=0;const o=i.count,l=r.count;i.count;const c=1===t||2===t?(e,t,i)=>p(e,t,i):(e,t,i)=>p(e,i,t);for(;s<o-1||a<l-1;){const e=r.getVertexOffset(a),t=i.getVertexOffset(s),h=s<o-1,d=a<l-1,u=h?0+n*(s+.5)/(o-1):0,p=d?1+g*(a+.5)/(l-1):0;h&&(!d||u<=p)?(++s,c(e,t,i.getVertexOffset(s))):(++a,c(e,t,r.getVertexOffset(a)))}}})(),i.forEach((i=>{let r=e.outerEdges[i.connectedOuterEdgeOffset].offset0;for(let e=0;e<i.latitudeResolution;++e){const s=0===e?i.rowOffset:r+t;for(let t=0;t<n;t++)p(r,r+1,s+t),e<i.latitudeResolution-1&&p(r+1,s+t+1,s+t),++r;r=s}})),e.indices=d,e.indexCount=c}function HC(e,t){const i=e.localOrigin,r=e.geometryInfo,s=e.geometryState.neighborData.edgeResolutions,a=r.numVerticesPerSide-2,n=r.vertexAttributes.position.typedBuffer;let o=t;for(let e=0;e<4;++e){{const t=0===e||2===e,s=(0===e?a-1:0)*a+(1===e?a-1:0),o=(t?0:1)*a+(t?1:0);r.innerEdges[e]=new IT(n,i,s,o,a)}{const t=o,a=s[e]+1;r.outerEdges[e]=new IT(n,i,t,1,a),o+=a}}}function WC(e,t){YC(e,t),function(e,t){const i=e.geometryState.clippingArea,r=e.tile.extent,s=U(i)&&(r[0]<i[0]||r[2]>i[2]||r[1]<i[1]||r[3]>i[3])?sS:rS;for(let i=0;i<4;++i)s(e,i,t)}(e,t),lS(e,t)}function QC(e,t,i,r,s){const a=Math.cos(i),n=Math.sin(i),o=Math.sin(t),l=Math.cos(t),h=s+r;e[0]=l*a*h,e[1]=o*a*h,e[2]=n*h}function ZC(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function XC(e){KC(e,((t,i,r,s)=>function(e,t,i,r,s,a){const n=s[0===i?1:3];QC(e,s[0===t?0:2],n,r,a)}(t,i,r,s,e.tile.extentInRadians,e.tile.ellipsoid.radius)))}function YC(e,t){const i=e.tile;U(i.renderData.geometryState.clippingArea)?function(e,t){const i=e.geometryState,r=e.tile,s=r.extent,a=H(i.clippingArea,s),n=e.geometryInfo,o=n.boundingBox,l=n.outerEdges,h=i.neighborData.cornerNeighborData,c=n.uvOffsetAndScale[0],d=n.uvOffsetAndScale[1],u=n.uvOffsetAndScale[2],p=n.uvOffsetAndScale[3],m=u>0?1/u:1,g=p>0?1/p:1,f=-c*m,_=-d*g,y=r.surface.isWebMercatorOnPlateeCarree,v=ZC(y,y?r.ellipsoid.radius:0,t),b=i.samplerData,x=i.neighborData.edgeNeighbours,w=e.localOrigin,T=(e,i,n,l,c)=>{const d=s[0]*(1-l)+s[2]*l,u=s[1]*(1-c)+s[3]*c,p=Se(d,a[0],a[2]),y=Se(u,a[1],a[3]),T=[y===s[3],p===s[2],y===s[1],p===s[0]],C=!T[3]&&!T[1]||!T[0]&&!T[2],S=C?T[0]&&U(x[0])?x[0]:T[1]&&U(x[1])?x[1]:T[2]&&U(x[2])?x[2]:T[3]&&U(x[3])?x[3]:null:null,P=C?S?S.neighborTile.level===r.level?.5*(pT(p,y,b)+pT(p,y,S.neighborSamplerData)):pT(p,y,S.neighborSamplerData):pT(p,y,b):h[n].elevation,R=p*t-w[0],A=v(y)-w[1],O=P-w[2];cS(R,A,O,o);const M=Se(f+l*m,0,1),E=Se(_+c*g,0,1);e.setVertexRawXYZUV(i,R,A,O,M,E)};for(let e=0;e<4;++e){const t=l[e];T(t,0,0===e?3:1===e?1:2,1===e?1:0,0===e?1:0);const i=2===e?1:3===e?3:0,r=3===e?0:1,s=2===e?0:1;T(t,t.count-1,i,r,s)}}(e,t):KC(e,((r,s,a,n)=>function(e,t,i,r,s,a,n){const o=0===t?s[0]:s[2],l=0===i?s[1]:s[3],h=r;e[0]=o*a,e[1]=n(l),e[2]=h}(r,s,a,n,e.tile.extent,t,ZC(i.surface.isWebMercatorOnPlateeCarree,i.ellipsoid.radius,t))))}function KC(e,t){const i=e.geometryInfo,r=i.outerEdges,s=e.geometryState.neighborData.cornerNeighborData,a=i.boundingBox,n=e.localOrigin,o=(e,i,r,o,l)=>{t(mS,r,o,s[i].elevation);for(let e=0;e<3;++e)mS[e]-=n[e];cS(mS[0],mS[1],mS[2],a),e.setVertexRawXYZUV(l,mS[0],mS[1],mS[2],r,o)};for(let e=0;e<4;++e){const t=r[e];o(t,0===e?3:1===e?1:2,1===e?1:0,0===e?1:0,0),o(t,2===e?1:3===e?3:0,3===e?0:1,2===e?0:1,t.count-1)}}function $C(e){const t=e.vao,i=e.geometryInfo.vertexAttributes;t?.vertexBuffers?.geometry?.setSubData(i.position.typedBuffer)}function JC(e){XC(e);for(let t=0;t<4;++t)eS(e,t);oS(e)}function eS(e,t){const i=e.geometryState,r=i.neighborData,s=e.tile;s.level;const a=s.extent,n=a[2]-a[0],o=a[3]-a[1],l=s.extentInRadians,h=l[0];l[1];const c=l[2];l[3];const d=s.ellipsoid.radius,u=nS(e),p=r.edgeNeighbours[t],m=r.edgeResolutions[t],g=1===t||3===t,f=1===t?1:0,_=0===t?1:0,y=a[0]+f*n,v=a[1]+_*o,b=h*(1-f)+c*f,x=u(_),w=p?.neighborTile,T=s.level-(w?.level??s.level),C=2**T,S=m*C,P=(e=>{if(!e)return 0;const t=m,i=g?0:1,r=e.lij[i+1]*C,a=s.lij[i+1]-r;return(g?C-1-a:a)*t})(w),R=w?.extent,A=(t+2)%4,O=i.samplerData,M=w?.renderData?.geometryState?.samplerData,E=w&&0===T,D=E?(e,t,i,r)=>.5*(pT(e,t,M)+pT(i,r,O)):(e,t)=>pT(e,t,M);let I=R?1===A?R[2]:R[0]:y,L=R?0===A?R[3]:R[1]:v;const N=g?(e,t,i)=>{const r=(P+e)/S;return L=R[1]*(1-r)+R[3]*r,D(I,L,t,i)}:(e,t,i)=>{const r=(P+e)/S;return I=R[0]*(1-r)+R[2]*r,D(I,L,t,i)},F=w?N:(e,t,i)=>pT(t,i,O),V=(e,t,i)=>F(e,t,i);let U=f,z=y,j=b,k=_,G=v,q=x,B=Math.sin(j),H=Math.cos(j),W=Math.cos(q),Q=Math.sin(q);const Z=g?()=>u(k):()=>x,X=g?e=>{k=e,G=a[1]*(1-e)+a[3]*e,q=Z(),W=Math.cos(q),Q=Math.sin(q)}:e=>{U=e,z=a[0]*(1-e)+a[2]*e,j=h*(1-U)+c*U,B=Math.sin(j),H=Math.cos(j)},Y=e.geometryInfo,K=Y.boundingBox,$=Y.vertexAttributes,J=$.position.typedBuffer,ee=$.uv0.typedBuffer,te=$.normal.typedBuffer,ie=Y.outerEdges[t];let re=ie.getVertexOffset(1);const se=m+1,ae=e.localOrigin,ne=ae[0],oe=ae[1],le=ae[2],he=s.surface.shadingEnabled,ce=1===t?-1:3===t?1:0,de=0===t?-1:2===t?1:0,ue=n/m,pe=ce*ue,me=de*ue,ge=ce*(1/m),fe=de*(1/m),_e=e=>{ht(fS,e,vS),Ne(_S,fS,xS),Ne(yS,_S,fS),Ge(wS,wS,yS)};for(let e=1;e<se-1;++e){X(e/m);const t=V(e,z,G),i=d+t,r=H*W*i,s=B*W*i,a=Q*i,n=r-ne,o=s-oe,l=a-le;cS(n,o,l,K);const p=zd*re;if(J[p+0]=n,J[p+1]=o,J[p+2]=l,ee[p+0]=U,ee[p+1]=k,he){Me(wS,0,0,0),Me(vS,r,s,a),Fe(xS,vS);const e=(e,t)=>{const i=pT(z+e*pe,G+e*me,t),r=d+i,s=U+e*ge,a=h*(1-s)+c*s,n=Math.sin(a),o=Math.cos(a),l=u(k+e*fe),p=Math.sin(l),m=Math.cos(l),g=Ae(o*m*r,n*m*r,p*r);_e(g)};w&&e(-1,M),w&&!E||e(1,O),te[p+0]=wS[0],te[p+1]=wS[1],te[p+2]=wS[2]}++re}if(he)for(let e=1;e<se-1;++e)ie.getVertexRawNormal(wS,e),ie.getVertex(vS,e),Fe(xS,vS),ie.getVertex(gS,e-1),_e(gS),ie.getVertex(gS,e+1),_e(gS),Fe(wS,wS),ie.setVertexRawNormal(e,wS[0],wS[1],wS[2])}function tS(e,t,i,r,s,a,n){return n===s?!e||t?(e,t)=>pT(e,t,i):null:n===a&&e?(e,t)=>pT(e,t,r):null}function iS(e,t,i,r){if(t!==e)return()=>0;const s=t?3:2,a=t?1:0,n=r(s,a),o=r(a,s),l=(null!=n?1:0)+(null!=o?1:0),h=t?i:0,c=t?0:i;return(e,t,i)=>((null!=n?-(n(e+h,t+c)-i):0)+(null!=o?+(o(e-h,t-c)-i):0))/l}function rS(e,t,i){const r=e.geometryState.neighborData,s=r.edgeNeighbours,a=e.tile,n=a.level,o=a.surface,l=o.shadingEnabled,h=s[t],c=r.edgeResolutions[t],d=c,u=a.extent,p=e.geometryState,m=d+1,g=h,f=e.localOrigin,_=p.samplerData,y=g?.neighborTile.level===n,v=y?(e,t)=>.5*(pT(e,t,g.neighborSamplerData)+pT(e,t,_)):(e,t)=>pT(e,t,g.neighborSamplerData),b=U(g)?v:(e,t)=>pT(e,t,_),x=e.geometryInfo,w=x.outerEdges[t],T=ZC(o.isWebMercatorOnPlateeCarree,a.ellipsoid.radius,i),C=x.boundingBox,S=1===t||3===t,P=1===t?u[2]:u[0],R=0===t?u[3]:u[1],A=1===t?1:0,O=0===t?1:0,M=(u[2]-u[0])/c,E=g?.neighborSamplerData,D=U(g),I=(e,i)=>tS(D,y,_,E,e,i,t),L=iS(S,!0,M,I),N=iS(S,!1,M,I);for(let e=1;e<m-1;++e){const t=e/d,r=S?P:u[0]*(1-t)+u[2]*t,s=S?u[1]*(1-t)+u[3]*t:R,a=S?A:t,n=S?t:O,o=b(r,s),h=r*i-f[0],c=T(s)-f[1],p=o-f[2];if(cS(h,c,p,C),l){const t=L(r,s,o),i=N(r,s,o),l=M;w.setVertexRawXYZUVN(e,h,c,p,a,n,t,i,l)}else w.setVertexRawXYZUV(e,h,c,p,a,n)}if(l){const e=S?0:1,t=S?1:0;for(let i=1;i<m-1;++i){w.getNormal(TS,i);const r=w.getVertexZ(i-1)-w.getVertexZ(i+1),s=TS[0]+.5*e*r,a=TS[1]+.5*t*r,n=2*M,o=1/Math.sqrt(s*s+a*a+n*n);w.setVertexRawNormal(i,o*s,o*a,o*n)}}}function sS(e,t,i){const r=e.geometryState.neighborData,s=r.edgeNeighbours,a=e.tile,n=a.level,o=a.surface,l=o.shadingEnabled,h=s[t],c=r.edgeResolutions[t],d=c,u=a.extent,p=e.geometryState,m=H(p.clippingArea,pS),g=e.geometryInfo,f=g.uvOffsetAndScale[0],_=g.uvOffsetAndScale[1],y=f+g.uvOffsetAndScale[2],v=_+g.uvOffsetAndScale[3],b=y>f?1/(y-f):1,x=v>_?1/(v-_):1,w=-f*b,T=-_*x,C=d+1,S=[u[3]>m[3],u[2]>m[2],u[1]<m[1],u[0]<m[0]],P=h,R=p.samplerData,A=(e,t)=>pT(e,t,R),O=P?.neighborTile.level===n,M=A,E=U(P)?(e,t)=>{const i=pT(e,t,P.neighborSamplerData);return O?.5*(i+pT(e,t,R)):i}:A,D=S[t]?M:E,I=g.outerEdges[t],L=g.boundingBox,N=1===t||3===t,F=Se(1===t?u[2]:u[0],m[0],m[2]),V=Se(0===t?u[3]:u[1],m[1],m[3]),z=1===t?1:0,j=0===t?1:0,k=e.localOrigin,G=ZC(o.isWebMercatorOnPlateeCarree,a.ellipsoid.radius,i),q=(u[2]-u[0])/c,B=P?.neighborSamplerData,W=U(P),Q=P?.neighborTile.level===n,Z=(e,i)=>tS(W,Q,R,B,e,i,t),X=iS(N,!0,q,Z),Y=iS(N,!1,q,Z);for(let e=1;e<C-1;++e){const t=e/d,r=N?F:Se(u[0]*(1-t)+u[2]*t,m[0],m[2]),s=N?Se(u[1]*(1-t)+u[3]*t,m[1],m[3]):V,a=N?z:Se(w+t*b,0,1),n=N?Se(T+t*x,0,1):j,o=D(r,s),h=r*i-k[0],c=G(s)-k[1],p=o-k[2];if(cS(h,c,p,L),l){const t=X(r,s,o),i=Y(r,s,o),l=q;I.setVertexRawXYZUVN(e,h,c,p,a,n,t,i,l)}else I.setVertexRawXYZUV(e,h,c,p,a,n)}if(l){const e=N?0:1,t=N?1:0;for(let i=1;i<C-1;++i){I.getNormal(TS,i);const r=I.getVertexZ(i-1)-I.getVertexZ(i+1),s=TS[0]+.5*e*r,a=TS[1]+.5*t*r,n=2*q,o=1/Math.sqrt(s*s+a*a+n*n);I.setVertexRawNormal(i,o*s,o*a,o*n)}}}function aS(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function nS(e){const t=e.tile;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius,r=t=>function(e,t,i,r){return aS(e+r*(t-e),i)}(e[1],e[3],i,t);return r}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function oS(e){e.tile.surface.shadingEnabled&&hS(e,((e,t,i,r,s,a,n)=>function(e,t,i,r,s,a,n){(function(e,t,i,r,s){const a=nS(e),n=e.tile,o=n.extent;Uc(ti(o,i,r,1));const l=(i-o[0])/(o[2]-o[0]),h=(r-o[1])/(o[3]-o[1]),c=n.extentInRadians;QC(t,c[0]*(1-l)+c[2]*l,a(h),s,n.ellipsoid.radius)})(e,gS,s,a,n),ht(fS,gS,i),Ne(_S,fS,r),Ne(t,_S,fS)}(t,e,i,r,s,a,n)))}function lS(e,t){e.tile.surface.shadingEnabled&&hS(e,((i,r,s,a,n,o,l)=>function(e,t,i,r,s,a){e(gS,r,s,a);const n=gS[0]-i[0],o=gS[1]-i[1],l=gS[2]-i[2];t[0]=-n*l,t[1]=-o*l,t[2]=n*n+o*o}(function(e,t){return e.tile.surface.isWebMercatorOnPlateeCarree?(i,r,s,a)=>function(e,t,i,r,s,a){i[0]=r*e,i[1]=(Math.PI/2-2*Math.atan(Math.exp(-s/t)))*t,i[2]=a}(t,e.tile.ellipsoid.radius,i,r,s,a):(e,i,r,s)=>function(e,t,i,r,s){t[0]=i*e,t[1]=r*e,t[2]=s}(t,e,i,r,s)}(e,t),i,s,n,o,l)))}function hS(e,t){if(!e.tile.surface.shadingEnabled)return;const i=e.geometryState.neighborData.cornerNeighborData,r=e.tile,s=r.extent,a="local"===e.tile.surface.view?.viewingMode;a&&Me(xS,0,0,1);{const n=(e,i,r,s)=>{t(yS,e.renderData,vS,xS,i,r,s),Ge(wS,wS,yS)},o=1,l=(e,t,i,r,s,a)=>{const l=1===a?s.extent[0]:3===a?s.extent[2]:e,h=0===a?s.extent[1]:2===a?s.extent[3]:t,c=l+dS[i][0]*r,d=h+dS[i][1]*r;Uc(ti(s.extent,c,d,o));const u=pT(c,d,s.renderData.geometryState.samplerData);n(s,c,d,u)},h=(e,t,i)=>e.extent[0===t||1===t?2:0]+i,c=(e,t,i)=>e.extent[0===t||3===t?3:1]+i,d=(e,t,i,r)=>{const s=h(i,r,dS[e][0]*t),a=c(i,r,dS[e][1]*t);Uc(ti(i.extent,s,a,o));const l=pT(s,a,i.renderData.geometryState.samplerData);n(i,s,a,l)},u=(e,t,i,r,s,a)=>{const l=dS[e][0]*t,d=dS[e][1]*t,u=h(i,r,l),p=c(i,r,d),m=h(s,a,l),g=c(s,a,d);Uc(ti(i.extent,u,p,o)),Uc(ti(s.extent,m,g,o));const f=pT(u,p,i.renderData.geometryState.samplerData),_=pT(m,g,s.renderData.geometryState.samplerData);n(i,u,p,.5*(f+_))},p=e=>{const t=0===e||1===e?s[2]:s[0],a=0===e||3===e?s[3]:s[1],n=i[e].cornerTiles,o=n.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);for(let e=0;e<4;++e){const t=n[e];SS[e]=t?.level===o?t:null}for(let e=0;e<4;++e){const i=SS[(e+3)%4],s=SS[e];if(null!=i&&i!==r&&i===s){const s=i,n=(e+2)%4,o=s.renderData.geometryState.neighborData.edgeResolutions[n],h=Math.max(o,2**(r.level-s.level)),c=(s.extent[2]-s.extent[0])/h,d=(e+0)%4,u=(e+1)%4;return l(t,a,(e+3)%4,c,s,e),l(t,a,d,c,s,e),l(t,a,u,c,s,e),wS}}{Uc(SS.some((e=>e?.isLoaded||e===r)));const e=SS.reduce(((e,t)=>t?t.extent[2]-t.extent[0]:e),0),t=SS.reduce(((e,t)=>Math.max(e,t?.renderData.geometryState.numVerticesPerSide??1)),1),i=e/t;for(let e=0;e<4;++e){const t=SS[(e+3)%4],r=SS[(e+0)%4];if(!t&&!r)continue;const s=0===e?1:1===e?2:2===e?3:0,a=0===e?2:1===e?3:2===e?0:1;t&&r?u(e,i,t,s,r,a):d(e,i,t??r,t?s:a)}}return wS};for(let t=0;t<4;++t){const i=e.geometryInfo.outerEdges[t],r=1===t||2===t?0:i.count-1;i.getVertex(vS,r),a||Fe(xS,vS),Me(wS,0,0,0);const s=p(t);Fe(CS[t],s)}}{const t=(e,t,i,r,s)=>{e.setVertexRawNormal(s,t,i,r)},i=e.geometryInfo.outerEdges;for(let e=0;e<4;++e){const r=i[e];{const i=CS[0===e?3:1===e?1:2];t(r,i[0],i[1],i[2],0)}{const i=CS[2===e?1:3===e?3:0];t(r,i[0],i[1],i[2],r.count-1)}}}}function cS(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}qC.updatedGeometryTiles=new Map,qC.deferTileNeighborUpdate=!1,qC.neighborTilesToUpdate=new Set;const dS=[[0,1],[1,0],[0,-1],[-1,0]],uS=new class{constructor(){this.sinLonLUT=new Array(jd+1),this.cosLonLUT=new Array(jd+1)}update(e,t){const i=t[0],r=t[2];for(let t=0;t<=e;t++){const s=t/e,a=i*(1-s)+r*s;this.sinLonLUT[t]=Math.sin(a),this.cosLonLUT[t]=Math.cos(a)}}},pS=Bt(-1/0,-1/0,1/0,1/0),mS=Oe(),gS=Oe(),fS=Oe(),_S=Oe(),yS=Oe(),vS=Oe(),bS=Oe(),xS=Oe(),wS=Oe(),TS=Oe(),CS=[Oe(),Oe(),Oe(),Oe()],SS=[null,null,null,null];class PS extends EC{constructor(e,t,i){super(),this.horizontalScaleFactor=1,this.extentInRenderSR=Vt(),void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i);const r=i.view.renderSpatialReference,s=i.spatialReference,a=U(r)&&yr(r)&&s.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this.horizontalScaleFactor=a;const n=this.surface.isWebMercatorOnPlateeCarree,o=this.extentInRenderSR,l=this.extent;if(n){const e=Ae(l[0],l[1],0);Ot(e,mr.WebMercator,e,mr.PlateCarree);const t=Ae(l[2],l[3],0);Ot(t,mr.WebMercator,t,mr.PlateCarree),o[0]=e[0],o[1]=e[1],o[2]=t[0],o[3]=t[1]}else for(let e=0;e<4;++e)o[e]=l[e]*a;this.centerAtSeaLevel[0]=.5*(o[0]+o[2]),this.centerAtSeaLevel[1]=.5*(o[1]+o[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(o[2]-o[0],o[3]-o[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this.extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),s=.5*(this.elevationBounds[0]-this.elevationBounds[1]),a=Math.max(r,s);this._center[VC.MIDDLE][3]=a}_isVisible(e){return gc(e,this._aabb())}_aabb(){const e=this.extentInRenderSR;return Nh(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,t,i,r){return RS[0]=1/t[0],RS[1]=1/t[1],RS[2]=1/t[2],un(this._aabb(),e,RS,i,r)}createGeometry(){!function(e,t){const i=e.tile,r=i.extent,s=e.localOrigin,a=e.geometryState,n=i.surface,o=n.isWebMercatorOnPlateeCarree,l=n.shadingEnabled,h=r[0],c=r[1],d=r[2]-h,u=r[3]-c,p=a.clippingArea,m=U(p)?Math.max(0,(p[0]-r[0])/d):0,g=U(p)?Math.max(0,(p[1]-r[1])/u):0,f=U(p)?Math.min(1,(p[2]-r[0])/d):1,_=U(p)?Math.min(1,(p[3]-r[1])/u):1,y=f-m,v=_-g,b=y>0?1/y:1,x=v>0?1/v:1,w=-m*b,T=-g*x,C=a.numVerticesPerSide,S=C-1,P=(C-2)**2+a.neighborData.edgeResolutions.reduce(((e,t)=>e+t+1),0),R=FT(P),A=R.position.typedBuffer,O=R.uv0.typedBuffer,M=R.normal.typedBuffer,E=e.geometryInfo,D=E.boundingBox;Lh(D);let I=0;const L=i.ellipsoid.radius,N=a.samplerData,F=U(p)?p:pS,V=Bt(Math.max(r[0],F[0]),Math.max(r[1],F[1]),Math.min(r[2],F[2]),Math.min(r[3],F[3])),z=s[0],j=s[1],k=s[2],G=ZC(o,L,t);(()=>{for(let e=1;e<=S-1;e++){const i=e/S,r=T+i*x,s=Se(c+i*u,V[1],V[3]),a=Se(r,0,1),n=G(s)-j,o=d/S;for(let e=1;e<=S-1;e++){const i=e/S,r=w+i*b,c=Se(h+i*d,V[0],V[2]),u=Se(r,0,1),p=pT(c,s,N),m=c*t-z,g=p-k;cS(m,n,g,D);const f=zd*I;if(A[f+0]=m,A[f+1]=n,A[f+2]=g,O[f+0]=u,O[f+1]=a,l){const e=pT(c+o,s,N),t=pT(c-o,s,N),i=pT(c,s+o,N),r=.25*(t-e),a=.25*(pT(c,s-o,N)-i),n=o,l=Math.sqrt(r*r+a*a+n*n);M[f+0]=r/l,M[f+1]=a/l,M[f+2]=n/l}++I}}})(),E.numVerticesPerSide=a.numVerticesPerSide,E.vertexAttributes=R,et(e.geometryInfo.uvOffsetAndScale,m,g,f-m,_-g),HC(e,I),WC(e,t),I=P,BC(E,a.numVerticesPerSide,[],[0,C-1],[0,C-1],a.wireframe),e.intersectionData=null}(this.renderData,this.horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerRowOnLevel(){return this.level<9?3:2}updateCornerElevations(){var e,t;YC(e=this.renderData,t=this.horizontalScaleFactor),lS(e,t),$C(e)}updateEdgeElevations(){var e;WC(e=this.renderData,this.horizontalScaleFactor),$C(e)}}const RS=Oe();var AS;!function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(AS||(AS={}));class OS extends EC{constructor(e,t,i){super(),this.obb=new Array(8);for(let e=0;e<8;e++)this.obb[e]=Oe();void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i);const r=this.ellipsoid.radius,s=this.extentInRadians[0],a=this.extentInRadians[1],n=this.extentInRadians[2],o=this.extentInRadians[3],l=e[0],h=Ie(a,o,.5),c=Ie(s,n,.5),d=0===l?0:Math.min(Math.abs(a),Math.abs(o));this._edgeLen=(n-s)*Math.cos(d)*r,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=r-Math.sqrt(r*r-this._edgeLen2/4),Mt(this.centerAtSeaLevel,c,h,this.ellipsoid.radius);const u=st(this.centerAtSeaLevel);Fe(u,u),this.up=u,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(0===this.lij[0])Me(this._center[DS.MIDDLE],0,0,0),Me(this._center[DS.TOP],0,0,0),Me(this._center[DS.BOTTOM],0,0,0),this.ellipsoid||(this.ellipsoid=vr(this.surface.spatialReference)),this._center[DS.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const e=Math.max(Ke(this._center[DS.MIDDLE],this.obb[0]),Ke(this._center[DS.MIDDLE],this.obb[1]));this._center[DS.MIDDLE][3]=Math.sqrt(e)}}_isVisible(e){if(!hc(e,this._center[DS.MIDDLE]))return!1;if(this.lij[0]<10)return!0;const t=this.obb;for(let i=0;i<fc.NUM;i++){const r=i===mc.NEAR,s=e[i];r&&(ES[0]=s[0],ES[1]=s[1],ES[2]=s[2],ES[3]=s[3]-this.surface.view.state.camera.near);const a=r?ES:s;let n;for(n=0;n<8;n++){const e=t[n];if(a[0]*e[0]+a[1]*e[1]+a[2]*e[2]+a[3]<0)break}if(8===n)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(){const e=this._getPatchType(this.lij[1],this.lij[0]);(function(e,t){const i=e.tile,{extent:r,extentInRadians:s,surface:a}=i,n=e.localOrigin,o=e.geometryState,l=a.isWebMercator,h=a.shadingEnabled,c=o.numVerticesPerSide,d=c-1,u=(c-2)**2,p=l&&(t===$d.HAS_SOUTH_POLE||t===$d.HAS_BOTH_POLES),m=l&&(t===$d.HAS_NORTH_POLE||t===$d.HAS_BOTH_POLES),g=6*((p?1:0)+(m?1:0))*(d+1),f=o.neighborData,_=f.edgeResolutions.reduce(((e,t)=>e+t+1),0),y=FT(u+g+_),v=e.geometryInfo;v.numVerticesPerSide=o.numVerticesPerSide,v.vertexAttributes=y,et(v.uvOffsetAndScale,0,0,1,1);const b=y.position.typedBuffer,x=y.uv0.typedBuffer,w=y.normal.typedBuffer,T=v.boundingBox;Lh(T);const C=n[0],S=n[1],P=n[2];uS.update(d,s);let R=0;const A=o.samplerData,O=i.ellipsoid.radius,M=nS(e),E=c-2,D=r[0],I=r[2],L=r[1],N=r[3];if((()=>{for(let e=1;e<=E;e++){const t=e/d,i=L*(1-t)+N*t,r=M(t),s=Math.cos(r),a=Math.sin(r);for(let e=1;e<=E;e++){const r=e/d,n=D*(1-r)+I*r,o=uS.sinLonLUT[e],l=uS.cosLonLUT[e],h=O+pT(n,i,A),c=l*s*h-C,u=o*s*h-S,p=a*h-P;cS(c,u,p,T);const m=zd*R;b[m+0]=c,b[m+1]=u,b[m+2]=p,x[m+0]=r,x[m+1]=t,++R}}})(),h){const t=()=>{const t=e=>(ze(fS,e,bS),Ne(_S,fS,xS),Ne(yS,_S,fS),yS),i=y.position,r=y.normal;R=0;const s=(e,r,s)=>{e>1&&r>1&&e<E&&r<E?(e=>{i.getVec(e,gS),Ge(wS,wS,t(gS))})(R+s):((e,i)=>{{const t=e/d,r=D*(1-t)+I*t,s=uS.sinLonLUT[e],a=uS.cosLonLUT[e],n=i/d,o=L*(1-n)+N*n,l=M(n),h=Math.cos(l),c=Math.sin(l),u=O+pT(r,o,A);Me(gS,a*h*u-C,s*h*u-S,c*u-P)}Ge(wS,wS,t(gS))})(e,r)};for(let t=1;t<=E;t++)for(let a=1;a<=E;a++)i.getVec(R,bS),Ge(vS,bS,e.localOrigin),Fe(xS,vS),Me(wS,0,0,0),s(a-1,t,-1),s(a+1,t,1),s(a,t-1,-E),s(a,t+1,+E),Fe(wS,wS),r.setVec(R,wS),++R};t()}R=u,HC(e,u),JC(e),R=u+_;const F=[];(()=>{const e=(e,t)=>{const i=t*c;cS(-C,-S,e*O-P,T),F.push({connectedRowOffset:i,connectedOuterEdgeOffset:1===e?0:2,rowOffset:R,latitudeResolution:6});const r=aS(-1===e?L:N,O),s=e*Math.PI/2-r,a=.99*(1===e?1:-1),n=O+0;for(let e=1;e<=6;++e){const t=r+s*(e/6),i=Math.cos(t),o=Math.sin(t);for(let e=0;e<=d;e++){const t=e/d,r=uS.sinLonLUT[e],s=uS.cosLonLUT[e]*i*n-C,l=r*i*n-S,c=o*n-P;cS(s,l,c,T);const u=zd*R;if(b[u+0]=s,b[u+1]=l,b[u+2]=c,x[u+0]=t,x[u+1]=a,h){const e=1/Math.sqrt(s*s+l*l+c*c);w[u+0]=e*s,w[u+1]=e*l,w[u+2]=e*c}++R}}};p&&e(-1,0),m&&e(1,d)})(),BC(v,o.numVerticesPerSide,F,[0,c-1],[0,c-1],o.wireframe),e.intersectionData=null;for(let e=0;e<4;++e)Uc(v.outerEdges[e].count===f.edgeResolutions[e]+1)})(this.renderData,e),this.setMemoryDirty()}_updateOBB(){const e=this.extentInRadians,t=this.obb;for(let i=0;i<2;i++){const r=this.elevationBounds[i];let s=4*i;Mt(t[s++],e[0],e[1],this.ellipsoid.radius+r),Mt(t[s++],e[0],e[3],this.ellipsoid.radius+r),Mt(t[s++],e[2],e[3],this.ellipsoid.radius+r),Mt(t[s++],e[2],e[1],this.ellipsoid.radius+r)}if(this.surface.isWebMercator)switch(this._getPatchType(this.lij[1],this.lij[0])){case $d.HAS_NORTH_POLE:Me(t[1],0,0,this.ellipsoid.radius),Me(t[2],0,0,this.ellipsoid.radius),Me(t[5],0,0,this.ellipsoid.radius),Me(t[6],0,0,this.ellipsoid.radius);break;case $d.HAS_SOUTH_POLE:Me(t[0],0,0,-this.ellipsoid.radius),Me(t[3],0,0,-this.ellipsoid.radius),Me(t[4],0,0,-this.ellipsoid.radius),Me(t[7],0,0,-this.ellipsoid.radius)}}_getPatchType(e,t){return e===(1<<t)-1?0===e?$d.HAS_BOTH_POLES:$d.HAS_SOUTH_POLE:0===e?$d.HAS_NORTH_POLE:$d.REGULAR}intersectsRay(e,t,i,r){const s=this._center[DS.MIDDLE],a=s[3]+i,n=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=s[0]-e[0],l=s[1]-e[1],h=s[2]-e[2],c=(o*t[0]+l*t[1]+h*t[2])/n,d=t[0]*c-o,u=t[1]*c-l,p=t[2]*c-h;return d*d+u*u+p*p<a*a}getDefaultVerticesPerRowOnLevel(){return this.level<MS.length?MS[this.level]+1:2}updateCornerElevations(){!function(e){XC(e),oS(e);const t=e.vao,i=e.geometryInfo.vertexAttributes;t?.vertexBuffers?.geometry?.setSubData(i.position.typedBuffer)}(this.renderData)}updateEdgeElevations(){var e;JC(e=this.renderData),$C(e)}}const MS=[128,64,32,16,16,8,8,4],ES=eh();var DS;!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(DS||(DS={}));class IS{constructor(){this.extent=hr(),this.minLevel=0,this.maxLevel=0,this.callback=null}}class LS{constructor(){this._queries=new le({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new le({initialSize:30}),this._queryPool=new vc(IS)}queryVisibleLevelRange(e,t,i,r){const s=this._queryPool.acquire();ct(s.extent,e),s.minLevel=t||-Number.MAX_VALUE,s.maxLevel=null!=i?i:Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s)}hasPendingQueries(){return 0!==this._queryQueue.length}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}processQueries(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear()}scaleQueriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],s=r.extent;t>=r.minLevel&&t<=r.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}}class NS extends Qn{constructor(){super(...arguments),this.blendMode=rC.Normal}}e([Wn({count:rC.COUNT})],NS.prototype,"blendMode",void 0);class FS extends lC{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.blendMode=rC.Normal,this.backgroundColor=Je}}class VS extends As{initializeProgram(e){const t=VS.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Un(vn.ONE,vn.ONE_MINUS_SRC_ALPHA),colorWrite:Vn})}}VS.shader=new Rs(_C,(()=>Promise.resolve().then((()=>_C))));class US extends NS{constructor(){super(...arguments),this.output=mC.Composite,this.baseOpacityMode=gC.One,this.premultipliedSource=!1}}e([Wn({count:mC.COUNT})],US.prototype,"output",void 0),e([Wn({count:gC.COUNT})],US.prototype,"baseOpacityMode",void 0),e([Wn()],US.prototype,"premultipliedSource",void 0);class zS{constructor(e,t,i,r,s,a){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=cr(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=Ae(r,a,s)}destroy(){this.texture.release()}}class jS{constructor(){this._renderParams={context:null,drawPhase:1,state:new cu({viewpoint:new r({targetGeometry:new xc(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(e,t,i,r,s,a,n,o,l,h){const c=a.adjustLevel(t[0]),d=this._renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=h,d.displayLevel=c,d.requiredLevel=c;const u=a.getScale(t[0]),[p,m]=a.getShift(t,n*u),g=.125*n*u/l,f=i.transforms.dvs;f[0]=g,f[4]=-g,f[6]=-1-p-o[0]*n*2,f[7]=1+m+(1-o[1])*n*2-2,d.state.size[0]=l,d.state.size[1]=l,i.stage||i.attachWithContext(e),i.triangleCount=0,r.drawTile(d,i,s)}}class kS extends As{initializeProgram(e){const t=kS.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Un(vn.ONE,vn.ONE_MINUS_SRC_ALPHA),colorWrite:Vn})}}kS.shader=new Rs(vC,(()=>Promise.resolve().then((()=>vC))));class GS extends NS{constructor(){super(...arguments),this.colorizerType=eC.Stretch,this.stretchType=tC.Noop,this.tileBlendInput=pC.LayerOnly,this.baseOpacityMode=gC.One,this.applyColormap=!0}}e([Wn({count:eC.COUNT})],GS.prototype,"colorizerType",void 0),e([Wn({count:tC.COUNT})],GS.prototype,"stretchType",void 0),e([Wn({count:pC.COUNT})],GS.prototype,"tileBlendInput",void 0),e([Wn({count:gC.COUNT})],GS.prototype,"baseOpacityMode",void 0),e([Wn()],GS.prototype,"applyColormap",void 0);class qS{constructor(e){this._rctx=e,this._pools=new Map}acquire(e){return this._getPool(e).acquire()}clear(){this._pools.forEach((e=>e.destroy())),this._pools.clear()}_getPool(e){let t=this._pools.get(e);if(!t){const i=BS.bind(BS,this._rctx,{colorTarget:wn.TEXTURE,depthStencilTarget:On.DEPTH_RENDER_BUFFER,width:e,height:e},(e=>this._getPool(e.width).release(e)));t=new vc(i,null,(()=>{})),this._pools.set(e,t)}return t}}class BS extends To{constructor(e,t,i){super(e,t),this.release=()=>i(this)}}const HS=V.getLogger("esri.views.3d.terrain");class WS{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._fboPools=[],this._doubleBufferFbo=[],this._vectorTileHelper=new jS,this._bindParameters=new ma(null,null,null),this._blendLayersTechniqueConfig=new US,this._poolToWrite=0,this._vaoQuad=Ms(this._rctx,Es),this._fboPools.push(new qS(this._rctx)),this._fboPools.push(new qS(this._rctx))}dispose(){this._fboPools.forEach((e=>{e.clear(),e=null})),this._fboPools=null,this._doubleBufferFbo.forEach((e=>B(e))),this._vaoQuad=B(this._vaoQuad),this._vectorTileHelper=B(this._vectorTileHelper),this._backgroundTechnique=q(this._backgroundTechnique),this._applyOpacityTechnique=q(this._applyOpacityTechnique),this._blendLayersTechnique=q(this._blendLayersTechnique)}_getBlendLayersTechnique(e,t,i,r=!1){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i?t===mC.Composite?gC.OnBaseLayer:gC.OnBackground:gC.One,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(VS,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const i=this._getBlendLayersTechnique(rC.Normal,t,!1),r=this._rctx.bindTechnique(i,e,this._bindParameters);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(xn.TRIANGLE_STRIP,0,Lo(this._vaoQuad,"geometry"))}drawRasterData(e,t,i=!1){if(z(t.texture))return;const r=t.baseOpacity<1;t.blendMode!==rC.Normal||r||i?(t.fboTexture=this._currentFBO.colorTexture,this._switchPool(this._currentFBO.width)):t.fboTexture=null;const s=this._getBlendLayersTechnique(t.blendMode,e,r,i),a=this._rctx.bindTechnique(s,t,this._bindParameters);this._render(a)}drawImageryTileData(e,t,i){const r=e.sourceLayerInfo.data;if(!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,yT.MAP).ensureSymbolizerParameters(r);const s=i.baseOpacity<1;i.blendMode!==rC.Normal||s?(i.fboTexture=this._currentFBO.colorTexture,this._switchPool(this._currentFBO.width)):i.fboTexture=null;const a=this._getRasterColorizerTechnique(r,t,i.blendMode,s),n=this._rctx.bindTechnique(a);if(!r.bind(this._rctx))return;r.opacity=i.opacity;const o=r.getUniforms();o.scale=e.scale,o.offset=e.offset,o.backgroundColor=i.backgroundColor,o.fboTexture=i.fboTexture,o.baseOpacity=i.baseOpacity,a.bindPass(o,null),this._render(n)}_getRasterColorizerTechnique(e,t,i,r){const s=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(s.type);return z(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new GS,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.tileBlendInput=t===mC.ColorComposite?pC.ColorComposite:t===mC.GridComposite?pC.GridComposite:pC.LayerOnly,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=r?t===mC.Composite?gC.OnBaseLayer:gC.OnBackground:gC.One,this._rasterColorizerConfig.colorizerType=a,this._rasterColorizerConfig.applyColormap=!!s.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?tC.Noop:tC.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(kS,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,i,r,s,a,n){const o=this._rctx,l=t.sourceLayerInfo.data,h=t.tile.surface.layerViewByIndex(t.layerIndex,yT.MAP),c=e.baseOpacity<1||e.opacity<1||e.blendMode!==rC.Normal||n!==mC.Composite;let d;this._getBlendLayersTechnique(e.blendMode,n,e.baseOpacity<1,c).bindPipelineState(o),c?(d=this._acquire(s),o.bindFramebuffer(d),o.setClearColor(0,0,0,0),o.clearSafe(Mn.COLOR_BUFFER_BIT|Mn.DEPTH_BUFFER_BIT)):a&&o.clearSafe(Mn.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(o,t.sourceLod,l,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/t.scale),t.offset,r,i)}catch(e){HS.warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!U(d)||(o.bindFramebuffer(this._currentFBO),e.texture=d.colorTexture,e.offset=Pr,e.scale=1,this.drawRasterData(n,e,c),d.release(),a)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,jo.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(Tn.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,jo.TEXTURE_UNIT_FOR_UPDATES)}_initFBO(e,t){this._rctx.bindFramebuffer(e),this._rctx.setViewport(0,0,t,t),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(Mn.COLOR_BUFFER_BIT|Mn.DEPTH_BUFFER_BIT)}_acquire(e){return this._fboPools[this._poolToWrite].acquire(e)}bindPool(e,t){this._poolToWrite=e,null==this._doubleBufferFbo[e]&&(this._doubleBufferFbo[e]=this._acquire(t),this._initFBO(this._doubleBufferFbo[e],t))}_switchPool(e){this._releaseCurrentFBO(),this._doubleBufferFbo[this._poolToWrite]=null,this._poolToWrite=0===this._poolToWrite?1:0,this.bindPool(this._poolToWrite,e)}get _currentFBO(){return this._doubleBufferFbo[this._poolToWrite]}_releaseCurrentFBO(){this._doubleBufferFbo[this._poolToWrite].release(),this._doubleBufferFbo[this._poolToWrite]=null}releasePool(){this._rctx.bindFramebuffer(null),this._releaseCurrentFBO()}cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPools.forEach((e=>e.clear())),this._lastPixelRatio=e,this._lastNumLayers=t)}}class QS{constructor(e,t,i){this._rctx=e,this.tileSize=t,this._techniqueRepository=i,this._passParameters=new FS,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._numTexturedLayer=0,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new WS(this._rctx,this._techniqueRepository),this._blackTex=new SC(Us(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=B(this._composition),this._backgroundTexture=q(this._backgroundTexture),this._blackTex=q(this._blackTex)}get backgroundIsGrid(){return z(this._backgroundColor)}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;this._numTexturedLayer=0;let s=0,a=this.tileSize,n=!1;const o=i.view.state.pixelRatio;let l=!1;const h=e.layerInfo[yT.MAP];let c=h.length,d=0;for(;d<h.length;d++){const t=i.layerViewByIndex(d,yT.MAP),u=t.fullOpacity;if(XS[d]=u,yi(t.layer)&&c>=h.length&&(c=d),0===u){h[d].pendingUpdates&=~(PC.TEXTURE_NOFADING&PC.TEXTURE_FADING);continue}++s;const p=ZS(e,d);if(p){if(h[d].pendingUpdates&=~(PC.TEXTURE_NOFADING&PC.TEXTURE_FADING),qc(t)){const e=ed(t.layer.parent)?"normal":t.layer.blendMode;YS[d]=e;const i="normal"!==e;i&&(l=i,n=!1)}td(t)?a=Math.max(a,this.tileSize*o):1===r&&1===u&&(t.isOpaque||this._dataToTexture(p)&&p.sourceLayerInfo.data.descriptor.isOpaque)&&(n=!0),++this._numTexturedLayer}}this._composition.cleanupFBOPool(o,h.length),a=function(e){const t=rt(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}(a);const u=a/this.tileSize,p=d-1;this._ensureBackgroundTexture(this.tileSize),0!==this._numTexturedLayer?1===this._numTexturedLayer&&!l&&this._useLayerTexture(e,p,c,XS[p])||this._composeMapLayers(e,t,p,c,XS,YS,a,u,!n||l):this._useBackgroundTexture(e,s)}_ensureBackgroundTexture(e){z(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bindPool(0,e),this._passParameters.offset=Pr,this._passParameters.scale=1,this._passParameters.opacity=1,this._passParameters.blendMode=rC.Normal,U(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,U(this.backgroundColor)?mC.ColorOnly:mC.GridOnly),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.releasePool(),this._backgroundDirty=!1)}_useBackgroundTexture(e,t){let i=kT.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(i=kT.Delayed),this._backgroundTexture&&z(e.renderData.textureReference)&&(i=kT.Immediate),e.renderData.setTextureReference(U(this._backgroundTexture)?new zS(this._backgroundTexture,Xd.FADING,$S,e.surface.baseOpacity,1,0):null,i)}_useLayerTexture(e,t,i,r){const s=t<i,a=s?1:e.surface.baseOpacity,n=s?e.surface.baseOpacity:1,o=ZS(e,t);return!!this._dataToTexture(o)&&(e.renderData.setTextureReference(new zS(o.sourceLayerInfo.data,Xd.FADING,o,a,r,n)),!0)}_composeMapLayers(e,t,i,r,s,a,n,o,l){this._composition.bindPool(0,n);const h=e.surface.baseOpacity;let c=!1,d=Rn.LINEAR_MIPMAP_LINEAR,u=!1,p=0;for(let t=i;t>=0;t--){const i=ZS(e,t);if(!i)continue;if(0===s[t])continue;const m=t<r&&h<1&&!c;this._passParameters.baseOpacity=m?h:1,m&&(c=!0);const g=0===p,f=l&&g?this.backgroundIsGrid?mC.GridComposite:mC.ColorComposite:mC.Composite;id(i)?(this._passParameters.opacity=s[t],this._passParameters.blendMode=sC[a[t]],u=this._composition.drawVectorData(this._passParameters,i,o,this.tileSize,n,u,f)):rd(i)?(this._passParameters.opacity=s[t],this._passParameters.blendMode=sC[a[t]],this._composition.drawImageryTileData(i,f,this._passParameters),this._hasNearestInterpolation(i)&&(d=Rn.NEAREST)):this._dataToTexture(i)&&(this._passParameters.texture=i.sourceLayerInfo.data.texture,this._passParameters.offset=i.offset,this._passParameters.scale=i.scale,this._passParameters.opacity=s[t],this._passParameters.blendMode=sC[a[t]],this._composition.drawRasterData(f,this._passParameters)),p++}const m=e.renderData.ensureTexture(n,(()=>this._buildTexture(n,d)));this._composition.copyFBOToTexture(m),this._composition.releasePool(),e.renderData.setTextureReference(new zS(m,t,$S,c?1:h,1,0))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_dataToTexture(e){return sd(e)&&this._rasterDataToTexture(e),ad(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t=Rn.LINEAR_MIPMAP_LINEAR){if(z(e))return null;const i={target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},r=this._rctx;let s;if("number"==typeof e)i.width=i.height=e,s=new SC(new jo(r,i));else if(e instanceof Gc)i.isOpaque=e.isOpaque,s=new SC(new jo(r,i,e.image)),e.release();else try{s=new SC(new jo(r,i,e))}catch(e){s=new SC(zs(r)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=r.bindTexture(s.texture,jo.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),r.bindTexture(a,jo.TEXTURE_UNIT_FOR_UPDATES),s}get test(){return{backgroundTexture:this._backgroundTexture}}}function ZS(e,t){KS.layerIndex=t;const i=e.layerInfo[yT.MAP][t];if(U(i.data))return xr(KS.offset,0,0),KS.tile=e,KS.scale=1,KS.sourceLod=e.lij,KS.sourceLayerInfo=i,KS;const r=i.upsampleInfo;if(U(r)){const e=r.tile.layerInfo[yT.MAP][t];return KS.tile=r.tile,Tr(KS.offset,r.offset),KS.scale=r.scale,KS.sourceLod=r.tile.lij,KS.sourceLayerInfo=e,KS}return null}const XS=new Array,YS=new Array,KS={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},$S={offset:[0,0],scale:1},JS=1e-6;class eP{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}}class tP{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positionAttribute=r,this.rayDirection=Oe(),this.bspNodeTree=new Array,this.vertexPositionBuffer=r.data,this.vertexPositionStride=r.stride;const s=i-t,a=s<=aP?new Uint16Array(s):new Uint32Array(s);this.indices=a;for(let e=0;e<s;++e)a[e]=e;{const n=function(e,t,i,r,s){const a=i-t,n=new Float32Array(6*a);for(let i=0;i<a;++i){const a=3*(i+t),o=e[a+0]*s,l=e[a+1]*s,h=e[a+2]*s;for(let e=0;e<3;++e){const t=r[o+e],s=r[l+e],a=r[h+e];n[6*i+e]=Math.min(t,s,a),n[6*i+3+e]=Math.max(t,s,a)}}return n}(e,t,i,r.data,r.stride),o=Se(Math.log2(s/40),2,10),l=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return Fh(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)rP[e]=t[r+0+e],sP[e]=t[r+3+e]}for(let s=i+1;s<r;++s){const i=6*e[s];for(let e=0;e<3;++e)rP[e]=Math.min(rP[e],t[i+0+e]),sP[e]=Math.max(sP[e],t[i+3+e])}return Fh(rP[0],rP[1],rP[2],sP[0],sP[1],sP[2])}(a,n,e,t),s=t-e;if(s<=40){const i=new eP(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:h,midValue:c}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(r),d=function(e,t,i,r,s,a){let n=i,o=r;for(;n<o;){const i=e[n];t[6*i+s+3]<=a?++n:(--o,e[n]=e[o],e[o]=i)}let l=n;for(o=r;l<o;){const i=e[o-1];t[6*i+s]>=a?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:n,mid:l}}(a,n,e,t,h,c),u=(e,t)=>{if(i>o)return;const r=t-e;return r<40||r>=.8*s?void 0:l(e,t,i+1)},p=new eP(r,h,c,d.next,d.mid);return this.bspNodeTree.push(p),p.leftNode=u(e,d.next),p.rightNode=u(d.mid,t),p};l(0,s,0),this.triangleVertexIndices=function(e,t,i,r){const s=r-i;let a=0;for(let e=i;e<r;++e)for(let i=0;i<3;++i)a=Math.max(t[3*e+i],a);const n=a<=aP?new Uint16Array(3*s):new Uint32Array(3*s);for(let r=0;r<s;++r){const s=3*(e[r]+i);for(let e=0;e<3;++e){const i=t[s+e];n[3*r+e]=i}}return n}(a,e,t,i)}}intersectRayTriangleRange(e,t){{if(e>=t)return;const i=this.triangleVertexIndices,r=this.positionAttribute.data,s=this.positionAttribute.stride,a=this.rayOrigin,n=a[0],o=a[1],l=a[2],h=this.rayDirection,c=h[0],d=h[1],u=h[2];for(let a=e,h=3*e;a<t;++a){const e=i[h]*s,t=r[e],p=r[e+1],m=r[e+2],g=i[h+1]*s,f=r[g],_=r[g+1],y=r[g+2],v=i[h+2]*s,b=r[v],x=r[v+1],w=r[v+2];h+=3;const T=f-t,C=_-p,S=y-m,P=b-t,R=x-p,A=w-m,O=d*A-R*u,M=u*P-A*c,E=c*R-P*d,D=T*O+C*M+S*E;if(Math.abs(D)<=Number.EPSILON)continue;const I=n-t,L=o-p,N=l-m,F=I*O+L*M+N*E;if(D>0){if(F<0||F>D)continue}else if(F>0||F<D)continue;const V=L*S-C*N,U=N*T-S*I,z=I*C-T*L,j=c*V+d*U+u*z;if(D>0){if(j<0||F+j>D)continue}else if(j>0||F+j<D)continue;const k=(P*V+R*U+A*z)/D;if(k>=0){const e=this.indices[a]+this.firstTriangleIndex,t=pn(T,C,S,P,R,A,iP);this.callback(k,t,e,!1)}}}tP.numFacesTested+=t-e}intersectRay(e,t){tP.numFacesTested=0;const i=Ae(e.r0[0],e.r0[1],e.r0[2]),r=Ae(e.r1[0],e.r1[1],e.r1[2]),s=r[0]-i[0],a=r[1]-i[1],n=r[2]-i[2];if(s*s+a*a+n*n<JS)return;this.rayOrigin=i;const o=this.rayDirection;o[0]=s,o[1]=a,o[2]=n;const l=this.triangleVertexIndices.length/3;this.callback=t;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,l)}intersectRayBSP(e,t,i){const r=this.rayOrigin,s=this.rayDirection;if(!function(e,t,i){const r=t,s=i;let a=0,n=1/0;for(let t=0;t<3;++t){{const i=e[t];if(r[t]<i){if(s[t]<=JS)return!1;const e=(i-r[t])/s[t];a=Math.max(a,e)}else if(s[t]<=-JS){const e=(i-r[t])/s[t];n=Math.min(n,e)}if(a>n)return!1}{const i=e[t+3];if(r[t]>i){if(s[t]>=-JS)return!1;const e=(i-r[t])/s[t];a=Math.max(a,e)}else if(s[t]>=JS){const e=(i-r[t])/s[t];n=Math.min(n,e)}if(a>n)return!1}}return!0}(e.aabb,r,s))return;const a=e.axis,n=e.d;if(r[a]<n||s[a]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[a]>n||s[a]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}tP.numFacesTested=0;const iP=Oe(),rP=[1/0,1/0,1/0],sP=[-1/0,-1/0,-1/0],aP=65535;class nP extends is{constructor(){super(...arguments),this.slicePlaneLocalOrigin=Oe(),this.origin=this.slicePlaneLocalOrigin}}var oP,lP,hP;!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}(oP||(oP={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.Depth=2]="Depth",e[e.Normal=3]="Normal"}(lP||(lP={}));class cP extends nP{constructor(){super(...arguments),this.identifier=oP.Material,this.transparent=!1,this.integratedMesh=!1}}class dP extends nP{constructor(){super(...arguments),this.identifier=oP.ShadowMap}}class uP extends nP{constructor(){super(...arguments),this.identifier=oP.Highlight}}class pP extends js{constructor(e,t){super(e,"vec4",ks.Draw,((i,r,s)=>i.setUniform4fv(e,t(r,s))))}}!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(hP||(hP={}));class mP extends on{constructor(){super(...arguments),this.overlayOpacity=1}}function gP(e,t){e.vertex.uniforms.add([new Xa("overlayTexOffset"),new Xa("overlayTexScale")]),e.fragment.uniforms.add([new Vs("overlayOpacity",(e=>e.overlayOpacity)),new Ns("ovColorTex",((e,t)=>0===t.overlays.length?null:t.overlays[Zd.INNER].getColorTexture(e.overlaySource)))]),_P(e,t)}function fP(e,t){const{vertex:i,fragment:r}=e;i.uniforms.add([new pP("overlayTexOffset",((e,t)=>function(e,t){for(const i of t.overlays){const{index:t,extent:r}=i;ii(r)>0&&(vP[2*t]=e.toMapSpace[0]/jt(r)-r[0]/jt(r),vP[2*t+1]=e.toMapSpace[1]/kt(r)-r[1]/kt(r))}return vP}(e,t))),new pP("overlayTexScale",((e,t)=>function(e,t){for(const i of t.overlays){const{index:t,extent:r}=i;ii(r)>0&&(vP[2*t]=e.toMapSpace[2]/jt(r),vP[2*t+1]=e.toMapSpace[3]/kt(r))}return vP}(e,t)))]),r.constants.add("overlayOpacity","float",1),r.uniforms.add(new Ns("ovColorTex",((e,t)=>yP(e,t)))),_P(e,t)}function _P(e,t){e.extensions.add("GL_OES_standard_derivatives"),t.pbrMode!==Hr.Water&&t.pbrMode!==Hr.WaterOnIntegratedMesh||e.include(wa,t);const{vertex:i,fragment:r}=e;e.varyings.add("vtcOverlay","vec4"),i.code.add(an`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),r.code.add(an`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),r.code.add(an`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),t.pbrMode!==Hr.Water&&t.pbrMode!==Hr.WaterOnIntegratedMesh||(r.uniforms.add([new Cs("lightingMainDirection",((e,t)=>t.lighting.lightingMainDirection)),new Cs("lightingMainIntensity",((e,t)=>t.lighting.mainLight.intensity))]),r.code.add(an`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function yP(e,t){return 0===t.overlays.length?null:e.identifier===oP.Material&&e.subPass===lP.Color?t.overlays[Zd.INNER].getColorTextureNoRasterImage():e.identifier===oP.Highlight?t.overlays[Zd.INNER].getValidTexture(Jd.Highlight):null}const vP=hr();function bP(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(an`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(an`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(an`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function xP(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add(new Xa("texOffsetAndScale")),e.fragment.uniforms.add(new Ya("tex")),e.fragment.uniforms.add(new Qa("textureOpacities"));const i=t.textureFadingEnabled&&!t.renderOccluded;i&&(e.vertex.uniforms.add(new Xa("nextTexOffsetAndScale")),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add(new Ya("texNext")),e.fragment.uniforms.add(new Qa("nextTexOpacities")),e.fragment.uniforms.add(new Za("fadeFactor")));const r=t.tileBlendInput===pC.ColorComposite,s=t.tileBlendInput===pC.GridComposite;s&&e.fragment.include(uC),r&&e.fragment.uniforms.add(new Qa("backgroundColor")),e.vertex.code.add(an`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${i?an`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:an``}
  }`),e.fragment.code.add(an`
    vec4 applyBaseOpacity(vec4 _color, vec3 _opacities) {
      return _opacities.z <= 0.0 ? _color : _color * _opacities.x;
    }

    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${s||r?an`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = ${r?an`vec4(backgroundColor, 1.0)`:an`gridColor(uv)`} * opacities.y;
              float alpha = opacities.z * color.a;
              return mix(bg, color, alpha) * opacities.x;`:an`return color;`}
    }`),i?e.fragment.code.add(an`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):e.fragment.code.add(an`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}class wP extends mP{}const TP=zr(),CP=Oe(),SP=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:wP,build:function(e){const t=new ws;t.include(Bh,{name:"Terrain Shader",output:e.output}),t.attributes.add(yn.POSITION,"vec3"),t.attributes.add(yn.UV0,"vec2"),t.attributes.add(yn.NORMAL,"vec3");const{vertex:i,fragment:r}=t;if(i.uniforms.add([new Ts("proj",((e,t)=>t.camera.projectionMatrix)),new Gs("view",((e,t)=>Fr(TP,t.camera.viewMatrix,e.origin))),new qs("origin",(e=>e.origin))]),r.uniforms.add(new qs("origin",(e=>e.origin))),e.output===Bs.Color){t.include(Ls),t.include(Ta,e),t.include(xP,e),t.include(Hh,e);const s=e.overlayMode!==hP.Disabled,a=e.overlayMode===hP.EnabledWithWater;s&&t.include(gP,{...e,pbrMode:Hr.Water}),a&&t.include(bP,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),(e.atmosphere||e.screenSizePerspective)&&i.uniforms.add(new Ts("viewNormal",((e,t)=>t.camera.viewInverseTransposeMatrix)));const n=e.receiveShadows&&!e.renderOccluded;n&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(i.uniforms.add(new Cs("lightingMainDirection",((e,t)=>t.lighting.lightingMainDirection))),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),i.code.add(an`
      void main(void) {
        vpos = position;
        vnormal = ${e.shading?an`normal`:an`getLocalUp(vpos, origin)`};
        vec2 uv = uv0;
        ${e.atmosphere?an`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${e.tileBorders?an`vuv = uv;`:""}
        ${e.screenSizePerspective?an`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${n?an`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${s?an`setOverlayVTC(uv);`:""}
        ${a?an`forwardVertexTangent(vnormal);`:an``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(Hs,e),t.include(Hh,e),t.include(Wh,e),t.include(rs,e),r.uniforms.add([new qs("cameraPosition",((e,t)=>ze(CP,t.camera.eye,e.origin))),new Cs("viewDirection",((e,t)=>Fe(CP,Me(CP,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14])))),new Vs("lightingGlobalFactor",((e,t)=>t.lighting.globalFactor)),new Cs("lightingMainDirection",((e,t)=>t.lighting.lightingMainDirection)),new Cs("lightingMainIntensity",((e,t)=>t.lighting.mainLight.intensity))]),r.constants.add("ambientBoostFactor","float",ss),a&&r.uniforms.add([new Ns("ovWaterTex",((e,t)=>0===t.overlays.length?null:t.overlays[Zd.INNER].getNormalTexture(e.overlaySource))),new Gs("view",((e,t)=>Fr(TP,t.camera.viewMatrix,e.origin)))]),r.code.add(an`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),r.code.add(an`
      void main() {
        ${n?an`float shadow = readShadowMap(vpos, linearDepth);`:an`float shadow = 0.0;`}
        vec3 normal = normalize(vnormal);
        float vndl = dot(normal, lightingMainDirection);
        float ssao = evaluateAmbientOcclusionInverse();
        vec4 tileColor = getTileColor();
        ${s?an`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${e.atmosphere?an`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${e.atmosphere?an`atm + tileColor.rgb;`:an`tileColor.rgb;`}

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl${e.shading?"":an`*2.5`}, 0.0, 1.0));

        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor ${e.shading?"":an`* lightingGlobalFactor`};

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${a?an`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + origin);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?an`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?an`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return e.output!==Bs.Depth&&e.output!==Bs.Shadow||(t.include(Ls,{hasModelTransformation:!1,linearDepth:!0}),t.include(Ws,{output:e.output}),t.include(Ta,e),t.varyings.add("linearDepth","float"),i.uniforms.add(new Ps("nearFar",((e,t)=>t.camera.nearFar))),i.code.add(an`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),r.code.add(an`void main() {
outputDepth(linearDepth);
}`)),e.output===Bs.Normal&&(t.include(Ls),t.include(Ta,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),i.uniforms.add(new Ts("viewNormal",((e,t)=>t.camera.viewInverseTransposeMatrix))),i.code.add(an`
        void main(void) {
          vec3 normal = ${e.shading?an`normal`:an`getLocalUp(position, origin)`};
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
          vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
        }
    `),r.code.add(an`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),e.output===Bs.Highlight&&(t.include(Ls),t.include(Ta,e),t.include(gP,e),i.code.add(an`void main() {
setOverlayVTC(uv0);
gl_Position = transformPosition(proj, view, position);
}`),t.include(Qs),r.code.add(an`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),t}},Symbol.toStringTag,{value:"Module"}));class PP extends As{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.spherical=e.viewingMode===Gi.Global}initializeProgram(e){const t=PP.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,i=t.backfaceCullingEnabled&&!t.renderOccluded;return Nn({blending:t.renderOccluded?Un(vn.ONE,vn.ONE_MINUS_SRC_ALPHA):null,culling:i&&zn,depthTest:!t.renderOccluded&&{func:bn.LESS},depthWrite:!t.renderOccluded&&jn,colorWrite:Vn,stencilTest:e?Zs(_d.IntegratedMeshMaskExcluded):null})}getPipelineState(e,t){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,t)}}PP.shader=new Rs(SP,(()=>Promise.resolve().then((()=>SP))));class RP extends Xs{constructor(){super(...arguments),this.output=Bs.Color,this.overlayMode=hP.Disabled,this.tileBlendInput=pC.LayerOnly,this.spherical=!1,this.atmosphere=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.tileBorders=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.shading=T("enable-feature:terrain-shading")}}e([Wn({count:Bs.COUNT})],RP.prototype,"output",void 0),e([Wn({count:hP.COUNT})],RP.prototype,"overlayMode",void 0),e([Wn({count:pC.COUNT})],RP.prototype,"tileBlendInput",void 0),e([Wn()],RP.prototype,"spherical",void 0),e([Wn()],RP.prototype,"atmosphere",void 0),e([Wn()],RP.prototype,"receiveShadows",void 0),e([Wn()],RP.prototype,"hasSlicePlane",void 0),e([Wn()],RP.prototype,"backfaceCullingEnabled",void 0),e([Wn()],RP.prototype,"stencilEnabled",void 0),e([Wn()],RP.prototype,"textureFadingEnabled",void 0),e([Wn()],RP.prototype,"renderOccluded",void 0),e([Wn()],RP.prototype,"hasScreenSpaceReflections",void 0),e([Wn()],RP.prototype,"hasCloudsReflections",void 0),e([Wn()],RP.prototype,"tileBorders",void 0),e([Wn()],RP.prototype,"screenSizePerspective",void 0),e([Wn()],RP.prototype,"receiveAmbientOcclusion",void 0),e([Wn()],RP.prototype,"shading",void 0),e([Wn({constValue:!0})],RP.prototype,"isGround",void 0),e([Wn({constValue:Hr.Disabled})],RP.prototype,"pbrMode",void 0),e([Wn({constValue:!1})],RP.prototype,"highStepCount",void 0),e([Wn({constValue:!1})],RP.prototype,"useCustomDTRExponentForWater",void 0),e([Wn({constValue:!1})],RP.prototype,"useFillLights",void 0);const AP=Eh(),OP=hr();let MP=class extends N{constructor(e){super(e),this.type=Xl.TERRAIN,this.isGround=!0,this.tileSize=256,this._techniqueConfiguration=new RP,this._passParameters=new wP,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new LS,this.renderDataPool=new vc(qC),this._patchGroups=new Map,this.patchGroupsDirty=!0,this.tileIterator=new GT,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._velvetOverground=!0,this._castShadows=!0,this.emptyTex=null,this.tileRenderer=null,this.stencilEnabledLayerExtents=[],this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=mn.Occlude}get isGlobal(){return this.stage.viewingMode===Gi.Global}get shadingEnabled(){return this._techniqueConfiguration?.shading}initialize(){const e=[Zo.OPAQUE_TERRAIN,Zo.TRANSPARENT_TERRAIN,Zo.OCCLUDED_TERRAIN];this.stage.addRenderPlugin(e,this)}destroy(){this.stage.removeRenderPlugin(this),NT.clear()}get canRender(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get opaque(){return this._opaque&&!this._techniqueConfiguration.hasSlicePlane}get needsLinearDepth(){return this.overlayRenderer.hasWater}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return ph}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}toggleShading(){this._techniqueConfiguration.shading=!this._techniqueConfiguration.shading,this.setNeedsRender()}setRootTiles(e){this._rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?Ca:mn.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,U(this.tileRenderer)&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}_prepareTileForLoading(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometry(e),this.updateTileTexture(e,PC.TEXTURE_FADING)}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender()}updateTileTexture(e,t){U(this.tileRenderer)&&(this.tileRenderer.updateTileTexture(e,t===PC.TEXTURE_FADING?Xd.FADING:Xd.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){this._prepareTileForLoading(e),e.renderData.updateGeometryStateAndPrepareForGeometryGeneration(this.wireframe)}updateTileGeometry(e){for(const t of e.layerInfo[yT.ELEVATION])t.pendingUpdates&=~PC.GEOMETRY;e.resetPendingUpdate(PC.GEOMETRY),e.renderData.updateGeometryIfChanged(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this.renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this.isGlobal&&0===t)return Je;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll((e=>{e.isLoaded&&(this.updateTileGeometry(e),e.updateNeighborsAfterGeometryChange())})),this.setNeedsRender())}setNeedsRender(e=gd.UPDATE){this.patchGroupsDirty=!0,this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this.rctx=e.renderContext.rctx,this._techniqueRepository=e.shaderTechniqueRepository,this.tileRenderer=new QS(this.rctx,this.tileSize,this._techniqueRepository),this.updateTileBackground(),this.emptyTex=zs(this.rctx)}uninitializeRenderContext(){this.emptyTex=B(this.emptyTex),this.tileRenderer=B(this.tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const s=IP,a=LP;ze(s,r,i),Me(a,1/s[0],1/s[1],1/s[2]);const n=e.results.min,o=e.results.max,l=e.results.ground,h=e.options.store===Ql.MIN,c=!!e.results.ground.target,d=mh(e.verticalOffset),u=e.tolerance;let p,m=h&&U(n.dist)?n.dist:1/0;const g=c=>{const g=c.renderData;if(!g?.vao)return;const f=g.geometryInfo;Vh(AP,f.boundingBox);const _=g.localOrigin;U(d)&&(d.localOrigin=_,d.applyToAabb(AP));const y=AP;if(NP[0]=i[0]-_[0],NP[1]=i[1]-_[1],NP[2]=i[2]-_[2],!un(y,NP,a,u,m))return;const v=(e,t,i)=>{e.set(this.type,c,t,i,kr),m=h&&U(n.dist)?n.dist:1/0},b=(a,h)=>{if(U(h)&&a>=0&&(e.options.backfacesTerrain||je(h,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,r,a))){if((null==l.dist||a<l.dist)&&v(l,a,h),e.options.isFiltered)return;e.options.store===Ql.ALL&&(z(p)?(p=Kl(e.ray),v(p,a,h),e.results.all.push(p)):a<p.dist&&v(p,a,h)),(null==n.dist||a<n.dist)&&v(n,a,h),e.options.store!==Ql.MIN&&(null==o.dist||a>o.dist)&&v(o,a,h)}},x=FP;ze(x,r,_);const w=f.indices,T=f.vertexAttributes,C={data:T.getField(yn.POSITION,lu).typedBuffer,size:3,stride:T.stride/4},S=f.indexCount/3;if(z(d)&&S>200){const e=c.renderData;z(e.intersectionData)&&(e.intersectionData=new tP(w,0,S,C)),e.intersectionData.intersectRay({r0:NP,r1:x},b)}else gn(NP,x,0,S,w,C,null,d,b)},f=this._rootTiles;U(f)&&(()=>{const t=this.tileIterator;t.reset(f);const r=e.options.invisibleTerrain;for(;!t.done;){const e=t.next();!(e.visible||r&&e.intersectsClippingArea)||!U(d)&&!e.intersectsRay(i,s,u,m)||c&&this._useStencilForTile(e)?t.skipSubtree():g(e)}})()}prepareTechnique(e){if(e.bindParameters.slot===Zo.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&Ca))return null}else{const t=this.opaque?Zo.OPAQUE_TERRAIN:Zo.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.pass){case Xo.MATERIAL:{this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=U(e.bindParameters.clouds.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.ready,this._techniqueConfiguration.overlayMode=this.overlayRenderer.isEmpty()?hP.Disabled:this.overlayRenderer.hasWater?hP.EnabledWithWater:hP.Enabled;const t=e.bindParameters.slot===Zo.OCCLUDED_TERRAIN?Sa.Occluded:Sa.ColorAndWater;return this._updateTechnique(Bs.Color,t===Sa.Occluded)}case Xo.MATERIAL_DEPTH_SHADOWMAP_ALL:case Xo.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this._castShadows&&1===e.bindParameters.lighting.globalFactor?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(Bs.Shadow,!1)):null;case Xo.MATERIAL_DEPTH:return this.isTransparent&&this.overlayRenderer.isEmpty()?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(Bs.Depth,!1));case Xo.MATERIAL_NORMAL:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(Bs.Normal,!1);case Xo.MATERIAL_HIGHLIGHT:return this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(Bs.Highlight,!1)):null}return null}render(e,t){const i=e.pass,r=1===e.bindParameters.lighting.globalFactor;switch(this._updatePatchGroups(),t.useStencil=!1,i){case Xo.MATERIAL:{const i=e.bindParameters.slot===Zo.OCCLUDED_TERRAIN?Sa.Occluded:Sa.ColorAndWater;this._renderMaterialPass(e,t,i);break}case Xo.MATERIAL_DEPTH_SHADOWMAP_ALL:case Xo.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:this._castShadows&&r&&this._renderAuxiliaryPass(e,t,Sa.None);break;case Xo.MATERIAL_DEPTH:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,t,Sa.None);break;case Xo.MATERIAL_NORMAL:this._renderAuxiliaryPass(e,t,Sa.None);break;case Xo.MATERIAL_HIGHLIGHT:this.needsHighlight&&(this._renderAuxiliaryPass(e,t,Sa.Highlight),e.rctx.clearSafe(Mn.DEPTH_BUFFER_BIT))}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(e,t,i):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,t,i)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(e,t,i){const r=e.rctx;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,i)}updateTileBackground(e=null){if(z(this.tileRenderer))return;const t=this.tileRenderer;let i=null;if(U(e)){const t=nr.toUnitRGBA(e);i=Ae(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this.allTiles.forAll((e=>t.updateTileTexture(e,Xd.FADING))),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?pC.GridComposite:U(t.backgroundColor)?pC.ColorComposite:pC.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this.patchGroupsDirty){if(this.highestVisibleLODTile=null,this._rebuildPatchGroups(),this.renderOrder!==AS.NONE){const e=Array.from(this._patchGroups.values());e.forEach((e=>WT(this.renderOrder,e))),e.sort(((e,t)=>QT(e[0],t[0],this.renderOrder))),this._patchGroups=new Map(e.map((e=>[e[0].renderData.localOrigin,e])))}this.patchGroupsDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(!z(e)){e[0]?.surface.checkAllTileWaterproofness(),this._patchGroups.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this.tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i||e.visible)if(e.rendered){if(i){const r=this._patchGroups.get(i.localOrigin)||new Array;this._patchGroups.set(i.localOrigin,r),r.push(e),(!this.highestVisibleLODTile||e.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=e),t.skipSubtree()}}else this.numTilesCulled++;else this.numTilesCulled++,t.skipSubtree()}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i){const r=this.stencilEnabledLayerExtents.length>0;this._patchGroups.forEach((s=>{const a=s[0].renderData.localOrigin;t.program.bindDraw(new Pa(a),e.bindParameters);for(let a=0;a<s.length;a++)this._renderPatch(e,t,s[a],xn.TRIANGLES,r,i)})),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i){const r=e.rctx,s=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=cn(this.stage.viewingMode,this.ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const n=this.stencilEnabledLayerExtents.length>0,o=i===Sa.Occluded;o&&(a.bindTexture("tex",this.emptyTex),a.setUniform1f("blend",1),a.setUniform4fv("texOffsetAndScale",ur));const l=U(this.tileRenderer)&&U(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:Je;this._techniqueConfiguration.tileBlendInput===pC.ColorComposite&&a.setUniform3fv("backgroundColor",l);const h=this.wireframe?xn.LINES:xn.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this.emptyTex),this._patchGroups.forEach((r=>{const s=r[0].renderData.localOrigin;t.program.bindDraw(new Pa(s),e.bindParameters),this.numOriginsRendered++;for(let s=0;s<r.length;s++){const l=r[s],c=l.renderData.textureReference;if(!z(c)){if(!o){this._scaleRangeQueries.scaleQueriesForTile(l),DP(l.renderData.geometryInfo.uvOffsetAndScale,c.offsetAndScale,OP),a.setUniform4fv("texOffsetAndScale",OP),a.bindTexture("tex",c.texture.texture);const e=l.renderData.textureFadeFactor,t=e<1?l.renderData.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&U(t)&&e<1?(DP(l.renderData.geometryInfo.uvOffsetAndScale,t.offsetAndScale,OP),a.setUniform1f("fadeFactor",e),a.setUniform4fv("nextTexOffsetAndScale",OP),a.setUniform3fv("nextTexOpacities",t.opacities),a.bindTexture("texNext",t.texture.texture)):a.setUniform1f("fadeFactor",1),l.renderData.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",c.opacities)}this._renderPatch(e,t,l,h,n,i),l.renderOrder=this.numTilesRendered,this.numTilesRendered++}}})),r.bindVAO(null)}_renderPatch(e,t,i,r,s,a){const n=i.renderData,o=n.vao,l=o.indexBuffer;if(z(l))return;const h=t.program;a!==Sa.None&&this._bindOverlayPatchData(h,n.overlay),s&&(t.useStencil=this._useStencilForTile(i),t.bindPipelineState(e.rctx,e.bindParameters.slot));const c=n.geometryInfo.indexCount;e.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(r,c,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,e===Bs.Color&&(this._techniqueConfiguration.atmosphere=this.isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(PP,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this.tileRenderer}}};e([ve({constructOnly:!0})],MP.prototype,"overlayRenderer",void 0),e([ve({constructOnly:!0})],MP.prototype,"stage",void 0),e([ve({readOnly:!0})],MP.prototype,"isGlobal",null),e([ve({constructOnly:!0})],MP.prototype,"allTiles",void 0),e([ve({constructOnly:!0})],MP.prototype,"ellipsoidRadius",void 0),e([ve({value:!1})],MP.prototype,"renderingDisabled",null),e([ve()],MP.prototype,"renderPatchBorders",null),e([ve()],MP.prototype,"cullBackFaces",null),e([ve({value:AS.FRONT_TO_BACK})],MP.prototype,"renderOrder",null),e([ve()],MP.prototype,"wireframe",null),MP=e([xe("esri.views.3d.terrain.TerrainRenderer")],MP);const EP=MP;function DP(e,t,i){i[0]=e[0]*t[2]+t[0],i[1]=e[1]*t[3]+t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3]}const IP=Oe(),LP=Oe(),NP=Oe(),FP=Oe();class VP{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let UP=class extends N{constructor(e){super(e),this._handles=new lr}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(K((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=k(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!_i(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return U(Fc(e,t,i))}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||Vc(t))))),e)if(e.isResolved()){const t=Fc(e,this.viewSpatialReference,this.viewingMode);if(U(t)){const e=new qd(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Gi.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=qd.makeWebMercatorAuxiliarySphere(t):St(e.spatialReference)&&(e=qd.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(K((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Gi.Global){const e=this.extentHelper.viewSpatialReference,t=St(e)||gr(e)||fr(e);e.isWebMercator?this.tilingScheme=qd.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=qd.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;U(e)&&!$t(e,this.extent)&&(this.tilingScheme=qd.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};e([ve()],UP.prototype,"tilingScheme",void 0),e([ve({readOnly:!0})],UP.prototype,"extent",void 0),e([ve({value:!1})],UP.prototype,"tilingSchemeLocked",void 0),e([ve({constructOnly:!0})],UP.prototype,"viewSpatialReference",void 0),e([ve({constructOnly:!0})],UP.prototype,"layers",void 0),e([ve({constructOnly:!0})],UP.prototype,"extentHelper",void 0),e([ve({constructOnly:!0})],UP.prototype,"viewingMode",void 0),UP=e([xe("esri.views.3d.terrain.TilingSchemeLogic")],UP);class zP{constructor(){this.offset=Sr(),this.scale=0,this.tile=null}init(e,t,i,r){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const jP=V.getLogger("esri.views.3d.terrain.TerrainSurface");let kP=class extends(or.EventedMixin(N)){constructor(e){super(e),this._elevationBounds=new cT,this._iteratorPool=new vc(GT,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new qT,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=null,this._performanceInfo=new VP,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=Oe(),this._eyePosSurfaceSR=Oe(),this._splitLimits=new MC,this._snapLevel=1/0,this._frustum=ac(),this._viewProjectionMatrix=zr(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new lr,this._watchUpdatingTracking=new Wi,this._frameTask=Ao,this._allTiles=new le,this._upsampleInfoPool=new vc(zP),this._rootTilesExtent=Vt(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundColor=null,this._updatingRootTiles=!1,this.deferTileNeighborUpdate=!1,this.neighborTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._layerViewsDirty=!1,this._isGlobal=!e.view?.state?.isLocal}initialize(){this._lercDecoder=Id(this.view.resourceController),this._tilePool=this.view.state.isLocal?new vc(PS):new vc(OS);const e=this.view.resourceController.memoryController;var t,i;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new Dd(e.newCache("elevation-query")),this._set("overlayManager",new TT({surface:this})),this._handles.add([K((()=>this.overlayManager.hasHighlights),(e=>this._renderer.setNeedsHighlight(e))),K((()=>this.overlayManager.rendersOccluded),(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new EP({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:vr(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([K((()=>this.baseOpacity),(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)}),J),K((()=>this.hasCompositeBlendMode),(()=>{this._updateBaseOpacity(this.baseOpacity)}),J),K((()=>this.renderingDisabled),(()=>this._updateTransparentTerrain()),te),K((()=>this.backgroundColor),(e=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(e)}),J),K((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>()=>this._allTilesSorted=!1))})),K((()=>fa.TERRAIN_TILE_TREE_SHOW_TILES),(e=>{e&&!this._treeDebugger?import("../chunks/TerrainTileTree3DDebugger.js").then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&fa.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))})):e||(this._treeDebugger=k(this._treeDebugger))}),$)]),this._extentHelper=(t=this.viewingMode,i={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference},t===Gi.Global?new gT(i):new fT(i));const r=this.view.defaultsFromMap?new Od({getCollections:()=>this.view?.defaultsFromMap?.mapCollections?.map((({layers:e})=>e)),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}):this.view.map.allLayers,s=new UP({layers:r,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",s),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(Tw.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(Tw.BASEMAP);const a=this.view.resourceController.scheduler;this._frameTask=a.registerTask(So.TERRAIN_SURFACE,this),this._handles.add([K((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),$),K((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),te),K((()=>this.extent),(()=>this._updateRootTiles()),$),this.view.on("resize",(()=>this._viewChangeUpdate())),K((()=>{const e=this.view,t=e.state;return[this.lodBias,this.lodSnapping,e.resourceController?.memoryController?.memoryFactor,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),J),K((()=>this.view.qualitySettings?.tiledSurface?.textureFadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),$),K((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),te)]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=q(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=k(this._upsampleMapCache),this._elevationQueryCache=k(this._elevationQueryCache),this._set("tilingSchemeLogic",k(this.tilingSchemeLogic)),this._extentHelper=k(this._extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",k(this.overlayManager)),this._tilePool=k(this._tilePool),EC.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=k(this._renderer),this._iteratorPool=k(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=k(this._upsampleInfoPool),Nd(),CC.size>0&&(console.log(`${CC.size} live TilePerLayerInfo allocations:`),CC.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){const e=this.view.pointsOfInterest?.contentCameraOnSurface?.scale;if(e){const t=this.view.state.contentCamera;let i=kl(this.view,t.eye,t.viewForward,t.up).tilt;i>90&&(i=180-i);const r=2*(i/90)**2,s=Il(this.view,e)-r;Math.abs(this._snapLevel-s)>.25&&(Math.round(s)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=s)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Yd.ON:Yd.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(z(t)||z(e))return null;const i=Vt(),r=yl(t,i,e)?i:null,s=this._get("extent");return $t(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=Jt(this.groundExtent,this._userClippingExtent,Vt()),t=this._get("extent");return $t(e,t)?t:e}get groundExtent(){return U(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return U(this.rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get spatialReference(){return this.tilingScheme?.spatialReference??null}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._updateTransparentTerrain()}_updateTransparentTerrain(){const e=!this.renderingDisabled&&!this.opaque;this.view?._stage?.renderView.setRenderParameters({transparentTerrain:e})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=this.getTileWithElevation(e,t,i,r,HP);return z(s)?null:uT(HP[0],HP[1],s.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=HP){const a=this.rootTiles;if(z(a)||!a.length)return null;if(0===a[0].layerInfo[yT.ELEVATION].length)return null;if(s[0]=e,s[1]=t,s[2]=i,!Ot(s,r,s,this.tilingScheme?.spatialReference))return jP.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let e of a){if(!e.containsPoint(s))continue;for(;e&&!e.rendered&&!e.isLeaf;){let t=0;s[0]>.5*(e.extent[0]+e.extent[2])&&(t+=1),s[1]<.5*(e.extent[1]+e.extent[3])&&(t+=2),e=e.children[t]}const t=e.renderData;return t&&t.geometryState.samplerData?e:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!Et(e,HP,this.spatialReference))return jP.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(U(t))for(let e of t)if(e?.containsPoint(HP)){for(;!e.isLeaf&&!e.rendered;){let t=0;HP[0]>e.children[0].extent[2]&&(t+=1),HP[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}getSphereElevationBounds(e,t,i,r,s){if(HP[0]=e,HP[1]=t,HP[2]=i,HP[3]=r,!Ot(HP,s,HP,this.tilingScheme?.spatialReference))return jP.error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let a=1/0,n=-1/0;const o=e=>{if(e&&ri(e.extent,HP))if(e.isLeaf||e.rendered)a=Math.min(a,e.elevationBounds[0]),n=Math.max(n,e.elevationBounds[1]);else for(const t of e.children)o(t)},l=this.rootTiles;if(U(l))for(const e of l)o(e);return{min:a,max:n}}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!Et(e,HP,this.spatialReference))return jP.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;HP[3]=t;let i=null;const r=e=>{if(e&&ri(e.extent,HP))if(e.isLeaf||e.rendered){const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}else for(const t of e.children)r(t)},s=this.rootTiles;if(U(s))for(const e of s)r(e);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+n,a+n,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1&&!this.hasCompositeBlendMode,this._renderer.isTransparent=this._allSurfaceLayersTransparent();const i=t!==this._renderer.opaque;i&&this._updateTransparentTerrain(),this._updateTileTextures(i?Xd.UNFADED:Xd.IMMEDIATE)}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;e!==this.tilingScheme&&(kc(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles()))}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return QP[0]=e,QP[1]=t,QP[2]=i,s.init(QP,r,this),s}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=WP;let r=t.rootTilesInExtent(e,i,5*Bd);if(U(this.rootTiles)){if(r.length>Bd)return void jP.warn(Hd);const e=this.rootTiles.map((e=>e.lij)),t=P(e,r,qP);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex((t=>qP(t,e.lij)))>-1&&(this._purgeTile(e,!0),1))));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,r.length>Bd&&(jP.warn(Wd),r=t.rootTilesInExtent(e,i,Bd)),this._setRootTiles(r.map((e=>this._newRootTile(e))));$t(i,this._rootTilesExtent)||(this._rootTilesExtent=Vt(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._allTiles.forEach((e=>{e.isLoaded&&this._prepareToLoadTile(e)})),this._allTiles.forAll((e=>{e.isLoaded&&(this._updateTileGeometry(e),this._updateTileNeighborsAfterGeometryChange(e))})),this._updatingRootTiles=!1,this.checkAllTileWaterproofness()}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===PC.SPLIT&&t.setPendingUpdate(PC.SPLIT),this._loadTile(t),this.deferTileNeighborUpdate||t.checkGeometryWaterproofness(),t}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),U(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(PC.GEOMETRY)&&this._updateTileGeometry(e)}_updateTilesVisibility(e){if(z(e))return;const t=function(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==i&&t.loadable)return!0}}return!1}(e);let i=t?this._elevationBounds.min:1/0,r=t?this._elevationBounds.max:-1/0;const s=this.view.state.fixedContentCamera,a=this.extent,n=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(a)&&e.resetPendingUpdate(PC.GEOMETRY)&&this._updateTileGeometry(e),e.setPendingUpdate(PC.RENDERDATA);const t=e.computeVisibility();s||t?(e.updateScreenDepth(n),e.renderData&&(i=Math.min(e.elevationBounds[0],i),r=Math.max(e.elevationBounds[1],r))):o.skipSubtree()}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(z(this._splitLimits.frustum)&&(this._splitLimits.frustum=ac()),_c(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,_c(this._frustum,e.frustum),Ir(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),De(this._eyePosRenderSR,t.eye),Ot(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(BP(e)?(this._loadChildren(e),this.deferTileNeighborUpdate||(this._checkTileNeighborsWaterproofness(e),e.children.forEach((e=>e.checkGeometryWaterproofness())))):function(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._updateTileNeighborsAfterGeometryChange(e),this._elevationUpdate(e),this._usedMemory=null,this.deferTileNeighborUpdate&&this.neighborTilesToUpdate.delete(e)}_updateTileNeighborsAfterGeometryChange(e,t){if(this.deferTileNeighborUpdate){const t=this.neighborTilesToUpdate;e.forEachLoadedNeighbor((e=>{t.add(e)}))}else e.updateNeighborsAfterGeometryChange(t)}_updateTileTexture(e,t){const i=e.resetPendingUpdate(PC.TEXTURE_FADING)?PC.TEXTURE_FADING:!!e.resetPendingUpdate(PC.TEXTURE_NOFADING)&&PC.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_elevationUpdate(e){XP.spatialReference=this.spatialReference,XP.tile=e,XP.extent=e.extent,this.emit("elevation-change",XP)}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done?this.requestUpdate():this._usedMemory=this._recalculateUsedMemory(),this.notifyChange("updatingProgressValue")}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(i===PC.SPLIT){e.resetPendingUpdate(PC.MERGE),e.isLeaf&&(e.setPendingUpdate(PC.SPLIT),t.skipSubtree());continue}e.resetPendingUpdate(PC.SPLIT)&&e.updateAgentSuspension(),i===PC.VSPLITMERGE&&e.updateAgents(yT.ELEVATION)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(PC.MERGE),e.resetPendingUpdate(PC.SPLIT);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(function(e,t){const i=new Map;e.forAll((e=>i.set(e.lij,e.distanceToSquared(t)))),e.sort(((e,t)=>i.get(e.lij)-i.get(t.lij)||HT(e,t)))}(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_prepareBatchTileGeometryUpdate(){Uc(0===this.neighborTilesToUpdate.size),this.deferTileNeighborUpdate=!0}_batchUpdateUpdatedTileNeighbors(){this.deferTileNeighborUpdate=!1;const e=this.neighborTilesToUpdate;(()=>{for(const t of e)t.updateNeighborDataAndGeometryIfNeeded()})(),(()=>{for(const t of e)t.updateNeighborsWithChangedEdgeResolution()})(),e.clear()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate(),this._prepareBatchTileGeometryUpdate();let i=!1;for(;!e.done;){i=!0;let r=!1;const s=!this._allTiles.some((i=>{if(i.resetPendingUpdate(PC.MERGE)){if(!t)return i.setPendingUpdate(PC.MERGE),e.done;this._mergeTile(i),r=!0,e.madeProgress()}else i.resetPendingUpdate(PC.SPLIT)&&(this._splitTile(i),r=!0,e.madeProgress());return!e.done&&i.resetPendingUpdate(PC.RENDERDATA)&&(this._updateRenderData(i),e.madeProgress()),e.done}));if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(!r)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}i||(this._allTilesDirty=!0),this._batchUpdateUpdatedTileNeighbors(),this._sortTiles(e)}_updateElevation(e){return this._prepareBatchTileGeometryUpdate(),this._allTiles.some((t=>(t.resetPendingUpdate(PC.GEOMETRY)&&(this._updateTileGeometry(t),this._updateTileTexture(t,e),e.madeProgress()),e.done))),this._batchUpdateUpdatedTileNeighbors(),e.hasProgressed}_updateTextures(e){return this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done))),e.hasProgressed}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(gd.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Qd}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=Se(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){U(this.rootTiles)&&(this.rootTiles.forEach((e=>this._purgeTile(e,!1))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeDescendantTiles(e){if(e.isLeaf)return!1;let t=!1;for(let i=0;i<4;++i)t=this._purgeTile(e.children[i],!1)||t;return e.unsetChildren(),t}_purgeTile(e,t){const i=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),t&&this._updateTileNeighborsAfterGeometryChange(e),this._tilePool.release(e),i}_unloadTile(e){this.deferTileNeighborUpdate&&this.neighborTilesToUpdate.delete(e),e.unload(this._renderer)}_splitTile(e){kc(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(PC.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){YP.spatialReference=this.spatialReference,YP.extent=e.extent,YP.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",YP)}_createTile(e,t,i,r){kc(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===PC.SPLIT&&s.setPendingUpdate(PC.SPLIT)),s}_mergeTile(e){kc(!e.hasPendingUpdate(PC.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(kc(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._updateTileNeighborsAfterGeometryChange(e),this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_checkTileAndNeighborsWaterproofness(e){e.checkGeometryWaterproofness(),this._checkTileNeighborsWaterproofness(e)}_checkTileNeighborsWaterproofness(e){}_loadChildren(e){this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(e),kc(e.rendered,"parent should be rendered"),this._unloadTile(e);const t=e.children;t.forEach((e=>this._prepareToLoadTile(e))),t.forEach((e=>this._loadTilePrepared(e))),this._updateTileNeighborsAfterGeometryChange(e,e.level+1),this.deferTileNeighborUpdate||(t.forEach((e=>e.updateNeighborsWithChangedEdgeResolution())),t.forEach((e=>e.checkGeometryWaterproofness())),this._checkTileNeighborsWaterproofness(e))}_loadParent(e){this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(e);const t=e.parent;this._unloadChildren(t),this._loadTile(t),this._updateTileNeighborsAfterGeometryChange(t),this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(t)}_unloadChildren(e){if(!e.isLeaf)for(let t=0;t<4;++t){const i=e.children[t];this._unloadChildren(i),this._unloadTile(i)}}_postLoadTile(e){e.setPendingUpdate(PC.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_loadTile(e){e.load(this._renderer),this._postLoadTile(e)}_loadTilePrepared(e){e.loadPrepared(this._renderer),this._postLoadTile(e)}_prepareToLoadTile(e){e.prepareToLoad(this._renderer)}_elevationDataArrived(e,t,i){const r=new dT(e.lij,e.extent,i);e.dataArrived(t,yT.ELEVATION,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds()}n.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(e=Ro){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const e of this.view.allLayerViews.items)if(i.add(e.uid),nd(e))if(this._basemapLayerViewHandles.has(e.uid)){const i=this._layerClassFromLayerView(e),s=this._getLayerIdxByUID(i,e.uid);U(s)&&((s<r||z(r))&&(t=!0),r=s)}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allSurfaceLayersTransparent(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),e.madeProgress()}_allSurfaceLayersTransparent(){let e=0===this.view.map?.ground?.opacity;for(const t of this.view.allLayerViews.items)if(od(t)&&!yi(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if(qc(e)){const t=ed(e.layer.parent)?"normal":e.layer.blendMode;if(aC(sC[t]))return!0}return!1}_layerClassFromLayerView(e){return ld(e)?yT.ELEVATION:yT.MAP}_registerTiledLayerView(e){const t=[],i=this._layerClassFromLayerView(e);t.push(K((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push(K((()=>e.fullOpacity),(()=>this._updateTileTextures(Xd.UNFADED)))),t.push(K((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),qc(e)&&t.push(K((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(Xd.UNFADED)}))),e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);U(t)&&this._invalidateLayerData(t,i)})),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!nd(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(r===yT.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)}));for(const e of vT){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let a=i.length!==s;const n=new Array(s),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByUid[e].set(s,t);const l=i.indexOf(r[t]);n[t]=l,t!==l&&(a=!0),l>-1&&(o[l]=t)}if(a){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;)t.next().modifyLayers(o,n,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===yT.ELEVATION&&i.computeElevationBounds()}}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(yT.MAP),e===Xd.IMMEDIATE?this.renderer.updateTileTexture(t,PC.TEXTURE_NOFADING):t.updateRenderData(yT.MAP,e)})),this._renderer.isTransparent=this._allSurfaceLayersTransparent()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=gd.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return!a.tilemapCache||td(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,u(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return t===yT.ELEVATION?ld(i)?this._requestElevationTileData(e,i,r):Promise.reject():od(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=r=>{if(d(i))return;const s=this._layerIndexByUid[yT.ELEVATION].get(t.uid);null!=s?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,s,r)):jP.warn("TerrainSurface: received data from unknown layer %d %s",yT.ELEVATION,e.lij.toString())},s=i=>{u(i)||(this._dataMissing(e,yT.ELEVATION,t,i),this.requestUpdate())};if(hd(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:Fd,signal:i.signal}).then((e=>{if(!d(i))return this._frameTask.schedule((()=>r(e)),i.signal,s);jP.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")}),s).finally((()=>{--this._asyncWorkItems}));const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:Fd},i.signal))).then((e=>{e?r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue}):s(new Error("LERC decoding failed"))}),s).finally((()=>{--this._asyncWorkItems}))}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,jc(s),d(i)||(this._dataMissing(e,yT.MAP,t,r),this.requestUpdate())},s=e=>t=>r(t,e),a=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),d(i)?jc(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),n=(e,t=null)=>this._frameTask.schedule((()=>r(e,t)));if(td(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(a,n)}if(cd(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,n);if(dd(t)&&hd(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(d(i))return jP.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(h());a(e)}),n);let o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);Ed(t.layer)&&t.layer.refreshTimestamp&&(o+=`${o.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,l,i).then(a,n)}_mapTileDataArrived(e,t,i){const r=this._getLayerIdxByUID(yT.MAP,t.uid);U(r)?e.dataArrived(r,yT.MAP,i):(jc(i),jP.warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i,r){const s=this._getLayerIdxByUID(t,i.uid);U(s)?e.dataMissing(s,t,r):jP.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}getUsedMemory(){return this.tilingScheme?(z(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),U(this._usedMemory)?this._usedMemory:0):0}_recalculateUsedMemory(){return this.tilingScheme?this._allTiles.reduce(((e,t)=>e+t.usedMemory),0):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return U(r)&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if(z(e)||z(this.rootTiles))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1}return kc(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{U(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){ZP.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&ZP.push(e)}));const t=ZP.toArray();return WT(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}checkAllTileWaterproofness(){}get isGlobal(){return this._isGlobal}get shadingEnabled(){return this._renderer.shadingEnabled}get isWebMercator(){return!!this.tilingScheme?.spatialReference.isWebMercator}get isWebMercatorOnPlateeCarree(){return this.isWebMercator&&yr(this.view?.renderSpatialReference)}isEastEndWrap(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this.isGlobal&&0===e[2]}lijEastEnd(e){return 2**(e+(this.spatialReference.isGeographic?1:0))}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this.isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}};e([ve()],kP.prototype,"_renderer",void 0),e([ve()],kP.prototype,"_hasPendingUpdates",void 0),e([ve()],kP.prototype,"_asyncWorkItems",void 0),e([ve()],kP.prototype,"_allTilesDirty",void 0),e([ve()],kP.prototype,"_allTilesSorted",void 0),e([ve()],kP.prototype,"_viewChanged",void 0),e([ve({readOnly:!0})],kP.prototype,"_watchUpdatingTracking",void 0),e([ve()],kP.prototype,"_frameTask",void 0),e([ve({readOnly:!0})],kP.prototype,"snapLevel",null),e([ve({readOnly:!0})],kP.prototype,"lodSnapping",null),e([ve({constructOnly:!0})],kP.prototype,"view",void 0),e([ve()],kP.prototype,"_userClippingExtent",null),e([ve()],kP.prototype,"_rootTilesExtent",void 0),e([ve({readOnly:!0})],kP.prototype,"extent",null),e([ve({readOnly:!0})],kP.prototype,"groundExtent",null),e([ve({readOnly:!0})],kP.prototype,"_tilingSchemeExtent",null),e([ve({readOnly:!0})],kP.prototype,"updating",null),e([ve(hT)],kP.prototype,"updatingProgress",void 0),e([ve({readOnly:!0})],kP.prototype,"updatingProgressValue",null),e([ve()],kP.prototype,"_maxNumUpdating",void 0),e([ve({aliasOf:"view.map.ground.opacity"})],kP.prototype,"baseOpacity",void 0),e([ve()],kP.prototype,"hasCompositeBlendMode",void 0),e([ve({readOnly:!0})],kP.prototype,"overlayManager",void 0),e([ve({readOnly:!0})],kP.prototype,"viewingMode",null),e([ve()],kP.prototype,"maxTextureScale",void 0),e([ve({readOnly:!0})],kP.prototype,"ready",null),e([ve({value:AS.FRONT_TO_BACK})],kP.prototype,"renderOrder",null),e([ve({readOnly:!0})],kP.prototype,"rootTiles",void 0),e([ve({readOnly:!0})],kP.prototype,"spatialReference",null),e([ve({type:nr,aliasOf:"view.map.ground.surfaceColor"})],kP.prototype,"backgroundColor",void 0),e([ve({value:!1})],kP.prototype,"slicePlaneEnabled",null),e([ve({readOnly:!0})],kP.prototype,"tilingScheme",void 0),e([ve({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],kP.prototype,"tilingSchemeLocked",void 0),e([ve({readOnly:!0})],kP.prototype,"tilingSchemeLogic",void 0),e([ve({value:!0})],kP.prototype,"velvetOverground",null),e([Md("_renderer.wireframe")],kP.prototype,"wireframe",void 0),e([ve({value:!1})],kP.prototype,"suspended",null),e([ve({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],kP.prototype,"textureFadeDuration",void 0),e([ve()],kP.prototype,"_layerViewsDirty",void 0),e([Md("_renderer.renderPatchBorders")],kP.prototype,"renderPatchBorders",void 0),e([Md("_renderer.renderingDisabled")],kP.prototype,"renderingDisabled",void 0),kP=e([xe("esri.views.3d.terrain.TerrainSurface")],kP);const GP=kP;function qP(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function BP(e){return!e.isLeaf&&(e.children.some((e=>e.shouldLoad))||e.children.some((e=>BP(e))))}const HP=hr(),WP=Vt(),QP=[0,0,0],ZP=new le,XP={spatialReference:null,tile:null,extent:null,context:"ground"},YP={spatialReference:null,extent:null,scale:0};let KP=class extends N{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,i)=>this.commitLayer(i,e)))}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach(((i,r)=>{const s=this._ensureGeomRecord(e,r);i.forEach(((e,i)=>{const a=e[0],n=e[1],o=e[2];let l=!1;if(n&Ra.Geometry.UPDATE){const e=s.get(i);if(e){const i=e[1];if(o&Ra.State.TRANSFORMATION){const e=this.model.getObject(r);this.model.updateRenderGeometryTransformation(e,a,i)&&(l=!0)}l||t.updates.push({renderGeometry:i,updateType:o})}else Go(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(n&Ra.Geometry.REMOVE||l){const e=s.get(i);e?(t.removes.push(e[1]),s.delete(i),e[0].disposed&&en.pool.release(e[0])):n===Ra.Geometry.REMOVE&&Go(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(n&Ra.Geometry.ADD||l){const e=this.model.getObject(r);if(U(e)){const r=this.model.getRenderGeometry(e,a),n=[a,r];t.adds.push(r),s.set(i,n)}}})),0===s.size&&this._residentGeomRecords.get(e).delete(r)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e[1])))))}_objectStateChanged(e,t){for(const i of t.geometryRecords)this._updateOrCreateDirtyRecord(t,i,null,Ra.Geometry.UPDATE,0,0,Ra.Geometry.UPDATE,Ra.Geometry.ADD|Ra.Geometry.REMOVE,e)}visibilityChanged(e){this._objectStateChanged(Ra.State.VISIBILITIES,e)}highlightChanged(e){this._objectStateChanged(Ra.State.HIGHLIGHTS,e)}occlusionChanged(e){this._objectStateChanged(Ra.State.OCCLUDEES,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,Ra.Geometry.UPDATE,0,0,Ra.Geometry.UPDATE,Ra.Geometry.ADD|Ra.Geometry.REMOVE,Ra.State.VERTEXATTRS)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const e of t.geometryRecords)this._objectGeometryAdded(t,e,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const e of t.geometryRecords)this._objectGeometryRemoved(t,e,i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const i=this.model.getObject(t);i&&i.hasVolativeTransformation()&&e.forEach((e=>{e[1].shaderTransformationChanged()}))}))}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i[0],t,Ra.Geometry.UPDATE,0,0,Ra.Geometry.UPDATE,Ra.Geometry.ADD|Ra.Geometry.REMOVE,Ra.State.TRANSFORMATION)}))}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Ra.Geometry.ADD,Ra.Geometry.REMOVE,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Ra.Geometry.REMOVE,Ra.Geometry.ADD,Ra.Geometry.UPDATE,0,0)}_updateOrCreateDirtyRecord(e,t,i,r,s,a,n,o,l){i=H(i,this._getParentLayerId(e));const h=e.id,c=t.id,d=this._ensureDirtyRecord(i,h),u=d.get(c);if(u){const e=u[1];e&s?(d.delete(c),u[0].disposed&&en.pool.release(u[0])):e&a?(u[1]=r,u[2]=l):e&n?u[2]|=l:e&o||Go(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else d.set(c,[t,r,l]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return Te(this._dirtyGeomRecords,(e=>Te(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return U(e.parentLayer)?e.parentLayer.id:jh}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,r)=>{i.forEach(((i,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const a=[];i.forEach((e=>{const t=e[1];a[t]||(a[t]=[]),a[t].push(e[0].geometry.id)}));for(let i=0;i<a.length;i++)if(a[i]){t+=" "+e[i-1]+": ";for(let e=0;e<a[i].length;e++)t+=a[i][e]+", "}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}};e([ve({constructOnly:!0})],KP.prototype,"model",void 0),e([ve()],KP.prototype,"dirty",void 0),KP=e([xe("esri.views.3d.webgl-engine.lib.ModelDirtySet")],KP);const $P=KP;let JP=class extends N{constructor(){super(...arguments),this.dirtySet=new $P({model:this}),this._content=new Map,this._originFactory=new Aa(null,75e4)}getObject(e){return this._content.get(e)}add(e){const t=e.id;Go(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),tn(e)&&this.dirtySet.layerAdded(e)}remove(e){Go(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),tn(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)U(t)&&(Go(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)Go(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}getRenderGeometry(e,t){const{geometry:i,material:r,id:s,shaderTransformation:a,origin:n,instanceParameters:o}=t,l=new du(i,r,{id:s,boundingInfo:i.boundingInfo,calculateShaderTransformation:a,castShadow:e.castShadow});return l.updateTransformation((i=>e.getCombinedStaticTransformation(t,i))),l.origin=n||this._originFactory.getOrigin(l.boundingSphere),l.instanceParameters=o,l}updateRenderGeometryTransformation(e,t,i){if(z(e))return!1;i.updateTransformation((i=>e.getCombinedStaticTransformation(t,i)));const r=this._originFactory.getOrigin(i.boundingSphere);return i.origin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<hn.COUNT;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};function eR(e,t,i,r){const s=tR(e,t,i),a=zr();return Dt(i,s,a,r),a}function tR(e,t,i){const r=Oe(),s=e[3],a=2**(4*Math.ceil(Math.log(s)*Math.LOG2E/4)+1);if(i.isGeographic){const t=a/vr(i).radius*180/Math.PI,s=Math.round(e[1]/t),n=Math.max(-90,Math.min(90,s*t)),o=t/Math.cos((Math.abs(n)-t/2)/180*Math.PI),l=Math.round(e[0]/o)*o;r[0]=l,r[1]=n}else{const t=Math.round(e[0]/a),i=Math.round(e[1]/a);r[0]=t*a,r[1]=i*a}const n=e[2]+t,o=Math.round(n/a);return r[2]=o*a,r}e([ve({constructOnly:!0})],JP.prototype,"dirtySet",void 0),JP=e([xe("esri.views.3d.webgl-engine.parts.Model")],JP);const iR=[0,0,0],rR=[0,0,0],sR=[0,0,0],aR=[0,0,0],nR=[0,0,0],oR=[0,0,0],lR=[0,0,0],hR=[0,0,0],cR=[0,0,0],dR=[0,0,0],uR=[0,0,0],pR=[0,0],mR=[0,0,0],gR=[0,0,0],fR=[0,0,0],_R=[0,0,0],yR=[0,0,0],vR=[0,0,0];function bR(e,t,i,r,s,a){if(HR(t)<1e-6)return;qR(mR,i,t),qR(gR,r,t),qR(fR,s,t),wR(e,t,pR),yR[1]=pR[0],_R[1]=pR[1],vR[1]=_R[1]-yR[1];const n=[i,r,s],o=[mR,gR,fR];for(let i=0;i<3;++i){wR(e,n[i],pR),yR[0]=pR[0],_R[0]=pR[1],wR(e,o[i],pR),yR[2]=pR[0],_R[2]=pR[1],vR[0]=_R[0]-yR[0],vR[2]=_R[2]-yR[2];const r=UR(vR);r<a.quality&&(GR(a.b0,n[i]),GR(a.b1,t),GR(a.b2,o[i]),a.quality=r)}}const xR=[0,0,0];function wR(e,t,i){const{data:r,size:s}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let e=0;e<r.length;e+=s){const s=r[e]*t[0]+r[e+1]*t[1]+r[e+2]*t[2];i[0]=Math.min(i[0],s),i[1]=Math.max(i[1],s)}}function TR(e,t,i){GR(i.center,e),kR(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const CR=[0,0,0],SR=[0,0,0],PR=[0,0,0],RR=[0,0,0],AR=[0,0,0],OR=[0,0,0];function MR(e,t,i){GR(CR,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?CR[0]=0:Math.abs(t[1])>Math.abs(t[2])?CR[1]=0:CR[2]=0,HR(CR)<1e-6&&(CR[0]=CR[1]=CR[2]=1),qR(SR,t,CR),BR(SR,SR),qR(PR,t,SR),BR(PR,PR),ER(e,t,SR,PR,RR,AR),jR(OR,AR,RR),NR(t,SR,PR,RR,AR,OR,i)}function ER(e,t,i,r,s,a){wR(e,t,pR),s[0]=pR[0],a[0]=pR[1],wR(e,i,pR),s[1]=pR[0],a[1]=pR[1],wR(e,r,pR),s[2]=pR[0],a[2]=pR[1]}const DR=[0,0,0],IR=[1,0,0,0,1,0,0,0,1],LR=[0,0,0];function NR(e,t,i,r,s,a,n){IR[0]=e[0],IR[1]=e[1],IR[2]=e[2],IR[3]=t[0],IR[4]=t[1],IR[5]=t[2],IR[6]=i[0],IR[7]=i[1],IR[8]=i[2],function(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);const r=(i+1)%3,s=(i+2)%3;let a=Math.sqrt(t[3*i+i]-t[3*r+r]-t[3*s+s]+1);e[i]=.5*a,a=.5/a,e[3]=(t[3*r+s]-t[3*s+r])*a,e[r]=(t[3*r+i]+t[3*i+r])*a,e[s]=(t[3*s+i]+t[3*i+s])*a}}(n.quaternion,IR),zR(LR,r,s),kR(LR,LR,.5),kR(n.center,e,LR[0]),kR(DR,t,LR[1]),zR(n.center,n.center,DR),kR(DR,i,LR[2]),zR(n.center,n.center,DR),kR(n.halfSize,a,.5)}class FR{constructor(e){this.minVert=new Array(7),this.maxVert=new Array(7),this.buffer=new ArrayBuffer(448);let t=0;this.minProj=new Float64Array(this.buffer,t,7),t+=56,this.maxProj=new Float64Array(this.buffer,t,7),t+=56;for(let e=0;e<7;++e)this.minVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.maxVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.minProj[e]=Number.POSITIVE_INFINITY,this.maxProj[e]=Number.NEGATIVE_INFINITY;const i=new Array(7),r=new Array(7),{data:s,size:a}=e;for(let e=0;e<s.length;e+=a){let t=s[e];t<this.minProj[0]&&(this.minProj[0]=t,i[0]=e),t>this.maxProj[0]&&(this.maxProj[0]=t,r[0]=e),t=s[e+1],t<this.minProj[1]&&(this.minProj[1]=t,i[1]=e),t>this.maxProj[1]&&(this.maxProj[1]=t,r[1]=e),t=s[e+2],t<this.minProj[2]&&(this.minProj[2]=t,i[2]=e),t>this.maxProj[2]&&(this.maxProj[2]=t,r[2]=e),t=s[e]+s[e+1]+s[e+2],t<this.minProj[3]&&(this.minProj[3]=t,i[3]=e),t>this.maxProj[3]&&(this.maxProj[3]=t,r[3]=e),t=s[e]+s[e+1]-s[e+2],t<this.minProj[4]&&(this.minProj[4]=t,i[4]=e),t>this.maxProj[4]&&(this.maxProj[4]=t,r[4]=e),t=s[e]-s[e+1]+s[e+2],t<this.minProj[5]&&(this.minProj[5]=t,i[5]=e),t>this.maxProj[5]&&(this.maxProj[5]=t,r[5]=e),t=s[e]-s[e+1]-s[e+2],t<this.minProj[6]&&(this.minProj[6]=t,i[6]=e),t>this.maxProj[6]&&(this.maxProj[6]=t,r[6]=e)}for(let e=0;e<7;++e){let t=i[e];GR(this.minVert[e],s,t),t=r[e],GR(this.maxVert[e],s,t)}}}class VR{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function UR(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function zR(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function jR(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function kR(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function GR(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function qR(e,t,i){const r=t[0],s=t[1],a=t[2],n=i[0],o=i[1],l=i[2];e[0]=s*l-a*o,e[1]=a*n-r*l,e[2]=r*o-s*n}function BR(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function HR(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function WR(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function QR(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}const ZR=wo(),XR=Oe(),YR=Oe(),KR=xo();class $R{constructor(e){const t=56*e;this.buffer=new ArrayBuffer(t),this.obbs=new Array(e);for(let t=0;t<e;t++)this.obbs[t]={center:pt(this.buffer,56*t+0),halfSize:bo(this.buffer,56*t+24),quaternion:xu(this.buffer,56*t+36)}}}function JR(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:Xe(e),halfSize:vo(t),quaternion:bu(i)}}function eA(e){return JR(e.center,e.halfSize,e.quaternion)}function tA(e,t){De(t.center,e.center),De(t.halfSize,e.halfSize),yu(t.quaternion,e.quaternion)}function iA(e,t){return function(e,t){const{data:i,size:r}=e,s=i.length/r;if(s<=0)return;const a=new FR(e);zR(iR,a.minProj,a.maxProj),kR(iR,iR,.5),jR(rR,a.maxProj,a.minProj);const n=UR(rR),o=new VR;o.quality=n,s<14&&(e={data:new Float64Array(a.buffer,112,42),size:3});const l=[0,0,0],h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],m=[0,0,0];switch(function(e,t,i,r,s,a,n,o,l,h){return function(e,t,i){let r=WR(e.maxVert[0],e.minVert[0]),s=0;for(let t=1;t<7;++t){const i=WR(e.maxVert[t],e.minVert[t]);i>r&&(r=i,s=t)}GR(t,e.minVert[s]),GR(i,e.maxVert[s])}(e,r,s),WR(r,s)<1e-6?1:(jR(n,r,s),BR(n,n),function(e,t,i,r){const{data:s,size:a}=e;let n=Number.NEGATIVE_INFINITY,o=0;for(let e=0;e<s.length;e+=a){uR[0]=s[e]-t[0],uR[1]=s[e+1]-t[1],uR[2]=s[e+2]-t[2];const r=i[0]*uR[0]+i[1]*uR[1]+i[2]*uR[2],a=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],l=uR[0]*uR[0]+uR[1]*uR[1]+uR[2]*uR[2]-r*r/a;l>n&&(n=l,o=e)}return GR(r,s,o),n}(t,r,n,a)<1e-6?2:(jR(o,s,a),BR(o,o),jR(l,a,r),BR(l,l),qR(i,o,n),BR(i,i),bR(t,i,n,o,l,h),0))}(a,e,m,l,h,c,d,u,p,o)){case 1:return void TR(iR,rR,t);case 2:return void MR(e,d,t)}!function(e,t,i,r,s,a,n,o,l){(function(e,t,i,r,s){!function(e,t,i,r,s){const{data:a,size:n}=e;GR(r,a),GR(s,r),i[0]=QR(xR,t),i[1]=i[0];for(let e=n;e<a.length;e+=n){const n=a[e]*t[0]+a[e+1]*t[1]+a[e+2]*t[2];n<i[0]&&(i[0]=n,GR(r,a,e)),n>i[1]&&(i[1]=n,GR(s,a,e))}}(e,t,pR,s,r);const a=QR(i,t);pR[1]-1e-6<=a&&(r[0]=void 0),pR[0]+1e-6>=a&&(s[0]=void 0)})(e,t,i,sR,aR),void 0!==sR[0]&&(jR(nR,sR,i),BR(nR,nR),jR(oR,sR,r),BR(oR,oR),jR(lR,sR,s),BR(lR,lR),qR(hR,oR,a),BR(hR,hR),qR(cR,lR,n),BR(cR,cR),qR(dR,nR,o),BR(dR,dR),bR(e,hR,a,oR,nR,l),bR(e,cR,n,lR,oR,l),bR(e,dR,o,nR,lR,l)),void 0!==aR[0]&&(jR(nR,aR,i),BR(nR,nR),jR(oR,aR,r),BR(oR,oR),jR(lR,aR,s),BR(lR,lR),qR(hR,oR,a),BR(hR,hR),qR(cR,lR,n),BR(cR,cR),qR(dR,nR,o),BR(dR,dR),bR(e,hR,a,oR,nR,l),bR(e,cR,n,lR,oR,l),bR(e,dR,o,nR,lR,l))}(e,m,l,h,c,d,u,p,o),ER(e,o.b0,o.b1,o.b2,RR,AR);const g=[0,0,0];jR(g,AR,RR),o.quality=UR(g),o.quality<n?NR(o.b0,o.b1,o.b2,RR,AR,g,t):TR(iR,rR,t)}(e,t=t||JR()),t}function rA(e,t){const i=hh(t,e.center),r=hA(e,sh(t));return i>r?1:i<-r?-1:0}function sA(e,t){t||(t=Eh());const i=uo(KR,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),s=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),a=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-s,t[2]=e.center[2]-a,t[3]=e.center[0]+r,t[4]=e.center[1]+s,t[5]=e.center[2]+a,t}function aA(e,t){return hh(t,e.center)-hA(e,sh(t))}function nA(e,t){return hh(t,e.center)+hA(e,sh(t))}function oA(e,t){return rA(e,t[0])<=0&&rA(e,t[1])<=0&&rA(e,t[2])<=0&&rA(e,t[3])<=0&&rA(e,t[4])<=0&&rA(e,t[5])<=0}function lA(e,t,i,r=0){_u(ZR,e.quaternion),ze(XR,t,e.center);const s=dt(XR,XR,ZR),a=dt(YR,i,ZR);let n=-1/0,o=1/0;for(let t=0;t<3;t++)if(Math.abs(a[t])>1e-6){const i=(r+e.halfSize[t]-s[t])/a[t],l=(-r-e.halfSize[t]-s[t])/a[t];n=Math.max(n,Math.min(i,l)),o=Math.min(o,Math.max(i,l))}else if(s[t]>e.halfSize[t]+r||s[t]<-e.halfSize[t]-r)return!1;return n<=o}function hA(e,t){_u(ZR,e.quaternion),dt(XR,t,ZR);const i=e.halfSize;return Math.abs(XR[0]*i[0])+Math.abs(XR[1]*i[1])+Math.abs(XR[2]*i[2])}function cA(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],dt(r,r,e.quaternion),Ge(r,r,e.center)}}function dA(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function uA(e){if(T("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function pA(e,t,i,r,s,a){const n=t!==r;s.traverse(i,(i=>{let s=i.mbs;return n&&(s=yA,It(i.mbs,r,s,t)),bA(e,s)!==vA.OUTSIDE&&(a(i),!0)}))}function mA(e,t,i){let r=0,s=0;for(let a=0;a<t.length&&r<e.length;a++)e[r]===t[a]&&(i(a)&&(e[s]=e[r],s++),r++);e.length=s}function gA(e,t,i){let r=0,s=0;for(;r<i.length;)R(e,i[r])>=0===t&&(i[s]=i[r],s++),r++;i.length=s}(()=>{const e=new Int8Array(162);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=6};i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4])})();const fA=Vt();function _A(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return fA[0]=(e[0]-t.position[0])/t.rotationScale[0],fA[1]=(e[1]-t.position[1])/t.rotationScale[4],fA[2]=(e[2]-t.position[0])/t.rotationScale[0],fA[3]=(e[3]-t.position[1])/t.rotationScale[4],fA}const yA=hr();var vA;function bA(e,t){const i=t[0],r=t[1],s=t[3],a=e[0]-i,n=i-e[2],o=e[1]-r,l=r-e[3],h=Math.max(a,n,0),c=Math.max(o,l,0),d=h*h+c*c;return d>s*s?vA.OUTSIDE:d>0?vA.INTERSECTS_CENTER_OUTSIDE:-Math.max(a,n,o,l)>s?vA.INSIDE:vA.INTERSECTS_CENTER_INSIDE}function xA(e,t,i){const r=[],s=i&&i.missingFields,a=i&&i.originalFields;for(const i of e){const e=i.toLowerCase();let n=!1;for(const s of t)if(e===s.name.toLowerCase()){r.push(s.name),n=!0,a&&a.push(i);break}!n&&s&&s.push(i)}return r}async function wA(e,t,i,r,s){if(0===t.length)return[];const a=e.attributeStorageInfo;if(U(e.associatedLayer))try{return await async function(e,t,i,r){t.sort(((e,t)=>e.attributes[i]-t.attributes[i]));const s=t.map((e=>e.attributes[i])),a=[],n=xA(r,e.fields,{originalFields:a}),o=await TA(e,s,n);for(let e=0;e<t.length;e++){const i=t[e],r=o[e],s={};if(i.attributes)for(const e in i.attributes)s[e]=i.attributes[e];for(let e=0;e<a.length;e++)s[a[e]]=r[n[e]];i.attributes=s}return t}(e.associatedLayer,t,i,r)}catch(t){if(e.associatedLayer.loaded)throw t}if(a){const n=function(e,t,i){const r=new Map,s=[],a=i();for(const i of e){const e=i.attributes[t];for(let t=0;t<a.length;t++){const n=a[t],o=n.featureIds.indexOf(e);if(o>=0){let e=r.get(n.node);e||(e={node:n.node,indices:[],graphics:[]},s.push(e),r.set(n.node,e)),e.indices.push(o),e.graphics.push(i);for(let e=t;e>0;e--)a[e]=a[e-1];a[0]=n;break}}}return s}(t,i,s);if(z(n))throw new o("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const l=e.parsedUrl.path,h=await Promise.all(n.map((e=>function(e,t,i,r,s){const a=[];for(const r of t)if(r&&s.includes(r.name)){const t=`${e}/nodes/${i.resources.attributes}/attributes/${r.key}/0`;a.push({url:t,storageInfo:r})}return f(a.map((e=>fu(e.url,{responseType:"array-buffer"}).then((t=>Tu(e.storageInfo,t.data)))))).then((e=>{const t=[];for(const i of r){const r={};for(let t=0;t<e.length;t++)null!=e[t].value&&(r[a[t].storageInfo.name]=CA(e[t].value,i));t.push(r)}return t}))}(l,a,e.node,e.indices,r).then((t=>{for(let i=0;i<e.graphics.length;i++){const r=e.graphics[i],s=t[i];if(r.attributes)for(const e in r.attributes)e in s||(s[e]=r.attributes[e]);r.attributes=s}return e.graphics})))));return A(h)}throw new o("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function TA(e,t,i){const r=e.capabilities.query.maxRecordCount;if(null!=r&&t.length>r){const s=O(t,r);return Promise.all(s.map((t=>TA(e,t,i)))).then(A)}const s=new Cu({objectIds:t,outFields:i,orderByFields:[e.objectIdField]});return e.queryFeatures(s).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new o("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function CA(e,t){if(!e)return null;const i=e[t];return M(e)?-32768===i?null:i:E(e)?-2147483648===i?null:i:i!=i?null:i}function SA(e){const t=e.store.indexCRS||e.store.geographicCRS,i=void 0===t?e.store.indexWKT:void 0;if(i){if(!e.spatialReference)throw new o("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(i!==e.spatialReference.wkt)throw new o("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=t?new mr(dA(t)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function PA(e){const t=e.store.vertexCRS||e.store.projectedCRS,i=void 0===t?e.store.vertexWKT:void 0;if(i){if(!e.spatialReference)throw new o("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(i!==e.spatialReference.wkt)throw new o("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=t?new mr(dA(t)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function RA(e,t){return z(t)?"@null":t===br(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function AA(e,t,i){if(!Lt(e,t))throw new o("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===i&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw new o("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function OA(e,t,i){const r=SA(e),s=PA(e);AA(r,t,i),AA(s,t,i)}function MA(e){if(null==e.store||null==e.store.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new o("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function EA(e,t){OA(e,t.spatialReference,t.viewingMode)}function DA(e){if(null==e.store||null==e.store.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new o("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function IA(e,t){AA(e.spatialReference,t.spatialReference,t.viewingMode)}function LA(e){return"mesh-3d"===e.type}function NA(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!LA(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||z(t.material)||z(t.material.color)||"replace"!==t.material.colorMixMode)return!0}return!1}!function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"}(vA||(vA={}));const FA=bl({color:[0,0,0,0],opacity:0});class VA{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function UA(e){const t=new VA;let i=!1,r=!1;for(const s of e.symbolLayers.items)if("fill"===s.type&&s.enabled){const e=s.material,a=s.edges;if(U(e)&&!i){const r=e.color,a=Qh(e.colorMixMode);U(r)?t.material={color:[r.r/255,r.g/255,r.b/255],alpha:r.a,colorMixMode:a}:t.material={color:[1,1,1],alpha:1,colorMixMode:Zh.Multiply},t.castShadows=s.castShadows,i=!0}U(a)&&!r&&(t.edgeMaterial=xl(a,{}),r=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:Zh.Multiply}),t}function zA(e,t){return(0|e)+(0|t)|0}function jA(e,t,i,r,s=0){r===br(r)?t.isGeographic?function(e,t,i,r){const s=vr(i),a=1+Math.max(0,r)/(s.radius+e.center[2]);Me(t.center,e.center[0],e.center[1],e.center[2]+r),Nt(t.center,i,0,t.center,br(i),0,1),yu(t.quaternion,e.quaternion),_u(sO,e.quaternion),Me(hO,0,0,1),dt(hO,hO,sO),Me(hO,e.halfSize[0]*Math.abs(hO[0]),e.halfSize[1]*Math.abs(hO[1]),e.halfSize[2]*Math.abs(hO[2])),Ue(hO,hO,s.inverseFlattening),Ge(t.halfSize,e.halfSize,hO),Ue(t.halfSize,t.halfSize,a)}(e,i,t,s):function(e,t,i,r){cA(e,aO),Me(t.center,e.center[0],e.center[1],e.center[2]+r),Dt(i,t.center,rO,br(i)),Me(t.center,rO[12],rO[13],rO[14]);const s=2*Math.sqrt(1+rO[0]+rO[5]+rO[10]);sO[0]=(rO[6]-rO[9])/s,sO[1]=(rO[8]-rO[2])/s,sO[2]=(rO[1]-rO[4])/s,sO[3]=.25*s,vu(t.quaternion,sO,e.quaternion),_u(sO,t.quaternion);let a=0,n=0,o=0;for(const e of aO)e[2]+=r,Nt(e,i,0,e,br(i),0,1),ht(hO,e,t.center),dt(hO,hO,sO),a=Math.max(a,Math.abs(hO[0])),n=Math.max(n,Math.abs(hO[1])),o=Math.max(o,Math.abs(hO[2]));Me(t.halfSize,a,n,o)}(e,i,t,s):t.isWGS84&&(r.isWebMercator||yr(r))?function(e,t,i,r,s){De(XA,t.center),XA[2]+=s;const a=br(i);Nt(XA,e,0,XA,a,0,1),KA(a,t,XA,i,r)}(t,e,r,i,s):t.isWebMercator&&yr(r)?function(e,t,i,r,s){De(XA,t.center),XA[2]+=s,KA(e,t,XA,i,r)}(t,e,r,i,s):e===i?(i.center[2]+=s,Nt(i.center,t,0,i.center,r,0,1)):(Me(i.center,e.center[0],e.center[1],e.center[2]+s),Nt(i.center,t,0,i.center,r,0,1),yu(i.quaternion,e.quaternion),De(i.halfSize,e.halfSize))}function kA(e,t,i,r,s){if(yu(s.quaternion,e.quaternion),r===Gi.Global){_u(HA,e.quaternion),dt(GA,e.center,HA),mt(qA,GA),gt(BA,qA,e.halfSize),ht(BA,qA,BA);const r=Ee(BA);Ge(BA,qA,e.halfSize);const a=Ee(BA);if(r<i)De(s.center,e.center),Me(GA,i,i,i),Ge(s.halfSize,e.halfSize,GA);else{const n=a>0?1+t/a:1,o=r>0?1+i/r:1,l=(o+n)/2,h=(o-n)/2;Ue(s.halfSize,qA,h),ft(s.halfSize,s.halfSize,e.halfSize,l),Ue(s.center,qA,l),ft(s.center,s.center,e.halfSize,h),_t(GA,GA),yt(s.center,s.center,GA),dt(s.center,s.center,s.quaternion)}}else{const r=Me(GA,0,0,1);ft(s.center,e.center,r,(i+t)/2),_u(HA,e.quaternion),dt(r,r,HA),mt(r,r),ft(s.halfSize,e.halfSize,r,(i-t)/2)}return s}const GA=Oe(),qA=Oe(),BA=Oe(),HA=wo(),WA=new Float64Array(24),QA={data:WA,size:3},ZA=Oe(),XA=Oe(),YA=xo();function KA(e,t,i,r,s){const a=uo(YA,t.quaternion);for(let e=0;e<8;++e){for(let i=0;i<3;++i)ZA[i]=t.halfSize[i]*(0!=(e&1<<i)?-1:1);for(let t=0;t<3;++t){let r=i[t];for(let e=0;e<3;++e)r+=ZA[e]*a[3*e+t];WA[3*e+t]=r}}Nt(WA,e,0,WA,r,0,8),iA(QA,s)}function $A(e,t,i,r,s,a){if(!a||0===a.length||z(t))return null;const n=eR(e.mbs,s,i,t);let o;Ar(dO,n);let l=1/0,h=-1/0;if(a.forEach((a=>(a=>{if("replace"!==a.type)return;const n=a.geometry;if(!n.hasZ)return;Ut(nO);const c=n.spatialReference||r,d=n.rings.reduce(((e,i)=>i.reduce(((e,i)=>(Ot(i,c,hO,t),Qe(hO,hO,dO),Wt(nO,hO),Math.min(hO[2],e))),e)),1/0);(()=>{if(!o)if(o=aO,Ut(oO),U(e.serviceObb)){jA(e.serviceObb,i,lO,t,s),cA(lO,o);for(const e of o)Qe(e,e,dO),Wt(oO,e)}else{const r=e.mbs,a=r[3];Ot(r,i,hO,t),Qe(hO,hO,dO),hO[2]+=s;for(let e=0;e<8;++e){const t=1&e?a:-a,i=2&e?a:-a,r=4&e?a:-a,s=o[e];De(s,[hO[0]+t,hO[1]+i,hO[2]+r]),Wt(oO,s)}}})(),qt(oO,nO)&&(l=Math.min(l,d),h=Math.max(h,d))})(a))),l===1/0)return null;const c=(e,t,i)=>{Qe(hO,i,n),e[t+0]=hO[0],e[t+1]=hO[1],e[t+2]=hO[2],t+=24,i[2]=l,Qe(hO,i,n),e[t+0]=hO[0],e[t+1]=hO[1],e[t+2]=hO[2],t+=24,i[2]=h,Qe(hO,i,n),e[t+0]=hO[0],e[t+1]=hO[1],e[t+2]=hO[2]};for(let e=0;e<8;++e)c(cO.data,3*e,o[e]);return iA(cO)}function JA(e){return U(e)&&e.halfSize[0]>=0}function eO(e){return e[3]>=0}function tO(e){U(e)&&(e.halfSize[0]=-1)}function iO(e){U(e)&&(e[3]=-1)}const rO=zr(),sO=wu(),aO=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],nO=Vt(),oO=Vt(),lO=JR(),hO=[0,0,0],cO={data:new Array(72),size:3},dO=zr();class uO{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}allVisible(){return this.componentCount()===this._totalCount}allInvisible(){return 0===this._indexRanges.length}componentCount(){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];return t}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const a=e[s];i+r===a?r+=1:(t.push(i),t.push(r),i=a,r=1)}return t.push(i),t.push(r),t}(e)}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],a=s+i[r+1],n=e[s],o=e[a];t[r]=n,t[r+1]=o-n}return t}}class pO extends Oa{constructor(e,t){super(),this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=D(t);const i=this.count;this.visibility=new uO(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return z(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return z(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return z(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((z(this.cachedHighlightRanges)||z(this.cachedDefaultRanges))&&U(this.highlightCounts)){const{highlightRanges:e,defaultRanges:t}=function(e,t,i){const r=[],s=[];let a=i.length,n=i.length;return t.forEachComponent((t=>(e[t]>0?(a!==t-1&&(r.length&&r.push(i[a+1]-r[r.length-1]),r.push(i[t])),a=t):(n!==t-1&&(s.length&&s.push(i[n+1]-s[s.length-1]),s.push(i[t])),n=t),!0))),r.length&&r.push(i[a+1]-r[r.length-1]),s.length&&s.push(i[n+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}}class mO extends Oa{constructor(){super(...arguments),this.visible=gO.Hidden}}var gO;function fO(e,t,i,r){if(i>=t)return e;null==e&&(e=function(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}());const s=e.isVisibleBit;let a=e.data;const n=yO(a),o=i/n|0,l=i-n*o,h=(t-1)/n|0,c=a,d=r===s;if(!(i<c.length*n)&&d){const e=1.5,t=o+1,i=Math.ceil(c.length*e),r=h+1;let s=Math.max(t,i);s=Math.min(s,r),a=new Uint32Array(s),a.set(c)}return o<a.length&&(a[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(a[o],l,d)),e.data=a,e}function _O(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,s=yO(r);return t<r.length*s?function(e,t,i,r){const s=i/r|0,a=i-s*r;return function(e,t){return 0!=(e&1<<t)}(t[s],a)===e}(i,r,t,s):!e.isVisibleBit}function yO(e){return 8*e.BYTES_PER_ELEMENT}e([Ma()],mO.prototype,"renderable",void 0),e([Ma()],mO.prototype,"components",void 0),function(e){e[e.Hidden=0]="Hidden",e[e.Visible=1]="Visible"}(gO||(gO={}));class vO{constructor(e,t){this._indices=U(e.indices)?e.indices:Su(e.positions.length/3),this._positions=new lu(e.positions),this._components=t,this._componentIntersectionData=new Array(t.count)}getComponentAabb(e,t){if(U(this._perComponentAabbs)){for(let i=0;i<6;i++)t[i]=this._perComponentAabbs[6*e+i];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,a,n){const o={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},l=this._indices,h=this._components.offsets,c=fn(e,t,bO),d=e[2],u=t[2];this._components.visibility.forEachComponent((p=>{if(!_O(this._components.pickability,p))return!0;const m=this.getComponentAabb(p,xO);if(U(a)){const i=a[p];U(s)?s.componentOffset=i:(e[2]=d-i,t[2]=u-i)}if(U(s)&&s.applyToAabb(m),!_n(m,e,c,i))return!0;const g=h[p]/3,f=h[p+1]/3,_=(e,t,i)=>{n(p,e,Ye(t,t,r),i)},y=f-g;return z(s)&&y>200?(null==this._componentIntersectionData[p]&&(this._componentIntersectionData[p]=new tP(this._indices,g,f,o)),this._componentIntersectionData[p].intersectRay({r0:e,r1:t},_)):gn(e,t,g,f,l,o,void 0,s,_),!0}))}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);const t=this._indices,i=this._positions.typedBuffer,r=this._positions.typedBufferStride,s=this._components.offsets;let a=0;for(let n=0;n<e;n++){const e=s[n],o=s[n+1];let l=1/0,h=1/0,c=1/0,d=-1/0,u=-1/0,p=-1/0;for(let s=e;s<o;s++){const e=t[s]*r,a=i[e],n=i[e+1],o=i[e+2];l=Math.min(l,a),h=Math.min(h,n),c=Math.min(c,o),d=Math.max(d,a),u=Math.max(u,n),p=Math.max(p,o)}this._perComponentAabbs[a++]=l,this._perComponentAabbs[a++]=h,this._perComponentAabbs[a++]=c,this._perComponentAabbs[a++]=d,this._perComponentAabbs[a++]=u,this._perComponentAabbs[a++]=p}}get positions(){return this._positions}get indices(){return this._indices}}const bO=Oe(),xO=Eh();class wO{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}dispose(){this.material.dispose(),this.geometry.dispose()}}class TO extends Oa{constructor(e,t,i,r){super(),this.primitiveType=t,this.parameters=i,this.indexed=r,this.vao=e}}function CO(e){return e?SO(e,1/0,-1/0):{near:1/0,far:-1/0}}function SO(e,t,i){return e.near=t,e.far=i,e}function PO(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function RO(e,t){return e.near<=t&&t<=e.far}e([Ma()],TO.prototype,"vao",void 0);const AO={near:0,far:0},OO=new le({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),MO=CO(),EO=Oe(),DO=Oe(),IO=new le({deallocator:null}),LO=new le({deallocator:null});function NO(e,t,i){i.length=0;const r=t.length-3;FO(EO,t,r);const s=hh(e,EO);s<=0&&(i.push(EO[0]),i.push(EO[1]),i.push(EO[2]));let a=0,n=s;for(;a<r;a+=3){FO(DO,t,a);const r=hh(e,DO);n*r<0&&(ke(EO,DO,EO,r/(r-n)),VO(i,EO)),r<=0&&VO(i,DO),n=r,De(EO,DO)}n*s<0&&(FO(DO,t,r),ke(EO,DO,EO,s/(s-n)),VO(i,EO))}function FO(e,t,i){return Me(e,t.data[i+0],t.data[i+1],t.data[i+2])}function VO(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function UO(e,t,i,r){_u(kO,e.quaternion),ht(GO,t,e.center),dt(GO,GO,kO);const s=8*((GO[0]<-e.halfSize[0]?-1:GO[0]>e.halfSize[0]?1:0)+3*(GO[1]<-e.halfSize[1]?-1:GO[1]>e.halfSize[1]?1:0)+9*(GO[2]<-e.halfSize[2]?-1:GO[2]>e.halfSize[2]?1:0)+13),a=zO[s];if(0===a)return a;uo(jO,e.quaternion),po(jO,jO,e.halfSize);const n=(t,i)=>{const r=zO[s+i+1];return Me(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),Ye(t,t,jO),Ge(t,e.center,t)};return i.length=0,VO(i,n(qO,0)),VO(i,n(BO,1)),VO(i,n(GO,2)),VO(i,n(HO,3)),r(i),1===a||(i.length=0,VO(i,qO),VO(i,HO),VO(i,n(GO,4)),VO(i,n(WO,5)),r(i),2===a||(i.length=0,VO(i,qO),VO(i,WO),VO(i,n(GO,6)),VO(i,BO),r(i))),a}const zO=(()=>{const e=new Int8Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),jO=xo(),kO=wo(),GO=Oe(),qO=Oe(),BO=Oe(),HO=Oe(),WO=Oe();class QO{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?function(e,t){const i=CO(),{eye:r,frustum:s,viewForward:a}=e;t.forAll((e=>{const t=U(e.offsetObb)?e.offsetObb:e.obb,n=je(ht(GO,t.center,r),a),o=hA(t,a);if(RO(i,n-o)&&RO(i,n+o))return;const l=function(e,t){let i=0;for(let r=0;r<4;r++){const s=rA(e,t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}(t,s);if(-1===l)return;if(0===l)return MO.far=n+o,MO.near=n-o,void PO(i,MO);const h=OO.pushNew();h.near=n-o,h.far=n+o,h.mask=l,h.object=e}));for(let e=0;e<OO.length;e++){const t=OO.data[e];if(RO(i,t.near)&&RO(i,t.far))continue;MO.far=t.far,MO.near=1/0;const n=UO(U(t.object.offsetObb)?t.object.offsetObb:t.object.obb,r,IO,(e=>{let i=LO;for(let r=0;r<4&&e.length>0;r++){if(0==(t.mask&1<<r))continue;NO(s[r],e,i);const a=e;e=i,i=a}for(let t=0;t<e.length;t+=3){Me(EO,e.data[t+0],e.data[t+1],e.data[t+2]);const i=je(ht(EO,EO,r),a);MO.near=Math.min(MO.near,i)}}));0===n&&(MO.near=0),PO(i,MO)}return OO.length=0,i}(e,this._objects.visibleObjects):null}}function ZO(e){const t=Do().vec3f(yn.POSITION);return e.normals&&t.vec2i16(yn.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===qr.Default?t.vec2f(yn.UV0):e.textureCoordinates===qr.Atlas&&(t.vec2f(yn.UV0),t.vec4u16(yn.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(yn.COLOR,{glNormalized:!0}),t.alignTo(4)}class XO extends js{constructor(e,t){super(e,"int",ks.Draw,((i,r,s)=>i.setUniform1i(e,t(r,s))))}}var YO,KO,$O,JO,eM;function tM(e,t){Pu(e/429496.7296*.5+.5,t)}function iM(e,t){switch(t.componentData){case YO.Varying:return function(e){const{vertex:t,fragment:i}=e;t.include(Is),t.uniforms.add([new Ya("componentColorTex"),new la("componentColorTexInvDim")]),e.attributes.add(yn.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include(Xh),t.constants.add("elevationScale","float",858993.4592),t.code.add(an`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex * 2.0 + 0.5) * componentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * componentColorTexInvDim.y
);
return texture2D(componentColorTex, indexCoord);
}
float readElevationOffset() {
float normalizedIndex = (componentIndex * 2.0 + 1.5) * componentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * componentColorTexInvDim.y
);
return (rgba2float(texture2D(componentColorTex, indexCoord)) - 0.5) * elevationScale;
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),i.code.add(an`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)}(e);case YO.Uniform:return function(e){const{vertex:t,fragment:i}=e;t.uniforms.add(new pP("externalColor",(e=>e.componentParameters.externalColor))),i.uniforms.add(new XO("externalColorMixMode",(e=>e.componentParameters.externalColorMixMode))),e.varyings.add("vExternalColor","vec4"),t.code.add(an`float readElevationOffset() {
return 0.0;
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),i.code.add(an`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}`)}(e);case YO.COUNT:return;default:Gl(t.componentData)}}function rM(e,t){const i=e.vertex;switch(i.code.add(an`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case KO.None:i.code.add(an`#define vertexDiscardByOpacity(_opacity_) {}`);break;case KO.Opaque:i.code.add(an`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case KO.Transparent:i.code.add(an`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}function sM(e){return e&&gr(e)?$O.Mars:e&&fr(e)?$O.Moon:$O.Earth}!function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"}(YO||(YO={})),function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(KO||(KO={})),function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}($O||($O={})),function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(JO||(JO={})),function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(eM||(eM={}));class aM extends Qn{constructor(){super(...arguments),this.output=Bs.Color,this.textureCoordinateType=qr.None,this.componentData=YO.Uniform,this.cullFace=yd.Back,this.vertexDiscardMode=KO.None,this.doubleSidedMode=Yh.WindingOrder,this.alphaDiscardMode=vd.Opaque,this.integratedMeshMode=eM.None,this.transparencyPassType=bd.NONE,this.ellipsoidMode=$O.Earth,this.pbrMode=Hr.Disabled,this.normalType=as.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasBaseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.isGround=!1,this.hasCloudsReflections=!0,this.snowCover=!1}}function nM(e,t){e.include(Au,t),e.fragment.include(Kh);const i=e.fragment;i.uniforms.add(new pP("baseColor",(e=>e.baseColor))),i.uniforms.add(new $h("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add(an`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(an`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(an`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function oM(e,t){const i=e.fragment;switch(t.doubleSidedMode){case Yh.None:i.code.add(an`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case Yh.View:e.include(ns,t),i.code.add(an`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case Yh.WindingOrder:i.code.add(an`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:Gl(t.doubleSidedMode);case Yh.COUNT:}switch(t.normalType){case as.Attribute:case as.CompressedAttribute:e.include(os,t),i.code.add(an`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case as.ScreenDerivative:e.extensions.add("GL_OES_standard_derivatives"),e.include(ns,t),i.code.add(an`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case as.Ground:t.spherical?(e.include(ns,t),i.code.add(an`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):i.code.add(an`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(an`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:Gl(t.normalType);case as.COUNT:}}function lM(e,t){const i=e.fragment;if(t.hasBaseColorTexture){e.include(ls,t);const r=t.textureCoordinateType===qr.Atlas;i.uniforms.add(hs("baseColorTexture",(e=>e.texture),r)),r?(e.include(cs),i.code.add(an`vec4 readBaseColorTexture() {
return textureAtlasLookup(baseColorTexture, baseColorTextureSize, vuv0, vuvRegion);
}`)):i.code.add(an`vec4 readBaseColorTexture() {
return texture2D(baseColorTexture, vuv0);
}`)}else i.code.add(an`vec4 readBaseColorTexture() { return vec4(1.0); }`)}e([Wn({count:Bs.COUNT})],aM.prototype,"output",void 0),e([Wn({count:qr.COUNT})],aM.prototype,"textureCoordinateType",void 0),e([Wn({count:YO.COUNT})],aM.prototype,"componentData",void 0),e([Wn({count:yd.COUNT})],aM.prototype,"cullFace",void 0),e([Wn({count:KO.COUNT})],aM.prototype,"vertexDiscardMode",void 0),e([Wn({count:Yh.COUNT})],aM.prototype,"doubleSidedMode",void 0),e([Wn({count:vd.COUNT})],aM.prototype,"alphaDiscardMode",void 0),e([Wn({count:eM.COUNT})],aM.prototype,"integratedMeshMode",void 0),e([Wn({count:bd.COUNT})],aM.prototype,"transparencyPassType",void 0),e([Wn({count:$O.COUNT})],aM.prototype,"ellipsoidMode",void 0),e([Wn({count:Hr.COUNT})],aM.prototype,"pbrMode",void 0),e([Wn({count:as.COUNT})],aM.prototype,"normalType",void 0),e([Wn()],aM.prototype,"spherical",void 0),e([Wn()],aM.prototype,"doublePrecisionRequiresObfuscation",void 0),e([Wn()],aM.prototype,"hasVertexColors",void 0),e([Wn()],aM.prototype,"hasNormals",void 0),e([Wn()],aM.prototype,"hasSlicePlane",void 0),e([Wn()],aM.prototype,"hasBaseColorTexture",void 0),e([Wn()],aM.prototype,"receiveAmbientOcclusion",void 0),e([Wn()],aM.prototype,"receiveShadows",void 0),e([Wn()],aM.prototype,"blendingEnabled",void 0),e([Wn()],aM.prototype,"hasScreenSpaceReflections",void 0),e([Wn()],aM.prototype,"hasPolygonOffset",void 0),e([Wn()],aM.prototype,"hasMetalnessAndRoughnessTexture",void 0),e([Wn()],aM.prototype,"hasEmissionTexture",void 0),e([Wn()],aM.prototype,"hasOcclusionTexture",void 0),e([Wn()],aM.prototype,"hasNormalTexture",void 0),e([Wn()],aM.prototype,"hasOccludees",void 0),e([Wn()],aM.prototype,"hasMultipassTerrain",void 0),e([Wn()],aM.prototype,"cullAboveGround",void 0),e([Wn()],aM.prototype,"isGround",void 0),e([Wn()],aM.prototype,"hasCloudsReflections",void 0),e([Wn()],aM.prototype,"snowCover",void 0),e([Wn({constValue:ks.Draw})],aM.prototype,"pbrTextureBindType",void 0),e([Wn({constValue:!0})],aM.prototype,"hasSliceHighlight",void 0),e([Wn({constValue:!1})],aM.prototype,"hasSliceInVertexProgram",void 0),e([Wn({constValue:!1})],aM.prototype,"useCustomDTRExponentForWater",void 0),e([Wn({constValue:!1})],aM.prototype,"hasVertexTangents",void 0),e([Wn({constValue:!0})],aM.prototype,"supportsTextureAtlas",void 0),e([Wn({constValue:!1})],aM.prototype,"highStepCount",void 0),e([Wn({constValue:!1})],aM.prototype,"instancedDoublePrecision",void 0),e([Wn({constValue:!0})],aM.prototype,"useFillLights",void 0);const hM=new Map([[yn.POSITION,0],[yn.NORMAL,1],[yn.NORMALCOMPRESSED,1],[yn.COLOR,2],[yn.UV0,3],[yn.UVREGION,4],[yn.COMPONENTINDEX,5]]);function cM(e){return 0===e.overlays.length?null:e.overlays[Zd.INNER].getValidTexture(Jd.Water)}const dM=Object.freeze(Object.defineProperty({__proto__:null,attributeLocations:hM,build:function(e){const t=new ws;t.include(ns,e),t.include(os,e),t.include(Au,e),t.include(Gr,e),t.include(ds,e),t.include(iM,e),t.include(Jh,e),t.include(Ys,e),t.include(lM,e),t.include(rM,e);const{vertex:i,fragment:r}=t;r.uniforms.add(new Xr("view")),e.pbrMode!==Hr.Normal&&e.pbrMode!==Hr.Schematic||(t.include(us,e),e.hasNormalTexture&&t.include(ec,e)),e.output===Bs.Shadow&&e.componentData===YO.Varying?i.code.add(an`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):i.code.add(an`#define discardShadows(castShadows) {}`);const s=e.integratedMeshMode===eM.ColorOverlay||e.integratedMeshMode===eM.ColorOverlayWithWater,a=s&&e.output===Bs.Color&&e.pbrMode===Hr.WaterOnIntegratedMesh;return s&&(t.include(Hh,e),t.include(fP,e),e.spherical?i.code.add(an`
      const float invEllipsoidRadius = ${an.float(1/(e.ellipsoidMode===$O.Earth?Qi.radius:e.ellipsoidMode===$O.Mars?Zi.radius:Xi.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):i.code.add(an`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),a&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),i.code.add(an`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${an.float(Ks)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${a?e.spherical?an`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:an`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${s?an`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),e.output===Bs.Alpha&&(r.include(Ss),t.include($s,e),t.include(nM,e),s&&r.uniforms.add(new Ns("ovColorTex",((e,t)=>yP(e,t)))),r.code.add(an`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.hasMultipassTerrain?an`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${s?an`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),e.output===Bs.Color&&(r.include(Ss),t.include($s,e),t.include(nM,e),t.include(oM,e),t.include(Hh,e),e.receiveShadows?(t.include(ps,e),r.code.add(an`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):r.code.add(an`float evaluateShadow() { return 0.0; }`),s&&r.uniforms.add(new Ns("ovColorTex",((e,t)=>yP(e,t)))),r.code.add(an`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.hasMultipassTerrain?an`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${s?an`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),e.pbrMode===Hr.Normal||e.pbrMode===Hr.Schematic?(r.uniforms.add(new Cs("lightingMainIntensity",((e,t)=>t.lighting.mainLight.intensity))),r.code.add(an`
        ${e.pbrMode===Hr.Normal?an`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?r.code.add(an`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):r.code.add(an`vec3 shadingNormal = normalVertex;`),r.code.add(an`${e.spherical?an`vec3 normalGround = normalize(positionWorld());`:an`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),r.code.add(an`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());

        ${e.snowCover?an`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);

                shadingNormal = mix(shadingNormal, surfaceNormal, snow);
                ssao = mix(ssao, 0.0, snow);
                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                emission = mix(emission, vec3(0.0), snow);`:""}

        ${s?an` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(e.receiveShadows?r.code.add(an`float shadow = evaluateShadow();`):e.spherical?(r.uniforms.add(new Vs("lightingGlobalFactor",((e,t)=>t.lighting.globalFactor))),r.code.add(an`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):r.code.add(an`float shadow = 0.0;`),a&&r.uniforms.add(new Ns("ovNormalTex",((e,t)=>cM(t)))),e.snowCover&&(t.extensions.add("GL_OES_standard_derivatives"),r.code.add(an`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)),r.code.add(an`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${s?an` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${a?an`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),r.code.add(an`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.transparencyPassType===bd.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==Bs.Depth&&e.output!==Bs.Shadow||(t.include(Ws,e),r.code.add(an`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),e.output===Bs.Normal&&(t.include(oM,e),r.code.add(an`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${e.normalType===as.Ground?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),e.output===Bs.Highlight&&(t.include(Qs),r.code.add(an`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${s?an`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  gl_FragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),t},getOverlayNormalTexture:cM},Symbol.toStringTag,{value:"Module"}));class uM extends As{bindDraw(e,t){const i=this.program;i.bindDraw(e,t),i.rebindTextures(),e.componentParameters.type===YO.Varying&&e.componentParameters.texture.bind(i,"componentColorTex","componentColorTexInvDim")}initializeConfiguration(e,t){t.spherical=e.viewingMode===Gi.Global,t.doublePrecisionRequiresObfuscation=ms(e.rctx)}initializeProgram(e){const t=uM.shader.get(),i=t.build(this.configuration);return new Os(e.rctx,i,t.attributeLocations)}_setPipelineState(e){const t=this.configuration,i=t.integratedMeshMode!==eM.None,r=e===bd.NONE,s=e===bd.FrontFace;return Nn({blending:t.output!==Bs.Color&&t.output!==Bs.Alpha||!t.blendingEnabled?null:r?kn:Gn(e),culling:qn(t.cullFace),depthTest:{func:Bn(e)},depthWrite:r||s?jn:null,colorWrite:Vn,stencilWrite:i||t.hasOccludees?Js:null,stencilTest:i?ea(_d.IntegratedMeshMaskExcluded):t.hasOccludees?ta:null,polygonOffset:r||s?t.hasPolygonOffset?{factor:2,units:2}:null:Hn})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}uM.shader=new Rs(dM,(()=>Promise.resolve().then((()=>dM))));class pM extends on{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class mM{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function gM(e={}){return(t,i)=>{const r=t._parameterCount??0;if(t._parameterCount=r+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=e;else{if(s.equals(t,e))return;s.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function fM(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}class _M{constructor(e){this._low=yo(),this._high=yo(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const t=this._low,i=this._high;De(t,e),ht(i,e,t)}setElements(e,t,i){Me(yM,e,t,i),this.set(yM)}get(e){return Ge(e,this._low,this._high)}getLowScaled(e){return Ue(e,this._low,1)}}const yM=Oe();class vM extends pM{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=Pc(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=fo(1,1,.5),this.emissiveFactor=fo(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new TM,this.componentParameters=new CM,this.textureAlphaCutoff=ia,this.alphaDiscardMode=vd.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=$O.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new aM;const i=new _M(e.position),r=uu(e.rotationScale);mo(r,r),this.transformNormalGlobalFromModel=co(r,r),this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=q(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return U(this.baseColorTexture)?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return U(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return U(this.emissionTexture)?this.emissionTexture.glTexture:null}get textureOcclusion(){return U(this.occlusionTexture)?this.occlusionTexture.glTexture:null}get textureNormal(){return U(this.normalTexture)?this.normalTexture.glTexture:null}prepareTechnique(e,t,i,r){const s=this._techniqueConfiguration;s.hasVertexColors=r.colors,s.hasNormals=r.normals,s.textureCoordinateType=r.textureCoordinates,s.hasMetalnessAndRoughnessTexture=U(this.metallicRoughnessTexture),s.hasEmissionTexture=U(this.emissionTexture),s.hasOcclusionTexture=U(this.occlusionTexture),s.hasNormalTexture=U(this.normalTexture),s.transparencyPassType=t.identifier===oP.Material&&null!=i.transparencyPassType?i.transparencyPassType:bd.NONE,s.hasMultipassTerrain=t.identifier===oP.Material&&null!=i.multipassTerrain&&i.multipassTerrain.enabled,s.cullAboveGround=t.identifier===oP.Material&&null!=i.multipassTerrain&&i.multipassTerrain.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?Yh.View:Yh.None,s.hasBaseColorTexture=U(this.baseColorTexture);const a=this._computeWhichMaterialPass();s.blendingEnabled=a===xM.Transparent||a===xM.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){return 0!==e.overlays.length&&U(e.overlays[Zd.INNER].getColorTextureNoRasterImage())}(i)?cM(i)?eM.ColorOverlayWithWater:eM.ColorOverlay:eM.NoOverlay:eM.None,s.isGround=this.isIntegratedMesh,s.hasPolygonOffset=this.polygonOffsetEnabled;const n=this.hasParametersFromSource&&z(this.baseColorTexture);return s.pbrMode=s.integratedMeshMode===eM.ColorOverlayWithWater?Hr.WaterOnIntegratedMesh:this.usePBR?n?Hr.Schematic:Hr.Normal:Hr.Disabled,s.normalType=s.integratedMeshMode===eM.None?s.hasNormals?as.CompressedAttribute:as.ScreenDerivative:as.Ground,s.hasSlicePlane=U(i.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,t.identifier===oP.ShadowMap?(s.output=Bs.Shadow,s.vertexDiscardMode=KO.None):t.identifier===oP.Highlight?(s.output=Bs.Highlight,s.vertexDiscardMode=KO.None):(this._computeWhichMaterialPass()===xM.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?KO.Opaque:KO.Transparent:s.vertexDiscardMode=KO.None,s.output=function(e){switch(e){case lP.Color:return Bs.Color;case lP.Alpha:return Bs.Alpha;case lP.Depth:return Bs.Depth;case lP.Normal:return Bs.Normal}}(t.subPass),t.subPass===lP.Alpha&&(s.hasOccludees=i.hasOccludees),t.subPass===lP.Color?(s.receiveAmbientOcclusion=i.ssaoHelper.ready,s.hasOccludees=i.hasOccludees,s.receiveShadows=i.shadowMap.ready,s.hasScreenSpaceReflections=i.ssr.enabled,s.hasCloudsReflections=U(i.clouds.data)):(s.receiveAmbientOcclusion=!1,s.receiveShadows=!1),s.snowCover=this.hasSnowCover(i)),this._technique=e.releaseAndAcquire(uM,s,this._technique),this._setClean(),this._technique}hasSnowCover(e){return U(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(e,t,i){if(0===this.objectOpacity)return;const r=i.renderable.geometry,s=i.components,a=i.renderable.meta.cameraDepthSquared,n=s.geometryRanges,o=s.highlightRanges,l=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case xM.Opaque:e.materialOpaque.submitDraw(this,r,n,a);break;case xM.Transparent:e.materialTransparent.submitDraw(this,r,n,a);break;case xM.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,r,n,a),e.materialTransparent.submitDraw(this,r,n,a);break;case xM.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,r,n,a),function(e){return 0!==e.overlays.length&&U(e.overlays[Zd.INNER].getValidTexture(Jd.Highlight))}(t)&&e.highlightIntegratedMesh.submitDraw(this,r,n,a)}const h=this.componentParameters.castShadows!==wM.None;h&&e.shadowMap.submitDraw(this,r,n,a),U(o)&&(e.highlight.submitDraw(this,r,o,a),h&&e.highlightShadowMap.submitDraw(this,r,o,a)),h&&U(l)&&e.defaultShadowMap.submitDraw(this,r,l,a)}get attributeLocations(){return hM}_computeWhichMaterialPass(){return this.isIntegratedMesh?xM.IntegratedMesh:this.objectOpacity<1?xM.Transparent:this.componentParameters.opaqueOverride===wM.All?xM.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===vd.Blend||this.alphaDiscardMode===vd.MaskBlend?xM.Transparent:this.componentParameters.transparent===wM.None?xM.Opaque:this.componentParameters.transparent===wM.All?xM.Transparent:xM.OpaqueAndTransparent}}var bM,xM,wM;e([gM({vectorOps:bt})],vM.prototype,"baseColor",void 0),e([gM()],vM.prototype,"usePBR",void 0),e([gM()],vM.prototype,"hasParametersFromSource",void 0),e([gM({vectorOps:vt})],vM.prototype,"mrrFactors",void 0),e([gM({vectorOps:vt})],vM.prototype,"emissiveFactor",void 0),e([gM({dispose:!0})],vM.prototype,"baseColorTexture",void 0),e([gM({dispose:!0})],vM.prototype,"metallicRoughnessTexture",void 0),e([gM({dispose:!0})],vM.prototype,"emissionTexture",void 0),e([gM({dispose:!0})],vM.prototype,"occlusionTexture",void 0),e([gM({dispose:!0})],vM.prototype,"normalTexture",void 0),e([gM()],vM.prototype,"objectOpacity",void 0),e([fM()],vM.prototype,"commonMaterialParameters",void 0),e([fM()],vM.prototype,"componentParameters",void 0),e([gM()],vM.prototype,"textureAlphaCutoff",void 0),e([gM()],vM.prototype,"alphaDiscardMode",void 0),e([gM()],vM.prototype,"isIntegratedMesh",void 0),e([gM()],vM.prototype,"polygonOffsetEnabled",void 0),e([gM()],vM.prototype,"ellipsoidMode",void 0),e([gM()],vM.prototype,"hasOccludees",void 0),function(e){e[e.VERTEX=0]="VERTEX",e[e.GROUND=1]="GROUND",e[e.SCREEN_DERIVATIVE=2]="SCREEN_DERIVATIVE"}(bM||(bM={})),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(xM||(xM={}));class TM extends mM{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=yd.Back,this.hasSlicePlane=!0}}e([gM()],TM.prototype,"doubleSided",void 0),e([gM()],TM.prototype,"cullFace",void 0),e([gM()],TM.prototype,"hasSlicePlane",void 0);class CM extends mM{constructor(){super(...arguments),this.externalColor=Pc(1,1,1,1),this.externalColorMixMode=Zh.Multiply,this.castShadows=wM.All}get transparent(){return this.externalColor[3]<1?wM.All:wM.None}get opaqueOverride(){return this.externalColorMixMode===Zh.Replace&&1===this.externalColor[3]?wM.All:wM.None}get visible(){return this.externalColor[3]>0?wM.All:wM.None}get type(){return YO.Uniform}}e([gM({vectorOps:bt})],CM.prototype,"externalColor",void 0),e([gM()],CM.prototype,"externalColorMixMode",void 0),e([gM()],CM.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(wM||(wM={}));class SM extends mM{constructor(){super(...arguments),this.texture=null,this.transparent=wM.None,this.opaqueOverride=wM.None,this.castShadows=wM.None}get type(){return YO.Varying}}e([gM()],SM.prototype,"texture",void 0),e([gM()],SM.prototype,"transparent",void 0),e([gM()],SM.prototype,"opaqueOverride",void 0),e([gM()],SM.prototype,"castShadows",void 0);class PM{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e)}}class RM{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.textureWidth=4096,this.dirty=!0,this.texture=new jo(this.rctx,{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,samplingMode:Rn.NEAREST,wrapMode:Pn.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this.data=new hu(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(e,t,i,r,s,a){const n=e*this.fieldCount+t;this.dirty=!0,this.data.set(n,0,i),this.data.set(n,1,r),this.data.set(n,2,s),this.data.set(n,3,a)}setDataElement(e,t,i,r){const s=e*this.fieldCount+t;this.dirty=!0,this.data.set(s,i,r)}resizeToFit(e){const t=e*this.fieldCount;if(t>=this.data.count){const e=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,i=new hu(new ArrayBuffer(4*e));i.typedBuffer.set(this.data.typedBuffer),this.data=i}}updateTexture(){if(!this.dirty)return;const e=this.texture.descriptor.width,t=this.texture.descriptor.height;this.data.count>e*t&&this.texture.resize(e,this.data.count/e),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(e,t,i){e.bindTexture(t,this.texture),e.setUniform2f(i,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}class AM{constructor(e,t=1){this.textureBuffer=new RM(e,t),this.indexManager=new PM(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e)}}class OM{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this.buffers.forEach((e=>e.dispose())),this.buffers=[]}getBuffer(e){for(const t of this.buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new AM(this.rctx,this.fieldCount);return this.buffers.push(t),t}updateTextures(){for(const e of this.buffers)e.textureBuffer.updateTexture()}}const MM=V.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class EM{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._objects=[new le,new le],this._renderSubmit=new QO(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new OM(e.rctx,2)}dispose(){Go(0===this._objects[gO.Hidden].length&&0===this._objects[gO.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const t=new mO;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=eA(e.obb),t.components=new pO(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new vO(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t}destroyObject(e){const t=e;this._objects[t.visible].removeUnordered(t),t.dispose(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(this._objects[i.visible].removeUnordered(i),this._objects[t].push(i),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=Ke(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount();return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){const i=e,r=i.renderable.material,s=i.components,a=s.materialDataBuffer,n=s.materialDataIndices,o={castShadows:!0,pickable:!0,externalColor:Rc(),externalColorMixMode:Zh.Multiply,elevationOffset:0},l=a.textureBuffer,h=new Uint8Array(4),c=new Uint32Array(h.buffer);let d=0,u=0,p=0,m=s.verticalOffsets,g=1/0,f=-1/0,_=!1,y=!1,v=0;for(let e=0;e<s.count;e++)t(e,o),d+=+(o.externalColor[3]<1),u+=+(o.externalColorMixMode===Zh.Replace&&1===o.externalColor[3]),p+=+o.castShadows,tc(o.externalColor,o.externalColorMixMode,h),h[2]=254&h[2]|+o.castShadows,l.setData(n[e],0,h[0],h[1],h[2],h[3]),_||(_=e>0&&v!==c[0]),v=c[0],y||(y=0!==o.elevationOffset),y&&z(m)&&(m=new Array(e).fill(0)),U(m)&&(m[e]=o.elevationOffset),g=Math.min(g,o.elevationOffset),f=Math.max(f,o.elevationOffset),tM(o.elevationOffset,h),l.setData(n[e],1,h[0],h[1],h[2],h[3]),o.pickable!==_O(s.pickability,e)&&(s.pickability=fO(s.pickability,s.count,e,o.pickable));s.verticalOffsets=y?m:null,i.offsetObb=y?kA(i.obb,g,f,this._viewingMode,U(i.offsetObb)?i.offsetObb:eA(i.obb)):null,_||y?(r.componentParameters=new SM,r.componentParameters.castShadows=IM(p,s.count),r.componentParameters.transparent=IM(d,s.count),r.componentParameters.opaqueOverride=IM(u,s.count),r.componentParameters.texture=l,l.updateTexture()):(r.componentParameters=new CM,r.componentParameters.castShadows=o.castShadows?wM.All:wM.None,r.componentParameters.externalColor=o.externalColor,r.componentParameters.externalColorMixMode=o.externalColorMixMode),this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const s=e,a=s.components.verticalOffsets;if(r||z(a))return i;const n=a[t];if(this._viewingMode===Gi.Local||0===n)return i[2]+=n,i[5]+=n,i;const o=Z(gh(n));return o.localOrigin=s.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}intersect(e,t,i,r,s,a){const n=e;U(s)&&(s.localOrigin=n.transform.position);const o=mo(LM,n.transform.rotationScale);ht(NM,t,n.transform.position),ht(FM,i,n.transform.position),Ye(NM,NM,o),Ye(FM,FM,o);const l=co(LM,o);return n.intersectionGeometry.intersect(NM,FM,r,l,s,n.components.verticalOffsets,a)}addEdges(e,t,i,r){const s=e,{indices:a,positions:n}=s.intersectionGeometry,o=s.components.offsets;return t.addComponentObject(e,s.transform,{center:s.obb.center,radius:(l=s.obb,ut(l.halfSize))},n,a,o,i,r);var l}async extractEdgeInformation(e,t,i){const r=e,s=r.components.visibility;if(s.allInvisible())return{buffer:Ou.createBuffer(0),origin:[0,0,0]};const{indices:a,positions:n}=r.intersectionGeometry,o=r.components.offsets,l=Mu.createBuffer(n.count);mu(l.position,n),gu(l.position,l.position,r.transform.rotationScale),this._setComponentIndices(l.componentIndex,a,o);const h=l.count,c=this._computeVisibilityIndices(a,s,o,h);return{origin:Xe(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:c,indicesLength:c.length,skipDeduplicate:!0,data:l,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let r=0;for(let s=0;s<i.length-1;s++){const a=i[s],n=i[s+1];for(let i=a;i<n;i++){const s=t?t[i]:i;e.set(s,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange(((e,t)=>(s+=i[t]-i[e],!0)));const a=2===e?.BYTES_PER_ELEMENT||r<=65536?new Uint16Array(s):new Uint32Array(s);let n=0;return t.forEachComponentRange(((t,r)=>{const s=i[t],o=i[r];for(let t=s;t<o;t++)a[n++]=e?e[t]:t;return!0})),a}addComponentHighlight(e,t){const i=e.components;z(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1)),0==i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(z(i.highlightCounts))return void MM.warn("Removing non-existing highlight.");const r=i.highlightCounts[t],s=i.highlightCounts[i.count];if(0!==r){if(r>1)return i.highlightCounts[t]=r-1,void(i.highlightCounts[i.count]=s-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===s?i.highlightCounts=null:i.highlightCounts[i.count]=s-1}else MM.warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;U(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[gO.Visible]}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,a=Fo.createVertex(i,An.STATIC_DRAW,r.vertices.data),n=Q(r.indices,(e=>Fo.createIndex(i,An.STATIC_DRAW,e))),o=Eo(ZO(s)),l=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],s=t.offsets[e+1],a=t.materialDataIndices[e];if(U(r.indices))for(let e=i;e<s;e++)l[r.indices[e]]=a;else for(let e=i;e<s;e++)l[e]=a}const h=Fo.createVertex(i,An.STATIC_DRAW,l.buffer),c=new vM(e.transform,e.toMapSpace),d=new No(i,c.attributeLocations,{data:o,componentIndices:DM},{data:a,componentIndices:h},Z(n)),u=new TO(d,xn.TRIANGLES,s,U(n)),p={cameraDepthSquared:.5,gpuMemoryEstimate:a.byteSize+h.byteSize+(U(n)?n.byteSize:0)};return new wO(c,u,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const DM=Eo(Do().u16(yn.COMPONENTINDEX));function IM(e,t){return e===t?wM.All:0===e?wM.None:wM.Some}const LM=pu(),NM=Oe(),FM=Oe();class VM extends on{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}}const UM=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:VM,build:function(e){const t=new ws;t.include(Ka);const i=t.fragment;switch(e.function){case Ea.Standard:i.uniforms.add(new Ns("tex",(e=>e.texture))),e.hasOpacityFactor?(i.uniforms.add(new Vs("opacity",(e=>e.opacity))),i.code.add(an`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):i.code.add(an`void main() {
gl_FragColor = texture2D(tex, uv);
}`);break;case Ea.OverlayWithTransparency:i.uniforms.add(new Ns("tex",(e=>e.texture))),i.uniforms.add(new es("overlayIdx",(e=>e.overlayIndex))),e.hasOpacityFactor&&i.uniforms.add(new Vs("opacity",(e=>e.opacity))),i.code.add(an`
        void main() {
          vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
          gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
        }`);break;case Ea.TransparentToHUDVisibility:i.uniforms.add(new Ns("tex",(e=>e.texture))),i.code.add(an`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`);break;case Ea.Transparency:i.uniforms.add([new Ns("colorTexture",(e=>e.colorTexture)),new Ns("alphaTexture",(e=>e.alphaTexture)),new Ns("frontFaceTexture",(e=>e.frontFaceTexture))]),i.code.add(an`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`);break;case Ea.COUNT:break;default:Gl(e.function)}return t}},Symbol.toStringTag,{value:"Module"}));class zM extends As{initializeProgram(e){const t=zM.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){if(this.configuration.function===Ea.TransparentToHUDVisibility)return Nn({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case Da.None:return Nn({colorWrite:Vn});case Da.Alpha:return Nn({blending:Fn(vn.SRC_ALPHA,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),colorWrite:Vn});default:return Nn({blending:Un(vn.ONE,vn.ONE_MINUS_SRC_ALPHA),colorWrite:Vn})}}}zM.shader=new Rs(UM,(()=>Promise.resolve().then((()=>UM))));class jM{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._configuration=new Ia,this._passParameters=new VM}dispose(){this._vao=B(this._vao)}compositeTransparent(e,t,i,r,s=1){this._configuration.alphaMode=Da.Alpha,this._configuration.function=Ea.Transparency,this._configuration.hasOpacityFactor=1!==s,this._passParameters.colorTexture=t,this._passParameters.alphaTexture=i,this._passParameters.frontFaceTexture=r;const a=this._rctx,n=this._techniqueRepository.acquire(zM,this._configuration);a.bindTechnique(n,this._passParameters,e);const o=this._ensureVAO();a.bindVAO(o),a.drawArrays(xn.TRIANGLE_STRIP,0,Lo(o,"geometry")),n.release()}composite(e,t,i=Da.None,r=1,s=Ea.Standard,a=Zd.INNER){const n=this._rctx;this._configuration.alphaMode=i,this._configuration.function=s,this._configuration.hasOpacityFactor=1!==r,this._passParameters.overlayIndex=a,this._passParameters.texture=t,this._passParameters.opacity=r;const o=this._techniqueRepository.acquire(zM,this._configuration);n.bindTechnique(o,this._passParameters,e);const l=this._ensureVAO();n.bindVAO(l),n.drawArrays(xn.TRIANGLE_STRIP,0,Lo(l,"geometry")),o.release()}_ensureVAO(){return z(this._vao)&&(this._vao=Ms(this._rctx)),this._vao}}function kM(e,t,i){return Ru(t,e)*(i[1]-i[0])+i[0]}function GM(e,t,i){if(!i.isVisible)return;if(!hc(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=QM;i.geometryRecords.forEach((i=>{Ir(s,r,i.getShaderTransformation());const a=er(s);qM(e,t,i.geometry.boundingInfo,s,a)}))}function qM(e,t,i,r,s){if(z(i))return;const a=t.eye,n=t.viewForward;Qe(WM,i.center,r);const o=n[0]*(WM[0]-a[0])+n[1]*(WM[1]-a[1])+n[2]*(WM[2]-a[2]);if(WM[3]=i.radius*s,!(o-WM[3]>e.near&&o+WM[3]<e.far)&&hc(t.frustum,WM))if(i.radius>100&&i.getChildren()){const a=i.getChildren();for(let i=0;i<8;++i)a[i]&&qM(e,t,a[i],r,s)}else KM.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function BM(e,t,i){const r=t.eye,s=t.viewForward,a=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,a-i[3]),e.far=Math.max(e.far,a+i[3])}const HM=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],WM=eo(),QM=zr(),ZM=CO(),XM=new class{constructor(){this._items=new le({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.obj.boundingVolumeWorldSpace.bounds,s=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=s,e.near=s-r[3],e.far=s+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===zu.DepthOrder.FRONT_TO_BACK)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}}},YM=new class{constructor(){this.view=zr(),this.viewProj=zr(),this.frustum=ac(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(e,t){this._reset(),Er(this.view,e.viewMatrix),Ir(this.viewProj,e.projectionMatrix,this.view),_c(this.frustum,e.frustum);const i=this.view,r=i[2],s=i[6],a=i[10],n=i[14],o=this.range;let l=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),WM,1),t=WM):t=e.boundingSphere;const i=r*t[0]+s*t[1]+a*t[2]+n,o=i-t[3],h=i+t[3];this.geometries[l]=e,this.near[l]=-h,this.far[l]=-o,++l})),0===this.geometries.length)return o;for(let e=0;e<this.geometries.length;++e)this.near[e]>o.far&&(o.far=this.near[e]),this.near[e]>2&&this.far[e]<o.near&&(o.near=this.far[e]);const h=this.looseRange;h.near=Math.max(.5*o.near,2),h.far=2*o.far;let c=0,d=0;for(let e=0;e<this.geometries.length;++e)this.near[e]<o.near&&(this.near[e]>=h.near?o.near=this.near[e]:this.nearCandidates[c++]=e),this.far[e]>o.far&&(this.far[e]<=h.far?o.far=this.far[e]:this.farCandidates[d++]=e);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return o;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let e=0;e<this.nearCandidates.length;++e){const t=this.nearCandidates[e];if(this.near[t]<o.near){const e=this.geometries[t],i=e.boundingInfo;this._includeNearBoundingInfoRec(i,e.getShaderTransformation())}}for(let e=0;e<this.farCandidates.length;++e){const t=this.farCandidates[e];if(this.far[t]>o.far){const e=this.geometries[t],i=e.boundingInfo;this._includeFarBoundingInfoRec(i,e.getShaderTransformation())}}return o}_reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}_includeNearBoundingInfoRec(e,t){if(z(e))return;const i=e.getCenter();Qe(WM,i,t);const r=er(t),s=WM[0],a=WM[1],n=WM[2],o=e.getBSRadius()*r,l=this.frustum;if(l[0][0]*s+l[0][1]*a+l[0][2]*n+l[0][3]>o||l[1][0]*s+l[1][1]*a+l[1][2]*n+l[1][3]>o||l[2][0]*s+l[2][1]*a+l[2][2]*n+l[2][3]>o||l[3][0]*s+l[3][1]*a+l[3][2]*n+l[3][3]>o)return;const h=this.view[2]*s+this.view[6]*a+this.view[10]*n+this.view[14],c=h+o;if(!(-(h-o)<2||-c>=this.range.near))if(-c>this.looseRange.near)this.range.near=-c;else{if(o>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this._includeNearBoundingInfoRec(i[e],t);return}}KM.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}_includeFarBoundingInfoRec(e,t){if(z(e))return;let i=e.getBSRadius();const r=e.getCenter();Qe(WM,r,t);const s=er(t),a=WM[0],n=WM[1],o=WM[2];i*=s;const l=this.frustum;if(l[0][0]*a+l[0][1]*n+l[0][2]*o+l[0][3]>i||l[1][0]*a+l[1][1]*n+l[1][2]*o+l[1][3]>i||l[2][0]*a+l[2][1]*n+l[2][2]*o+l[2][3]>i||l[3][0]*a+l[3][1]*n+l[3][2]*o+l[3][3]>i)return;const h=this.view[2]*a+this.view[6]*n+this.view[10]*o+this.view[14]-i;if(!(-h<=this.range.far))if(-h<this.looseRange.far)this.range.far=-h;else{if(i>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this._includeFarBoundingInfoRec(i[e],t);return}}KM.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},KM=new class{constructor(){this.modelViewProj=zr(),this.clipPosition=[hr(),hr(),hr(),hr(),hr(),hr(),hr(),hr()]}unionDepthRangeWithAABB(e,t,i,r,s){const a=this.modelViewProj;Ir(a,t,i);let n=!1;for(let e=0;e<8;++e){const t=this.clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:s[0],n=0===e||1===e||4===e||5===e?r[1]:s[1],o=e<4?r[2]:s[2];t[0]=a[0]*i+a[4]*n+a[8]*o+a[12],t[1]=a[1]*i+a[5]*n+a[9]*o+a[13],t[2]=a[2]*i+a[6]*n+a[10]*o+a[14],t[3]=a[3]*i+a[7]*n+a[11]*o+a[15]}for(let t=0;t<12;++t){const i=this.clipPosition[HM[t][0]],r=this.clipPosition[HM[t][1]],s=this.clipPosition[HM[t][2]],a=this._clipTriangle(i,r,s);let o=!0;for(let e=0;e<a.length;++e)if(a[e][3]>=2){o=!1;break}if(!o){n=!0;for(let t=0;t<a.length;++t){const i=a[t][3];i<e.near&&(e.near=i),i>e.far&&(e.far=i)}}}return n}_inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void Go(!1)}_intersect(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),xt(hr(),e,t,r)}_clipTriangle(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const s=t[i],a=t[(i+1)%t.length];this._inside(a,e)?(this._inside(s,e)||r.push(this._intersect(s,a,e)),r.push(a)):this._inside(s,e)&&r.push(this._intersect(s,a,e))}}return r}};class $M extends on{constructor(){super(...arguments),this.maskEnabled=!1,this.overlayEnabled=!1}}let JM=class extends N{constructor(){super(...arguments),this._handles=new lr,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new $M,this.events=new or,this.attributeLocations=new Map([[yn.POSITION,0]]),this.tmpScreenPoint=ue(),this.tmpRenderPoint=_e()}get updating(){return z(this._imageSources)&&U(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};U(this._magnifier)&&this._handles.add(K((()=>Q(this._magnifier,(e=>e.version))),t)),t()}get enabled(){return U(this._validMagnifier)}get _validMagnifier(){return U(this._magnifier)&&this._magnifier.visible&&U(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return U(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),U(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const i=this._validMagnifier;if(z(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this._updateResources(e,s),z(this._resources))return;this._passParameters.maskEnabled=i.maskEnabled,this._passParameters.overlayEnabled=i.overlayEnabled;const a=this._resources.program;e.useProgram(a),a.bindPass(this._passParameters,t);const n=this._resources.textures,o=Math.ceil(1/this.factor*s);n.input.resize(o,o);const l=t.camera.fullWidth,h=t.camera.fullHeight;pe(i.position,this.tmpScreenPoint);const c=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*o,u=.5*o;c[0]=Se(c[0],d,l-d-1),c[1]=Se(c[1],u,h-u-1);const p=Math.floor(c[0]-d),m=Math.floor(c[1]-u);a.bindTexture("textureInput",n.input),e.gl.copyTexImage2D(n.input.descriptor.target,0,n.input.descriptor.pixelFormat,p,m,o,o,0);const g=i.offset.x*r,f=i.offset.y*r,_=(c[0]+g)/l*2-1,y=(c[1]-f)/h*2-1,v=s/l*2,b=s/h*2;e.bindVAO(this._resources.vao),a.bindTexture("textureOverlay",n.overlay),a.bindTexture("textureMask",n.mask),a.setUniform4f("drawPosition",_,y,v,b),e.setPipelineState(this._resources.pipelineState),e.drawArrays(xn.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(z(e))return;const t=e.maskUrl,i=e.overlayUrl;!U(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),U(this._imageSources)||U(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:c((async e=>{const r=z(t)||z(i)?Sh(e):null,s=U(t)?Mo(t,{signal:e}):r.then((e=>e.mask)),a=U(i)?Mo(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await a},this._disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(U(this._resources)){if(this._resources.textures.size!==t){const i=this._createTextureResources(e,t);if(z(i))return void this._disposeResources();this._disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this._createTextureResources(e,t);z(i)||(this._resources={textures:i,program:this._createProgram(e),vao:Ms(e,ra,this.attributeLocations,0,1),pipelineState:Nn({blending:Un(vn.ONE,vn.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Vn})})}_disposeResources(){z(this._resources)||(this._disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(z(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new jo(e,{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,internalFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:Rn.LINEAR,flipped:!0,preMultiplyAlpha:!pd(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new jo(e,{target:Tn.TEXTURE_2D,pixelFormat:Cn.ALPHA,internalFormat:Cn.ALPHA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:Rn.LINEAR,flipped:!0},this._imageSources.mask);return{input:new jo(e,{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,internalFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,samplingMode:Rn.LINEAR,flipped:!1}),mask:r,overlay:i,size:t}}_createProgram(e){return new Os(e,function(){const e=new ws;return e.attributes.add(yn.POSITION,"vec2"),e.vertex.uniforms.add(new Xa("drawPosition")),e.varyings.add("vUV","vec2"),e.vertex.code.add(an`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add(new Ya("textureInput")),e.fragment.uniforms.add(new Ya("textureMask")),e.fragment.uniforms.add(new Ya("textureOverlay")),e.fragment.uniforms.add(new Jr("maskEnabled",(e=>e.maskEnabled))),e.fragment.uniforms.add(new Jr("overlayEnabled",(e=>e.overlayEnabled))),e.fragment.code.add(an`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}(),this.attributeLocations)}};e([ve()],JM.prototype,"_imageSources",void 0),e([ve()],JM.prototype,"_imageLoadTask",void 0),e([ve({readOnly:!0})],JM.prototype,"updating",null),JM=e([xe("esri/views/3d/webgl-engine/lib/MagnifierHelper")],JM);const eE=ae(1e3/30);var tE;!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(tE||(tE={}));class iE{constructor(e,t,i=tE.FrontToBack){this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new le({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r){const s=this._draws.pushNew();s.geometry=t,s.geometryRanges=i,s.material=e,s.depthSquaredHint=r,s.indexType=t.indexed?Z(t.vao.indexBuffer).indexType:0}dispatch(e,t){const i=this._rctx;this._previouslyBoundDraw.clear();let r=null;const s=this._draws.map((i=>i.material.prepareTechnique(this._techniqueRepository,e,t,i.geometry.parameters))),a=this._draws.length;for(let n=0;n<a;n++){const a=s[n];a===r&&a.configuration.transparencyPassType===bd.NONE||(i.bindTechnique(a,e,t),r=a);const o=this._draws.data[n],l=o.geometry;i.bindVAO(l.vao),this._previouslyBoundDraw.get(a)!==o.material&&(a.bindDraw(o.material,t),this._previouslyBoundDraw.set(a,o.material));const h=o.geometryRanges,c=h.length;if(0!==o.indexType){const e=rE.get(o.indexType);for(let t=0;t<c;t+=2){const r=h[t],s=h[t+1];i.drawElements(l.primitiveType,s,o.indexType,r*e)}}else for(let e=0;e<c;e+=2){const t=h[e],r=h[e+1];i.drawArrays(l.primitiveType,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===tE.FrontToBack?1:-1;this._draws.sort(((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-i.geometry.vao.size}))}get count(){return this._draws.length}}const rE=new Map;rE.set(En.UNSIGNED_BYTE,1),rE.set(En.UNSIGNED_SHORT,2),rE.set(En.UNSIGNED_INT,4);class sE{constructor(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParameters=new cP,this._shadowPassParameters=new dP,this._highlightPassParameters=new uP,this._systems=new Set,this._passes={materialOpaque:new iE(e,t),materialTransparent:new iE(e,t,tE.BackToFront),materialIntegratedMesh:new iE(e,t),shadowMap:new iE(e,t),highlight:new iE(e,t),highlightIntegratedMesh:new iE(e,t),highlightShadowMap:new iE(e,t),defaultShadowMap:new iE(e,t)}}register(e){this._systems.add(e)}prepareRender(e){if(0!==this._systems.size){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,e.bindParameters)));for(const e of Object.values(this._passes))e.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(e){if(0!==this._systems.size)switch(this._configure(e),e.bindParameters.slot){case Zo.OPAQUE_MATERIAL:switch(e.pass){case Xo.MATERIAL:return this._materialPassParameters.subPass=lP.Color,this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_DEPTH:return this._materialPassParameters.subPass=lP.Depth,this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_NORMAL:return this._materialPassParameters.subPass=lP.Normal,this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_HIGHLIGHT:return this._passes.highlight.dispatch(this._highlightPassParameters,e.bindParameters);case Xo.MATERIAL_DEPTH_SHADOWMAP_ALL:return this._passes.shadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case Xo.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case Xo.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,e.bindParameters)}return;case Zo.TRANSPARENT_MATERIAL:switch(e.pass){case Xo.MATERIAL:return this._materialPassParameters.subPass=lP.Color,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_ALPHA:return this._materialPassParameters.subPass=lP.Alpha,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_DEPTH:return this._materialPassParameters.subPass=lP.Depth,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_NORMAL:return this._materialPassParameters.subPass=lP.Normal,this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters)}return;case Zo.INTEGRATED_MESH:switch(e.pass){case Xo.MATERIAL:return this._materialPassParameters.subPass=lP.Color,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_DEPTH:return this._materialPassParameters.subPass=lP.Depth,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_NORMAL:return this._materialPassParameters.subPass=lP.Normal,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case Xo.MATERIAL_HIGHLIGHT:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,e.bindParameters)}return}}notifyDirty(){this._context.requestRender()}slots(){return[Zo.OPAQUE_MATERIAL,Zo.TRANSPARENT_MATERIAL,Zo.INTEGRATED_MESH]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const t={near:1/0,far:-1/0};return this._systems.forEach((i=>{const r=i.queryShadowCasterDepthRange(e);U(r)&&PO(t,r,t)})),t}_configure(e){const t=e.pass===Xo.MATERIAL_DEPTH_SHADOWMAP_ALL||e.pass===Xo.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||e.pass===Xo.MATERIAL_DEPTH_SHADOWMAP_DEFAULT?this._shadowPassParameters:e.pass===Xo.MATERIAL_HIGHLIGHT?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,t)}_updateParameters(e,t){const i=e.bindParameters.camera,r=i.viewInverseTransposeMatrix;Me(aE,r[3],r[7],r[11]),oE.set(aE),De(t.transformWorldFromViewTH,oE.high),De(t.transformWorldFromViewTL,oE.low),De(t.slicePlaneLocalOrigin,aE),ho(t.transformViewFromCameraRelativeRS,i.viewMatrix),Er(t.transformProjFromView,i.projectionMatrix),t.identifier===oP.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===Zo.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===Zo.INTEGRATED_MESH,co(nE,t.transformViewFromCameraRelativeRS),mo(t.transformNormalViewFromGlobal,nE))}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}}const aE=Oe(),nE=xo(),oE=new _M,lE=hr(),hE=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new ws,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(yn.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(yn.UV0,"vec2"),t.uniforms.add(new Ns("coverageTex",(e=>e.coverageTexture))),r.add(an`void main() {
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),i.uniforms.add(new Ns("tex",(e=>e.blurColorTexture))),i.uniforms.add(new Ns("origin",(e=>e.highlightColorTexture))),i.uniforms.add(new Fs("uColor",(e=>e.color))),i.uniforms.add(new Fs("haloColor",(e=>e.haloColor))),i.uniforms.add(new Fs("opacities",(e=>et(lE,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)))),i.constants.add("outlineSize","float",8.6),i.constants.add("blurSize","float",.4),s.add(an`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),e}},Symbol.toStringTag,{value:"Module"}));class cE extends As{initializeProgram(e){const t=cE.shader.get().build();return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Fn(vn.SRC_ALPHA,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),colorWrite:Vn})}}cE.shader=new Rs(hE,(()=>Promise.resolve().then((()=>hE))));class dE extends on{constructor(){super(...arguments),this.blurSize=Sr()}}const uE=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:dE,build:function(){const e=new ws,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(yn.POSITION,"vec2"),e.attributes.add(yn.UV0,"vec2"),e.varyings.add("blurCoordinate","vec3"),t.uniforms.add(new Ns("coverageTex",(e=>e.coverageTexture))),i.uniforms.add(new gs("blurSize",(e=>e.blurSize))),r.add(an`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
}`),i.uniforms.add(new fs("tex",(e=>e.blurInputTexture))),s.add(an`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture2D(tex, uv);
if (blurCoordinate.z == 1.0) {
gl_FragColor = center;
} else {
vec4 sum = vec4(0.0);
sum += center * 0.204164;
sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
gl_FragColor = sum;
}
}`),e}},Symbol.toStringTag,{value:"Module"}));class pE extends As{initializeProgram(e){const t=pE.shader.get().build();return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({colorWrite:Vn})}}pE.shader=new Rs(uE,(()=>Promise.resolve().then((()=>uE))));class mE extends on{constructor(){super(...arguments),this.invFramebufferDim=Sr()}}const gE=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:mE,build:function(){const e=new ws,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(yn.POSITION,"vec2"),r.add(an`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),i.uniforms.add(new fs("tex",(e=>e.inputTexture))),i.uniforms.add(new gs("invFramebufferDim",(e=>e.invFramebufferDim))),s.add(an`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`),e}},Symbol.toStringTag,{value:"Module"}));class fE extends As{initializeProgram(e){const t=fE.shader.get().build();return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({colorWrite:Vn})}}fE.shader=new Rs(gE,(()=>Promise.resolve().then((()=>gE))));class _E extends on{constructor(){super(...arguments),this.color=Pc(1,0,1,1),this.haloColor=Pc(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.shadowColor=cr(1,0,1,1),this.shadowOpacity=.15,this.occludedShadowOpacity=.075}}class yE{constructor(e,t){this._techniqueRep=e,this._rctx=t,this.viewportToRestore=hr(),this._passParameters=new _E,this._downsampleDrawParameters=new mE,this._blurDrawParameters=new dE,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this.quadVAO)return;this.quadVAO=Ms(this._rctx);const e={colorTarget:wn.TEXTURE,depthStencilTarget:On.NONE,width:0,height:0},t={target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,samplingMode:Rn.LINEAR,wrapMode:Pn.CLAMP_TO_EDGE,width:0,height:0};this.blur0Fbo=new To(this._rctx,e,t),this.blur1Fbo=new To(this._rctx,e,t);const i=new Qn;this._blurTechnique=this._techniqueRep.acquire(pE,i),this._downsampleTechnique=this._techniqueRep.acquire(fE,i),this._applyTechnique=this._techniqueRep.acquire(cE,i)}dispose(){if(this._blurTechnique=q(this._blurTechnique),this._downsampleTechnique=q(this._downsampleTechnique),this._applyTechnique=q(this._applyTechnique),this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=B(this.blur0Fbo),this.blur1Fbo=B(this.blur1Fbo)}setDefaultOptions(e){this._passParameters={...new _E,...e}}render(e,t,i){this._passParameters.highlightColorTexture=t.colorTexture,this._assertResources();const r=e.camera;ct(this.viewportToRestore,r.fullViewport);const s=r.fullWidth,a=r.fullHeight,n=r.pixelRatio,o=Math.ceil(s/n),l=Math.ceil(a/n);this.blur0Fbo.resize(o,l),this.blur1Fbo.resize(o,l);const h=this._rctx;h.bindVAO(this.quadVAO);let c=null;this._gridUpdateResources(t,32),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,c=this._grid.vao;const d=h.bindTechnique(this._blurTechnique,this._passParameters,e);h.bindVAO(c),h.bindFramebuffer(this.blur0Fbo),h.setViewport(0,0,o,l),h.setClearColor(0,0,0,0),h.clear(Mn.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=t.colorTexture,xr(this._blurDrawParameters.blurSize,1/o,0),d.bindDraw(this._blurDrawParameters,e),h.drawArrays(this._blurTechnique.primitiveType,0,Lo(c,"geometry")),h.bindFramebuffer(this.blur1Fbo),h.clear(Mn.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this.blur0Fbo.colorTexture,xr(this._blurDrawParameters.blurSize,0,1/l),d.bindDraw(this._blurDrawParameters,e),h.drawArrays(this._blurTechnique.primitiveType,0,Lo(c,"geometry")),h.bindFramebuffer(i),h.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),this._passParameters.blurColorTexture=this.blur1Fbo.colorTexture,h.bindTechnique(this._applyTechnique,this._passParameters,e),h.drawArrays(this._applyTechnique.primitiveType,0,Lo(c,"geometry")),h.bindVAO(null)}_gridUpdateResources(e,t){const i=this._rctx,r=this._grid;let s=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],s=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(s=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,s=!0),s){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const t=r.coverageMipmap[e],s={target:Tn.TEXTURE_2D,pixelFormat:Cn.RGB,dataType:Sn.UNSIGNED_SHORT_5_6_5,samplingMode:Rn.LINEAR,wrapMode:Pn.CLAMP_TO_EDGE,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)},a={colorTarget:wn.TEXTURE,depthStencilTarget:On.NONE,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)};r.coverageMipmap[e+1]=new To(i,a,s)}}const a=Math.ceil(e.height/r.cellPixelSize),n=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==a||r.horizontalCellCount!==n){r.verticalCellCount=a,r.horizontalCellCount=n;const e=a+1,t=n+1,s=1/a,o=1/n,l=6,h=4,c=new Float32Array(l*h*e*t);let d=0;for(let i=0;i<e;i++)for(let e=0;e<t;e++)c[d+0]=(e-.5)*o*2-1,c[d+1]=(i-.5)*s*2-1,c[d+2]=e*o,c[d+3]=i*s,c[d+4]=(e+.5)*o*2-1,c[d+5]=(i-.5)*s*2-1,c[d+6]=e*o,c[d+7]=i*s,c[d+8]=(e-.5)*o*2-1,c[d+9]=(i+.5)*s*2-1,c[d+10]=e*o,c[d+11]=i*s,c[d+12]=(e-.5)*o*2-1,c[d+13]=(i+.5)*s*2-1,c[d+14]=e*o,c[d+15]=i*s,c[d+16]=(e+.5)*o*2-1,c[d+17]=(i-.5)*s*2-1,c[d+18]=e*o,c[d+19]=i*s,c[d+20]=(e+.5)*o*2-1,c[d+21]=(i+.5)*s*2-1,c[d+22]=e*o,c[d+23]=i*s,d+=l*h;r.vao&&r.vao.dispose(!0),r.vao=new No(i,nn,{geometry:Es},{geometry:Fo.createVertex(i,An.STATIC_DRAW,c)})}}_gridComputeMipmap(e){const t=this._rctx,i=this._grid,r=t.bindTechnique(this._downsampleTechnique,this._passParameters,e);t.bindVAO(this.quadVAO);for(let s=0;s<i.mipmapLevels;s++){t.bindFramebuffer(i.coverageMipmap[s+1]);const a=i.coverageMipmap[s+1].width,n=i.coverageMipmap[s+1].height;this._downsampleDrawParameters.inputTexture=i.coverageMipmap[s].colorTexture,xr(this._downsampleDrawParameters.invFramebufferDim,1/a,1/n),r.bindDraw(this._downsampleDrawParameters,e),t.setViewport(0,0,a,n),t.drawArrays(xn.TRIANGLE_STRIP,0,Lo(this.quadVAO,"geometry"))}}get gpuMemoryUsage(){let e=(U(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(U(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const t of this._grid.coverageMipmap)e+=t.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const vE={dataType:Sn.UNSIGNED_BYTE,internalFormat:Cn.RGBA},bE={};class xE{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._disposeWithFramebuffers(this._depthTextures,t),this._disposeWithFramebuffers(this._depthBuffers,t),this._disposeWithFramebuffers(this._colorTextures,t))}_disposeWithFramebuffers(e,t){const i=e.get(t);i&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==i&&e.depthStencilAttachment!==i||(e.detachAll(),e.dispose(),this._framebuffers.delete(t))})),i.dispose(),e.delete(t))}getDepthTexture(e,t){if(!this.depthTextureSupported)return null;let i=this._depthTextures.get(e.id);return!i||i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=null),i||(i=new jo(this.rctx,{target:Tn.TEXTURE_2D,pixelFormat:Cn.DEPTH_STENCIL,dataType:Sn.UNSIGNED_INT_24_8,samplingMode:Rn.NEAREST,wrapMode:Pn.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return null;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===t.width&&i.descriptor.height===t.height||i.resize(t.width,t.height):(i=new Co(this.rctx,{internalFormat:Dn.DEPTH_STENCIL,...t}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=null)),i||(i=new jo(this.rctx,{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:Rn.LINEAR,wrapMode:Pn.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:Uh(),...bE,...e}}registerColorTarget(e={}){return{id:Uh(),...vE,...e}}getFramebuffer(e,t,i){const r=this._getKey(t,i);let s=this._framebuffers.get(r);const a=this.getColorTexture(t,e);if(this.depthTextureSupported){const t=i?this.getDepthTexture(i,e):void 0;return s?((s.width!==e.width||s.height!==e.height||s.colorTexture!==a||s.depthStencilTexture!==t)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilTexture(t)),s):(s=U(i)?new To(this.rctx,{colorTarget:wn.TEXTURE,depthStencilTarget:On.DEPTH_STENCIL_TEXTURE},a,t):new To(this.rctx,{colorTarget:wn.TEXTURE,depthStencilTarget:On.NONE},a),this._framebuffers.set(r,s),s)}const n=i?this.getDepthBuffer(i,e):void 0;return s?((s.width!==e.width||s.height!==e.height||s.colorTexture!==a)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilBuffer(n)),s):(s=new To(this.rctx,{colorTarget:wn.TEXTURE,depthStencilTarget:i?On.DEPTH_STENCIL_RENDER_BUFFER:On.NONE},a,n),this._framebuffers.set(r,s),s)}_getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}get gpuMemoryUsage(){let e=0;const t=new Set,i=i=>{t.has(i)||(t.add(i),e+=zo(i))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),e}}class wE{constructor(e,t){this._rctx=e,this._compositingHelper=t,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i=e.type===ju.WEBGL2;this._renderTargetHelper=new xE(e);const r=this._renderTargetHelper;this.mainColorTargets=[r.registerColorTarget({name:"mainColorTarget0"}),r.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=r.registerColorTarget({name:"frontFaceTarget"});const s=e=>r.registerColorTarget({name:e,dataType:Sn.FLOAT,internalFormat:i?In.RGBA32F:Cn.RGBA,samplingMode:Rn.NEAREST});this.colorFloatTarget=s("colorFloatTarget"),this.alphaFloatTarget=s("alphaFloatTarget"),this.mainDepth=r.registerDepthTarget({name:"mainDepth"}),this.linearDepth=r.registerColorTarget({name:"linearDepth",samplingMode:Rn.NEAREST}),this.terrainLinearDepth=r.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=r.registerColorTarget({name:"geometryLinearDepth"}),this.normal=r.registerColorTarget({name:"normal"}),this.highlight=r.registerColorTarget({name:"highlight",internalFormat:i?In.RGBA4:Cn.RGBA,dataType:Sn.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=r.registerColorTarget({name:"hudVisibility",internalFormat:i?In.RGBA4:Cn.RGBA,dataType:Sn.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=r.registerColorTarget({name:"tmpColor"}),this.tmpDepth=r.registerDepthTarget({name:"tmpDepth"}),this.hudColor=r.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this.mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this.mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,t)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._mainColorTarget=0===this._mainColorTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const t=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const i=this._background.color;t.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),t.clearSafe(Mn.COLOR_BUFFER_BIT|Mn.DEPTH_BUFFER_BIT|Mn.STENCIL_BUFFER_BIT)}composite(e){U(this.colorTexture)&&this._compositingHelper.composite(e,this.colorTexture,Da.None)}renderTmpAndCompositeToMain(e,t,i,r=!1){this.renderToTargets(e,this.tmpColor,r?this.tmpDepth:this.mainDepth,TE),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),i)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,CE)}compositeTransparentTerrainOntoHUDVisibility(e){this.renderToTargets((()=>this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),Da.None,1,Ea.TransparentToHUDVisibility)),this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,i){let r,s;switch(t){case bd.Color:r=this.colorFloatTarget,s=[0,0,0,0];break;case bd.Alpha:r=this.alphaFloatTarget,s=[1,1,1,1];break;case bd.FrontFace:r=this.frontFaceTarget,s=[0,0,0,0]}i?this.renderToTargets(e,r,this.tmpDepth,s,!0,!0):this.renderToTargets(e,r,this.mainDepth,s,!1)}compositeTransparentTerrainOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),Da.PremultipliedAlpha)}compositeOccludedOntoMain(e,t){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),Da.PremultipliedAlpha,t)}compositeTransparentOntoOpaque(e,t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(Mn.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,i,r,s=!1,a=!1){const n=this._rctx,o=this.bindTarget(t,i);let l=0;if(r){const e=1e-13,t=Math.max(e,r[3]);n.setClearColor(r[0],r[1],r[2],t),l|=Mn.COLOR_BUFFER_BIT}return s&&(l|=Mn.DEPTH_BUFFER_BIT),!1===a?a=0:(!0===a&&(a=255),l|=Mn.STENCIL_BUFFER_BIT),l&&n.clearSafe(l,a),e(),n.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),o}bindTarget(e,t){const i=this._renderTargetHelper.getFramebuffer(this._dimensions,e,t);return this._rctx.bindFramebuffer(i),i}_getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}const TE=[0,0,0,0],CE=[0,1,0,1];class SE{constructor(e){this.context=e,this._renderPlugins=new le,this.slots=[];for(let e=0;e<Zo.MAX_SLOTS;++e)this.slots[e]=[]}add(e,t,i){const r=()=>{if(i?.aborted)throw t.uninitializeRenderContext(),h();this._renderPlugins.push(t);for(const i of e)this.slots[i].push(t);this.context.requestRender()},s=t.initializeRenderContext(this.context,i);if(_(s))return s.then(r);r()}remove(e){if(null!=this._renderPlugins.removeUnordered(e)){for(let t=0;t<this.slots.length;++t)this.slots[t]=this.slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this.context.requestRender()}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>{i.updateAnimation&&(t=i.updateAnimation(e)||t)})),t}render(){const e=this.slots[this.context.renderContext.bindParameters.slot],t=new Array;e.filter((e=>{if(!e.canRender)return!1;if(function(e){return"prepareTechnique"in e}(e)){const i=e.prepareTechnique(this.context.renderContext);return!!i&&(t.push(i),!0)}return t.push(null),!0})).forEach(((e,i)=>e.render(this.context.renderContext,t[i])))}queryDepthRange(e){const t=PE;return t.near=1/0,t.far=-1/0,this._renderPlugins.forAll((i=>{if(i.queryDepthRange){const r=i.queryDepthRange(e);r&&PO(t,r,t)}})),t}get needsTransparentPass(){return this._renderPlugins.some((e=>e.needsTransparentPass))}get needsHighlight(){return this._renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this._renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this.slots[Zo.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|t.renderOccludedFlags),0)}}const PE={near:0,far:0};class RE extends _s{}const AE=zr(),OE=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:RE,shadowCastMaxSamples:255,build:function(){const e=new ws,t=e.fragment;return t.include(Is),t.include(Ss),e.include(rn),e.include(Ka),e.include(ps,{receiveShadows:!0}),t.uniforms.add([new Ns("depthMap",(e=>e.linearDepthTexture)),new Ts("inverseViewMatrix",((e,t)=>Ar(AE,Fr(AE,t.camera.viewMatrix,t.camera.center)))),new Ps("nearFar",((e,t)=>t.camera.nearFar))]),t.constants.add("sampleValue","float",.00392156862745098),t.code.add(an`void main(void) {
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
gl_FragColor = vec4(sampleValue);
}`),e}},Symbol.toStringTag,{value:"Module"})),ME=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new ws,i=t.fragment;i.include(Is),i.include(Ss),t.include(rn),t.include(Ka);const{visualization:r,bandsEnabled:s}=e;i.constants.add("inverseSampleValue","float",255),i.uniforms.add([new Ns("shadowCastMap",(e=>e.shadowCastMap)),new Vs("sampleScale",(e=>e.sampleScale)),new Vs("opacityFromElevation",(e=>e.opacityFromElevation)),new Fs("uColor",(e=>e.color))]);const a=r===el.Gradient,n=r===el.Threshold;return a&&s?i.uniforms.add(new Vs("bandSize",(e=>e.bandSize))):n&&i.uniforms.add(new Vs("threshold",(e=>e.threshold))),i.code.add(an`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;
        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${n?an`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${a&&s?an`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${a?an`* strength`:""});
      }
    `),t}},Symbol.toStringTag,{value:"Module"}));class EE extends As{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){const t=EE.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:kn,colorWrite:Vn,depthTest:null,depthWrite:null})}get primitiveType(){return xn.TRIANGLE_STRIP}}EE.shader=new Rs(ME,(()=>Promise.resolve().then((()=>ME))));const DE=cr(.01,0,.25,1);let IE=class extends N{constructor(e,t,i,r){super({}),this._techniqueRepository=e,this._rctx=t,this._shadowAccumulator=i,this._requestRender=r,this._passParameters={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:DE,threshold:.5,bandSize:.1,opacityFromElevation:1,__tagStrict:"NoParameters"},this._techniqueConfig=new tl,this._enabled=!1,this._vao=Ms(t),this._techniqueConfig.visualization=el.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=B(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null}get visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(EE,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._isRenderingVisualization)return;this._passParameters.sampleScale=1/this._computedSamples;const t=this.visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,this._passParameters,e),this._rctx.drawArrays(t.primitiveType,0,Lo(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>.001953125}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;wt(e,t)||(ct(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};e([ve()],IE.prototype,"opacityFromElevation",null),IE=e([xe("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],IE);class LE extends As{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){const t=LE.shader.get().build();return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Fn(vn.ONE,vn.ONE,vn.ONE,vn.ONE),colorWrite:Vn,depthTest:null,depthWrite:null})}get primitiveType(){return xn.TRIANGLE_STRIP}}var NE;LE.shader=new Rs(OE,(()=>Promise.resolve().then((()=>OE))));let FE=NE=class extends N{constructor(e,t,i,r,s,a){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=a,this._progress=0,this._sampleCount=0,this._passParameters=new RE,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=AO,this._previewing=!1,this._handles=new lr,this._cameraForcedForScreenshot=!1,this._bindParameters=new ma(new La(e,i.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._bindParameters.camera=new ql,this._vao=Ms(e);const n={colorTarget:wn.TEXTURE,depthStencilTarget:On.NONE,width:0,height:0},o={target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,samplingMode:Rn.LINEAR,wrapMode:Pn.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new To(e,n,o),this._accumulationRenderer=new IE(t,e,this,a);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(So.SHADOW_ACCUMULATOR,this)),this._handles.add(K((()=>i.renderView),(e=>{this._handles.remove(NE.renderViewHandleKey),z(e)||this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),NE.renderViewHandleKey)}),J))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(z(this._accumulationTechnique)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechnique=new LE(e,new Qn)}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get canAccumulate(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==AO&&this._opacityFromElevation>.001953125}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(S(t,e,Ve))return;const i=e.length;t.length=i,this._sampleCount=Math.min(255,i);for(let r=0;r<i;++r){const i=e[r],s=t[r]||Oe();De(s,i),t[r]=s}this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,r){if(this._passParameters.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(NE.previewSamples,this._sampleCount-this._progress);for(let e=0;e<s;++e)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(e){this._accumulationRenderer.render(e)}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=B(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=B(this._fbo),this._vao=B(this._vao),this._accumulationTechnique=q(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){void 0!==e.enabled&&(this.enabled=e.enabled),void 0!==e.previewing&&(this.previewing=e.previewing),void 0!==e.lightDirections&&(this.lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}set previewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}set lightDirections(e){this._lightDirections=e}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=VE;return this._fbo.readPixels(e,t,1,1,Cn.RGBA,Sn.UNSIGNED_BYTE,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Mn.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress];this._renderToShadowMap(this._bindParameters,e,this._depthRange),this._passParameters.origin=this._bindParameters.camera.center,this._rctx.bindFramebuffer(this._fbo);const t=this.accumulationTechnique;this._rctx.bindTechnique(t,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,Lo(this._vao,"geometry")),this._progress++}_updateCamera(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Le(4e4,5e4,e.relativeElevation))}set enabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};FE.previewSamples=6,FE.renderViewHandleKey="renderView",e([ve()],FE.prototype,"_progress",void 0),e([ve()],FE.prototype,"_sampleCount",void 0),e([ve()],FE.prototype,"_enabled",void 0),e([ve()],FE.prototype,"_depthRange",void 0),e([ve()],FE.prototype,"_previewing",void 0),e([ve()],FE.prototype,"_accumulationRenderer",void 0),e([ve()],FE.prototype,"_isRefining",null),e([ve()],FE.prototype,"_isActive",null),e([ve()],FE.prototype,"canAccumulate",null),e([ve()],FE.prototype,"_isDoneAccumulating",null),e([ve()],FE.prototype,"_opacityFromElevation",null),e([ve()],FE.prototype,"running",null),FE=NE=e([xe("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],FE);const VE=new Uint8Array(4),UE=zr(),zE=Oe(),jE=Sr(),kE=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new ws;e.include(rs,{receiveShadows:!0});const t=e.fragment;return t.include(Is),t.include(Ss),e.include(rn),e.include(Ka),t.uniforms.add([new Ns("defaultDepthTex",((e,t)=>t.shadowMap.getSnapshot(Na.Default))),new Ns("highlightDepthTex",((e,t)=>t.shadowMap.getSnapshot(Na.Highlight))),new Ns("depthMap",((e,t)=>t.linearDepthTexture)),new Ns("highlightMap",((e,t)=>t.highlightColorTexture)),new Fs("uColor",(e=>e.shadowColor)),new Ps("nearFar",((e,t)=>t.camera.nearFar)),new Vs("opacity",(e=>e.shadowOpacity)),new Vs("occludedOpacity",(e=>e.occludedShadowOpacity)),new Vs("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new Cs("lightingMainDirectionView",((e,t)=>Fe(zE,Qe(zE,t.lighting.lightingMainDirection,t.camera.viewInverseTransposeMatrix)))),new Ps("texelSize",((e,t)=>U(t.linearDepthTexture)?xr(jE,1/t.linearDepthTexture.descriptor.width,1/t.linearDepthTexture.descriptor.height):Pr)),new Ts("inverseViewMatrix",((e,t)=>Ar(UE,Fr(UE,t.camera.viewMatrix,t.camera.center))))]),t.constants.add("unoccludedHighlightFlag","vec4",sa).add("highlightedThreshold","float",.99999).add("selfShadowThreshold","float",.025),t.code.add(an`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),t.code.add(an`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
gl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),e}},Symbol.toStringTag,{value:"Module"}));class GE extends on{constructor(){super(...arguments),this.shadowColor=cr(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class qE extends As{constructor(e){super(e,null,(()=>this.destroy()))}initializeProgram(e){const t=qE.shader.get().build();return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({blending:Fn(vn.SRC_ALPHA,vn.ONE,vn.ONE_MINUS_SRC_ALPHA,vn.ONE_MINUS_SRC_ALPHA),colorWrite:Vn,depthTest:null,depthWrite:null})}get primitiveType(){return xn.TRIANGLE_STRIP}}qE.shader=new Rs(kE,(()=>Promise.resolve().then((()=>kE))));class BE{constructor(e,t){this._rctx=e,this._viewingMode=t,this._maxOpacity=1,this._passParameters=new GE,this._drawParameters=new _s,this._vao=Ms(this._rctx)}get technique(){return z(this._technique)&&(this._technique=new qE({rctx:this._rctx,viewingMode:this._viewingMode})),this._technique}render(e,t){if(!e.shadowMap.enabled||!e.linearDepthTexture||!this.isVisible)return;const i=this.technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(t),this._rctx.bindTechnique(i,this._passParameters,e).bindDraw(this._drawParameters,e),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,Lo(this._vao,"geometry"))}get gpuMemoryUsage(){return this._vao?.size??0}setDefaultOptions(e){this._passParameters={...this._passParameters,...e},this._updateMaxOpacity()}updateParameters(e,t){this._passParameters.opacityElevation=1-Le(4e4,5e4,e.relativeElevation);const i=this._viewingMode===Gi.Global?Fe(HE,e.center):Me(HE,0,0,1),r=je(i,t);this._passParameters.dayNightTerminator=Le(0,1,Se(30*r,0,1))}dispose(){this._vao=B(this._vao),this._technique=q(this._technique)}get isVisible(){const{opacityElevation:e,dayNightTerminator:t}=this._passParameters;return this._maxOpacity*e*t>=.001953125}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}}const HE=Oe(),WE=ni();class QE{constructor(){this._plane=ni()}get isEnabled(){return!hi(this.plane,WE)}get plane(){return this._plane}set plane(e){oi(e||WE,this._plane)}}var ZE;!function(e){e[e.EdgeDetector=0]="EdgeDetector",e[e.BlendWeight=1]="BlendWeight",e[e.Blur=2]="Blur",e[e.COUNT=3]="COUNT"}(ZE||(ZE={}));class XE extends Qn{constructor(){super(...arguments),this.output=ZE.EdgeDetector}}e([Wn({count:ZE.COUNT})],XE.prototype,"output",void 0);const YE=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new ws;return e.output===ZE.EdgeDetector&&(t.attributes.add(yn.POSITION,"vec2"),t.vertex.uniforms.add(new Xa("resolution")),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.vertex.code.add(an`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),t.fragment.uniforms.add(new Ya("tColor")),t.fragment.code.add(an`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${an.float(.05)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${an.float(2)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),e.output===ZE.BlendWeight&&(t.attributes.add(yn.POSITION,"vec2"),t.vertex.uniforms.add(new Xa("resolution")),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.varyings.add("fPixCoord","vec2"),t.vertex.code.add(an`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * resolution.zw;
        fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${an.int(8)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),t.fragment.uniforms.add(new Ya("tEdges")),t.fragment.uniforms.add(new Ya("tArea")),t.fragment.uniforms.add(new Ya("tSearch")),t.fragment.uniforms.add(new Ya("tColor")),t.fragment.uniforms.add(new Xa("resolution")),t.fragment.code.add(an`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D texture, vec2 coord, vec2 offset) {
        return texture2D(texture, coord + offset.x * resolution.xy, 0.0);
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${an.int(8)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${an.int(8)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${an.int(8)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${an.int(8)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${an.int(16)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * resolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * resolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),e.output===ZE.Blur&&(t.attributes.add(yn.POSITION,"vec2"),t.vertex.uniforms.add(new Xa("resolution")),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[2]","vec4"),t.vertex.code.add(an`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),t.fragment.uniforms.add(new Ya("tBlendWeights")),t.fragment.uniforms.add(new Ya("tColor")),t.fragment.uniforms.add(new Xa("resolution")),t.fragment.code.add(an`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * resolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),t}},Symbol.toStringTag,{value:"Module"}));class KE extends As{initializeProgram(e){const t=KE.shader.get().build(this.configuration);return new Os(e.rctx,t,nn)}initializePipeline(){return Nn({colorWrite:Vn})}}KE.shader=new Rs(YE,(()=>Promise.resolve().then((()=>YE))));let $E=class extends N{constructor(e,t){super({}),this.rctx=e,this._techniqueRep=t,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=G(this._abortController),this.disable()}_loadResources(e){if(U(this._abortController))return!1;if(U(this._searchTexture))return!0;this._abortController=new AbortController;const t=this._abortController.signal;return import("../chunks/SmaaRenderPassData.js").then((e=>this._loadTextures(e,t))).then((()=>e())).finally((()=>this._abortController=null)),!1}_loadTextures(e,t){return p(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,Rn.LINEAR,Cn.RGB),this._loadTextureFromBase64(e.searchTexure,Rn.NEAREST,Cn.LUMINANCE)]).then((([e,i])=>{d(t)?(e.dispose(),i.dispose(),p(t)):(this._areaTexture=e,this._searchTexture=i)}))}get updating(){return U(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const e=new XE,t=(e,t)=>this._techniqueRep.releaseAndAcquire(KE,e,t);e.output=ZE.EdgeDetector,this._edgeDetectTechnique=t(e,this._edgeDetectTechnique),e.output=ZE.BlendWeight,this._blendWeightsTechnique=t(e,this._blendWeightsTechnique),e.output=ZE.Blur,this._blurTechnique=t(e,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=aa(this.rctx),this._edges=new To(this.rctx,{colorTarget:wn.TEXTURE,depthStencilTarget:On.NONE},{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGB,dataType:Sn.UNSIGNED_BYTE,samplingMode:Rn.LINEAR,wrapMode:Pn.CLAMP_TO_EDGE,width:4,height:4}),this._blend=new To(this.rctx,{colorTarget:wn.TEXTURE,depthStencilTarget:On.NONE},{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,samplingMode:Rn.LINEAR,wrapMode:Pn.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=B(this._vao),this._areaTexture=B(this._areaTexture),this._searchTexture=B(this._searchTexture),this._blend=B(this._blend),this._edges=B(this._edges),this._isEnabled=!1)}render(e){if(!this._isEnabled)return;const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.descriptor.width,height:e.descriptor.height};t.bindVAO(this._vao),t.setViewport(r.x,r.y,r.width,r.height),this._edges.resize(r.width,r.height),t.bindFramebuffer(this._edges),t.setClearColor(0,0,0,1),t.clear(Mn.COLOR_BUFFER_BIT);const s=t.bindTechnique(this._edgeDetectTechnique);s.bindTexture("tColor",e),s.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(xn.TRIANGLES,0,3),this._blend.resize(r.width,r.height),t.bindFramebuffer(this._blend),t.setClearColor(0,0,1,1),t.clear(Mn.COLOR_BUFFER_BIT);const a=t.bindTechnique(this._blendWeightsTechnique);a.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),a.bindTexture("tSearch",this._searchTexture),a.bindTexture("tArea",this._areaTexture),a.bindTexture("tEdges",this._edges.colorTexture),t.drawArrays(xn.TRIANGLES,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(Mn.COLOR_BUFFER_BIT);const n=t.bindTechnique(this._blurTechnique);n.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),n.bindTexture("tColor",e),n.bindTexture("tBlendWeights",this._blend.colorTexture),t.drawArrays(xn.TRIANGLES,0,3)}_loadTextureFromBase64(e,t,i){return Mo(e).then((e=>new jo(this.rctx,{pixelFormat:i,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.CLAMP_TO_EDGE,width:e.width,height:e.height,samplingMode:t},e)))}};e([ve()],$E.prototype,"_abortController",void 0),e([ve({readOnly:!0})],$E.prototype,"updating",null),$E=e([xe("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],$E);class JE{constructor(e){this.factory=e,this.originData=new Map}acquire(e){return this.register(this.factory.getOrigin(e))}register(e){const t=this.originData.get(e.id);return t?(t.refCount++,t.origin):(this.originData.set(e.id,{refCount:1,viewMatrix:zr(),origin:e}),e)}release(e){const t=this.originData.get(e.id);t&&(t.refCount--,0===t.refCount&&this.originData.delete(e.id))}updateViewMatrices(e){this.originData.forEach((t=>{Er(t.viewMatrix,e),function(e,t){const i=t,r=e[0],s=e[1],a=e[2];i[12]+=r*i[0]+s*i[4]+a*i[8],i[13]+=r*i[1]+s*i[5]+a*i[9],i[14]+=r*i[2]+s*i[6]+a*i[10],i[14]+=r*i[3]+s*i[7]+a*i[11]}(t.origin.vec3,t.viewMatrix)}))}getViewMatrix(e){return this.originData.get(e.id).viewMatrix}}class eD extends ys{constructor(e,t,i){super(),this.distanceFalloffFactor=e,this.minimumEdgeLength=t,this.transparency=i,this.transformNormalViewFromGlobal=xo()}}class tD extends vs{constructor(){super(...arguments),this.transformNormalViewFromGlobal=xo(),this.slicePlaneLocalOrigin=Oe(),this.transformNormalGlobalFromModel=xo()}}function iD(e){const t=an`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}const rD=Rr(.5,-4e-4);function sD(e,t){const i=e.vertex;i.include(iD),i.constants.add("depthBias","vec2",rD),i.uniforms.add(new Ps("inverseViewport",((e,t)=>t.inverseViewport))),t.legacy?(i.uniforms.add(new Xr("localView")),i.uniforms.add(new Ts("proj",((e,t)=>t.camera.projectionMatrix))),i.code.add(an`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(i.uniforms.add(new bs("transformNormalViewFromGlobal",(e=>e.transformNormalViewFromGlobal))),i.uniforms.add(new Ts("transformProjFromView",(e=>e.transformProjFromView))),i.code.add(an`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),i.code.add(an`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function aD(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(an`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(an`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function nD(e,t){const i=e.vertex;t.silhouette?(i.code.add(an`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(an`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(an`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(an`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function oD(e,t){const i=e.vertex;i.include(Is),i.uniforms.add(new Vs("distanceFalloffFactor",(e=>e.distanceFalloffFactor))),i.code.add(an`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add(new Ya("componentDataTex")),i.uniforms.add(new la("componentDataTexInvDim")),e.attributes.add(yn.COMPONENTINDEX,"float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentVerticalOffsetFieldOffset","float",2),i.constants.add("componentFieldCount","float",3),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.constants.add("verticalOffsetScale","float",858993.4592),i.code.add(an`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * componentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
float verticalOffset;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);
vec4 colorValue = texture2D(componentDataTex, colorIndex);
vec4 otherValue = texture2D(componentDataTex, otherIndex);
float verticalOffset = (rgba2float(texture2D(componentDataTex, verticalOffsetIndex)) - 0.5) * verticalOffsetScale;
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5,
verticalOffset
);
}`),t.legacy?i.code.add(an`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add(new Zr("transformNormalGlobalFromModel",(e=>e.transformNormalGlobalFromModel))),i.code.add(an`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add(yn.NORMALA,"vec3"),e.attributes.add(yn.NORMALB,"vec3"),i.code.add(an`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(e.attributes.add(yn.NORMAL,"vec3"),i.code.add(an`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),t.legacy?i.code.add(an`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(i.include(xs,t),i.include(xs,t),i.uniforms.add([new bs("transformViewFromCameraRelativeRS",(e=>e.transformViewFromCameraRelativeRS)),new Zr("transformWorldFromModelRS",(e=>e.transformWorldFromModelRS)),new qs("transformWorldFromModelTL",(e=>e.transformWorldFromModelTL)),new qs("transformWorldFromModelTH",(e=>e.transformWorldFromModelTH)),new Cs("transformWorldFromViewTL",(e=>e.transformWorldFromViewTL)),new Cs("transformWorldFromViewTH",(e=>e.transformWorldFromViewTH))]),i.code.add(an`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${t.spherical?an`normalize(transformWorldFromModelTL + rotatedModelPosition);`:an`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),i.uniforms.add(new Ts("transformProjFromView",((e,t)=>t.camera.projectionMatrix))),i.code.add(an`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),i.code.add(an`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function lD(e){return e.mode===hD.SKETCH||e.mode===hD.MIXED}var hD;function cD(e,t){const i=e.vertex;switch(t.mode){case hD.SKETCH:i.code.add(an`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case hD.MIXED:i.code.add(an`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case hD.SOLID:i.code.add(an`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function dD(e,t){const i=e.vertex;switch(e.attributes.add(yn.SIDENESS,"vec2"),t.mode===hD.MIXED?i.code.add(an`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(an`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case hD.MIXED:i.code.add(an`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case hD.SKETCH:i.code.add(an`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case hD.SOLID:i.code.add(an`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case hD.COUNT:break;default:Gl(t.mode)}}function uD(e,t){const i=e.vertex;switch(e.include(dD,t),lD(t)&&i.uniforms.add(new Za("strokesAmplitude")),t.mode){case hD.SOLID:i.code.add(an`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case hD.SKETCH:i.code.add(an`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case hD.MIXED:i.code.add(an`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function pD(e,t){const i=e.vertex;e.include(dD,t);const r=e.fragment;switch(lD(t)&&(i.uniforms.add(new la("strokesTextureScale")),i.uniforms.add(new Za("strokesLog2Resolution")),i.uniforms.add(new Za("strokeVariants")),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add(new Ya("strokesTexture")),r.uniforms.add(new Za("strokesNormalizationScale")),i.code.add(an`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * strokesTextureScale;
vStrokeUV.x += variantOffset;
}`),e.fragment.include(Is),r.code.add(an`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case hD.SOLID:i.code.add(an`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(an`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case hD.SKETCH:i.code.add(an`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(an`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case hD.MIXED:e.varyings.add("vType","float"),i.code.add(an`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(an`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"}(hD||(hD={}));const mD=Sr(),gD=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new ws,i=t.vertex,r=t.fragment;return e.legacy&&i.uniforms.add(new Xr("model")),e.antialiasing&&(i.code.add(an`#define ANTIALIASING 1`),r.code.add(an`#define ANTIALIASING 1`)),t.include(sD,e),t.include(oD,e),t.include(uD,e),t.include(dD,e),t.include(pD,e),t.include(Hs,e),t.include(nD,e),t.include(aD,e),t.include(cD,e),t.include($s,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add(new Ps("pixelToNDC",((e,t)=>xr(mD,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3])))),i.uniforms.add(new Fs("viewport",((e,t)=>t.camera.fullViewport))),i.uniforms.add(new Vs("pixelRatio",((e,t)=>t.camera.pixelRatio))),t.attributes.add(yn.POSITION0,"vec3"),t.attributes.add(yn.POSITION1,"vec3"),t.attributes.add(yn.VARIANTOFFSET,"float"),t.attributes.add(yn.VARIANTSTROKE,"float"),t.attributes.add(yn.VARIANTEXTENSION,"float"),i.code.add(an`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 ndcToPixel = viewport.zw * 0.5;
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),t.fragment.code.add(an`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class fD extends As{initializeProgram(e){const t=fD.shader.get().build(this.configuration);return new Os(e.rctx,t,Eu)}initializePipeline(e){return e.blendMinMax?Nn({blending:Fn(vn.ONE,vn.ONE,vn.ZERO,vn.ONE,Ln.ADD,e.blendMinMax.MAX),depthTest:{func:bn.LEQUAL},colorWrite:Vn}):Nn({depthTest:{func:bn.LEQUAL},depthWrite:jn,colorWrite:Vn})}}fD.shader=new Rs(gD,(()=>Promise.resolve().then((()=>gD))));class _D extends Xs{constructor(){super(...arguments),this.mode=hD.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.spherical=!1}}e([Wn({count:hD.COUNT})],_D.prototype,"mode",void 0),e([Wn()],_D.prototype,"hasSlicePlane",void 0),e([Wn()],_D.prototype,"silhouette",void 0),e([Wn()],_D.prototype,"legacy",void 0),e([Wn()],_D.prototype,"antialiasing",void 0),e([Wn()],_D.prototype,"doublePrecisionRequiresObfuscation",void 0),e([Wn()],_D.prototype,"hasMultipassTerrain",void 0),e([Wn()],_D.prototype,"cullAboveGround",void 0),e([Wn()],_D.prototype,"spherical",void 0);const yD={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0};class vD{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const bD={solid:hD.SOLID,sketch:hD.SKETCH,uber:hD.MIXED};class xD{constructor(e,t,i){this.rctx=e,this.shaderTechniqueRepository=t,this._configuration=new _D,this.refCount=new vD,this.renderables=new Set,this.sortedRenderables={[wl.TRANSPARENT]:{[wl.TRANSPARENT]:new le,[wl.OPAQUE]:new le},[wl.OPAQUE]:{[wl.TRANSPARENT]:new le,[wl.OPAQUE]:new le}},this._renderablesDirty=!1,this._drawParameters=new tD,this._settings={...yD,...i},this.key=xD.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const r=this._settings.strokesTexture.variants;this.writerSettings={variants:r,reducedPrecision:fa.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=bD[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this.rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=ms(e),this._configuration.spherical=i.spherical}dispose(){this._technique=q(this._technique)}addRenderable(e){this.renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,t){this._renderablesDirty&&this._sortRenderables(),this.sortedRenderables[t][wl.TRANSPARENT].forAll(e),this.sortedRenderables[t][wl.OPAQUE].forAll(e)}updateTechnique(e,t){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this.shaderTechniqueRepository.releaseAndAcquire(fD,this._configuration,this._technique),this._technique}bindRegularEdges(e,t){return this.rctx.bindTechnique(this.updateTechnique(t,!1),e,t)}bindSilhouetteEdges(e,t){return this.rctx.bindTechnique(this.updateTechnique(t,!0),e,t)}renderRegularEdges(e,t,i,r,s){this._render(e,t,t.regular.vao,i,r,s)}renderSilhouetteEdges(e,t,i,r,s){this._render(e,t,t.silhouette.vao,i,r,s)}_render(e,t,i,r,s,a){this._bindDraw(e,t,r,a),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(xn.TRIANGLE_FAN,0,4,s)}_bindDraw(e,t,i,r){if(t.components.buffer.textureBuffer.bind(e,wD,TD),"origin"in t.transform)e.setUniformMatrix4fv("localView",r),e.setUniformMatrix4fv("model",t.transform.modelMatrix),De(this._drawParameters.slicePlaneLocalOrigin,t.transform.origin.vec3);else{const e=new _M(t.transform.position),r=co(CD,mo(CD,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=r;const s=i.camera.viewInverseTransposeMatrix;Me(this._drawParameters.slicePlaneLocalOrigin,s[3],s[7],s[11])}e.bindDraw(this._drawParameters,i),"uber"!==this._settings.type&&"sketch"!==this._settings.type||this._setSketchUniforms(e)}_setSketchUniforms(e){const t=this._settings.strokesTexture,i=t.texture;z(i)||(e.bindTexture("strokesTexture",i),e.setUniform2f("strokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),e.setUniform1f("strokesLog2Resolution",Math.log2(t.resolution)),e.setUniform1f("strokesNormalizationScale",t.normalizationScale),e.setUniform1f("strokesAmplitude",t.amplitude),e.setUniform1f("strokeVariants",t.variants))}_sortRenderables(){this._renderablesDirty=!1,this.sortedRenderables[wl.TRANSPARENT][wl.TRANSPARENT].clear(),this.sortedRenderables[wl.TRANSPARENT][wl.OPAQUE].clear(),this.sortedRenderables[wl.OPAQUE][wl.TRANSPARENT].clear(),this.sortedRenderables[wl.OPAQUE][wl.OPAQUE].clear(),this.renderables.forEach((e=>{e.objectTransparency!==wl.INVISIBLE&&e.edgeTransparency!==wl.INVISIBLE&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[wl.TRANSPARENT][wl.TRANSPARENT].sort(e),this.sortedRenderables[wl.TRANSPARENT][wl.OPAQUE].sort(e),this.sortedRenderables[wl.OPAQUE][wl.TRANSPARENT].sort(e),this.sortedRenderables[wl.OPAQUE][wl.OPAQUE].sort(e)}static getKey(e,t,i){return`edges-t:${e}:${t}:${i}`}}const wD="componentDataTex",TD="componentDataTexInvDim",CD=pu();class SD extends Gu{constructor(e){super("EdgeProcessingWorker","extract",{extract:e=>[e.dataBuffer],extractComponentsEdgeLocations:e=>[e.dataBuffer],extractEdgeLocations:e=>[e.dataBuffer]},e)}async process(e,t,i){if(i)return Du(e);const r=this._packInput(e),s=await this.invoke(r,t);return this._unpackOutput(s)}async extractEdgeLocations(e,t){const i=this._packInput(e),r=await this.invokeMethod("extractEdgeLocations",i,t);return Iu(r)}async extractComponentsEdgeLocations(e,t){const i=this._packInput(e),r=await this.invokeMethod("extractComponentsEdgeLocations",i,t);return Iu(r)}_packInput(e){return{dataBuffer:e.data.buffer,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate,indicesBuffer:e.indices.buffer,indicesType:I(e.indices)?"Uint32Array":"Uint16Array",indicesLength:e.indicesLength}}_unpackOutput(e){return{regular:{instancesData:Iu(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:Iu(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}function PD(e,t){if(!e)return null;const i=e.length/2,r=AD*i,s=new Array(i);let a=0;const n=t===RD.PRESSURE;for(let t=0;t<e.length;t+=2){const i=(e[t]+e[t+1])/2;s[a++]=n?Math.min(r,1-(1-i)*OD):Math.min(r,i*OD)}return s}var RD;!function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"}(RD||(RD={}));const AD=.1,OD=.5;class MD{constructor(e,t,i,r,s){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=r,this.texture=s}dispose(){this.texture=B(this.texture)}}const ED=[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}];function DD(e){let t=null;for(const i of e){const e=i.type;if(FD(i))if(z(t))t=e;else if(t!==e)return"uber"}return U(t)?t:"uber"}function ID(e){let t=wl.INVISIBLE;for(const{material:i}of e)if(ND(i)){if(i.color[3]*i.opacity<1)return wl.TRANSPARENT;t=wl.OPAQUE}return t}function LD(e){let t=wl.INVISIBLE;for(const{material:i}of e)if(ND(i)){switch(i.objectTransparency){case wl.TRANSPARENT:case wl.INVISIBLE:return wl.TRANSPARENT;case wl.OPAQUE:if(i.opacity<1)return wl.TRANSPARENT}t=wl.OPAQUE}return t}function ND(e){return e.size*e.color[3]*e.opacity>0}function FD(e){return e.size*e.color[3]>0}function VD(e,t,i){return e.length-function(e,t){const i=R(e,t,!0);return-1===i?t<e[0]?0:e.length:i}(e,t*i.minimumEdgeLength)}function UD(e,t,i,r){for(let s=0;s<e.length;s++){const a=e[s].index,n=t[s],o=t[s+1];if(r)for(let e=n;e<o;e++){const t=r[e];i.set(t,a)}else for(let e=n;e<o;e++)i.set(e,a)}}const zD=V.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let jD=class extends N{constructor(e){super(e),this.updatingHandles=new Wi,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges={[wl.TRANSPARENT]:0,[wl.OPAQUE]:0},this.gpuMemoryUsage=0,this.workerAbort=new AbortController,this.tmpModelPosition=Oe(),this.localOrigins=new JE(new Aa(e.renderSR))}initialize(){this.worker=new SD(this.schedule),this.componentColorManager=new OM(this.rctx,3);const e=Lu.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=Fo.createVertex(this.rctx,An.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach((e=>this._discardObjectEntry(e))),this.perObjectData.clear(),this.strokesTexture=B(this.strokesTexture),this.componentColorManager=k(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=B(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges[wl.TRANSPARENT]+this.numberOfRenderedEdges[wl.OPAQUE]}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,s,a,n,o){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let l;const h=new kD(new Promise((e=>l=e)),i.center,i.radius);this.perObjectData.set(e,h);const c=await this.updatingHandles.addPromise(this._addComponentGeometry(t,h,r,s,a,n,o));return this.setNeedsRender(),l(),c}async addOrUpdateObject3D(e,t,i,r){if(this.destroyed)return void zD.warn("Attempt to add an object to a destroyed instance");const s=this.perObjectData.get(e);let a;s?.renderables.length>0&&this.perObjectDataEvictionCache.add(s);const n=e.boundingVolumeWorldSpace.bounds,o=new kD(new Promise((e=>a=e)),io(n),so(n));this.perObjectData.set(e,o);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,i=null;for(let r=0;r<e.geometries.length;r++){const s=e.geometryRecords[r];if(s.material.supportsEdges){if(t){if(!S(t,s.transformation))return!1}else t=s.transformation;if(!i&&U(s.origin))i=s;else if(U(i?.origin)&&U(s.origin)&&i.origin.id!==s.origin.id)return!1}}return!0}(e))l.push(this._addObjectMergedGeometries(e,o,t,i,r));else for(let s=0;s<e.geometries.length;s++){const a=e.geometryRecords[s];if(!a.material.supportsEdges)continue;const n=e.geometries[s];l.push(this._addGeometry(e,o,n,a,t[0],i,r))}await this.updatingHandles.addPromise(Promise.all(l)),this.perObjectDataEvictionCache.delete(o),this._discardObjectEntry(s),this.setNeedsRender(),a()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this._removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach((e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=i(r),s=e.components.meta[r],a=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(a,1,3,255*t)}this._updateTransparency(e)})),this.setNeedsRender()}async getObjectMemoryUsage(e){return(await this._getObjectEntry(e)).renderables.reduce(((e,t)=>e+t.statistics.gpuMemoryUsage),0)}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof sn,a=!!i.hasSlicePlane,n=DD(t),o=xD.getKey(n,a,s);(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach((e=>{if(o!==e.rendererKey){const t=this.renderers.get(e.rendererKey),i=this._acquireRenderer(n,a,s);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];r&&this._updateComponentBuffer(e.components),this._updateTransparency(e)})),this.setNeedsRender()}async updateAllVerticalOffsets(e,t){(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach((e=>{const i=e.components.meta;for(let r=0;r<i.length;r++)e.components.meta[r].verticalOffset=t?.[r]??0;this._updateComponentBuffer(e.components)})),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach((e=>e.visible=t)),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";if(await t.loaded,null==t.loaded)throw h();return t}removeAll(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)))}render(e,t){if(this.numberOfRenderedEdges[t]=0,z(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=Oe(),s=new _M;let a=0,n=0;if(this.renderers.forEach((i=>{0===i.refCount.value?(this.renderers.delete(i.key),i.dispose()):i.forEachRenderable((t=>{t.visible&&(a+=t.statistics.averageEdgeLength,n++,t.regular&&i.updateTechnique(e,!1),t.silhouette&&i.updateTechnique(e,!0))}),t)})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),0===n)return;const o=40*a/n,l=e.camera.perScreenPixelRatio,h=new eD(o,l,t);Me(r,i[3],i[7],i[11]),s.set(r),De(h.transformWorldFromViewTH,s.high),De(h.transformWorldFromViewTL,s.low),ho(h.transformViewFromCameraRelativeRS,e.camera.viewMatrix),co(GD,h.transformViewFromCameraRelativeRS),mo(h.transformNormalViewFromGlobal,GD),h.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this.renderers.forEach((t=>{this._renderRegularEdges(t,e,h),this._renderSilhouetteEdges(t,e,h)}))}_updateTransparency(e){const t=ID(e.components.meta),i=LD(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),U(t.origin))this.localOrigins.register(t.origin);else{const e=Me(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(e)}return function(e,t){const i=t,r=-e[0],s=-e[1],a=-e[2],n=i[3],o=i[7],l=i[11],h=i[15];i[0]+=n*r,i[1]+=n*s,i[2]+=n*a,i[4]+=o*r,i[5]+=o*s,i[6]+=o*a,i[8]+=l*r,i[9]+=l*s,i[10]+=l*a,i[12]+=h*r,i[13]+=h*s,i[14]+=h*a}(t.origin.vec3,i),t.origin}_updateComponentBuffer(e){const{meta:t,buffer:i}=e,r=new Uint8Array(4);for(let e=0;e<t.length;e++){const s=t[e].material,a=t[e].index,n=Se(Math.round(8*s.size),0,255),o=Se(s.extensionLength,-128,127)+128,l="solid"===s.type?Nu.SOLID:Nu.SKETCH,h=255*s.opacity,c=s.color,d=255*c[0],u=255*c[1],p=255*c[2],m=255*c[3];i.textureBuffer.setData(a,0,d,u,p,m),i.textureBuffer.setData(a,1,n,o,l,h),tM(t[e].verticalOffset,r),i.textureBuffer.setData(a,2,r[0],r[1],r[2],r[3])}}_createComponentBuffers(e){if(z(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let r=0;r<e.length;r++){const s=e[r],a=i.acquireIndex();t.push({index:a,verticalOffset:0,material:s})}const r={meta:t,buffer:i};return this._updateComponentBuffer(r),r}_extractEdges(e,t,i,r,s,a=s.length){return this.worker.process({data:t,indices:s,indicesLength:a,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}_createEdgeResources(e){const t={};if(z(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new No(this.rctx,Eu,{vertices:Fu,instances:Vu.glLayout},{vertices:this.verticesBufferObject,instances:Fo.createVertex(this.rctx,An.STATIC_DRAW,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new No(this.rctx,Eu,{vertices:Fu,instances:Uu.glLayout},{vertices:this.verticesBufferObject,instances:Fo.createVertex(this.rctx,An.STATIC_DRAW,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async _addGeometry(e,t,i,r,s,a,n){const o=i.vertexAttributes.get(yn.POSITION),l=i.indices.get(yn.POSITION),h=zr(),c={position:o,indices:l,modelTransform:h,origin:this._computeModelTransformWithLocalOrigin(e,r,h)};return this._addPositionData(t,c,i.edgeIndicesLength,s,a,n)}async _addPositionData(e,t,i,r,s,a=!1){if(null==e.loaded)return;const n=this._createComponentBuffers([r]);if(z(n)||i<=0)return;const o=this._acquireRenderer(r.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:h}=t,c=t.indices,d=t.position,u=d.data.length/d.size,p=Mu.createBuffer(u);for(let e=0;e<u;e++)p.position.set(e,0,d.data[e*d.size+0]),p.position.set(e,1,d.data[e*d.size+1]),p.position.set(e,2,d.data[e*d.size+2]);UD(n.meta,[0,p.componentIndex.count],p.componentIndex);const m=await this.updatingHandles.addPromise(this._extractEdges(o.writerSettings,p,!1,a,c,i));if(null==e.loaded)return;const{regular:g,silhouette:f}=this._createEdgeResources(m),_=(g?g.vao.size:0)+(f?f.vao.size:0),y={regular:g,silhouette:f,transform:{modelMatrix:l,origin:h},statistics:{gpuMemoryUsage:_,externalMemoryUsage:!1,averageEdgeLength:m.averageEdgeLength},components:n,visible:!0,edgeTransparency:ID(n.meta),objectTransparency:LD(n.meta),distanceToCamera:0,rendererKey:o.key};e.renderables.push(y),o.addRenderable(y),this.gpuMemoryUsage+=_}async _addComponentGeometry(e,t,i,r,s,a,n){if(null==t.loaded)return 0;const o=this._createComponentBuffers(a);if(z(o))return 0;const l=DD(a),h=this._acquireRenderer(l,n.hasSlicePlane||!1,!1),c=Mu.createBuffer(i.count);mu(c.position,i),UD(o.meta,s,c.componentIndex,r);const d=h.writerSettings,u=await this.updatingHandles.addPromise(this._extractEdges(d,c,!0,!1,r));if(null==t.loaded)return 0;const{regular:p,silhouette:m}=this._createEdgeResources(u),g=(p?p.vao.size:0)+(m?m.vao.size:0),f={regular:p,silhouette:m,transform:e,statistics:{gpuMemoryUsage:g,externalMemoryUsage:!0,averageEdgeLength:u.averageEdgeLength},components:o,visible:!0,edgeTransparency:ID(o.meta),objectTransparency:LD(o.meta),distanceToCamera:0,rendererKey:h.key};return t.renderables.push(f),h.addRenderable(f),g}async _addObjectMergedGeometries(e,t,i,r,s){const a=new Map;let n=0,o=null,l=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t],r=e.geometryRecords[t];if(!r.material.supportsEdges)continue;!o&&r.origin&&(o=r);const s=i.vertexAttributes.get(yn.POSITION);l+=s.data.length/s.size,n+=i.edgeIndicesLength}const h=l>=65536?Uint32Array:Uint16Array,c=n?new h(n):null,d=[];let u=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t];if(!e.geometryRecords[t].material.supportsEdges)continue;const r=i.vertexAttributes.get(yn.POSITION),s=i.indices.get(yn.POSITION);let n=a.get(r.data);if(null==n){n=d.length/3;for(let e=0;e<r.data.length;e+=r.size)d.push(r.data[e+0]),d.push(r.data[e+1]),d.push(r.data[e+2]);a.set(r.data,n)}if(s)for(let e=0;e<i.edgeIndicesLength;e++)c[u++]=n+s[e]}const p=o||e.geometryRecords[0],m=zr(),g=this._computeModelTransformWithLocalOrigin(e,p,m);for(let t=0;t<e.geometryRecords.length;t++)e.geometryRecords[t].origin=g;const f={position:{data:d,size:3},indices:c,modelTransform:m,origin:g};await this.updatingHandles.addPromise(this._addPositionData(t,f,c.length,i[0],r,s))}_acquireRenderer(e,t,i){const r=xD.getKey(e,t,i);let s=this.renderers.get(r);return z(this.strokesTexture)&&(this.strokesTexture=function(e){const t=256,i=new Uint8Array(262144),r=1024,s=Math.log2(t)+1,a=ED.length;let n=(s-1)*a*r;for(const{distance:e,pressure:t}of ED){let o=e,l=t,h=n;for(let e=0;e<s;e++){0!==e&&(o=PD(o,RD.DISTANCE),l=PD(l,RD.PRESSURE));for(let e=0;e<256;e++){const t=.5+(o?o[e%o.length]/16:0),r=l?l[e%l.length]:1;Pu(t,i,h),Pu(r,i,h+131072),h+=4}h-=r*(a+1)}n+=r}const o=new jo(e,{pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:Rn.LINEAR,width:t,height:t,wrapMode:Pn.REPEAT},i);return new MD(t,16,8,a,o)}(this.rctx)),s||(s=new xD(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this.strokesTexture,legacy:i,spherical:this.viewingMode===Gi.Global}),this.renderers.set(r,s)),s.refCount.increment(),s}_removeRenderable(e){var t;(t=e).regular&&(t.regular.vao.vertexBuffers.instances.dispose(),t.regular.vao.dispose(!1),t.regular.vao=null),t.silhouette&&(t.silhouette.vao.vertexBuffers.instances.dispose(),t.silhouette.vao.dispose(!1),t.silhouette.vao=null);const i=this.renderers.get(e.rendererKey);if(i){i.removeRenderable(e),i.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,r=Oe(),s=e=>{const{center:s,radius:a}=e;ht(r,s,t);const n=je(r,i),o=n<-a?1/0:n<a?0:n-a;e.renderables.forEach((e=>e.distanceToCamera=o))};this.perObjectData.forEach(s),this.perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(e,t,i){const r=e.bindRegularEdges(i,t),s=i.transparency;e.forEachRenderable((a=>{if(!a.visible||!a.regular)return;const n=VD(a.regular.lod.lengths,a.distanceToCamera,i),o="origin"in a.transform?this.localOrigins.getViewMatrix(a.transform.origin):kr;e.renderRegularEdges(r,a,t,n,o),this.numberOfRenderedEdges[s]+=n}),s)}_renderSilhouetteEdges(e,t,i){const r=e.bindSilhouetteEdges(i,t),s=i.transparency;e.forEachRenderable((a=>{if(!a.visible||!a.silhouette)return;const n=VD(a.silhouette.lod.lengths,a.distanceToCamera,i),o="origin"in a.transform?this.localOrigins.getViewMatrix(a.transform.origin):kr;e.renderSilhouetteEdges(r,a,t,n,o),this.numberOfRenderedEdges[s]+=n}),s)}};e([ve({constructOnly:!0})],jD.prototype,"rctx",void 0),e([ve({constructOnly:!0})],jD.prototype,"renderSR",void 0),e([ve({constructOnly:!0})],jD.prototype,"viewingMode",void 0),e([ve({constructOnly:!0})],jD.prototype,"techniqueRepository",void 0),e([ve({constructOnly:!0})],jD.prototype,"setNeedsRender",void 0),e([ve({constructOnly:!0})],jD.prototype,"schedule",void 0),e([ve({readOnly:!0})],jD.prototype,"updatingHandles",void 0),e([ve({readOnly:!0})],jD.prototype,"updating",null),jD=e([xe("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],jD);class kD{constructor(e,t,i){this.center=t,this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))}}const GD=xo();class qD{constructor(e){this.timer=e,this.start=e.createQuery(),e.createTimestamp(this.start)}stop(e,t=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this._checkQueryResult(e,t)}_checkQueryResult(e,t){if(!this.timer.resultAvailable(this.end))return void setTimeout((()=>this._checkQueryResult(e,t)),t);if(this.timer.disjoint())return void e(null);const i=this.timer.getResult(this.start),r=this.timer.getResult(this.end);e((r-i)/1e6)}}class BD{constructor(e){this.timer=e,this.query=e.createQuery(),HD=!0,this.timer.beginTimeElapsed(this.query)}stop(e,t=50){this.timer.endTimeElapsed(),HD=!1,this._checkQueryResult(e,t)}_checkQueryResult(e,t){const i=this.timer.resultAvailable(this.query),r=this.timer.disjoint();if(!i||r)r?e(null):setTimeout((()=>this._checkQueryResult(e,t)),t);else{const t=this.timer.getResult(this.query);e(t/1e6)}}}let HD=!1;var WD;!function(e){e[e.Prepare=0]="Prepare",e[e.Shadowmap=1]="Shadowmap",e[e.Lineardepth=2]="Lineardepth",e[e.Normals=3]="Normals",e[e.SSAO=4]="SSAO",e[e.Opaque=5]="Opaque",e[e.OpaqueEdges=6]="OpaqueEdges",e[e.Transparent=7]="Transparent",e[e.TransparentEdges=8]="TransparentEdges",e[e.Hudvisibility=9]="Hudvisibility",e[e.TransparentTerrain=10]="TransparentTerrain",e[e.Atmosphere=11]="Atmosphere",e[e.Laserline=12]="Laserline",e[e.Occluded=13]="Occluded",e[e.Antialiasing=14]="Antialiasing",e[e.Highlights=15]="Highlights",e[e.HudOccluded=16]="HudOccluded",e[e.HudNotoccluded=17]="HudNotoccluded"}(WD||(WD={}));const QD=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class ZD extends ce{constructor(){super("total"),this.total=0,this.frameCount=0}}class XD{constructor(){this._startTime=ae(0),this._lastSample=ae(0),this._enableGPUTimer=0,this.totalTime=new ZD,this.gpuTime=new ce("gpu",9),this.renderPassTimings=QD.map((e=>new ce(e)))}get elapsedTime(){return ae(performance.now()-this._startTime)}enableGPUTimer(){return++this._enableGPUTimer,{remove:qu((()=>--this._enableGPUTimer))}}prerender(e){this._startTime=this._lastSample=ae(performance.now()),this._enableGPUTimer&&(this._gpuTimer=function(e){const t=e.capabilities.disjointTimerQuery;return z(t)?null:t.timestampBits()>0?new qD(t):HD?null:new BD(t)}(e))}advance(e){const t=ae(performance.now());this.renderPassTimings[e].record(t-this._lastSample),this._lastSample=t}postrender(){U(this._gpuTimer)&&(this._gpuTimer.stop((e=>U(e)&&this.gpuTime.record(e)),16),this._gpuTimer=null);const e=performance.now()-this._startTime;this.totalTime.record(e),this.totalTime.total+=e,this.totalTime.frameCount++}}let YD=class extends N{constructor(e,t,i,r,s,a,n,o,l){super({}),this._materialRepository=e,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=a,this._requestRender=n,this._stage=l,this._materialRenderers=new Map,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new XD,this._antialiasing=xd.SMAA,this._oitEnabled=!1,this._multipassTerrain=!0,this._transparentTerrain=!1,this._hasAnimations=!1,this._animationTimestep=ae(0),this._handles=new lr,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new $E(this._rctx,i),this._oitEnabled=this._hasOITSupport,this._requestRender(),this._offscreenRendering=new wE(this._rctx,this._compositingHelper),this._sliceHelper=new QE,this._shadowMap=new La(this._rctx,l.viewingMode,2),this._ssaoHelper=new Fa(i,this._rctx,(()=>this._requestRender())),this._highlight=new yE(i,this._rctx),this._shadowHighlight=new BE(this._rctx,l.viewingMode),this._shadowAccumulator=new FE(this._rctx,i,l,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureCameraBindParameters(e.camera,e.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=t}),((e,t,i)=>{e.shadowMap.start(e.camera,t,i),this._renderShadowCascades(Xo.MATERIAL_DEPTH_SHADOWMAP_ALL,e.shadowMap),e.camera.setGLViewport(this._rctx),this._ensureCameraBindParameters(e.camera,e.contentCamera)}),(()=>this._requestRender())),this._renderContext=new Va(this._rctx,this._offscreenRendering,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new SE({renderContext:this._renderContext,shaderTechniqueRepository:i,textureRep:t,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:o}),this.renderPassManager=new sE(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([K((()=>this._stage.state.camera),(()=>this._requestRender()),J),K((()=>fa.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(wl.TRANSPARENT):()=>{},this._requestRender()}),$)])}get _bindParameters(){return this._renderContext.bindParameters}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return{}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=k(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=B(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),na.prune(),this._content.clear()}disposeOffscreenBuffers(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing===xd.SMAA&&this._smaaPass.updating||U(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return z(this._edgeView)&&(this._edgeView=new jD({rctx:this._rctx,renderSR:this._stage.renderSR,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(K((()=>Q(this._edgeView,(e=>e.updating))),(()=>this._requestRender()),te)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return Ur(this._bindParameters.ssr.reprojectionMatrix,kr)}set _reprojectionMatrix(e){L(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){return!!this._shadowMap?.enabled}setRenderParameters(e){const{_shadowMap:t,_ssaoHelper:i,_bindParameters:r}=this;if(void 0!==e.screenSpaceReflectionsEnabled&&r.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(r.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.shadowMap&&t.enabled!==e.shadowMap&&(t.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),U(e.environment)){U(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=e.weatherVisible,this._renderContext.bindParameters.weather=e.environment.weather,this._renderContext.bindParameters.weatherVisible=e.weatherVisible),void 0!==e.environment.lighting.ambientOcclusionEnabled&&i.enabled!==e.environment.lighting.ambientOcclusionEnabled&&(i.enabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),void 0!==e.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());const t="sun"===e.environment.lighting.type;r.enableFillLights!==t&&(r.enableFillLights=t,this._requestRender())}e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender());const s=e.antialiasingEnabled?xd.SMAA:xd.NONE;void 0!==e.antialiasingEnabled&&this._antialiasing!==s&&(this._antialiasing=s,this._requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=Z(e.slicePlane),this._requestRender()),void 0!==e.transparentTerrain&&this._transparentTerrain!==e.transparentTerrain&&(this._transparentTerrain=e.transparentTerrain,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:i,updates:r}=e;if(0===t.length&&0===i.length&&0===r.length)return;i.forAll((({id:e})=>this._content.delete(e))),t.forAll((e=>this._content.set(e.id,e)));const s=Ua(e);let a=!1;s.forEach(((e,t)=>{let i=this._materialRenderers.get(t);if(!i){if(!(e.adds.length>0))return;i=new za(this._rctx,this._materialRepository,t),this._materialRenderers.set(t,i)}i.modify(e),i.isEmpty&&(a=!0)})),a&&this._materialRenderers.forEach(((e,t)=>{e.isEmpty&&(this._materialRenderers.delete(t),e.dispose())})),this._hasHighlights=Te(this._materialRenderers,(e=>e.hasHighlights)),this._bindParameters.hasOccludees=Te(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=Te(this._materialRenderers,(e=>e.hasWater)),this._needsTransparentPass=Te(this._materialRenderers,(e=>e.requiresSlot(Zo.TRANSPARENT_MATERIAL,Xo.MATERIAL))),this._hasHUDElements=Te(this._materialRenderers,(e=>e.requiresSlot(Zo.LINE_CALLOUTS_HUD_DEPTH,Xo.MATERIAL)||e.requiresSlot(Zo.HUD_MATERIAL,Xo.MATERIAL)||e.requiresSlot(Zo.LABEL_MATERIAL,Xo.MATERIAL))),this._requestRender()}updateAnimation(e){return this._hasAnimations=!1,this._materialRenderers.forEach((t=>this._hasAnimations=t.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations}get animationTimestep(){return this._animationTimestep}updateLightSources(e,t,i){this._bindParameters.lighting.groundLightingFactor=t,this._bindParameters.lighting.globalFactor=i,this._bindParameters.lighting.set(e)}render(e,t,i,r){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.transparencyPassType=bd.NONE;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const a=ni(this._sliceHelper.plane);r===wd.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this._ensureCameraBindParameters(t,i),this._renderPlugins.prepareRender(),this.performanceInfo.advance(WD.Prepare);const n=this._computeDepthRange(t);this._renderShadowMap(e,t,this._bindParameters.lighting.lightingMainDirection,n),this.performanceInfo.advance(WD.Shadowmap),s.initializeFrame(t),this._ensureBindParameters(t,i),this._renderLinearDepth(),this.performanceInfo.advance(WD.Lineardepth),this._accumulateShadows(n,t,i),this._renderNormal(),this.performanceInfo.advance(WD.Normals),this._ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(this._bindParameters,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(WD.SSAO),this._renderContext.pass=Xo.MATERIAL,s.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(WD.Opaque);const o=this._multipassTerrain&&this._transparentTerrain;this._renderTerrainLinearDepth(o),this._setMultipassEnabled(o),this._setTerrainCulling(o),this._renderEdges(wl.OPAQUE),this.performanceInfo.advance(WD.OpaqueEdges),this._offscreenRendering.bindTarget(this._offscreenRendering.currentColorTarget,this._offscreenRendering.mainDepth),this._renderSlot(Zo.VOXEL),this._renderHiddenTransparentEdges();const l=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;l&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(WD.Transparent),this._renderGeometryLinearDepth(o);const h=this._renderHUDVisibility();o||this._renderInternalSlot(Zo.LINE_CALLOUTS),this.performanceInfo.advance(WD.Hudvisibility),this._renderEdges(wl.TRANSPARENT,o),this.performanceInfo.advance(WD.TransparentEdges),this._renderTransparentTerrain(),this._transparentTerrain&&h&&(o?this._renderLineCallouts(Qo.Occluded):s.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(Qo.Occluded,s.framebuffer),this.performanceInfo.advance(WD.HudOccluded)),this.performanceInfo.advance(WD.TransparentTerrain),this._setTerrainCulling(!1),this._transparentTerrain&&(s.compositeTransparentTerrainOntoMain(this._bindParameters),o&&(this._renderEdges(wl.OPAQUE),this.performanceInfo.advance(WD.OpaqueEdges),l&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(WD.Transparent),this._renderEdges(wl.TRANSPARENT),this.performanceInfo.advance(WD.TransparentEdges))),o&&this._renderLineCallouts(Qo.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),s.renderToTargets((()=>{this._renderInternalSlot(Zo.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(Zo.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(Zo.LASERLINES)}),s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(WD.Atmosphere),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain((()=>this._renderSlot(Zo.LASERLINES_CONTRAST_CONTROL)),this._bindParameters,Da.PremultipliedAlpha),this.performanceInfo.advance(WD.Laserline),this._renderOccluded(),this.performanceInfo.advance(WD.Occluded);const c=r===wd.ON&&this._magnifierHelper.enabled,d=c&&z(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(d);const u=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(this._antialiasing,u)&&U(u)&&this._compositingHelper.composite(this._bindParameters,u,Da.None),this.performanceInfo.advance(WD.Antialiasing),this._renderHUD(Qo.NotOccluded,d),this.performanceInfo.advance(WD.HudNotoccluded),this._renderHighlights(d,this._bindParameters),this.performanceInfo.advance(WD.Highlights),c&&this._magnifierHelper.render(this._rctx,this._bindParameters),d!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.tmpColorTexture,Da.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=a,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}finish(e){if(this._hasAnimations||(this._animationTimestep=ae(0)),e===gd.BACKGROUND){this._rctx.gl.getError();const e=this.performanceInfo.elapsedTime/.5;this._animationTimestep=ae(Math.max(.9*this._animationTimestep+e*(1-.9),eE))}}readDepthPixels(e,t,i){const r=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const t=Mn.COLOR_BUFFER_BIT|Mn.DEPTH_BUFFER_BIT|Mn.STENCIL_BUFFER_BIT;this._rctx.clearSafe(t),this._renderGeometryAndTransparentTerrainPass(Xo.MATERIAL_DEPTH)}r.readPixels(t[0],t[1],t[2],t[3],Cn.RGBA,Sn.UNSIGNED_BYTE,i)}readHUDVisibility(e,t,i,r,s){this._offscreenRendering.bindTarget(this._offscreenRendering.hudVisibility).readPixels(e,t,i,r,Cn.RGBA,Sn.UNSIGNED_BYTE,s)}readAccumulatedShadow(e,t){return this._shadowAccumulator.readAccumulatedShadow(e,t)}_setMultipassEnabled(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderSlot(e){this._bindParameters.slot=e,this._renderPlugins.render()}_renderEdges(e,t=!1){const i=this._edgeView;U(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>i.render(this._bindParameters,e)),this._bindParameters,Da.Alpha,t)}_renderShadowMap(e,t,i,r){const s=this._shadowMap;s.enabled&&(s.start(t,i,r),this._shadowHighlight.updateParameters(t,i),this.needsShadowHighlight?(this._renderShadowCascades(Xo.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,this._shadowMap,(e=>s.takeCascadeSnapshotTo(e,Na.Highlight))),s.clear(),this._renderShadowCascades(Xo.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,this._shadowMap,(e=>{s.takeCascadeSnapshotTo(e,Na.Default),this._renderGeometryAndTransparentTerrainPass(Xo.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT)}))):this._renderShadowCascades(Xo.MATERIAL_DEPTH_SHADOWMAP_ALL),s.finish(e),t.setGLViewport(this._rctx))}_renderShadowCascades(e,t=this._shadowMap,i=(e=>{})){for(const r of t.getCascades())r.camera.setGLViewport(this._rctx),this._ensureCameraBindParameters(r.camera,r.camera),this._renderGeometryAndTransparentTerrainPass(e),i(r)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this._renderGeometryAndTransparentTerrainPass(Xo.MATERIAL_DEPTH)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=Xo.MATERIAL_DEPTH,this._offscreenRendering.renderToTargets((()=>this._renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}_renderGeometryLinearDepth(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this._renderGeometryPass(Xo.MATERIAL_DEPTH)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}_renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(Xo.MATERIAL_NORMAL)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}_computeDepthRange(e){if(!this.needsDepthRange)return AO;const t=function(e,t,i){if(t.size<1e4)return YM.compute(e,t);const r=CO();return i.forAll((t=>{t.isVisible&&PO(r,function(e,t){if(!t.isVisible)return;const i=CO(),r=t.getSpatialQueryAccelerator();return U(r)?function(e,t,i){const r=t.eye,s=t.viewForward,a=t.frustum,n=e=>e.isVisible,o=i.objectCount;if(o<500)SO(ZM,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,zu.DepthOrder.FRONT_TO_BACK,ZM,((i,r)=>{GM(e,t,i),ZM.far=e.near,r.setRange(ZM)}),a,n),SO(ZM,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,zu.DepthOrder.BACK_TO_FRONT,ZM,((i,r)=>{GM(e,t,i),ZM.near=e.far,r.setRange(ZM)}),a,n);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,zu.DepthOrder.FRONT_TO_BACK,a,n,r),h=i.findClosest(s,zu.DepthOrder.BACK_TO_FRONT,a,n,r);l&&h&&(BM(e,t,l.boundingVolumeWorldSpace.bounds),BM(e,t,h.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){XM.clear(),i.forAll((e=>{e.isVisible&&0!==e.geometryRecords.length&&XM.add(e)})),XM.empty||(XM.sort(t),SO(ZM,t.near,Math.min(e.near,t.far)),XM.forEachInDepthRange(ZM,zu.DepthOrder.FRONT_TO_BACK,((i,r)=>{r<e.near&&GM(e,t,i)})),SO(ZM,Math.max(e.far,t.near),t.far),XM.forEachInDepthRange(ZM,zu.DepthOrder.BACK_TO_FRONT,((t,i,r)=>{e.far=Math.max(e.far,r)})))}(i,e,t.objects),i}(e,t))})),r}(e,this._content,this._stage.layers);return PO(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this._renderGeometryPass(e),this._renderTransparentTerrain()}_renderGeometryPass(e){this._renderContext.pass=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderOpaqueGeometry(){this._renderSlot(Zo.INTEGRATED_MESH),this._renderSlot(Zo.OPAQUE_TERRAIN),this._renderInternalSlot(Zo.OPAQUE_MATERIAL),this._renderSlot(Zo.OPAQUE_MATERIAL),this._renderSlot(Zo.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(Zo.TRANSPARENT_MATERIAL),this._renderSlot(Zo.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(Zo.TRANSPARENT_TERRAIN)}_renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(Zo.OCCLUSION_PIXELS)}),this._multipassTerrain&&this._transparentTerrain),e}_renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===Qo.Occluded?this._offscreenRendering.renderToTargets((()=>this._renderInternalSlot(Zo.LINE_CALLOUTS)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(Zo.LINE_CALLOUTS)}_renderHUD(e,t){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency((()=>this._renderHUDElements(e)),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.hudColorTexture,Da.PremultipliedAlpha)):e===Qo.Occluded?this._offscreenRendering.renderToTargets((()=>this._renderHUDElements(Qo.Occluded)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}_renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(Zo.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(Zo.HUD_MATERIAL),this._renderInternalSlot(Zo.LABEL_MATERIAL)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this.needsHighlight}_renderHighlights(e,t){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlight,r=this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(Xo.MATERIAL_HIGHLIGHT),this._rctx.clearSafe(Mn.DEPTH_BUFFER_BIT),this._renderHUDElements(Qo.Both)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=r.colorTexture,this.needsShadowHighlight&&this._shadowHighlight.render(t,e),i.render(this._bindParameters,r,e)}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(e,t,i){this.needsShadowCast&&this._shadowAccumulator.renderAccumulation(this._offscreenRendering.linearDepthTexture,e,t,i)}_renderOrderIndependentTransparency(e,t){const i=i=>{this._bindParameters.transparencyPassType=i,this._offscreenRendering.renderOITPass((()=>e()),i,t)},r=this._renderContext.pass;this._renderContext.pass=Xo.MATERIAL_ALPHA,i(bd.Alpha),this._renderContext.pass=Xo.MATERIAL,i(bd.Color),i(bd.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(this._bindParameters,t),this._bindParameters.transparencyPassType=bd.NONE,this._renderContext.pass=r,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let e=0;this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&i.renderOccluded===mn.OccludeAndTransparentStencil&&(e|=i.renderOccluded,JD.push(i))}));const t=this._offscreenRendering,i=(i,r,s,a,n)=>{0!=(e&r)&&(t.renderToTargets(s,t.tmpColor,t.mainDepth,[0,0,0,0],a,n),t.compositeOccludedOntoMain(this._bindParameters,i))};0!==JD.length&&(this._renderInternalSlot(Zo.OCCLUDER_MATERIAL,JD),i(.5,mn.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(Zo.TRANSPARENT_OCCLUDER_MATERIAL,JD)),!1,!1),JD.length=0),this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&(i.renderOccluded===mn.OccludeAndTransparent||i.renderOccluded===mn.Transparent||i.renderOccluded===mn.Opaque)&&(e|=i.renderOccluded,$D.push(i))}));const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,r>mn.Occlude&&this._renderSlot(Zo.OCCLUDED_TERRAIN),this._renderInternalSlot(Zo.OPAQUE_MATERIAL,$D),this._renderInternalSlot(Zo.TRANSPARENT_MATERIAL,$D),this._renderInternalSlot(Zo.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,$D),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=Xo.MATERIAL,i(.5,mn.OccludeAndTransparent,(()=>s(mn.OccludeAndTransparent)),!0,_d.OutlineVisualElementMask),i(.5,mn.Transparent,(()=>s(mn.Transparent)),!0,_d.OutlineVisualElementMask),i(1,mn.Opaque,(()=>s(mn.Opaque)),!0,_d.OutlineVisualElementMask),$D.length=0}_renderAntiAliasing(e,t){if(e===xd.SMAA){if(this._smaaPass.enable((()=>this._requestRender()))&&U(t))return this._smaaPass.render(t),!0}else this._smaaPass.disable();return!1}_ensureCameraBindParameters(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParameters(e,t){this._ensureCameraBindParameters(e,t);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=i.depthTexture??this._getFallbackDepthTexture()}_ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=kr:(Ar(tI,this._bindParameters.camera.viewMatrix),Ar(eI,this._bindParameters.camera.projectionMatrix),Ir(iI,tI,eI),Ir(iI,this._renderContext.lastFrameCamera.viewMatrix,iI),Ir(iI,this._renderContext.lastFrameCamera.projectionMatrix,iI),this._reprojectionMatrix=iI),this._bindParameters.ssr.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._bindParameters.ssr.lastFrameColorTexture=null,this._bindParameters.ssr.enabled=this.hasWaterReflection}_renderInternalSlot(e,t){let i=!1;return this._bindParameters.slot=e,U(t)?t.forEach((e=>{if(!e.shouldRender(this._renderContext))return;const t=this._materialRenderers.get(e);U(t)&&(i=t.render(this._renderContext.pass,this._bindParameters)||i)})):this._materialRenderers.forEach(((e,t)=>{t.shouldRender(this._renderContext)&&e.render(this._renderContext.pass,this._bindParameters)&&(i=!0)})),i}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=oa(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){return{offscreen:this._offscreenRendering?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}get test(){const e=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:t=>{switch(t){case KD.Color:return e._offscreenRendering.colorTexture;case KD.LinearDepth:return e._offscreenRendering.linearDepthTexture;case KD.Normals:return e._offscreenRendering.normalTexture;case KD.ShadowMap:return e._shadowMap.depthTexture;case KD.HudVisibility:return e._offscreenRendering.hudVisibilityTexture;case KD.Highlight:return e._offscreenRendering.highlightTexture}}}}};var KD;e([ve()],YD.prototype,"_shadowAccumulator",void 0),e([ve()],YD.prototype,"_smaaPass",void 0),e([ve()],YD.prototype,"_antialiasing",void 0),e([ve()],YD.prototype,"_edgeView",void 0),e([ve()],YD.prototype,"updating",null),e([ve()],YD.prototype,"isCameraFinal",null),YD=e([xe("esri.views.3d.webgl-engine.lib.Renderer")],YD),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(KD||(KD={}));const $D=[],JD=[],eI=zr(),tI=zr(),iI=zr();class rI extends Ph{constructor(e,t,i){super(e,t),this.newCache=i,this._refCount=1}dispose(){--this._refCount>0||super.dispose()}ref(){++this._refCount}bindTechnique(e,t,i,r){this.useProgram(e.program);const s=U(i)?i.slot:null;return e.bindPipelineState(this,s,r),U(t)&&U(i)&&e.bindPass(t,i),e.program}get test(){return this.programCache.test}}const sI=V.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let aI=class extends N{constructor(e,t,i){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new or,this._frameTask=e.resourceController.scheduler.registerTask(So.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}dispose(){this._frameTask.remove(),this._stage.forEachOfType(hn.Texture,(e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return z(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(ja,new ka)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),H(t.loadingPromise,t)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",gd.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(z(t))return Go(void 0!==t),null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(e)})),r=new nI(e,(()=>{this._frameTask.schedule((()=>{r.isUnreferenced&&t.unload()}))}));return this._textures.set(e,r),r.ref(),U(t.glTexture)?(this._updateGLTexture(r,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule((()=>{const i=t.load(this._rctx,(()=>this.textureTechnique)),s=i=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,i),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r);return _(i)?i.then(s,(e=>(this._loadingCount--,r.loadingPromise=null,u(e)||sI.error(e),null))):s(i)})),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",gd.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};e([ve()],aI.prototype,"_loadingCount",void 0),e([ve()],aI.prototype,"_frameTask",void 0),e([ve()],aI.prototype,"updating",null),aI=e([xe("esri.views.3d.webgl-engine.lib.TextureRepository")],aI);class nI{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(sI.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}const oI=V.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let lI=class extends N{constructor(){super(...arguments),this._data=new Array,this._state=Td.NOT_LOADED}dispose(){this._state=Td.NOT_LOADED,this._data.forEach((e=>e.dispose())),this._data.length=0}get updating(){return this._state===Td.LOADING}get resourceState(){return this._state}loadTextures(e){const t=[Bo("esri/images/materials/water/normals.jpg"),Bo("esri/images/materials/water/perturbation.jpg")];this._state=Td.LOADING,Promise.all(t.map((e=>Mo(e)))).then((t=>{t.forEach((t=>this._data.push(new jo(e,{target:Tn.TEXTURE_2D,pixelFormat:Cn.RGBA,dataType:Sn.UNSIGNED_BYTE,wrapMode:Pn.REPEAT,samplingMode:Rn.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8,width:t.width,height:t.height},t)))),this._state=Td.LOADED})).catch((e=>{oI.error("Failed to load textures for water material.",e),this._state=Td.NOT_LOADED}))}bind(e){this._state===Td.LOADED&&(e.bindTexture("texWaveNormal",this._data[0]),e.bindTexture("texWavePerturbation",this._data[1]))}};e([ve()],lI.prototype,"_state",void 0),e([ve({type:Boolean,readOnly:!0})],lI.prototype,"updating",null),lI=e([xe("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],lI);class hI extends Oa{constructor(e,t,i,r,s,a){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=i,this._renderOverlay=r,this._forceCameraHook=s,this._disposeOffscreenBuffers=a,this.supersample=!0,this._screenshotQueue=new Array}dispose(){this._rctx=null}takeScreenshot(e){this._requestRenderScene(gd.BACKGROUND);const t=l();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const i={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},r=this._renderScreenshot(e,i);t.resolver(r)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){if(z(this._renderOverlay))return t;e.width=t.width,e.height=t.height;const r=e.getContext("2d"),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderOverlay(e,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled(e,t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:s,resample:a}=e,n=this._ensureScreenshotEncodeCanvas();let o=Bu(i,r,n);this._rctx.gl.readPixels(0,0,i,r,Cn.RGBA,En.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(n,o,{...e,region:null});const l=Bu(s.width,s.height,n);return Hu(o,l,!0,a.region.x,r-(a.region.y+a.region.height),a.region.width,a.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),a=Bu(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,Cn.RGBA,En.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(s,a,e)}_renderScreenshot(e,t){let i=null;const r=e.viewCamera,{framebufferWidth:s,framebufferHeight:a}=t;let n=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=s!==r.fullWidth||a!==r.fullHeight,h=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,c=l||o||h;if(c){const e=r.clone();if(t.ignorePadding){const i=pr(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s,e.fullHeight=a,e.pixelRatio=t.pixelRatio;const o=r.fovX-e.fovX,l=r.fovY-e.fovY;o<0&&o<l?e.fovX=r.fovX:l<0&&l<o&&(e.fovY=r.fovY),this._forceCameraHook(e),n=!0,i=new To(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:wn.TEXTURE,depthStencilTarget:On.DEPTH_STENCIL_RENDER_BUFFER}),this._renderScene(i,e,t.disableDecorations?wd.OFF:wd.ON),this._disposeOffscreenBuffers()}const d=()=>{this._rctx.bindFramebuffer(null),B(i)},u=this._readbackScreenshot(t,d);if(d(),c&&!this._rctx.contextAttributes.alpha)for(let e=3;e<u.data.length;e+=4)u.data[e]=255;return n&&this._forceCameraHook(r),u}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const cI=V.getLogger("esri.views.3d.webgl-engine.parts.View");let dI=class extends(Ga(N)){constructor(e){super({}),this.events=new or,this.waterTextureRepository=new lI,this._magnifierHelper=new JM,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode,this._initializeContext(e),K((()=>this.waterTextureRepository?.updating),(()=>this.requestRender()),$),this._magnifierHelper.events.on("request-render",(()=>this.requestRender())),this._stippleTextureRepository=new qa(this._rctx),this._shaderTechniqueRepository=new Ba({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new aI(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.requestRender(e))),this._materialRepository=new Ha(this._textureRepository,this._shaderTechniqueRepository,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new jM(this._rctx,this._shaderTechniqueRepository),this._renderer=new YD(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,(e=>this.requestRender(e)),((t,i)=>e.schedule(t,i)),e),this._screenshotManager=new hI(this._rctx,((e,t,i)=>this._renderer.render(e,t,t,i)),(e=>this.requestRender(e)),e.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e)),(()=>this._renderer.disposeOffscreenBuffers())),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=j(this._frameTask),this._shaderTechniqueRepository=B(this._shaderTechniqueRepository),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}requestRender(e=gd.UPDATE){e===gd.UPDATE?this._needsUpdate=!0:this._needsRender=!0}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}updateLightSources(e,t,i){this._renderer.updateLightSources(e,t,i),this.requestRender()}setRenderParameters(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(e){this._renderer.modify(e),e.clear()}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}getAlpha(){return this._rctx.contextAttributes.alpha}get shadowsEnabled(){return this._renderer.shadowsEnabled}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}readHUDVisibility(e,t,i,r,s){this._renderer.readHUDVisibility(e,t,i,r,s)}getMinimalDepthForArea(e,t,i,r,s,a=s){const n=r.constrainWindowSize(t,i,s*r.pixelRatio,a*r.pixelRatio),o=this._ensureDepthBuffer(n);this._renderer.readDepthPixels(r,n,o);let l=Number.MAX_VALUE;for(let e=0;e<n[2]*n[3];e++){const t=kM(4*e,o,r.nearFar);l>t&&t!==r.nearFar[0]&&t!==r.nearFar[1]&&(l=t)}if(U(e)){const s=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);U(s)&&l>s&&s!==r.nearFar[0]&&s!==r.nearFar[1]&&(l=s)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(z(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}get gpuMemoryUsage(){return this._renderer.gpuMemoryUsage}async reloadShaders(){bT(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}get animationTimestep(){return this._renderer.animationTimestep}_registerFrameTask(e){const t=e.state,i={viewCamera:t.camera,frameHasDecorations:!1};let r=!1,s=gd.BACKGROUND,a=!1;const n={preRender:i=>{r=this.updating,s=this._needsUpdate?gd.UPDATE:gd.BACKGROUND,e.processSyncLayers();const a=ae(i.time-this._lastAnimationUpdate);(a>this.animationTimestep||U(this.forcedAnimationTime)||r||this._needsRender)&&(this._renderer.updateAnimation({camera:t.camera,dt:a,forcedTime:this.forcedAnimationTime})&&this.requestRender(gd.BACKGROUND),this._lastAnimationUpdate=i.time)},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,wd.ON),a=!0,e&&this._renderer.hasWaterReflection&&(this.requestRender(gd.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:()=>{i.viewCamera=t.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)},finish:()=>{a&&(this._renderer.finish(s),a=!1)}};this._frameTask=he(n)}_initializeContext(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==t.stencil||t.stencil,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},r=ku("3d",this._canvas,i);if(z(r)){const e=T("esri-force-webgl");cI.error(e)}else this._rctx=this._newRenderingContext(r,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&cI.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&T("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8};return new rI(e,i,((e,i)=>t.resourceController.memoryController.newCache(e,i)))}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return z(this._componentObjectCollection)&&(this._componentObjectCollection=new EM(this._renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};var uI;e([ve({type:Boolean,readOnly:!0})],dI.prototype,"updating",null),e([Ma()],dI.prototype,"_rctx",void 0),e([Ma()],dI.prototype,"_container",void 0),e([Ma()],dI.prototype,"_canvas",void 0),e([Ma()],dI.prototype,"_stippleTextureRepository",void 0),e([Ma(),ve()],dI.prototype,"waterTextureRepository",void 0),e([Ma(),ve()],dI.prototype,"_magnifierHelper",void 0),e([Ma(),ve()],dI.prototype,"_textureRepository",void 0),e([Ma()],dI.prototype,"_compositingHelper",void 0),e([Ma()],dI.prototype,"_renderer",void 0),e([Ma()],dI.prototype,"_screenshotManager",void 0),e([Ma()],dI.prototype,"componentObjectCollection",null),e([Ma()],dI.prototype,"_componentObjectCollection",void 0),e([ve()],dI.prototype,"_needsUpdate",void 0),e([ve()],dI.prototype,"_needsWaterReflectionUpdate",void 0),dI=e([xe("esri.views.3d.webgl-engine.parts.RenderView")],dI);let pI=uI=class extends(Ga(N)){constructor(e){super(e),this._handles=new lr,this._model=new JP,this._layers=new le,this._changeSet=new Wa,this._layerSyncSet=new Set}initialize(){this._set("renderView",new dI(this)),this._frameTask=this.resourceController.scheduler.registerTask(So.STAGE,this),this._handles.add(this._frameTask)}destroy(){en.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}add(e){this._model.add(e),tn(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}remove(e){z(e)||(this.renderView.requestRender(),this._model.remove(e),tn(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){U(e)&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){U(e)&&(this._model.removeMany(e),this.renderView.requestRender())}async load(e){z(e)||(Array.isArray(e)||(e=[e]),await Promise.all(e.filter((e=>z(e.glTexture))).map((e=>this.schedule((()=>this._model.has(e)?e.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique)):null))))))}loadImmediate(e){return e.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique))}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;uI.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),uI.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||t.updatePolicy===Cd.SYNC)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,i){const r=this.renderView.renderPlugins.add(e,t,i),s=()=>{sw(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(_(r))return r.then(s);s()}removeRenderPlugin(e){sw(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,model:e._model}}};pI.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e([ve({constructOnly:!0})],pI.prototype,"resourceController",void 0),e([ve({constructOnly:!0})],pI.prototype,"options",void 0),e([ve({constructOnly:!0})],pI.prototype,"state",void 0),e([ve({constructOnly:!0})],pI.prototype,"sceneIntersectionHelper",void 0),e([ve({readOnly:!0})],pI.prototype,"viewingMode",null),e([ve({constructOnly:!0})],pI.prototype,"container",void 0),e([ve({constructOnly:!0})],pI.prototype,"renderSR",void 0),e([ve({constructOnly:!0})],pI.prototype,"_handles",void 0),e([ve({readOnly:!0})],pI.prototype,"updating",null),e([ve({constructOnly:!0})],pI.prototype,"_model",void 0),e([Ma(),ve()],pI.prototype,"renderView",void 0),pI=uI=e([xe("esri.views.3d.webgl-engine.Stage")],pI);let mI=class extends rp{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};e([ve()],mI.prototype,"components",void 0),mI=e([xe("esri.views.ui.3d.DefaultUI3D")],mI);const gI=mI,fI=V.getLogger("esri.views.SceneView");let _I=class extends(Ci(Si(zi(xi)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new vh({slicePlane:ci},this),this._resourceController=new Ow.ResourceController({view:this}),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new xb({view:this}),this.labeler=new Gb({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new Ti,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new wp,this.environmentManager=new vg,this.extent=null,this.floors=new s,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new dp({view:this}),this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Cx,this.scale=null,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new gI,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new pw,this.voxelWasm=null,this.voxelWasmPromise=null,ye(),e&&e.environment||(this._defaults.environment=new Ap,this.environment=this._defaults.environment);const t=(e=null)=>{U(e)&&e.type===a.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this._updatingChanged()})))};this.handles.add([Y((()=>this.map?.allLayers),"after-changes",(e=>t(e)),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),K((()=>this.map),(e=>{e&&"load"in e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new qv({view:this}),this.stateManager=new qx({view:this})}initialize(){this.groundView=new Pi({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(Y((()=>this.map?.allLayers),"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),$),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),$),this.updatingHandles.add((()=>this.qualitySettings.frameRate),(e=>de(e>0?1e3/Math.ceil(e):0)),$),this.updatingHandles.add((()=>this.map?.ground),e,J),this.updatingHandles.add((()=>this.map?.ground?.opacity),(()=>this._updateDefaultHitTestOptions()),J),this.handles.add(K((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),te))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=k(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=k(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=k(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");return!this._userClippingArea&&!this.get("map.clippingEnabled")||z(e)?(this._clippingArea=null,null):e instanceof bc?this.spatialReference&&(e=vI(e,this.spatialReference),z(e))?(fI.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),z(e.intersection(this.groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(fI.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&U(e)?fI.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Gi.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return z(t)||z(e)||t.spatialReference.equals(e)?t:vI(t,e)}get dataExtent(){let e=this.groundAndLayersExtent;const t=this.spatialReference||mr.WGS84,i=vI(this.clippingArea,t);U(i)&&(e=U(e)?e.intersection(i):i);const r=this._get("dataExtent");return U(e)&&e.equals(r)?r:e}get groundAndLayersExtent(){const e=this.spatialReference||mr.WGS84;let t;const i=i=>{const r=vI(i,e);z(r)||(U(t)?t.union(r):t=r.clone())},r=this.basemapTerrain;if(r?.spatialReference){const e=r.groundExtent;i(new bc({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const e=e=>{!U(e.fullExtent)||"graphics"===e.type&&e.internal||i(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(z(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0);const s=this._get("groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof Ap?e:e instanceof rr?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):Ap.fromWebsceneEnvironment(e):Ce(Ap,e):new Ap}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||U(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(z(this.state)||this.state.stationary)}set qualityProfile(e){dw.isValidProfile(e)&&(dw.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||dw.getDefaultProfile()}set slicePlane(e){if(U(this._stage)&&this._stage.renderView.setRenderParameters({slicePlane:e}),z(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");oi(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return null!=this.spatialReference?gi(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?Ct.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((r=>{if(r.isFulfilled()){if(r.updating){if(t=!0,r.suspended||nd(r))return;++i,e+=r.updatingProgress}}else++i}));for(const t of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager,this.analysisViewManager])if(U(t)&&t.updating){const t=.1;i+=t,e+=.5*t}for(const t of[this.deconflictor,this.labeler,this.basemapTerrain])U(t)&&t.updating&&(++i,e+=t.updatingProgress);if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||this.inputManager?.hasPendingInputs||this.map?.allLayers?.some((e=>!e.isFulfilled()))),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const i=performance.now();if(e<1){const t=Math.min((i-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?i:0}return t}get viewingMode(){const e=this._predeterminedViewingMode;if(U(e))return qi(e);const t=this.spatialReference;return t?U(this.defaultsFromMap?.viewingMode)&&t.equals(this.defaultsFromMap.spatialReference)?qi(this.defaultsFromMap.viewingMode):ip(t,Gi.Global)?"global":"local":"global"}set viewingMode(e){this.ready?fI.error("#viewingMode","viewingMode cannot be set once view is ready"):e?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new Ic(this)}forceAnimationTime(e){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=e}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return fI.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=U(i.graphics)&&(U(i.graphics.include)||U(i.graphics.exclude)),s=ep(e)?tp(this,e):e,a=pe(s);i.enableDraped=i.include&&!i.include.has(ph)||i.exclude&&i.exclude.has(ph);const n=this.sceneIntersectionHelper,o=Hl(this.state.viewingMode);if(o.options.selectionMode=!0,o.options.store=r?Ql.ALL:Ql.MIN,n.intersectIntersectorScreen(a,o,i),r){for(const e of o.results.all){const t=Yu(e,this);if(z(t))return this._intersectResultToMapPoint(e);if("graphic"!==t.type||this._testGraphicUidFilter(i.graphics,t.graphic))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return fI.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=H(null==e.z&&Sc(this.elevationProvider,e),0);return Et(e,xI,this.renderSpatialReference,t),this.state.camera.projectToScreen(xI,wI),ge(wI[0],wI[1])}pixelSizeAt(e){return this.ready?e?(Et(e,xI,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(xI)):0:(fI.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return fI.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=ep(e)?tp(this,e):e,r=ue(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const a=Hl(this.state.viewingMode);a.options.selectionMode=!0,a.options.store=Ql.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(r,a,s);const n=this._intersectResultsToHits(a.results.all,s.graphics),o=a.results.ground,l=Ku(o,this),h=U(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,c={screenPoint:i,results:n,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:Zl(o)?o.distanceInRenderSpace:0,layer:h}};return fa.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(c.intersector=a),Promise.resolve(c)}async popupHitTest(e){const{results:t,ground:i}=await $u(this,e);let r=null;return!(0===t.length||Math.abs(H(t[0].distance,0)-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(z(e.parent))throw new o("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return"line-of-sight"===e.parent.type?(await this.whenLayerView(e.parent)).whenAnalysisView():this.analysisViewManager.whenAnalysisView(e)}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return Wu(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return Qu(i,this._pixelFormat())}_completeSettings(e){const t=Zu(e,this);return t.pixelRatio/=this.state.pixelRatio,Xu(t,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:e=>this._takeScreenshot(e)}}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return(e=>{const t=np[e.type];if(z(t))throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new o(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)})(e)}hasLayerViewModule(e){return(e=>U(np[e.type]))(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=ji(this.type);if(T("safari")&&T("safari")<9&&(e=new o("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:T("safari")})),U(e))throw fI.warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return U(e)?Bi(e):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const i=this._predeterminedViewingMode;if(U(i))return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,Gi.Local),s=this._validateSpatialReferenceForViewingMode(e,t,Gi.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Gi.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Gi.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!(!ip(e,i)||!z(t)&&!vi(t)&&(_i(t)&&z(Fc(t,e,i))||bi(t)&&i===Gi.Global))}_makeSpatialReferenceConstraints(e,t,i){if(z(t))return[{spatialReference:e,viewingMode:i}];const r=e.isWebMercator,s=e.isWGS84;return vi(t)&&(r||s)?s&&i!==Gi.Local&&null!==ud(t.tileInfo,t.fullExtent,e,Gi.Global)?[{spatialReference:r?mr.WGS84:mr.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:mr.WebMercator,viewingMode:i}]:_i(t)||bi(t)||!r&&!s?_i(t)&&r&&i!==Gi.Global?[{spatialReference:e,viewingMode:i},{spatialReference:mr.WGS84,viewingMode:Gi.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?mr.WGS84:mr.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=U(this.getSpatialReferenceSupport({spatialReference:e})),i=this._predeterminedViewingMode;return t||(U(i)?fI.warnOnce(`Spatial reference defined on view not supported in ${qi(i)} viewing mode.`):e.isGeographic&&fI.warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||mr.WGS84;return Ot(e,this.renderSpatialReference,e,i)||(i=mr.WGS84,Ot(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new xc(e,i),t}trackGraphicState(e){if(!e.graphic)return fI.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&U(t)&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return U(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,U(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return x(e.map((e=>this.highlight(e))));if(s.isCollection(e))return x(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):b()}maskOccludee(e){if(!e)return fI.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&U(t)&&Ju(t)&&(i=t.maskOccludee(e))};return U(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,U(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){U(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await ie((()=>this.graphicsView)),this.graphicsView;if(!e.layer||!this.map)throw new o("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{s.added.includes(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,bI.INCLUDE),i=this._externalToInternalRenderItems(e.exclude,bI.EXCLUDE);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(xI)?(t=this.computeMapPointFromVec3d(xI,t),e.intersector===Xl.TERRAIN&&this.basemapTerrain&&(t.z=H(Sc(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const a=e[s],n=Ku(a,this);if(U(n)&&(n===this.map.ground||"type"in n&&"integrated-mesh"===n.type))break;const o=Yu(a,this);if(z(o))continue;if("graphic"===o.type){if(z(r)&&s!==e.length-1&&(r=new Set),U(r)){const e=this._getGraphicFilterUid(o.graphic);if(r.has(e))continue;r.add(e)}if(!this._testGraphicUidFilter(t,o.graphic))continue}const l=this._intersectResultToMapPoint(a),h=a.distanceInRenderSpace;i.push({...o,mapPoint:l,distance:h})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return z(e)||(z(e.include)||e.include.has(i))&&(z(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,r={layerUids:null,graphicUids:null}){if(!e)return r;if(e instanceof i)!function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}(r,this._getGraphicFilterUid(e)),t===bI.INCLUDE&&(U(this.graphicsView)&&e.layer===this?yI(r,this.graphicsView.processor.layer.id):e.layer&&yI(r,e.layer.uid));else if(F(e))for(const i of e)i===this.graphics&&U(this.graphicsView)?yI(r,this.graphicsView.processor.layer.id):i===this.map.ground?yI(r,ph):this._externalToInternalRenderItems(i,t,r);else"uid"in e&&yI(r,e.uid);return r}_initBasemapTerrain(){this._set("basemapTerrain",new GP({view:this})),this._set("elevationProvider",new ow({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new rT({view:this})),this._set("featureTiles",new vx({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=U(this.basemapTerrain.extent)?Ft(si(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;U(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add((()=>fa.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("../chunks/FeatureTileTree3DDebugger.js")).then((({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&fa.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}))})):e||!this.featureTreeDebugger||fa.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)}),J),this.updatingHandles.add((()=>this.clippingArea),e,J),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,J)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new mw(this.map,e));const t=this.state.isGlobal,i=pi(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",mi.create(this.state.viewingMode,i)),t||this.handles.add(K((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;e&&(0!==e[0]||0!==e[1]||0!==e[2]||0!==e[3])&&Rt(e,this.basemapTerrain.spatialReference,TI,t)&&(this.renderCoordsHelper.extent=TI)}),te),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Wl/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){U(e)&&e.type===a.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add(K((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),te),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},t=new Kx(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=n(this.surface),{resourceController:r,state:s,renderSpatialReference:a}=this;this._stage=new pI({options:e,container:i,resourceController:r,state:s,sceneIntersectionHelper:t,renderSR:a}),this._stage.renderView.setRenderParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=y(this._stage.renderView.canvas,"webglcontextlost",(()=>this.fatalError=new o("webgl-context-lost"))),this.handles.add([this.updatingHandles.add((()=>this.qualitySettings.antialiasingEnabled),(()=>this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})),$),this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(()=>this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency})),$),K((()=>this.magnifier),(e=>this._stage.renderView.magnifier=e),J)],"stage");const l=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:pw.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add((()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference]),l),"stage"),l(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Wl/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Ew({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new Zb})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("../chunks/GraphicsView3D.js")).default;p(e),await ie((()=>this.basemapTerrain?.ready),e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),U(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=Bi(this.viewingMode);if(e===Gi.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.handles.add(Y((()=>this.graphics),"after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(ph);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(ph);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}addVoxelLayerViewToWasm(e){return z(this.voxelWasm)?(z(this.voxelWasmPromise)&&(this.voxelWasmPromise=import("../chunks/VoxelWasmPerSceneView.js").then((e=>(this.voxelWasm=new e.default(this),this.voxelWasm)))),this.voxelWasmPromise.then((t=>t.addVoxelLayer(e)))):this.voxelWasm.addVoxelLayer(e)}removeVoxelLayerViewFromWasm(e){U(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(e)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}};function yI(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function vI(e,t){return U(e)&&Lt(e.spatialReference,t)?Ft(e,t):null}var bI;_I.type="3d",e([ve()],_I.prototype,"_userClippingArea",void 0),e([ve()],_I.prototype,"_resourceController",void 0),e([ve()],_I.prototype,"_stage",void 0),e([ve({readOnly:!0})],_I.prototype,"deconflictor",void 0),e([ve({readOnly:!0})],_I.prototype,"labeler",void 0),e([ve(Tt(Ti,"analyses"))],_I.prototype,"analyses",void 0),e([ve({type:ki,readOnly:!0,aliasOf:"state.animation"})],_I.prototype,"animation",void 0),e([ve({readOnly:!0})],_I.prototype,"basemapTerrain",void 0),e([ve({readOnly:!0})],_I.prototype,"elevationProvider",void 0),e([ve({type:t,aliasOf:"stateManager.camera"})],_I.prototype,"camera",void 0),e([ve({type:t,aliasOf:"stateManager.contentCamera"})],_I.prototype,"contentCamera",void 0),e([ve({readOnly:!0})],_I.prototype,"canvas",void 0),e([ve({type:xc,aliasOf:"stateManager.center"})],_I.prototype,"center",void 0),e([ve({type:bc})],_I.prototype,"clippingArea",null),e([ve({type:wp})],_I.prototype,"constraints",void 0),e([ve({type:bc,readOnly:!0})],_I.prototype,"renderDataExtent",null),e([ve({type:bc,readOnly:!0})],_I.prototype,"dataExtent",null),e([ve({type:bc,readOnly:!0})],_I.prototype,"groundAndLayersExtent",null),e([ve({value:null,type:Ap})],_I.prototype,"environment",null),e([be("environment")],_I.prototype,"castEnvironment",null),e([ve({readOnly:!0})],_I.prototype,"environmentManager",void 0),e([ve({type:bc,aliasOf:"stateManager.extent"})],_I.prototype,"extent",void 0),e([ve()],_I.prototype,"floors",void 0),e([ve({readOnly:!0,aliasOf:"stateManager.screenCenter"})],_I.prototype,"screenCenter",void 0),e([ve({aliasOf:"stateManager.frustum"})],_I.prototype,"frustum",void 0),e([ve({type:Number,readOnly:!0})],_I.prototype,"fullOpacity",void 0),e([ve({readOnly:!0})],_I.prototype,"graphicsView",void 0),e([ve({readOnly:!0})],_I.prototype,"analysisViewManager",void 0),e([ve()],_I.prototype,"groundView",void 0),e([ve({type:Boolean})],_I.prototype,"initialExtentRequired",null),e([ve()],_I.prototype,"_defaultsFromMapSettings",null),e([ve({type:Boolean,readOnly:!0})],_I.prototype,"interacting",null),e([ve()],_I.prototype,"stationary",null),e([ve({aliasOf:"state.navigating"})],_I.prototype,"navigating",void 0),e([ve()],_I.prototype,"map",void 0),e([ve({readOnly:!0})],_I.prototype,"mapCoordsHelper",void 0),e([ve({aliasOf:"stateManager.padding"})],_I.prototype,"padding",void 0),e([ve({type:rT,readOnly:!0})],_I.prototype,"pointsOfInterest",void 0),e([ve({type:vx,readOnly:!0})],_I.prototype,"featureTiles",void 0),e([ve()],_I.prototype,"featureTreeDebugger",void 0),e([ve({type:Boolean})],_I.prototype,"screenSizePerspectiveEnabled",void 0),e([ve({constructOnly:!0})],_I.prototype,"deactivatedWebGLExtensions",void 0),e([ve({constructOnly:!0})],_I.prototype,"debugWebGLExtensions",void 0),e([ve({constructOnly:!0})],_I.prototype,"renderCanvas",void 0),e([ve({constructOnly:!0})],_I.prototype,"state",void 0),e([ve({readOnly:!0})],_I.prototype,"inputManager",void 0),e([ve({readOnly:!0})],_I.prototype,"stateManager",void 0),e([ve({type:["low","medium","high"]})],_I.prototype,"qualityProfile",null),e([ve({type:ww,get(){let e=this._get("qualitySettings");return e||(e=new ww,dw.apply(this.qualityProfile,e)),e}})],_I.prototype,"qualitySettings",void 0),e([ve()],_I.prototype,"slicePlane",null),e([ve({readOnly:!0})],_I.prototype,"typeSpecificPreconditionsReady",null),e([ve({readOnly:!0})],_I.prototype,"renderCoordsHelper",void 0),e([ve({readOnly:!0})],_I.prototype,"sceneIntersectionHelper",void 0),e([ve({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],_I.prototype,"resolution",null),e([ve({type:Number,aliasOf:"stateManager.scale"})],_I.prototype,"scale",void 0),e([ve()],_I.prototype,"heightModelInfo",null),e([ve()],_I.prototype,"spatialReference",void 0),e([ve({type:Boolean,constructOnly:!0})],_I.prototype,"alphaCompositingEnabled",void 0),e([ve({constructOnly:!0})],_I.prototype,"preserveDrawingBufferEnabled",void 0),e([ve({type:Boolean})],_I.prototype,"supersampleScreenshotsEnabled",void 0),e([ve({readOnly:!0})],_I.prototype,"type",void 0),e([ve({type:gI})],_I.prototype,"ui",void 0),e([ve({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating"]})],_I.prototype,"updating",null),e([ve({type:Number,readOnly:!0,dependsOn:["updating"]})],_I.prototype,"updatingProgress",void 0),e([ve({type:["global","local"]})],_I.prototype,"viewingMode",null),e([ve({type:r,aliasOf:"stateManager.viewpoint"})],_I.prototype,"viewpoint",void 0),e([ve({type:Number,aliasOf:"stateManager.zoom"})],_I.prototype,"zoom",void 0),e([ve({type:pw})],_I.prototype,"highlightOptions",void 0),_I=e([xe("esri.views.SceneView")],_I),function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(bI||(bI={}));const xI=Oe(),wI=ue(),TI=Vt(),CI=_I;export{SD as $,gA as A,iO as B,tO as C,sM as D,jA as E,Yb as F,kA as G,oA as H,Tw as I,PA as J,pA as K,Sw as L,vA as M,ZT as N,tA as O,sA as P,rA as Q,$R as R,gO as S,aA as T,nA as U,DA as V,IA as W,OA as X,uA as Y,iA as Z,xC as _,lT as a,lA as b,AA as c,eO as d,CI as default,JR as e,xA as f,SA as g,MA as h,JA as i,EA as j,RA as k,ZO as l,eR as m,$A as n,tR as o,eA as p,mA as q,NA as r,bA as s,zA as t,hT as u,UA as v,wA as w,CA as x,FA as y,_A as z};
