// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/arrayUtils ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/quantizationUtils ../../../layers/support/arcgisLayerUrl ../../../layers/support/fieldType ../../../layers/support/fieldUtils ../../../rest/support/GenerateRendererParameters ../../../rest/support/QuantizationParameters ../../../rest/support/StatisticDefinition ../../../rest/support/UniqueValueDefinition ../../statistics/support/predominanceUtils ../../statistics/support/statsWorker ../../statistics/support/utils ../../statistics/support/WorkerClient ../utils ./LayerAdapter ./support/utils ../../../statistics/utils ../../../tasks/GenerateRendererTask".split(" "),
function(v,K,L,A,D,M,B,P,Q,ba,ca,R,S,T,U,E,G,V,H,W,N,C,u,X,I,Y,t,x,Z){const aa=D.getLogger("esri.smartMapping.support.adapters.FeatureLayerAdapter");D=function(O){function J(b){return O.call(this,b)||this}v._inheritsLoose(J,O);var n=J.prototype;n.destroy=function(){var b;this._hasLocalSource=null;null==(b=this.workerClient)?void 0:b.destroy()};n._isStatsSupportedOnService=function(){const b=this.layer;return!b.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!T.isHostedAgolService(b.url)&&
10.5>b.version?Promise.reject(new A("feature-layer-adapter:not-supported","Layer does not support statistics query")):Promise.resolve()};n._waitForLayerViewUpdate=function(){var b=v._asyncToGenerator(function*(a){if(!a)throw new A("feature-layer-adapter:insufficient-data","layerView is required to fetch the features");const c=new AbortController,d=P.whenOnce(()=>!a.updating,c.signal);yield B.timeout(d,5E3,c).catch(e=>{aa.warn("LayerView is taking too long to update. Aborting fetch from layerView.");
throw e;})});return function(a){return b.apply(this,arguments)}}();n._fetchFeaturesFromMemory=function(){var b=v._asyncToGenerator(function*(a,c,d,e){const k=this.layer;e="json"===e;if(this._hasLocalSource)return a=yield k.queryFeatures(c),e?t.ensureFeaturesJSON(a.features):a.features;yield this._waitForLayerViewUpdate(a);if(e&&"queryFeaturesJSON"in a&&a.queryFeaturesJSON)return{features:e}=yield a.queryFeaturesJSON(c,{signal:d}),e;a=yield a.queryFeatures(c,{signal:d});return e?t.ensureFeaturesJSON(a.features):
a.features});return function(a,c,d,e){return b.apply(this,arguments)}}();n._fetchFeaturesFromService=function(b,a){return this.layer.queryFeatures(b,{signal:a}).then(c=>c.features)};n._fetchFeaturesJSONFromService=function(b,a){return this._fetchFeaturesFromService(b,a).then(t.ensureFeaturesJSON)};n._fetchFeaturesForStats=function(b,a){return I.getFieldsList({field:b.field,normalizationField:b.normalizationField,valueExpression:b.valueExpression}).then(c=>this.getSampleFeatures({sampleSize:-1,view:b.view,
returnGeometry:b.returnGeometry,requiredFields:c,signal:b.signal},a))};n._summaryStatsFromGenRend=function(b){const a=b.normalizationType,c=b.normalizationField;return this.classBreaks({field:b.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:a,normalizationField:"field"===a?c:void 0,minValue:b.minValue,maxValue:b.maxValue,signal:b.signal}).then(d=>{let e,k;d.classBreakInfos.some(f=>{f.hasAvg&&(e=f);return!!e});if(e){var h=e.maxValue-e.minValue;
k=e.minValue+h/2;h*=4}return x.processSummaryStatisticsResult({min:d.minValue,max:d.maxValue,avg:k,stddev:h})})};n._getSummaryStatsQuery=function(b,a){const {field:c,normalizationType:d,normalizationField:e,normalizationTotal:k,minValue:h,maxValue:f}=b;a=this.supportsSQLExpression&&a?t.msSinceUnixEpochSQL(this,c):b.sqlExpression;var g=t.getFieldExpr({field:c,normalizationType:d,normalizationField:e,normalizationTotal:k,layer:this});const l=a||g;g=l?u.getRangeExpr(l,h,f):null;var m=u.getSQLFilterForNormalization({field:c,
normalizationField:e,normalizationType:d});b=u.mergeWhereClauses(b.sqlWhere,m);b=u.mergeWhereClauses(b,g);const q=x.isNullCountSupported({normalizationField:e,normalizationType:d,sqlExpression:a,supportsSQLExpression:this.supportsSQLExpression,minValue:h,maxValue:f}),p=E.isStringField(this.getField(c));g=x.statisticTypes.filter(r=>"nullcount"===r?q:p?"count"===r:!0);m=this.layer.createQuery();m.where=u.mergeWhereClauses(m.where,b);m.sqlFormat=a?"standard":null;m.outStatistics=g.map(r=>{const y=new H;
let z=null,w=null,F=`${r}_value`;"variance"===r?(z="var",w=l):"nullcount"===r?(z="count",w=this.layer.objectIdField,F="totalcount_value"):"median"===r?(z="percentile-continuous",w=l,y.statisticParameters={value:.5}):(z=r,w=l);y.statisticType=z;y.onStatisticField=w;y.outStatisticFieldName=F;return y});return m};n._summaryStatsFromServiceQuery=function(){var b=v._asyncToGenerator(function*(a,c){yield this._isStatsSupportedOnService();"percent-of-total"===a.normalizationType&&(a.normalizationTotal=yield this._getNormalizationTotal(a.field,
a.normalizationType));const d=this._getSummaryStatsQuery(a,c);a=yield this.layer.queryFeatures(d,{signal:a.signal});c=t.getSummaryStatisticsFromFeatureSet(a,c);return x.processSummaryStatisticsResult(c)});return function(a,c){return b.apply(this,arguments)}}();n._summaryStatsFromClientQuery=function(){var b=v._asyncToGenerator(function*(a,c){const d=this._getSummaryStatsQuery(a,c);a=yield this.layer.queryFeatures(d,{signal:a.signal});c=t.getSummaryStatisticsFromFeatureSet(a,c);return x.processSummaryStatisticsResult(c)});
return function(a,c){return b.apply(this,arguments)}}();n._getNormalizationTotalFromMemory=function(){var b=v._asyncToGenerator(function*(a,c,d){const {featuresJSON:e,graphics:k,layerView:h,query:f}=c;a=(!e&&!k&&h&&"querySummaryStatistics"in h?yield h.querySummaryStatistics(f,{field:a},{signal:d}):e?yield this.workerClient.summaryStatistics({field:a},e):yield C.summaryStatistics({attribute:{field:a},features:k})).sum;if(null==a)throw new A("feature-layer-adapter:invalid","invalid normalizationTotal");
return a});return function(a,c,d){return b.apply(this,arguments)}}();n._summaryStatsFromMemory=function(){var b=v._asyncToGenerator(function*(a,c){const {view:d,field:e,valueExpression:k,normalizationType:h,signal:f}=a,g={field:e,valueExpression:k,normalizationType:h,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,minValue:a.minValue,maxValue:a.maxValue},{featuresJSON:l,graphics:m,layerView:q,query:p,fieldInfos:r}=yield this._processStatsFromMemoryParams({...a,layerViewFunc:"querySummaryStatistics"});
k&&d&&(l||m)&&(g.fieldType=null!=c&&c.type?U.kebabDict.toJSON(c.type):null,g.viewInfoParams=t.getViewInfoParams(d),g.fieldInfos=r);"percent-of-total"===h&&null==a.normalizationTotal&&(g.normalizationTotal=yield this._getNormalizationTotalFromMemory(e,{featuresJSON:l,graphics:m,layerView:q,query:p},f));return!l&&!m&&q&&"querySummaryStatistics"in q?q.querySummaryStatistics(p,g,{signal:f}):l?this.workerClient.summaryStatistics(g,l):C.summaryStatistics({attribute:g,features:m})});return function(a,c){return b.apply(this,
arguments)}}();n._processStatsFromMemoryParams=function(){var b=v._asyncToGenerator(function*(a){var c=a.features;if(null!=c&&c.length)return c.length&&"declaredClass"in c[0]&&"esri.Graphic"===c[0].declaredClass?{graphics:c}:{featuresJSON:c};const {view:d,field:e,normalizationField:k,valueExpression:h,returnGeometry:f,layerViewFunc:g,signal:l}=a;let m=c=a=null,q=null,p=null;if(d)try{a=yield d.whenLayerView(this.layer),c=g in a&&"function"===typeof a[g]}catch{c=!1}if(c)try{yield this._waitForLayerViewUpdate(a);
const y=yield I.getFieldsList({field:e,normalizationField:k,valueExpression:h});(yield t.getMissingFields(this,y,a)).length?c=!1:(m=this.layer.createQuery(),m.outFields=y,m.returnGeometry=!1);a.suspended&&(c=!1)}catch{c=!1}if(!c){var r;q=yield this._fetchFeaturesForStats({field:e,valueExpression:h,normalizationField:k,returnGeometry:f,view:d,signal:l},"json");p=(yield I.getFieldsList({valueExpression:h})).map(y=>{var z;return null==(z=this.getField(y))?void 0:z.toJSON()}).filter(Boolean);if(null==
(r=q)||!r.length)throw new A("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");}return{layerView:a,query:m,featuresJSON:q,fieldInfos:p}});return function(a){return b.apply(this,arguments)}}();n._uvFromGenRenderer=function(b,a){const c=b.field,d=new W;d.attributeField=c;const e=new G;e.classificationDefinition=d;return this.generateRenderer(e,b.signal).then(k=>{const h={},f=this.getField(c);k.uniqueValues.forEach(g=>{let l=g.value;if(null==l||""===l||"string"===
typeof l&&(""===l.trim()||"\x3cnull\x3e"===l.toLowerCase()))l=null;null==h[l]?h[l]={count:g.count,data:E.isNumericField(f)&&l?Number(l):l}:h[l].count+=g.count});return{count:h}}).then(k=>x.createUVResult(k,a,b.returnAllCodedValues))};n._getUVQuery=function(b){const a=b.field,c=b.sqlExpression;var d="countOF"+(a||"Expr");const e=new H;e.statisticType="count";e.onStatisticField=c?"1":a;e.outStatisticFieldName=d;d=this.layer.createQuery();d.where=u.mergeWhereClauses(d.where,b.sqlWhere);d.sqlFormat=c?
"standard":null;d.outStatistics=[e];d.groupByFieldsForStatistics=[a||c];return d};n._uvFromServiceQuery=function(b,a){return this._isStatsSupportedOnService().then(()=>this.layer.queryFeatures(this._getUVQuery(b),{signal:b.signal})).then(c=>t.getUniqueValuesFromFeatureSet(c,this,b.field,b.view,null,b.signal)).then(c=>x.createUVResult(c,a,b.returnAllCodedValues))};n._uvFromClientQuery=function(){var b=v._asyncToGenerator(function*(a,c){var {signal:d}=a,e=this._getUVQuery(a);e=yield this.layer.queryFeatures(e,
{signal:d});d=yield t.getUniqueValuesFromFeatureSet(e,this,a.field,a.view,null,d);return x.createUVResult(d,c,a.returnAllCodedValues)});return function(a,c){return b.apply(this,arguments)}}();n._uvFromMemory=function(){var b=v._asyncToGenerator(function*(a,c){const {view:d,field:e,valueExpression:k,returnAllCodedValues:h,signal:f}=a,{featuresJSON:g,graphics:l,layerView:m,query:q,fieldInfos:p}=yield this._processStatsFromMemoryParams({...a,layerViewFunc:"queryUniqueValues"});a={field:e,valueExpression:k,
domain:c,returnAllCodedValues:h};k&&d&&g&&(a.viewInfoParams=t.getViewInfoParams(d),a.fieldInfos=p);return!g&&!l&&m&&"queryUniqueValues"in m?m.queryUniqueValues(q,a,{signal:f}):g?this.workerClient.uniqueValues(a,g):C.uniqueValues({attribute:a,features:l})});return function(a,c){return b.apply(this,arguments)}}();n._calcBinsSQL=function(b,a,c){const d=[],e=a.length;a.forEach((k,h)=>{const [f,g]=k;k=null;k=0!==h||c?h!==e-1||c?u.mergeWhereClauses(`${b} >= ${f}`,`${b} ${h===e-1?" \x3c\x3d ":" \x3c "} ${g}`):
`${b} >= ${f}`:`${b} < ${g}`;d.push("WHEN ("+k+") THEN "+(h+1))});return["CASE",d.join(" "),"ELSE 0 END"].join(" ")};n._getNormalizationTotal=function(b,a,c){return b&&"percent-of-total"===a?this.summaryStatistics({field:b,signal:c}).then(d=>d.sum):Promise.resolve(null)};n._getQueryParamsForExpr=function(b,a){const c=b.signal;if(!b.valueExpression&&!b.sqlExpression){const {field:e,normalizationType:k,normalizationField:h}=b;var d=e?this.getField(e):null;d=E.isDateField(d);a={field:e,normalizationType:k,
normalizationField:h,normalizationTotal:a,layer:this};return{sqlExpression:d?t.msSinceUnixEpochSQL(this,e):t.getFieldExpr(a),sqlWhere:d?null:b.sqlWhere||u.getSQLFilterForNormalization({field:e,normalizationType:k,normalizationField:h}),signal:c}}return{valueExpression:b.valueExpression,sqlExpression:b.sqlExpression,sqlWhere:b.sqlWhere,signal:c}};n._getDataRange=function(b,a,c){return null!=a&&null!=c?Promise.resolve({min:a,max:c}):this.summaryStatistics(b).then(d=>({min:d.min,max:d.max}))};n._histogramForExpr=
function(b){return this._getNormalizationTotal(b.field,b.normalizationType,b.signal).then(a=>{const c=this._getQueryParamsForExpr(b,a);return this._getDataRange(c,b.minValue,b.maxValue).then(d=>{const {min:e,max:k}=d,h=b.numBins||10;d=x.getEqualIntervalBins(e,k,h);d=this._calcBinsSQL(c.sqlExpression,d,null!=b.minValue&&null!=b.maxValue);const f=new H({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),g=this.layer.createQuery();g.where=u.mergeWhereClauses(g.where,c.sqlWhere);
g.sqlFormat="standard";g.outStatistics=[f];g.groupByFieldsForStatistics=[d];g.orderByFields=[d];return this._isStatsSupportedOnService().then(()=>this.layer.queryFeatures(g,{signal:c.signal})).then(l=>t.getHistogramFromFeatureSet(l,e,k,h,a))})})};n._histogramForField=function(b){let a=null;a=null!=b.minValue&&null!=b.maxValue?Promise.resolve({min:b.minValue,max:b.maxValue}):this.summaryStatistics(b).then(c=>{if(!c.count)throw new A("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field");
return{min:c.min,max:c.max}});return a.then(c=>this._getBins({min:c.min,max:c.max},b.field,b.numBins,b.view,b.signal))};n._getBins=function(b,a,c=10,d,e){const {min:k,max:h,normTotal:f,excludeZerosExpr:g}=b,l=b.intervals||x.getEqualIntervalBins(k,h,c);return this._queryBins(l,b.sqlExpr||a,g,d,e).then(m=>({bins:m.map((q,p)=>({minValue:l[p][0],maxValue:l[p][1],count:q.value})),minValue:k,maxValue:h,normalizationTotal:f}))};n._queryBins=function(b,a,c,d,e){const k=[],h=b.length;for(let f=0;f<h;f++){const g=
u.mergeWhereClauses(c,u.mergeWhereClauses(a+" \x3e\x3d "+b[f][0],null!==b[f][1]?a+(f===h-1?" \x3c\x3d ":" \x3c ")+b[f][1]:""));k.push(g)}return B.eachAlways(k.map(f=>this.queryFeatureCount({whereClause:f,view:d,signal:e})))};n._binParamsFromGenRend=function(b,a){const {field:c,normalizationType:d,normalizationField:e,signal:k}=b,h=u.getSQLFilterForNormalization({field:c,normalizationType:d,normalizationField:e});b=new G({classificationDefinition:x.createClassBreaksDefinition({field:c,normalizationType:d,
normalizationField:e,classificationMethod:b.classificationMethod,standardDeviationInterval:b.standardDeviationInterval,breakCount:b.numBins||10}),where:u.mergeWhereClauses(h,a)});return this.generateRenderer(b,k).then(f=>{const {normalizationTotal:g,classBreaks:l}=f;return t.generateBinParams({field:c,normalizationType:d,normalizationField:e,normalizationTotal:g,classBreaks:l,where:h,layer:this})})};n._histogramFromMemory=function(){var b=v._asyncToGenerator(function*(a){const {view:c,field:d,signal:e}=
a,{featuresJSON:k,graphics:h,layerView:f,query:g,fieldInfos:l}=yield this._processStatsFromMemoryParams({...a,layerViewFunc:"queryHistogram"}),m={field:d,valueExpression:a.valueExpression,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,minValue:a.minValue,maxValue:a.maxValue,standardDeviationInterval:a.standardDeviationInterval,classificationMethod:a.classificationMethod,numBins:a.numBins};a.valueExpression&&c&&k&&(m.viewInfoParams=
t.getViewInfoParams(c),m.fieldInfos=l);"percent-of-total"===a.normalizationType&&null==a.normalizationTotal&&(m.normalizationTotal=yield this._getNormalizationTotalFromMemory(d,{featuresJSON:k,graphics:h,layerView:f,query:g},e));return!k&&!h&&f&&"queryHistogram"in f?f.queryHistogram(g,m,{signal:e}):k?this.workerClient.histogram(m,k):C.histogram({attribute:m,features:h})});return function(a){return b.apply(this,arguments)}}();n._classBreaksFromGenRend=function(b){const {field:a,normalizationType:c,
normalizationField:d,normalizationTotal:e,signal:k}=b,h=u.getSQLFilterForNormalization({field:a,normalizationType:c,normalizationField:d});var f=t.getFieldExpr({field:a,normalizationType:c,normalizationField:d,normalizationTotal:e,layer:this});f=u.getRangeExpr(f,b.minValue,b.maxValue);const g=x.createClassBreaksDefinition({field:a,normalizationType:c,normalizationField:d,classificationMethod:b.classificationMethod,standardDeviationInterval:b.standardDeviationInterval,breakCount:b.numClasses||5}),
l=new G;l.classificationDefinition=g;l.where=u.mergeWhereClauses(h,f);return this.generateRenderer(l,k).then(m=>x.resolveCBResult(m,b.classificationMethod))};n._classBreaksFromInterpolation=function(b){const {minValue:a,maxValue:c}=b,d=b.numClasses||5,e=[],k=(c-a)/d;for(let h=0;h<d;h++){const f=a+h*k;e.push({minValue:f,maxValue:f+k})}e[d-1].maxValue=c;b=x.resolveCBResult({classBreaks:e,normalizationTotal:b.normalizationTotal},b.classificationMethod);return Promise.resolve(b)};n._classBreaksFromMemory=
function(){var b=v._asyncToGenerator(function*(a){const {view:c,field:d,signal:e}=a,{featuresJSON:k,graphics:h,layerView:f,query:g,fieldInfos:l}=yield this._processStatsFromMemoryParams({...a,layerViewFunc:"queryClassBreaks"}),m={field:d,valueExpression:a.valueExpression,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,minValue:a.minValue,maxValue:a.maxValue,standardDeviationInterval:a.standardDeviationInterval,classificationMethod:a.classificationMethod,
numClasses:a.numClasses};a.valueExpression&&c&&k&&(m.viewInfoParams=t.getViewInfoParams(c),m.fieldInfos=l);"percent-of-total"===a.normalizationType&&null==a.normalizationTotal&&(m.normalizationTotal=yield this._getNormalizationTotalFromMemory(d,{featuresJSON:k,graphics:h,layerView:f,query:g},e));return!k&&!h&&f&&"queryClassBreaks"in f?f.queryClassBreaks(g,m,{signal:e}):k?this.workerClient.classBreaks(m,k):C.classBreaks({attribute:m,features:h})});return function(a){return b.apply(this,arguments)}}();
n._heatmapStatsFromMemory=function(){var b=v._asyncToGenerator(function*(a,c){var d;const {view:e,field:k,radius:h}=a,{featuresJSON:f,graphics:g}=yield this._processStatsFromMemoryParams({...a,returnGeometry:!0});a=new V({extent:e.extent,tolerance:"2d"===e.type?e.state.resolution:e.pixelSizeAt(e.center)});c={field:k,fieldOffset:c,radius:h,transform:S.toQuantizationTransform(a),spatialReference:null==(d=e.spatialReference)?void 0:d.toJSON(),size:e.size};return null!=f&&f.length||null!=g&&g.length?
f?this.workerClient.heatmapStatistics(c,f):C.heatmapStatistics({attribute:c,features:g}):{count:0,min:null,max:null,avg:null,stddev:null}});return function(a,c){return b.apply(this,arguments)}}();n.getField=function(b=""){return this.layer.getField(b)};n.getFieldUsageInfo=function(b){return this.getField(b)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};n.getFieldDomain=function(b,a){return this.layer.getFieldDomain(b,a)};n.summaryStatistics=
function(b){const {field:a,normalizationType:c,sqlExpression:d,view:e,features:k,useFeaturesInView:h}=b,f=a?this.getField(a):null,g=E.isDateField(f),l=b.valueExpression||d,m=l&&!d,q=e&&"3d"===e.type;return this._hasLocalSource||k||h||m?m||k||h||q?this._summaryStatsFromMemory(b,f):this._summaryStatsFromClientQuery(b,g):this.supportsSQLExpression||!g&&!l&&"natural-log"!==c&&"square-root"!==c?(c&&!this.supportsSQLExpression?this._summaryStatsFromGenRend(b):this._summaryStatsFromServiceQuery(b,g)).catch(()=>
{B.throwIfAborted(b.signal);return this._summaryStatsFromMemory(b,f)}):Promise.reject(new A("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};n.uniqueValues=function(b){const {field:a,valueExpression:c,sqlExpression:d,features:e,useFeaturesInView:k,signal:h}=b,f=(a?this.getField(a):null)&&this.getFieldDomain(a),g=c&&(!d||!this.supportsSQLExpression),l=b.view,m=l&&"3d"===l.type;return this._hasLocalSource||e||k||g?g||e||k||m?this._uvFromMemory(b,
f):this._uvFromClientQuery(b,f):this._uvFromServiceQuery(b,f).catch(q=>{B.throwIfAborted(h);return b.field?this._uvFromGenRenderer(b,f):q}).catch(()=>{B.throwIfAborted(h);return m?this._uvFromMemory(b,f):this._uvFromClientQuery(b,f)})};n.histogram=function(b){const {field:a,normalizationType:c,normalizationField:d,classificationMethod:e,view:k,signal:h}=b;var f=a?this.getField(a):null;f=E.isDateField(f);const g=b.valueExpression||b.sqlExpression,l=g&&!b.sqlExpression,m=this.supportsSQLExpression,
q=!e||"equal-interval"===e,p=b.minValue,r=b.maxValue,y=null!=p&&null!=r,z=b.numBins||10;return this._hasLocalSource||b.features||b.useFeaturesInView||l?this._histogramFromMemory(b):(g||m)&&q?m||!g&&"natural-log"!==c&&"square-root"!==c?this._histogramForExpr(b):Promise.reject(new A("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):f&&q?Promise.reject(new A("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):
c||!q?this._binParamsFromGenRend(b).then(w=>{if(!y)return this._getBins(w,a,z,k,h);if(p>w.max||r<w.min)throw new A("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field");if(q)return this._getBins({min:p,max:r,sqlExpr:w.sqlExpr,excludeZerosExpr:w.excludeZerosExpr},a,z,k,h);w=t.getFieldExpr({field:a,normalizationType:c,normalizationField:d,normalizationTotal:w.normTotal,layer:this});w=u.getRangeExpr(w,p,r);return this._binParamsFromGenRend(b,
w).then(F=>this._getBins(F,a,z,k,h))}):this._histogramForField(b)};n.classBreaks=function(b){const a=!1!==b.analyzeData,c=this._hasLocalSource||b.features||b.useFeaturesInView||b.valueExpression;return a&&c?this._classBreaksFromMemory(b):(a?this._classBreaksFromGenRend(b):this._classBreaksFromInterpolation(b)).catch(()=>{B.throwIfAborted(b.signal);return this._classBreaksFromMemory(b)})};n.queryFeatureCount=function(b){if(this._hasLocalSource)return Promise.reject(new A("feature-layer-adapter:not-supported",
"Layer does not support count query"));const a=this.layer,c=a.createQuery();c.where=u.mergeWhereClauses(c.where,b.whereClause);return a.queryFeatureCount(c,{signal:b.signal})};n.generateRenderer=function(b,a){var c=this.layer;if(this._hasLocalSource||10.1>c.version)return Promise.reject(new A("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));const d=new Z({url:c.parsedUrl.path,source:c.dynamicDataSource,gdbVersion:c.gdbVersion});
c=c.createQuery();b.where=u.mergeWhereClauses(b.where,c.where);return d.execute(b,{signal:a})};n.heatmapStatistics=function(b){const {field:a,fieldOffset:c,view:d,signal:e}=b;return(a&&null==c?this.summaryStatistics({field:a,view:d,signal:e}):Promise.resolve(null)).then(k=>{let h=c||0;if(k){const {count:f,min:g,max:l}=k;f?g===l&&0===g?h=1:0>=l?h="abs":0>g&&(h=-1.01*g):h=1}return this._heatmapStatsFromMemory(b,h).then(f=>({...f,summaryStatistics:k,fieldOffset:h}))})};n.predominantCategories=function(){var b=
v._asyncToGenerator(function*(a){if(!this._hasLocalSource&&!this.supportsSQLExpression)throw new A("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries");const {fields:c,view:d,signal:e}=a;a=N.getArcadeForPredominantCategory(c);const k=N.getSQLForPredominantCategoryName(c);a=d&&this._hasLocalSource?yield this._uvFromMemory({valueExpression:a,view:d,signal:e}):yield this._uvFromServiceQuery({sqlExpression:k.expression,valueExpression:a,signal:e});
return t.getPredominantCategoriesFromUVInfos(a.uniqueValueInfos,c)});return function(a){return b.apply(this,arguments)}}();n.getSampleFeatures=function(){var b=v._asyncToGenerator(function*(a,c){const {view:d,sampleSize:e,requiredFields:k,returnGeometry:h,signal:f}=a,g=this.layer.createQuery(),l="json"===c;g.outSpatialReference=a.spatialReference||d&&d.spatialReference;g.returnGeometry=!!h;g.outFields=k;let m=[],q=!1;if(d)try{const p=yield d.whenLayerView(this.layer);if(q=!(yield t.getMissingFields(this,
k,p)).length)if(m=yield this._fetchFeaturesFromMemory(p,g,f,c),m.length&&0<e&&e<=m.length)return L.pickRandom(m,e,1)}catch(p){B.throwIfAborted(f)}try{if(this._hasLocalSource)return q?m:l?this._fetchFeaturesJSONFromService(g,f):this._fetchFeaturesFromService(g,f);const p=yield this.queryFeatureCount({view:d,signal:f}),r=this.layer.capabilities.query.maxRecordCount;c=-1===e?p:e;c=r&&c>r?r:c;if(p<=m.length||m.length>=r)return m;const y=d.extent.width/d.width/d.scale*4E5;g.maxAllowableOffset=a.resolution||
y;if(p<=c)return l?this._fetchFeaturesJSONFromService(g,f):this._fetchFeaturesFromService(g,f);if(2E4>=p){const z=yield this.layer.queryObjectIds();g.objectIds=L.pickRandom(z,c,1);return l?this._fetchFeaturesJSONFromService(g,f):this._fetchFeaturesFromService(g,f)}this.layer.get("capabilities.query.supportsPagination")&&(g.num=Math.min(c,2E4));return l?this._fetchFeaturesJSONFromService(g,f):this._fetchFeaturesFromService(g,f)}catch(p){return B.throwIfAborted(f),m}});return function(a,c){return b.apply(this,
arguments)}}();n.load=function(b){var a=this;const c=this.layer.load(b).then(function(){var d=v._asyncToGenerator(function*(e){a.geometryType=e.geometryType;a.objectIdField=e.objectIdField;a.supportsSQLExpression=e.get("capabilities.query.supportsSqlExpression");a._hasLocalSource=!e.url&&!!e.source;a.hasQueryEngine=a._hasLocalSource;a.minScale=e.minScale;a.maxScale=e.maxScale;a.fullExtent=e.fullExtent;a.workerClient=X.WorkerClient.getInstance();yield a.workerClient.open(M.unwrap(M.unwrap(b).signal))});
return function(e){return d.apply(this,arguments)}}());this.addResolvingPromise(c);return Promise.resolve(this)};return J}(Y);K.__decorate([Q.property({constructOnly:!0})],D.prototype,"layer",void 0);return D=K.__decorate([R.subclass("esri.smartMapping.support.adapters.FeatureLayerAdapter")],D)});