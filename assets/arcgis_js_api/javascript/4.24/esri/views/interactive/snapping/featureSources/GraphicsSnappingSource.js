// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/HandleOwner ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Polygon ../../../../geometry/projection ../../../../geometry/support/normalizeUtilsSync ../../../../geometry/support/typeUtils ../../../../layers/graphics/featureConversionUtils ../../../../layers/graphics/OptimizedFeature ../../../../layers/graphics/data/FeatureStore ../../../../layers/graphics/data/QueryEngine ../snappingUtils ./queryEngineUtils".split(" "),
function(h,n,l,w,x,y,f,t,m,K,L,z,A,q,B,C,D,E,F,G,H,I){h.GraphicsSnappingSource=function(u){function p(a){a=u.call(this,a)||this;a.availability=1;a.sources={multipoint:null,point:null,polygon:null,polyline:null};a.loadedWkids=new Set;a.loadedWkts=new Set;a.pendingAdds=[];return a}n._inheritsLoose(p,u);var c=p.prototype;c.destroy=function(){const a=this.pendingAdds;this.pendingAdds.length=0;for(const b of a)b.task.abort();this._mapSources(b=>this._destroySource(b))};c.initialize=function(){this.handles.add([this.layer.on("graphic-update",
a=>this._onGraphicUpdate(a)),this.updatingHandles.addOnCollectionChange(()=>this.layer.graphics,a=>this._onGraphicsChanged(a))]);this._addMany(this.layer.graphics.toArray())};c.fetchCandidates=function(){var a=n._asyncToGenerator(function*(b,d){const e=(yield t.eachAlwaysValues(this._mapSources(k=>k.queryEngine.executeQueryForSnapping({point:b.coordinateHelper.vectorToPoint(b.point).toJSON(),distance:b.distance,types:b.types,query:f.isSome(b.filter)?b.filter.createQuery().toJSON():{where:"1\x3d1"}},
d).then(({candidates:g})=>g)))).flat().map(k=>I.convertSnappingCandidate(k,b.coordinateHelper,b.elevationInfo));H.sortCandidatesInPlace(b.point,e);return e});return function(b,d){return a.apply(this,arguments)}}();c.refresh=function(){};c._onGraphicUpdate=function(a){switch(a.property){case "geometry":case "visible":this._remove(a.graphic),this._addMany([a.graphic])}};c._onGraphicsChanged=function(a){for(const b of a.removed)this._remove(b);this._addMany(a.added)};c._addMany=function(a){const b=[],
d=new Map;for(const e of a)f.isNone(e.geometry)||(this._needsInitializeProjection(e.geometry.spatialReference)?(b.push(e.geometry.spatialReference),d.set(e.uid,e)):this._add(e));this._createPendingAdd(b,d)};c._createPendingAdd=function(a,b){var d=this;if(a.length){var e=t.createTask(function(){var J=n._asyncToGenerator(function*(v){yield q.initializeProjection(a.map(r=>({source:r,dest:d.spatialReference})),{signal:v});d._markLoadedSpatialReferences(a);for(const [,r]of b)d._add(r)});return function(v){return J.apply(this,
arguments)}}());this.updatingHandles.addPromise(e.promise);var k={task:e,graphics:b},g=()=>x.removeUnordered(this.pendingAdds,k);e.promise.then(g,g);this.pendingAdds.push(k)}};c._markLoadedSpatialReferences=function(a){for(const b of a)null!=b.wkid&&this.loadedWkids.add(b.wkid),null!=b.wkt&&this.loadedWkts.add(b.wkt)};c._add=function(a){if(!f.isNone(a.geometry)&&a.visible){var b=a.geometry;if("mesh"!==b.type){"extent"===b.type&&(b=A.fromExtent(b));var d=this._ensureSource(b.type);f.isNone(d)||(a=
this._createOptimizedFeature(a.uid,b),f.isSome(a)&&d.featureStore.add(a))}}};c._needsInitializeProjection=function(a){return null!=a.wkid&&this.loadedWkids.has(a.wkid)||null!=a.wkt&&this.loadedWkts.has(a.wkt)?!1:!q.canProjectWithoutEngine(a,this.spatialReference)};c._createOptimizedFeature=function(a,b){return(b=q.project(B.normalizeCentralMeridianForDisplay(b),this.spatialReference))?new E.OptimizedFeature(D.convertFromGeometry(b,!1,!1),{["OBJECTID"]:a},null,a):null};c._ensureSource=function(a){var b=
this.sources[a];if(f.isSome(b))return b;b=this._createSource(a);return this.sources[a]=b};c._createSource=function(a){var b=C.featureGeometryTypeKebabDictionary.toJSON(a);const d=new F({geometryType:b,hasZ:!1,hasM:!1});b=new G.QueryEngine({featureStore:d,fields:[{name:"OBJECTID",type:"esriFieldTypeOID",alias:"OBJECTID"}],geometryType:b,hasM:!1,hasZ:!1,objectIdField:"OBJECTID",spatialReference:this.spatialReference,scheduler:f.isSome(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:
null});return{featureStore:d,queryEngine:b,type:a}};c._remove=function(a){this._mapSources(b=>this._removeFromSource(b,a));for(const b of this.pendingAdds)b.graphics.delete(a.uid),0===b.graphics.size&&b.task.abort()};c._removeFromSource=function(a,b){a.featureStore.has(b.uid)&&a.featureStore.removeById(b.uid)};c._destroySource=function(a){a.queryEngine.destroy();this.sources[a.type]=null};c._mapSources=function(a){const {point:b,polygon:d,polyline:e,multipoint:k}=this.sources,g=[];f.isSome(b)&&g.push(a(b));
f.isSome(d)&&g.push(a(d));f.isSome(e)&&g.push(a(e));f.isSome(k)&&g.push(a(k));return g};n._createClass(p,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"layer",get:function(){return this.layerSource.layer}}]);return p}(y.HandleOwnerMixin(w));l.__decorate([m.property({constructOnly:!0})],h.GraphicsSnappingSource.prototype,"spatialReference",void 0);l.__decorate([m.property({constructOnly:!0})],h.GraphicsSnappingSource.prototype,"layerSource",void 0);l.__decorate([m.property({constructOnly:!0})],
h.GraphicsSnappingSource.prototype,"view",void 0);l.__decorate([m.property({readOnly:!0})],h.GraphicsSnappingSource.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],h.GraphicsSnappingSource.prototype,"availability",void 0);h.GraphicsSnappingSource=l.__decorate([z.subclass("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],h.GraphicsSnappingSource);Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});