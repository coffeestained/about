// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/HandleOwner ../../../core/Handles ../../../core/MapUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3f64 ../../../layers/graphics/data/QueryEngineResult ./SnappingConstraint ./snappingUtils ./candidates/EdgeSnappingCandidate ./candidates/FeatureSnappingCandidate ./candidates/RightAngleSnappingCandidate ../support/viewUtils".split(" "),
function(x,n,y,r,E,F,G,f,A,t,u,Q,R,S,H,I,B,J,K,L,M,C,z){n.FeatureSnappingEngine=function(v){function m(a){a=v.call(this,a)||this;a.options=null;a.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}};return a}y._inheritsLoose(m,v);var g=m.prototype;g.initialize=function(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),t.sync);f.isSome(this.view)&&this.handles.add([this.view.on("layerview-create",
a=>this._updateLayerView(a.layer,a.layerView)),this.view.on("layerview-destroy",a=>this._updateLayerView(a.layer,null))])};g._updateLayerView=function(a,b){for(const [,c]of this.snappingSources)c.snappingSource.layerSource.layer===a&&(c.layerView=b)};g.destroy=function(){this._set("options",null);for(const [,a]of this.snappingSources)a.destroy()};g.fetchCandidates=function(){var a=y._asyncToGenerator(function*(b,c,d){if(f.isNone(this.options)||!this.options.effectiveFeatureEnabled)return[];var e=
[];const l=this._computeScreeenSizeDistanceParameters(b,c),h={distance:l,point:b,coordinateHelper:c.coordinateHelper,types:this.types,filter:null};for(const [,{snappingSource:k,layerView:p}]of this.snappingSources)!k.layerSource.enabled||f.isSome(p)&&p.suspended||e.push(k.fetchCandidates(h,d).then(q=>q.filter(w=>!this._candidateIsExcluded(k,w,c.excludeFeature))));e=(yield A.eachAlwaysValues(e)).flat();this._addRightAngleCandidates(e,b,l,c);A.throwIfAborted(d);K.sortCandidatesInPlace(b,e);return e});
return function(b,c,d){return a.apply(this,arguments)}}();g._addRightAngleCandidates=function(a,b,c,d){var e,l,h,k,p,q,w,D;const N=f.isSome(d.vertexHandle)?null==(e=d.vertexHandle.rightEdge)?void 0:null==(l=e.rightVertex)?void 0:l.pos:f.isSome(d.editGeometryOperations)&&"polygon"===d.editGeometryOperations.data.type?null==(h=f.unwrap(null==(k=d.editGeometryOperations.data.components[0])?void 0:k.getFirstVertex()))?void 0:h.pos:null;e=f.isSome(d.vertexHandle)?null==(p=d.vertexHandle.leftEdge)?void 0:
null==(q=p.leftVertex)?void 0:q.pos:f.isSome(d.editGeometryOperations)?null==(w=f.unwrap(null==(D=d.editGeometryOperations.data.components[0])?void 0:D.getLastVertex()))?void 0:w.pos:null;p=a.length;for(q=0;q<p;q++)this._addRightAngleCandidate(a[q],e,b,c,d,a),this._addRightAngleCandidate(a[q],N,b,c,d,a)};g._addRightAngleCandidate=function(a,b,c,d,e,l){if(!f.isNone(b)&&a instanceof L.EdgeSnappingCandidate){var h=a.constraint.closestTo(b),k=(h[0]-c[0])/d.x;c=(h[1]-c[1])/d.y;1>=k*k+c*c&&(e=e.coordinateHelper,
l.push(new C.RightAngleSnappingCandidate({coordinateHelper:e,targetPoint:h,otherVertex:b,otherVertexType:C.OtherVertexType.NEXT,previousVertex:a.constraint.start,constraint:new J.RayConstraint(e,b,h),objectId:a.objectId,elevationInfo:a.elevationInfo})))}};g._computeScreeenSizeDistanceParameters=function(a,b){const c=f.isSome(this.options)?this.options.distance*("touch"===b.pointer?this.options.touchSensitivityMultiplier:1):0;return f.isNone(this.view)?{x:c,y:c,pixelSize:c}:"2d"===this.view.type?(a=
c*this.view.resolution,{x:a,y:a,pixelSize:a}):this._computeScreenSizeDistanceParameters3D(a,c,this.view,b)};g._computeScreenSizeDistanceParameters3D=function(a,b,c,d){const {coordinateHelper:e,elevationInfo:l}=d,h=c.state.camera.computeScreenPixelSizeAt(z.anyMapPointToRender(a,e,l,c,O)),k=h*c.renderCoordsHelper.unitInMeters/c.mapCoordsHelper.unitInMeters;b*=k;const p=this._computeScreenMagnitudeOfMapOffset(a,k,0,c,d);a=this._computeScreenMagnitudeOfMapOffset(a,0,k,c,d);return{x:b/p,y:b/a,pixelSize:h}};
g._computeScreenMagnitudeOfMapOffset=function(a,b,c,d,{coordinateHelper:e,elevationInfo:l}){const h=e.clone(a);h[0]+=b;h[1]+=c;a=z.anyMapPointToScreenPoint(a,e,l,d);e=z.anyMapPointToScreenPoint(h,e,l,d);d=e.x-a.x;e=e.y-a.y;return Math.sqrt(d*d+e*e)};g._candidateIsExcluded=function(a,b,c){if(f.isNone(c))return!1;b=this._getCandidateObjectId(b);if(f.isNone(b))return!1;a=a.layerSource.layer;return"graphics"===a.type?c.uid===b:c.sourceLayer===a&&c.attributes&&"objectIdField"in a?c.attributes[a.objectIdField]===
b:!1};g._getCandidateObjectId=function(a){return a instanceof M.FeatureSnappingCandidate?a.objectId:null};g._createSourceInfo=function(a){const b=this._createFeatureSnappingSourceType(a);if(f.isNone(b))return null;if("loading"in b)return this.updatingHandles.addPromise(b.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const c=f.isSome(this.view)?this.view.allLayerViews.find(d=>d.layer===a.layer):null;return new P(b.source,c)};g._createFeatureSnappingSourceType=function(a){switch(a.layer.type){case "feature":case "geojson":case "csv":case "subtype-group":case "wfs":return this._createFeatureSnappingSourceFeatureLayer(a);
case "graphics":return this._createFeatureSnappingSourceGraphicsLayer(a)}return null};g._createFeatureSnappingSourceFeatureLayer=function(a){switch(a.layer.source.type){case "feature-layer":var b=this._getSourceModule("featureService");return f.isSome(b.module)?{source:new b.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:a})}:{loading:b.loader};case "memory":case "csv":case "geojson":case "wfs":if("mesh"!==a.layer.geometryType)return b=this._getSourceModule("featureCollection"),
f.isSome(b.module)?{source:new b.module.FeatureCollectionSnappingSource({layerSource:a})}:{loading:b.loader}}return null};g._createFeatureSnappingSourceGraphicsLayer=function(a){const b=this._getSourceModule("graphics");return f.isSome(b.module)?{source:new b.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:a})}:{loading:b.loader}};g._getSourceModule=function(a){const b=this.sourceModules[a];return f.isNone(b.loader)?(a=this._loadSourceModule(a).then(c=>
{b.module=c}),b.loader=a,{module:b.module,loader:a}):{module:b.module,loader:b.loader}};g._loadSourceModule=function(a){switch(a){case "featureService":return this.updatingHandles.addPromise(new Promise((b,c)=>x(["./featureSources/FeatureServiceSnappingSource"],b,c)));case "featureCollection":return this.updatingHandles.addPromise(new Promise((b,c)=>x(["./featureSources/FeatureCollectionSnappingSource"],b,c)));case "graphics":return this.updatingHandles.addPromise(new Promise((b,c)=>x(["./featureSources/GraphicsSnappingSource"],
b,c)))}return null};y._createClass(m,[{key:"updating",get:function(){return G.someMap(this.snappingSources,({snappingSource:a})=>a.updating)||this.updatingHandles.updating}},{key:"snappingSources",get:function(){const a=this._get("snappingSources")||new Map,b=new Map;if(f.isSome(this.options)&&f.isSome(this.options.featureSources))for(const d of this.options.featureSources.items){const e=d.layer.uid;var c=a.get(e);c?(a.delete(e),b.set(e,c)):d.layer.loaded?(c=this._createSourceInfo(d),f.isSome(c)&&
b.set(e,c)):this.updatingHandles.addPromise(d.layer.load())}for(const [,d]of a)d.destroy();return b}},{key:"types",get:function(){return B.SnappingTypes.EDGE|B.SnappingTypes.VERTEX}}]);return m}(E.HandleOwner);r.__decorate([u.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"spatialReference",void 0);r.__decorate([u.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"view",void 0);r.__decorate([u.property()],n.FeatureSnappingEngine.prototype,"options",void 0);r.__decorate([u.property({readOnly:!0})],
n.FeatureSnappingEngine.prototype,"updating",null);r.__decorate([u.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"snappingSources",null);n.FeatureSnappingEngine=r.__decorate([H.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],n.FeatureSnappingEngine);let P=function(){function v(m,g){this.snappingSource=m;this.layerView=g;this.handles=new F;g=this.snappingSource.layerSource.layer;"refresh"in g&&this.handles.add(g.on("refresh",()=>m.refresh()));this.handles.add([t.watch(()=>
m.updating,a=>m.layerSource.updating=a,t.syncAndInitial),t.watch(()=>m.availability,a=>m.layerSource.availability=a,t.syncAndInitial)])}v.prototype.destroy=function(){this.snappingSource.destroy();this.handles.destroy()};return v}();const O=I.create();Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});