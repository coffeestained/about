// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../ViewingMode ./Camera ./Util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),function(O,pa,
W,I,qa,F,J,d,p,G,S,X,Y,ra,sa,t,u,ta,T,ua){function x(y,l){d.set(ca,y[l],y[l+3]);return ca}O.SnapshotSlot=void 0;(function(y){y[y.Highlight=0]="Highlight";y[y.Default=1]="Default"})(O.SnapshotSlot||(O.SnapshotSlot={}));let U=function(){this.camera=new sa.Camera;this.lightMat=J.create()},wa=function(){function y(a,b,e=0){this.rctx=a;this.viewingMode=b;this._enabled=!1;this._snapshots=[];this.maxTextureSize=this._textureSize=0;this.numCascades=1;this.maxNumCascades=4;this.splitSchemeLambda=0;this.warp=
!0;this._cascadeDistances=[0,0,0,0,0];this._usedCascadeDistances=Y.create();this._cascades=[new U,new U,new U,new U];this.maxTextureSize=this.rctx.parameters.maxTextureSize;this.snapshotCount=e}var l=y.prototype;l.dispose=function(){this._discardDepthTexture();this._discardAllSnapshots()};l.getSnapshot=function(a){return this.enabled?this._snapshots[a]:null};l.getCascades=function(){for(let a=0;a<this.numCascades;++a)Z[a]=this._cascades[a];Z.length=this.numCascades;return Z};l.start=function(a,b,
e){t.assert(this.enabled);this._textureSize=this._computeTextureSize(a.fullWidth,a.fullHeight);this._ensureDepthTexture();const {near:g,far:f}=this._clampNearFar(e);this._computeCascadeDistances(f,g);this._setupMatrices(a,b);e=a.viewMatrix;a=a.projectionMatrix;for(let k=0;k<this.numCascades;++k)this._constructCascade(k,a,e,b);this.lastOrigin=null;this.clear()};l.finish=function(a){t.assert(this.enabled);this.rctx.bindFramebuffer(a)};l.getShadowMapMatrices=function(a){if(!this.lastOrigin||!G.exactEquals(a,
this.lastOrigin)){this.lastOrigin=this.lastOrigin||S.create();G.copy(this.lastOrigin,a);for(let b=0;b<this.numCascades;++b){F.translate(da,this._cascades[b].lightMat,a);for(let e=0;16>e;++e)ea[16*b+e]=da[e]}}return ea};l.takeCascadeSnapshotTo=function(a,b){t.assert(this.enabled);var e=this._ensureSnapshot(b);this._bindFbo();b=this.rctx;e=b.bindTexture(e,T.Texture.TEXTURE_UNIT_FOR_UPDATES);b.gl.copyTexSubImage2D(u.TextureType.TEXTURE_2D,0,a.camera.viewport[0],a.camera.viewport[1],a.camera.viewport[0],
a.camera.viewport[1],a.camera.viewport[2],a.camera.viewport[3]);b.bindTexture(e,T.Texture.TEXTURE_UNIT_FOR_UPDATES)};l.clear=function(){const a=this.rctx;this._bindFbo();a.setClearColor(1,1,1,1);a.clearSafe(u.ClearBufferBit.COLOR_BUFFER_BIT|u.ClearBufferBit.DEPTH_BUFFER_BIT)};l._computeTextureSize=function(a,b){return Math.min(this.maxTextureSize,2*2**Math.round(.5*Math.log(a*a+b*b)*Math.LOG2E+.35))};l._ensureDepthTexture=function(){I.isSome(this._depthTexture)&&this._depthTexture.descriptor.width===
this._textureSize||(this._discardDepthTexture(),this._depthTexture=new T.Texture(this.rctx,{target:u.TextureType.TEXTURE_2D,pixelFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:u.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize}),this._fbo=new ta.FramebufferObject(this.rctx,{colorTarget:u.TargetType.TEXTURE,depthStencilTarget:u.DepthStencilTargetType.DEPTH_RENDER_BUFFER,width:this._textureSize,
height:this._textureSize},this._depthTexture))};l._ensureSnapshot=function(a){let b=this._snapshots[a];if(I.isSome(b)&&b.descriptor.width===this._textureSize)return b;this._discardSnapshot(a);b=new T.Texture(this.rctx,{target:u.TextureType.TEXTURE_2D,pixelFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:u.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize});return this._snapshots[a]=b};l._discardDepthTexture=
function(){this._fbo=I.disposeMaybe(this._fbo);this._depthTexture=I.disposeMaybe(this._depthTexture)};l._discardSnapshot=function(a){this._snapshots[a]=I.disposeMaybe(this._snapshots[a])};l._discardAllSnapshots=function(){for(let a=0;a<this.snapshotCount;++a)this._discardSnapshot(a)};l._bindFbo=function(){const a=this.rctx;a.unbindTexture(this._depthTexture);a.bindFramebuffer(this._fbo)};l._constructCascade=function(a,b,e,g){const f=this._cascades[a];var k=-this._cascadeDistances[a],h=-this._cascadeDistances[a+
1];k=(b[10]*k+b[14])/Math.abs(b[11]*k+b[15]);b=(b[10]*h+b[14])/Math.abs(b[11]*h+b[15]);t.assert(k<b);for(h=0;8>h;++h){X.set(fa,0===h%4||3===h%4?-1:1,0===h%4||1===h%4?-1:1,4>h?k:b,1);X.transformMat4(v[h],fa,ha);for(let q=0;3>q;++q)v[h][q]/=v[h][3]}G.negate(aa,v[0]);F.translate(ia,ja,aa);f.camera.viewMatrix=ia;for(k=0;8>k;++k)G.transformMat4(v[k],v[k],f.camera.viewMatrix);G.copy(B,v[0]);G.copy(C,v[0]);for(k=1;8>k;++k)for(b=0;3>b;++b)B[b]=Math.min(B[b],v[k][b]),C[b]=Math.max(C[b],v[k][b]);B[2]-=200;
C[2]+=200;f.camera.near=-C[2];f.camera.far=-B[2];this.warp?this._constructTrapezoidalProjection(e,g,f):this._constructOrthogonalProjection(f);F.multiply(f.lightMat,f.camera.projectionMatrix,f.camera.viewMatrix);e=this._textureSize/2;f.camera.viewport[0]=0===a%2?0:e;f.camera.viewport[1]=0===Math.floor(a/2)?0:e;f.camera.viewport[2]=e;f.camera.viewport[3]=e};l._constructOrthogonalProjection=function(a){F.ortho(a.camera.projectionMatrix,B[0],C[0],B[1],C[1],a.camera.near,a.camera.far)};l._constructTrapezoidalProjection=
function(a,b,e){var g=1/v[0][3],f=1/v[4][3];t.assert(g<f);g+=Math.sqrt(g*f);var k=Math.sin(W.acosClamped(a[2]*b[0]+a[6]*b[1]+a[10]*b[2]));a=v;var h=g/k;b=ka;var q=la,m=va;f=ma;g=na;d.set(z,0,0);for(var r=0;4>r;++r)d.add(z,z,a[r]);d.scale(z,z,.25);d.set(K,0,0);for(r=4;8>r;++r)d.add(K,K,a[r]);d.scale(K,K,.25);d.lerp(H[0],a[4],a[5],.5);d.lerp(H[1],a[5],a[6],.5);d.lerp(H[2],a[6],a[7],.5);d.lerp(H[3],a[7],a[4],.5);r=0;var D=d.squaredDistance(H[0],z);for(var A=1;4>A;++A){var L=d.squaredDistance(H[A],z);
L<D&&(D=L,r=A)}d.subtract(n,H[r],a[r+4]);r=n[0];n[0]=-n[1];n[1]=r;d.subtract(ba,K,z);0>d.dot(ba,n)&&d.negate(n,n);d.lerp(n,n,ba,k);d.normalize(n,n);k=r=d.dot(d.subtract(E,a[0],z),n);for(D=1;8>D;++D)A=d.dot(d.subtract(E,a[D],z),n),A<k?k=A:A>r&&(r=A);d.copy(b,z);d.scale(E,n,k-h);d.add(b,b,E);A=-1;L=1;h=D=0;for(let P=0;8>P;++P){d.subtract(Q,a[P],b);d.normalize(Q,Q);const R=n[0]*Q[1]-n[1]*Q[0];0<R?R>A&&(A=R,D=P):R<L&&(L=R,h=P)}t.verify(0<A,"leftArea");t.verify(0>L,"rightArea");d.scale(M,n,k);d.add(M,
M,z);d.scale(N,n,r);d.add(N,N,z);V[0]=-n[1];V[1]=n[0];q=t.rayRay2D(b,a[h],N,d.add(E,N,V),1,q);m=t.rayRay2D(b,a[D],N,E,1,m);f=t.rayRay2D(b,a[D],M,d.add(E,M,V),1,f);a=t.rayRay2D(b,a[h],M,E,1,g);t.verify(q,"rayRay");t.verify(m,"rayRay");t.verify(f,"rayRay");t.verify(a,"rayRay");m=ka;a=la;b=ma;f=na;g=e.camera.projectionMatrix;d.subtract(w,b,f);d.scale(w,w,.5);c[0]=w[0];c[1]=w[1];c[2]=0;c[3]=w[1];c[4]=-w[0];c[5]=0;c[6]=w[0]*w[0]+w[1]*w[1];c[7]=w[0]*w[1]-w[1]*w[0];c[8]=1;c[6]=-d.dot(x(c,0),m);c[7]=-d.dot(x(c,
1),m);m=d.dot(x(c,0),b)+c[6];q=d.dot(x(c,1),b)+c[7];h=d.dot(x(c,0),f)+c[6];f=d.dot(x(c,1),f)+c[7];m=-(m+h)/(q+f);c[0]+=c[1]*m;c[3]+=c[4]*m;c[6]+=c[7]*m;m=1/(d.dot(x(c,0),b)+c[6]);q=1/(d.dot(x(c,1),b)+c[7]);c[0]*=m;c[3]*=m;c[6]*=m;c[1]*=q;c[4]*=q;c[7]*=q;c[2]=c[1];c[5]=c[4];c[8]=c[7];c[7]+=1;m=d.dot(x(c,1),a)+c[7];q=d.dot(x(c,2),a)+c[8];h=d.dot(x(c,1),b)+c[7];f=d.dot(x(c,2),b)+c[8];m=-.5*(m/q+h/f);c[1]+=c[2]*m;c[4]+=c[5]*m;c[7]+=c[8]*m;m=d.dot(x(c,1),a)+c[7];q=d.dot(x(c,2),a)+c[8];h=-q/m;c[1]*=h;c[4]*=
h;c[7]*=h;g[0]=c[0];g[1]=c[1];g[2]=0;g[3]=c[2];g[4]=c[3];g[5]=c[4];g[6]=0;g[7]=c[5];g[8]=0;g[9]=0;g[10]=1;g[11]=0;g[12]=c[6];g[13]=c[7];g[14]=0;g[15]=c[8];e.camera.projectionMatrix[10]=2/(B[2]-C[2]);e.camera.projectionMatrix[14]=-(B[2]+C[2])/(B[2]-C[2])};l._setupMatrices=function(a,b){F.multiply(oa,a.projectionMatrix,a.viewMatrix);F.invert(ha,oa);a=this.viewingMode===ra.ViewingMode.Global?a.eye:G.set(aa,0,0,1);F.lookAt(ja,[0,0,0],[-b[0],-b[1],-b[2]],a)};l._clampNearFar=function(a){let {near:b,far:e}=
a;2>b&&(b=2);2>e&&(e=2);b>=e&&(b=2,e=4);return{near:b,far:e}};l._computeCascadeDistances=function(a,b){this.numCascades=Math.min(1+Math.floor(t.logWithBase(a/b,4)),this.maxNumCascades);const e=(a-b)/this.numCascades;a=(a/b)**(1/this.numCascades);let g=b;for(let f=0;f<this.numCascades+1;++f)this._cascadeDistances[f]=W.lerp(g,b,this.splitSchemeLambda),g*=a,b+=e};pa._createClass(y,[{key:"depthTexture",get:function(){return this._depthTexture}},{key:"textureSize",get:function(){return this._textureSize}},
{key:"cascadeDistances",get:function(){return X.set(this._usedCascadeDistances,this._cascadeDistances[0],1<this.numCascades?this._cascadeDistances[1]:Infinity,2<this.numCascades?this._cascadeDistances[2]:Infinity,3<this.numCascades?this._cascadeDistances[3]:Infinity)}},{key:"maxCascades",get:function(){return this.maxNumCascades},set:function(a){this.maxNumCascades=W.clamp(Math.floor(a),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(a){this._enabled=a;a||(this._discardDepthTexture(),
this._discardAllSnapshots())}},{key:"ready",get:function(){return this._enabled&&I.isSome(this._depthTexture)}},{key:"snapshotCount",get:function(){return this._snapshots.length},set:function(a){var b=this._snapshots.length;if(a>b){var e=a-b;this._snapshots.length=a;for(a=0;a<e;++a)this._snapshots[b+a]=null}else if(a<this.snapshotCount){b-=a;for(e=0;e<b;++e)this._discardSnapshot(a+e);this._snapshots.length=a}}},{key:"gpuMemoryUsage",get:function(){var a,b;return this._snapshots.reduce((e,g)=>e+ua.getGpuMemoryUsage(g),
null!=(a=null==(b=this._fbo)?void 0:b.gpuMemoryUsage)?a:0)}},{key:"test",get:function(){const a=this;return{maxNumCascades:this.maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(b){a.splitSchemeLambda=b},get splitSchemeLambda(){return a.splitSchemeLambda},set warp(b){a.warp=b},get warp(){return a.warp}}}}]);return y}();const ia=J.create(),oa=J.create(),ha=J.create(),fa=Y.create(),v=[];for(let y=0;8>y;++y)v.push(Y.create());const B=S.create(),C=S.create(),ka=
p.create(),la=p.create(),va=p.create(),ma=p.create(),na=p.create(),ja=J.create(),aa=S.create(),Z=[],da=J.create(),ea=new Float32Array(64),z=p.create(),K=p.create(),H=[p.create(),p.create(),p.create(),p.create()],n=p.create(),ba=p.create(),E=p.create(),Q=p.create(),M=p.create(),N=p.create(),V=p.create(),ca=p.create(),w=p.create(),c=qa.create();O.ShadowMap=wa;Object.defineProperties(O,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});