// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../core/support/WatchUpdatingTracking ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../../../ViewingMode ../../collections/Component/Material/shader/ComponentData.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./edgePreprocessing ./EdgeRenderer ./EdgeShaderParameters ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/VertexArrayObject".split(" "),
function(v,r,z,V,W,X,O,u,Y,A,ra,sa,Z,K,aa,H,E,L,ba,P,ca,da,ea,fa,ha,ia,ja,ka,F,B,Q,R,C,la,ma,I,na,w,oa,M,N,S){function pa(D){let y=null,m=null;for(let a=0;a<D.geometries.length;a++){var b;const c=D.geometryRecords[a];if(c.material.supportsEdges){if(!y)y=c.transformation;else if(!W.equals(y,c.transformation))return!1;if(!m&&u.isSome(c.origin))m=c;else if(u.isSome(null==(b=m)?void 0:b.origin)&&u.isSome(c.origin)&&m.origin.id!==c.origin.id)return!1}}return!0}const qa=X.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");
v.EdgeView=function(D){function y(b){var a=D.call(this,b)||this;a.updatingHandles=new ba.WatchUpdatingTracking;a.perObjectData=new Map;a.perObjectDataEvictionCache=new Set;a.renderers=new Map;a.numberOfRenderedEdges={[I.Transparency.TRANSPARENT]:0,[I.Transparency.OPAQUE]:0};a.gpuMemoryUsage=0;a.workerAbort=new AbortController;a.tmpModelPosition=L.create();a.localOrigins=new ja.LocalOriginManager(new ha.GridLocalOriginFactory(b.renderSR));return a}r._inheritsLoose(y,D);var m=y.prototype;m.initialize=
function(){this.worker=new ma(this.schedule);this.componentColorManager=new oa.BufferManager(this.rctx,3);const b=B.VertexLayout.createBuffer(4);for(let a=0;4>a;a++)b.sideness.set(a,0,0===a||3===a?0:1),b.sideness.set(a,1,0===a||1===a?0:1);this.verticesBufferObject=M.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,b.buffer)};m.destroy=function(){this.destroyed||(this.perObjectData.forEach(b=>this._discardObjectEntry(b)),this.perObjectData.clear(),this.strokesTexture=u.disposeMaybe(this.strokesTexture),
this.componentColorManager=u.destroyMaybe(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=u.disposeMaybe(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())};m.shouldRender=function(){return 0<this.renderers.size};m.addComponentObject=function(){var b=r._asyncToGenerator(function*(a,c,d,e,g,h,f,l){if(this.hasObject(a))return this.getObjectMemoryUsage(a);let k;d=new T(new Promise(n=>k=n),d.center,d.radius);this.perObjectData.set(a,
d);a=yield this.updatingHandles.addPromise(this._addComponentGeometry(c,d,e,g,h,f,l));this.setNeedsRender();k();return a});return function(a,c,d,e,g,h,f,l){return b.apply(this,arguments)}}();m.addOrUpdateObject3D=function(){var b=r._asyncToGenerator(function*(a,c,d,e){if(this.destroyed)qa.warn("Attempt to add an object to a destroyed instance");else{var g=this.perObjectData.get(a);0<(null==g?void 0:g.renderables.length)&&this.perObjectDataEvictionCache.add(g);var h,f=a.boundingVolumeWorldSpace.bounds;
f=new T(new Promise(k=>h=k),P.getCenter(f),P.getRadius(f));this.perObjectData.set(a,f);var l=[];if(d.mergeGeometries&&1<a.geometries.length&&pa(a))l.push(this._addObjectMergedGeometries(a,f,c,d,e));else for(let k=0;k<a.geometries.length;k++){const n=a.geometryRecords[k];n.material.supportsEdges&&l.push(this._addGeometry(a,f,a.geometries[k],n,c[0],d,e))}yield this.updatingHandles.addPromise(Promise.all(l));this.perObjectDataEvictionCache.delete(f);this._discardObjectEntry(g);this.setNeedsRender();
h()}});return function(a,c,d,e){return b.apply(this,arguments)}}();m._discardObjectEntry=function(b){b&&(b.renderables.length&&(b.renderables.forEach(a=>this._removeRenderable(a)),this.setNeedsRender()),b.loaded=null)};m.hasObject=function(b){return this.perObjectData.has(b)};m.updateAllComponentOpacities=function(){var b=r._asyncToGenerator(function*(a,c){const d=c instanceof Array?e=>c[e]:()=>c;(yield this.updatingHandles.addPromise(this._getObjectEntry(a))).renderables.forEach(e=>{const g=e.components.meta.length;
for(let h=0;h<g;h++){const f=d(h),l=e.components.meta[h],k=l.index;l.material.opacity=f;e.components.buffer.textureBuffer.setDataElement(k,1,3,255*f)}this._updateTransparency(e)});this.setNeedsRender()});return function(a,c){return b.apply(this,arguments)}}();m.getObjectMemoryUsage=function(){var b=r._asyncToGenerator(function*(a){return(yield this._getObjectEntry(a)).renderables.reduce((c,d)=>c+d.statistics.gpuMemoryUsage,0)});return function(a){return b.apply(this,arguments)}}();m.updateAllComponentMaterials=
function(){var b=r._asyncToGenerator(function*(a,c,d,e){const g=a instanceof ka.Object3D,h=!!d.hasSlicePlane,f=w.determineRendererType(c),l=C.EdgeRenderer.getKey(f,h,g);(yield this.updatingHandles.addPromise(this._getObjectEntry(a))).renderables.forEach(k=>{if(l!==k.rendererKey){var n=this.renderers.get(k.rendererKey);const p=this._acquireRenderer(f,h,g);n.removeRenderable(k);n.refCount.decrement();k.rendererKey=l;p.addRenderable(k)}for(n=0;n<c.length;n++)k.components.meta[n].material=c[n];e&&this._updateComponentBuffer(k.components);
this._updateTransparency(k)});this.setNeedsRender()});return function(a,c,d,e){return b.apply(this,arguments)}}();m.updateAllVerticalOffsets=function(){var b=r._asyncToGenerator(function*(a,c){(yield this.updatingHandles.addPromise(this._getObjectEntry(a))).renderables.forEach(d=>{const e=d.components.meta;for(let h=0;h<e.length;h++){var g;d.components.meta[h].verticalOffset=null!=(g=null==c?void 0:c[h])?g:0}this._updateComponentBuffer(d.components)});this.setNeedsRender()});return function(a,c){return b.apply(this,
arguments)}}();m.updateObjectVisibility=function(){var b=r._asyncToGenerator(function*(a,c){(yield this.updatingHandles.addPromise(this._getObjectEntry(a))).renderables.forEach(d=>d.visible=c);this.setNeedsRender()});return function(a,c){return b.apply(this,arguments)}}();m.removeObject=function(b){const a=this.perObjectData.get(b);a&&(this.perObjectData.delete(b),this._discardObjectEntry(a))};m._getObjectEntry=function(){var b=r._asyncToGenerator(function*(a){a=this.perObjectData.get(a);if(!a)throw"no object";
yield a.loaded;if(null==a.loaded)throw Y.createAbortError();return a});return function(a){return b.apply(this,arguments)}}();m.removeAll=function(){this.perObjectData.forEach((b,a)=>this.removeObject(a))};m.render=function(b,a){this.numberOfRenderedEdges[a]=0;if(!u.isNone(this.componentColorManager)){this.localOrigins.updateViewMatrices(b.camera.viewMatrix);var c=b.camera.viewInverseTransposeMatrix,d=L.create(),e=new fa.TwoVectorPosition,g=0,h=0;this.renderers.forEach(l=>{0===l.refCount.value?(this.renderers.delete(l.key),
l.dispose()):l.forEachRenderable(k=>{k.visible&&(g+=k.statistics.averageEdgeLength,h++,k.regular&&l.updateTechnique(b,!1),k.silhouette&&l.updateTechnique(b,!0))},a)});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();if(0!==h){var f=new la.EdgePassParameters(40*g/h,b.camera.perScreenPixelRatio,a);E.set(d,c[3],c[7],c[11]);e.set(d);E.copy(f.transformWorldFromViewTH,e.high);E.copy(f.transformWorldFromViewTL,e.low);K.fromMat4(f.transformViewFromCameraRelativeRS,b.camera.viewMatrix);
K.transpose(U,f.transformViewFromCameraRelativeRS);K.invert(f.transformNormalViewFromGlobal,U);f.transformProjFromView=b.camera.projectionMatrix;this._updateObjectCameraDistances(b);this.renderers.forEach(l=>{this._renderRegularEdges(l,b,f);this._renderSilhouetteEdges(l,b,f)})}}};m._updateTransparency=function(b){const a=w.determineEdgeTransparency(b.components.meta),c=w.determineObjectTransparency(b.components.meta);if(a!==b.edgeTransparency||c!==b.objectTransparency)b.edgeTransparency=a,b.objectTransparency=
c,this.renderers.get(b.rendererKey).setRenderablesDirty()};m._computeModelTransformWithLocalOrigin=function(b,a,c){b.getCombinedStaticTransformation(a,c);u.isSome(a.origin)?this.localOrigins.register(a.origin):(b=E.set(this.tmpModelPosition,c[12],c[13],c[14]),a.origin=this.localOrigins.acquire(b));ia.applyToModelMatrix(a.origin.vec3,c);return a.origin};m._updateComponentBuffer=function(b){const {meta:a,buffer:c}=b;b=new Uint8Array(4);for(let e=0;e<a.length;e++){var d=a[e].material;const g=a[e].index,
h=O.clamp(Math.round(d.size*C.LINE_WIDTH_FRACTION_FACTOR),0,255),f=O.clamp(d.extensionLength,-C.EXTENSION_LENGTH_OFFSET,255-C.EXTENSION_LENGTH_OFFSET)+C.EXTENSION_LENGTH_OFFSET,l="solid"===d.type?R.EdgeType.SOLID:R.EdgeType.SKETCH,k=255*d.opacity;d=d.color;c.textureBuffer.setData(g,0,255*d[0],255*d[1],255*d[2],255*d[3]);c.textureBuffer.setData(g,1,h,f,l,k);ea.encodeElevationOffset(a[e].verticalOffset,b);c.textureBuffer.setData(g,2,b[0],b[1],b[2],b[3])}};m._createComponentBuffers=function(b){if(u.isNone(this.componentColorManager))return null;
const a=[],c=this.componentColorManager.getBuffer(b.length);for(let d=0;d<b.length;d++){const e=b[d],g=c.acquireIndex();a.push({index:g,verticalOffset:0,material:e})}b={meta:a,buffer:c};this._updateComponentBuffer(b);return b};m._extractEdges=function(b,a,c,d,e,g=e.length){return this.worker.process({data:a,indices:e,indicesLength:g,writerSettings:b,skipDeduplicate:c},this.workerAbort.signal,d)};m._createEdgeResources=function(b){const a={};if(u.isNone(this.verticesBufferObject))return a;if(0<b.regular.lodInfo.lengths.length){var c=
new S.VertexArrayObject(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:Q.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:M.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,b.regular.instancesData.buffer)});a.regular={vao:c,lod:b.regular.lodInfo}}0<b.silhouette.lodInfo.lengths.length&&(c=new S.VertexArrayObject(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:Q.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,
instances:M.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,b.silhouette.instancesData.buffer)}),a.silhouette={vao:c,lod:b.silhouette.lodInfo});return a};m._addGeometry=function(){var b=r._asyncToGenerator(function*(a,c,d,e,g,h,f){const l=d.vertexAttributes.get(F.VertexAttribute.POSITION),k=d.indices.get(F.VertexAttribute.POSITION),n=H.create();a=this._computeModelTransformWithLocalOrigin(a,e,n);return this._addPositionData(c,{position:l,indices:k,modelTransform:n,origin:a},d.edgeIndicesLength,
g,h,f)});return function(a,c,d,e,g,h,f){return b.apply(this,arguments)}}();m._addPositionData=function(){var b=r._asyncToGenerator(function*(a,c,d,e,g,h=!1){if(null!=a.loaded){var f=this._createComponentBuffers([e]);if(!(u.isNone(f)||0>=d)){e=this._acquireRenderer(e.type,!!g.hasSlicePlane,!0);var {modelTransform:l,origin:k}=c;g=c.indices;c=c.position;var n=c.data.length/c.size,p=B.EdgeInputBufferLayout.createBuffer(n);for(let x=0;x<n;x++)p.position.set(x,0,c.data[x*c.size]),p.position.set(x,1,c.data[x*
c.size+1]),p.position.set(x,2,c.data[x*c.size+2]);w.fillComponenBufferIndices(f.meta,[0,p.componentIndex.count],p.componentIndex);h=yield this.updatingHandles.addPromise(this._extractEdges(e.writerSettings,p,!1,h,g,d));if(null!=a.loaded){var {regular:t,silhouette:q}=this._createEdgeResources(h);d=(t?t.vao.size:0)+(q?q.vao.size:0);f={regular:t,silhouette:q,transform:{modelMatrix:l,origin:k},statistics:{gpuMemoryUsage:d,externalMemoryUsage:!1,averageEdgeLength:h.averageEdgeLength},components:f,visible:!0,
edgeTransparency:w.determineEdgeTransparency(f.meta),objectTransparency:w.determineObjectTransparency(f.meta),distanceToCamera:0,rendererKey:e.key};a.renderables.push(f);e.addRenderable(f);this.gpuMemoryUsage+=d}}}});return function(a,c,d,e,g){return b.apply(this,arguments)}}();m._addComponentGeometry=function(){var b=r._asyncToGenerator(function*(a,c,d,e,g,h,f){if(null==c.loaded)return 0;const l=this._createComponentBuffers(h);if(u.isNone(l))return 0;h=w.determineRendererType(h);f=this._acquireRenderer(h,
f.hasSlicePlane||!1,!1);h=B.EdgeInputBufferLayout.createBuffer(d.count);ca.copy(h.position,d);w.fillComponenBufferIndices(l.meta,g,h.componentIndex,e);e=yield this.updatingHandles.addPromise(this._extractEdges(f.writerSettings,h,!0,!1,e));if(null==c.loaded)return 0;const {regular:k,silhouette:n}=this._createEdgeResources(e);d=(k?k.vao.size:0)+(n?n.vao.size:0);a={regular:k,silhouette:n,transform:a,statistics:{gpuMemoryUsage:d,externalMemoryUsage:!0,averageEdgeLength:e.averageEdgeLength},components:l,
visible:!0,edgeTransparency:w.determineEdgeTransparency(l.meta),objectTransparency:w.determineObjectTransparency(l.meta),distanceToCamera:0,rendererKey:f.key};c.renderables.push(a);f.addRenderable(a);return d});return function(a,c,d,e,g,h,f){return b.apply(this,arguments)}}();m._addObjectMergedGeometries=function(){var b=r._asyncToGenerator(function*(a,c,d,e,g){var h=new Map,f=0,l=null,k=0;for(var n=0;n<a.geometries.length;n++){var p=a.geometries[n],t=a.geometryRecords[n];t.material.supportsEdges&&
(!l&&t.origin&&(l=t),t=p.vertexAttributes.get(F.VertexAttribute.POSITION),k+=t.data.length/t.size,f+=p.edgeIndicesLength)}k=65536<=k?Uint32Array:Uint16Array;f=f?new k(f):null;k=[];n=0;for(p=0;p<a.geometries.length;p++){t=a.geometries[p];if(!a.geometryRecords[p].material.supportsEdges)continue;var q=t.vertexAttributes.get(F.VertexAttribute.POSITION);const x=t.indices.get(F.VertexAttribute.POSITION);let J=h.get(q.data);if(null==J){J=k.length/3;for(let G=0;G<q.data.length;G+=q.size)k.push(q.data[G+0]),
k.push(q.data[G+1]),k.push(q.data[G+2]);h.set(q.data,J)}if(x)for(q=0;q<t.edgeIndicesLength;q++)f[n++]=J+x[q]}l=l||a.geometryRecords[0];h=H.create();l=this._computeModelTransformWithLocalOrigin(a,l,h);for(n=0;n<a.geometryRecords.length;n++)a.geometryRecords[n].origin=l;yield this.updatingHandles.addPromise(this._addPositionData(c,{position:{data:k,size:3},indices:f,modelTransform:h,origin:l},f.length,d[0],e,g))});return function(a,c,d,e,g){return b.apply(this,arguments)}}();m._acquireRenderer=function(b,
a,c){const d=C.EdgeRenderer.getKey(b,a,c);let e=this.renderers.get(d);u.isNone(this.strokesTexture)&&(this.strokesTexture=na.generateStrokesTexture(this.rctx));e||(e=new C.EdgeRenderer(this.rctx,this.techniqueRepository,{type:b,hasSlicePlane:a,strokesTexture:this.strokesTexture,legacy:c,spherical:this.viewingMode===da.ViewingMode.Global}),this.renderers.set(d,e));e.refCount.increment();return e};m._removeRenderable=function(b){b.regular&&(b.regular.vao.vertexBuffers.instances.dispose(),b.regular.vao.dispose(!1),
b.regular.vao=null);b.silhouette&&(b.silhouette.vao.vertexBuffers.instances.dispose(),b.silhouette.vao.dispose(!1),b.silhouette.vao=null);const a=this.renderers.get(b.rendererKey);if(a){a.removeRenderable(b);a.refCount.decrement();"origin"in b.transform&&this.localOrigins.release(b.transform.origin);this.gpuMemoryUsage-=b.statistics.externalMemoryUsage?0:b.statistics.gpuMemoryUsage;for(const c of b.components.meta)b.components.buffer.releaseIndex(c.index)}};m._updateObjectCameraDistances=function(b){const a=
b.camera.eye,c=b.camera.viewForward,d=L.create();b=e=>{const {center:g,radius:h}=e;E.sub(d,g,a);const f=E.dot(d,c),l=f<-h?Infinity:f<h?0:f-h;e.renderables.forEach(k=>k.distanceToCamera=l)};this.perObjectData.forEach(b);this.perObjectDataEvictionCache.forEach(b)};m._renderRegularEdges=function(b,a,c){const d=b.bindRegularEdges(c,a),e=c.transparency;b.forEachRenderable(g=>{if(g.visible&&g.regular){var h=w.computeEdgeCount(g.regular.lod.lengths,g.distanceToCamera,c),f="origin"in g.transform?this.localOrigins.getViewMatrix(g.transform.origin):
H.IDENTITY;b.renderRegularEdges(d,g,a,h,f);this.numberOfRenderedEdges[e]+=h}},e)};m._renderSilhouetteEdges=function(b,a,c){const d=b.bindSilhouetteEdges(c,a),e=c.transparency;b.forEachRenderable(g=>{if(g.visible&&g.silhouette){var h=w.computeEdgeCount(g.silhouette.lod.lengths,g.distanceToCamera,c),f="origin"in g.transform?this.localOrigins.getViewMatrix(g.transform.origin):H.IDENTITY;b.renderSilhouetteEdges(d,g,a,h,f);this.numberOfRenderedEdges[e]+=h}},e)};r._createClass(y,[{key:"updating",get:function(){return this.updatingHandles.updating}},
{key:"usedMemory",get:function(){return this.gpuMemoryUsage}},{key:"numberOfRenderedPrimitives",get:function(){return this.numberOfRenderedEdges[I.Transparency.TRANSPARENT]+this.numberOfRenderedEdges[I.Transparency.OPAQUE]}}]);return y}(V);z.__decorate([A.property({constructOnly:!0})],v.EdgeView.prototype,"rctx",void 0);z.__decorate([A.property({constructOnly:!0})],v.EdgeView.prototype,"renderSR",void 0);z.__decorate([A.property({constructOnly:!0})],v.EdgeView.prototype,"viewingMode",void 0);z.__decorate([A.property({constructOnly:!0})],
v.EdgeView.prototype,"techniqueRepository",void 0);z.__decorate([A.property({constructOnly:!0})],v.EdgeView.prototype,"setNeedsRender",void 0);z.__decorate([A.property({constructOnly:!0})],v.EdgeView.prototype,"schedule",void 0);z.__decorate([A.property({readOnly:!0})],v.EdgeView.prototype,"updatingHandles",void 0);z.__decorate([A.property({readOnly:!0})],v.EdgeView.prototype,"updating",null);v.EdgeView=z.__decorate([Z.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],v.EdgeView);
let T=function(D,y,m){this.center=y;this.radius=m;this.renderables=[];this.loaded=D;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0)})};const U=aa.create();Object.defineProperties(v,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});