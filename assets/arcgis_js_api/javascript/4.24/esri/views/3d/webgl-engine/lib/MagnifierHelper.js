// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../support/requestImageUtils ./DefaultVertexBufferLayouts ./glUtil3D ./Program ./VertexAttribute ../shaders/Magnifier.glsl ../../../magnifier/resources ../../../webgl/enums ../../../webgl/renderState ../../../webgl/Texture".split(" "),
function(p,v,t,F,G,H,B,c,I,J,w,K,x,R,S,T,L,C,M,N,O,P,D,Q,d,y,z){p.MagnifierHelper=function(E){function u(){var a=E.apply(this,arguments)||this;a._handles=new H;a._magnifier=null;a._imageSources=null;a._imageLoadTask=null;a._resources=null;a._passParameters=new D.MagnifierPassParameters;a.events=new G;a.attributeLocations=new Map([[P.VertexAttribute.POSITION,0]]);a.tmpScreenPoint=w.createScreenPointArray();a.tmpRenderPoint=w.createRenderScreenPointArray();return a}v._inheritsLoose(u,E);var m=u.prototype;
m.dispose=function(){this._magnifier=null;this._handles.destroy();c.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null);this._disposeResources()};m.render=function(a,b){var e=this._validMagnifier;if(!c.isNone(e)){var g=b.camera.pixelRatio,n=Math.ceil(g*e.size);this._updateResources(a,n);if(!c.isNone(this._resources)){this._passParameters.maskEnabled=e.maskEnabled;this._passParameters.overlayEnabled=e.overlayEnabled;var f=this._resources.program;a.useProgram(f);
f.bindPass(this._passParameters,b);var k=this._resources.textures,h=Math.ceil(1/this.factor*n);k.input.resize(h,h);var l=b.camera.fullWidth,A=b.camera.fullHeight;w.screenPointObjectToArray(e.position,this.tmpScreenPoint);b=b.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint);var q=.5*h,r=.5*h;b[0]=B.clamp(b[0],q,l-q-1);b[1]=B.clamp(b[1],r,A-r-1);q=Math.floor(b[0]-q);r=Math.floor(b[1]-r);f.bindTexture("textureInput",k.input);a.gl.copyTexImage2D(k.input.descriptor.target,0,k.input.descriptor.pixelFormat,
q,r,h,h,0);h=-1+(b[0]+e.offset.x*g)/l*2;e=-1+(b[1]-e.offset.y*g)/A*2;l=n/l*2;n=n/A*2;a.bindVAO(this._resources.vao);f.bindTexture("textureOverlay",k.overlay);f.bindTexture("textureMask",k.mask);f.setUniform4f("drawPosition",h,e,l,n);a.setPipelineState(this._resources.pipelineState);a.drawArrays(d.PrimitiveType.TRIANGLE_STRIP,0,4)}}};m._updateResourceLoading=function(){var a=this;const b=this._validMagnifier;if(!c.isNone(b)){var e=b.maskUrl,g=b.overlayUrl;!c.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===
e&&this._imageLoadTask.overlayUrl===g||(this._imageLoadTask.task.abort(),this._imageSources=this._imageLoadTask=null);c.isSome(this._imageSources)||c.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:e,overlayUrl:g,task:I.createTask(function(){var n=v._asyncToGenerator(function*(f){const k=c.isNone(e)||c.isNone(g)?Q.loadMagnifierResources(f):null,h=c.isSome(e)?C.requestImage(e,{signal:f}):k.then(l=>l.mask);f=c.isSome(g)?C.requestImage(g,{signal:f}):k.then(l=>l.overlay);a._imageSources={mask:yield h,
overlay:yield f};a._disposeResources();a.events.emit("request-render")});return function(f){return n.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}};m._updateResources=function(a,b){this.enabled?c.isSome(this._resources)?this._resources.textures.size!==b&&(a=this._createTextureResources(a,b),c.isNone(a)?this._disposeResources():(this._disposeTextureResources(this._resources.textures),this._resources.textures=
a)):(b=this._createTextureResources(a,b),c.isNone(b)||(this._resources={textures:b,program:this._createProgram(a),vao:N.createQuadVAO(a,M.Pos2,this.attributeLocations,0,1),pipelineState:y.makePipelineState({blending:y.simpleBlendingParams(d.BlendFactor.ONE,d.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:y.defaultColorWriteParams})})):this._disposeResources()};m._disposeResources=function(){c.isNone(this._resources)||(this._disposeTextureResources(this._resources.textures),
this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)};m._disposeTextureResources=function(a){a.mask.dispose();a.overlay.dispose();a.input.dispose()};m._createTextureResources=function(a,b){if(c.isNone(this._imageSources))return null;this._imageSources.overlay.width=b;this._imageSources.overlay.height=b;this._imageSources.mask.width=b;this._imageSources.mask.height=b;const e=new z.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.RGBA,internalFormat:d.PixelFormat.RGBA,
dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!0,preMultiplyAlpha:K.isSVG(this._imageSources.overlay.src)&&a.driverTest.svgAlwaysPremultipliesAlpha?!1:!0},this._imageSources.overlay),g=new z.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.ALPHA,internalFormat:d.PixelFormat.ALPHA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!0},
this._imageSources.mask);return{input:new z.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.RGBA,internalFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!1}),mask:g,overlay:e,size:b}};m._createProgram=function(a){return new O.Program(a,D.build(),this.attributeLocations)};v._createClass(u,[{key:"updating",get:function(){return c.isNone(this._imageSources)&&c.isSome(this._imageLoadTask)&&
!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(a){a!==this._magnifier&&(this._handles.removeAll(),this._magnifier=a,a=()=>{this._updateResourceLoading();this.events.emit("request-render")},c.isSome(this._magnifier)&&this._handles.add(J.watch(()=>c.applySome(this._magnifier,b=>b.version),a)),a())}},{key:"enabled",get:function(){return c.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return c.isSome(this._magnifier)&&this._magnifier.visible&&
c.isSome(this._magnifier.position)&&0<this._magnifier.size?this._magnifier:null}},{key:"factor",get:function(){return c.isSome(this._magnifier)?this._magnifier.factor||1:1}}]);return u}(F);t.__decorate([x.property()],p.MagnifierHelper.prototype,"_imageSources",void 0);t.__decorate([x.property()],p.MagnifierHelper.prototype,"_imageLoadTask",void 0);t.__decorate([x.property({readOnly:!0})],p.MagnifierHelper.prototype,"updating",null);p.MagnifierHelper=t.__decorate([L.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],
p.MagnifierHelper);Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});