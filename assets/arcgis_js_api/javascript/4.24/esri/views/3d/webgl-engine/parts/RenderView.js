// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/time ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/AutoDisposable ../lib/basicInterfaces ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRepository ../lib/MagnifierHelper ../lib/Renderer ../lib/RenderingContext ../lib/TextureRepository ../materials/StippleTextureRepository ../materials/internal/WaterTextureRepository ./contextCache ./requireUtils ./ScreenshotManager ./testUtils ../../../webgl/context-util".split(" "),
function(f,v,h,C,D,x,E,m,y,F,G,q,X,Y,H,I,J,k,n,K,L,M,N,O,z,P,Q,R,S,T,U,V,W){const A=E.getLogger("esri.views.3d.webgl-engine.parts.View");f.RenderView=function(w){function t(b){var a=w.call(this,{})||this;a.events=new D;a.waterTextureRepository=new R.WaterTextureRepository;a._magnifierHelper=new N.MagnifierHelper;a._needsUpdate=!0;a._needsRender=!0;a._idleSuspend=!0;a._needsWaterReflectionUpdate=!1;a._lastAnimationUpdate=0;a._container=b.container;a._viewingMode=b.viewingMode;a._initializeContext(b);
y.watch(()=>{var c;return null==(c=a.waterTextureRepository)?void 0:c.updating},()=>a.requestRender(),y.initial);a._magnifierHelper.events.on("request-render",()=>a.requestRender());a._stippleTextureRepository=new Q.StippleTextureRepository(a._rctx);a._shaderTechniqueRepository=new J.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:b.viewingMode,stippleTextureRepository:a._stippleTextureRepository,waterTextureRepository:a.waterTextureRepository});a._textureRepository=new P.TextureRepository(b,
a._shaderTechniqueRepository,a._rctx);a._textureRepository.events.on("changed",c=>a.requestRender(c));a._materialRepository=new M.GLMaterialRepository(a._textureRepository,a._shaderTechniqueRepository,()=>a.requestRender(),()=>a.requestRender());a._compositingHelper=new K(a._rctx,a._shaderTechniqueRepository);a._renderer=new O.Renderer(a._materialRepository,a._textureRepository,a._shaderTechniqueRepository,a._rctx,a._compositingHelper,a._magnifierHelper,c=>a.requestRender(c),(c,d)=>b.schedule(c,d),
b);a._screenshotManager=new U.ScreenshotManager(a._rctx,(c,d,e)=>a._renderer.render(c,d,d,e),c=>a.requestRender(c),b.options.screenshot.renderOverlay,c=>a.events.emit("force-camera-for-screenshot",c),()=>a._renderer.disposeOffscreenBuffers());a._registerFrameTask(b);return a}v._inheritsLoose(t,w);var g=t.prototype;g.normalizeCtorArgs=function(){return{}};g.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask=m.removeMaybe(this._frameTask);
this._shaderTechniqueRepository=m.disposeMaybe(this._shaderTechniqueRepository);w.prototype.dispose.call(this);this._rctx=this._tmpDepthBuffer=null};g.requestRender=function(b=n.RenderRequestType.UPDATE){b===n.RenderRequestType.UPDATE?this._needsUpdate=!0:this._needsRender=!0};g.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};g.updateLightSources=function(b,a,c){this._renderer.updateLightSources(b,a,c);this.requestRender()};g.setRenderParameters=function(b){void 0!==b.idleSuspend&&
this._idleSuspend!==!!b.idleSuspend&&(this._idleSuspend=!!b.idleSuspend,this.requestRender());this._renderer.setRenderParameters(b)};g.modify=function(b){this._renderer.modify(b);b.clear()};g.takeScreenshot=function(b){return this._screenshotManager.takeScreenshot(b)};g.getAlpha=function(){return this._rctx.contextAttributes.alpha};g.readAccumulatedShadow=function(b){return this._renderer.readAccumulatedShadow(b[0],b[1])};g.readHUDVisibility=function(b,a,c,d,e){this._renderer.readHUDVisibility(b,
a,c,d,e)};g.getMinimalDepthForArea=function(b,a,c,d,e,l=e){l=d.constrainWindowSize(a,c,e*d.pixelRatio,l*d.pixelRatio);const p=this._ensureDepthBuffer(l);this._renderer.readDepthPixels(d,l,p);e=Number.MAX_VALUE;for(let r=0;r<l[2]*l[3];r++){const u=L.textureToDepth(4*r,p,d.nearFar);e>u&&u!==d.nearFar[0]&&u!==d.nearFar[1]&&(e=u)}m.isSome(b)&&(b=b.pickDepth(a*d.pixelRatio,c*d.pixelRatio,d),m.isSome(b)&&e>b&&b!==d.nearFar[0]&&b!==d.nearFar[1]&&(e=b));return e===Number.MAX_VALUE?void 0:e};g._ensureDepthBuffer=
function(b){b=4*b[2]*b[3];if(m.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<b)this._tmpDepthBuffer=new Uint8Array(b);return this._tmpDepthBuffer};g.reloadShaders=function(){var b=v._asyncToGenerator(function*(){T.removeLoadedShaderModules();yield this._shaderTechniqueRepository.reloadAll();this.requestRender()});return function(){return b.apply(this,arguments)}}();g._registerFrameTask=function(b){const a=b.state,c={viewCamera:a.camera,frameHasDecorations:!1};let d=!1,e=n.RenderRequestType.BACKGROUND,
l=!1;this._frameTask=F.addFrameTask({preRender:p=>{d=this.updating;e=this._needsUpdate?n.RenderRequestType.UPDATE:n.RenderRequestType.BACKGROUND;b.processSyncLayers();const r=G.Milliseconds(p.time-this._lastAnimationUpdate);if(r>this.animationTimestep||m.isSome(this.forcedAnimationTime)||d||this._needsRender)this._renderer.updateAnimation({camera:a.camera,dt:r,forcedTime:this.forcedAnimationTime})&&this.requestRender(n.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=p.time},render:()=>{if((this._needsUpdate||
this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&0<a.camera.fullWidth&&0<a.camera.fullHeight){const p=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=!1;this._renderer.render(null,a.camera,a.contentCamera,n.Decorations.ON);l=!0;p&&this._renderer.hasWaterReflection&&(this.requestRender(n.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},
update:()=>{c.viewCamera=a.camera;c.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled;this._textureRepository.update();this._screenshotManager.update(c)},finish:()=>{l&&(this._renderer.finish(e),l=!1)}})};g._initializeContext=function(b){var a;const c=b.options;this._canvas=c.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const d={alpha:c.alpha||!1,premultipliedAlpha:!0,
antialias:!1,depth:!0,stencil:null==c.stencil?!0:c.stencil,powerPreference:"high-performance",preserveDrawingBuffer:null!=(a=c.preserveDrawingBuffer)?a:!1};a=W.createContextOrErrorHTML("3d",this._canvas,d);m.isNone(a)?(b=x("esri-force-webgl"),A.error("A WebGL context with the requested version ("+b?b:"automatic) could not be created.")):(this._rctx=this._newRenderingContext(a,b),this._loadShaderOnlyExtensions(),!c.alpha&&this._rctx.contextAttributes.alpha&&A.error("WebGL context has alpha channel even though no alpha channel was requested"),
!this._rctx.contextAttributes.alpha&&11<=x("safari")&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))};g._newRenderingContext=function(b,a){const c={disabledExtensions:a.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.options.debugWebGLExtensions||{},maxAnisotropy:8},d=(e,l)=>a.resourceController.memoryController.newCache(e,l);if(V.contextCache.enabled){let e=B.get(b);if(e)return e.configure(c),e.newCache=d,e.ref(),e;e=new z.RenderingContext(b,
c,d);B.set(b,e);e.ref();return e}return new z.RenderingContext(b,c,d)};g._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("standardDerivatives");this._rctx.capabilities.enable("shaderTextureLOD");this._rctx.capabilities.enable("textureFloat")};v._createClass(t,[{key:"performanceInfo",get:function(){const b=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==b.getUsedTextureMemory?b.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==b.getUsedRenderbufferMemory?
b.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==b.getUsedVBOMemory?b.getUsedVBOMemory():void 0}}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},
{key:"magnifier",set:function(b){this._magnifierHelper.magnifier=b}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"shadowsEnabled",get:function(){return this._renderer.shadowsEnabled}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"gpuMemoryUsage",get:function(){return this._renderer.gpuMemoryUsage}},
{key:"animationTimestep",get:function(){return this._renderer.animationTimestep}},{key:"componentObjectCollection",get:function(){m.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new I.ComponentObjectCollection(this._renderer.renderPassManager,this._viewingMode));return this._componentObjectCollection},set:function(b){this._componentObjectCollection=b}}]);return t}(k.AutoDisposableMixin(C));h.__decorate([q.property({type:Boolean,readOnly:!0})],f.RenderView.prototype,"updating",
null);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_rctx",void 0);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_container",void 0);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_canvas",void 0);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_stippleTextureRepository",void 0);h.__decorate([k.autoDispose(),q.property()],f.RenderView.prototype,"waterTextureRepository",void 0);h.__decorate([k.autoDispose(),q.property()],f.RenderView.prototype,"_magnifierHelper",void 0);
h.__decorate([k.autoDispose(),q.property()],f.RenderView.prototype,"_textureRepository",void 0);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_compositingHelper",void 0);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_renderer",void 0);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_screenshotManager",void 0);h.__decorate([k.autoDispose()],f.RenderView.prototype,"componentObjectCollection",null);h.__decorate([k.autoDispose()],f.RenderView.prototype,"_componentObjectCollection",
void 0);h.__decorate([q.property()],f.RenderView.prototype,"_needsUpdate",void 0);h.__decorate([q.property()],f.RenderView.prototype,"_needsWaterReflectionUpdate",void 0);f.RenderView=h.__decorate([H.subclass("esri.views.3d.webgl-engine.parts.RenderView")],f.RenderView);const B=S.getContextCache();Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});