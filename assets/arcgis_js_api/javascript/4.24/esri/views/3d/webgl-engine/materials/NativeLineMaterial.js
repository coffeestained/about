// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../../../geometry/support/buffer/BufferView ../core/shaderLibrary/ShaderOutputOptions ../lib/geometryDataUtils ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./internal/bufferWriterUtils ./internal/DefaultBufferWriter ./internal/MaterialUtil ./renderers/utils ../shaders/NativeLineTechnique ../shaders/NativeLineTechniqueConfiguration".split(" "),
function(M,N,O,H,E,ea,g,w,fa,I,z,l,W,P,ha,ia,X,Q,ja,v,ka,R,la,ma,na,oa){const pa=O.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");var J;(function(n){n[n.START=0]="START";n[n.END=1]="END"})(J||(J={}));O=function(n){function p(a){a=n.call(this,a,new Y)||this;a._techniqueConfig=new oa.NativeLineTechniqueConfiguration;return a}N._inheritsLoose(p,n);var b=p.prototype;b.getConfiguration=function(a,c){this._techniqueConfig.output=a;this._techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane;
this._techniqueConfig.hasVertexColors=this.parameters.hasVertexColors;this._techniqueConfig.transparent=1>this.parameters.color[3]||1>this.parameters.width;this._techniqueConfig.draped=c.slot===Q.RenderSlot.DRAPED_MATERIAL;a=H.isSome(this.parameters.stipplePattern);this._techniqueConfig.stippleEnabled=a;this._techniqueConfig.stippleOffColorEnabled=a&&H.isSome(this.parameters.stippleOffColor);this._techniqueConfig.hasOccludees=this.parameters.hasOccludees;this._techniqueConfig.stipplePreferContinuous=
this.parameters.stipplePreferContinuous;return this._techniqueConfig};b.intersect=function(a,c,d,e,u,h,k,m,f){H.isSome(f)?la.intersectDrapedRenderLineGeometry(a,e,f,h,1,k):this._intersectLineGeometry(a,c,d,e,k)};b._intersectLineGeometry=function(a,c,d,e,u){if(e.options.selectionMode&&!ma.isInstanceHidden(c))if(ja.isTranslationMatrix(d)){var h=a.vertexAttributes.get(v.VertexAttribute.POSITION).data,k=e.camera,m=qa;ea.copy(m,e.point);g.set(G[0],m[0]-2,m[1]+2,0);g.set(G[1],m[0]+2,m[1]+2,0);g.set(G[2],
m[0]+2,m[1]-2,0);g.set(G[3],m[0]-2,m[1]-2,0);for(a=0;4>a;a++)if(!k.unprojectFromRenderScreen(G[a],y[a]))return;l.fromPoints(k.eye,y[0],y[1],S);l.fromPoints(k.eye,y[1],y[2],T);l.fromPoints(k.eye,y[2],y[3],U);l.fromPoints(k.eye,y[3],y[0],V);c=Number.MAX_VALUE;a=0;for(let q=0;q<h.length-5;q+=3)if(r[0]=h[q]+d[12],r[1]=h[q+1]+d[13],r[2]=h[q+2]+d[14],t[0]=h[q+3]+d[12],t[1]=h[q+4]+d[13],t[2]=h[q+5]+d[14],!(0>l.signedDistance(S,r)&&0>l.signedDistance(S,t)||0>l.signedDistance(T,r)&&0>l.signedDistance(T,t)||
0>l.signedDistance(U,r)&&0>l.signedDistance(U,t)||0>l.signedDistance(V,r)&&0>l.signedDistance(V,t))){k.projectToRenderScreen(r,A);k.projectToRenderScreen(t,B);if(0>A[2]&&0<B[2]){g.subtract(x,r,t);var f=k.frustum;f=-l.signedDistance(f[I.PlaneIndex.NEAR],r)/g.dot(x,l.normal(f[I.PlaneIndex.NEAR]));g.scale(x,x,f);g.add(r,r,x);k.projectToRenderScreen(r,A)}else if(0<A[2]&&0>B[2])g.subtract(x,t,r),f=k.frustum,f=-l.signedDistance(f[I.PlaneIndex.NEAR],t)/g.dot(x,l.normal(f[I.PlaneIndex.NEAR])),g.scale(x,x,
f),g.add(t,t,x),k.projectToRenderScreen(t,B);else if(0>A[2]&&0>B[2])continue;A[2]=0;B[2]=0;f=z.distance2(z.fromPoints(A,B,Z),m);f<c&&(c=f,g.copy(aa,r),g.copy(ba,t),a=q/3)}d=e.rayBegin;e=e.rayEnd;4>c&&(c=Number.MAX_VALUE,z.closestLineSegmentPoint(z.fromPoints(aa,ba,Z),z.fromPoints(d,e,ra),C)&&(g.subtract(C,C,d),c=g.length(C),g.scale(C,C,1/c),c/=g.distance(d,e)),u(c,C,a,!1))}else pa.error("intersection assumes a translation-only matrix")};b.computeAttachmentOrigin=function(a,c){a=a.vertexAttributes;
if(!a)return!1;a=a.get(v.VertexAttribute.POSITION);return ha.computeAttachmentOriginLines(a,null,!1,c)};b.requiresSlot=function(a){return a===Q.RenderSlot.OPAQUE_MATERIAL||a===Q.RenderSlot.DRAPED_MATERIAL};b.createGLMaterial=function(a){return a.output===P.ShaderOutput.Color||a.output===P.ShaderOutput.Highlight?new sa(a):null};b.createBufferWriter=function(){const a=this.parameters.hasVertexColors?R.PositionColorLayout:R.PositionLayout;return H.isNone(this.parameters.stipplePattern)?new R.DefaultBufferWriter(a):
new ta(a.clone().vec3f(v.VertexAttribute.AUXPOS1).vec2f(v.VertexAttribute.UV0))};return p}(X.Material);let sa=function(n){function p(){return n.apply(this,arguments)||this}N._inheritsLoose(p,n);var b=p.prototype;b._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})};b.beginSlot=function(a){this._output===P.ShaderOutput.Color&&this._updateOccludeeState(a);return this.ensureTechnique(na.NativeLineTechnique,
a)};return p}(ia),ta=function(){function n(b){this.vertexBufferLayout=b}var p=n.prototype;p.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};p.elementCount=function(b){return b.indices.get(v.VertexAttribute.POSITION).length};p.write=function(b,a,c,d){ka.writeDefaultAttributes(a,this.vertexBufferLayout,b.transformation,b.invTranspTransformation,c,d);this._writeAuxpos1(b,a,c,d);this._writeUV0(b,a,c,d)};p._writeAuxpos1=function(b,a,c,d){var e=c.getField(v.VertexAttribute.AUXPOS1,
W.BufferViewVec3f);c=a.indices.get(v.VertexAttribute.POSITION);a=a.vertexAttributes.get(v.VertexAttribute.POSITION).data;b=b.transformation;const u=e.typedBufferStride;e=e.typedBuffer;d*=u;for(let k=0;k<c.length-1;k+=2)for(const m of[1,0]){var h=3*c[k+m];const f=a[h],q=a[h+1];h=a[h+2];const K=b[1]*f+b[5]*q+b[9]*h+b[13],L=b[2]*f+b[6]*q+b[10]*h+b[14];e[d]=b[0]*f+b[4]*q+b[8]*h+b[12];e[d+1]=K;e[d+2]=L;d+=u}};p._writeUV0=function(b,a,c,d){var e,u=c.getField(v.VertexAttribute.UV0,W.BufferViewVec2f),h=a.indices.get(v.VertexAttribute.POSITION);
c=a.vertexAttributes.get(v.VertexAttribute.POSITION).data;const k=null==(e=a.vertexAttributes.get(v.VertexAttribute.DISTANCETOSTART))?void 0:e.data;b=b.transformation;a=u.typedBufferStride;u=u.typedBuffer;d*=a;let m=0;u[d]=J.START;u[d+1]=m;d+=a;e=3*h[0];e=g.set(r,c[e],c[e+1],c[e+2]);b&&g.transformMat4(e,e,b);const f=t,q=h.length-1;let K=1;const L=k?(F,ca,da)=>m=k[da]:(F,ca,da)=>m+=g.distance(F,ca);for(let F=1;F<q;F+=2){var D=3*h[F];g.set(f,c[D],c[D+1],c[D+2]);b&&g.transformMat4(f,f,b);L(e,f,K++);
for(D=0;2>D;++D)u[d]=1-D,u[d+1]=m,d+=a;g.copy(e,f)}h=3*h[q];g.set(f,c[h],c[h+1],c[h+2]);b&&g.transformMat4(f,f,b);L(e,f,K);u[d]=J.END;u[d+1]=m};return n}(),Y=function(n){function p(){var b=n.apply(this,arguments)||this;b.color=fa.ONES;b.hasVertexColors=!1;b.hasSlicePlane=!1;b.width=1;b.stipplePreferContinuous=!0;b.hasOccludees=!1;return b}N._inheritsLoose(p,n);return p}(X.MaterialParameters);const r=w.create(),t=w.create(),x=w.create(),C=w.create(),A=E.createRenderScreenPointArray3(),B=E.createRenderScreenPointArray3(),
aa=w.create(),ba=w.create(),Z=z.create(),ra=z.create(),qa=w.create(),G=[E.createRenderScreenPointArray3(),E.createRenderScreenPointArray3(),E.createRenderScreenPointArray3(),E.createRenderScreenPointArray3()],y=[w.create(),w.create(),w.create(),w.create()],S=l.create(),T=l.create(),U=l.create(),V=l.create();M.NativeLineMaterial=O;M.Parameters=Y;Object.defineProperties(M,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});