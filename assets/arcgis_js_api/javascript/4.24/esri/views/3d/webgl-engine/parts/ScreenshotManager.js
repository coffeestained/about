// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/promiseUtils ../../../../chunks/vec4f64 ../lib/AutoDisposable ../lib/basicInterfaces ../../../support/screenshotUtils ../../../webgl/enums ../../../webgl/FramebufferObject".split(" "),function(t,w,u,x,y,p,q,n,m,z){p=function(v){function r(b,a,f,c,g,h){var d=v.call(this)||this;d._rctx=b;d._renderScene=a;d._requestRenderScene=f;d._renderOverlay=c;d._forceCameraHook=g;d._disposeOffscreenBuffers=h;d.supersample=
!0;d._screenshotQueue=[];return d}w._inheritsLoose(r,v);var k=r.prototype;k.dispose=function(){this._rctx=null};k.takeScreenshot=function(b){this._requestRenderScene(q.RenderRequestType.BACKGROUND);const a=x.createResolver();this._screenshotQueue.push({settings:b,resolver:a});return a.promise};k.update=function(b){for(const a of this._screenshotQueue){if(this.isDisposed){a.resolver.reject();continue}const f=this._renderScreenshot(b,{...a.settings,pixelRatio:a.settings.pixelRatio*b.viewCamera.pixelRatio});
a.resolver(f)}this._screenshotQueue.length=0};k._renderScreenshotOverlay=function(b,a,f){if(u.isNone(this._renderOverlay))return a;b.width=a.width;b.height=a.height;const c=b.getContext("2d"),g=f.pixelRatio;c.save();c.translate(0,a.height);c.scale(1,-1);f.region&&c.translate(-f.region.x,-f.region.y);c.scale(g,g);a=this._renderOverlay(b,a);c.restore();return a};k._readbackScreenshot=function(b,a){return b.resample?this._readbackScreenshotResampled(b,a):this._readbackScreenshotImmediate(b,a)};k._readbackScreenshotResampled=
function(b,a){const {framebufferWidth:f,framebufferHeight:c,region:g,resample:h}=b,d=this._ensureScreenshotEncodeCanvas();let e=n.createEmptyImageData(f,c,d);this._rctx.gl.readPixels(0,0,f,c,m.PixelFormat.RGBA,m.DataType.UNSIGNED_BYTE,new Uint8Array(e.data.buffer));a();e=this._renderScreenshotOverlay(d,e,{...b,region:null});b=n.createEmptyImageData(g.width,g.height,d);return n.resampleHermite(e,b,!0,h.region.x,c-(h.region.y+h.region.height),h.region.width,h.region.height)};k._readbackScreenshotImmediate=
function(b,a){const {framebufferHeight:f,region:c}=b,g=this._ensureScreenshotEncodeCanvas(),h=n.createEmptyImageData(c.width,c.height,g);this._rctx.gl.readPixels(c.x,f-(c.y+c.height),c.width,c.height,m.PixelFormat.RGBA,m.DataType.UNSIGNED_BYTE,new Uint8Array(h.data.buffer));a();return this._renderScreenshotOverlay(g,h,b)};k._renderScreenshot=function(b,a){let f=null;const c=b.viewCamera,{framebufferWidth:g,framebufferHeight:h}=a;var d=!1;b=a.disableDecorations&&b.frameHasDecorations;var e=a.ignorePadding&&
c.pixelRatio!==a.pixelRatio;if(b=g!==c.fullWidth||h!==c.fullHeight||b||e){e=c.clone();if(a.ignorePadding){d=y.clone(e.padding);for(var l=0;4>l;l++)d[l]=Math.round(d[l]/e.pixelRatio*a.pixelRatio);e.padding=d}e.fullWidth=g;e.fullHeight=h;e.pixelRatio=a.pixelRatio;d=c.fovX-e.fovX;l=c.fovY-e.fovY;0>d&&d<l?e.fovX=c.fovX:0>l&&l<d&&(e.fovY=c.fovY);this._forceCameraHook(e);d=!0;f=new z.FramebufferObject(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:m.TargetType.TEXTURE,depthStencilTarget:m.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER});
this._renderScene(f,e,a.disableDecorations?q.Decorations.OFF:q.Decorations.ON);this._disposeOffscreenBuffers()}e=()=>{this._rctx.bindFramebuffer(null);u.disposeMaybe(f)};a=this._readbackScreenshot(a,e);e();if(b&&!this._rctx.contextAttributes.alpha)for(b=3;b<a.data.length;b+=4)a.data[b]=255;d&&this._forceCameraHook(c);return a};k._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};
return r}(p.AutoDisposable);t.ScreenshotManager=p;Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});