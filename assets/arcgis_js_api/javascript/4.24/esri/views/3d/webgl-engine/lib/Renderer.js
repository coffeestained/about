// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/MapUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/time ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/boundedPlane ../../support/animationUtils ../../support/debugFlags ../core/renderPasses/RenderPassManager ../core/shaderLibrary/hud/HUDUniforms ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./glUtil3D ./Highlight ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderPass ./RenderPluginManager ./RenderSlot ./ShadowAccumulator ./ShadowHighlight ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./edgeRendering/EdgeView ./edgeRendering/interfaces ../materials/renderers/MergedRenderer ../shaders/CompositingTechniqueConfiguration ../statistics/RendererPerformanceInfo ../../../webgl/enums".split(" "),
function(n,P,A,U,V,W,F,t,B,M,C,sa,ta,X,D,G,Y,Q,Z,aa,y,q,ba,R,ca,da,ea,u,fa,ha,ia,p,ja,l,ka,la,N,ma,na,oa,pa,H,qa,I,m,z){n.Renderer=function(r){function L(a,b,d,f,e,h,k,v,x){var c=r.call(this,{})||this;c._materialRepository=a;c._shaderTechniqueRepository=d;c._rctx=f;c._compositingHelper=e;c._magnifierHelper=h;c._requestRender=k;c._stage=x;c._materialRenderers=new Map;c._needsTransparentPass=!1;c._hasHUDElements=!1;c._hasHighlights=!1;c._hasWater=!1;c._hasOverlayWater=!1;c._content=new Map;c._isRendering=
!1;c._fallbackDepthStencilTexture=null;c.performanceInfo=new m.RendererPerformanceInfo;c._antialiasing=q.AntiAliasingMode.SMAA;c._oitEnabled=!1;c._multipassTerrain=!0;c._transparentTerrain=!1;c._hasAnimations=!1;c._animationTimestep=M.Milliseconds(0);c._handles=new W;c._renderHiddenTransparentEdges=()=>{};c._oitUsed=!1;c._smaaPass=new na.SmaaRenderPass(c._rctx,d);c._oitEnabled=c._hasOITSupport;c._requestRender();c._offscreenRendering=new fa.OffscreenRendering(c._rctx,c._compositingHelper);c._sliceHelper=
new ma;c._shadowMap=new N.ShadowMap(c._rctx,x.viewingMode,2);c._ssaoHelper=new oa.SSAOHelper(d,c._rctx,()=>c._requestRender());c._highlight=new ea.Highlight(d,c._rctx);c._shadowHighlight=new la.ShadowHighlight(c._rctx,x.viewingMode);c._shadowAccumulator=new ka.ShadowAccumulator(c._rctx,d,x,w=>{const O=c.shadowsEnabled;c._shadowMap.enabled=!0;c._ensureCameraBindParameters(w.camera,w.contentCamera);c._renderPlugins.prepareRender();c._shadowMap.enabled=O},(w,O,ra)=>{w.shadowMap.start(w.camera,O,ra);
c._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL,w.shadowMap);w.camera.setGLViewport(c._rctx);c._ensureCameraBindParameters(w.camera,w.contentCamera)},()=>c._requestRender());c._renderContext=new ha.RenderContext(c._rctx,c._offscreenRendering,c._shadowMap,c._ssaoHelper,c._sliceHelper);c._renderPlugins=new ja.RenderPluginManager({renderContext:c._renderContext,shaderTechniqueRepository:d,textureRep:b,materialRep:c._materialRepository,requestRender:c._requestRender,schedule:v});c.renderPassManager=
new aa.RenderPassManager(c._rctx,c._shaderTechniqueRepository);c._renderPlugins.add(c.renderPassManager.slots(),c.renderPassManager);c._handles.add([B.watch(()=>c._stage.state.camera,()=>c._requestRender(),B.syncAndInitial),B.watch(()=>Z.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,w=>{c._renderHiddenTransparentEdges=w?()=>c._renderEdges(H.Transparency.TRANSPARENT):()=>{};c._requestRender()},B.initial)]);return c}P._inheritsLoose(L,r);var g=L.prototype;g.normalizeCtorArgs=function(){return{}};g.dispose=function(){this._handles.destroy();
this._smaaPass.dispose();this._materialRenderers.forEach(a=>a.dispose());this._materialRenderers.clear();this._edgeView=t.destroyMaybe(this._edgeView);this._offscreenRendering.dispose();this._fallbackDepthStencilTexture=t.disposeMaybe(this._fallbackDepthStencilTexture);this._shadowMap.enabled=!1;this._shadowMap.dispose();this._ssaoHelper.enabled=!1;this._ssaoHelper.dispose();this._highlight.dispose();this._shadowHighlight.dispose();this._shadowAccumulator.dispose();ba.BoundingInfo.prune();this._content.clear()};
g.disposeOffscreenBuffers=function(){this._offscreenRendering.dispose();this._shadowMap.dispose();this._smaaPass.disable();this._ssaoHelper.disposeOffscreenBuffers()};g.ensureEdgeView=function(){t.isNone(this._edgeView)&&(this._edgeView=new pa.EdgeView({rctx:this._rctx,renderSR:this._stage.renderSR,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:a=>this._stage.resourceController.schedule(a)}),this._handles.add(B.watch(()=>
t.applySome(this._edgeView,a=>a.updating),()=>this._requestRender(),B.sync)),this._requestRender());return this._edgeView};g.setRenderParameters=function(a){const {_shadowMap:b,_ssaoHelper:d,_bindParameters:f}=this;void 0!==a.screenSpaceReflectionsEnabled&&f.ssr.enabled!==a.screenSpaceReflectionsEnabled&&(f.ssr.enabled=a.screenSpaceReflectionsEnabled,this._requestRender());void 0!==a.shadowMap&&b.enabled!==a.shadowMap&&(b.enabled=a.shadowMap,this._requestRender());void 0!==a.shadowMapMaxCascades&&
b.maxCascades!==a.shadowMapMaxCascades&&(b.maxCascades=a.shadowMapMaxCascades,this._requestRender());if(t.isSome(a.environment)){t.isSome(a.environment.weather)&&(this._bindParameters.weather=a.environment.weather,this._bindParameters.weatherVisible=a.weatherVisible,this._renderContext.bindParameters.weather=a.environment.weather,this._renderContext.bindParameters.weatherVisible=a.weatherVisible);void 0!==a.environment.lighting.ambientOcclusionEnabled&&d.enabled!==a.environment.lighting.ambientOcclusionEnabled&&
(d.enabled=a.environment.lighting.ambientOcclusionEnabled,this._requestRender());void 0!==a.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==a.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=a.environment.lighting.waterReflectionEnabled,this._requestRender());var e="sun"===a.environment.lighting.type;f.enableFillLights!==e&&(f.enableFillLights=e,this._requestRender())}a.background&&this._offscreenRendering.background!==a.background&&(this._offscreenRendering.background=
a.background,this._requestRender());e=a.antialiasingEnabled?q.AntiAliasingMode.SMAA:q.AntiAliasingMode.NONE;void 0!==a.antialiasingEnabled&&this._antialiasing!==e&&(this._antialiasing=e,this._requestRender());void 0!==a.highQualityTransparency&&this._multipassTerrain!==a.highQualityTransparency&&(this._oitEnabled=(this._multipassTerrain=a.highQualityTransparency)&&this._hasOITSupport,this._requestRender());void 0!==a.defaultHighlightOptions&&(this._highlight.setDefaultOptions(a.defaultHighlightOptions),
this._shadowHighlight.setDefaultOptions(a.defaultHighlightOptions),this._requestRender());void 0!==a.overlays&&this._bindParameters.overlays!==a.overlays&&(this._bindParameters.overlays=a.overlays,this._requestRender());void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=t.unwrap(a.slicePlane),this._requestRender());void 0!==a.transparentTerrain&&this._transparentTerrain!==a.transparentTerrain&&(this._transparentTerrain=a.transparentTerrain,this._requestRender());
void 0!==a.hasOverlayWater&&this._hasOverlayWater!==a.hasOverlayWater&&(this._hasOverlayWater=a.hasOverlayWater,this._requestRender());void 0!==a.shadowCastOptions&&this._shadowAccumulator.setOptions(a.shadowCastOptions)};g.modify=function(a){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:b,removes:d,updates:f}=a;if(0!==b.length||0!==d.length||0!==f.length){d.forAll(({id:h})=>this._content.delete(h));b.forAll(h=>this._content.set(h.id,h));var e=!1;ia.splitRenderGeometryChangeSetByMaterial(a).forEach((h,
k)=>{let v=this._materialRenderers.get(k);if(!v)if(0<h.adds.length)v=new qa.MergedRenderer(this._rctx,this._materialRepository,k),this._materialRenderers.set(k,v);else return;v.modify(h);v.isEmpty&&(e=!0)});e&&this._materialRenderers.forEach((h,k)=>{h.isEmpty&&(this._materialRenderers.delete(k),h.dispose())});this._hasHighlights=F.someMap(this._materialRenderers,h=>h.hasHighlights);this._bindParameters.hasOccludees=F.someMap(this._materialRenderers,h=>h.hasOccludees);this._hasWater=F.someMap(this._materialRenderers,
h=>h.hasWater);this._needsTransparentPass=F.someMap(this._materialRenderers,h=>h.requiresSlot(l.RenderSlot.TRANSPARENT_MATERIAL,p.RenderPass.MATERIAL));this._hasHUDElements=F.someMap(this._materialRenderers,h=>h.requiresSlot(l.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,p.RenderPass.MATERIAL)||h.requiresSlot(l.RenderSlot.HUD_MATERIAL,p.RenderPass.MATERIAL)||h.requiresSlot(l.RenderSlot.LABEL_MATERIAL,p.RenderPass.MATERIAL));this._requestRender()}};g.updateAnimation=function(a){this._hasAnimations=!1;this._materialRenderers.forEach(b=>
this._hasAnimations=b.updateAnimation(a)||this._hasAnimations);return this._hasAnimations=this._renderPlugins.updateAnimation(a)||this._hasAnimations};g.updateLightSources=function(a,b,d){this._bindParameters.lighting.groundLightingFactor=b;this._bindParameters.lighting.globalFactor=d;this._bindParameters.lighting.set(a)};g.render=function(a,b,d,f){this._isRendering=!0;this.performanceInfo.prerender(this._rctx);this._bindParameters.transparencyPassType=q.TransparencyPassType.NONE;var e=this._offscreenRendering;
e.needLastFrameColorTexture=this.hasWaterReflection;e.advanceCurrentRenderTarget();const h=Y.create(this._sliceHelper.plane);f===q.Decorations.OFF&&(this._sliceHelper.plane=null);this._rctx.bindFramebuffer(a);b.setGLViewport(this._rctx);this._ensureCameraBindParameters(b,d);this._renderPlugins.prepareRender();this.performanceInfo.advance(m.Statistics.Prepare);var k=this._computeDepthRange(b);this._renderShadowMap(a,b,this._bindParameters.lighting.lightingMainDirection,k);this.performanceInfo.advance(m.Statistics.Shadowmap);
e.initializeFrame(b);this._ensureBindParameters(b,d);this._renderLinearDepth();this.performanceInfo.advance(m.Statistics.Lineardepth);this._accumulateShadows(k,b,d);this._renderNormal();this.performanceInfo.advance(m.Statistics.Normals);this._ensureBindParametersSSR();this._ssaoHelper.computeSSAO(this._bindParameters,e.linearDepthTexture,e.normalTexture);this.performanceInfo.advance(m.Statistics.SSAO);this._renderContext.pass=p.RenderPass.MATERIAL;e.bindFramebuffer();this._renderOpaqueGeometry();
this.performanceInfo.advance(m.Statistics.Opaque);b=this._multipassTerrain&&this._transparentTerrain;this._renderTerrainLinearDepth(b);this._setMultipassEnabled(b);this._setTerrainCulling(b);this._renderEdges(H.Transparency.OPAQUE);this.performanceInfo.advance(m.Statistics.OpaqueEdges);this._offscreenRendering.bindTarget(this._offscreenRendering.currentColorTarget,this._offscreenRendering.mainDepth);this._renderSlot(l.RenderSlot.VOXEL);this._renderHiddenTransparentEdges();(d=this._needsTransparentPass||
this._renderPlugins.needsTransparentPass)&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry());this.performanceInfo.advance(m.Statistics.Transparent);this._renderGeometryLinearDepth(b);k=this._renderHUDVisibility();b||this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS);this.performanceInfo.advance(m.Statistics.Hudvisibility);this._renderEdges(H.Transparency.TRANSPARENT,b);this.performanceInfo.advance(m.Statistics.TransparentEdges);
this._renderTransparentTerrain();this._transparentTerrain&&k&&(b?this._renderLineCallouts(y.HUDTransparentRenderStyle.Occluded):e.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(y.HUDTransparentRenderStyle.Occluded,e.framebuffer),this.performanceInfo.advance(m.Statistics.HudOccluded));this.performanceInfo.advance(m.Statistics.TransparentTerrain);this._setTerrainCulling(!1);this._transparentTerrain&&(e.compositeTransparentTerrainOntoMain(this._bindParameters),b&&
(this._renderEdges(H.Transparency.OPAQUE),this.performanceInfo.advance(m.Statistics.OpaqueEdges),d&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(m.Statistics.Transparent),this._renderEdges(H.Transparency.TRANSPARENT),this.performanceInfo.advance(m.Statistics.TransparentEdges)));b&&this._renderLineCallouts(y.HUDTransparentRenderStyle.NotOccluded);this._setMultipassEnabled(!1);this._shadowAccumulator.render(this._bindParameters);
e.renderToTargets(()=>{this._renderInternalSlot(l.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);this._renderSlot(l.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT);this._renderSlot(l.RenderSlot.LASERLINES)},e.currentColorTarget,e.mainDepth);this.performanceInfo.advance(m.Statistics.Atmosphere);this._renderPlugins.needsLaserlineWithContrastControl&&e.renderTmpAndCompositeToMain(()=>this._renderSlot(l.RenderSlot.LASERLINES_CONTRAST_CONTROL),this._bindParameters,I.AlphaMode.PremultipliedAlpha);
this.performanceInfo.advance(m.Statistics.Laserline);this._renderOccluded();this.performanceInfo.advance(m.Statistics.Occluded);e=(f=f===q.Decorations.ON&&this._magnifierHelper.enabled)&&t.isNone(a)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):a;this._rctx.bindFramebuffer(e);b=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(this._antialiasing,b)&&t.isSome(b)&&this._compositingHelper.composite(this._bindParameters,b,I.AlphaMode.None);
this.performanceInfo.advance(m.Statistics.Antialiasing);this._renderHUD(y.HUDTransparentRenderStyle.NotOccluded,e);this.performanceInfo.advance(m.Statistics.HudNotoccluded);this._renderHighlights(e,this._bindParameters);this.performanceInfo.advance(m.Statistics.Highlights);f&&this._magnifierHelper.render(this._rctx,this._bindParameters);e!==a&&(this._rctx.bindFramebuffer(a),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.tmpColorTexture,I.AlphaMode.None));this._disposeOITBuffers();
this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera);this._sliceHelper.plane=h;this._isRendering=!1;if(this.onPostRender)this.onPostRender();this.performanceInfo.postrender()};g.finish=function(a){this._hasAnimations||(this._animationTimestep=M.Milliseconds(0));a===q.RenderRequestType.BACKGROUND&&(this._rctx.gl.getError(),this._animationTimestep=M.Milliseconds(Math.max(.9*this._animationTimestep+this.performanceInfo.elapsedTime/Q.MAXIMUM_ANIMATION_LOAD*(1-.9),Q.MINIMUM_IDLE_ANIMATION_MS)))};
g.readDepthPixels=function(a,b,d){const f=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);this._needsLinearDepth||(this._ensureBindParameters(a,a),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(z.ClearBufferBit.COLOR_BUFFER_BIT|z.ClearBufferBit.DEPTH_BUFFER_BIT|z.ClearBufferBit.STENCIL_BUFFER_BIT),this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_DEPTH));f.readPixels(b[0],
b[1],b[2],b[3],z.PixelFormat.RGBA,z.PixelType.UNSIGNED_BYTE,d)};g.readHUDVisibility=function(a,b,d,f,e){this._offscreenRendering.bindTarget(this._offscreenRendering.hudVisibility).readPixels(a,b,d,f,z.PixelFormat.RGBA,z.PixelType.UNSIGNED_BYTE,e)};g.readAccumulatedShadow=function(a,b){return this._shadowAccumulator.readAccumulatedShadow(a,b)};g._setMultipassEnabled=function(a){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=a};g._setTerrainCulling=function(a){this._bindParameters.multipassTerrain.cullAboveGround=
a};g._renderSlot=function(a){this._bindParameters.slot=a;this._renderPlugins.render()};g._renderEdges=function(a,b=!1){const d=this._edgeView;t.isSome(d)&&d.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>d.render(this._bindParameters,a),this._bindParameters,I.AlphaMode.Alpha,b)};g._renderShadowMap=function(a,b,d,f){const e=this._shadowMap;e.enabled&&(e.start(b,d,f),this._shadowHighlight.updateParameters(b,d),this.needsShadowHighlight?(this._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,
this._shadowMap,h=>e.takeCascadeSnapshotTo(h,N.SnapshotSlot.Highlight)),e.clear(),this._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,this._shadowMap,h=>{e.takeCascadeSnapshotTo(h,N.SnapshotSlot.Default);this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT)})):this._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL),e.finish(a),b.setGLViewport(this._rctx))};g._renderShadowCascades=function(a,b=this._shadowMap,d=f=>{}){for(const f of b.getCascades())f.camera.setGLViewport(this._rctx),
this._ensureCameraBindParameters(f.camera,f.camera),this._renderGeometryAndTransparentTerrainPass(a),d(f)};g._renderLinearDepth=function(){this._needsLinearDepth?this._offscreenRendering.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_DEPTH),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth);this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture};
g._renderTerrainLinearDepth=function(a){a?(a=this._renderContext.pass,this._renderContext.pass=p.RenderPass.MATERIAL_DEPTH,this._offscreenRendering.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1E10,-1E10,-1E10,1],!0,!0),this._renderContext.pass=a):this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture};
g._renderGeometryLinearDepth=function(a){a?(a=this._renderContext.pass,this._offscreenRendering.renderToTargets(()=>this._renderGeometryPass(p.RenderPass.MATERIAL_DEPTH),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=a):this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture};g._renderNormal=
function(){this.needsNormal?this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_NORMAL)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};g._computeDepthRange=function(a){if(!this.needsDepthRange)return R.ZERO;const b=ca.depthRangeFromScene(a,this._content,this._stage.layers);R.union(b,this.renderPlugins.queryDepthRange(a));b.near=
Math.max(a.near,b.near);b.far=Math.min(a.far,b.far);return b};g._renderGeometryAndTransparentTerrainPass=function(a){this._renderContext.pass=a;this._renderGeometryPass(a);this._renderTransparentTerrain()};g._renderGeometryPass=function(a){this._renderContext.pass=a;this._renderOpaqueGeometry();this._renderTransparentGeometry()};g._renderOpaqueGeometry=function(){this._renderSlot(l.RenderSlot.INTEGRATED_MESH);this._renderSlot(l.RenderSlot.OPAQUE_TERRAIN);this._renderInternalSlot(l.RenderSlot.OPAQUE_MATERIAL);
this._renderSlot(l.RenderSlot.OPAQUE_MATERIAL);this._renderSlot(l.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)};g._renderTransparentGeometry=function(){this._renderInternalSlot(l.RenderSlot.TRANSPARENT_MATERIAL);this._renderSlot(l.RenderSlot.TRANSPARENT_MATERIAL)};g._renderTransparentTerrain=function(){this._renderSlot(l.RenderSlot.TRANSPARENT_TERRAIN)};g._renderHUDVisibility=function(){let a=!1;this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>
{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture;a=this._renderInternalSlot(l.RenderSlot.OCCLUSION_PIXELS)},this._multipassTerrain&&this._transparentTerrain);return a};g._renderLineCallouts=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;a===y.HUDTransparentRenderStyle.Occluded?this._offscreenRendering.renderToTargets(()=>this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,
void 0,!0,!0):this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS)};g._renderHUD=function(a,b){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(a),!0),this._rctx.bindFramebuffer(b),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.hudColorTexture,I.AlphaMode.PremultipliedAlpha)):a===y.HUDTransparentRenderStyle.Occluded?this._offscreenRendering.renderToTargets(()=>this._renderHUDElements(y.HUDTransparentRenderStyle.Occluded),
this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(a))};g._renderHUDElements=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS_HUD_DEPTH);this._renderInternalSlot(l.RenderSlot.HUD_MATERIAL);this._renderInternalSlot(l.RenderSlot.LABEL_MATERIAL)};g._renderHighlights=function(a,b){if(this.needsHighlight){var d=this._highlight,f=this._offscreenRendering.renderToTargets(()=>
{this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_HIGHLIGHT);this._rctx.clearSafe(z.ClearBufferBit.DEPTH_BUFFER_BIT);this._renderHUDElements(y.HUDTransparentRenderStyle.Both)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=f.colorTexture;this.needsShadowHighlight&&this._shadowHighlight.render(b,a);d.render(this._bindParameters,f,a)}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};
g._accumulateShadows=function(a,b,d){this.needsShadowCast&&this._shadowAccumulator.renderAccumulation(this._offscreenRendering.linearDepthTexture,a,b,d)};g._renderOrderIndependentTransparency=function(a,b){const d=e=>{this._bindParameters.transparencyPassType=e;this._offscreenRendering.renderOITPass(()=>a(),e,b)},f=this._renderContext.pass;this._renderContext.pass=p.RenderPass.MATERIAL_ALPHA;d(q.TransparencyPassType.Alpha);this._renderContext.pass=p.RenderPass.MATERIAL;d(q.TransparencyPassType.Color);
d(q.TransparencyPassType.FrontFace);this._offscreenRendering.compositeTransparentOntoOpaque(this._bindParameters,b);this._bindParameters.transparencyPassType=q.TransparencyPassType.NONE;this._renderContext.pass=f;this._oitUsed=!0};g._disposeOITBuffers=function(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget));
this._oitUsed=!1};g._renderOccluded=function(){let a=0;this._materialRenderers.forEach((h,k)=>{k&&k.isVisible()&&k.renderOccluded===u.RenderOccludedFlag.OccludeAndTransparentStencil&&(a|=k.renderOccluded,J.push(k))});const b=this._offscreenRendering,d=(h,k,v,x,c)=>{0!==(a&k)&&(b.renderToTargets(v,b.tmpColor,b.mainDepth,[0,0,0,0],x,c),b.compositeOccludedOntoMain(this._bindParameters,h))};0!==J.length&&(this._renderInternalSlot(l.RenderSlot.OCCLUDER_MATERIAL,J),d(.5,u.RenderOccludedFlag.OccludeAndTransparentStencil,
()=>this._renderInternalSlot(l.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,J),!1,!1),J.length=0);this._materialRenderers.forEach((h,k)=>{k&&k.isVisible()&&(k.renderOccluded===u.RenderOccludedFlag.OccludeAndTransparent||k.renderOccluded===u.RenderOccludedFlag.Transparent||k.renderOccluded===u.RenderOccludedFlag.Opaque)&&(a|=k.renderOccluded,K.push(k))});const f=this._renderPlugins.renderOccludedFlags;if(a|=f){var e=h=>{this._renderContext.renderOccludedMask=h;f>u.RenderOccludedFlag.Occlude&&this._renderSlot(l.RenderSlot.OCCLUDED_TERRAIN);
this._renderInternalSlot(l.RenderSlot.OPAQUE_MATERIAL,K);this._renderInternalSlot(l.RenderSlot.TRANSPARENT_MATERIAL,K);this._renderInternalSlot(l.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,K);this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=p.RenderPass.MATERIAL;d(.5,u.RenderOccludedFlag.OccludeAndTransparent,()=>e(u.RenderOccludedFlag.OccludeAndTransparent),!0,q.StencilBits.OutlineVisualElementMask);d(.5,u.RenderOccludedFlag.Transparent,()=>e(u.RenderOccludedFlag.Transparent),
!0,q.StencilBits.OutlineVisualElementMask);d(1,u.RenderOccludedFlag.Opaque,()=>e(u.RenderOccludedFlag.Opaque),!0,q.StencilBits.OutlineVisualElementMask);K.length=0}};g._renderAntiAliasing=function(a,b){if(a===q.AntiAliasingMode.SMAA){if(this._smaaPass.enable(()=>this._requestRender())&&t.isSome(b))return this._smaaPass.render(b),!0}else this._smaaPass.disable();return!1};g._ensureCameraBindParameters=function(a,b){this._bindParameters.camera=a;this._bindParameters.contentCamera=b};g._ensureBindParameters=
function(a,b){var d;this._ensureCameraBindParameters(a,b);a=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=a.hudVisibilityTexture;this._bindParameters.highlightDepthTexture=null!=(d=a.depthTexture)?d:this._getFallbackDepthTexture()};g._ensureBindParametersSSR=function(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=G.IDENTITY:(D.invert(S,this._bindParameters.camera.viewMatrix),D.invert(T,
this._bindParameters.camera.projectionMatrix),D.multiply(E,S,T),D.multiply(E,this._renderContext.lastFrameCamera.viewMatrix,E),D.multiply(E,this._renderContext.lastFrameCamera.projectionMatrix,E),this._reprojectionMatrix=E),this._bindParameters.ssr.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._bindParameters.ssr.lastFrameColorTexture=null;this._bindParameters.ssr.enabled=this.hasWaterReflection};g._renderInternalSlot=function(a,b){let d=!1;this._bindParameters.slot=a;
t.isSome(b)?b.forEach(f=>{f.shouldRender(this._renderContext)&&(f=this._materialRenderers.get(f),t.isSome(f)&&(d=f.render(this._renderContext.pass,this._bindParameters)||d))}):this._materialRenderers.forEach((f,e)=>{e.shouldRender(this._renderContext)&&f.render(this._renderContext.pass,this._bindParameters)&&(d=!0)});return d};g._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=da.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};
P._createClass(L,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"hasWaterReflection",get:function(){return this.hasWater&&this._waterReflectionEnabled}},{key:"updating",get:function(){return this._antialiasing===q.AntiAliasingMode.SMAA&&this._smaaPass.updating||t.isSome(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"edgeView",
get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return D.equals(this._bindParameters.ssr.reprojectionMatrix,G.IDENTITY)}},{key:"_reprojectionMatrix",set:function(a){V.update(this._bindParameters.ssr.reprojectionMatrix,a)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",get:function(){var a;return!(null==(a=this._shadowMap)||!a.enabled)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},
{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlendWorking}},{key:"animationTimestep",get:function(){return this._animationTimestep}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}},{key:"needsNormal",get:function(){return this._ssaoHelper.enabled}},{key:"needsDepthRange",get:function(){return this._shadowMap.enabled||
this.needsShadowCast}},{key:"needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this.needsHighlight}},{key:"needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){var a,b,d,f,e,h,k,v,x,c;return{offscreen:null!=(a=null==(b=this._offscreenRendering)?void 0:b.gpuMemoryUsage)?a:0,highlights:(null!=
(d=null==(f=this._highlight)?void 0:f.gpuMemoryUsage)?d:0)+(null!=(e=null==(h=this._shadowHighlight)?void 0:h.gpuMemoryUsage)?e:0),shadows:null!=(k=null==(v=this._shadowMap)?void 0:v.gpuMemoryUsage)?k:0,ssao:null!=(x=null==(c=this._ssaoHelper)?void 0:c.gpuMemoryUsage)?x:0}}},{key:"test",get:function(){const a=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,
shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:b=>{switch(b){case n.FramebufferId.Color:return a._offscreenRendering.colorTexture;case n.FramebufferId.LinearDepth:return a._offscreenRendering.linearDepthTexture;case n.FramebufferId.Normals:return a._offscreenRendering.normalTexture;case n.FramebufferId.ShadowMap:return a._shadowMap.depthTexture;case n.FramebufferId.HudVisibility:return a._offscreenRendering.hudVisibilityTexture;case n.FramebufferId.Highlight:return a._offscreenRendering.highlightTexture}}}}}]);
return L}(U);A.__decorate([C.property()],n.Renderer.prototype,"_shadowAccumulator",void 0);A.__decorate([C.property()],n.Renderer.prototype,"_smaaPass",void 0);A.__decorate([C.property()],n.Renderer.prototype,"_antialiasing",void 0);A.__decorate([C.property()],n.Renderer.prototype,"_edgeView",void 0);A.__decorate([C.property()],n.Renderer.prototype,"updating",null);A.__decorate([C.property()],n.Renderer.prototype,"isCameraFinal",null);n.Renderer=A.__decorate([X.subclass("esri.views.3d.webgl-engine.lib.Renderer")],
n.Renderer);n.FramebufferId=void 0;(function(r){r[r.Color=0]="Color";r[r.LinearDepth=1]="LinearDepth";r[r.Normals=2]="Normals";r[r.ShadowMap=3]="ShadowMap";r[r.HudVisibility=4]="HudVisibility";r[r.Highlight=5]="Highlight"})(n.FramebufferId||(n.FramebufferId={}));const K=[],J=[],T=G.create(),S=G.create(),E=G.create();Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});