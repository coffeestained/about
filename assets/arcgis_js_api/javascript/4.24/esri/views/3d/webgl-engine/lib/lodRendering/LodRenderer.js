// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f64 ../../../support/debugFlags ../../../support/buffer/glUtil ../Camera ../DefaultVertexAttributeLocations ../IntersectorInterfaces ../Octree ../RenderPass ../RenderSlot ../Util ./InstanceData ./InstanceOctree ./LevelSelector ./LodLevel ./RenderInstanceData ../../materials/DefaultMaterial ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../shaders/DefaultMaterialTechnique ../../../../webgl/Util".split(" "),
function(y,A,P,B,Q,u,w,R,C,S,T,D,U,E,x,z,v,m,V,W,X,F,Y,Z,aa,ba,G){function H(k,h,a){const b=k.allocateHead();k=k.view;aa.encodeDoubleVec3(h.modelOrigin,a,k.modelOriginHi,k.modelOriginLo,b);k.model.copyFrom(b,h.model,a);k.modelNormal.copyFrom(b,h.modelNormal,a);h.color&&k.color&&k.color.copyFrom(b,h.color,a);h.featureAttribute&&k.featureAttribute&&k.featureAttribute.copyFrom(b,h.featureAttribute,a)}let I=k=>{const h=k.baseBoundingSphere.radius;k=k.levels.map(a=>a.minScreenSpaceRadius);return new W.LevelSelector(h,
k)},ea=function(){function k(a,b,d,c){this.type=U.IntersectorType.LOD;this.isGround=!1;this._levels=[];this._defaultRenderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlane=!1;this._enableLevelSelection=!0;this._lastCamera=new T.Camera;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.slots=[z.RenderSlot.OPAQUE_MATERIAL,z.RenderSlot.TRANSPARENT_MATERIAL];this.canRender=!0;this._symbol=a;this._optionalFields=b;this._metadata=d;this._instanceBufferLayout=
Y.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:b});this._glInstanceBufferLayout=S.glLayout(this._instanceBufferLayout,1);this._instanceData=new m.InstanceData(this._optionalFields,c);this._instanceData.on("instance-added",()=>this._requestUpdateCycle());this._instanceData.on("instance-removed",()=>this._requestUpdateCycle());this._instanceData.on("instance-transform-changed",e=>{this._requestUpdateCycle();this._metadata.notifyGraphicGeometryChanged(e.index)});this._instanceData.on("instance-visibility-changed",
e=>{this._requestUpdateCycle(!0);this._metadata.notifyGraphicVisibilityChanged(e.index)});this._instanceData.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0));this._enableLevelSelection=1<this._symbol.levels.length}var h=k.prototype;h.initializeRenderContext=function(){var a=A._asyncToGenerator(function*(b,d){this._context=b;const c=b.renderContext.rctx,e=yield Promise.allSettled(this._symbol.levels.map(f=>{this._defaultRenderInstanceData.push(new F.RenderInstanceData(c,this._instanceBufferLayout));
this._highlightRenderInstanceData.push(new F.RenderInstanceData(c,this._instanceBufferLayout));return X.LodLevel.create(b,f,d)})),n=e.map(f=>"fulfilled"===f.status?f.value:null).filter(f=>f);if(B.isAborted(d)||n.length!==e.length){n.forEach(f=>f.destroy());B.throwIfAborted(d);for(const f of e)if("rejected"===f.status)throw f.reason;}this._levels=n;this._levelSelector=I(this)});return function(b,d){return a.apply(this,arguments)}}();h.uninitializeRenderContext=function(){this._invalidateOctree();this._levels.forEach(a=>
a.destroy());this._defaultRenderInstanceData.forEach(a=>a.destroy());this._highlightRenderInstanceData.forEach(a=>a.destroy())};h.prepareRender=function(a){if(!C.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var b=a.bindParameters.contentCamera.equals(this._lastCamera);this._lastCamera.copyFrom(a.bindParameters.contentCamera);b||this._requestUpdateCycle()}b=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this._updateInstances(a.bindParameters.contentCamera,
b);this.needsUpdates&&this._context.requestRender()}};h.render=function(a){if(this.baseMaterial.isVisible()&&this.baseMaterial.isVisibleInPass(a.pass)){a.rctx.bindVAO();var b=a.pass!==x.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT;a.pass!==x.RenderPass.MATERIAL_HIGHLIGHT&&a.pass!==x.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT&&this._renderComponents(a,this._defaultRenderInstanceData);b&&this._renderComponents(a,this._highlightRenderInstanceData)}};h.intersect=function(a,b,d,c){if(this.baseMaterial.isVisible()){var e=
w.create();u.subtract(e,c,d);var n=f=>{this._instanceData.getCombinedModelTransform(f,J);a.transform.set(J);u.transformMat4(K,d,a.transform.inverse);u.transformMat4(L,c,a.transform.inverse);const g=this._instanceData.getState(f),l=this._instanceData.getLodLevel(f),p=this._levels.length;v.assert(g&m.StateFlags.ACTIVE,"invalid instance state");v.assert(0<=l&&l<p,"invaid lod level");this._levels[l].intersect(a,b,K,L,f,this._metadata,p)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(n):
this.octree.forEachAlongRay(d,e,n)}};h.queryDepthRange=function(a){return this._queryDepthRangeOctree(a)};h.notifyShaderTransformationChanged=function(){this._invalidateOctree()};h._requestUpdateCycle=function(a=!1){this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=!0);this.needsUpdates&&this._context.requestRender()};h._invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};h._buildOctree=function(){const a=new V.InstanceOctree(this._instanceData,this.baseBoundingSphere);
var b=this._instanceData;b=b.view?b.view.state:null;for(let d=0;d<this._instanceData.capacity;++d)b.get(d)&m.StateFlags.ACTIVE&&a.addInstance(d);return a};h._queryDepthRangeOctree=function(a){var b=a.eye;const d=a.viewForward;var c=this.octree.findClosest(d,E.DepthOrder.FRONT_TO_BACK,a.frustum);const e=this.octree.findClosest(d,E.DepthOrder.BACK_TO_FRONT,a.frustum);return null!=c&&null!=e?(this._instanceData.view.boundingSphere.getVec(c,t),u.subtract(t,t,b),c=u.dot(t,d)-t[3],this._instanceData.view.boundingSphere.getVec(e,
t),u.subtract(t,t,b),b=u.dot(t,d)+t[3],{near:Math.max(a.near,c),far:Math.min(a.far,b)}):{near:Infinity,far:-Infinity}};h._startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._defaultRenderInstanceData.forEach(a=>{a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(a=>{a.startUpdateCylce()});this.needsUpdates&&this._context.requestRender()};h._updateInstances=function(a,b){const d=this._enableLevelSelection,c=this._levelSelector;c.updateCamera(a);this._defaultRenderInstanceData.forEach(p=>
{p.beginUpdate()});this._highlightRenderInstanceData.forEach(p=>{p.beginUpdate()});a=this._instanceData;const e=this._instanceData.view,n=a.capacity;let f=this._instanceIndex;b=Math.min(a.size,b);for(let p=0;p<b;++p){0===f&&this._startUpdateCycle();const q=e.state.get(f);var g=0;if(q&m.StateFlags.ALLOCATED){var l=e.lodLevel.get(f);q&m.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[l].freeTail();q&m.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[l].freeTail();q&m.StateFlags.REMOVE?
a.freeInstance(f):q&m.StateFlags.VISIBLE?(l=0,d&&(e.modelOrigin.getVec(f,M),l=c.selectLevel(M,a.getCombinedMedianScaleFactor(f))),g=q&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),0<=l&&(q&m.StateFlags.HIGHLIGHT?(H(this._highlightRenderInstanceData[l],e,f),g|=m.StateFlags.HIGHLIGHT_ACTIVE):(H(this._defaultRenderInstanceData[l],e,f),g|=m.StateFlags.DEFAULT_ACTIVE)),e.state.set(f,g),e.lodLevel.set(f,l)):(g=q&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),e.state.set(f,g));this._octree&&
(l=!!(q&m.StateFlags.ACTIVE),g=!!(g&m.StateFlags.ACTIVE),!l&&g?this._octree.addInstance(f):l&&!g?this._octree.removeInstance(f):l&&g&&q&m.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(f),this._octree.addInstance(f)));f=(f+1)%n}else f=(f+1)%n,b++}this._instanceIndex=f;this._defaultRenderInstanceData.forEach(p=>{p.endUpdate()});this._highlightRenderInstanceData.forEach(p=>{p.endUpdate()})};h._renderComponents=function(a,b){this.levels.forEach((d,c)=>{d.components.forEach(e=>{this._renderComponent(a,
b[c],e,c)})})};h._renderComponent=function(a,b,d,c){var e=a.bindParameters;if(0!==b.size&&d.material.requiresSlot(e.slot)){var {rctx:n,pass:f}=a,g=d.glMaterials.load(n,f);if(!P.isNone(g)){var l=g.beginSlot(e);g=n.bindTechnique(l,d.material.parameters,e);n.bindVAO(d.vao);l.ensureAttributeLocations(d.vao);l.bindDraw(ca,e);C.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&a.pass===x.RenderPass.MATERIAL&&(g.setUniform4fv("externalColor",N[Math.min(c,N.length-1)]),g.setUniform1i("colorMixMode",Z.colorMixModes.replace));
var p=n.capabilities.instancing;a=b.capacity;c=b.headIndex;e=b.tailIndex;g=b.firstIndex;var q=this._glInstanceBufferLayout,r=(O,da)=>{G.bindVertexBufferLayout(n,D.Default3D,b.buffer,q,O);p.drawArraysInstanced(l.primitiveType,0,d.vertexCount,da-O);G.unbindVertexBufferLayout(n,D.Default3D,b.buffer,q)};d.material.parameters.transparent&&null!=g?c>e?(v.assert(g>=e&&g<=c,"invalid firstIndex"),r(g,c),r(e,g)):c<e&&(g<=c?(v.assert(0<=g&&g<=c,"invalid firstIndex"),r(g,c),r(e,a),r(0,g)):(v.assert(g>=e&&g<=
a,"invalid firstIndex"),r(g,a),r(0,c),r(e,g))):c>e?r(e,c):c<e&&(r(0,c),r(e,a));n.bindVAO(null)}}};A._createClass(k,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},
set:function(a){this._slicePlane=a}},{key:"layerUid",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const a={cpu:0,gpu:0};this._defaultRenderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});this._highlightRenderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});return a}},{key:"renderStats",get:function(){const a=this._instanceData.size,b=[];this._levels.forEach((d,
c)=>{c=this._defaultRenderInstanceData[c].size+this._highlightRenderInstanceData[c].size;d=d.triangleCount;b.push({renderedInstances:c,renderedTriangles:c*d,trianglesPerInstance:d})});return{totalInstances:a,renderedInstances:b.reduce((d,c)=>d+c.renderedInstances,0),renderedTriangles:b.reduce((d,c)=>d+c.renderedTriangles,0),levels:b}}},{key:"needsTransparentPass",get:function(){return this._levels.some(a=>a.components.some(b=>b.material.requiresSlot(z.RenderSlot.TRANSPARENT_MATERIAL)))}},{key:"needsHighlight",
get:function(){return this._highlightRenderInstanceData.some(a=>0<a.size)}},{key:"needsUpdates",get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera}},{key:"octree",get:function(){this._octree||(this._octree=this._buildOctree());return this._octree}}]);return k}();const M=w.create(),t=R.create(),J=Q.create(),K=w.create(),L=w.create(),N=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]],ca=new ba.DefaultMaterialDrawParameters;y.LodRenderer=ea;y.setLevelSelectorFactory=
function(k){I=k};Object.defineProperties(y,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});