// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutputOptions ../lib/geometryDataUtils ../lib/GLMaterial ../lib/GLMaterials ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./VisualVariablePassParameters ./renderers/utils ../../../../chunks/RibbonLine.glsl ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechniqueConfiguration".split(" "),
function(Z,aa,ba,ca,X,S,sa,k,A,ta,Y,N,x,ua,I,va,wa,xa,da,L,ya,l,za,Aa,Ba,la,ma){function M(m,u,b,a,c){for(let f=0;f<c;f++)b[a++]=m[u++];return a}function ea(m,u,b){u=u.get(l.VertexAttribute.POSITION).data;b=b?b.get(l.VertexAttribute.POSITION):null;return m.isClosed?b?2<b.length:6<u.length:!1}const Ca=ba.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");var B;(function(m){m[m.LEFT_JOIN_START=-2]="LEFT_JOIN_START";m[m.LEFT_JOIN_END=-1]="LEFT_JOIN_END";m[m.LEFT_CAP_START=-4]="LEFT_CAP_START";
m[m.LEFT_CAP_END=-5]="LEFT_CAP_END";m[m.RIGHT_JOIN_START=2]="RIGHT_JOIN_START";m[m.RIGHT_JOIN_END=1]="RIGHT_JOIN_END";m[m.RIGHT_CAP_START=4]="RIGHT_CAP_START";m[m.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(B||(B={}));ba=function(m){function u(a){a=m.call(this,a,new na)||this;a._vertexAttributeLocations=la.ribbonVertexAttributeLocations;a.techniqueConfig=new ma.RibbonLineTechniqueConfiguration;a.layout=a.createLayout();return a}aa._inheritsLoose(u,m);var b=u.prototype;b.isClosed=function(a,c){return this.parameters.isClosed?
c?2<c.length:6<a.length:!1};b.getConfiguration=function(a,c){this.techniqueConfig.output=a;this.techniqueConfig.draped=c.slot===L.RenderSlot.DRAPED_MATERIAL;a=X.isSome(this.parameters.stipplePattern)&&a!==I.ShaderOutput.Highlight;this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleOffColorEnabled=a&&X.isSome(this.parameters.stippleOffColor);this.techniqueConfig.stippleScaleWithLineWidth=a&&this.parameters.stippleScaleWithLineWidth;this.techniqueConfig.stipplePreferContinuous=a&&this.parameters.stipplePreferContinuous;
this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane;this.techniqueConfig.hasOccludees=this.parameters.hasOccludees;this.techniqueConfig.roundJoins="round"===this.parameters.join;this.techniqueConfig.capType=this.parameters.cap;this.techniqueConfig.hasPolygonOffset=this.parameters.hasPolygonOffset;this.techniqueConfig.writeDepth=this.parameters.writeDepth;this.techniqueConfig.vvColor=this.parameters.vvColorEnabled;this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled;this.techniqueConfig.vvSize=
this.parameters.vvSizeEnabled;this.techniqueConfig.innerColorEnabled=0<this.parameters.innerWidth&&X.isSome(this.parameters.innerColor);this.techniqueConfig.falloffEnabled=0<this.parameters.falloff;this.techniqueConfig.occluder=this.parameters.renderOccluded===da.RenderOccludedFlag.OccludeAndTransparentStencil;this.techniqueConfig.transparencyPassType=c.transparencyPassType;this.techniqueConfig.hasMultipassTerrain=c.multipassTerrain.enabled;this.techniqueConfig.cullAboveGround=c.multipassTerrain.cullAboveGround;
this.techniqueConfig.wireframe=this.parameters.wireframe;return this.techniqueConfig};b.intersect=function(a,c,f,n,t,d,e,g,h){X.isSome(h)?this._intersectDrapedLineGeometry(a,n,h,d,e):this._intersectLineGeometry(a,c,f,n,e)};b._intersectDrapedLineGeometry=function(a,c,f,n,t){if(c.options.selectionMode){c=a.vertexAttributes.get(l.VertexAttribute.POSITION).data;var d=a.vertexAttributes.get(l.VertexAttribute.SIZE),e=this.parameters.width;this.parameters.vvSizeEnabled?(d=a.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0],
e*=ca.clamp(this.parameters.vvSizeOffset[0]+d*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])):d&&(e*=d.data[0]);d=n[0];n=n[1];a=(e/2+4)*a.screenToWorldRatio;e=Number.MAX_VALUE;var g=0;for(let C=0;C<c.length-5;C+=3){var h=c[C],w=c[C+1],E=d-h,p=n-w;h=c[C+3]-h;w=c[C+4]-w;const U=ca.clamp((h*E+w*p)/(h*h+w*w),0,1);E=h*U-E;p=w*U-p;p=E*E+p*p;p<e&&(e=p,g=C/3)}e<a*a&&t(f.dist,f.normal,g,!1)}};b._intersectLineGeometry=function(a,c,f,n,t){if(n.options.selectionMode&&
!Aa.isInstanceHidden(c))if(ya.isTranslationMatrix(f)){var d=a.vertexAttributes,e=d.get(l.VertexAttribute.POSITION).data;c=this.parameters.width;if(this.parameters.vvSizeEnabled){var g=d.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];c*=ca.clamp(this.parameters.vvSizeOffset[0]+g*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else d.has(l.VertexAttribute.SIZE)&&(c*=d.get(l.VertexAttribute.SIZE).data[0]);var h=n.camera,w=Da;sa.copy(w,n.point);
g=c*h.pixelRatio/2+4*h.pixelRatio;k.set(V[0],w[0]-g,w[1]+g,0);k.set(V[1],w[0]+g,w[1]+g,0);k.set(V[2],w[0]+g,w[1]-g,0);k.set(V[3],w[0]-g,w[1]-g,0);for(c=0;4>c;c++)if(!h.unprojectFromRenderScreen(V[c],J[c]))return;x.fromPoints(h.eye,J[0],J[1],fa);x.fromPoints(h.eye,J[1],J[2],ha);x.fromPoints(h.eye,J[2],J[3],ia);x.fromPoints(h.eye,J[3],J[0],ja);var E=Number.MAX_VALUE;c=0;a=ea(this.parameters,d,a.indices)?e.length-2:e.length-5;for(d=0;d<a;d+=3){y[0]=e[d]+f[12];y[1]=e[d+1]+f[13];y[2]=e[d+2]+f[14];var p=
(d+3)%e.length;z[0]=e[p]+f[12];z[1]=e[p+1]+f[13];z[2]=e[p+2]+f[14];if(!(0>x.signedDistance(fa,y)&&0>x.signedDistance(fa,z)||0>x.signedDistance(ha,y)&&0>x.signedDistance(ha,z)||0>x.signedDistance(ia,y)&&0>x.signedDistance(ia,z)||0>x.signedDistance(ja,y)&&0>x.signedDistance(ja,z))){h.projectToRenderScreen(y,O);h.projectToRenderScreen(z,P);if(0>O[2]&&0<P[2])k.subtract(G,y,z),p=h.frustum,p=-x.signedDistance(p[Y.PlaneIndex.NEAR],y)/k.dot(G,x.normal(p[Y.PlaneIndex.NEAR])),k.scale(G,G,p),k.add(y,y,G),h.projectToRenderScreen(y,
O);else if(0<O[2]&&0>P[2])k.subtract(G,z,y),p=h.frustum,p=-x.signedDistance(p[Y.PlaneIndex.NEAR],z)/k.dot(G,x.normal(p[Y.PlaneIndex.NEAR])),k.scale(G,G,p),k.add(z,z,G),h.projectToRenderScreen(z,P);else if(0>O[2]&&0>P[2])continue;O[2]=0;P[2]=0;p=N.distance2(N.fromPoints(O,P,oa),w);p<E&&(E=p,k.copy(pa,y),k.copy(qa,z),c=d/3)}}f=n.rayBegin;n=n.rayEnd;E<g*g&&(e=Number.MAX_VALUE,N.closestLineSegmentPoint(N.fromPoints(pa,qa,oa),N.fromPoints(f,n,Ea),Q)&&(k.subtract(Q,Q,f),e=k.length(Q),k.scale(Q,Q,1/e),e/=
k.distance(f,n)),t(e,Q,c,!1))}else Ca.error("intersection assumes a translation-only matrix")};b.computeAttachmentOrigin=function(a,c){const f=a.vertexAttributes;if(!f)return null;a=a.indices;const n=f.get(l.VertexAttribute.POSITION);return va.computeAttachmentOriginLines(n,a?a.get(l.VertexAttribute.POSITION):null,a&&ea(this.parameters,f,a),c)};b.createLayout=function(){const a=ua.newLayout().vec3f(l.VertexAttribute.POSITION).f32(l.VertexAttribute.SUBDIVISIONFACTOR).vec2f(l.VertexAttribute.UV0).vec3f(l.VertexAttribute.AUXPOS1).vec3f(l.VertexAttribute.AUXPOS2);
this.parameters.vvSizeEnabled?a.f32(l.VertexAttribute.SIZEFEATUREATTRIBUTE):a.f32(l.VertexAttribute.SIZE);this.parameters.vvColorEnabled?a.f32(l.VertexAttribute.COLORFEATUREATTRIBUTE):a.vec4f(l.VertexAttribute.COLOR);this.parameters.vvOpacityEnabled&&a.f32(l.VertexAttribute.OPACITYFEATUREATTRIBUTE);return a};b.createBufferWriter=function(){return new Fa(this.layout,this.parameters)};b.requiresSlot=function(a,c){if(a===L.RenderSlot.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===da.RenderOccludedFlag.OccludeAndTransparentStencil)return a===
L.RenderSlot.OPAQUE_MATERIAL||a===L.RenderSlot.OCCLUDER_MATERIAL||a===L.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;c=xa.outputFromPass(c);return c===I.ShaderOutput.Color||c===I.ShaderOutput.Alpha?a===(this.parameters.writeDepth?L.RenderSlot.TRANSPARENT_MATERIAL:L.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):a===L.RenderSlot.OPAQUE_MATERIAL};b.createGLMaterial=function(a){return a.output===I.ShaderOutput.Color||a.output===I.ShaderOutput.Alpha||a.output===I.ShaderOutput.Highlight||a.output===
I.ShaderOutput.Depth?new Ga(a):null};b.validateParameters=function(a){"miter"!==a.join&&(a.miterLimit=0)};return u}(da.Material);let Ga=function(m){function u(){return m.apply(this,arguments)||this}aa._inheritsLoose(u,m);var b=u.prototype;b._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})};b.beginSlot=function(a){this._output!==I.ShaderOutput.Color&&this._output!==I.ShaderOutput.Alpha||this._updateOccludeeState(a);
return this.ensureTechnique(la.RibbonLineTechnique,a)};return u}(wa),na=function(m){function u(){var b=m.apply(this,arguments)||this;b.width=0;b.color=ta.ONES;b.join="miter";b.cap=ma.CapType.BUTT;b.miterLimit=5;b.writeDepth=!0;b.hasPolygonOffset=!1;b.stippleScaleWithLineWidth=!1;b.stipplePreferContinuous=!0;b.hasSlicePlane=!1;b.vvFastUpdate=!1;b.isClosed=!1;b.falloff=0;b.innerWidth=0;b.hasOccludees=!1;b.wireframe=!1;return b}aa._inheritsLoose(u,m);return u}(za.VisualVariablePassParameters),Fa=function(){function m(b,
a){this.parameters=a;this.numJoinSubdivisions=0;this.vertexBufferLayout=b;b=a.stipplePattern?1:0;switch(this.parameters.join){case "miter":case "bevel":this.numJoinSubdivisions=b;break;case "round":this.numJoinSubdivisions=Ba.NUM_ROUND_JOIN_SUBDIVISIONS+b}}var u=m.prototype;u._isClosed=function(b){return ea(this.parameters,b.vertexAttributes,b.indices)};u.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};u.elementCount=function(b){var a=b.indices.get(l.VertexAttribute.POSITION).length/
2+1;b=this._isClosed(b);a=(b?2:4)+((b?a:a-1)-(b?0:1))*(2*this.numJoinSubdivisions+4);a+=2;this.parameters.wireframe&&(a=2+4*(a-2));return a};u.write=function(b,a,c,f){var n;const t=Ha,d=Ia,e=Ja,g=a.vertexAttributes.get(l.VertexAttribute.POSITION).data;var h=a.indices&&a.indices.get(l.VertexAttribute.POSITION);const w=null==(n=a.vertexAttributes.get(l.VertexAttribute.DISTANCETOSTART))?void 0:n.data;h&&h.length!==2*(g.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let E=1,
p=0;this.parameters.vvSizeEnabled?p=a.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:a.vertexAttributes.has(l.VertexAttribute.SIZE)&&(E=a.vertexAttributes.get(l.VertexAttribute.SIZE).data[0]);let C=[1,1,1,1],U=0;this.parameters.vvColorEnabled?U=a.vertexAttributes.get(l.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:a.vertexAttributes.has(l.VertexAttribute.COLOR)&&(C=a.vertexAttributes.get(l.VertexAttribute.COLOR).data);let ra=0;this.parameters.vvOpacityEnabled&&(ra=a.vertexAttributes.get(l.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);
n=g.length/3;b=b.transformation;const r=new Float32Array(c.buffer);h=this.vertexBufferLayout.stride/4;let q=f*h;f=q;let D=0;const ka=w?(v,H,K)=>D=w[K]:(v,H,K)=>D+=k.distance(v,H),F=(v,H,K,Ka,La,Ma,Na)=>{r[q++]=H[0];r[q++]=H[1];r[q++]=H[2];r[q++]=Ka;r[q++]=Na;r[q++]=La;r[q++]=v[0];r[q++]=v[1];r[q++]=v[2];r[q++]=K[0];r[q++]=K[1];r[q++]=K[2];this.parameters.vvSizeEnabled?r[q++]=p:r[q++]=E;this.parameters.vvColorEnabled?r[q++]=U:(v=Math.min(4*Ma,C.length-4),r[q++]=C[v+0],r[q++]=C[v+1],r[q++]=C[v+2],r[q++]=
C[v+3]);this.parameters.vvOpacityEnabled&&(r[q++]=ra)};q+=h;k.set(d,g[0],g[1],g[2]);b&&k.transformMat4(d,d,b);if(a=this._isClosed(a)){var R=g.length-3;k.set(t,g[R],g[R+1],g[R+2]);b&&k.transformMat4(t,t,b)}else k.set(e,g[3],g[4],g[5]),b&&k.transformMat4(e,e,b),F(d,d,e,1,B.LEFT_CAP_START,0,0),F(d,d,e,1,B.RIGHT_CAP_START,0,0),k.copy(t,d),k.copy(d,e);R=a?0:1;const W=a?n:n-1;for(let v=R;v<W;v++){var T=(v+1)%n*3;k.set(e,g[T+0],g[T+1],g[T+2]);b&&k.transformMat4(e,e,b);ka(t,d,v);F(t,d,e,0,B.LEFT_JOIN_END,
v,D);F(t,d,e,0,B.RIGHT_JOIN_END,v,D);T=this.numJoinSubdivisions;for(let H=0;H<T;++H){const K=(H+1)/(T+1);F(t,d,e,K,B.LEFT_JOIN_END,v,D);F(t,d,e,K,B.RIGHT_JOIN_END,v,D)}F(t,d,e,1,B.LEFT_JOIN_START,v,D);F(t,d,e,1,B.RIGHT_JOIN_START,v,D);k.copy(t,d);k.copy(d,e)}a?(k.set(e,g[3],g[4],g[5]),b&&k.transformMat4(e,e,b),D=ka(t,d,W),F(t,d,e,0,B.LEFT_JOIN_END,R,D),F(t,d,e,0,B.RIGHT_JOIN_END,R,D)):(D=ka(t,d,W),F(t,d,d,0,B.LEFT_CAP_END,W,D),F(t,d,d,0,B.RIGHT_CAP_END,W,D));M(r,f+h,r,f,h);q=M(r,q-h,r,q,h);this.parameters.wireframe&&
this._addWireframeVertices(c,f,q,h)};u._addWireframeVertices=function(b,a,c,f){const n=new Float32Array(b.buffer,c*Float32Array.BYTES_PER_ELEMENT);b=new Float32Array(b.buffer,a*Float32Array.BYTES_PER_ELEMENT,c-a);a=0;for(c=0;c<b.length-1;c+=2*f)a=M(b,c,n,a,f),a=M(b,c+2*f,n,a,f),a=M(b,c+1*f,n,a,f),a=M(b,c+2*f,n,a,f),a=M(b,c+1*f,n,a,f),a=M(b,c+3*f,n,a,f)};return m}();const y=A.create(),z=A.create(),G=A.create(),Q=A.create(),Da=A.create(),O=S.createRenderScreenPointArray3(),P=S.createRenderScreenPointArray3(),
pa=A.create(),qa=A.create(),oa=N.create(),Ea=N.create(),Ha=A.create(),Ia=A.create(),Ja=A.create(),V=[S.createRenderScreenPointArray3(),S.createRenderScreenPointArray3(),S.createRenderScreenPointArray3(),S.createRenderScreenPointArray3()],J=[A.create(),A.create(),A.create(),A.create()],fa=x.create(),ha=x.create(),ia=x.create(),ja=x.create();Z.Parameters=na;Z.RibbonLineMaterial=ba;Object.defineProperties(Z,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});