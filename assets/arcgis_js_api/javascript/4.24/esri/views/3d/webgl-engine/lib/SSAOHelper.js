// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/vec3 ../../../../support/requestImageUtils ../core/shaderModules/interfaces ./glUtil3D ./SSAOTechnique ./SSAOTechniqueConfiguration ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),function(z,w,A,b,B,C,D,E,x,r,c,t,F,u){let G=function(){function v(a,d,f){this._techniqueRep=a;this._rctx=d;this._requestRender=f;this._enabled=!1;this._ssaoTechniqueConfig=
new r.SSAOTechniqueConfiguration;this.quadVAO=null;this._blurSizePx=2;this._attenuation=.5}var l=v.prototype;l.dispose=function(){this.quadVAO=b.disposeMaybe(this.quadVAO)};l.disposeOffscreenBuffers=function(){b.applySome(this._ssaoFBO,a=>a.resize(0,0));b.applySome(this._blur0FBO,a=>a.resize(0,0));b.applySome(this._blur1FBO,a=>a.resize(0,0))};l.computeSSAO=function(a,d,f){if(!(!this.enabled||b.isNone(d)||b.isNone(f)||b.isNone(this._noiseTexture)||b.isNone(this._ssaoFBO)||b.isNone(this._blur0FBO)||
b.isNone(this._blur1FBO))){var e=this._rctx,g=a.camera,q=g.fullViewport,h=q[2],k=q[3],n=h/this._blurSizePx,p=k/this._blurSizePx;this._ssaoFBO.resize(h,k);this._blur0FBO.resize(n,p);this._blur1FBO.resize(n,p);n=1*h;p=1*k;e.bindFramebuffer(this._ssaoFBO);e.setViewport(0,0,h,k);var m=e.bindTechnique(this._ssaoTechnique,y,a);m.setUniform2f("rnmScale",h/this._noiseTexture.descriptor.width,k/this._noiseTexture.descriptor.height);h=1/g.computeRenderPixelSizeAtDist(1);m.setUniform1f("projScale",1*h);m.setUniform2f("screenSize",
n,p);k=B.distance(g.eye,g.center);g=20*g.computeRenderPixelSizeAtDist(k);g=Math.max(.1,g);m.setUniform1f("radius",g);m.setUniform1f("intensity",4*this._attenuation/g**6);m.bindTexture("rnm",this._noiseTexture);m.bindTexture("normalMap",f);m.bindTexture("depthMap",d);b.isNone(this.quadVAO)&&(this.quadVAO=E.createQuadVAO(this._rctx));e.bindVAO(this.quadVAO);e.drawArrays(c.PrimitiveType.TRIANGLE_STRIP,0,u.vertexCount(this.quadVAO,"geometry"));a=e.bindTechnique(this._blurTechnique,y,a);a.bindTexture("tex",
this._ssaoFBO.colorTexture);a.bindTexture("normalMap",f);a.bindTexture("depthMap",d);e.setViewport(0,0,n/this._blurSizePx,p/this._blurSizePx);e.bindFramebuffer(this._blur0FBO);a.setUniform2f("screenSize",n,p);a.setUniform2f("blurSize",0,1*this._blurSizePx/p);5E4<k&&(h=Math.max(0,h-(k-5E4)));a.setUniform1f("projScale",h);e.drawArrays(c.PrimitiveType.TRIANGLE_STRIP,0,u.vertexCount(this.quadVAO,"geometry"));a.setUniform2f("blurSize",1*this._blurSizePx/n,0);e.bindFramebuffer(this._blur1FBO);a.bindTexture("tex",
this._blur0FBO.colorTexture);e.drawArrays(c.PrimitiveType.TRIANGLE_STRIP,0,u.vertexCount(this.quadVAO,"geometry"));e.setViewport(q[0],q[1],q[2],q[3])}};l._selectPrograms=function(){this._ssaoTechniqueConfig.output=r.SSAOOutput.SSAO;this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(x.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique);this._ssaoTechniqueConfig.output=r.SSAOOutput.Blur;this._blurTechnique=this._techniqueRep.releaseAndAcquire(x.SSAOTechnique,this._ssaoTechniqueConfig,
this._blurTechnique)};l._enable=function(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))};l._loadResources=function(a){this._data?a():(new Promise((d,f)=>z(["./SSAOHelperData"],d,f))).then(d=>{this._data=d;a()})};l._initialize=function(){const a={target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,samplingMode:c.TextureSamplingMode.LINEAR,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0},d={colorTarget:c.TargetType.TEXTURE,
depthStencilTarget:c.DepthStencilTargetType.NONE};C.requestImage(this._data.noiseTexture).then(f=>{this._enabled&&(this._ssaoFBO=new t.FramebufferObject(this._rctx,d,a),this._blur0FBO=new t.FramebufferObject(this._rctx,d,a),this._blur1FBO=new t.FramebufferObject(this._rctx,d,a),this._noiseTexture=new F.Texture(this._rctx,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,hasMipmap:!0,width:f.width,height:f.height},f),this._requestRender())});this._selectPrograms()};
l._disable=function(){this._enabled=!1;this._noiseTexture=b.disposeMaybe(this._noiseTexture);this._blur1FBO=b.disposeMaybe(this._blur1FBO);this._blur0FBO=b.disposeMaybe(this._blur0FBO);this._ssaoFBO=b.disposeMaybe(this._ssaoFBO)};A._createClass(v,[{key:"enabled",get:function(){return this._enabled},set:function(a){a?this._enable():this._disable()}},{key:"ready",get:function(){return this.enabled&&b.isSome(this._noiseTexture)&&b.isSome(this._ssaoFBO)&&b.isSome(this._blur0FBO)&&b.isSome(this._blur1FBO)}},
{key:"colorTexture",get:function(){return b.isSome(this._blur1FBO)?this._blur1FBO.colorTexture:null}},{key:"width",get:function(){return b.isSome(this._ssaoFBO)?this._ssaoFBO.width:-1}},{key:"height",get:function(){return b.isSome(this._ssaoFBO)?this._ssaoFBO.height:-1}},{key:"gpuMemoryUsage",get:function(){return(b.isSome(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(b.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(b.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",
get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]);return v}();const y=new D.NoParameters;w.SSAOHelper=G;Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});