// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../debugFlags ../debugUtils ../PropertiesPool ../geometryUtils/ray ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/verticalOffsetUtils ../../../support/Scheduler".split(" "),
function(c,x,d,F,G,r,f,e,V,W,X,H,t,z,A,I,l,J,K,B,u,L,M,N,O,C,P,Q,n){c.PointsOfInterest=function(D){function v(a){a=D.call(this,a)||this;a._handles=new G;a._tmpRay=A.create();a._centerRayDirty=!0;a._surfaceAltitudeAtCenter=0;a._surfaceAltitudeAtCenterDirty=!0;a._contentAltitudeAtCenter=0;a._contentAltitudeAtCenterDirty=!0;a._propertiesPool=new J.PropertiesPool({renderPointOfView:R},x._assertThisInitialized(a));a.renderPointOfView=z.create();a._pois=[];a._debugCenters=new Map;return a}x._inheritsLoose(v,
D);var k=v.prototype;k.initialize=function(){var a;const {state:b,basemapTerrain:g,renderCoordsHelper:q,map:w}=this.view;this._surfaceIntersector=C.newIntersector(b.viewingMode);this._surfaceIntersector.options.backfacesTerrain=b.isGlobal?!1:!0;this._surfaceIntersector.options.invisibleTerrain=!1;this._surfaceIntersector.options.store=P.StoreResults.MIN;this._contentIntersector=C.newIntersector(b.viewingMode);var h=()=>this._estimateSurfaceAltitudeAtCenter();const E=this.view.resourceController.scheduler,
y=r.unwrap(null==(a=this.view.basemapTerrain)?void 0:a.elevationQueryCache);a={state:b,scheduler:E,surface:g,renderCoordsHelper:q};this._set("centerOnSurfaceInfrequent",new u.CenterOnSurface({...a,task:n.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnSurfaceFrequent",new u.CenterOnSurface({...a,task:n.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("contentCenterOnSurface",new u.CenterOnSurface({...a,task:n.TaskPriority.POINT_OF_INTEREST_INFREQUENT,
estimateSurfaceAltitudeAtCenter:h,cameraName:"contentCamera"}));this._set("centerOnContent",new u.CenterOnSurface({...a,task:n.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));this._set("cameraOnSurface",new B.CameraOnSurface({...a,cache:y,task:n.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:w}));this._set("contentCameraOnSurface",new B.CameraOnSurface({...a,cache:y,task:n.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:w,cameraName:"contentCamera"}));
this._set("surfaceGeometryUpdates",new O.SurfaceGeometryUpdates({...a,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}));this._set("contentGeometryUpdates",new L.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:q}));this._set("surfaceOrigin",new N.StableSurfaceCenter({cache:y,view:this.view}));this._set("focus",new M.Focus({state:b,scheduler:E,surface:g,renderCoordsHelper:q,centerOnSurface:this.contentCenterOnSurface,
estimateSurfaceIntersectionAtRenderPoint:(m,S)=>this._estimateSurfaceIntersectionAtRenderPoint(m,this.view.state.contentCamera,S)}));this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);h=this.view.graphics;this._debugCenters.set(this.centerOnContent,new l.PointGraphics(h,"red","CenterOnContent"));this._debugCenters.set(this.centerOnSurfaceFrequent,new l.PointGraphics(h,
"red","CenterOnSurface"));this._debugCenters.set(this.centerOnSurfaceInfrequent,new l.PointGraphics(h,"red","CenterOnSurface"));this._debugCenters.set(this.contentCenterOnSurface,new l.PointGraphics(h,"red","ContentCenterOnSurface"));this._debugCenters.set(this.cameraOnSurface,new l.PointGraphics(h,"blue","CameraOnSurface"));this._debugCenters.set(this.contentCameraOnSurface,new l.PointGraphics(h,"blue","ContentCameraOnSurface"));this._debugCenters.set(this.focus,new l.PointGraphics(h,"green","Focus"));
this._handles.add([f.watch(()=>b.camera,m=>this._cameraChanged(m),f.sync),f.watch(()=>g.extent,()=>this._updateCenterPointsOfInterest()),f.when(()=>!g.updating,()=>this._updateCenterPointsOfInterest(),f.sync),f.on(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),f.on(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),f.when(()=>I.SHOW_POI,m=>this._setDebug(m),f.initial)]);this._cameraChanged(this.view.state.camera);
for(const m of this._pois)m.runTask()};k.destroy=function(){this._setDebug(!1);this._handles.destroy();this._propertiesPool.destroy();for(const a of this._pois)a.destroy();this.surfaceOrigin.destroy()};k._estimateContentAltitudeAtCenter=function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const a=this.centerRay;if(r.isNone(a))return this._contentAltitudeAtCenter;this.view.sceneIntersectionHelper.intersectRay(a,this._contentIntersector,
p,T)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(p):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter();return this._contentAltitudeAtCenter};k._estimateSurfaceAltitudeAtCenter=function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const a=this.centerRay;if(r.isNone(a))return this._surfaceAltitudeAtCenter;const b=a.origin,g=t.add(p,a.origin,a.direction);
this._surfaceIntersector.resetWithRay(a,this.view.state.camera);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,b,g);this._surfaceIntersector.results.min.getIntersectionPoint(p)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(p));return this._surfaceAltitudeAtCenter};k._estimateSurfaceIntersectionAtRenderPoint=function(a,b,g){a=K.fromRenderAtEye(b,a,U);if(r.isNone(a))return null;const q=a.origin,w=t.add(p,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,
b);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,q,w);return this._surfaceIntersector.results.min.getIntersectionPoint(g)?g:null};k._cameraChanged=function(a){this._updateCenterPointsOfInterest();a=a.eye;t.exactEquals(this.renderPointOfView,a)||this._set("renderPointOfView",t.copy(this._propertiesPool.get("renderPointOfView"),a))};k._updateCenterPointsOfInterest=function(){this._contentAltitudeAtCenterDirty=this._surfaceAltitudeAtCenterDirty=this._centerRayDirty=!0;for(const a of this._pois)a.updateRenderLocation()};
k._updateCenterOnContent=function(){this._contentAltitudeAtCenterDirty=!0;this.centerOnContent.updateRenderLocation()};k._setDebug=function(a){if(a)for(const b of this._pois)this._handles.add(f.watch(()=>b.renderLocation,g=>this._debugCenters.get(b).show(g,b.renderCoordsHelper.spatialReference),f.initial),"debug");else this._debugCenters.forEach(b=>b.hide()),this._handles.remove("debug")};x._createClass(v,[{key:"updating",get:function(){var a;return!!(null!=(a=this.surfaceGeometryUpdates)&&a.updating||
this._pois.some(b=>b.updating))}},{key:"centerRay",get:function(){this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1);return this._centerRay}},{key:"test",get:function(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const a of this._pois)a.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]);return v}(F);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,
"centerOnContent",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"contentCenterOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"cameraOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,
"contentCameraOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"focus",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"renderPointOfView",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"surfaceOrigin",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"contentGeometryUpdates",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"surfaceGeometryUpdates",
void 0);d.__decorate([e.property({constructOnly:!0})],c.PointsOfInterest.prototype,"view",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"updating",null);c.PointsOfInterest=d.__decorate([H.subclass("esri.views.3d.support.PointsOfInterest")],c.PointsOfInterest);const R=Array,p=z.create(),U=A.create(),T={exclude:new Set([Q.TERRAIN_ID])};Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});