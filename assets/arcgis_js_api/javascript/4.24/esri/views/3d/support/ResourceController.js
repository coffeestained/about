// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/maybe ../../../core/reactiveUtils ../../../core/scheduling ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ./index ./MemoryController ./StreamDataLoader ../../support/Scheduler".split(" "),function(g,q,d,
w,x,m,r,y,z,h,E,F,G,u,v,A,B,e){g.ResourceControllerMain=function(k){function b(){var n=k.apply(this,arguments)||this;n.updating=!1;return n}q._inheritsLoose(b,k);return b}(w);d.__decorate([h.property({readOnly:!0})],g.ResourceControllerMain.prototype,"updating",void 0);g.ResourceControllerMain=d.__decorate([u.subclass("esri.views.3d.support.ResourceController")],g.ResourceControllerMain);var t;(function(k){let b=function(n){function p(){var a=n.apply(this,arguments)||this;a._scheduler=null;a._memoryController=
null;a._streamDataLoader=null;a._scheduleTask=e.ImmediateTask;a._cameraChangeTime=0;a._handles=new x;a._frameTask=null;a._state=e.State.IDLE;return a}q._inheritsLoose(p,n);var f=p.prototype;f.initialize=function(){this._cameraChangeTime=performance.now();this._scheduler=e.newScheduler();this._memoryController=A.newMemoryController(this.view);this._streamDataLoader=new B.StreamDataLoader;this._streamDataLoader.setup(v.maxDownloadSlots,v.downloadSlotsPerClient,this._scheduler);this._handles.add([r.watch(()=>
{var a;return null==(a=this.view.state)?void 0:a.camera},(a,c)=>this._cameraChangedHandler(a,c),r.sync),r.watch(()=>this.view.stationary,()=>this._stationaryChangedHandler())]);this._frameTask=y.addFrameTask({update:a=>this._frame(a)});this._scheduleTask=this._scheduler.registerTask(e.TaskPriority.RESOURCE_CONTROLLER)};f.destroy=function(){this._handles=m.destroyMaybe(this._handles);this._scheduleTask.remove();this._frameTask=m.removeMaybe(this._frameTask);this._streamDataLoader=m.destroyMaybe(this._streamDataLoader);
this._memoryController=m.destroyMaybe(this._memoryController);this._scheduler=m.destroyMaybe(this._scheduler)};f.schedule=function(a,c,l){return this._scheduleTask.schedule(a,c,l)};f.createStreamDataRequester=function(a){const c=this._streamDataLoader;return{request(l,C,D){return c.request(l,C,a,D)},get busy(){return!c.hasDownloadSlots(a)}}};f._frame=function(a){if(!this.view.suspended){if(this.view.stateManager&&(this.view.stateManager.step(z.secondsFromMilliseconds(a.deltaTime)),!this._scheduler))return;
this._updateState();this._scheduler.state=this._state;this._scheduler.updateBudget(a)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update()}};f._cameraChangedHandler=function(a,c){a&&c&&a.almostEquals(c)||(this._cameraChangeTime=performance.now(),this._updateState(),this._scheduler.state=this._state)};f._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()};f._updateState=function(){this.view.animation?
this._state=e.State.ANIMATING:this.view.interacting?this._state=e.State.INTERACTING:(this._state===e.State.ANIMATING&&(this._cameraChangeTime=0),300>=performance.now()-this._cameraChangeTime?this._state=e.State.INTERACTING:this._state=e.State.IDLE)};q._createClass(p,[{key:"updating",get:function(){var a,c,l;return!!(null!=(a=this._memoryController)&&a.updating||null!=(c=this._streamDataLoader)&&c.updating||null!=(l=this._scheduleTask)&&l.updating)}},{key:"scheduler",get:function(){return this._scheduler}},
{key:"memoryController",get:function(){return this._memoryController}},{key:"test",get:function(){return{getQueueStats:a=>this._streamDataLoader.test.loadQueue.getStatsForType(a),state:this._state}}}]);return p}(g.ResourceControllerMain);d.__decorate([h.property({constructOnly:!0})],b.prototype,"view",void 0);d.__decorate([h.property()],b.prototype,"_scheduler",void 0);d.__decorate([h.property()],b.prototype,"_memoryController",void 0);d.__decorate([h.property()],b.prototype,"_streamDataLoader",void 0);
d.__decorate([h.property()],b.prototype,"_scheduleTask",void 0);d.__decorate([h.property({readOnly:!0})],b.prototype,"updating",null);b=d.__decorate([u.subclass("esri.views.3d.support.ResourceController")],b);k.ResourceController=b})(t||(t={}));g.newResourceController=function(k){return new t.ResourceController({view:k})};Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});