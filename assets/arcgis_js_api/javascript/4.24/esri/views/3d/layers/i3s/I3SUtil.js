// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../request ../../../../core/arrayUtils ../../../../core/Error ../../../../core/has ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/quat ../../../../chunks/quatf32 ../../../../chunks/quatf64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/projection ../../../../geometry/projectionEllipsoid ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../rest/support/Query ../../../ViewingMode ./I3SBinaryReader ./I3SProjectionUtil ../support/edgeUtils ../support/symbolColorUtils ../../support/orientedBoundingBox".split(" "),
function(h,Y,ta,L,w,ua,u,va,Z,wa,xa,ya,aa,C,za,Aa,k,H,R,x,E,ba,A,ca,Ba,Ca,Da,Ea,da,S,I){function T(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function ea(a,b){var c=b[0],d=b[1];b=b[3];const e=a[0]-c;c-=a[2];const f=a[1]-d;a=d-a[3];d=Math.max(e,c,0);const g=Math.max(f,a,0);d=d*d+g*g;return d>b*b?h.MbsIntersectResult.OUTSIDE:0<d?h.MbsIntersectResult.INTERSECTS_CENTER_OUTSIDE:-Math.max(e,c,f,a)>b?h.MbsIntersectResult.INSIDE:h.MbsIntersectResult.INTERSECTS_CENTER_INSIDE}function fa(a,
b,c){const d=[],e=c&&c.missingFields;c=c&&c.originalFields;for(const f of a){a=f.toLowerCase();let g=!1;for(const n of b)if(a===n.name.toLowerCase()){d.push(n.name);g=!0;c&&c.push(f);break}!g&&e&&e.push(f)}return d}function U(){U=Y._asyncToGenerator(function*(a,b,c,d,e){if(0===b.length)return[];const f=a.attributeStorageInfo;if(u.isSome(a.associatedLayer))try{return yield Fa(a.associatedLayer,b,c,d)}catch(g){if(a.associatedLayer.loaded)throw g;}if(f){b=Ga(b,c,e);if(u.isNone(b))throw new w("scenelayer:features-not-loaded",
"Tried to query attributes for unloaded features");const g=a.parsedUrl.path;a=yield Promise.all(b.map(n=>Ha(g,f,n.node,n.indices,d).then(r=>{for(let p=0;p<n.graphics.length;p++){const t=n.graphics[p],J=r[p];if(t.attributes)for(const l in t.attributes)l in J||(J[l]=t.attributes[l]);t.attributes=J}return n.graphics})));return L.flatten(a)}throw new w("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available");});return U.apply(this,arguments)}function Ga(a,b,
c){const d=new Map,e=[];c=c();for(const n of a){var f=n.attributes[b];for(var g=0;g<c.length;g++){a=c[g];const r=a.featureIds.indexOf(f);if(0<=r){f=d.get(a.node);f||(f={node:a.node,indices:[],graphics:[]},e.push(f),d.set(a.node,f));f.indices.push(r);for(f.graphics.push(n);0<g;g--)c[g]=c[g-1];c[0]=a;break}}}return e}function Fa(a,b,c,d){return V.apply(this,arguments)}function V(){V=Y._asyncToGenerator(function*(a,b,c,d){b.sort((g,n)=>g.attributes[c]-n.attributes[c]);var e=b.map(g=>g.attributes[c]);
const f=[];d=fa(d,a.fields,{originalFields:f});a=yield ha(a,e,d);for(e=0;e<b.length;e++){const g=b[e],n=a[e],r={};if(g.attributes)for(const p in g.attributes)r[p]=g.attributes[p];for(let p=0;p<f.length;p++)r[f[p]]=n[d[p]];g.attributes=r}return b});return V.apply(this,arguments)}function ha(a,b,c){var d=a.capabilities.query.maxRecordCount;if(null!=d&&b.length>d)return d=L.splitIntoChunks(b,d),Promise.all(d.map(e=>ha(a,e,c))).then(L.flatten);d=new Ba({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});
return a.queryFeatures(d).then(e=>{if(e&&e.features&&e.features.length===b.length)return e.features.map(f=>f.attributes);throw new w("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer");})}function Ha(a,b,c,d,e){const f=[];for(const g of b)g&&e.includes(g.name)&&f.push({url:`${a}/nodes/${c.resources.attributes}/attributes/${g.key}/0`,storageInfo:g});return va.eachAlways(f.map(g=>ta(g.url,{responseType:"array-buffer"}).then(n=>Da.readBinaryAttribute(g.storageInfo,
n.data)))).then(g=>{const n=[];for(const r of d){const p={};for(let t=0;t<g.length;t++)null!=g[t].value&&(p[f[t].storageInfo.name]=ia(g[t].value,r));n.push(p)}return n})}function ia(a,b){if(!a)return null;b=a[b];return Z.isInt16Array(a)?-32768===b?null:b:Z.isInt32Array(a)?b===Ia?null:b:b!==b?null:b}function ja(a){var b=a.store.indexCRS||a.store.geographicCRS;const c=void 0===b?a.store.indexWKT:void 0;if(c)if(a.spatialReference){if(c!==a.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-index-incompatible",
"The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{});}else throw new w("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});b=b?new ba(T(b)):a.spatialReference;return b.equals(a.spatialReference)?a.spatialReference:b}function ka(a){var b=a.store.vertexCRS||a.store.projectedCRS;const c=void 0===b?a.store.vertexWKT:void 0;if(c)if(a.spatialReference){if(c!==
a.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{});}else throw new w("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});b=b?new ba(T(b)):a.spatialReference;return b.equals(a.spatialReference)?a.spatialReference:b}function M(a,b,c){if(!x.canProjectWithoutEngine(a,
b))throw new w("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===c&&!la(a,b))throw new w("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});}function la(a,b){return a.equals(b)||a.isWGS84&&b.isWebMercator||a.isWebMercator&&b.isWGS84}function ma(a,b,c){const d=ja(a);a=ka(a);M(d,b,c);M(a,b,c)}function na(a,
b,c,d,e=0){if(d===E.getSphericalPCPF(d))if(b.isGeographic){var f=E.getReferenceEllipsoid(b);d=1+Math.max(0,e)/(f.radius+a.center[2]);k.set(c.center,a.center[0],a.center[1],a.center[2]+e);x.projectBuffer(c.center,b,0,c.center,E.getSphericalPCPF(b),0,1);C.copy(c.quaternion,a.quaternion);C.conjugate(B,a.quaternion);k.set(m,0,0,1);k.transformQuat(m,m,B);k.set(m,a.halfSize[0]*Math.abs(m[0]),a.halfSize[1]*Math.abs(m[1]),a.halfSize[2]*Math.abs(m[2]));k.scale(m,m,f.inverseFlattening);k.add(c.halfSize,a.halfSize,
m);k.scale(c.halfSize,c.halfSize,d)}else{{I.corners(a,W);k.set(c.center,a.center[0],a.center[1],a.center[2]+e);x.computeTranslationToOriginAndRotation(b,c.center,v,E.getSphericalPCPF(b));k.set(c.center,v[12],v[13],v[14]);d=2*Math.sqrt(1+v[0]+v[5]+v[10]);B[0]=(v[6]-v[9])/d;B[1]=(v[8]-v[2])/d;B[2]=(v[1]-v[4])/d;B[3]=.25*d;C.multiply(c.quaternion,B,a.quaternion);C.conjugate(B,c.quaternion);let g=d=a=0;for(f of W)f[2]+=e,x.projectBuffer(f,b,0,f,E.getSphericalPCPF(b),0,1),k.sub(m,f,c.center),k.transformQuat(m,
m,B),a=Math.max(a,Math.abs(m[0])),d=Math.max(d,Math.abs(m[1])),g=Math.max(g,Math.abs(m[2]));k.set(c.halfSize,a,d,g)}}else b.isWGS84&&(d.isWebMercator||ca.isPlateCarree(d))?(k.copy(y,a.center),y[2]+=e,e=E.getSphericalPCPF(d),x.projectBuffer(y,b,0,y,e,0,1),oa(e,a,y,d,c)):b.isWebMercator&&ca.isPlateCarree(d)?(k.copy(y,a.center),y[2]+=e,oa(b,a,y,d,c)):a===c?(c.center[2]+=e,x.projectBuffer(c.center,b,0,c.center,d,0,1)):(k.set(c.center,a.center[0],a.center[1],a.center[2]+e),x.projectBuffer(c.center,b,0,
c.center,d,0,1),C.copy(c.quaternion,a.quaternion),k.copy(c.halfSize,a.halfSize))}function oa(a,b,c,d,e){const f=wa.fromQuat(Ja,b.quaternion);for(let n=0;8>n;++n){for(var g=0;3>g;++g)pa[g]=b.halfSize[g]*(0!==(n&1<<g)?-1:1);for(g=0;3>g;++g){let r=c[g];for(let p=0;3>p;++p)r+=pa[p]*f[3*p+g];N[3*n+g]=r}}x.projectBuffer(N,a,0,N,d,0,8);I.compute(Ka,e)}const K=A.create(),La=R.create();h.MbsIntersectResult=void 0;(function(a){a[a.OUTSIDE=0]="OUTSIDE";a[a.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE";
a[a.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE";a[a.INSIDE=3]="INSIDE"})(h.MbsIntersectResult||(h.MbsIntersectResult={}));const Ia=-(2**31);R=da.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});let qa=function(){this.material=this.edgeMaterial=null;this.castShadows=!0};const D=H.create(),F=H.create(),G=H.create(),O=Aa.create(),N=new Float64Array(24),Ka={data:N,size:3},pa=H.create(),y=H.create(),Ja=xa.create(),v=aa.create(),B=za.create(),W=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,
0,0],[0,0,0],[0,0,0]],X=A.create(),P=A.create(),ra=I.create(),m=[0,0,0],sa={data:Array(72),size:3},Q=aa.create();h.SymbolInfo=qa;h.addWraparound=function(a,b){return(a|0)+(b|0)|0};h.checkPointCloudLayerCompatibleWithView=function(a,b){M(a.spatialReference,b.spatialReference,b.viewingMode)};h.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null==a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==
a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new w("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});};h.checkSceneLayerCompatibleWithView=function(a,b){ma(a,b.spatialReference,b.viewingMode)};h.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(b=a.store.defaultGeometrySchema,b=!!(null!=
b.geometryType&&"triangles"!==b.geometryType||null!=b.topology&&"PerAttributeArray"!==b.topology||null==b.vertexAttributes||null==b.vertexAttributes.position));if(b)throw new w("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:a.parsedUrl.path});};h.checkSpatialReference=M;h.checkSpatialReferences=ma;h.computeOffsetObb=function(a,b,c,d,e){C.copy(e.quaternion,a.quaternion);if(d===Ca.ViewingMode.Global){C.conjugate(O,a.quaternion);k.transformQuat(D,
a.center,O);k.abs(F,D);k.min(G,F,a.halfSize);k.sub(G,F,G);d=k.length(G);k.add(G,F,a.halfSize);const f=k.length(G);d<c?(k.copy(e.center,a.center),k.set(D,c,c,c),k.add(e.halfSize,a.halfSize,D)):(b=0<f?1+b/f:1,d=0<d?1+c/d:1,c=(d+b)/2,b=(d-b)/2,k.scale(e.halfSize,F,b),k.scaleAndAdd(e.halfSize,e.halfSize,a.halfSize,c),k.scale(e.center,F,c),k.scaleAndAdd(e.center,e.center,a.halfSize,b),k.sign(D,D),k.multiply(e.center,e.center,D),k.transformQuat(e.center,e.center,e.quaternion))}else d=k.set(D,0,0,1),k.scaleAndAdd(e.center,
a.center,d,(c+b)/2),C.conjugate(O,a.quaternion),k.transformQuat(d,d,O),k.abs(d,d),k.scaleAndAdd(e.halfSize,a.halfSize,d,(c-b)/2);return e};h.computeVisibilityObb=function(a,b,c,d,e,f){if(!f||0===f.length||u.isNone(b))return null;const g=Ea.computeGlobalTransformation(a.mbs,e,c,b);ya.invert(Q,g);let n;const r=()=>{if(!n)if(n=W,A.empty(P),u.isSome(a.serviceObb)){na(a.serviceObb,c,ra,b,e);I.corners(ra,n);for(var l of n)k.transformMat4(l,l,Q),A.expandPointInPlace(P,l)}else{var q=a.mbs;l=q[3];x.projectVectorToVector(q,
c,m,b);k.transformMat4(m,m,Q);m[2]+=e;for(q=0;8>q;++q){const z=n[q];k.copy(z,[m[0]+(q&1?l:-l),m[1]+(q&2?l:-l),m[2]+(q&4?l:-l)]);A.expandPointInPlace(P,z)}}};let p=Infinity,t=-Infinity;const J=l=>{if("replace"===l.type&&(l=l.geometry,l.hasZ)){A.empty(X);var q=l.spatialReference||d;l=l.rings.reduce((z,Ma)=>Ma.reduce((Na,Oa)=>{x.projectVectorToVector(Oa,q,m,b);k.transformMat4(m,m,Q);A.expandPointInPlace(X,m);return Math.min(m[2],Na)},z),Infinity);r();A.intersects(P,X)&&(p=Math.min(p,l),t=Math.max(t,
l))}};f.forEach(l=>J(l));if(Infinity===p)return null;f=(l,q,z)=>{k.transformMat4(m,z,g);l[q+0]=m[0];l[q+1]=m[1];l[q+2]=m[2];q+=24;z[2]=p;k.transformMat4(m,z,g);l[q+0]=m[0];l[q+1]=m[1];l[q+2]=m[2];q+=24;z[2]=t;k.transformMat4(m,z,g);l[q+0]=m[0];l[q+1]=m[1];l[q+2]=m[2]};for(let l=0;8>l;++l)f(sa.data,3*l,n[l]);return I.compute(sa)};h.containsDraco=function(a){if(ua("disable-feature:i3s-draco")||!a)return!1;for(const c of a)for(const d of c.geometryBuffers){var b;if("draco"===(null==(b=d.compressedAttributes)?
void 0:b.encoding))return!0}return!1};h.extractWkid=T;h.filterInPlace=function(a,b,c){let d=0,e=0;for(let f=0;f<b.length&&d<a.length;f++)a[d]===b[f]&&(c(f)&&(a[e]=a[d],e++),d++);a.length=e};h.findFieldsCaseInsensitive=fa;h.findIntersectingNodes=function(a,b,c,d,e,f){const g=b!==d;e.traverse(c,n=>{let r=n.mbs;g&&(r=La,x.projectBoundingSphere(n.mbs,d,r,b));if(ea(a,r)===h.MbsIntersectResult.OUTSIDE)return!1;f(n);return!0})};h.getCacheKeySuffix=function(a,b){return u.isNone(b)?"@null":b===E.getSphericalPCPF(b)?
"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};h.getCachedAttributeValue=ia;h.getClipRect=function(a,b){if(0===b.rotationScale[1]&&0===b.rotationScale[2]&&0===b.rotationScale[3]&&0===b.rotationScale[5]&&0===b.rotationScale[6]&&0===b.rotationScale[7])return K[0]=(a[0]-b.position[0])/b.rotationScale[0],K[1]=(a[1]-b.position[1])/b.rotationScale[4],K[2]=(a[2]-b.position[0])/b.rotationScale[0],K[3]=(a[3]-b.position[1])/b.rotationScale[4],K};h.getIndexCrs=ja;h.getSymbolInfo=function(a){const b=new qa;
var c=!1;let d=!1;for(const f of a.symbolLayers.items)if("fill"===f.type&&f.enabled){var e=f.material;a=f.edges;u.isSome(e)&&!c&&(c=e.color,e=S.parseColorMixMode(e.colorMixMode),u.isSome(c)?b.material={color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:e}:b.material={color:[1,1,1],alpha:1,colorMixMode:S.ColorMixModeEnum.Multiply},b.castShadows=f.castShadows,c=!0);u.isSome(a)&&!d&&(b.edgeMaterial=da.createMaterialFromEdges(a,{}),d=!0)}b.material||(b.material={color:[1,1,1],alpha:1,colorMixMode:S.ColorMixModeEnum.Multiply});
return b};h.getVertexCrs=ka;h.intersectBoundingBoxWithMbs=function(a,b){var c=b[0],d=b[1],e=b[2];b=b[3];const f=a[0]-c;c-=a[3];const g=a[1]-d;d-=a[4];const n=a[2]-e;a=e-a[5];e=Math.max(f,c,0);const r=Math.max(g,d,0),p=Math.max(n,a,0);e=e*e+r*r+p*p;return e>b*b?h.MbsIntersectResult.OUTSIDE:0<e?h.MbsIntersectResult.INTERSECTS_CENTER_OUTSIDE:-Math.max(f,c,g,d,n,a)>b?h.MbsIntersectResult.INSIDE:h.MbsIntersectResult.INTERSECTS_CENTER_INSIDE};h.intersectBoundingRectWithMbs=ea;h.invalidateMbs=function(a){u.isSome(a)&&
(a[3]=-1)};h.invalidateObb=function(a){u.isSome(a)&&(a.halfSize[0]=-1)};h.isSupportedLocalModeProjection=la;h.isValidMbs=function(a){return 0<=a[3]};h.isValidObb=function(a){return u.isSome(a)&&0<=a.halfSize[0]};h.objectIdFilter=function(a,b,c){let d=0,e=0;for(;d<c.length;)0<=L.binaryIndexOf(a,c[d])===b&&(c[e]=c[d],e++),d++;c.length=e};h.rendererNeedsTextures=function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&
null==a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(const b of a){if("mesh-3d"!==b.type||0===b.symbolLayers.length)return!0;for(const c of b.symbolLayers.items)if("fill"!==c.type||u.isNone(c.material)||u.isNone(c.material.color)||"replace"!==c.material.colorMixMode)return!0}return!1};h.transformObb=na;h.transparentEdgeMaterial=R;h.whenGraphicAttributes=function(a,b,c,d,e){return U.apply(this,arguments)};Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});