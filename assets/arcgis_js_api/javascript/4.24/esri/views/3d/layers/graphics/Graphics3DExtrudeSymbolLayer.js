// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/maybe ../../../../chunks/earcut ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec32 ../../../../renderers/support/renderingInfoUtils ../../../ViewingMode ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(da,ea,va,K,wa,xa,ya,fa,O,B,E,za,S,ha,ia,Aa,Ba,T,Ca,Da,Y,ja,ka,la,Ea,Fa,Ga,U,Ha,Ia,C,ma){function na(f,l,e,b){var a=new Uint32Array(f.length);b=[[C.VertexAttribute.POSITION,{size:3,data:e.positions,exclusive:!0}],[C.VertexAttribute.NORMAL,{size:3,data:e.normals,exclusive:!0}],[C.VertexAttribute.COLOR,{size:4,data:b,exclusive:!0}],[C.VertexAttribute.SIZE,{size:1,data:e.heights,exclusive:!0}]];a=[[C.VertexAttribute.POSITION,f],[C.VertexAttribute.NORMAL,f],[C.VertexAttribute.COLOR,a]];e.elevation&&
(b.push([C.VertexAttribute.MAPPOS,{size:3,data:e.elevation}]),a.push([C.VertexAttribute.MAPPOS,f]));return new Ha.Geometry(b,a,U.PrimitiveType.Triangle,l)}function Ja(f,l,e,b,a,c,g,u,h,r,n,p,k,q){let w=0;var v=2*b.count;{var d=b.index,y=b.count,x=e.length/3,m=h;B.copy(z,k);const t=0<p?1:-1;d*=3;let A=m;k=3*A;let F=m+y;m=3*F;for(let G=0;G<y;++G)q&&(z[0]=f[d+0],z[1]=f[d+1],z[2]=f[d+2],B.normalize(z,z)),a[k+0]=f[d+0],a[k+1]=f[d+1],a[k+2]=f[d+2],c[k+0]=l[d+0],c[k+1]=l[d+1],c[k+2]=l[d+2],g[k+0]=-t*z[0],
g[k+1]=-t*z[1],g[k+2]=-t*z[2],u[A]=0,a[m+0]=f[d+0]+p*z[0],a[m+1]=f[d+1]+p*z[1],a[m+2]=f[d+2]+p*z[2],c[m+0]=l[d+0],c[m+1]=l[d+1],c[m+2]=l[d+2],g[m+0]=t*z[0],g[m+1]=t*z[1],g[m+2]=t*z[2],u[F]=p,k+=3,m+=3,d+=3,A+=1,F+=1;k=d=0;m=3*v;f=0>p?oa:pa;l=0>p?pa:oa;for(q=0;q<x;++q)n[k+0]=e[d+f[0]],n[k+1]=e[d+f[1]],n[k+2]=e[d+f[2]],r[m+0]=e[d+l[0]]+y,r[m+1]=e[d+l[1]]+y,r[m+2]=e[d+l[2]]+y,k+=3,m+=3,d+=3}h+=2*b.count;v=0;qa(a,c,u,g,w,b.pathLengths[0],b.count,h,r,v,p);h+=4*b.pathLengths[0];v+=2*b.pathLengths[0];w+=
b.pathLengths[0];for(e=1;e<b.pathLengths.length;++e)qa(a,c,u,g,w,b.pathLengths[e],b.count,h,r,v,p),h+=4*b.pathLengths[e],v+=2*b.pathLengths[e],w+=b.pathLengths[e]}function V(f,l,e,b,a,c,g){b[c]=b[g];g*=3;c*=3;f[c+0]=f[g+0];f[c+1]=f[g+1];f[c+2]=f[g+2];l[c+0]=l[g+0];l[c+1]=l[g+1];l[c+2]=l[g+2];e[c+0]=a[0];e[c+1]=a[1];e[c+2]=a[2]}function qa(f,l,e,b,a,c,g,u,h,r,n){let p=a,k=a+1,q=a+g,w=a+g+1,v=u,d=u+1,y=u+2*c;u=u+2*c+1;0>n&&(p=a+g+1,w=a);r*=3;for(let G=0;G<c;++G){G===c-1&&(0<n?(k=a,w=a+g):(k=a,p=a+g));
var x=f,m=p,t=k,A=q,F=P;m*=3;t*=3;A*=3;B.set(Z,x[m++],x[m++],x[m++]);B.set(ra,x[t++],x[t++],x[t++]);B.set(sa,x[A++],x[A++],x[A++]);B.subtract(ta,ra,Z);B.subtract(ua,sa,Z);B.cross(F,ua,ta);B.normalize(F,F);V(f,l,b,e,P,v,p);V(f,l,b,e,P,d,k);V(f,l,b,e,P,y,q);V(f,l,b,e,P,u,w);h[r++]=v;h[r++]=y;h[r++]=u;h[r++]=v;h[r++]=u;h[r++]=d;p++;k++;q++;w++;v+=2;d+=2;y+=2;u+=2}}function Ka(f,l,e,b){f=f.stageObject;const a=f.geometryRecords,c=a.length,g="absolute-height"!==l.mode;let u=0;const h=f.transformation,r=
fa.invert(O.create(),h);for(let p=0;p<c;p+=2){const k=a[p].geometry,q=k.getMutableAttribute(C.VertexAttribute.POSITION).data,w=k.vertexAttributes.get(C.VertexAttribute.SIZE).data;var n=k.vertexAttributes.get(C.VertexAttribute.MAPPOS).data;n=new Ga.SamplePosition(n);const v=q.length/3;let d=0,y=!1,x=0;const m=e.spatialReference;for(let t=0;t<v;t++){N[0]=q[d];N[1]=q[d+1];N[2]=q[d+2];T.evaluateElevationInfoAtPoint(n,e,l,b,W);g&&(x+=W.sampledElevation);Fa.TESTS_DISABLE_OPTIMIZATIONS?(B.set(D,n.array[n.offset+
0],n.array[n.offset+1],W.z+w[d/3]),b.toRenderCoords(D,m,D)):(B.set(D,q[d+0],q[d+1],q[d+2]),B.transformMat4(D,D,h),b.setAltitude(D,W.z+w[d/3]));B.transformMat4(D,D,r);q[d]=D[0];q[d+1]=D[1];q[d+2]=D[2];const A=.01/b.unitInMeters;if(Math.abs(N[0]-q[d])>=A||Math.abs(N[1]-q[d+1])>=A||Math.abs(N[2]-q[d+2])>=A)y=!0;n.offset+=3;d+=3}y&&(k.invalidateBoundingInfo(),f.geometryVertexAttrsUpdated(a[p]),a[p+1].geometry.invalidateBoundingInfo(),f.geometryVertexAttrsUpdated(a[p+1]));u+=x/v}return u/c}const La=["polygon",
"extent"];Y=function(f){function l(b,a,c,g){b=f.call(this,b,a,c,g)||this;b.ensureDrapedStatus(!1);return b}ea._inheritsLoose(l,f);var e=l.prototype;e.doLoad=function(){var b=ea._asyncToGenerator(function*(){if(!this._drivenProperties.size){var a=ja.validateSymbolLayerSize(this._getSymbolSize());if(a)throw new va("graphics3dextrudesymbollayer:invalid-size",a);}a=K.get(this.symbolLayer,"material","color");var c=this._getCombinedOpacityAndColor(a);a=E.fromArray(c);c=c[3];const g=1>c||this.needsDrivenTransparentPass;
a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:c,transparent:g,cullFace:g?U.CullFaceOptions.None:U.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new ma.DefaultMaterial(a);this._bottomMaterial=new ma.DefaultMaterial({...a,cullFace:U.CullFaceOptions.Back});this._context.stage.add(this._material);this._context.stage.add(this._bottomMaterial)});
return function(){return b.apply(this,arguments)}}();e.destroy=function(){f.prototype.destroy.call(this);this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))};e.createGraphics3DGraphic=function(b){const a=b.graphic;if(!this._validateGeometry(a.geometry,La,this.symbolLayer.type))return null;const c=this._getVertexOpacityAndColor(b.renderingInfo,255),g=this.setGraphicElevationContext(a,new Ca.ElevationContext);return this._createAs3DShape(a,b.renderingInfo,
c,g,a.uid)};e.layerOpacityChanged=function(b,a){var c=K.get(this.symbolLayer,"material","color");c=this._getCombinedOpacity(c);const g=1>c||this.needsDrivenTransparentPass;this._material.setParameters({opacity:c,transparent:g});this._bottomMaterial.setParameters({opacity:c,transparent:g});const u=this._getLayerOpacity();b.forEach(h=>{h=a(h);K.isSome(h)&&h.layerOpacityChanged(u,this._context.isAsync)});return!0};e.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,
a,T.needsElevationUpdates3D)};e.slicePlaneEnabledChanged=function(b,a){this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});b.forEach(c=>{c=a(c);K.isSome(c)&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0};e.physicalBasedRenderingChanged=function(){this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});
this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};e.pixelRatioChanged=function(){return!0};e._getExtrusionSize=function(b){if(b.size&&this._drivenProperties.size){var a;b=null!=(a=Aa.getDriverAxisSizeValue(b.size,2))?a:0}else b=this._getSymbolSize();return b/=this._context.renderCoordsHelper.unitInMeters};e.applyRendererDiff=function(b,a){return this._drivenPropertiesChanged(a)?ka.ApplyRendererDiffResult.Recreate_Symbol:ka.ApplyRendererDiffResult.Recreate_Graphics};
e._getSymbolSize=function(){var b;return null!=(b=this.symbolLayer.size)?b:1};e._createAs3DShape=function(b,a,c,g,u){var h=la.geometryAsPolygon(b.geometry);if(K.isNone(h))return null;b=la.geometryToRenderInfo(h,this._context.elevationProvider,this._context.renderCoordsHelper,g);this._logGeometryCreationWarnings(b,h.rings,"rings","ExtrudeSymbol3DLayer");if(0===h.rings.length||!h.rings.some(Q=>0<Q.length))return null;var r=ja.computeCentroid(h);if(K.isNone(r))return null;var n=[];const p=[],k=[],q=
S.create(),w=O.create(),v=E.create(),d=this._context.renderCoordsHelper.viewingMode===Ba.ViewingMode.Global;d||this._context.renderCoordsHelper.worldUpAtPosition(null,v);za.computeTranslationToOriginAndRotation(h.spatialReference,[r.x,r.y,0],w,this._context.renderCoordsHelper.spatialReference);h=O.create();fa.invert(h,w);r=ya.create();xa.normalFromMat4(r,h);const {polygons:y,mapPosition:x,position:m}=b;var t=m.length/3;const A=new Float64Array(18*t),F=new Float64Array(18*t),G=new Float64Array(18*
t);t=new Float64Array(6*t);let L=0;for(let Q=0;Q<y.length;++Q){var M=y[Q];const aa=M.count;if(this._context.clippingExtent&&(S.empty(q),S.expandWithBuffer(q,M.mapPosition),!S.intersectsClippingArea(q,this._context.clippingExtent)))continue;const X=wa.earcut(M.mapPosition,M.holeIndices,3);if(0===X.length)continue;const ba=new Uint32Array(6*aa+X.length);var R=new Uint32Array(X.length),J=6*aa,H=3*A.BYTES_PER_ELEMENT;H=new ha.BufferViewVec3f64(A.buffer,L*H,H,(L+J)*H);var I=3*F.BYTES_PER_ELEMENT;I=new ha.BufferViewVec3f64(F.buffer,
L*I,I,(L+J)*I);const ca=new Float64Array(G.buffer,3*L*G.BYTES_PER_ELEMENT,3*J);J=new Float64Array(t.buffer,1*L*t.BYTES_PER_ELEMENT,1*J);const Ma=this._getExtrusionSize(a);Ja(m,x,X,M,H.typedBuffer,ca,I.typedBuffer,J,0,ba,R,Ma,v,d);ia.transformMat4(H,H,h);ia.transformMat3(I,I,r);L+=6*aa;M=na(ba,ba.length-R.length,{positions:H.typedBuffer,elevation:ca,normals:I.typedBuffer,heights:J},c);n.push(M);p.push(this._material);k.push(O.IDENTITY);R=na(R,0,{positions:H.typedBuffer,elevation:ca,normals:I.typedBuffer,
heights:J},c);n.push(R);p.push(this._bottomMaterial);k.push(O.IDENTITY)}if(0===n.length)return null;a=new Ia.Object3D({geometries:n,materials:p,transformations:k,metadata:{layerUid:this._context.layer.uid,graphicUid:u,isElevationSource:!0}});a.transformation=w;c=Ea.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()});c=K.isSome(c)?{baseMaterial:this._material,edgeMaterials:[c],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null;n=new Da.Graphics3DObject3DGraphicLayer(this,
a,n,null,null,Ka,g,c);n.alignedSampledElevation=b.sampledElevation;n.needsElevationUpdates=T.needsElevationUpdates3D(g.mode);return n};return l}(Y.Graphics3DSymbolLayer);const P=E.create(),Z=E.create(),ra=E.create(),sa=E.create(),ta=E.create(),ua=E.create(),N=E.create(),D=E.create(),z=E.create(),W=new T.SampleElevationInfo,pa=[0,2,1],oa=[0,1,2];da.Graphics3DExtrudeSymbolLayer=Y;Object.defineProperties(da,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});