// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../core/sql/WhereClause ../../../layers/support/FeatureFilter ../../../layers/support/floorFilterUtils ../../../rest/support/Query ./I3SMeshView3D ./II3SMeshView3D ./LayerView3D ./i3s/attributeEditing ./i3s/I3SGeometryUtil ./i3s/I3SMeshViewFilter ./i3s/I3SNode ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ./support/fieldProperties ./support/PopupSceneLayerView ./support/SceneLayerViewRequiredFields ../support/updatingProperties ../../layers/SceneLayerView ../../support/Scheduler".split(" "),
function(t,g,z,n,e,u,h,S,T,U,A,B,C,D,q,f,r,E,v,F,w,x,G,H,I,y,J,K,L,M,N,O,P){const Q=n.getLogger("esri.views.3d.layers.SceneLayerView3D");n=K.defineFieldProperties();f=function(m){function p(){var a=m.apply(this,arguments)||this;a.type="scene-layer-3d";a.lodFactor=1;a.progressiveLoadFactor=1;a._elevationContext="scene";a._isIntegratedMesh=!1;a._supportsLabeling=!0;a._interactiveEditingSessions=new Map;a._queryEngine=null;return a}t._inheritsLoose(p,m);var c=p.prototype;c.initialize=function(){this.fieldsHelper=
new M.SceneLayerViewRequiredFields({layerView:this});this.updatingHandles.add(()=>this.layer.rangeInfos,a=>this._rangeInfosChanged(a),u.initial);this.updatingHandles.add(()=>this.layer.renderer,a=>this.updatingHandles.addPromise(this._rendererChange(a)),u.initial);this.updatingHandles.add(()=>[this.parsedDefinitionExpression,this.filter,this.layer.filter,this.floorFilterClause,this.excludeObjectIdsSorted,e.applySome(this.viewFilter,a=>[a.parsedWhereClause,a.parsedGeometry,a.sortedObjectIds])],()=>
this._filterChange());this.updatingHandles.add(()=>[this.filter,e.applySome(this.viewFilter,a=>a.parsedGeometry)],()=>this._geometryFilterChange());this.handles.add(this.layer.on("apply-edits",a=>this.updatingHandles.addPromise(a.result)));this.handles.add(this.layer.on("edits",a=>this._handleEdits(a)))};c.destroy=function(){this.fieldsHelper=e.destroyMaybe(this.fieldsHelper)};c._rangeInfosChanged=function(a){null!=a&&0<a.length&&Q.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};
c.createQuery=function(){const a={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return e.isSome(this.filter)?this.filter.createQuery(a):new q(a)};c.queryExtent=function(a,b){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(a),null==b?void 0:b.signal)};c.queryFeatureCount=function(a,b){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(a),null==b?void 0:b.signal)};c.queryFeatures=function(a,b){return this._ensureQueryEngine().executeQuery(this._ensureQuery(a),
null==b?void 0:b.signal).then(d=>{if(null==d||!d.features)return d;const k=this.layer;for(const l of d.features)l.layer=k,l.sourceLayer=k;return d})};c.queryObjectIds=function(a,b){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(a),null==b?void 0:b.signal)};c._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};c._createQueryEngine=function(){const a=F.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,
this._collection);return new G.I3SQueryEngine({layerView:this,priority:P.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new I.I3SQueryFeatureStore({featureAdapter:new H.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:a}),toArray:()=>{const b=[];this._forAllFeatures((d,k,l)=>{b.push({id:d,index:k,meta:l});return r.ForAllFeaturesReturnType.CONTINUE},null,r.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA);return b},
forAllFeatures:(b,d)=>this._forAllFeatures((k,l,R)=>b({id:k,index:l,meta:R}),d,r.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA),getFeatureExtent:a,sourceSpatialReference:y.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})};c.highlight=function(a){const b=this._highlights;if(a instanceof q){const {set:d,handle:k}=b.acquireSet();this.queryObjectIds(a).then(l=>b.setFeatureIds(d,l));return k}return m.prototype.highlight.call(this,a)};c.createInteractiveEditSession=function(a){return v.createInteractiveEditSession(this.attributeEditingContext,
a)};c._createLayerGraphic=function(a){a=new z(null,null,a);a.layer=this.layer;a.sourceLayer=this.layer;return a};c.canResume=function(){return m.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)};c.getFilters=function(){const a=m.prototype.getFilters.call(this),b=this.excludeObjectIdsSorted;e.isSome(b)&&a.push(d=>y.objectIdFilter(b,!1,d));this.floorFilterClause&&this.addSqlFilter(a,this.floorFilterClause,this.logError);this.addSqlFilter(a,this.parsedDefinitionExpression,
this.logError);e.isSome(this.viewFilter)&&this.viewFilter.addFilters(a,this.view,this._controller.crsIndex,this._collection);return a};c.isUpdating=function(){return m.prototype.isUpdating.call(this)||this.layerFilterUpdating};c._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(e.isNone(a)?this.createQuery():q.from(a))};c._handleEdits=function(a){v.processAttributeEdits(this.attributeEditingContext,a)};c.computeNodeFiltering=function(a){const b=this.viewFilter;return e.isNone(b)||
b.isMBSGeometryVisible(a,this.view.spatialReference,this._controller.crsIndex)?x.NodeFilterImpact.Unmodified:x.NodeFilterImpact.Culled};t._createClass(p,[{key:"filter",get:function(){return this._get("filter")},set:function(a){this._set("filter",w.I3SMeshViewFilter.checkSupport(a)?a:null)}},{key:"viewFilter",get:function(){const a=this.filter;if(e.isNone(a)&&e.isNone(this.layerFilter))return null;const b=this._get("viewFilter");if(e.isNone(b))return new w.I3SMeshViewFilter({layerFilter:this.layerFilter,
viewFilter:a,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:d=>this._loadAsyncModule(d),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(d,k)=>this.addSqlFilter(d,k,this.logError)});b.viewFilter=this.filter;b.layerFilter=this.layerFilter;this.notifyChange("viewFilter");return b}},{key:"requiredFields",get:function(){var a,b;return null!=(a=null==(b=this.fieldsHelper)?void 0:b.requiredFields)?a:[]}},{key:"floorFilterClause",get:function(){const a=D.getFloorFilterClause(this);return e.isSome(a)?
B.WhereClause.create(a,this.layer.fieldsIndex):null}},{key:"excludeObjectIdsSorted",get:function(){const a=this.layer.excludeObjectIds;return a.length?a.toArray().sort((b,d)=>b-d):null}},{key:"lodCrossfadeinDuration",get:function(){var a,b;return null!=(a=null==(b=this.view)?void 0:b.qualitySettings.sceneService["3dObject"].lodCrossfadeinDuration)?a:0}},{key:"lodCrossfadeoutDuration",get:function(){var a,b;return null!=(a=null==(b=this.view)?void 0:b.qualitySettings.sceneService["3dObject"].lodCrossfadeoutDuration)?
a:0}},{key:"lodCrossfadeUncoveredDuration",get:function(){var a,b;return null!=(a=null==(b=this.view)?void 0:b.qualitySettings.sceneService["3dObject"].lodCrossfadeUncoveredDuration)?a:0}},{key:"attributeEditingContext",get:function(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:a=>this._forAllNodes(b=>e.isSome(b)?a(b.node,b.featureIds):null),attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this.attributeOverrides,
getAttributeData:a=>this.getAttributeData(a),setAttributeData:(a,b)=>this.setAttributeData(a,b),clearMemCache:()=>this.clearMemCache()}}},{key:"hasGeometryFilter",get:function(){const a=this.viewFilter;return e.isSome(a)&&e.isSome(a.parsedGeometry)}}]);return p}(f.I3SMeshView3D(J.DefinitionExpressionSceneLayerView(L.PopupSceneLayerView(E.LayerView3D(O)))));g.__decorate([h.property({aliasOf:"layer"})],f.prototype,"i3slayer",void 0);g.__decorate([h.property(N.updatingProgress)],f.prototype,"updatingProgress",
void 0);g.__decorate([h.property({type:C})],f.prototype,"filter",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"viewFilter",null);g.__decorate([h.property(n.requiredFields)],f.prototype,"requiredFields",null);g.__decorate([h.property(n.availableFields)],f.prototype,"availableFields",void 0);g.__decorate([h.property()],f.prototype,"fieldsHelper",void 0);g.__decorate([h.property()],f.prototype,"floorFilterClause",null);g.__decorate([h.property()],f.prototype,"excludeObjectIdsSorted",null);
g.__decorate([h.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],f.prototype,"lodFactor",void 0);g.__decorate([h.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],f.prototype,"updatingProgressValue",void 0);return f=g.__decorate([A.subclass("esri.views.3d.layers.SceneLayerView3D")],f)});