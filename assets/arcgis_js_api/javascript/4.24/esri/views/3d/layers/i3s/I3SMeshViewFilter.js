// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../core/sql/WhereClause ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/Ellipsoid ../../../../geometry/support/webMercatorUtils ../../../../layers/support/FeatureFilter ./I3SUtil ../../../../geometry/SpatialReference".split(" "),
function(Y,r,M,u,qa,Z,N,aa,ba,m,ca,da,v,ra,sa,ea,w,fa,x,ha,F,ia,O,ja,P,Q){function E(g,c,b){if(m.isNone(c))return null;if("disjoint"===b&&"polygon"===c.type){const d=Array(c.rings.length);for(b=0;b<c.rings.length;++b){var a=F.fromValues(Infinity,Infinity,-Infinity,-Infinity);F.expandWithNestedArray(a,c.rings[b]);d[b]={type:"polygon",rings:[c.rings[b]],spatialReference:c.spatialReference,aabr:a}}d.sort((f,e)=>f.aabr[0]-e.aabr[0]);const n=new Set,k=new N.PositionHint;for(c=0;c<d.length;++c){const f=
d[c];for(b=c+1;b<d.length;++b){a=d[b];if(a.aabr[0]>=f.aabr[2])break;n.add(a)}n.forEach(e=>{f!==e&&(e.aabr[2]<=f.aabr[0]?n.delete(e):g.intersects(f,e)&&(f.rings=f.rings.concat(e.rings),F.expand(f.aabr,e.aabr,f.aabr),delete f._geVersion,n.delete(e),e=N.indexOf(d,e,d.length,k),d.splice(e,1)))});n.add(f)}for(const f of d)delete f.aabr;return d}return[c]}function R(g,c,b,a,d){const n=S(g,c,a);return b.every(k=>T(g,k,n,d)!==q.DISCARD)}function U(g,c,b,a,d,n,k,f){const e=k[0].spatialReference||d.spatialReference;
if(x.projectBoundingSphere(b.node.mbs,n,C,e)){n=S(g,C,e);var t=ka(f,d,e,a,b.objectHandle);for(const h of k){if(0===c.length)break;switch(T(g,h,n,f)){case q.DISCARD:c.length=0;return;case q.KEEP:continue}P.filterInPlace(c,b.featureIds,l=>la(g,h,l,t))}}else B.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")}function ka(g,c,b,a,d){c=c.renderSpatialReference;const n=new Map,k={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",
spatialReference:b};k.rings[0][3]=k.rings[0][0];let f,e;switch(g){case "intersects":f=(t,h,l)=>t.intersects(h,l)?q.KEEP:q.TEST;e=G;break;case "contains":f=(t,h,l)=>t.contains(h,l)?q.TEST:q.DISCARD;e=G;break;default:f=(t,h,l)=>t.disjoint(h,l)?q.TEST:q.DISCARD,e=V}return{collection:a,object:d,type:g,maskSR:b,renderSR:c,aabbCache:n,triangle:k,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:f,geometryTest:e}}function S(g,c,b){const a={x:c[0],y:c[1],hasZ:!1,hasM:!1,type:"point",
spatialReference:b};b=!b.isWGS84&&!b.isWebMercator;c=Number.isNaN(c[3])?0:ba.clamp(c[3],0,2*ia.earth.radius);g=b?g.buffer(a,c,1):g.geodesicBuffer(a,c,1);g.type="polygon";return g}function T(g,c,b,a){switch(a){case "intersects":case "contains":return G(g,c,b);case "disjoint":return V(g,c,b)}}function G(g,c,b){return g.intersects(c,b)?g.contains(c,b)?q.KEEP:q.TEST:q.DISCARD}function V(g,c,b){return g.intersects(c,b)?g.contains(c,b)?q.DISCARD:q.TEST:q.KEEP}function la(g,c,b,a){const {collection:d,object:n,
renderSR:k,maskSR:f,geometryTest:e,aabbCache:t}=a;var h=t.get(b);if(!h){h=d.getObjectTransform(n);d.getComponentAabb(n,b,y);var l=[[y[0],y[1],0],[y[0],y[4],0],[y[3],y[4],0],[y[3],y[1],0]];for(var p=0;4>p;++p)w.transformMat3(l[p],l[p],h.rotationScale),w.add(l[p],l[p],h.position),x.projectVectorToVector(l[p],k,l[p],f);h={rings:[l],hasZ:!1,hasM:!1,type:"polygon",spatialReference:f};h.rings[0][4]=h.rings[0][0];t.set(b,h)}switch(e(g,c,h)){case q.DISCARD:return!1;case q.KEEP:return!0}const {triangle:z,
triangleTest:ma,positions:W}=a;h=z.rings[0][0];l=z.rings[0][1];p=z.rings[0][2];const D=d.getObjectTransform(n);d.getComponentPositions(n,b,W);const {indices:H,data:A,stride:I,startIndex:na,endIndex:oa}=W;for(b=na;b<oa;b+=3){const J=I*H[b+0],K=I*H[b+1],L=I*H[b+2];w.set(h,A[J+0],A[J+1],A[J+2]);w.set(l,A[K+0],A[K+1],A[K+2]);w.set(p,A[L+0],A[L+1],A[L+2]);w.transformMat3(h,h,D.rotationScale);w.transformMat3(l,l,D.rotationScale);w.transformMat3(p,p,D.rotationScale);w.add(h,h,D.position);w.add(l,l,D.position);
w.add(p,p,D.position);x.projectVectorToVector(h,k,h,f);x.projectVectorToVector(l,k,l,f);x.projectVectorToVector(p,k,p,f);if(!(Math.abs((l[0]-h[0])*(p[1]-h[1])-(l[1]-h[1])*(p[0]-h[0]))<pa))switch(delete z._geVersion,ma(g,c,z)){case q.DISCARD:return!1;case q.KEEP:return!0}}switch(a.type){case "intersects":return!1;default:return!0}}const B=aa.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");r.I3SMeshViewFilter=function(g){function c(a){a=g.call(this,a)||this;a._projectionEngineLoaded=!1;return a}
M._inheritsLoose(c,g);var b=c.prototype;b.initialize=function(){ca.whenOnce(()=>{var a;return(null==(a=m.unwrap(this.viewFilter))?void 0:a.geometry)||m.isSome(this.layerFilter)}).then(()=>this.loadAsyncModule((new Promise((a,d)=>Y(["../../../../geometry/geometryEngine"],a,d))).then(a=>{this.destroyed||(this._geometryEngine=a,this.applyFilters())})))};b.addFilters=function(a,d,n,k){const f=this.sortedObjectIds;m.isSome(f)&&a.push(l=>P.objectIdFilter(f,!0,l));this.addSqlFilter(a,this.parsedWhereClause);
const e=this._layerMaskGeometries,t=this._geometryEngine;if(m.isSome(e)&&m.isSome(this.layerFilter)&&m.isSome(t)){const l=this.layerFilter.spatialRelationship;a.push((p,z)=>U(t,p,z,k,d,n,e,l))}const h=this._viewMaskGeometries;if(m.isSome(h)&&m.isSome(this.viewFilter)&&m.isSome(t)){const l=this.viewFilter.spatialRelationship;a.push((p,z)=>U(t,p,z,k,d,n,h,l))}};b.isMBSGeometryVisible=function(a,d,n){var k=this._layerMaskGeometries;const f=this._geometryEngine;if(m.isSome(k)&&m.isSome(this.layerFilter)&&
m.isSome(f)){var e=this.layerFilter.spatialRelationship;d=k[0].spatialReference||d;return x.projectBoundingSphere(a,n,C,d)?R(f,C,k,d,e):(B.warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}k=this._viewMaskGeometries;return m.isSome(k)&&m.isSome(this.viewFilter)&&m.isSome(f)?(e=this.viewFilter.spatialRelationship,d=k[0].spatialReference||d,x.projectBoundingSphere(a,n,C,d)?R(f,C,k,d,e):(B.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),
!0)):!0};c.checkSupport=function(a){if(m.isNone(a))return!1;if(a.timeExtent)return B.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1;a=a.spatialRelationship;return null!=a&&X.includes(a)?!0:(B.warn(`Filters with spatialRelationship other than ${X.join(", ")} are not supported for mesh scene layers`),!1)};M._createClass(c,[{key:"sortedObjectIds",get:function(){if(m.isNone(this.viewFilter)||m.isNone(this.viewFilter.objectIds))return null;const a=new Float64Array(this.viewFilter.objectIds);
a.sort();return a}},{key:"parsedWhereClause",get:function(){const a=m.isSome(this.viewFilter)?this.viewFilter.where:null;if(m.isNone(a)||!a)return null;try{return fa.WhereClause.create(a,this.layerFieldsIndex)}catch(d){B.error(`Failed to parse filter where clause: ${d}`)}return null}},{key:"parsedGeometry",get:function(){const a=this._viewMaskGeometries,d=this._layerMaskGeometries;return m.isNone(a)||m.isNone(d)?a||d:d.concat(a)}},{key:"_layerMaskGeometries",get:function(){const a=this.layerFilter;
return m.isNone(a)||m.isNone(this._geometryEngine)?null:E(this._geometryEngine,a.geometry,a.spatialRelationship)}},{key:"_viewMaskGeometries",get:function(){if(m.isNone(this.viewFilter)||m.isNone(this._geometryEngine))return null;var {geometry:a}=this.viewFilter;if(m.isNone(a))return null;const {distance:d,units:n}=this.viewFilter,k=this.viewFilter.spatialRelationship;a="mesh"===a.type?a.extent:a;if(m.isNone(d)||0===d)return E(this._geometryEngine,a,k);const f=n||da.getUnitString(a.spatialReference);
if(a.spatialReference.isWGS84)return a=this._geometryEngine.geodesicBuffer(a,d,f),E(this._geometryEngine,a,k);var e=O.project(a,Q.WGS84);if(m.isSome(e))return a=O.project(this._geometryEngine.geodesicBuffer(e,d,f),a.spatialReference),E(this._geometryEngine,a,k);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(x.load().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;e=null;try{e=x.project(a,Q.WGS84)}catch(t){}if(e)try{e=x.project(this._geometryEngine.geodesicBuffer(e,
d,f),a.spatialReference)}catch(t){e=null}e||B.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${a.spatialReference.wkid}) to WGS84.`);return E(this._geometryEngine,e,k)}}]);return c}(Z);u.__decorate([v.property()],r.I3SMeshViewFilter.prototype,"layerFilter",void 0);u.__decorate([v.property({type:ja})],r.I3SMeshViewFilter.prototype,"viewFilter",void 0);u.__decorate([v.property()],r.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0);u.__decorate([v.property()],
r.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0);u.__decorate([v.property()],r.I3SMeshViewFilter.prototype,"applyFilters",void 0);u.__decorate([v.property()],r.I3SMeshViewFilter.prototype,"addSqlFilter",void 0);u.__decorate([v.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"sortedObjectIds",null);u.__decorate([v.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"parsedWhereClause",null);u.__decorate([v.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"parsedGeometry",null);
u.__decorate([v.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null);u.__decorate([v.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null);u.__decorate([v.property()],r.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0);u.__decorate([v.property()],r.I3SMeshViewFilter.prototype,"_geometryEngine",void 0);r.I3SMeshViewFilter=u.__decorate([ea.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],r.I3SMeshViewFilter);const X=["contains",
"intersects","disjoint"];var q;(function(g){g[g.KEEP=0]="KEEP";g[g.DISCARD=1]="DISCARD";g[g.TEST=2]="TEST"})(q||(q={}));const C=[0,0,0,0],pa=2**-32,y=ha.create();Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});