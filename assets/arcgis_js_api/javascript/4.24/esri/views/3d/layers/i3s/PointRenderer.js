// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../chunks/mat4 ../../../../chunks/mat4f32 ../../../../chunks/vec3 ../../../../chunks/vec3f32 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/plane ../../../../geometry/support/ray ./PointHighlights ../../support/orientedBoundingBox ../../webgl-engine/core/shaderLibrary/ShaderOutputOptions ../../webgl-engine/core/shaderLibrary/Slice.glsl ../../webgl-engine/core/shaderModules/interfaces ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/RenderPass ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/shaders/PointRendererTechnique ../../webgl-engine/shaders/PointRendererTechniqueConfiguration ../../../webgl/BufferObject ../../../webgl/enums ../../../webgl/VertexArrayObject ../../../webgl/VertexElementDescriptor".split(" "),
function(T,fa,p,ha,Z,ia,r,ja,I,ka,t,la,ma,na,N,U,oa,pa,qa,ra,J,K,O,sa,ta,aa,D,ua,ba){function L(f,h,a,c,b){if(a.drawScreenSpace)return a.fixedSize*h*c;b=(b?256:64)*h*c;return a.drawFixedSize?Math.min(a.fixedSize/2,b):0<a.screenMinSize?Math.min(Math.max(a.screenMinSize*h*c,f/2),b):Math.min(f/2,b)}function ca(f){return p.isSome(f.component)?f.component:-1}function va(f,h){if(p.isNone(f))return f;f=f.filter(a=>a.id!==h);return 0===f.length?null:f}function da(f){return p.isSome(f.dist)&&p.isSome(f.point)&&
p.isSome(f.pointId)&&p.isSome(f.node)}const wa={positions:[new ba.VertexElementDescriptor(O.VertexAttribute.POSITION,3,D.DataType.FLOAT,0,12)],colors:[new ba.VertexElementDescriptor(O.VertexAttribute.COLOR,3,D.DataType.UNSIGNED_BYTE,0,3,!0)]};O=function(){function f(a){this._params=a;this.type=J.IntersectorType.PCL;this.isGround=!1;this._highlights=new na.PointHighlights({forEachNode:c=>this.forEachNode(c),addHighlight:(c,b,d)=>this._addHighlight(c,b,d),removeHighlight:(c,b)=>this._removeHighlight(c,
b)});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=t.create(t.POSITIVE_INFINITY);this._techniqueConfig=new ta.PointRendererTechniqueConfiguration;this.tempMatrix4=ia.create();this.tempVec3=ja.create();this.nodes=new ha}var h=f.prototype;h.initializeRenderContext=function(a){this._context=a;this._techniqueRep=this._context.shaderTechniqueRepository;a.requestRender()};
h.uninitializeRenderContext=function(){};h.intersect=function(a,c,b,d){const l=I.create(),g=I.create(),M=I.create(),v=I.create(),w=la.create(),k=a.camera.perScreenPixelRatio/2,m=a.camera.near,z=this._getSizeParams();r.subtract(g,d,b);const P=1/r.length(g);r.scale(g,g,P);r.negate(M,g);ka.set(w,g[0],g[1],g[2],-r.dot(g,b));const A=new V,B=new V,ea=[],Q=t.create(),R=t.create(this._clipBox);t.offset(R,-b[0],-b[1],-b[2],R);this.nodes.forAll(e=>{const n=e.splatSize*this._scaleFactor;var u=N.minimumDistancePlane(e.obb,
w),q=N.maximumDistancePlane(e.obb,w);u-=z.drawScreenSpace?0:L(n,u+m,z,k,e.isLeaf);q-=z.drawScreenSpace?0:L(n,q+m,z,k,e.isLeaf);u=null!=A.dist&&null!=B.dist&&A.dist<u*P&&B.dist>q*P;if(!(0>q||u)&&(q=L(n,q+m,z,k,e.isLeaf),N.intersectLine(e.obb,b,g,q))){q*=q;N.toAaBoundingBox(e.obb,Q);t.offset(Q,-b[0],-b[1],-b[2],Q);u=!t.contains(R,Q);r.subtract(v,e.origin,b);var xa=e.coordinates.length/3;for(let E=0;E<xa;E++){l[0]=v[0]+e.coordinates[3*E];l[1]=v[1]+e.coordinates[3*E+1];l[2]=v[2]+e.coordinates[3*E+2];
if(u&&!t.containsPoint(R,l))continue;var x=r.dot(l,g),S=r.squaredLength(l)-x*x;if(S>q)continue;var F=x+m;const W=z.drawScreenSpace?0:L(n,F,z,k,e.isLeaf);if(0>x-W)continue;F-=W;F=L(n,F,z,k,e.isLeaf);if(S>F*F)continue;const G=(x-W)*P;x=C=>{var X=E,H=C.point;p.isNone(H)&&(H=I.create());H[0]=e.origin[0]+e.coordinates[3*X];H[1]=e.origin[1]+e.coordinates[3*X+1];H[2]=e.origin[2]+e.coordinates[3*X+2];C.point=H;C.dist=G;C.normal=M;C.node=e;C.pointId=E;C.layerUid=this.layerUid;return C};(null==A.dist||G<A.dist)&&
(null==c||c(b,d,G))&&x(A);a.options.store!==J.StoreResults.MIN&&(null==B.dist||G>B.dist)&&(null==c||c(b,d,G))&&x(B);a.options.store!==J.StoreResults.ALL||null!=c&&!c(b,d,G)||(S=new V,ea.push(x(S)))}}});const ya=e=>{const {layerUid:n,node:u,pointId:q}=e;return{point:e.point,layerUid:n,graphicUid:q,createGraphic:()=>this._params.createGraphic(u,q,e.point)}},Y=(e,n)=>{const u=ya(n);e.set(this.type,u,n.dist,n.normal)};if(da(A)){var y=a.results.min;(null==y.dist||A.dist<y.dist)&&Y(y,A)}da(B)&&a.options.store!==
J.StoreResults.MIN&&(y=a.results.max,(null==y.dist||B.dist>y.dist)&&Y(y,B));if(a.options.store===J.StoreResults.ALL){y=ma.fromPoints(b,d);for(const e of ea){const n=ra.newIntersectorResult(y);Y(n,e);a.results.all.push(n)}}};h.prepareTechnique=function(a){if(0===this.nodes.length||a.pass!==K.RenderPass.MATERIAL&&a.pass!==K.RenderPass.MATERIAL_DEPTH&&a.pass!==K.RenderPass.MATERIAL_HIGHLIGHT)return null;this.nodes.forAll(b=>{null==b.vao&&this._initNode(a,b)});const c=this._getSizeParams();this._techniqueConfig.drawScreenSize=
c.drawScreenSpace;this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled;this._techniqueConfig.hasOccludees=a.bindParameters.hasOccludees;this._techniqueConfig.output=a.pass===K.RenderPass.MATERIAL_DEPTH?U.ShaderOutput.Depth:a.pass===K.RenderPass.MATERIAL_HIGHLIGHT?U.ShaderOutput.Highlight:U.ShaderOutput.Color;return this._techniqueRep.releaseAndAcquire(sa.PointRendererTechnique,this._techniqueConfig,this._technique)};h.render=function(a,c){const b=a.rctx,d=b.bindTechnique(c,za,a.bindParameters),
l=a.bindParameters.camera,g=this._clipBox,M=!t.equals(g,t.POSITIVE_INFINITY,(k,m)=>k===m);M||(r.set(this.tempVec3,-Infinity,-Infinity,-Infinity),d.setUniform3fv("clipMin",this.tempVec3),r.set(this.tempVec3,Infinity,Infinity,Infinity),d.setUniform3fv("clipMax",this.tempVec3));const v=this._getSizeParams(),w=l.pixelRatio;v.drawFixedSize&&d.setUniform2f("pointScale",v.fixedSize*w,l.fullHeight);this.nodes.forAll(k=>{if(0!==k.coordinates.length&&(!a.isHighlightPass||k.highlights)){d.setUniform2f("screenMinMaxSize",
v.screenMinSize*w,(k.isLeaf?256:64)*w);v.drawFixedSize||d.setUniform2f("pointScale",k.splatSize*this._scaleFactor*w,l.fullHeight/w);var m=k.origin;M&&(r.set(this.tempVec3,g[0]-m[0],g[1]-m[1],g[2]-m[2]),d.setUniform3fv("clipMin",this.tempVec3),r.set(this.tempVec3,g[3]-m[0],g[4]-m[1],g[5]-m[2]),d.setUniform3fv("clipMax",this.tempVec3));Z.fromTranslation(this.tempMatrix4,m);Z.multiply(this.tempMatrix4,l.viewMatrix,this.tempMatrix4);d.setUniformMatrix4fv("modelView",this.tempMatrix4);c.bindDraw(new oa.SlicePlaneParameters(m),
a.bindParameters);b.bindVAO(k.vao);a.isHighlightPass?this._renderHighlightFragments(b,k):b.drawArrays(D.PrimitiveType.POINTS,0,k.coordinates.length/3)}})};h._renderHighlightFragments=function(a,c){var b=c.highlights;if(!p.isNone(b)){c=p.unwrap(b[0].component);var d=c+1;for(let l=1;l<b.length;l++){const g=p.unwrap(b[l].component);g!==d&&(d-=c,0<d&&a.drawArrays(D.PrimitiveType.POINTS,c,d),c=g);d=g+1}b=d-c;0<b&&a.drawArrays(D.PrimitiveType.POINTS,c,b)}};h.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);
this._requestRender()};h.removeNode=function(a){let c=null;this.nodes.filterInPlace(b=>b.id===a?(c=b,b.vao=p.disposeMaybe(b.vao),this._highlights.nodeRemoved(b),!1):!0);this._requestRender();return c};h.forEachNode=function(a){this.nodes.forAll(a)};h.removeAll=function(){this.nodes.forAll(a=>a.vao=p.disposeMaybe(a.vao));this._highlights.removeAll();this.nodes.clear();this._requestRender()};h.highlight=function(a){return this._highlights.add(a)};h._addHighlight=function(a,c,b){var d=a.highlights;p.isNone(d)&&
(d=[]);c={component:c,id:b};d.push(c);c=ca(c);for(b=d.length-1;0<b&&c<ca(d[b-1]);)[d[b-1],d[b]]=[d[b],d[b-1]],--b;a.highlights=d;this._requestRender()};h._removeHighlight=function(a,c){a.highlights=va(a.highlights,c);this._requestRender()};h._initNode=function(a,c){a=a.rctx;c.vao=new ua.VertexArrayObject(a,qa.Default3D,wa,{positions:aa.BufferObject.createVertex(a,D.Usage.STATIC_DRAW,c.coordinates),colors:aa.BufferObject.createVertex(a,D.Usage.STATIC_DRAW,c.rgb)})};h._requestRender=function(){this._context&&
this._context.requestRender()};h._getSizeParams=function(){const a=this._useFixedSizes,c=a&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:c,drawFixedSize:a,fixedSize:c?this._sizePx:this._size,screenMinSize:a?0:this._minSizePx}};fa._createClass(f,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())}},{key:"scaleFactor",
get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())}},{key:"size",get:function(){return this._size},
set:function(a){this._size!==a&&(this._size=a,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())}},{key:"clippingBox",set:function(a){t.set(this._clipBox,a||t.POSITIVE_INFINITY)}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())}}]);return f}();let V=function(){this.normal=this.dist=this.point=
this.pointId=this.node=null;this.layerUid=""};const za=new pa.NoParameters;T.PointRenderer=O;T.isInstanceOfNode=function(f){return f.hasOwnProperty("splatSize")};Object.defineProperties(T,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});