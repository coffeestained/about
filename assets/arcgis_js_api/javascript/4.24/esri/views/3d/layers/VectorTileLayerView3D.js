// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../2d/engine/vectorTiles/SchemaHelper ../../2d/engine/vectorTiles/TileHandler3D ../../2d/engine/vectorTiles/VTLPainter3D ../../2d/engine/vectorTiles/style/StyleRepository ./LayerView3D ./TiledLayerView3D ../terrain/terrainUtils ../../layers/LayerView".split(" "),
function(q,k,F,g,G,H,r,e,Q,R,I,J,u,v,w,K,L,x,M){e=function(y){function l(){var b=y.apply(this,arguments)||this;b.type="vector-tile-3d";return b}q._inheritsLoose(l,y);var t=l.prototype;t.initialize=function(){if(g.isNone(this.layer.fullExtent))this.addResolvingPromise(Promise.reject(new F("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));else{var {basemapTerrain:b,spatialReference:m,state:n,viewingMode:p}=this.view,{pixelRatio:h}=n,d="local"===p&&
!x.vtlAssumes256PixelSizeAsDefault(m)||x.test.force512VTL,f=this.layer.tileInfo.spatialReference.isGeographic;d=d?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,f?1:2);d=this._getTileInfoSupportError(d,this.layer.fullExtent);if(g.isSome(d))return this.addResolvingPromise(Promise.reject(d));d=H.whenOnce(()=>{var a,c;return null==(a=this.view)?void 0:null==(c=a.basemapTerrain)?void 0:c.tilingSchemeLocked}).then(()=>{var a=b.tilingScheme,c=a.pixelSize;this.schemaHelper=new J.SchemaHelper(c,
b.spatialReference.isGeographic);c=256===c?this.layer.tileInfo.getOrCreateCompatible(256,this.layer.tileInfo.spatialReference.isGeographic?1:2):this.view.spatialReference.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;if(a=this._getTileInfoCompatibilityError(c,a))throw a;this.tileInfo=c});this._tileHandlerController=new AbortController;var z=this.view.resourceController;this._memCache=z.memoryController.newCache(this.layer.uid,a=>{a.release()});f=new w(this.layer.currentStyleInfo.style);
var A=b.mapTileRequester;this._tileHandler=new u(this.layer,f,h,this._memCache,A);var B=this._tileHandlerController.signal,C=a=>z.schedule(a);f=this._tileHandler.start({signal:B,schedule:C});var D=this._tileHandler.spriteMosaic;D.then(a=>{!G.isAborted(B)&&this._tileHandler&&(this.painter=new v(a,this._tileHandler.glyphMosaic))});f.then(()=>this._tileHandlerController=null);this.updatingHandles.add(()=>{var a;return{style:this.layer.currentStyleInfo.style,newPixelRatio:null==(a=this.view.state)?void 0:
a.pixelRatio}},({style:a})=>{this._tileHandlerController&&this._tileHandlerController.abort();this._tileHandlerController=new AbortController;this._memCache.clear();a=new w(a);const c=new u(this.layer,a,h,this._memCache,A);a=c.start({signal:this._tileHandlerController.signal,schedule:C});const N=c.spriteMosaic;a.then(()=>this._tileHandlerController=null);this.updatingHandles.addPromise(Promise.all([a,N]).then(([,O])=>{const P=this._tileHandler,E=this.painter;this.painter=new v(O,c.glyphMosaic);this._tileHandler=
c;this.emit("data-changed");P.destroy();E&&E.dispose()}))});d=Promise.all([d,f,D]);this.addResolvingPromise(d)}};t.destroy=function(){this.painter=g.disposeMaybe(this.painter);this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null);g.destroyMaybe(this._tileHandler);this._memCache=g.destroyMaybe(this._memCache);this._tileHandler=null};t.fetchTile=function(){var b=q._asyncToGenerator(function*(m,n,p,h){return this._tileHandler.getVectorTile(m,n,p,h)});return function(m,
n,p,h){return b.apply(this,arguments)}}();q._createClass(l,[{key:"dataLevelRange",get:function(){var b=this.tileInfo.lods;b=this.levelRangeFromScaleRange(b[0].scale,b[b.length-1].scale);1===b.minLevel&&256===this.tileInfo.size[0]&&(b.minLevel=0);return b}}]);return l}(L.TiledLayerView3D(K.LayerView3D(M)));k.__decorate([r.property()],e.prototype,"layer",void 0);k.__decorate([r.property()],e.prototype,"dataLevelRange",null);k.__decorate([r.property()],e.prototype,"updatingProgressValue",void 0);return e=
k.__decorate([I.subclass("esri.views.3d.layers.VectorTileLayerView3D")],e)});