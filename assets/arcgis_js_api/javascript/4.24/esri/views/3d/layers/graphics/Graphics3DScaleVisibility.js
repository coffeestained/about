// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/maybe ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/projection ../../../../geometry/support/aaBoundingRect ./enums ../../../support/layerViewUtils ../../../support/Scheduler".split(" "),
function(r,m,e,v,n,q,A,B,C,w,x,y,f,t,z){e=function(u){function p(){var a=u.apply(this,arguments)||this;a._scaleRangeActive=!1;a.layerScaleRangeVisibilityQuery=!1;a.handles=new v;a.graphicsCoreOwner=null;a.layer=null;a.queryGraphicUIDsInExtent=null;a.extent=null;a.graphicsCore=null;a.basemapTerrain=null;a.layerScaleEnabled=!0;a.suspended=!1;a.updating=!0;return a}r._inheritsLoose(p,u);var d=p.prototype;d.setup=function(a,b,c,g,k){this.graphicsCoreOwner=a;this.layer=b;this.queryGraphicUIDsInExtent=
c;this.graphicsCore=g;this.basemapTerrain=k;this.updateScaleRangeActive();this.handles.add(this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(z.TaskPriority.SCALE_VISIBILITY,this))};d.destroy=function(){this.handles.destroy();this.graphicsCore=this.queryGraphicUIDsInExtent=this.extent=this.graphicsCoreOwner=this.handles=null};d._setDirty=function(){this.updating||this._set("updating",!0)};d.setExtent=function(a){const b=this.graphicsCoreOwner.view.spatialReference,c=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;
if(b===c)this.extent=a;else{const g=y.create();x.projectBoundingRect(a,b,g,c)?this.extent=g:this.extent=null}this._setDirty()};d.scaleRangeActive=function(){return this._scaleRangeActive};d.updateScaleRangeActive=function(){var a=this.layer,b=a.effectiveScaleRange;b=this.layerScaleEnabled&&(0<b.minScale||0<b.maxScale);a.labelingInfo&&!b&&(b=a.labelingInfo.some(c=>c&&(0<c.minScale||0<c.maxScale)));a=this._scaleRangeActive!==b;(this._scaleRangeActive=b)&&!this.handles.has("terrain-events")&&this.basemapTerrain?
(this.handles.add(this.basemapTerrain.on("scale-change",c=>this._scaleUpdateHandler(c)),"terrain-events"),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),"terrain-events")):!b&&this.handles.has("terrain-events")&&this.handles.remove("terrain-events");return a};d.runTask=function(){const a=this.graphicsCoreOwner.view.basemapTerrain;if(!(this.extent&&a&&a.ready&&this._scaleRangeActive&&this.layerScaleEnabled))this._finishUpdate(!0);else if(!this.layerScaleRangeVisibilityQuery){this.layerScaleRangeVisibilityQuery=
!0;const b=this.layer.effectiveScaleRange;a.queryVisibleScaleRange(this.extent,b.minScale,b.maxScale,c=>this._finishUpdate(c))}};d._finishUpdate=function(a){this.layerScaleRangeVisibilityQuery=!1;this._set("suspended",!a);this._set("updating",!1)};d._visibleAtLayerScale=function(a){const b=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||t.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};d._visibleAtLabelScale=function(a,b){return t.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||
0)};d._graphicScale=function(a){let b;n.isSome(a.centroid)?b=a.centroid:n.isSome(a.graphic.geometry)&&"point"===a.graphic.geometry.type&&(b=a.graphic.geometry);return b?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(b):1:null};d._graphicVisible=function(a){if(!this.layerScaleEnabled)return!0;a=this._graphicScale(a);return this._visibleAtLayerScale(a)};d.updateVisibility=function(a){if(this._scaleRangeActive){const b=this._graphicVisible(a);return a.setVisibilityFlag(f.VisibilityFlag.SCALE_RANGE,
b,f.VisibilityGroup.GRAPHIC)}return!1};d.updateGraphicLabelScaleVisibility=function(a){if(!this._scaleRangeActive||!a.labelGraphics||0===a.labelGraphics.length)return!1;const b=this._graphicScale(a);if(a=this._updateLabelScaleVisibility(a,b))this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty();return a};d._updateLabelScaleVisibility=function(a,b){if(!a.labelGraphics||0===a.labelGraphics.length)return!1;const c=a.labelGraphics[0]._labelClass;return c&&
null!=c.minScale&&null!=c.maxScale&&(b=this._visibleAtLabelScale(b,c),a.setVisibilityFlag(f.VisibilityFlag.SCALE_RANGE,b,f.VisibilityGroup.LABEL))?!0:!1};d._scaleUpdateHandler=function(a){this._setDirty();if(!this.graphicsCoreOwner.suspended){var b=a.extent,c=a.scale,g=this._visibleAtLayerScale(c),k=!1;this.queryGraphicUIDsInExtent(b,a.spatialReference,h=>{h=this.graphicsCore.getGraphics3DGraphicById(h);if(!n.isNone(h)){var l=h.centroid;n.isSome(l)&&(b[0]>l.x||b[1]>l.y||b[2]<l.x||b[3]<l.y)||(h.setVisibilityFlag(f.VisibilityFlag.SCALE_RANGE,
g,f.VisibilityGroup.GRAPHIC)&&(k=!0),this._updateLabelScaleVisibility(h,c)&&(k=!0))}});k&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}};d.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(a=>a.clearVisibilityFlag(f.VisibilityFlag.SCALE_RANGE)):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility();this._setDirty()};r._createClass(p,
[{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}}]);return p}(e);m.__decorate([q.property({constructOnly:!0})],e.prototype,"layerScaleEnabled",void 0);m.__decorate([q.property({readOnly:!0})],e.prototype,"suspended",void 0);m.__decorate([q.property({readOnly:!0})],e.prototype,"updating",void 0);return e=m.__decorate([w.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],e)});