// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/maybe ../../../../core/ObservableChangesType ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../layers/support/FeatureFilter ../../../../layers/support/floorFilterUtils ./enums ./QueryEngine ../../../support/Scheduler".split(" "),
function(d,n,h,r,t,u,e,v,w,x,k,E,F,G,y,z,A,g,B,p){const C=u.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");d.Graphics3DFilterVisibility=function(q){function l(...a){a=q.call(this,...a)||this;a._dirty=!1;a._querying=!1;a._handles=new t;return a}n._inheritsLoose(l,q);var f=l.prototype;f.setup=function(a,c){this._layerView=a;this._core=c;this._objectIdField=a.layer.objectIdField;this._queryEngine=new B.QueryEngine({layerView:this._layerView,priority:p.TaskPriority.FILTER_VISIBILITY});
this._handles.add(this._layerView.view.resourceController.scheduler.registerTask(p.TaskPriority.FILTER_VISIBILITY,this));this._handles.add(x.on(()=>{var b;return null==(b=c.owner)?void 0:b.loadedGraphics},"after-changes",b=>this._graphicsChanged(b),{onListenerAdd:()=>this.dirty=!0}));this.filterChanged()};f.destroy=function(){this._handles.destroy();this._handles=null;this.clear();this._core=this._layerView=null};f.clear=function(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(a=>
a.clearVisibilityFlag(g.VisibilityFlag.FILTER)),this._queryResult=null,this._querying=!1);this.dirty=!1};f._graphicsChanged=function(a){this._queryEngine&&0===(a.type&v.ObservableChangesType.ADD)||(this.dirty=!0)};f.updateVisibility=function(a){this.active&&(a.hasVisibilityFlag(g.VisibilityFlag.FILTER,g.VisibilityGroup.GRAPHIC)||a.setVisibilityFlag(g.VisibilityFlag.FILTER,!1,g.VisibilityGroup.GRAPHIC),this.dirty=!0)};f.filterChanged=function(){var a=this._recomputeFilter();a!==this._featureFilter&&
(this._featureFilter=a,this.dirty=!0);a="layerFilter"in this._layerView?this._layerView.layerFilter:null;a!==this._sceneFilter&&(this._sceneFilter=a,this.dirty=!0)};f._recomputeFilter=function(){var a="filter"in this._layerView?this._layerView.filter:null;const c="timeExtent"in this._layerView?this._layerView.timeExtent:null,b=A.getFloorFilterClause(this._layerView);if(e.isNone(c)&&e.isNone(b))return a;a=e.isSome(a)?a.clone():new z;e.isSome(c)&&(a.timeExtent=e.isSome(a.timeExtent)?a.timeExtent.intersection(c):
c);e.isSome(b)&&(a.where=null==a.where||""===a.where?b:`(${a.where}) AND (${b})`);return a};f.runTask=function(a){if(this.active){!this._dirty||this._querying||a.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._featureFilter,this._sceneFilter).then(b=>{this._queryResult=b;this._querying=!1}).catch(b=>{if(!w.isAbortError(b)){C.warn("FeatureFilter query failed: "+b,{error:b});const m=new Set;this._core.graphics3DGraphics.forEach(D=>m.add(this._getFeatureId(D.graphic)));
this._queryResult=m;this._querying=!1}}),a.madeProgress());var c=this._queryResult;e.isSome(c)&&!a.done&&(this._core.modifyGraphics3DGraphicVisibilities(b=>{if(a.done)return!1;const m=c.has(this._getFeatureId(b.graphic));return b.setVisibilityFlag(g.VisibilityFlag.FILTER,m,g.VisibilityGroup.GRAPHIC)?(a.madeProgress(),!0):!1}),a.done||(this._queryResult=null))}else this.clear()};f._getFeatureId=function(a){return null==a.objectId?a.attributes[this._objectIdField]:a.objectId};n._createClass(l,[{key:"updating",
get:function(){return this._dirty||this._querying||e.isSome(this._queryResult)}},{key:"active",get:function(){return(this._featureFilter||this._sceneFilter)&&0<this._core.graphics3DGraphics.size}},{key:"running",get:function(){return this._dirty&&!this._querying||e.isSome(this._queryResult)}},{key:"dirty",set:function(a){this._dirty=a}}]);return l}(r);h.__decorate([k.property({readOnly:!0})],d.Graphics3DFilterVisibility.prototype,"updating",null);h.__decorate([k.property({readOnly:!0})],d.Graphics3DFilterVisibility.prototype,
"running",null);h.__decorate([k.property()],d.Graphics3DFilterVisibility.prototype,"_dirty",void 0);h.__decorate([k.property()],d.Graphics3DFilterVisibility.prototype,"_querying",void 0);h.__decorate([k.property()],d.Graphics3DFilterVisibility.prototype,"_queryResult",void 0);d.Graphics3DFilterVisibility=h.__decorate([y.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],d.Graphics3DFilterVisibility);Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});