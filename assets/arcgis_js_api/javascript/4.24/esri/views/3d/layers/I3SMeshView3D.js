// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../Graphic ../../../core/arrayUtils ../../../core/byteSizeEstimations ../../../core/Collection ../../../core/has ../../../core/Logger ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/scheduling ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat3f32 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../layers/graphics/controllers/I3SOnDemandController ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../layers/support/SceneModification ../../../renderers/visualVariables/support/visualVariableUtils ../../../support/arcadeOnDemand ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./I3SMeshViewLabeler ./I3SMeshWorkerHandle ./II3SMeshView3D ./SceneLayerWorker ./graphics/graphicUtils ./i3s/enums ./i3s/Highlights ./i3s/I3SAsyncElevationUpdater ./i3s/I3SAttributeOverrides ./i3s/I3SCrossfadeHelper ./i3s/I3SElevationProvider ./i3s/I3SGeometryUtil ./i3s/I3SIntersectionHandler ./i3s/I3SMaterialUtil ./i3s/I3SNode ./i3s/I3SProjectionUtil ./i3s/I3SUtil ./i3s/IDBCache ./i3s/IDBMockCache ./support/attributeUtils ./support/symbolColorUtils ../support/debugFlags ../support/extentUtils ../support/orientedBoundingBox ../support/updatingProperties ../support/buffer/glUtil ../webgl-engine/collections/Component/ComponentObject ../webgl-engine/collections/Component/SourceGeometry ../webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl ../webgl-engine/lib/BasisUtil ../webgl-engine/lib/edgeRendering/interfaces".split(" "),
function(Sa,y,M,u,Ta,ba,Ua,Va,Wa,ka,Xa,ua,g,Ya,ca,E,Za,va,wa,w,Jb,$a,ab,bb,xa,ya,V,la,cb,db,Q,W,S,eb,fb,gb,hb,za,ib,jb,Aa,kb,Ba,z,da,Ca,I,lb,mb,nb,Da,ob,pb,qb,X,ma,na,t,rb,sb,oa,pa,Y,Ea,ea,tb,ub,qa,vb,fa,Fa,ha){function Ga(k){if(g.isNone(k))return!1;const p=k.metallicRoughness;return p&&0<=p.baseColorTextureId||p&&0<=p.metallicRoughnessTextureId||0<=k.normalTextureId||0<=k.emissiveTextureId||0<=k.occlusionTextureId}function Ha(k){return g.isSome(k)&&va.isArrayBuffer(k.data)}function Ia(k,p){k=1024+
k.interleavedVertexData.byteLength+(k.indices?k.indices.byteLength:0)+k.positionData.data.byteLength+k.positionData.indices.byteLength;if(g.isSome(p))for(const r of p)g.isSome(r)&&va.isArrayBuffer(r.data)&&(k+=r.data.byteLength);return k}function Ja(k,p){return p.byteSize>wb?(J.warn(`Node is too big to store in IndexedDB cache: ${k.id} (${p.byteSize} bytes)`),!1):0<p.byteSize}function xb(k){if(0===k.length)return null;const p=new Float64Array(10*k.length);k.forAll((r,f)=>{let a=r.serviceObb;g.isNone(a)&&
(a=yb,V.copy(a.center,r.mbs),a.halfSize[0]=a.halfSize[1]=a.halfSize[2]=r.mbs[3]);r=10*f;p[r+0]=a.center[0];p[r+1]=a.center[1];p[r+2]=a.center[2];p[r+3]=a.halfSize[0];p[r+4]=a.halfSize[1];p[r+5]=a.halfSize[2];p[r+6]=a.quaternion[0];p[r+7]=a.quaternion[1];p[r+8]=a.quaternion[2];p[r+9]=a.quaternion[3]});return p}function Z(k,p){k.forEach(r=>r.opacity=p)}const J=Xa.getLogger("esri.views.3d.layers.SceneLayerView3D"),Ka=[1,1,1,1];let zb=function(k){function p(r,f,a,b,c,d,e){var h=k.call(this)||this;h.node=
r;h.featureIds=f;h.objectHandle=a;h.cachedRendererVersion=b;h.attributeInfo=c;h.material=d;h.textures=e;h.cachedEdgeMaterials=[];h.edgeMemoryUsage=0;h.cachedSymbology=null;return h}M._inheritsLoose(p,k);return p}(Da.NodeCrossfadeMetaData);var R;(function(k){k[k.CastShadows=4]="CastShadows";k[k.Pickable=5]="Pickable"})(R||(R={}));const wb=100*Va.ByteSizeUnit.MEGABYTES;var F;(function(k){k[k.ADD=0]="ADD";k[k.REMOVE=1]="REMOVE";k[k.UPDATE=2]="UPDATE"})(F||(F={}));const La=W.create(),Ma=S.create(),Ab=
S.create(),yb=ea.create(),aa=[0,0,0,0],Bb=new Ta([0,0,0,0]),Na=[0,0,0,0],Oa=S.create(),Cb={remove(){},pause(){},resume(){}};y.ElevationMode=void 0;(function(k){k[k.Absolute=0]="Absolute";k[k.RelativeToGround=1]="RelativeToGround";k[k.OnTheGround=2]="OnTheGround"})(y.ElevationMode||(y.ElevationMode={}));const K=la.create(),T=W.create();y.I3SMeshView3D=k=>{k=function(p){function r(...a){a=p.call(this,a)||this;a._elevationProvider=null;a._intersectionHandler=null;a._nodeId2Meta=new Map;a._nodeId2MetaReloading=
new Map;a._i3sWasmLoaded=!1;a._snappingSourcesTrackers=[];a._hasLoadedPBRTextures=!1;a._asyncModuleLoading=0;a._addTasks=new Map;a._rendererVersion=0;a._colorVariable=null;a._opacityVariable=null;a._rendererFields=null;a._symbologyFields=null;a._symbologyOverride=null;a._symbologyOverrideFields=null;a._symbolInfos=new Map;a._idbCache=ka("enable-feature:idb-mock-cache")?new sb.IDBMockCache:new rb.IDBCache("esri-scenelayer-cache","geometries");a.holeFilling="auto";a._hasColors=!1;a._hasTextures=!1;
a._hasData=!1;a.filter=null;a.slicePlaneEnabled=!1;a._modifications=[];a._layerUrl="";a._cacheKeySuffix=null;a._elevationTask=null;a._arcade=null;a._tmpAttributeOnlyGraphic=new ba(null,null,{});a._crossfadeHelper=new Da.I3SCrossfadeHelper(M._assertThisInitialized(a));return a}M._inheritsLoose(r,p);var f=r.prototype;f.initialize=function(){this._preLoadBasis();this.addResolvingPromise(this.i3slayer.indexInfo);const a=this.view.resourceController;this.attributeOverrides=new nb.I3SAttributeOverrides(this.i3slayer,
a.memoryController);this._worker=new Ba.I3SMeshWorkerHandle(c=>a.schedule(c));this.addResolvingPromise(this._worker.promise);this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema);t.checkSceneLayerValid(this.i3slayer);t.checkSceneLayerCompatibleWithView(this.i3slayer,this.view);this._layerUrl=this.i3slayer.parsedUrl.path;this._controller=new eb({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._collection=
this._stage.renderView.componentObjectCollection;this._highlights=new lb({collection:this._collection,forAllFeatures:c=>this._forAllFeatures(c,null,z.ForAllFeaturesVisibilityMode.ALL),forAllFeaturesOfNode:(c,d)=>this._forAllFeaturesOfNode(c,d)});if(this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasComponentData=!1;else{var b=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasComponentData=!!(b&&b.faceRange&&b.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&
(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.newCache(this.i3slayer.uid,c=>this._deleteComponentObject(c));this._intersectionHandler=new qb.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:c=>
g.isSome(this._controller.index)&&g.isSome(this._controller.index.rootNode)?this._controller.index.traverse(this._controller.index.rootNode,d=>{var e=d.index;e=this._nodeId2Meta.get(e)||this._nodeId2MetaReloading.get(e);return c(d,g.isSome(e)?e.objectHandle:null)}):()=>{}});this._elevationProvider=new ob({layerView:this,intersectionHandler:this._intersectionHandler});this._hasLoadedPBRTextures=this._usePBR();this.updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),E.initial);
this.updatingHandles.add(()=>this.fullOpacity,c=>this._opacityChange(c));this.updatingHandles.add(()=>this.slicePlaneEnabled,c=>this._slicePlaneEnabledChange(c));this.updatingHandles.add(()=>this.elevationOffset,(c,d)=>{this._reloadAll(d);this._controller.invalidateVisibilityObbs()});this.updatingHandles.add(()=>this.elevationInfo,(c,d)=>this._elevationInfoChanged(c,d),E.initial);this.updatingHandles.add(()=>this.filter,()=>this._filterChange(),E.initial);this.updatingHandles.add(()=>this.view.qualitySettings.physicallyBasedRenderingEnabled,
()=>this._updatePBR());b=()=>{this._reloadAll();this.clearMemCache()};this.updatingHandles.add(()=>this.rendererTextureUsage,b);this.updatingHandles.add(()=>this.uncompressedTextureDownsamplingEnabled,b);this.updatingHandles.add(()=>this.suspended,c=>this._suspendedChange(c),E.initial);this.updatingHandles.add(()=>this.i3slayer.labelsVisible,()=>this._labelingChanged(),E.initial);this.updatingHandles.add(()=>this.i3slayer.labelingInfo,()=>this._labelingChanged(),E.initial);this.updatingHandles.add(()=>
this._modifications,()=>this._modificationsChanged(),E.initial);this.handles.add([E.watch(()=>Y.I3S_TREE_SHOW_TILES,c=>{if(c&&!this._treeDebugger){const d=this._controller.crsIndex;(new Promise((e,h)=>Sa(["./support/I3STreeDebugger"],e,h))).then(({I3STreeDebugger:e})=>{!this._treeDebugger&&Y.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new e({lv:this,view:this.view,nodeSR:d}))})}else c||Y.I3S_TREE_SHOW_TILES||(this._treeDebugger=g.destroyMaybe(this._treeDebugger))},E.initial),E.watch(()=>Y.I3S_SHOW_MODIFICATIONS,
()=>this._showModifications(),E.initial)]);this._cacheKeySuffix=t.getCacheKeySuffix(this.i3slayer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(c=>J.warn(`Failed to initialize IndexedDB cache: ${c}`))};f.destroy=function(){this._clearAddTasks();this._elevationTask=g.destroyMaybe(this._elevationTask);this.attributeOverrides=g.destroyMaybe(this.attributeOverrides);this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),
this._elevationProvider=null);this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const a=this._worker;a&&(a.destroyContext(this.i3slayer.uid).then(()=>a.destroy()),this._worker=null);this._removeAllNodeDataFromStage();this._memCache=g.destroyMaybe(this._memCache);this._edgeView=this._stage=this._collection=null;this._labeler=g.destroyMaybe(this._labeler);this._treeDebugger=g.destroyMaybe(this._treeDebugger);
this._controller=g.destroyMaybe(this._controller);this._highlights.destroy();this._nodeId2Meta.clear();this._nodeId2MetaReloading.clear();this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};f._memEstimateTextureAdded=function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};f._memEstimateTextureRemoved=function(a){g.isSome(a)&&
(a=a.estimatedTexMemRequired,this.gpuMemoryEstimate-=a,this.texMemoryEstimate-=a)};f._memEstimateGeometryAdded=function(a){a=this._collection.getObjectGPUMemoryUsage(a);this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};f._memEstimateGeometryRemoved=function(a){a=this._collection.getObjectGPUMemoryUsage(a);this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};f.isNodeLoaded=function(a){return this._nodeId2Meta.has(a)};f.isNodeReloading=function(a){return this._nodeId2MetaReloading.has(a)};
f.getUsedMemory=function(){let a=g.isSome(this._labeler)?this._labeler.usedMemory:0;this._nodeId2Meta.forEach(b=>a+=g.isSome(b)?b.node.memory:0);this._nodeId2MetaReloading.forEach(b=>a+=g.isSome(b)?b.node.memory:0);return a};f.getUnloadedMemory=function(){return(g.isSome(this._controller)?this._controller.unloadedMemoryEstimate:0)+(g.isSome(this._labeler)?this._labeler.unloadedMemoryEstimate:0)};f.ignoresMemoryFactor=function(){return!1};f._labelingChanged=function(){if(!gb.areLabelsVisible(this.i3slayer)||
!this._supportsLabeling)g.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null);else if(!g.isSome(this._labeler)){var a=new kb({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach(b=>g.isSome(b)&&this._addMetaToLabeler(a,b));this._labeler=a}};f._loadAsyncModule=function(a){++this._asyncModuleLoading;return a.then(b=>{--this._asyncModuleLoading;return b},b=>{--this._asyncModuleLoading;throw b;})};f._modificationsChanged=function(){if(!this._i3sWasmLoaded&&
this.hasModifications)this._i3sWasmLoaded=da.initialize().then(()=>{this._i3sWasmLoaded=!0;this._modificationsChanged();this.notifyUpdate()}),this.notifyUpdate();else if(!0===this._i3sWasmLoaded){var a=this.i3slayer.uid,b=this.i3slayer.spatialReference;this._worker.setModifications(a,this._layerClippingArea,this._modifications,b);var c=Ba.toWasmModification(this._layerClippingArea,this._modifications,b);da.setModificationsSync({context:a,modifications:c,isGeodetic:b.isGeographic});this._controller.modificationsChanged();
var d=this.hasModifications?new Ya:null;this._nodeId2Meta.forEach((e,h)=>{g.isNone(e)?(this._nodeId2Meta.delete(h),this._controller.updateLoadStatus(h,!1)):e.node.hasModifications?(this._nodeId2Meta.delete(h),this._nodeId2MetaReloading.set(h,e)):g.isSome(d)&&d.push(e.node)});g.isSome(d)&&this._nodeId2MetaReloading.forEach(e=>d.push(e.node));g.isSome(d)&&0<d.length&&(this.updateNodeModificationStatus(d),d.forAll(e=>{if(e.imModificationImpact!==ma.NodeIMModificationImpact.Culled){const h=this._nodeId2Meta.get(e.index);
this._controller.invalidateGeometryVisibility(e.index);g.isSome(h)?(this._nodeId2Meta.delete(e.index),this._nodeId2MetaReloading.set(e.index,h)):this._nodeId2Meta.has(e.index)&&(this._nodeId2Meta.delete(e.index),this._controller.updateLoadStatus(e.index,!1))}}));this.clearMemCache();this._controller.restartNodeLoading();this._showModifications()}};f._showModifications=function(){g.isSome(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=
null);if(Y.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var a={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},b={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(const c of this._modifications)c.geometry.spatialReference=this.i3slayer.spatialReference,this._modificationGraphics.push(new ba({geometry:c.geometry,symbol:{...b,color:a[c.type]}}));this.view.graphics.addMany(this._modificationGraphics)}};f._addMetaToLabeler=function(a,
b){a.addNodeMeta(b,(c,d)=>this._createAttributes(c,d))};f._suspendedChange=function(a){a?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))};f.getLoadedAttributes=
function(a){a=this._nodeId2Meta.get(a);if(g.isSome(a)&&g.isSome(a.attributeInfo))return a.attributeInfo.loadedAttributes};f.getAttributeData=function(a){a=this._nodeId2Meta.get(a);if(g.isSome(a)&&g.isSome(a.attributeInfo))return a.attributeInfo.attributeData};f.setAttributeData=function(a,b){a=this._nodeId2Meta.get(a);g.isSome(a)&&g.isSome(a.attributeInfo)&&(a.attributeInfo.attributeData=b,this._attributeValuesChanged(a))};f.updateAttributes=function(){var a=M._asyncToGenerator(function*(b,c,d){b=
this._nodeId2Meta.get(b);g.isSome(b)&&(yield this.attributeOverrides.apply(b.featureIds,c,d),b.attributeInfo=c,this._attributeValuesChanged(b))});return function(b,c,d){return a.apply(this,arguments)}}();f._attributeValuesChanged=function(a){a.cachedRendererVersion=this._getInvalidRendererVersion();a.filteredIds=null;g.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(a,(b,c)=>this._createAttributes(b,c));this._updateEngineObject(a)};f.clearMemCache=function(){g.isSome(this._memCache)&&this._memCache.clear()};
f.getVisibleNodes=function(){const a=[];this._nodeId2Meta.forEach(b=>g.isSome(b)&&a.push(b.node));return a};f.getLoadedNodeIndices=function(a){this._nodeId2Meta.forEach((b,c)=>a.push(c));this._nodeId2MetaReloading.forEach((b,c)=>a.push(c))};f._preLoadBasis=function(){!ka("disable-feature:i3s-basis")&&0!==(this.supportedTextureEncodings&I.TextureEncoding.Basis)&&g.applySome(this.i3slayer.textureSetDefinitions,a=>a.some(b=>b.formats.some(c=>"basis"===c.format||"ktx2"===c.format)))&&Fa.loadBasis()};
f._getVertexBufferLayout=function(a,b){a={hasTexture:Ga(a.params.material),hasNormals:b.normal,hasRegions:b.uvRegion};return ub.glLayout(vb.createVertexBufferLayout(this._getGeometryParameters(a)))};f._getObjectIdField=function(){return this.i3slayer.objectIdField||"OBJECTID"};f._findGraphicNodeAndIndex=function(a){const b=oa.attributeLookup(this.i3slayer.fieldsIndex,a.attributes,this._getObjectIdField());let c=null;ua.someMap(this._nodeId2Meta,d=>{if(g.isNone(d))return!1;const e=d.featureIds.indexOf(b);
if(-1===e)return!1;c={node:d.node,index:e};return!0});return c};f._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.index);if(g.isNone(a))return[];const c=[],d=this._getObjectIdField(),e=this.i3slayer.fieldsIndex;for(const h of b)b=oa.attributeLookup(e,h.attributes,d),b=a.featureIds.indexOf(b),-1!==b&&c.push(b);return c};f.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(!a)return Promise.reject();a=this._getAABB(a.node.index,a.index);return g.isNone(a)?Promise.reject():
Promise.resolve({boundingBox:a,screenSpaceObjects:[]})};f.getAABBFromIntersectorTarget=function(a){return null==a.nodeIndex||null==a.componentIndex?null:this._getAABB(a.nodeIndex,a.componentIndex)};f._getAABB=function(a,b){a=this._nodeId2Meta.get(a);if(g.isNone(a)||null==a.featureIds||b>=a.featureIds.length)return null;b=pb.boundingBoxCornerPoints(b,this._collection,a.objectHandle,new Float64Array(24));if(!Q.projectBuffer(b,this.view.renderSpatialReference,0,b,this.view.spatialReference,0,8))return null;
a=W.empty();W.expandWithBuffer(a,b,0,8);return a};f.whenGraphicAttributes=function(a,b){return t.whenGraphicAttributes(this.i3slayer,a,this._getObjectIdField(),b,()=>[...this._nodeId2Meta.values()].filter(g.isSome))};f.getGraphicFromIntersectorTarget=function(a){if(null==a.nodeIndex||null==a.componentIndex)return null;const b=this._nodeId2Meta.get(a.nodeIndex);return g.isNone(b)||null==b.featureIds||a.componentIndex>=b.featureIds.length?null:this._createGraphic(a.componentIndex,b)};f._getCacheKey=
function(a){return`${this._layerUrl}/v${19}/${a.id}${this._cacheKeySuffix}`};f._getMemCacheKey=function(a,b=this.elevationOffset){return a+"#"+b};f.loadCachedGPUData=function(a){return g.isSome(this._memCache)?this._memCache.pop(this._getMemCacheKey(a.index)):null};f.deleteCachedGPUData=function(a){g.isSome(a)&&this._deleteComponentObject(a)};f._cacheGPUData=function(a,b=this.elevationOffset){if(g.isNone(this._memCache))this._deleteComponentObject(a);else{var c=this._controller.indexDepth-a.node.level;
this._memCache.put(this._getMemCacheKey(a.node.index,b),a,a.node.memory,c)}};f.loadMissingTextures=function(a,b,c,d){var e;const h=null!=(e=null==a?void 0:a.filter((l,m)=>{if(0===(l.usage&this.rendererTextureUsage))return!1;if(g.isNone(b))return!0;l=X.selectEncoding(l.encodings,this.supportedTextureEncodings);m=b[m];return g.isNone(m)||null==m.data||l&&m.encoding!==l.encoding?!0:!1}))?e:[];return 0===h.length?Promise.resolve(!1):c(h,d).then(l=>{let m=0;for(let q=0;q<a.length;q++)m<l.length&&l[m].id===
a[q].id&&(b[q]=l[m],m++);return!0})};f.loadCachedNodeData=function(a,b,c){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(a),b).then(d=>{if(null==d)return null;if(d.nodeVersion!==a.version)return this._idbCache.remove(this._getCacheKey(a)),null;this.elevationInfo.mode===y.ElevationMode.Absolute&&(a.geometryObb=d.geometryObb);return this.loadMissingTextures(d.requiredTextures,d.textureData,c,b).then(e=>{e&&this._idbCache.initialized&&g.isSome(d.textureData)&&(d.byteSize=Ia(d.transformedGeometry,
d.textureData),d.textureData.every(Ha)&&Ja(a,d)&&this._idbCache.put(this._getCacheKey(a),d).catch(h=>J.warn(`Failed to update node with textures in IndexedDB cache: ${a.id}: ${h}`)));ca.throwIfAborted(b);return d})}):Promise.resolve(null)};f.addNode=function(a,b,c){return"geometryData"in b?null==b.geometryBuffer?(this._addNodeMeta(a.index,null),Promise.resolve()):this._addData(a,b.attributeDataInfo,()=>this._transformNode(a,b,c).then(d=>this._safeReschedule(()=>{if(g.isNone(d))return a.hasModifications=
!1,this._addCachedNodeData(a,null,c);a.hasModifications=d.transformedGeometry.hasModifications;const {obb:e,componentOffsets:h,featureIds:l,transformedGeometry:m}=d;var q=na.computeGlobalTransformation(a.mbs,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference),v=ea.create([e.center.x,e.center.y,e.center.z],[e.extents.x,e.extents.y,e.extents.z],[e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w]);V.transformMat4(v.center,v.center,q);this.elevationInfo.mode===
y.ElevationMode.Absolute&&(a.geometryObb=v);b.geometryData.componentOffsets=h;l&&(b.geometryData.featureIds=Array.from(l));q={nodeVersion:a.version,geometryData:b.geometryData,requiredTextures:b.requiredTextures,textureData:b.textureData,transformedGeometry:m,globalTrafo:q,geometryObb:v,byteSize:Ia(m,b.textureData)};this._idbCacheEnabled&&this._idbCache.initialized&&Ja(a,q)&&(v=g.isSome(q.textureData)?q.textureData.map(x=>Ha(x)?x:null):null,this._idbCache.put(this._getCacheKey(a),{...q,textureData:v}).catch(x=>
J.warn(`Failed to store node in IndexedDB cache: ${a.id}: ${x}`)));return this._addCachedNodeData(a,q,c)},c))):Promise.reject()};f.computeVisibilityObb=function(a){return t.computeVisibilityObb(a,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)};f._transformNode=function(a,b,c){var d=b.geometryData.geometries;const e=Array(d.length);for(var h=0;h<d.length;++h)e[h]=this._getVertexBufferLayout(d[h],b.geometryDescriptor);
d=a.mbs;h=this.elevationOffset;var l=this._controller.crsIndex,m=this._controller.crsVertex;const q=this.view.renderSpatialReference,v=na.getLocalOrigin(d,h,l),x=na.computeGlobalTransformation(d,h,l,q);l=Q.getProjectorName(l,m);m=Q.getProjectorName(m,q);return g.isNone(l)||g.isNone(m)?Promise.resolve(null):this._worker.invoke({context:this.i3slayer.uid,geometryBuffer:b.geometryBuffer,geometryData:b.geometryData,geometryDescriptor:b.geometryDescriptor,layouts:e,localOrigin:v,globalTrafo:x,mbs:d,obb:a.serviceObb,
elevationOffset:h,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:l,vertexToRenderProjector:m},c)};f._setNewNodeOpacity=function(a){this._setNodeOpacity(a,this.nodeCrossfadingEnabled?0:this.fullOpacity)};f.addCachedGPUData=function(a,b,c){this.elevationInfo.mode===y.ElevationMode.Absolute&&(a.geometryObb=ea.clone(this._collection.getComponentObb(b.objectHandle)));if(this._controller.isGeometryVisible(a)){g.isSome(this._labeler)&&
this._addMetaToLabeler(this._labeler,b);var d=a.index;this._addNodeMeta(d,b);this.updateNodeState(d,c);this._collection.setObjectVisibility(b.objectHandle,qa.State.Visible);this._updateMaterial(b);this._setNewNodeOpacity(b);this.elevationInfo.mode!==y.ElevationMode.Absolute&&this._scheduleElevationAlign(a.index);this._updateEngineObject(b);this._highlights.objectCreated(b);g.isSome(this._treeDebugger)&&this._treeDebugger.update()}else this._cacheGPUData(b)};f.addCachedNodeData=function(a,b,c,d){return this._addData(a,
c,()=>this._addCachedNodeData(a,b,d))};f._addCachedNodeData=function(){var a=M._asyncToGenerator(function*(b,c,d){var e;if(this.suspended||!this._controller.isGeometryVisible(b))this._removeNodeStageData(b.index,this.elevationOffset,this._nodeId2MetaReloading);else if(g.isNone(c))this._addNodeMeta(b.index,null);else{var h=this._addTasks.get(b.index),{geometryData:l,transformedGeometry:m,globalTrafo:q}=c;yield this.attributeOverrides.apply(l.featureIds,h.attributeInfo,d);var v=g.isSome(c.textureData)?
c.textureData.filter(A=>g.isSome(A)&&0!==(A.usage&this.rendererTextureUsage)):[];!ka("disable-feature:i3s-basis")&&v.some(A=>g.isSome(A)&&(A.encoding===I.TextureEncoding.Basis||A.encoding===I.TextureEncoding.KTX2))&&(yield Fa.loadBasis());b.memory=0;var {componentOffsets:x,geometries:G,featureIds:ia}=l,L=this._collection,n=G[0],{layout:B,indices:D,interleavedVertexData:H,positionData:N,hasColors:Db}=m,O=this._materialParameters(n,B),ra=x||new Uint32Array([0,D?D.length:H.byteLength/B[0].stride]);ra=
{vertices:{data:H,count:H.byteLength/B[0].stride,layoutParameters:O.geometryParams},positionData:{positions:N.data,indices:N.indices},indices:D,componentOffsets:ra};var U=n.transformation?ya.clone(n.transformation):ya.create();xa.multiply(U,q,U);n=xa.getTranslation(la.create(),U);U=ab.fromMat4(bb.create(),U);var Pa=this.view.renderSpatialReference,Qa=this.view.basemapTerrain.spatialReference,sa=la.create(),ta=[1,1,1];Q.localLinearScaleFactors(n,Pa,ta,Qa)||J.errorOnce("Unsupported coordinate system for IM overlay");
Q.projectVectorToVector(n,Pa,sa,Qa);var ja=L.createObject({toMapSpace:db.fromValues(sa[0],sa[1],ta[0],ta[1]),geometry:ra,obb:c.geometryObb,transform:{position:n,rotationScale:U}}),{textures:Ra,texturePromise:Eb}=this._initMaterialAndTextures(ja,O.material,v,O.geometryParams.textureCoordinates===fa.TextureCoordinateAttributeType.Atlas);b.memory+=this._memEstimateGeometryAdded(ja);b.memory+=Ra.reduce((A,P)=>A+(g.isSome(P)?this._memEstimateTextureAdded(P):0),0);v=!!O.material.hasParametersFromSource;
O="blend"!==O.material.alphaMode&&1<=O.material.metallicRoughness.baseColorFactor[3];var C=new zb(b,ia,ja,this._getInvalidRendererVersion(),h.attributeInfo,{hasParametersFromSource:v,isOpaque:O},Ra);h.meta=C;!this._hasTextures&&null!=(e=c.requiredTextures)&&e.some(({usage:A})=>0!==(A&I.TextureUsage.ColorTextures))&&(this._hasTextures=!0);this._hasData=!0;this._hasColors=this._hasColors||Db;this._hasTextures=this._hasTextures||!!b.resources.texture;this.notifyChange("hasTexturesOrVertexColors");var Fb=
this.slicePlaneEnabled;return Promise.all([this._addOrUpdateEdgeRendering(C),Eb]).then(([A])=>{g.isSome(A)&&A.updateObjectVisibility(C.objectHandle,!1).catch(this._logEdgeViewError);return this._safeReschedule(()=>{var P=this._addTasks.get(b.index);if(P)if(this._addNodeMeta(b.index,C),P.meta=null,this.suspended)this._removeNodeStageData(b.index,this.elevationOffset);else{L.setObjectVisibility(ja,qa.State.Visible);g.isSome(A)&&A.updateObjectVisibility(C.objectHandle,!0).catch(this._logEdgeViewError);
C.attributeInfo=P.attributeInfo;P=C.cachedRendererVersion!==this._rendererVersion;var Gb=Fb!==this.slicePlaneEnabled;this._updateElevationOffsets(C);var Hb=C.elevationOffsets;this._updateComponentData(C);var Ib=this._applyFiltersToNode(C);(P||g.isSome(A)&&(Gb||Ib||Hb))&&this._addOrUpdateEdgeRendering(C);g.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,C);this._visibleGeometryChanged(C,F.ADD);this._highlights.objectCreated(C);this._updateMaterial(C);this._setNewNodeOpacity(C);g.isSome(this._treeDebugger)&&
this._treeDebugger.update()}},d)}).catch(A=>{g.isSome(h.meta)&&(this._cacheGPUData(h.meta),h.meta=null);throw A;})}});return function(b,c,d){return a.apply(this,arguments)}}();f._addNodeMeta=function(a,b){this._removeNodeStageData(a,this.elevationOffset,this._nodeId2MetaReloading);if(this._nodeId2Meta.has(a)){J.error("Removing duplicated node");const c=this._nodeId2Meta.get(a);g.isSome(c)&&this._deleteComponentObject(c)}else this._controller.updateLoadStatus(a,!0);g.isSome(b)&&(b.lodCrossfadeProgress=
null,this.nodeCrossfadingEnabled&&Z(b.cachedEdgeMaterials,0));this._nodeId2Meta.set(a,b)};f._updateElevationOffsets=function(a){var b;const c=this.view.renderSpatialReference,d=this.elevationInfo;if(g.isNone(c)||d.mode===y.ElevationMode.Absolute)a.elevationOffsets=null;else{var e=this.view.basemapTerrain,h=this._collection.getObjectTransform(a.objectHandle);a.elevationOffsets=null!=(b=a.elevationOffsets)?b:[];for(b=0;b<a.featureIds.length;b++){this._collection.getComponentAabb(a.objectHandle,b,T,
!0);V.set(K,(T[0]+T[3])/2,(T[1]+T[4])/2,T[2]);V.transformMat3(K,K,h.rotationScale);V.add(K,K,h.position);const l=e.getElevation(K[0],K[1],K[2],c),m=d.mode===y.ElevationMode.OnTheGround?this.view.renderCoordsHelper.getAltitude(K):0;a.elevationOffsets[b]=d.offset+(g.isSome(l)?l-m:0)}}};f._elevationChanged=function(a){const b=this._controller.crsIndex;Q.projectBoundingRect(a.extent,a.spatialReference,Oa,b);a=this._controller.updateElevationChanged(Oa,b);g.isNone(a)||a.forAll(c=>{g.isSome(this._nodeId2Meta.get(c))&&
this._scheduleElevationAlign(c)})};f._scheduleElevationAlign=function(a){let b=this._elevationTask;g.isNone(b)&&(this._elevationTask=b=new mb.I3SAsyncElevationUpdater(this.view.resourceController.scheduler,c=>{c=this._nodeId2Meta.get(c);g.isSome(c)&&(this._updateElevationOffsets(c),this._updateComponentData(c),this._updateEdgeRendering(c),g.isSome(this._labeler)&&this._labeler.updateLabelPositions(c))}));b.schedule(a)};f._elevationInfoChanged=function(a,b){const c=a.mode!==y.ElevationMode.Absolute,
d=null!=b&&b!==a&&b.mode!==y.ElevationMode.Absolute;c&&!d?(this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._elevationChanged(e)),"elevation"),this._controller.removeAllGeometryObbs()):d&&!c&&this.handles.remove("elevation");this._intersectionHandler.updateElevationAlignState(c,this.view.state.viewingMode);this._nodeId2Meta.forEach(e=>{g.isSome(e)&&(d&&!c&&(e.node.geometryObb=ea.clone(this._collection.getComponentObb(e.objectHandle))),this._updateElevationOffsets(e),this._updateComponentData(e),
this._updateEdgeRendering(e),g.isSome(this._labeler)&&this._labeler.updateLabelPositions(e))})};f._safeReschedule=function(a,b){ca.throwIfAborted(b);return this._controller.reschedule(a,b)};f._materialParameters=function(a,b){a=g.isSome(a.params.material)?a.params.material:X.defaultMaterial();const c=b.some(e=>"uvRegion"===e.name);b=b.some(e=>"normalCompressed"===e.name);const d=Ga(a);return{geometryParams:this._getGeometryParameters({hasTexture:d,hasNormals:b,hasRegions:c}),material:a}};f._initMaterialAndTextures=
function(a,b,c,d){const e=this._stage.renderView,h=c.map(m=>X.createTexture(m,b,d,e));this._stage.addMany(h);let l=null;this._collection.updateMaterial(a,m=>{l=X.configureMaterial(m,b,h,c,this.view._stage.renderView.textureRepository,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR(),isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference});this._updateMaterialOverlay(m)});return{textures:h,texturePromise:l}};
f._getGeometryParameters=function(a){return{textureCoordinates:a.hasTexture?a.hasRegions?fa.TextureCoordinateAttributeType.Atlas:fa.TextureCoordinateAttributeType.Default:fa.TextureCoordinateAttributeType.None,colors:this._hasVertexColors,normals:a.hasNormals&&!this._isIntegratedMesh}};f._addData=function(a,b,c){let d=this._addTasks.get(a.index);d?d.attributeInfo=b:(d={...ca.createResolver(),attributeInfo:b,meta:null},this._addTasks.set(a.index,d),c().then(d.resolve,d.reject).then(()=>this._addTasks.delete(a.index)).catch(e=>
{this._addTasks.delete(a.index);throw e;}));return d.promise};f._clearAddTasks=function(){this._addTasks.forEach(a=>{g.isSome(a.meta)&&(this._cacheGPUData(a.meta),a.meta=null)});this._addTasks.clear()};f._clippingAreaChanged=function(){var a=this.view.renderSpatialReference;const b=this.i3slayer.spatialReference,c=S.create();this._renderClippingArea=Ea.toBoundingRect(this.view.clippingArea,c,a)?c:null;a=S.create();this._layerClippingArea=Ea.toBoundingRect(this.view.clippingArea,a,b)?a:null;this._filterChange();
this._controller&&this._controller.updateClippingArea(this.view.clippingArea);this._isIntegratedMesh&&this._modificationsChanged()};f._geometryFilterChange=function(){this._controller.geometryFilterChanged(this.hasGeometryFilter)};f._filterChange=function(){this._applyFilters(!1)};f._applyFilters=function(a){this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(b=>{g.isSome(b)&&this._applyFiltersToNode(b)&&(this._addOrUpdateEdgeRendering(b),
this._visibleGeometryChanged(b,F.UPDATE))})};f.getFilters=function(){const a=[],b=this._renderClippingArea;g.isSome(b)&&a.push((c,d)=>this._boundingRectFilter(c,d,b));return a};f.addSqlFilter=function(a,b,c){if(g.isSome(b)){const d=b.fieldNames;a.push((e,h)=>this._sqlFilter(e,h,b,d,c))}};f._sqlFilter=function(a,b,c,d,e){const h={},l=this._createLayerGraphic(h),m=this.i3slayer.objectIdField,q=b.featureIds,v=g.isSome(b.attributeInfo)&&b.attributeInfo.attributeData;d.every(x=>null!=v[x]||x===m)&&t.filterInPlace(a,
q,x=>{h[m]=q[x];for(const G of d)G!==m&&(h[G]=t.getCachedAttributeValue(v[G],x));try{return c.testFeature(l)}catch(G){return e(G),!1}})};f._boundingRectNodeTest=function(a,b){Q.projectBoundingSphere(a.node.mbs,this._controller.crsIndex,Na,this.view.renderSpatialReference);return t.intersectBoundingRectWithMbs(b,Na)};f._boundingRectFeatureTest=function(a,b,c){this._collection.getComponentAabb(a.objectHandle,b,La);W.toRect(La,Ma);return S.intersects(c,Ma)};f._boundingRectFilter=function(a,b,c){var d=
this._collection;const e=this._boundingRectNodeTest(b,c);if(e!==t.MbsIntersectResult.INSIDE)if(e===t.MbsIntersectResult.OUTSIDE)a.length=0;else if(d=d.getComponentCount(b.objectHandle),d.invisible+d.visible===b.featureIds.length){var h=this._transformClippingArea(Ab,c,b.objectHandle);t.filterInPlace(a,b.featureIds,l=>this._boundingRectFeatureTest(b,l,h))}};f._transformClippingArea=function(a,b,c){var d=this._collection.getObjectTransform(c);c=d.position;d=d.rotationScale;a[0]=(b[0]-c[0])/d[0];a[1]=
(b[1]-c[1])/d[4];a[2]=(b[2]-c[0])/d[0];a[3]=(b[3]-c[1])/d[4];return a};f._addOrUpdateEdgeRendering=function(a,b=!0){const c=this._edgeView;if(g.isNone(c))return Promise.resolve(null);const d=a.objectHandle;var e=c.hasObject(d);const {hasEdges:h,perFeatureEdgeMaterials:l}=this._getFilteredEdgeMaterials(a),m={hasSlicePlane:this.slicePlaneEnabled};if(h&&e)return this.nodeCrossfadingEnabled&&(e=this.getNodeOpacity(a),Z(l,e)),c.updateAllComponentMaterials(d,l,m,b).catch(this._logEdgeViewError),c.updateObjectVisibility(d,
!0).catch(this._logEdgeViewError),c.updateAllVerticalOffsets(d,a.elevationOffsets).catch(this._logEdgeViewError),Promise.resolve(c);if(h&&!e)return this._collection.addEdges(d,c,l,m).then(q=>{a.edgeMemoryUsage=q;a.node.memory+=q;c.updateAllVerticalOffsets(d,a.elevationOffsets).catch(this._logEdgeViewError);return c});!h&&e&&(a.node.memory-=a.edgeMemoryUsage,a.edgeMemoryUsage=0,c.removeObject(d));return Promise.resolve(null)};f._logEdgeViewError=function(a){ca.isAbortError(a)||J.error("Error while processing edges. Edges on this layer might not diplay correctly",
this.i3slayer,a)};f._applyFiltersToNode=function(a){return this._applyFiltersToNodeComponents(a)?(g.isSome(this._labeler)&&this._labeler.applyFilterChange(a),!0):!1};f._applyFiltersToNodeComponents=function(a){const b=this._collection;var c=0===b.getComponentCount(a.objectHandle).invisible;b.setAllComponentVisibilities(a.objectHandle,"all");if(0===this._filters.length)return a.filteredIds=null,!c;this._updateCachedFilteredIds(a);if(a.filteredIds===a.featureIds)return!c;c=this._computeFilteredComponentIndices(a);
b.setAllComponentVisibilities(a.objectHandle,c);return!0};f._updateCachedFilteredIds=function(a){if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),a.appliedFilters=this._filters};f._computeFilteredIds=function(a){const b=a.featureIds.slice();for(const c of this._filters)if(c(b,a),0===b.length)break;return b.length===a.featureIds.length?a.featureIds:b};f._computeFilteredComponentIndices=function(a){const b=[];a.featureIds.forEach((c,d)=>{a.filteredIds[b.length]===
c&&b.push(d)});return b};f._removeAllNodeDataFromStage=function(a=this.elevationOffset){this._nodeId2Meta.forEach((b,c)=>this._removeNodeStageData(c,a));this._nodeId2MetaReloading.forEach((b,c)=>this._removeNodeStageData(c,a,this._nodeId2MetaReloading));this._elevationTask=g.destroyMaybe(this._elevationTask)};f.removeNode=function(a){const b=this.elevationOffset;this._removeNodeStageData(a,b);this._removeNodeStageData(a,b,this._nodeId2MetaReloading);g.isSome(this._elevationTask)&&this._elevationTask.remove(a)};
f._removeNodeStageData=function(a,b,c=this._nodeId2Meta){c.has(a)&&this._controller.updateLoadStatus(a,!1);const d=c.get(a);g.isNone(d)?c.delete(a):(this._collection.setObjectVisibility(d.objectHandle,qa.State.Hidden),g.isSome(this._edgeView)&&this._edgeView.hasObject(d.objectHandle)&&this._edgeView.updateObjectVisibility(d.objectHandle,!1).catch(this._logEdgeViewError),this._visibleGeometryChanged(d,F.REMOVE),g.isSome(this._labeler)&&this._labeler.removeNodeMeta(d),c.delete(a),this._highlights.objectDeleted(d),
c===this._nodeId2Meta?(this._cacheGPUData(d,b),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(d)):this._deleteComponentObject(d),g.isSome(this._treeDebugger)&&this._treeDebugger.update())};f._deleteComponentObject=function(a){g.isSome(this._edgeView)&&this._edgeView.removeObject(a.objectHandle);this._memEstimateGeometryRemoved(a.objectHandle);this._collection.destroyObject(a.objectHandle);if(a.textures)for(const b of a.textures)this._memEstimateTextureRemoved(b),this._stage.remove(b)};
f.updateNodeState=function(a,b){a=this._nodeId2Meta.get(a);g.isSome(a)&&this._collection.updateMaterial(a.objectHandle,c=>c.polygonOffsetEnabled=b===ma.NodeState.Hole)};f._invalidateAllSymbols=function(){this._rendererVersion=t.addWraparound(this._rendererVersion,1);this._controller&&this._controller.requestUpdate()};f._getInvalidRendererVersion=function(){return t.addWraparound(this._rendererVersion,-1)};f._rendererChange=function(){var a=M._asyncToGenerator(function*(b){this._currentRenderer=b;
this.notifyChange("rendererTextureUsage");this._rendererVersion=t.addWraparound(this._rendererVersion,1);this._opacityVariable=this._colorVariable=this._rendererFields=null;this._invalidateAllSymbols();b&&(this._rendererFields=yield b.getRequiredFields(this.i3slayer.fieldsIndex));this._updateSymbologyFields();!this._arcade&&b&&"arcadeRequired"in b&&b.arcadeRequired&&(this._arcade=yield ib.loadArcade());if(b&&"visualVariables"in b&&b.visualVariables)for(const c of b.visualVariables)"color"===c.type?
this._colorVariable=c:"opacity"===c.type?this._opacityVariable=c:J.warn(`Unsupported visual variable type for 3D Object Scene Services: ${c.type}`);if(b)for(const c of b.getSymbols())"mesh-3d"!==c.type&&J.error(`Symbols of type '${c.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()});return function(b){return a.apply(this,arguments)}}();f._getCachedEdgeMaterials=function(a){this._hasComponentData&&a.cachedRendererVersion!==this._rendererVersion&&
this._updateCachedRendererData(a);return a.cachedEdgeMaterials};f._getComponentParameters=function(a){this._hasComponentData&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);const b=a.cachedSymbology;return(c,d)=>{var e,h;const l=5*c;cb.set(d.externalColor,b[l+0]/255,b[l+1]/255,b[l+2]/255,b[l+3]/255);d.externalColorMixMode=b[l+4]&(1<<R.CastShadows)-1;d.castShadows=0!==(b[l+4]&1<<R.CastShadows);d.pickable=0!==(b[l+4]&1<<R.Pickable);d.elevationOffset=null!=(e=null==
(h=a.elevationOffsets)?void 0:h[c])?e:0}};f._getSymbolInfo=function(a,b){b=a&&a.getSymbol(b,{arcade:this._arcade});if(!(b instanceof jb))return null;a=b.id;if(this._symbolInfos.has(a))return this._symbolInfos.get(a);b=t.getSymbolInfo(b);this._symbolInfos.set(a,b);return b};f._setSymbologyOverride=function(a,b){this._symbologyOverride!==a&&(this._symbologyOverride=a,this._symbologyOverrideFields=b,this._invalidateAllSymbols(),this._updateSymbologyFields())};f._updateSymbologyFields=function(){this._symbologyFields=
g.isSome(this._symbologyOverrideFields)&&0<this._symbologyOverrideFields.length?g.isSome(this._rendererFields)&&0<this._rendererFields.length?fb.fixFields(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields};f._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasComponentData){var b=this._tmpAttributeOnlyGraphic,c={};b.attributes=c;var d=this._currentRenderer,e=g.isSome(a.attributeInfo)&&
a.attributeInfo.attributeData,h=null!=a.featureIds?this.i3slayer.objectIdField:null,l=null!=e&&g.isSome(this._symbologyFields)&&0<this._symbologyFields.length,m=l?[]:null,q=l?[]:null;if(l&&g.isSome(this._symbologyFields))for(var v of this._symbologyFields){var x=e[v];x&&(m.push(v),q.push(x))}a.cachedSymbology||(a.cachedSymbology=new Uint8Array(5*a.featureIds.length));e={color:aa,castShadows:!0,pickable:!0,colorMixMode:pa.ColorMixModeEnum.Multiply,edgeMaterial:null};v=this.fullOpacity;v=this.nodeCrossfadingEnabled?
this.getNodeOpacity(a):v;x=null;var G=ha.Transparency.OPAQUE,ia=t.transparentEdgeMaterial,L=0;for(let H=0;H<a.featureIds.length;H++){null!=h&&(c[h]=a.featureIds[H]);if(l)for(var n=0;n<m.length;n++)c[m[n]]=t.getCachedAttributeValue(q[n],H);var B=this._getSymbolInfo(d,b);let N=n=null;if(d&&"visualVariables"in d){if(this._colorVariable){var D=za.getColor(this._colorVariable,b,{color:Bb,arcade:this._arcade});D&&(n=aa,n[0]=D.r/255,n[1]=D.g/255,n[2]=D.b/255,this._opacityVariable||null===D.a||(N=D.a))}this._opacityVariable&&
(N=za.getOpacity(this._opacityVariable,b,{arcade:this._arcade}))}B&&B.material&&(D=B.material,n=g.isNone(n)||g.isNone(N)?Ca.overrideColor(n,N,D.color,D.alpha,Ka,aa):Ca.overrideColor(n,N,null,null,Ka,aa));g.isNone(n)&&(n=aa,n[0]=1,n[1]=1,n[2]=1,n[3]=1);e.pickable=!0;e.castShadows=B?B.castShadows:!0;e.colorMixMode=B&&B.material?B.material.colorMixMode:pa.ColorMixModeEnum.Multiply;e.edgeMaterial=B?B.edgeMaterial:null;g.isSome(this._symbologyOverride)&&(e.color=n,this._symbologyOverride(b,e),n=e.color);
if(g.isSome(e.edgeMaterial)){B=0>=n[3]?ha.Transparency.INVISIBLE:1<=n[3]&&(a.material.isOpaque||e.colorMixMode===pa.ColorMixModeEnum.Replace)?ha.Transparency.OPAQUE:ha.Transparency.TRANSPARENT;if(e.edgeMaterial!==x||B!==G)ia={...e.edgeMaterial,opacity:v,objectTransparency:B},x=e.edgeMaterial,G=B;a.cachedEdgeMaterials[H]=ia}else a.cachedEdgeMaterials[H]=t.transparentEdgeMaterial;a.cachedSymbology[L+0]=Math.round(255*n[0]);a.cachedSymbology[L+1]=Math.round(255*n[1]);a.cachedSymbology[L+2]=Math.round(255*
n[2]);a.cachedSymbology[L+3]=Math.round(255*n[3]);a.cachedSymbology[L+4]=e.colorMixMode|+e.castShadows<<R.CastShadows|+e.pickable<<R.Pickable;L+=5}}};f._getFilteredEdgeMaterials=function(a){var b=this._getCachedEdgeMaterials(a);this.nodeCrossfadingEnabled||Z(b,this.fullOpacity);if(g.isNone(a.filteredIds))return{hasEdges:b.some(e=>e!==t.transparentEdgeMaterial),perFeatureEdgeMaterials:b};let c=0,d=!1;b=b.map((e,h)=>{if(a.featureIds[h]!==a.filteredIds[c])return t.transparentEdgeMaterial;d=d||e!==t.transparentEdgeMaterial;
c++;return e});return{hasEdges:d,perFeatureEdgeMaterials:b}};f._updateComponentData=function(a){if(this._hasComponentData){var b=a.objectHandle;a=this._getComponentParameters(a);this._collection.setComponentData(b,a);this._stage.renderView.requestRender()}};f._reloadAll=function(a=this.elevationOffset){this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};f._opacityChange=function(a){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading();
this._nodeId2Meta.forEach(b=>{g.isNone(b)||(this._collection.updateMaterial(b.objectHandle,c=>c.objectOpacity=a),Z(b.cachedEdgeMaterials,a),this._updateEdgeRendering(b))})};f._updateMaterial=function(a){this._collection.updateMaterial(a.objectHandle,b=>{b.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled;b.usePBR=this._usePBR();this._updateMaterialOverlay(b)})};f._updateMaterialOverlay=function(a){};f._updateEngineObject=function(a){this._updateComponentData(a);this._applyFiltersToNode(a);
this._addOrUpdateEdgeRendering(a);this._visibleGeometryChanged(a,F.UPDATE)};f._slicePlaneEnabledChange=function(a){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=a);g.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=a);this._nodeId2Meta.forEach(b=>{g.isNone(b)||(this._collection.updateMaterial(b.objectHandle,c=>{c.commonMaterialParameters.hasSlicePlane=a}),this._updateEdgeRendering(b,!1))})};f._updatePBR=function(){this._nodeId2Meta.forEach(a=>{g.isNone(a)||this._collection.updateMaterial(a.objectHandle,
b=>{b.usePBR=this._usePBR()})});this._hasLoadedPBRTextures=!0};f._usePBR=function(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled};f._updateEdgeRendering=function(a,b=!0){g.isSome(this._edgeView)&&this._edgeView.hasObject(a.objectHandle)&&this._addOrUpdateEdgeRendering(a,b)};f._forAllNodes=function(a){this._nodeId2Meta.forEach(a)};f._forAllFeatures=function(a,b,c=z.ForAllFeaturesVisibilityMode.VISIBLE_ONLY){ua.someMap(this._nodeId2Meta,d=>{if(g.isNone(d))return!1;
if(g.isSome(b))switch(b(d)){case z.ForAllFeaturesReturnType.EXIT:return!0;case z.ForAllFeaturesReturnType.SKIP:return!1}let e=z.ForAllFeaturesReturnType.CONTINUE;switch(c){case z.ForAllFeaturesVisibilityMode.ALL:e=this._forAllFeaturesOfNode(d,a);break;case z.ForAllFeaturesVisibilityMode.VISIBLE_ONLY:e=this._forVisibleFeaturesOfNode(d,a);break;case z.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA:e=this._forAllFeaturesOfNodeInClippingArea(d,a)}return e===z.ForAllFeaturesReturnType.EXIT})};f._forAllFeaturesOfNode=
function(a,b){let c=z.ForAllFeaturesReturnType.CONTINUE;const d=a.featureIds;for(let e=0;e<d.length&&(c=b(d[e],e,a),c!==z.ForAllFeaturesReturnType.EXIT);e++);return c};f._forVisibleFeaturesOfNode=function(a,b){let c=z.ForAllFeaturesReturnType.CONTINUE;const d=a.featureIds;this._collection.forEachVisibleComponent(a.objectHandle,e=>{c=b(d[e],e,a);return c===z.ForAllFeaturesReturnType.CONTINUE});return c};f._forAllFeaturesOfNodeInClippingArea=function(a,b){if(g.isNone(this._renderClippingArea))return this._forAllFeaturesOfNode(a,
b);var c=this._boundingRectNodeTest(a,this._renderClippingArea);if(c===t.MbsIntersectResult.OUTSIDE)return z.ForAllFeaturesReturnType.CONTINUE;if(c===t.MbsIntersectResult.INSIDE)return this._forAllFeaturesOfNode(a,b);c=z.ForAllFeaturesReturnType.CONTINUE;const d=a.featureIds,e=t.getClipRect(this._renderClippingArea,this._collection.getObjectTransform(a.objectHandle));for(let h=0;h<d.length;h++){if(!this._boundingRectFeatureTest(a,h,e))continue;const l=b(d[h],h,a);if(l===z.ForAllFeaturesReturnType.EXIT)return l}return c};
f._createAttributes=function(a,b){const c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);b=g.isSome(b.attributeInfo)&&b.attributeInfo.attributeData;if(g.isSome(b))for(const d of Object.keys(b))c[d]=t.getCachedAttributeValue(b[d],a);return c};f._createGraphic=function(a,b){return this._createLayerGraphic(this._createAttributes(a,b))};f.highlight=function(a){const b=this._highlights;"number"===typeof a?a=[a]:a instanceof ba?a=[a]:a instanceof Wa&&(a=a.toArray());if(Array.isArray(a)&&
0<a.length){if(a[0]instanceof ba){const c=this.i3slayer.fieldsIndex,d=this._getObjectIdField();a=a.map(l=>oa.attributeLookup(c,l.attributes,d));const {set:e,handle:h}=b.acquireSet();b.setFeatureIds(e,a);return h}if("number"===typeof a[0]){const {set:c,handle:d}=b.acquireSet();b.setFeatureIds(c,a);return d}}return Cb};f._visibleGeometryChanged=function(a,b){this._elevationProvider&&(this._elevationProvider.objectChanged(a.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=
Za.schedule(()=>{this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle=null})),this._updateSnappingSources(a,b))};f.getNodeOpacityByIndex=function(a){a=this._nodeId2Meta.get(a);return this.getNodeOpacity(a)};f.getNodeOpacity=function(a){return g.isSome(a)?this._collection.getMaterial(a.objectHandle).objectOpacity:0};f.isNodeFullyFadedIn=function(a){return this._crossfadeHelper.isNodeFullyFadedIn(a)};f.getNodeCrossfadeMetaData=function(a){return this._nodeId2Meta.get(a)};
f.markNodeToRemove=function(a){this._controller&&this._controller.markNodeToRemove(a)};f.removeMarkedNodes=function(){this._controller&&this._controller.removeMarkedNodes()};f.foreachCrossfadeNode=function(a){this._nodeId2Meta.forEach((b,c)=>a(c,b))};f.fadeNode=function(a,b,c){if(this.nodeCrossfadingEnabled){var d=this._nodeId2Meta.get(a);g.isSome(d)&&this._crossfadeHelper.fadeNode(a,d,b,c)}};f.setNodeOpacityByIndex=function(a,b){a=this._nodeId2Meta.get(a);g.isSome(a)&&this._setNodeOpacity(a,b)};
f._setNodeOpacity=function(a,b){this._collection.updateMaterial(a.objectHandle,c=>c.objectOpacity=b);this._setNodeEdgeOpacity(a,b)};f._setNodeEdgeOpacity=function(a,b){!g.isNone(this._edgeView)&&a.cachedEdgeMaterials&&(Z(a.cachedEdgeMaterials,b),a=a.objectHandle,this._edgeView.hasObject(a)&&this._edgeView.updateAllComponentOpacities(a,b).catch(this._logEdgeViewError))};f.updateNodeModificationStatus=function(a){var b=a.length;if(this.hasModifications&&!(0>=b)&&!0===this._i3sWasmLoaded){b=this.i3slayer.uid;
var c=xb(a);if(g.isSome(c)){da.filterObbsForModificationsSync({context:b,buffer:c.buffer});const d=new Float64Array(c.buffer);a.forAll((e,h)=>{h=da.interpretObbModificationResults(d[h]);e.imModificationImpact=h;h!==ma.NodeIMModificationImpact.Unmodified&&this._controller.invalidateGeometryVisibility(e.index)})}}};f.notifyUpdate=function(){this.notifyChange("updating")};f.notifyLODUpdate=function(){this._controller.notifyLODUpdate()};f.isUpdating=function(){return!(!this._controller||!this._controller.updating)||
!!this._visibleGeometryChangedSchedulerHandle||g.isSome(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof Promise||0<this._asyncModuleLoading||g.isSome(this._elevationTask)&&this._elevationTask.running};f.trackSnappingSources=function(a){var b=this;const c={events:a,fetchEdgeLocations:function(){var d=M._asyncToGenerator(function*(e,h,l){e=b._nodeId2Meta.get(e);if(g.isNone(e))throw Error("invalid-node");const {origin:m,buffer:q}=yield b._collection.extractEdgeInformation(e.objectHandle,
h,l);return{locations:q,type:"components",objectIds:e.featureIds,origin:m}});return function(e,h,l){return d.apply(this,arguments)}}(),remove:()=>{Ua.removeUnordered(this._snappingSourcesTrackers,c)}};this._snappingSourcesTrackers.push(c);this._nodeId2Meta.forEach((d,e)=>{g.isNone(d)||a.add(e,d.node.renderMbs)});return c};f._updateSnappingSources=function(a,b){const {index:c,renderMbs:d}=a.node;for(const e of this._snappingSourcesTrackers)b!==F.REMOVE&&b!==F.UPDATE||e.events.remove(c),b!==F.ADD&&
b!==F.UPDATE||e.events.add(c,d)};M._createClass(r,[{key:"lodCrossfadeoutDuration",get:function(){return 0}},{key:"lodCrossfadeinDuration",get:function(){return 0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return 0}},{key:"layerUid",get:function(){return this.i3slayer&&this.i3slayer.uid}},{key:"sublayerUid",get:function(){return null}},{key:"hasTexturesOrVertexColors",get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}},{key:"rendererTextureUsage",
get:function(){return t.rendererNeedsTextures(this._currentRenderer)?this._usePBR()||this._hasLoadedPBRTextures?I.TextureUsage.AllTexturesPBR:I.TextureUsage.AllTextures:this._usePBR()||this._hasLoadedPBRTextures?I.TextureUsage.GeometryTexturesPBR:I.TextureUsage.GeometryTextures}},{key:"elevationOffset",get:function(){const a=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){const b=wa.getMetersPerVerticalUnitForSR(this.i3slayer.spatialReference),c=Aa.getMetersPerUnit(a.unit);
return g.unwrapOr(a.offset,0)*c/b}return 0}},{key:"elevationInfo",get:function(){const a=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null==a)return{mode:y.ElevationMode.Absolute,offset:0};var b=wa.getMetersPerVerticalUnitForSR(this.i3slayer.spatialReference);const c=Aa.getMetersPerUnit(a.unit);b=g.unwrapOr(a.offset,0)*c/b;switch(a.mode){case "absolute-height":return{mode:y.ElevationMode.Absolute,offset:b};case "relative-to-ground":return{mode:y.ElevationMode.RelativeToGround,offset:b};
case "on-the-ground":return{mode:y.ElevationMode.OnTheGround,offset:0};default:return{mode:y.ElevationMode.Absolute,offset:0}}}},{key:"supportedTextureEncodings",get:function(){return X.getSupportedEncodings(this.view._stage.renderView.capabilities)}},{key:"uncompressedTextureDownsamplingEnabled",get:function(){var a;const b=null==(a=this.view)?void 0:a.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled;a=0===(this.supportedTextureEncodings&I.TextureEncoding.DDS_S3TC);return b&&a}},
{key:"_idbCacheEnabled",get:function(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}},{key:"supportsNodeCrossFading",get:function(){var a,b;return!(null!=(a=this.view)&&null!=(b=a._stage)&&b.renderView.shadowsEnabled)}},{key:"nodeCrossfadingEnabled",get:function(){return this.supportsNodeCrossFading&&(0<this.lodCrossfadeinDuration||0<this.lodCrossfadeoutDuration||0<this.lodCrossfadeUncoveredDuration)}},{key:"nodeFadeoutEnabled",
get:function(){return this.supportsNodeCrossFading&&0<this.lodCrossfadeoutDuration}},{key:"hasGeometryFilter",get:function(){return!1}},{key:"performanceInfo",get:function(){const a={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/
1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/1048576).toFixed(1)+"MB"};g.isSome(this._memCache)&&(a.MemCache=Math.round(100*this._memCache.hitRate)+"% hit");this._controller&&(this._idbCacheEnabled&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a}},{key:"test",get:function(){const a=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){const b=[];a._forAllFeatures(c=>{b.push(c);
return z.ForAllFeaturesReturnType.CONTINUE},null,z.ForAllFeaturesVisibilityMode.VISIBLE_ONLY);b.sort((c,d)=>c-d);return b},get numNodes(){return a._nodeId2Meta.size}}}},{key:"hasModifications",get:function(){return this._isIntegratedMesh&&g.isSome(this._layerClippingArea)||this._modifications&&0<this._modifications.length}}]);return r}(k);u.__decorate([w.property()],k.prototype,"_hasLoadedPBRTextures",void 0);u.__decorate([w.property()],k.prototype,"_asyncModuleLoading",void 0);u.__decorate([w.property()],
k.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);u.__decorate([w.property()],k.prototype,"view",void 0);u.__decorate([w.property()],k.prototype,"i3slayer",void 0);u.__decorate([w.property()],k.prototype,"_controller",void 0);u.__decorate([w.property()],k.prototype,"_labeler",void 0);u.__decorate([w.property()],k.prototype,"updating",void 0);u.__decorate([w.property()],k.prototype,"suspended",void 0);u.__decorate([w.property()],k.prototype,"holeFilling",void 0);u.__decorate([w.property(tb.updatingProgress)],
k.prototype,"updatingProgress",void 0);u.__decorate([w.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],k.prototype,"updatingProgressValue",void 0);u.__decorate([w.property({readOnly:!0})],k.prototype,"hasTexturesOrVertexColors",null);u.__decorate([w.property({readOnly:!0})],k.prototype,"rendererTextureUsage",null);u.__decorate([w.property()],k.prototype,"filter",void 0);u.__decorate([w.property({readOnly:!0})],k.prototype,"elevationOffset",null);u.__decorate([w.property({readOnly:!0})],
k.prototype,"elevationInfo",null);u.__decorate([w.property({type:Boolean})],k.prototype,"slicePlaneEnabled",void 0);u.__decorate([w.property()],k.prototype,"supportedTextureEncodings",null);u.__decorate([w.property()],k.prototype,"uncompressedTextureDownsamplingEnabled",null);u.__decorate([w.property({type:[hb]})],k.prototype,"_modifications",void 0);u.__decorate([w.property()],k.prototype,"_elevationTask",void 0);return k=u.__decorate([$a.subclass("esri.views.3d.layers.I3SMeshView3D")],k)};Object.defineProperties(y,
{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});