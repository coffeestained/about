// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../renderers/ClassBreaksRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/PieChartRenderer ../../../../renderers/Renderer ../../../../renderers/SimpleRenderer ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/jsonUtils ../../../../symbols ../../../../core/Accessor ../../../../core/has ../../../../core/Error ../../../../core/Handles ../../../../core/handleUtils ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./ElevationQuery ./enums ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphicCreationContext ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicStateTracking ./graphicUtils ./interfaces ./Loadable ./SpatialIndex2D ./symbolComplexity ../support/StageLayerElevationProvider ../../support/extentUtils ../../support/PropertiesPool ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler ../../../../geometry/Extent ../../../../geometry/Point ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol".split(" "),
function(k,y,l,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,S,Oa,Pa,aa,Qa,F,ba,ca,da,T,e,U,B,A,ea,m,Ra,Sa,fa,N,G,I,D,H,ha,ia,O,P,V,ja,ka,W,la,J,K,ma,na,oa,pa,qa,ra,sa,X,ta,ua,Y,va,wa,xa,v,ya,za,L,Aa,Ba,Z,Ca,Da){var Q;const R=I.create(),q=H.create(),u=da.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");k.Graphics3DCore=Q=function(w){function M(a){var b=w.call(this,a)||this;b.propertiesPool=new xa.PropertiesPool({computedExtent:Aa},y._assertThisInitialized(b));b.computedExtent=null;b.currentRenderer=null;b.rendererHasGeometryOperations=
!1;b.graphicStateTracking=null;b.symbolCreationContext=new oa.Graphics3DSymbolCreationContext((c,d)=>b._frameTask.schedule(c,d));b.graphics3DGraphics=new Map;b.stageLayer=null;b.stage=null;b.graphicsDrapedUids=new Set;b.graphicsBySymbol=new Map;b.symbolConversionCache=new Map;b.symbols=new Map;b.graphicsWithoutSymbol=new Map;b.graphicsWaitingForSymbol=new Map;b.graphicsUpdateId=0;b._handles=new ba;b._frameTask=L.ImmediateTask;b.suspendSymbolCleanup=!1;b._viewSpatialReference=null;b.arcadeOnDemand=
null;b.rendererChangeAbortController=null;b.elevationInfoChangeAbortController=null;b.setupAbortController=null;b.elevationAlignment=null;b.scaleVisibility=null;b._spatialIndex=null;b.extentPadding=0;b._updatingPendingLoadedGraphicsChange=null;b.featureStore=null;b.deconflictor=null;b.labeler=null;b.objectStates=null;b.viewElevationProvider=null;b.stageLayerElevationProvider=null;b.sharedSymbolResourcesOwnerHandle=null;b.whenGraphics3DGraphicRequests={};b.pendingUpdates=new Map;b.numberOfGraphics=
0;b.numberOfGraphicsProvidingElevation=0;b.pendingAdds=0;b.pendingRemoves=0;b._loadingSymbols=0;b.pendingUpdatesPool=new U({allocator:c=>c||new Ea,deallocator:c=>{c.clear();return c}});b.symbolWarningLogged=!1;b.geometryWarningLogged=!1;b.objectIdInvisibleSet=new Set;b._whenSymbolRemoved=new U;b.preferredUpdatePolicy=v.UpdatePolicy.SYNC;b.forcedUpdatePolicy=null;b.elevationFeatureExpressionEnabled=!0;b.owner=null;b.layer=null;b.graphicSymbolSupported=!0;b.getRenderingInfoWithoutRenderer=!1;b.hasZ=
null;b.hasM=null;b._usedMemory=0;b._visible=void 0;b._startCreateGraphics=!1;return b}y._inheritsLoose(M,w);var g=M.prototype;g._getConvertedSymbol=function(a){if("web-style"===a.type)return a.clone();var b=this.symbolConversionCache.get(a.id);if(e.isSome(b))return b;b=W.to3D(a,{retainId:!0,hasLabelingContext:this._hasLabelingContext(a)});const c=b.symbol||null;e.isNone(c)&&b.error&&u.error(b.error.message);this.symbolConversionCache.set(a.id,c);return c};g._getSymbolComplexitiesUsedOrRenderer=function(a){if(e.isNone(a))return[];
var b=a.getSymbols(),c="backgroundFillSymbol"in a&&a.backgroundFillSymbol;if(!(c||b&&b.length))return[];a=[];c=this._getSymbolComplexityUsedOrRenderer(c);e.isSome(c)&&a.push(c);for(const d of b)b=this._getSymbolComplexityUsedOrRenderer(d),e.isSome(b)&&a.push(b);return a};g._getSymbolComplexityUsedOrRenderer=function(a){if(e.isNone(a))return null;const b=this.symbols.get(a.id);if(e.isSome(b))return b.complexity;a=this._getConvertedSymbol(a);return e.isSome(a)?Y.defaultSymbolComplexity(a):null};g._getSymbolComplexitiesUsed=
function(){const a=[];this.symbols.forEach(b=>{e.isSome(b)&&a.push(b.complexity)});return a};g.initialize=function(){this._viewSpatialReference=this.owner.view.spatialReference;this._set("featureStore",new ma.Graphics3DFeatureStore({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:a=>this.graphics3DGraphics.forEach(a),
toArray:()=>Array.from(this.graphics3DGraphics.values())}))};g.setup=function(){var a=y._asyncToGenerator(function*(b){this.setupAbortController=new AbortController;const c=this.setupAbortController.signal;this._set("elevationAlignment",b.elevationAlignment);this._set("scaleVisibility",b.scaleVisibility);this._set("filterVisibility",b.filterVisibility);this._set("deconflictor",b.deconflictor);this._set("labeler",b.labeler);this._set("objectStates",b.objectStates);const d=this.owner.view;this.viewElevationProvider=
new la.ViewElevationProvider(this._viewSpatialReference,d);this._initializeStage(d,this.layer.uid);this.symbolCreationContext.sharedResources=d.sharedSymbolResources;this.sharedSymbolResourcesOwnerHandle=d.sharedSymbolResources.addGraphicsOwner(this.owner);e.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=d.sharedSymbolResources.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=
d.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.graphicsCoreOwner=this.owner;this.symbolCreationContext.localOriginFactory=new ya.GridLocalOriginFactory(d.renderSpatialReference);this.symbolCreationContext.elevationProvider=d.elevationProvider;this.symbolCreationContext.notifyGraphicGeometryChanged=f=>this.notifyGraphicGeometryChanged(f);this.symbolCreationContext.notifyGraphicVisibilityChanged=f=>this.notifyGraphicVisibilityChanged(f);b=K.extractExpressionInfo(this.layer.elevationInfo,
this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=yield K.createContext(b,this._viewSpatialReference,u);B.throwIfAborted(c);this.symbolCreationContext.screenSizePerspectiveEnabled=d.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled;if("drapeSourceType"in
this.owner){const {owner:f}=this;this.symbolCreationContext.drapeSourceRenderer=d.basemapTerrain.overlayManager.registerGeometryDrapeSource(f);this._handles.add(ca.makeHandle(()=>d.basemapTerrain.overlayManager.unregisterDrapeSource(f)))}this._handles.add([A.watch(()=>this.suspendedOrOutsideOfView,()=>this._frameTask.reschedule(()=>this._updateLayerVisibility())),A.watch(()=>{var f;return[null==(f=this.layer)?void 0:f.screenSizePerspectiveEnabled,this.owner.view.screenSizePerspectiveEnabled]},()=>
{const f=d.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;if(f!==this.symbolCreationContext.screenSizePerspectiveEnabled){var h;this.symbolCreationContext.screenSizePerspectiveEnabled=f;null==(h=this.labeler)?void 0:h.reset();this.recreateAllGraphicsAndSymbols()}}),A.watch(()=>this.owner.slicePlaneEnabled,f=>this._slicePlaneEnabledChange(!!f)),A.watch(()=>{var f;return null==(f=this.owner.view.state)?void 0:f.pixelRatio},()=>this._pixelRatioChange()),A.watch(()=>{var f;return null==
(f=this.owner.view.qualitySettings)?void 0:f.physicallyBasedRenderingEnabled},f=>this._physicalBasedRenderingChange(f)),A.when(()=>{var f;return null==(f=d.basemapTerrain)?void 0:f.tilingScheme},f=>{f.spatialReference.equals(this.symbolCreationContext.overlaySR)||(this.symbolCreationContext.overlaySR=d.basemapTerrain.spatialReference);this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([A.on(()=>{var h;return null==(h=this.owner)?void 0:h.loadedGraphics},"change",h=>
{this._graphicsCollectionChanged(h);this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics();this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")},{initial:!0}),A.watch(()=>this.effectiveUpdatePolicy,f=>{e.isSome(this.stageLayer)&&(this.stageLayer.updatePolicy=f);this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC;f===v.UpdatePolicy.SYNC&&this.runTask(L.noBudget)},A.syncAndInitial)]);this._frameTask=
d.resourceController.scheduler.registerTask(L.TaskPriority.GRAPHICS_CORE,this);this.layer&&"featureReduction"in this.layer&&this._handles.add(A.watch(()=>this.layer.featureReduction,()=>this.deconflictor.featureReductionChange()));this.notifyChange("averageSymbolComplexity");try{yield this.rendererChange(this.layer.renderer)}catch{}B.throwIfAborted(c);this.setupAbortController=null});return function(b){return a.apply(this,arguments)}}();g._abortSetup=function(){this.setupAbortController&&(this.setupAbortController.abort(),
this.setupAbortController=null)};g.destroy=function(){this._abortSetup();this._abortRendererChange();this._abortElevationInfoChange();this.owner.view.deconflictor.removeGraphicsOwner(this);this.owner.view.labeler.removeGraphicsOwner(this);this._updatingPendingLoadedGraphicsChange=e.removeMaybe(this._updatingPendingLoadedGraphicsChange);this.clear();this.graphicStateTracking=e.destroyMaybe(this.graphicStateTracking);this.stage&&(this.stage.remove(this.stageLayer),this.stage=this.stageLayer=null);this._handles=
e.destroyMaybe(this._handles);this._frameTask.remove();this._frameTask=L.ImmediateTask;this._viewSpatialReference=null;this._set("owner",null);for(const a in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[a].reject(new F("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null;this.sharedSymbolResourcesOwnerHandle=e.removeMaybe(this.sharedSymbolResourcesOwnerHandle);this.propertiesPool=e.destroyMaybe(this.propertiesPool);this.pendingUpdatesPool=
null;this.symbolConversionCache.clear();this.objectIdInvisibleSet.clear();this._spatialIndex=e.destroyMaybe(this._spatialIndex);this._set("featureStore",e.destroyMaybe(this.featureStore))};g.clear=function(){var a,b;null==(a=this.objectStates)?void 0:a.allGraphicsDeleted();e.isSome(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted();this.graphics3DGraphics.forEach(c=>c.destroy());null==(b=this._spatialIndex)?void 0:b.clear();this.graphics3DGraphics.clear();this._usedMemory=
this.numberOfGraphics=0;this._updateLayerVisibility();this.symbols.forEach(e.destroyMaybe);this.symbols.clear();this.graphicsBySymbol.clear();this.graphicsWithoutSymbol.clear();this.graphicsWaitingForSymbol.clear();this.pendingUpdates.clear();this.pendingUpdatesPool.clear();this.pendingRemoves=this.pendingAdds=0;this.notifyChange("updating");this.notifyChange("running");this.notifyChange("updatingRemaining");this.featureStore.events.emit("changed")};g._initializeStage=function(a,b){this.stage=a._stage;
this.stageLayer=new za.WebGLLayer({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},b);this.stage.add(this.stageLayer);a=this.stageLayer.events;a.on("objectTransformation",c=>this.notifyGraphicGeometryChanged(c.metadata.graphicUid));a.on("visibilityChanged",c=>this.notifyGraphicVisibilityChanged(c.metadata.graphicUid));a.on("objectGeometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));a.on("objectGeometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));
a.on("vertexAttrsUpdated",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid))};g.notifyGraphicGeometryChanged=function(a){e.isNone(this.graphicStateTracking)||e.isNone(a)||(a=this.graphics3DGraphics.get(a))&&this.graphicStateTracking.updateGraphicGeometry(a)};g.notifyGraphicVisibilityChanged=function(a){e.isNone(this.graphicStateTracking)||e.isNone(a)||(a=this.graphics3DGraphics.get(a))&&this.graphicStateTracking.updateGraphicVisibility(a)};g._updateLayerVisibility=function(){var a=
this.numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;a=!this.suspendedOrOutsideOfView&&!a;a!==this._visible&&((this._visible=a)?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())};g._updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||0<this.layer.opacity)};g.getGraphics3DGraphicById=function(a){return this.graphics3DGraphics.get(a)};
g.getGraphics3DGraphicByObjectId=function(a){var b;return null!=(b=this.owner.layer)&&b.objectIdField?this._findGraphics3DGraphicByObjectId(a):null};g._getGraphicObjectID=function(a,b=this.owner.layer&&this.owner.layer.objectIdField){return O.getObjectId(a,b)};g.updateLabelingInfo=function(){var a=y._asyncToGenerator(function*(b){const c=this.deconflictor&&this.deconflictor.labelingInfoChange(b);b=this.labeler&&this.labeler.labelingInfoChange(b);yield B.eachAlways([c,b])});return function(b){return a.apply(this,
arguments)}}();g.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange();this.labeler&&this.labeler.visibilityInfoChange()};g.runTask=function(a){this._frameTask.processQueue(a);this._applyPendingUpdates(a);this.notifyChange("running");this.running||this.notifyChange("updating");this.notifyChange("updatingRemaining")};g.setObjectIdVisibility=function(a,b){b?this.objectIdInvisibleSet.delete(a):this.objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);
e.isSome(a)&&this._updateUserVisibility(a)};g._findGraphics3DGraphicByObjectId=function(a){return T.findInMap(this.graphics3DGraphics,b=>this._getGraphicObjectID(b.graphic)===a)};g._updateUserVisibility=function(a){if(e.isNone(a))return!1;var b=a.graphic;const c=this._getGraphicObjectID(b);b=b.visible&&!this.owner.suspended&&(e.isNone(c)||!this.objectIdInvisibleSet.has(c));return a.setVisibilityFlag(J.VisibilityFlag.USER_SETTING,b,J.VisibilityGroup.GRAPHIC)};g._whenGraphics3DGraphic=function(a){var b=
this.graphics3DGraphics.get(a.uid);if(b)return Promise.resolve(b);if(b=this.whenGraphics3DGraphicRequests[a.uid])return b.promise;b=B.createDeferred();this.whenGraphics3DGraphicRequests[a.uid]=b;return b.promise};g._boundsForGraphics3DGraphic=function(){var a=y._asyncToGenerator(function*(b,c){const d=this._viewSpatialReference,f=this.owner.view.renderSpatialReference,h=this.owner.view.basemapTerrain.spatialReference;var p=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:e.isSome(c)&&
c.useViewElevation,minDemResolution:e.isSome(c)&&c.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null;b=yield b.getProjectedBoundingBox((n,r,z)=>D.projectBuffer(n,f,r,n,d,r,z),(n,r,z)=>D.projectBuffer(n,h,r,n,d,r,z),p,e.get(c,"signal"));if(!b)return null;c=b.boundingBox;b.requiresDrapedElevation&&(p=this.symbolCreationContext.elevationProvider)&&(H.center(c,R),p=e.unwrapOr(p.getElevation(R[0],R[1],0,d,"ground"),0),c[2]=Math.min(c[2],p),c[5]=Math.max(c[5],p));return{boundingBox:c,
screenSpaceObjects:b.screenSpaceObjects}});return function(b,c){return a.apply(this,arguments)}}();g.whenGraphicBounds=function(){var a=y._asyncToGenerator(function*(b,c){yield A.whenOnce(()=>{var h;return null==(h=this.owner)?void 0:h.loadedGraphics});const d=this.owner.layer&&this.owner.layer.objectIdField;var f=this.owner.loadedGraphics.find(h=>h===b?!0:d&&h.attributes&&b.attributes&&h.attributes[d]===b.attributes[d]);if(!f)throw new F("internal:graphic-not-part-of-view","Graphic is not part of this view");
f=yield this._whenGraphics3DGraphic(f);return this._boundsForGraphics3DGraphic(f,c)});return function(b,c){return a.apply(this,arguments)}}();g.computeAttachmentOrigin=function(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var c=a.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;G.set(C,0,0,0);a=0;if(0<c.render.num){if(!D.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,E,b))return null;G.add(C,C,E);a++}if(0<
c.draped.num){const [d,f]=c.draped.origin;c=e.unwrapOr(this.viewElevationProvider.getElevation(d,f,"ground"),0);G.set(E,d,f,c);if(!D.projectVectorToVector(E,this.viewElevationProvider.spatialReference,E,b))return null;G.add(C,C,E);a++}1<a&&G.scale(C,C,1/a);return new Ba({x:C[0],y:C[1],z:C[2],spatialReference:b})};g.getSymbolLayerSize=function(a,b){var c=this.symbols.get(a.id);if(e.isNone(c))throw new F("internal:symbol-not-part-of-view","Symbol is not part of this view");a=a.symbolLayers.indexOf(b);
if(-1===a)throw new F("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(a);if(null==c)throw new F("internal:missing-size","Symbol layer has no valid size");return c};g._graphicsCollectionChanged=function(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))};g.graphicUpdateHandler=function(a){const b=a.graphic.uid,c=this.graphics3DGraphics.get(b);if(!e.isNone(c)||!e.isNone(this.graphicsWithoutSymbol.get(b)))switch(a.property){case "visible":this._graphicUpdateVisibleHandler(c);
break;case "geometry":this._graphicUpdateGeometryHandler(c,a);break;case "symbol":this._graphicUpdateSymbolHandler(c,a);break;case "transform":this._graphicUpdateTransformHandler(c,a)}};g._graphicUpdateGeometryHandler=function(a,b){const c=b.graphic.geometry;if(e.isNone(c))this._recreateGraphic(b.graphic);else if(e.isNone(a)){if(a=b.graphic.symbol&&b.graphic.symbol.id)if(a=this.symbols.get(a),e.isSome(a)&&a.loadStatus===ta.LoadStatus.LOADING)return;this._recreateGraphic(b.graphic)}else{var d=a.graphics3DSymbol;
!e.isNone(b.newValue)&&d.updateGeometry(a,b.newValue)||this._recreateGraphic(a.graphic);this._expandComputedExtent(c)}};g._graphicUpdateSymbolHandler=function(a,b){var c=b.graphic;const d=e.isSome(a)?a.graphics3DSymbol:e.isSome(b.oldValue)?this.symbols.get(b.oldValue.id):null;if(e.isNone(d)||e.isNone(b.newValue))this._recreateGraphic(c);else{var f=d.symbol;b=this._getConvertedSymbol(b.newValue);if(e.isSome(b)&&(b.type!==f.type||"web-style"===b.type)||"web-style"===f.type)this._recreateGraphic(c);
else{var h=this.graphicsBySymbol.get(f.id);if(h&&1!==h.size)this._recreateGraphic(c);else if(h=N.diff(f,b),e.isNone(h))this._updateSymbolMapping(f.id,b);else if(h={diff:h,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(h),N.isEmpty(h.diff)){var p=this._getRenderingInfo(c);if(e.isNone(p))this._recreateGraphic(c);else{c=d.extentPadding;for(const n of h.symbolStatePatches)n();c!==d.extentPadding&&this._recomputeExtentPadding();if(e.isSome(a))for(const n of h.graphics3DGraphicPatches)n(a,
p);this._updateSymbolMapping(f.id,b)}}else this._recreateGraphic(c)}}};g._graphicUpdateVisibleHandler=function(a){this._updateUserVisibility(a)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};g._graphicUpdateTransformHandler=function(a,b){};g.recreateGraphics=function(a){this.suspendSymbolCleanup=!0;this.remove(a);this.add(a);this.suspendSymbolCleanup=!1;this.effectiveUpdatePolicy===v.UpdatePolicy.SYNC&&this._cleanupSymbols()};g._recreateGraphic=function(a){this.recreateGraphics([a])};
g._beginGraphicUpdate=function(a){const b=this.graphicsUpdateId;this.graphicsUpdateId++;this.graphicsWaitingForSymbol.set(a.uid,b);1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating");return b};g._endGraphicUpdate=function(a){a&&(this.graphicsWaitingForSymbol.delete(a.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))};g._recomputeExtentPadding=function(){let a=0;this.symbols.forEach(b=>{e.isSome(b)&&(a=Math.max(a,b.extentPadding))});
this._set("extentPadding",a)};g._expandComputedExtent=function(a){var b=a.spatialReference;O.computeAABB(a,q);a=this._viewSpatialReference;var c=Q.tmpVec;!b.equals(a)&&D.projectXYZToVector(q[0],q[1],0,b,c,a)&&(q[0]=c[0],q[1]=c[1],D.projectXYZToVector(q[3],q[4],0,b,c,a),q[3]=c[0],q[4]=c[1]);if(isFinite(q[0])&&isFinite(q[3])&&isFinite(q[1])&&isFinite(q[4])){b=this.computedExtent;c=null;var d=isFinite(q[2])&&isFinite(q[5]),f=d&&(!b||null==b.zmin||q[2]<b.zmin);d=d&&(!b||null==b.zmax||q[5]>b.zmax);if(b){if(q[0]<
b.xmin||q[1]<b.ymin||q[3]>b.xmax||q[4]>b.ymax||f||d)c=this.propertiesPool.get("computedExtent"),c.xmin=Math.min(q[0],b.xmin),c.ymin=Math.min(q[1],b.ymin),c.xmax=Math.max(q[3],b.xmax),c.ymax=Math.max(q[4],b.ymax),c.spatialReference=a}else c=this.propertiesPool.get("computedExtent"),c.xmin=q[0],c.ymin=q[1],c.xmax=q[3],c.ymax=q[4],c.spatialReference=a;c&&(f&&(c.zmin=q[2]),d&&(c.zmax=q[5]),this._set("computedExtent",c))}};g._abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&
(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)};g.elevationInfoChange=function(){var a=y._asyncToGenerator(function*(){var b,c;this._abortElevationInfoChange();const d=new AbortController;this.elevationInfoChangeAbortController=d;const f=K.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=yield K.createContext(f,this._viewSpatialReference,u);B.throwIfAborted(d);
this.elevationInfoChangeAbortController=null;null==(b=this.labeler)?void 0:b.elevationInfoChange();this.forEachGraphics3DSymbol((h,p,n)=>{h.globalPropertyChanged("elevationInfo",p)?p.forEach(r=>{const z=r.graphic;r=r.labelGraphics;for(const x of r)x.graphics3DSymbolLayer.updateGraphicElevationContext(z,x)}):this._recreateSymbol(n)});this.updateStageLayerElevationProvider();null==(c=this.elevationAlignment)?void 0:c.elevationInfoChange()});return function(){return a.apply(this,arguments)}}();g.updateStageLayerElevationProvider=
function(){if(this.stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this.numberOfGraphicsProvidingElevation&&(this.stageLayerElevationProvider=
new va.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))};g._clearSymbolsAndGraphics=function(){var a,b,c,d;this.clear();e.isSome(this.filterVisibility)&&this.filterVisibility.clear();null==(a=this.labeler)?void 0:a.reset();null==(b=this.deconflictor)?void 0:b.clear();null==(c=this.elevationAlignment)?void 0:c.clear();null==(d=this.stageLayer)?void 0:d.invalidateSpatialQueryAccelerator();
this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)};g.startCreateGraphics=function(){this._startCreateGraphics=!0;this.recreateAllGraphics()};g.recreateAllGraphics=function(){this._recreateAllGraphics(!1)};g.recreateAllGraphicsAndSymbols=function(){this._recreateAllGraphics(!0)};g._recreateAllGraphics=function(a=!1){if(this._startCreateGraphics){var {loadedGraphics:b,
view:c}=this.owner,d=c.basemapTerrain.tilingScheme&&b&&b.length?b.toArray():null;!a&&d||this._clearSymbolsAndGraphics();this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this._set("computedExtent",null);d&&(a?this.add(d):this.recreateGraphics(d))}};g._recreateSymbol=function(a){var b=this.graphicsBySymbol.get(a);const c=[];b&&(b.forEach((d,
f)=>{var h;const p=d.usedMemory;this._conditionalRemove(d,f);null==(h=this._spatialIndex)?void 0:h.remove(d);c.push(d.graphic);d.destroy();this._removeGraphics3DGraphic(f,p);this._updateLayerVisibility();this.featureStore.events.emit("changed")}),this.graphicsBySymbol.set(a,new Map));b=this.symbols.get(a);e.destroyMaybe(b);this.symbols.delete(a);this.add(c)};g._recreateGraphicsForSymbol=function(a){if(a=this.graphicsBySymbol.get(a)){const b=[];a.forEach(c=>b.push(c.graphic));this.recreateGraphics(b)}};
g._conditionalRemove=function(a,b){var c,d,f;this.graphicsDrapedUids.delete(b);null==(c=this.objectStates)?void 0:c.removeGraphic(a);null==(d=this.labeler)?void 0:d.removeGraphic(a);null==(f=this.deconflictor)?void 0:f.removeGraphic(a);e.isSome(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(a)};g.add=function(a){a&&0!==a.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(a)===v.UpdatePolicy.ASYNC?this._addDelayed(a):
this._addImmediate(a),this.notifyChange("updating")):u.error("#add()","Cannot add graphics before terrain surface has been initialized"))};g._updatePolicyForGraphics=function(a){if(this.effectiveUpdatePolicy===v.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const b of a)if(e.isSome(b.geometry)&&"mesh"===b.geometry.type&&!b.geometry.loaded)return v.UpdatePolicy.ASYNC;return this.effectiveUpdatePolicy};g._addImmediate=function(a){this.symbolWarningLogged=this.geometryWarningLogged=
!1;for(const b of a)this._addGraphic(b,this._getRenderingInfo(b,u),v.UpdatePolicy.SYNC);this._cleanupSymbols();this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()};g._addDelayed=function(a){for(const b of a){a=b.uid;let c=this.pendingUpdates.get(a);c?c.add?c.state!==t.NEW&&c.abortController.abort():this.pendingAdds++:(c=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(a,c));c.add=b}this.notifyChange("running");
this.notifyChange("updatingRemaining")};g.remove=function(a){this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?this._removeDelayed(a):this._removeImmediate(a);this.notifyChange("updating")};g._removeImmediate=function(a){for(const b of a)this._removeGraphic(b);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};g._removeDelayed=function(a){for(const c of a){a=c.uid;var b=this.pendingUpdates.get(a);b?b.add&&(b.remove?b.add=null:this.pendingUpdates.delete(a),
b.state===t.LOADING&&b.abortController.abort(),this.pendingAdds--):(b=this.pendingUpdatesPool.pushNew(),b.remove=c,this.pendingUpdates.set(a,b),this.pendingRemoves++)}0===this.pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("running");this.notifyChange("updatingRemaining")};g._finishPendingUpdates=function(){this.pendingUpdatesPool.clear();this._cleanupSymbols();(this.pendingAdds||this.pendingRemoves)&&u.warn("pendingAdds/Removes in inconsistent state!");this.pendingRemoves=this.pendingAdds=
0};g._applyPendingUpdates=function(a){var b;this.symbolWarningLogged=this.geometryWarningLogged=!1;if(0===this.pendingUpdates.size&&null!=(b=this._spatialIndex)&&b.updating)this._spatialIndex.update();else{for(const [c,d]of this.pendingUpdates){if(a.done)break;d.add&&d.state===t.NEW&&this._processPendingUpdateNew(d);b=this.effectiveUpdatePolicy;!d.remove||d.add&&d.state!==t.READY||(this.pendingRemoves--,a.madeProgress(),this._removeGraphic(d.remove),d.remove=null,b=v.UpdatePolicy.SYNC);if(d.add)switch(d.state){case t.READY:this._addGraphic(d.add,
d.renderingInfo,b);d.add=null;this.pendingAdds--;a.madeProgress();break;case t.REJECTED:d.add=null,this.pendingAdds--}null==d.remove&&null==d.add&&this.pendingUpdates.delete(c)}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}};g._processPendingUpdateNew=function(a){if(a.add){var b=a.add.geometry;e.isSome(b)&&"mesh"===b.type&&!b.loaded?this._processPendingUpdateNewMesh(a,b):this._processPendingUpdateNewRenderingInfo(a)}else a.state=t.READY};g._processPendingUpdateNewMesh=
function(){var a=y._asyncToGenerator(function*(b,c){b.state=t.LOADING;b.abortController=new AbortController;const d=b.abortController.signal;try{yield c.load({signal:d})}catch(f){return this._processPendingUpdateNewError(b,f)}b.abortController=null;this._processPendingUpdateNewRenderingInfo(b)});return function(b,c){return a.apply(this,arguments)}}();g._processPendingUpdateNewError=function(a,b){a.abortController=null;B.isAbortError(b)?a.state=t.NEW:a.state=t.REJECTED};g._processPendingUpdateNewRenderingInfo=
function(){var a=y._asyncToGenerator(function*(b){if(e.isNone(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)b.renderingInfo=this._getRenderingInfo(b.add,u);else{b.state=t.LOADING;b.abortController=new AbortController;var c=null;try{c=yield this._getRenderingInfoAsync(b.add,{signal:b.abortController.signal})}catch(d){b.abortController=null;B.isAbortError(d)?b.state=t.NEW:b.state=t.REJECTED;return}e.isNone(c)||e.isNone(c.symbol)?(u&&!this.symbolWarningLogged&&(this.symbolWarningLogged=
!0,u.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),b.renderingInfo=null):b.renderingInfo=c}b.state=t.READY});return function(b){return a.apply(this,arguments)}}();g._addGraphic=function(a,b,c){this.graphicsWithoutSymbol.set(a.uid,a);if(!e.isNone(b)&&!e.isNone(b.symbol)&&O.hasGeometry(a)){var d=this.getOrCreateGraphics3DSymbol(b.symbol,b.renderer);if(!e.isNone(d)){this._expandComputedExtent(a.geometry);var f=this._beginGraphicUpdate(a),h=new na(a,b,this.layer),p=!1,n=
x=>{x===d.symbol.id&&(p=!0)};this._whenSymbolRemoved.push(n);var r=()=>{--this._loadingSymbols;if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(n);if(this.graphicsWaitingForSymbol.get(a.uid)!==f||p||d.destroyed||this.graphicSymbolSupported&&a.symbol&&a.symbol.id!==d.symbol.id)--d.referenced,this._cleanupSymbols();else{const x=this._createGraphics3DGraphic(d,h);this._spatialIndex&&e.isSome(x)&&this._spatialIndex.add(x);--d.referenced;this._endGraphicUpdate(a)}this.featureStore.events.emit("changed");
this.labeler&&this.owner.view.labeler.setDirty()}},z=x=>{--this._loadingSymbols;this.destroyed||(this._whenSymbolRemoved.removeUnordered(n),p||(B.isAbortError(x)?this.add([a]):d.destroyed||this._endGraphicUpdate(a)))};++this._loadingSymbols;c===v.UpdatePolicy.ASYNC?d.load(()=>this._frameTask.schedule(r),x=>this._frameTask.schedule(()=>z(x))):d.load(r,z)}}};g._removeGraphic=function(a){a=a.uid;const b=this.graphics3DGraphics.get(a);if(b){var c;b.graphics3DSymbol.onRemoveGraphic(b);const d=b.usedMemory,
f=b.isElevationSource;this._conditionalRemove(b,a);null==(c=this._spatialIndex)?void 0:c.remove(b);this.graphicsBySymbol.get(b.graphics3DSymbol.symbol.id).delete(a);this.graphicsWithoutSymbol.delete(a);this._removeGraphics3DGraphic(a,d,f);b.destroy();this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(a),this.graphicsWaitingForSymbol.delete(a),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))};g._hasLabelingContext=function(a){if(a instanceof
Z||a instanceof Ca){const b=this.symbolCreationContext.layer;return b.labelingInfo?b.labelingInfo.some(c=>c.symbol===a):!1}return!1};g._hasValidSymbolCreationContext=function(a){return a instanceof Z&&!this._hasLabelingContext(a)?(u.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};g._getRenderingInfo=function(a,b){const c=a.geometry;if(e.isNone(c))return b&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),
null;if(!D.canProjectWithoutEngine(c.spatialReference,this._viewSpatialReference))return b&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&e.isSome(a.symbol))return b&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?
P.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||e.isSome(this.currentRenderer))?this.owner.getRenderingInfo(a,this.currentRenderer,e.unwrap(this.arcadeOnDemand)):{symbol:a.symbol||ka.getDefaultSymbol3D(a.geometry)};return e.isNone(a)||e.isNone(a.symbol)?(b&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a};g._getRenderingInfoAsync=function(a,b){if(e.isNone(a.geometry))return u&&
!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,u.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&e.isSome(a.symbol))return u&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,u.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?P.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,e.unwrap(this.currentRenderer),
e.unwrap(this.arcadeOnDemand),b)};g._createGraphics3DSymbol=function(a,b){if(!this._hasValidSymbolCreationContext(a))return null;a=this._getConvertedSymbol(a);if(!a)return null;let c;e.isSome(b)&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=W.to3D(b.backgroundFillSymbol,{ignoreDrivers:!0}),e.isSome(b.symbol)&&"web-style"!==b.symbol.type&&"cim"!==b.symbol.type&&(c=b.symbol.symbolLayers));const d=pa.make(a,this.symbolCreationContext,c);d.load(()=>{const f=d.extentPadding;f>this.extentPadding&&
this._set("extentPadding",f);this.notifyChange("averageSymbolComplexity")},()=>{});return d};g.getOrCreateGraphics3DSymbol=function(a,b){let c=this.symbols.get(a.id);void 0===c&&(c=a instanceof Da?new qa(a,d=>this._frameTask.schedule(d),d=>this._createGraphics3DSymbol(d,b)):this._createGraphics3DSymbol(a,b),this.symbols.set(a.id,c));e.isSome(c)&&++c.referenced;return c};g.trackGraphicState=function(a){e.isNone(this.graphicStateTracking)&&(this.graphicStateTracking=new ra.GraphicStateTracking(this));
return this.graphicStateTracking.add(a)};g._addGraphics3DGraphic=function(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,a);this.numberOfGraphics++;a.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this._updateLayerVisibility()};g._removeGraphics3DGraphic=function(a,b,c=!1){this._usedMemory-=b;this.graphics3DGraphics.delete(a);this.numberOfGraphics--;c&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());
this._updateLayerVisibility()};g._createGraphics3DGraphic=function(a,b){var c,d,f;const h=b.graphic;this.graphicsWithoutSymbol.delete(h.uid);if(!this.symbols.has(a.symbol.id))return this.add([h]),null;if(this.graphics3DGraphics.has(h.uid))return null;b=a.createGraphics3DGraphic(b);if(e.isNone(b))return null;this._addGraphics3DGraphic(b);a=a.symbol.id;this.graphicsBySymbol.has(a)||this.graphicsBySymbol.set(a,new Map);this.graphicsBySymbol.get(a).set(h.uid,b);b.isDraped&&this.graphicsDrapedUids.add(h.uid);
b.centroid=null;e.isSome(h.geometry)&&"point"!==h.geometry.type&&(b.centroid=sa.computeCentroid(h.geometry,this._viewSpatialReference));this._updateUserVisibility(b);e.isSome(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(b);e.isSome(this.filterVisibility)&&this.filterVisibility.updateVisibility(b);null==(c=this.deconflictor)?void 0:c.addGraphic(b);null==(d=this.labeler)?void 0:d.addGraphic(b);null==(f=this.objectStates)?void 0:f.addGraphic(b);this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,
b);b.initialize(this.stage,this.stageLayer,this.owner);e.isSome(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(b);if(c=this.whenGraphics3DGraphicRequests[h.uid])delete this.whenGraphics3DGraphicRequests[h.uid],c.resolve(b);return b};g._abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)};g.rendererChange=function(){var a=y._asyncToGenerator(function*(b){this._abortRendererChange();
if(b!==this.currentRenderer)if(this._validateRenderer(b),e.isNone(b)&&this._currentRendererChange(null,!1),V.isSupportedRenderer3D(b))if(e.isSome(b)&&b.arcadeRequired){var c=new AbortController;this.rendererChangeAbortController=c;const {arcadeUtils:d}=yield this._ensureArcade();B.throwIfAborted(c);d.hasGeometryOperations(b)&&(yield d.enableGeometryOperations(),B.throwIfAborted(c));this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?yield this._frameTask.schedule(()=>this._currentRendererChange(b,!0),
c.signal):this._currentRendererChange(b,!0);this.rendererChangeAbortController=null}else this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?(this.rendererChangeAbortController=c=new AbortController,yield this._frameTask.schedule(()=>this._currentRendererChange(b,!1),c.signal),this.rendererChangeAbortController=null):this._currentRendererChange(b,!1);else this._currentRendererChange(b,!1)});return function(b){return a.apply(this,arguments)}}();g._ensureArcade=function(){var a=y._asyncToGenerator(function*(){e.isNone(this.arcadeOnDemand)&&
(this.arcadeOnDemand=yield ja.loadArcade());return this.arcadeOnDemand});return function(){return a.apply(this,arguments)}}();g._currentRendererChange=function(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=b;this.symbolCreationContext.arcade=e.unwrap(this.arcadeOnDemand);b=this.symbolCreationContext.renderer;if(a!==b)if(this.symbolConversionCache.clear(),e.isNone(a))this.symbolCreationContext.renderer=null,this.recreateAllGraphicsAndSymbols();else{var c=N.diff(b,a);this._updateUnchangedSymbolMappings(c,
a,b);this.symbolCreationContext.renderer=a;e.isNone(c)||("complete"===c.type?this.recreateAllGraphicsAndSymbols():"partial"===c.type&&(this._applyRendererDiff(c,a,b)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}};g._diffHasSymbolChange=function(a){for(const b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1};
g._applySymbolSetDiff=function(a,b,c){a=a||[];b=b||[];const d=[];for(const f of b){const h=this.graphicsBySymbol.get(f.id);h&&h.forEach((p,n)=>{var r=p.graphic,z=this.layer instanceof ia?this.layer:null;const x=e.unwrap(this.arcadeOnDemand);if(f!==c.defaultSymbol||c.getSymbol(P.hydrateGraphic(r,z),{arcade:x})!==c.defaultSymbol)z=p.usedMemory,a.length||c.defaultSymbol?d.push(r):this.graphicsWithoutSymbol.set(n,r),r=this.graphics3DGraphics.get(n),this._conditionalRemove(r,n),p.destroy(),h.delete(n),
this._removeGraphics3DGraphic(n,z),this._updateLayerVisibility()});this._whenSymbolRemoved.forAll(p=>p(f.id))}if(a.length||d.length)this.graphicsWithoutSymbol.forEach(f=>d.push(f)),this.graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};g._applyUniqueValueRendererDiff=function(a,b,c){const d=a.diff.defaultSymbol,f=a.diff.uniqueValueInfos;if(d||f){const h=f?f.added.map(n=>n.symbol):[],p=f?f.removed.map(n=>
n.symbol):[];if(f)for(let n=0;n<f.changed.length;n++)h.push(f.changed[n].newValue.symbol),p.push(f.changed[n].oldValue.symbol);d?(c.defaultSymbol&&p.push(c.defaultSymbol),b.defaultSymbol&&h.push(b.defaultSymbol)):c.defaultSymbol&&h.length&&p.push(b.defaultSymbol);this._applySymbolSetDiff(h,p,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1};g._calculateUnchangedSymbolMapping=function(a,b,c){if("unique-value"!==(null==b?void 0:b.type)||"unique-value"!==(null==c?void 0:
c.type)||e.isSome(a)&&"partial"!==a.type)return[];const d=h=>e.isSome(h)?h.id:null;var f=a&&a.diff;a=f&&f.defaultSymbol;if(f=f&&f.uniqueValueInfos)f=f.unchanged.map(h=>({oldId:d(h.oldValue.symbol),newId:d(h.newValue.symbol)}));else{f=[];for(const h of c.uniqueValueInfos){const p=d(h.symbol),n=b.uniqueValueInfos.find(r=>r.value===h.value);n&&p!==d(n.symbol)&&f.push({oldId:p,newId:d(n.symbol)})}}!a&&c.defaultSymbol&&f.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return f};g._updateSymbolMapping=
function(a,b){const c=e.isSome(b)&&b?"string"===typeof b?b:b.id:null;if(a&&a!==c){var d=this.graphicsBySymbol.get(a);this.graphicsBySymbol.delete(a);void 0!==d&&this.graphicsBySymbol.set(c,d);d=this.symbols.get(a);void 0!==d&&(this.symbols.delete(a),this.symbols.set(c,d),e.isSome(d)&&(a="string"===typeof b?null:b,e.isSome(a)?d.symbol=a:d.symbol.id=c))}};g._updateUnchangedSymbolMappings=function(a,b,c){a=this._calculateUnchangedSymbolMapping(a,b,c);for(const {oldId:d,newId:f}of a)this._updateSymbolMapping(d,
f)};g._applyRendererDiff=function(a,b,c){if(this._diffHasSymbolChange(a))return!1;if(b instanceof S&&c instanceof S&&this._applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(const [d]of this.graphicsBySymbol)if(c=this.symbols.get(d),e.isSome(c))switch(c.applyRendererDiff(a,b)){case X.ApplyRendererDiffResult.Recreate_Symbol:this._recreateSymbol(d);break;case X.ApplyRendererDiffResult.Recreate_Graphics:this._recreateGraphicsForSymbol(d)}return!0};g.opacityChange=function(){this.forEachGraphics3DSymbol((a,
b)=>a.globalPropertyChanged("opacity",b));this._updateStageLayerVisibility()};g._slicePlaneEnabledChange=function(a){a!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=a,this.stageLayer.isSliceable=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("slicePlaneEnabled",c)),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())};g._physicalBasedRenderingChange=function(a){a!==this.symbolCreationContext.physicalBasedRenderingEnabled&&
(this.symbolCreationContext.physicalBasedRenderingEnabled=a,this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("physicalBasedRenderingEnabled",c)||this._recreateSymbol(d)}))};g._pixelRatioChange=function(){this.forEachGraphics3DSymbol((a,b,c)=>{a.globalPropertyChanged("pixelRatio",b)||this._recreateSymbol(c)})};g._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=
ea.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})};g.setClippingExtent=function(a,b){const c=this.symbolCreationContext.clippingExtent,d=ha.create();wa.toBoundingRect(a,d,b)?this.symbolCreationContext.clippingExtent=H.fromRect(H.create(),d):this.symbolCreationContext.clippingExtent=null;return!H.equals(this.symbolCreationContext.clippingExtent,c)};g.modifyGraphics3DGraphicVisibilities=function(a){let b=!1;this.graphics3DGraphics.forEach(c=>{a(c)&&(b=!0)});b&&(this.labeler&&this.owner.view.labeler.setDirty(),
this.owner.view.deconflictor.setDirty())};g.forEachGraphics3DSymbol=function(a){for(const [b,c]of this.symbols){if(e.isNone(c))break;const d=this.graphicsBySymbol.get(b);a(c,d||Fa,b)}};g.updateAllGraphicsVisibility=function(){e.isSome(this.filterVisibility)&&(this.filterVisibility.dirty=!0);this.modifyGraphics3DGraphicVisibilities(a=>{const b=this._updateUserVisibility(a);a=e.isSome(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(a);return b||a})};g._hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(a=>
a.setVisibilityFlag(J.VisibilityFlag.USER_SETTING,!1,J.VisibilityGroup.GRAPHIC))};g._validateRenderer=function(a){(a=V.validateTo3D(a))&&u.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`,a.message)};g._volatileGraphicsUpdated=function(){var a;null==(a=this.labeler)?void 0:a.reset();this.stageLayer.shaderTransformationChanged();this.notifyChange("updating")};g._cleanupSymbols=function(){if(!(0<this.graphicsWaitingForSymbol.size||
this.suspendSymbolCleanup)){var a=!1;this.symbols.forEach((b,c)=>{if(!(e.isNone(b)||0<b.referenced)){var d=this.graphicsBySymbol.get(c);d&&0!==d.size||(this.graphicsBySymbol.delete(c),this.symbols.delete(c),e.destroyMaybe(b),a=!0)}});a&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}};y._createClass(M,[{key:"spatialIndex",get:function(){if(!this._spatialIndex){var a;this._spatialIndex=new ua.SpatialIndex2D({objectIdField:null==(a=this.owner.layer)?void 0:a.objectIdField,
spatialReference:this._viewSpatialReference,hasZ:this.hasZ,hasM:this.hasM});this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))}this._spatialIndex.update();return this._spatialIndex}},{key:"effectiveUpdatePolicy",get:function(){return e.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?v.UpdatePolicy.ASYNC:e.unwrapOr(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"updating",get:function(){var a;return!!(0<this.graphicsWaitingForSymbol.size||this.running||
null!=(a=this.elevationAlignment)&&a.updating||e.isSome(this.scaleVisibility)&&this.scaleVisibility.updating||e.isSome(this.filterVisibility)&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||0<this._loadingSymbols)}},{key:"running",get:function(){var a;return 0<this.pendingUpdates.size||!(null==(a=this._spatialIndex)||!a.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var a;
return this.owner.suspended||(null==(a=this.owner.suspendInfo)?void 0:a.outsideOfView)}},{key:"updatingRemaining",get:function(){var a,b;return this.updating?this.pendingUpdates.size+.1*((null==(a=this._spatialIndex)?void 0:a.updatingRemaining)||0)+.1*((null==(b=this.elevationAlignment)?void 0:b.updatingRemaining)||0):0}},{key:"displayFeatureLimit",get:function(){var a=this.owner&&this.owner.view&&this.owner.view.qualitySettings;const b=a?a.graphics3D.minTotalNumberOfFeatures:0,c=a?a.graphics3D.maxTotalNumberOfFeatures:
0;a=a?a.graphics3D.maxTotalNumberOfPrimitives:0;const d=this.averageSymbolComplexity;var f=Math.max(1,e.isSome(d)?d.primitivesPerFeature:1),h=e.isSome(d)&&0<d.drawCallsPerFeature?c/d.drawCallsPerFeature*.3:c;f=Math.max(b,Math.min(c,Math.ceil(a/f),h));return(h=this._get("displayFeatureLimit"))&&h.minimumTotalNumberOfFeatures===b&&h.maximumTotalNumberOfFeatures===c&&h.maximumTotalNumberOfPrimitives===a&&h.averageSymbolComplexity===d&&h.maximumNumberOfFeatures===f?h:{minimumTotalNumberOfFeatures:b,maximumTotalNumberOfFeatures:c,
maximumTotalNumberOfPrimitives:a,averageSymbolComplexity:d,maximumNumberOfFeatures:f}}},{key:"averageSymbolComplexity",get:function(){const a=Y.averageSymbolComplexities(this.symbolComplexities),b=this._get("averageSymbolComplexity");return 0===a.numComplexities||e.isSome(b)&&(a.estimated&&(b.primitivesPerFeature>=a.primitivesPerFeature||b.primitivesPerCoordinate>=a.primitivesPerCoordinate||b.drawCallsPerFeature>=a.drawCallsPerFeature)||b.primitivesPerFeature===a.primitivesPerFeature&&b.primitivesPerCoordinate===
a.primitivesPerCoordinate&&b.drawCallsPerFeature===a.drawCallsPerFeature)?b:a}},{key:"usedMemory",get:function(){const a=e.isSome(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+a}},{key:"usedMemoryPerGraphic",get:function(){return this._usedMemory&&this.numberOfGraphics?30<Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics?0:this._usedMemory/this.numberOfGraphics:e.isSome(this.averageSymbolComplexity)?
this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},{key:"graphics3DGraphicsByObjectID",get:function(){const a=this.owner.layer&&
this.owner.layer.objectIdField;if(!a)return null;const b=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,a);e.isSome(d)&&b.set(d,c)}});return b}},{key:"labelsEnabled",get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}},{key:"symbolUpdateType",get:function(){if(0<this.pendingUpdates.size)return"unknown";let a=0,b=0;return T.someMap(this.symbols,(c,d)=>{if(e.isSome(c)){c=c.getFastUpdateStatus();if(0<c.loading)return!0;this.graphicsBySymbol.has(d)&&
(b+=c.fast,a+=c.slow)}return!1})?"unknown":0<=b&&0===a?"fast":0<=a&&0===b?"slow":"mixed"}},{key:"test",get:function(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map(a=>({symbolId:a,graphics:[...this.graphicsBySymbol.get(a).keys()].sort()})),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),
pendingUpdates:this.pendingUpdates}),symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:a=>{this.forcedUpdatePolicy=a}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}}]);return M}(aa);k.Graphics3DCore.tmpVec=I.create();l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"computedExtent",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"currentRenderer",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_frameTask",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererChangeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"elevationInfoChangeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"setupAbortController",void 0);
l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"elevationAlignment",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"scaleVisibility",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"filterVisibility",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_spatialIndex",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"extentPadding",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,
"_updatingPendingLoadedGraphicsChange",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"featureStore",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"deconflictor",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"labeler",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"objectStates",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_loadingSymbols",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"forcedUpdatePolicy",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"effectiveUpdatePolicy",null);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"owner",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,
"layer",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"running",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"suspendedOrOutsideOfView",
null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"updatingRemaining",null);l.__decorate([m.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],k.Graphics3DCore.prototype,"displayFeatureLimit",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"averageSymbolComplexity",null);l.__decorate([m.property({constructOnly:!0})],
k.Graphics3DCore.prototype,"hasZ",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasM",void 0);k.Graphics3DCore=Q=l.__decorate([fa.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],k.Graphics3DCore);var t;(function(w){w[w.NEW=0]="NEW";w[w.LOADING=1]="LOADING";w[w.READY=2]="READY";w[w.REJECTED=3]="REJECTED"})(t||(t={}));let Ea=function(){function w(){this.renderingInfo=this.add=null;this.state=t.NEW;this.remove=null}w.prototype.clear=function(){this.renderingInfo=
this.add=null;this.state=t.NEW;this.remove=this.abortController=null};return w}();const C=I.create(),E=I.create(),Fa=new Map;Object.defineProperties(k,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});