// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../geometry ../../../../core/Error ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/mat4f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../renderers/support/renderingInfoUtils ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./interfaces ./lineUtils ../support/FastSymbolUpdates ../support/markerUtils ../../support/debugFlags ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/LineMarkerMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../../geometry/Extent ../../../../geometry/Polygon".split(" "),
function(K,E,F,M,e,x,G,N,H,l,O,P,u,Q,R,S,A,I,v,L,T,J,U,V,W,X,B,Y,Z){const aa=["polyline","polygon","extent"];F=function(r){function y(a,b,d,c){a=r.call(this,a,b,d,c)||this;a._uniformSize=1;return a}E._inheritsLoose(y,r);var f=y.prototype;f.doLoad=function(){var a=E._asyncToGenerator(function*(){this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=
this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?L.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};if(!this._drivenProperties.size){const b=null!=this.symbolLayer.size?this.symbolLayer.size:x.px2pt(1);if(0>b)throw new M("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=b}this._markerTexture=T.prepareMarkerResources(this._context.sharedResources.textures,
this.symbolLayer.marker)});return function(){return a.apply(this,arguments)}}();f._getMaterialParameters=function(a,b=!1){var d;const c=this._getCombinedOpacityAndColor(b&&this._markerColor||this._materialColor);this._patternHidesLine&&!b&&(c[3]=0);a={width:this._computeMaterialWidth(null==(d=this.symbolLayer)?void 0:d.size),color:c,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:v.parseCapType(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:a,stipplePattern:X.getStipplePatternForLinePattern(this.symbolLayer.pattern),
stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...a,...this._fastUpdates.materialParameters}:a};f.destroy=function(){r.prototype.destroy.call(this);this._forEachMaterial(a=>this._context.stage.remove(a));this._markerMaterial=this._wireframeRingMaterial=this._wireframeLineMaterial=this._ringMaterial=this._lineMaterial=null;this._markerTexture=e.releaseMaybe(this._markerTexture)};f._getDrivenSize=function(a){return this._drivenProperties.size&&a.size?x.pt2px(O.getDriverAxisSizeValueAny(a.size)):
1};f._getSizeFeatureAttributeData=function(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?A.getAttributeValue(this._fastUpdates.visualVariables.size.field,a):null};f._getDrivenColor=function(a){const b=H.fromValues(1,1,1,1);this._drivenProperties.color&&a.color&&(b[0]=a.color[0],b[1]=a.color[1],b[2]=a.color[2],0<a.color.length&&(b[3]=a.color[3]));this._drivenProperties.opacity&&a.opacity&&(b[3]=a.opacity);return b};f._getColorFeatureAttributeData=function(a){return this._fastUpdates.enabled&&
this._fastUpdates.visualVariables.color?A.getAttributeValue(this._fastUpdates.visualVariables.color.field,a):null};f._getOpacityFeatureAttributeData=function(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?A.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,a):null};f.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,aa,this.symbolLayer.type))return null;const d=this.setGraphicElevationContext(b,new Q.ElevationContext);
this.ensureDrapedStatus("on-the-ground"===d.mode);return this.draped?this._createAsOverlay(a,this._context.layer.uid):this._createAs3DShape(a,d,b.uid)};f.applyRendererDiff=function(a,b){for(const d in a.diff)switch(d){case "visualVariables":if(L.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._forEachMaterial(c=>c.setParameters(this._fastUpdates.materialParameters));else return I.ApplyRendererDiffResult.Recreate_Symbol;break;default:return I.ApplyRendererDiffResult.Recreate_Symbol}return I.ApplyRendererDiffResult.Fast_Update};
f.prepareSymbolLayerPatch=function(a){var b,d;if("partial"===a.diff.type){var c=a.diff.diff,g={};"complete"===(null==(b=c.size)?void 0:b.type)&&(g.width=this._computeMaterialWidth(c.size.newValue),delete c.size);"complete"===(null==(d=c.cap)?void 0:d.type)&&(g.cap=v.parseCapType(e.unwrapOr(c.cap.newValue,"butt")),delete c.cap);b=this._prepareMarkerPatch(a,c);this._prepareMaterialPatch(a,c,b);a.symbolLayerStatePatches.push(()=>this._forEachMaterial(h=>h.setParameters(g)))}};f.layerOpacityChanged=function(){this._forEachMaterial((a,
b)=>this._updateMaterialLayerOpacity(a,b));return!0};f._forEachMaterial=function(a){e.isSome(this._lineMaterial)&&a(this._lineMaterial);e.isSome(this._ringMaterial)&&a(this._ringMaterial);e.isSome(this._wireframeLineMaterial)&&a(this._wireframeLineMaterial);e.isSome(this._wireframeRingMaterial)&&a(this._wireframeRingMaterial);e.isSome(this._markerMaterial)&&a(this._markerMaterial,!0)};f._updateMaterialLayerOpacity=function(a,b=!1){var d=a.parameters.color;const c=e.get(this.symbolLayer,"material",
"color");b=this._patternHidesLine&&!b?0:this._getCombinedOpacity(c);d=H.fromValues(d[0],d[1],d[2],b);a.setParameters({color:d})};f.layerElevationInfoChanged=function(a,b,d){const c=this._elevationContext.mode;d=u.elevationModeChangeUpdateType(y.elevationModeChangeTypes,d,c);if(d!==u.SymbolUpdateType.UPDATE)return d;const g=u.needsElevationUpdates2D(c);return this.updateGraphics3DGraphicElevationInfo(a,b,()=>g)};f.slicePlaneEnabledChanged=function(){const a={hasSlicePlane:this._context.slicePlaneEnabled};
this._forEachMaterial(b=>b.setParameters(a));return!0};f.physicalBasedRenderingChanged=function(){return!0};f.pixelRatioChanged=function(){return!0};f._getGeometryAsPolygonOrPolyline=function(a){switch(a.type){case "extent":if(a instanceof Y)return Z.fromExtent(a);break;case "polygon":case "polyline":return a}return null};f._createAs3DShape=function(a,b,d){const c=this._getGeometryAsPolygonOrPolyline(a.graphic.geometry);var g="polygon"===c.type?c.rings:c.paths,h=[];const t=[],m=[],w=l.create(),k=
v.geometryToRenderInfo(c,this._context.elevationProvider,this._context.renderCoordsHelper,b);this._logGeometryCreationWarnings(k,g,"polygon"===c.type?"rings":"paths","LineSymbol3DLayer");for(g=0;g<k.lines.length;g++){const {position:C,mapPosition:n}=k.lines[g];if(e.isSome(this._context.clippingExtent)&&(l.empty(w),l.expandWithBuffer(w,n),!l.intersectsClippingArea(w,this._context.clippingExtent)))continue;const p=this._createGeometry(a,C,n,c.type,z.ELEVATED);h.push(p);t.push("polygon"===c.type?this.ringMaterial:
this.lineMaterial);m.push(G.IDENTITY);J.LINE_WIREFRAMES&&(h.push(p.cloneShallow()),t.push("polygon"===c.type?this.wireframeRingMaterial:this.wireframeLineMaterial),m.push(G.IDENTITY));const D=this.markerMaterial;e.isSome(D)&&(h.push(p.cloneShallow()),t.push(D),m.push(G.IDENTITY))}if(0===h.length)return null;a=new U.Object3D({geometries:h,materials:t,transformations:m,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:d}});h=new S.Graphics3DObject3DGraphicLayer(this,a,h,null,null,
P.sharedGeometryElevationAligner,b);h.alignedSampledElevation=k.sampledElevation;h.needsElevationUpdates=u.needsElevationUpdates2D(b.mode);return h};f._createGeometry=function(a,b,d,c,g){const h=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color;return v.createGeometry({overlayInfo:g===z.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:"polygon"===c?v.RemoveDuplicateStartEnd.REMOVE:v.RemoveDuplicateStartEnd.KEEP,
uniformSize:this._uniformSize,attributeData:{position:b,mapPosition:d,size:this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?null:this._getDrivenSize(a.renderingInfo),color:h?null:this._getDrivenColor(a.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(a.graphic),colorFeature:this._getColorFeatureAttributeData(a.graphic),opacityFeature:this._getOpacityFeatureAttributeData(a.graphic)}})};f._createAsOverlay=function(a,b){const d=a.graphic,c=this._getGeometryAsPolygonOrPolyline(d.geometry);
var g="polygon"===c.type?c.rings:c.paths;const h="polygon"===c.type?this.ringMaterial:this.lineMaterial;h.renderPriority=this._renderPriority;const t=J.LINE_WIREFRAMES?"polygon"===c.type?this.wireframeRingMaterial:this.wireframeLineMaterial:null,m=this.markerMaterial;e.isSome(t)&&(t.renderPriority=this._renderPriority-.001);e.isSome(m)&&(m.renderPriority=this._renderPriority-.002);const w=[],k=l.create(),C=l.empty();var n=v.geometryToRenderInfoDraped(c,this._context.overlaySR);this._logGeometryCreationWarnings(n,
g,"polygon"===c.type?"rings":"paths","LineSymbol3DLayer");for(const p of n.lines){l.empty(k);l.expandWithBuffer(k,p.position);if(!l.intersectsClippingArea(k,this._context.clippingExtent))continue;l.expandWithAABB(C,k);const D=this._createGeometry(a,p.position,null,c.type,z.DRAPED);g=q=>{q=new V.RenderGeometry(D,q,{layerUid:b,graphicUid:d.uid});w.push(q);return q};if(e.isSome(m)){n=g(m);const q=e.unwrap(this.symbolLayer.marker).placement;"begin"!==q&&"begin-end"!==q||l.expandWithBuffer(k,p.position,
0,1);"end"!==q&&"begin-end"!==q||l.expandWithBuffer(k,p.position,p.position.length-3,1);this._updateBoundingSphere(n,k)}n=g(h);this._updateBoundingSphere(n,k);J.LINE_WIREFRAMES&&(g=g(t),this._updateBoundingSphere(g,k))}return new R(this,w,C,this._context.drapeSourceRenderer)};f._updateBoundingSphere=function(a,b){N.set(a.boundingSphere,.5*(b[0]+b[3]),.5*(b[1]+b[4]),0,.5*Math.sqrt((b[3]-b[0])*(b[3]-b[0])+(b[4]-b[1])*(b[4]-b[1])))};f._computeMaterialWidth=function(a){a=e.unwrapOr(a,x.px2pt(1));return this._drivenProperties.size?
this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?x.pt2px(1):1:x.pt2px(a)};f._prepareMaterialPatch=function(a,b,d){var c=b.material;e.isNone(c)?d.changed&&d.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterial,a):"collection"!==c.type&&(c="complete"===c.type?e.applySome(c.newValue,g=>g.color):"complete"===c.diff.color.type?c.diff.color.newValue:null,c=this._getCombinedOpacityAndColor(c),d.useMaterialColor&&this._patchMaterialColor(H.clone(c),
this._markerMaterial,a),this._patternHidesLine&&(c[3]=0),this._patchMaterialColor(c,this._lineMaterial,a),delete b.material)};f._prepareMarkerPatch=function(a,b){var d=b.marker;if(e.isNone(d)||"partial"!==d.type||e.isSome(d.diff.style)||e.isSome(d.diff.placement)||e.isSome(d.diff.color)&&"complete"!==d.diff.color.type)return{changed:!1,useMaterialColor:e.isNone(this._markerColor)};d=d.diff.color;if(e.isNone(d))return delete b.marker,{changed:!1,useMaterialColor:e.isNone(this._markerColor)};d=e.unwrap(d.newValue);
if(e.isNone(d))return delete b.marker,{changed:!0,useMaterialColor:!0};this._patchMaterialColor(this._getCombinedOpacityAndColor(d),this._markerMaterial,a);delete b.marker;return{changed:!0,useMaterialColor:!1}};f._patchMaterialColor=function(a,b,d){e.isNone(b)||d.symbolLayerStatePatches.push(()=>b.setParameters({color:a}))};E._createClass(y,[{key:"_materialColor",get:function(){return e.applySome(this.symbolLayer.material,a=>a.color)}},{key:"_markerColor",get:function(){return e.applySome(this.symbolLayer.marker,
a=>a.color)}},{key:"lineMaterial",get:function(){e.isNone(this._lineMaterial)&&(this._lineMaterial=new B.RibbonLineMaterial(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial));return this._lineMaterial}},{key:"ringMaterial",get:function(){e.isNone(this._ringMaterial)&&(this._ringMaterial=new B.RibbonLineMaterial(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial));return this._ringMaterial}},{key:"wireframeLineMaterial",get:function(){e.isNone(this._wireframeLineMaterial)&&
(this._wireframeLineMaterial=new B.RibbonLineMaterial({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterial));return this._wireframeLineMaterial}},{key:"wireframeRingMaterial",get:function(){e.isNone(this._wireframeRingMaterial)&&(this._wireframeRingMaterial=new B.RibbonLineMaterial({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterial));return this._wireframeRingMaterial}},{key:"markerMaterial",get:function(){e.isNone(this._markerMaterial)&&
e.isSome(this.symbolLayer.marker)&&e.isSome(this._markerTexture)&&(this._markerMaterial=new W.LineMarkerMaterial({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterial));return this._markerMaterial}},{key:"_patternHidesLine",get:function(){const a=this.symbolLayer.pattern;return e.isSome(a)&&"style"===a.type&&"none"===a.style}}]);return y}(A.Graphics3DSymbolLayer);F.elevationModeChangeTypes=
{definedChanged:u.SymbolUpdateType.RECREATE,staysOnTheGround:u.SymbolUpdateType.NONE,onTheGroundChanged:u.SymbolUpdateType.RECREATE};var z;(function(r){r[r.DRAPED=0]="DRAPED";r[r.ELEVATED=1]="ELEVATED"})(z||(z={}));K.Graphics3DLineSymbolLayer=F;Object.defineProperties(K,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});