// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ../../../../core/PooledArray ../../../../core/screenUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/ray ../../../../geometry/support/vectorStacks ../../../ViewingMode ../../support/geometryUtils/ray ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtils".split(" "),function(D,l,I,A,u,J,x,K,v,L,F,z,r,E){function G(m){B&&
B.viewingMode===m||(B=z.newIntersector(m));return B}let O=function(){function m(a,b,c){this.viewingMode=a;this._forEachLayer=b;this.view=c;this.externalIntersectionHandlers=new I;this.tolerance=z.DEFAULT_TOLERANCE;this.tmpRay=K.create();this.tmpRegion=x.create();this.validateHUDIntersector=z.newIntersector(this.viewingMode);this.validateHUDIntersector.options.hud=!1}var g=m.prototype;g.intersectScreen=function(a,b,c){return this.intersectRay(this._getPickRay(a,this.tmpRay),G(this.viewingMode),b,c)};
g.intersectScreenFreePointFallback=function(a,b,c){return this.intersectRayFreePointFallback(this._getPickRay(a,this.tmpRay),b,c)};g.intersectRayFreePointFallback=function(a,b,c){return this.intersectRay(a,G(this.viewingMode),b,c)||this._intersectRayFreePointLocal(a,b)};g.intersectRay=function(a,b,c,e){b.options.selectionMode=!1;b.options.store=r.StoreResults.MIN;this.computeIntersection(a,b,e);return b.results.min?b.results.min.getIntersectionPoint(c):!1};g.getCenterRayWithSubpixelOffset=function(a,
b,c=.5,e=.5){a.getRenderCenter(y,c,e);y[0]+=.0466;y[1]-=.0123;return F.fromRenderAtEye(a,y,b)};g.intersectIntersectorScreen=function(a,b,c){this.computeIntersection(this._getPickRay(a,this.tmpRay),b,c)};g.intersectToolIntersectorScreen=function(a,b,c){a=this._getPickRay(a,this.tmpRay);this.intersectToolIntersectorRay(a,b,c)};g.intersectToolIntersectorRay=function(a,b,c){b.options.selectionMode=!0;this.computeIntersection(a,b,c);const e=b.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.opaque||
E.isValidIntersectorResult(e)&&e.intersector!==r.IntersectorType.TERRAIN||(b.options.selectionMode=!1,this.computeIntersection(a,b,c))};g.setTolerance=function(a=z.DEFAULT_TOLERANCE){this.tolerance=a};g.addIntersectionHandler=function(a){this.externalIntersectionHandlers.push(a);this.externalIntersectionHandlers.sort((b,c)=>b.type===r.IntersectorType.TERRAIN?1:c.type===r.IntersectorType.TERRAIN?-1:0)};g.removeIntersectionHandler=function(a){null!=this.externalIntersectionHandlers.removeUnordered(a)&&
this.externalIntersectionHandlers.sort((b,c)=>b.type===r.IntersectorType.TERRAIN?1:c.type===r.IntersectorType.TERRAIN?-1:0)};g._getPickRay=function(a,b){return F.fromScreen(this.view.state.camera,a,b)};g._intersectRayFreePointLocal=function(a,b){if(this.viewingMode!==L.ViewingMode.Local||l.isNone(a))return!1;var c=this.view.renderDataExtent;if(l.isNone(c))return u.add(b,a.origin,u.normalize(v.sv3d.get(),a.direction)),!0;var e=Math.max(c.xmax-c.xmin,c.ymax-c.ymin,8*Math.max(c.xmax-c.xmin,c.ymax-c.ymin));
if(0===e)return u.add(b,a.origin,u.normalize(v.sv3d.get(),a.direction)),!0;var d=this.view.state.camera;const k=Math.max(0,c.xmin-d.eye[0],d.eye[0]-c.xmax);c=Math.max(0,c.ymin-d.eye[1],d.eye[1]-c.ymax);d=e/Math.max(1,Math.max(0,Math.log(e/(Math.abs(d.relativeElevation)+Number.MIN_VALUE)))**2);d=Math.max(d,Math.min(Math.sqrt(k*k+c*c),e));e=u.scale(v.sv3d.get(),a.direction,d/u.length(a.direction));u.add(b,a.origin,e);return!0};g.intersectElevationFromScreen=function(a,b,c=0,e=null){return this._intersectElevation(this._getPickRay(a,
this.tmpRay),b,c,e)};g._intersectElevation=function(a,b,c=0,e=null){if(l.isNone(a))return null;var d=l.isSome(b)?b.mode:"absolute-height",k=l.isSome(b)?l.unwrapOr(b.offset,0):0,n="on-the-ground"!==d?k+c:0;b=n/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===d)return this.view.renderCoordsHelper.intersectInfiniteManifold(a,n,C)?(c=this.view.computeMapPointFromVec3d(C),c.z-=k,c):null;k=this.view.state.camera;const q=A.castRenderScreenPointArray3(v.sv3d.get());k.projectToRenderScreen(a.origin,
q);n=new H(null,this._forEachLayer);const t=this.view.slicePlane,w=l.isSome(t)?E.sliceFilterPredicate(t):null,h=z.newIntersector(this.viewingMode);h.options.store=r.StoreResults.MIN;h.options.verticalOffset=b;b=a.origin;a=u.add(v.sv3d.get(),b,a.direction);h.reset(b,a,k);h.point=q;const p=l.isSome(e)?"type"in e&&"graphics"===e.type?f=>f.metadata.layerUid!==e.uid:f=>f.metadata.graphicUid!==e.uid:null;switch(d){case "relative-to-scene":h.intersect(n.layers,q,this.tolerance,null,f=>(l.isNone(p)||p(f))&&
f.metadata&&f.metadata.isElevationSource);this.externalIntersectionHandlers.forAll(f=>{f.type!==r.IntersectorType.I3S&&f.type!==r.IntersectorType.TERRAIN||f.intersect(h,f.slicePlaneEnabled?w:null,h.rayBegin,h.rayEnd,q)});break;case "on-the-ground":case "relative-to-ground":this.externalIntersectionHandlers.forAll(f=>{f.isGround&&f.intersect(h,f.slicePlaneEnabled?w:null,h.rayBegin,h.rayEnd,q)})}return h.results.min.getIntersectionPoint(C)?(d=this.view.computeMapPointFromVec3d(C),d.z=c,d):null};g.computeIntersection=
function(a,b,c){if(!l.isNone(a)){var e=this.view.state.camera,d=A.castRenderScreenPointArray3(v.sv3d.get());e.projectToRenderScreen(a.origin,d);var k=new H(c,this._forEachLayer);b.options.selectOpaqueTerrainOnly=!c||!("include"in c||"exclude"in c);var n=a.origin,q=u.add(v.sv3d.get(),a.origin,a.direction);b.reset(n,q,e);b.intersect(k.layers,d,this.tolerance);a=this.view.slicePlane;var t=l.isSome(a)?E.sliceFilterPredicate(a):null;b.intersect(k.sliceableLayers,d,this.tolerance,t);var w=c&&(c.requiresGroundFeedback||
c.enableDraped);this.externalIntersectionHandlers.forAll(h=>{b.options.isFiltered=!k.filterLayerUid(h.layerUid);(h.isGround&&w||!b.options.isFiltered)&&h.intersect(b,h.slicePlaneEnabled?t:null,n,q,d)});a=v.sv3d.get();if(c&&c.enableDraped&&b.results.ground.getIntersectionPoint(a)){c=this.view.basemapTerrain;e=c.overlayManager.renderer;const h=this.view.renderCoordsHelper.spatialReference,p=v.sv3d.get();this.view.renderCoordsHelper.fromRenderCoords(a,p,c.spatialReference);p[2]=l.unwrapOr(this.view.elevationProvider.getElevation(a[0],
a[1],a[2],h,"ground"),0);e.intersect(b,p,b.results.ground,f=>k.filterRenderGeometry(f))}b.sortResults();this._processHUDResults(b)}};g._processHUDResults=function(a){var b=a.results.hud;x.copy(this.tmpRegion,x.NEGATIVE_INFINITY);const c=this.view.state.camera,e=[],d=this.tmpRegion;var k=p=>{const f=new M(p);c.projectToRenderScreen(p.target.center,f.screenPoint);f.screenPoint[0]=Math.floor(f.screenPoint[0]);f.screenPoint[1]=Math.floor(f.screenPoint[1]);e.push(f);x.expandPointInPlace(d,f.screenPoint)};
a.sortResults(b.all);l.isSome(b.min.dist)&&k(b.min);for(var n of b.all)b.min.target.object!==n.target.object&&b.max.target.object!==n.target.object&&k(n);l.isSome(b.max.dist)&&b.max.target.object!==b.min.target.object&&k(b.max);if(e.length){d[0]===d[2]&&(d[2]+=1);d[1]===d[3]&&(d[3]+=1);b=c.fullWidth;k=c.fullHeight;var q=Math.max(0,d[0]-1),t=Math.max(0,d[1]-1);n=Math.min(x.width(d)+2,b-q);var w=Math.min(x.height(d)+2,k-t),h=new Uint8Array(n*w*4);this.view._stage.renderView.readHUDVisibility(q,t,n,
w,h);q=!0;t=l.isNone(a.results.max.dist);w=0;for(const p of e)for(const f of N)if(h[4*(Math.min(p.screenPoint[0]+f[0],b)-d[0]+(Math.min(p.screenPoint[1]+f[1],k)-d[1])*n)]){q&&(a.results.min.copy(p.result),q=!1);t&&a.results.max.copy(p.result);a.options.store===r.StoreResults.ALL&&a.results.all.splice(w++,0,p.result);break}}};return m}();const N=(()=>{const m=[];for(let g=-1;1>=g;g++)for(let a=-1;1>=a;a++)m.push([a+1,g+1]);return m})();let M=function(m){this.result=m;this.screenPoint=A.createRenderScreenPointArray3()},
B,H=function(){function m(a,b){this.layers=[];this.sliceableLayers=[];this.include=null==a?void 0:a.include;this.exclude=null==a?void 0:a.exclude;b(c=>{c.isPickable&&this.filterLayerUid(c.apiLayerUid)&&(c.isSliceable?this.sliceableLayers:this.layers).push(c)})}var g=m.prototype;g.filterLayerUid=function(a){const {include:b,exclude:c}=this;return l.isNone(a)?null==b&&null==c:(null==b||b.has(a))&&(null==c||!c.has(a))};g.filterRenderGeometry=function(a){return this.filterLayerUid(a.layerUid)};return m}();
const C=J.create(),y=A.createRenderScreenPointArray3();D.SceneIntersectionHelper=O;D.isIntersectionHandler=function(m){return"object"===typeof m&&"intersect"in m};Object.defineProperties(D,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});