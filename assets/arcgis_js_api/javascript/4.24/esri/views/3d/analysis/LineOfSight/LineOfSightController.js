// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../analysis/featureReferenceUtils ../../../../core/Accessor ../../../../core/Evented ../../../../core/Handles ../../../../core/handleUtils ../../../../core/lang ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../core/support/WatchUpdatingTracking ../../../../geometry/projection ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/ray ../../../../support/elevationInfoUtils ../LineOfSightAnalysisResult ./LineOfSightComputation ./LineOfSightRayIntersector ../support/projectionUtils ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtilsConversions ../../../support/Scheduler ../../../../geometry/Point".split(" "),
function(q,J,r,ha,K,W,X,M,B,Y,Z,d,N,v,u,ia,aa,k,z,ba,C,F,L,O,ca,da,ea,P,Q,D,A,fa){const R=Z.getLogger("esri.views.3d.analysis.LineOfSight.LineOfSightController");q.LineOfSightController=function(S){function G(a){a=S.call(this,a)||this;a.updateOnCameraChange=!0;a._effectiveObserverElevationMode="absolute-height";a._observerFeatureId=null;a._updatingHandles=new ba.WatchUpdatingTracking;a._frameTask=A.ImmediateTask;a._handles=new M;a._computationHandles=new M;a._externalObserverUpdate=!0;return a}J._inheritsLoose(G,
S);var m=G.prototype;m.initialize=function(){var a;const b=null==(a=this.view.resourceController)?void 0:a.scheduler;this._frameTask=b?b.registerTask(A.TaskPriority.LINE_OF_SIGHT_TOOL):A.ImmediateTask;this._intersector=new ea.LineOfSightRayIntersector({view:this.view});this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])};m.destroy=function(){this._handles.destroy();this._computationHandles.destroy();this._computations.removeAll();this._updatingHandles.destroy()};
m.getLineOfSightComputationDependencies=function(a){({inputPoints:a}=a);return{inputPoints:a}};m._computeResult=function(a){const b=a.computation,{inputPoints:c,computationResult:e}=b,{observerAdjusted:h,targetAdjusted:f}=c,{start:g,end:p}=e;k.copy(g,h);k.copy(p,f);this._canCompute(b)?this._computeIntersection(a):this._interpolateIntersection(a);b.notifyResultChanged();this.emit("result-changed",{target:a.computation.target,result:b.result})};m._updateAdjustedPointsFromFeatures=function(a){const b=
this.view;var {sceneIntersectionHelper:c}=b;({inputPoints:a}=a);const {observerAdjusted:e,observerFeatureId:h,targetFeatureId:f,targetAdjusted:g}=a;if(!d.isNone(h)||!d.isNone(f)){var p=k.distance(e,g),n=this._intersector.intersector,l=L.fromPoints(a.observer,a.target,T);n.options.store=Q.StoreResults.ALL;c.intersectToolIntersectorRay(l,n);var x=l=c=null,w=null;for(const t of n.results.all)n=D.toGraphic(t,this.view),d.isNone(n)||d.isNone(t.distanceInRenderSpace)||(n=K.getFeatureId(n),d.isNone(n)||
(d.isSome(h)&&n===h&&(d.isNone(c)&&(c=this._getFeatureDistanceThreshold(t,b,p)),t.distanceInRenderSpace<c&&(x=t)),d.isSome(f)&&n===f&&(d.isNone(l)&&(l=this._getFeatureDistanceThreshold(t,b,p)),d.isNone(w)&&t.distanceInRenderSpace<p&&p-t.distanceInRenderSpace<l&&(w=t))));d.isSome(x)&&x.getIntersectionPoint(e)&&(a.observerSurfaceNormal=x.getTransformedNormal(z.create()));d.isSome(w)&&w.getIntersectionPoint(g)&&(a.targetSurfaceNormal=w.getTransformedNormal(z.create()))}};m._getFeatureDistanceThreshold=
function(a,b,c){return D.hasLod(a)&&(a=D.getIntersectedFeatureBSRadius(a,b),d.isSome(a))?Math.min(.05*a,c):1E-5*c};m._adjustStartEndPositions=function(a){const b=this._screenPixelSize,c=this.view;var {inputPoints:e}=a;const {observer:h,observerSurfaceNormal:f,target:g,targetSurfaceNormal:p,observerAdjusted:n,targetAdjusted:l}=e;e=H;k.copy(n,h);k.copy(l,g);this._updateAdjustedPointsFromFeatures(a);d.isSome(f)?k.copy(e,f):k.subtract(e,l,n);k.normalize(e,e);k.scale(e,e,Math.min(b,1));k.add(n,n,e);d.isSome(p)?
k.copy(e,p):k.subtract(e,n,l);a=c.state.camera.computeScreenPixelSizeAt(l);k.normalize(e,e);k.scale(e,e,Math.min(a,1));k.add(l,l,e)};m._computeIntersection=function({computation:a,interpolationInfo:b}){const {view:c}=this,{sceneIntersectionHelper:e,renderCoordsHelper:h}=c;if(!d.isNone(e)){var f=this._intersector.intersector,{computationResult:g,inputPoints:p}=a,{observer:n,target:l}=p,{start:x,end:w}=g,t=L.fromPoints(x,w,T);f.options.store=Q.StoreResults.MIN;e.intersectToolIntersectorRay(t,f);f=f.results.min;
t=g.intersection;var U=H,y=!0;d.isSome(f)&&f.getIntersectionPoint(t)&&(k.copy(b.originalIntersection,t),k.copy(b.originalObserver,x),k.copy(b.originalTarget,w),h.fromRenderCoords(t,U,c.spatialReference),b=1-k.dist(w,l)/k.dist(x,l),y=k.dist(n,t)>=b*k.dist(n,l));b=new fa(U,c.spatialReference);{const {result:E,target:V}=a;d.isSome(E)?(E.target=V,E.intersectedGraphic=y?null:D.toGraphic(f,c),E.intersectedLocation=y?null:b,E.visible=y):a.result=new ca.LineOfSightAnalysisResult({target:V,elevationAlignedTargetLocation:a.elevationAlignedTargetLocation,
intersectedGraphic:y?null:D.toGraphic(f,c),intersectedLocation:y?null:b,visible:y})}g.isValid=p.isValid=!0;g.isTargetVisible=y}};m._interpolateIntersection=function({computation:a,interpolationInfo:b}){const {computationResult:c,inputPoints:e}=a,{start:h,end:f,intersection:g}=c,{originalIntersection:p,originalObserver:n,originalTarget:l}=b;k.copy(g,p);e.isValid?(a=H,b=k.dist(n,p)/k.dist(n,l),k.sub(a,h,n),k.scale(a,a,1-b),k.add(g,g,a),k.sub(a,f,l),k.scale(a,a,b),k.add(g,g,a),c.isValid=!0):(a.result=
null,c.isValid=!1,c.isTargetVisible=!1)};m._canCompute=function(a){var b=this.view.frustum;if(d.isNone(this.analysisViewData.elevationAlignedObserver)||d.isNone(a.elevationAlignedTargetLocation)||d.isNone(b))return!1;const {observerAdjusted:c,targetAdjusted:e}=a.inputPoints;a=b.intersectsPoint(c);b=b.intersectsPoint(e);return a&&b};m._onObserverPositionChange=function(a,b,c,e,h){this._externalObserverUpdate=h;if(d.isNone(a))this._observerFeatureId=this.analysisViewData.elevationAlignedObserver=null;
else if(d.isNone(b))P.logFailedGeometryProjectionError(this.analysis,a.spatialReference,R),this.analysisViewData.elevationAlignedObserver=null;else{a=this._getEffectiveElevationInfo(b,c);var {absoluteZ:f,elevation:g}=O.zValueInAbsoluteHeightMode(b.x,b.y,b.z,this.view.spatialReference,this.view,a);b=b.clone();b.z=f;this._effectiveObserverElevationMode=a.mode;this.analysisViewData.elevationAlignedObserver=b;a=z.create();this.view.renderCoordsHelper.toRenderCoords(b,a);this._elevationAlignedObserverPositionRenderSpace=
a;this._observerGroundOffsetRenderSpace=f-g;this._observerFeatureId=K.getFeatureId(e);this.priority=A.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE}};m._onObserverRenderSpacePositionChangeForComputation=function(a,b,c,e,h){const {inputPoints:f}=a;k.copy(f.observer,b);f.observerFeatureId=h;f.observerSurfaceNormal=null;switch(e){case "on-the-ground":case "relative-to-ground":b=this._intersector.updateFromGroundIntersection(f.observer,c,f.observer),d.isNone(f.observerFeatureId)&&(f.observerSurfaceNormal=
b)}this._adjustStartEndPositions(a);a.notifyInputPointsChanged();this.priority=A.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE};m._onTargetPositionChange=function(a,b,c,e,h,f=!0){const g=a.inputPoints;f&&(g.isValid=!1);if(d.isNone(c))d.isSome(b)&&P.logFailedGeometryProjectionError(this.analysis,b.spatialReference,R),a.elevationAlignedTargetLocation=null,a.notifyInputPointsChanged();else{b=this._getEffectiveElevationInfo(c,e);var {absoluteZ:p,elevation:n}=O.zValueInAbsoluteHeightMode(c.x,c.y,c.z,this.view.spatialReference,
this.view,b);c=c.clone();c.z=p;a.elevationAlignedTargetLocation=c;this.view.renderCoordsHelper.toRenderCoords(a.elevationAlignedTargetLocation,g.target);g.targetFeatureId=K.getFeatureId(h);g.targetSurfaceNormal=null;switch(b.mode){case "on-the-ground":case "relative-to-ground":h=this._intersector.updateFromGroundIntersection(g.target,p-n,g.target),d.isNone(g.targetFeatureId)&&(g.targetSurfaceNormal=h)}this._adjustStartEndPositions(a);a.notifyInputPointsChanged();this.priority=A.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE}};
m._connectComputationToTarget=function(a){return B.handlesGroup([v.watch(()=>({computation:a,targetPosition:a.target.position,targetElevationInfo:a.target.elevationInfo,targetFeatureInfo:a.target.feature,projectedTargetPosition:C.projectOrLoad(a.target.position,this.view.spatialReference)}),({computation:b,targetPosition:c,targetElevationInfo:e,targetFeatureInfo:h,projectedTargetPosition:f})=>{d.isSome(f.pending)?this._updatingHandles.addPromise(f.pending):this._onTargetPositionChange(b,c,f.geometry,
e,h)},v.syncAndInitial)])};m._connectComputationToObserver=function(a){return v.watch(()=>({computation:a,observer:this.analysisViewData.elevationAlignedObserver}),({computation:b})=>{this._externalObserverUpdate&&(b.inputPoints.isValid=!1,b.notifyInputPointsChanged())},v.syncAndInitial)};m._connectComputationToRenderSpaceObserver=function(a){return v.watch(()=>({computation:a,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,
observerFeatureId:this._observerFeatureId}),({computation:b,observer:c,observerGroundOffset:e,observerElevationMode:h,observerFeatureId:f})=>{this._onObserverRenderSpacePositionChangeForComputation(b,c,e,h,f)},v.syncAndInitial)};m._connectComputationToCamera=function(a){return v.watch(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:b})=>{!this.updateOnCameraChange||a.inputPoints.isValid&&!b||a.notifyInputPointsChanged()},v.sync)};m._connectComputationToSlicePlane=function(a){return v.watch(()=>
this.view.slicePlane,()=>{a.inputPoints.isValid=!1;a.notifyInputPointsChanged()})};m._connectComputationToElevation=function(a){const b=(c,e)=>{const h=this.analysis.observer,f=a.target;var g=null;let p=null,n=null;var l=null;let x=null,w=null;if(d.isSome(h)&&d.isSome(h.position)){g=C.projectOrLoad(h.position,this.view.spatialReference);if(d.isSome(g.pending)){this._updatingHandles.addPromise(g.pending);g.pending.finally(()=>b(c,e));return}g=g.geometry;p=h.elevationInfo;n=h.feature}if(d.isSome(f.position)){l=
C.projectOrLoad(f.position,this.view.spatialReference);if(d.isSome(l.pending)){this._updatingHandles.addPromise(l.pending);l.pending.finally(()=>b(c,e));return}l=l.geometry;x=f.elevationInfo;w=f.feature}d.isNone(g)&&d.isNone(l)||(C.projectBoundingRect(c,e,I,this.view.spatialReference),d.isSome(g)&&F.containsPointObject(I,g)&&this._onObserverPositionChange(d.isSome(h)?h.position:null,g,p,n,!1),d.isSome(l)&&F.containsPointObject(I,l)&&this._onTargetPositionChange(a,f.position,l,x,w,!1),d.isSome(g)&&
d.isSome(l)&&F.intersectsSegment(I,g,l)&&a.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",c=>b(c.extent,c.spatialReference))};m._connectComputationToTask=function(a){var b=this;let c=d.none;const e={computation:a,interpolationInfo:{originalIntersection:z.create(),originalObserver:z.create(),originalTarget:z.create()}};return B.handlesGroup([v.watch(()=>this.getLineOfSightComputationDependencies(a),()=>{c=d.abortMaybe(c);c=N.createTask(function(){var h=J._asyncToGenerator(function*(f){yield N.ignoreAbortErrors(b._frameTask.schedule(()=>
b._computeResult(e),f))});return function(f){return h.apply(this,arguments)}}())},{sync:!0,initial:!0,equals:Y.equals}),B.makeHandle(()=>c=d.abortMaybe(c))])};m._connectComputation=function(a){const b=this._computationHandles;b.has(a)||b.add([this._connectComputationToTarget(a),this._connectComputationToObserver(a),this._connectComputationToRenderSpaceObserver(a),this._connectComputationToCamera(a),this._connectComputationToSlicePlane(a),this._connectComputationToElevation(a),this._connectComputationToTask(a)],
a)};m._disconnectComputation=function(a){this._computationHandles.remove(a)};m._onComputationCollectionChange=function({added:a,removed:b}){for(const c of b)this._disconnectComputation(c);for(const c of a)this._connectComputation(c)};m._onTargetCollectionChange=function({added:a,removed:b}){for(const c of b)this._removeTarget(c);for(const c of a)this._addTarget(c)};m._onCursorTargetChange=function(a,b){d.isSome(b)&&this._removeTarget(b);d.isSome(a)&&this._addTarget(a)};m._addTarget=function(a){this._computations.some(b=>
b.target===a)||this._computations.add(new da.LineOfSightComputation({target:a}))};m._removeTarget=function(a){const b=this._computations.findIndex(c=>c.target===a);this._computations.removeAt(b)};m._connectObserver=function(){return B.handlesGroup([v.watch(()=>({observerPosition:d.isSome(this.analysis.observer)?this.analysis.observer.position:null,projectedObserverPosition:C.projectOrLoad(d.isSome(this.analysis.observer)?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:d.isSome(this.analysis.observer)?
this.analysis.observer.elevationInfo:null,observerFeatureInfo:d.isSome(this.analysis.observer)?this.analysis.observer.feature:null}),({observerPosition:a,projectedObserverPosition:b,observerElevationInfo:c,observerFeatureInfo:e})=>{d.isSome(b.pending)?this._updatingHandles.addPromise(b.pending):this._onObserverPositionChange(a,b.geometry,c,e,!0)},v.syncAndInitial)])};m._connectComputations=function(){return v.on(()=>this._computations,"change",a=>this._onComputationCollectionChange(a),{onListenerAdd:a=>
{for(const b of a)this._connectComputation(b)},onListenerRemove:a=>{for(const b of a)this._disconnectComputation(b)},sync:!0})};m._connectTargets=function(){return B.handlesGroup([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,a=>this._onTargetCollectionChange(a),{initial:!0,final:!0}),v.watch(()=>this.analysisViewData.cursorTarget,(a,b)=>{this._onCursorTargetChange(a,b)})])};m._getEffectiveElevationInfo=function(a,b){return a.hasZ?d.unwrapOr(b,{mode:"absolute-height",offset:0}):
{mode:"on-the-ground",offset:0}};J._createClass(G,[{key:"updating",get:function(){return this._frameTask.updating||this._updatingHandles.updating}},{key:"priority",get:function(){return this._frameTask.priority},set:function(a){this._frameTask.priority=a}},{key:"_computations",get:function(){return this.analysisViewData.computations}},{key:"_elevationAlignedObserverPositionRenderSpace",get:function(){return this.analysisViewData.observerEngineLocation},set:function(a){this.analysisViewData.observerEngineLocation=
a}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}},{key:"_isCameraDirty",get:function(){var a=this.analysisViewData.elevationAlignedObserver;const {view:b}=this,{renderCoordsHelper:c}=b;if(d.isNone(a)||d.isNone(c))return!1;const e=H;c.toRenderCoords(a,e);a=b.state.camera.computeScreenPixelSizeAt(e);return.1<Math.abs((a-this._screenPixelSize)/this._screenPixelSize)}}]);return G}(X.EventedMixin(W));r.__decorate([u.property({constructOnly:!0})],
q.LineOfSightController.prototype,"analysis",void 0);r.__decorate([u.property({constructOnly:!0})],q.LineOfSightController.prototype,"analysisViewData",void 0);r.__decorate([u.property({constructOnly:!0})],q.LineOfSightController.prototype,"view",void 0);r.__decorate([u.property()],q.LineOfSightController.prototype,"updating",null);r.__decorate([u.property()],q.LineOfSightController.prototype,"priority",null);r.__decorate([u.property()],q.LineOfSightController.prototype,"updateOnCameraChange",void 0);
r.__decorate([u.property()],q.LineOfSightController.prototype,"_computations",null);r.__decorate([u.property()],q.LineOfSightController.prototype,"_elevationAlignedObserverPositionRenderSpace",null);r.__decorate([u.property()],q.LineOfSightController.prototype,"_observerGroundOffsetRenderSpace",void 0);r.__decorate([u.property()],q.LineOfSightController.prototype,"_effectiveObserverElevationMode",void 0);r.__decorate([u.property()],q.LineOfSightController.prototype,"_observerFeatureId",void 0);r.__decorate([u.property()],
q.LineOfSightController.prototype,"_screenPixelSize",null);r.__decorate([u.property({readOnly:!0})],q.LineOfSightController.prototype,"_updatingHandles",void 0);r.__decorate([u.property()],q.LineOfSightController.prototype,"_frameTask",void 0);r.__decorate([u.property()],q.LineOfSightController.prototype,"_isCameraDirty",null);q.LineOfSightController=r.__decorate([aa.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightController")],q.LineOfSightController);const H=z.create(),T=L.create(),I=F.empty();
Object.defineProperties(q,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});