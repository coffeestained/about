// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../analysis/SlicePlane ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/boundedPlane ../../../../layers/Layer ../../../../layers/buildingSublayers/BuildingComponentSublayer ./sliceToolUtils ../support/projectionUtils ../../terrain/terrainUtils".split(" "),
function(f,r,k,x,y,z,A,c,l,m,H,I,J,B,C,v,D,q,E,F){function G(n,p){g.has(n)||g.set(n,{all:[],activeController:null});g.get(n).all.push(p)}const t=A.getLogger("esri.views.3d.analysis.Slice.SliceController");f.SliceController=function(n){function p(a){a=n.call(this,a)||this;a._handles=new z;a._internalChange=!1;a._currentSlicePlane=null;a.state="ready";return a}r._inheritsLoose(p,n);var h=p.prototype;h.initialize=function(){this._handles.add(this.analysis.excludedLayers.on("before-add",a=>{const b=a.item;
null!=b&&(b instanceof v||b instanceof D)?b instanceof v&&F.isTerrainSurfaceLayer(b)?(t.error("excludedLayers",`Layer '${b.title}, id:${b.id}' of type '${b.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),a.preventDefault()):this.analysis.excludedLayers.includes(b)&&a.preventDefault():(t.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),a.preventDefault())}));G(this.view,this);this._handles.add([l.watch(()=>
this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane();this._updateLayerViews()},{sync:!0}),l.watch(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),l.watch(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController();this._updateViewSlicePlane()},{sync:!0}),l.watch(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]);
this._handles.add([l.watch(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis");this._set("state","ready");this._updateActiveController();this._updateBoundedPlaneFromSlicePlane();this._updateViewSlicePlane()};h.destroy=function(){if("destroyed"!==this.state){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null);{var a=this.view;if(!g.has(a))throw Error("view expected in global slice register");
const b=g.get(a),e=b.all.lastIndexOf(this);if(-1===e)throw Error("controller expected in global slice register");b.all.splice(e,1);0===b.all.length&&g.delete(a)}this._handles.destroy();this.set("view",null);this._set("state","destroyed")}};h.whenReady=function(){var a=r._asyncToGenerator(function*(){yield l.whenOnce(()=>this.ready);return this});return function(){return a.apply(this,arguments)}}();h._updateBoundedPlaneFromSlicePlane=function(){const a=this.analysis.shape;var b=this._currentSlicePlane;
if(!(c.isNone(b)&&c.isNone(a)||c.isSome(b)&&c.isSome(a)&&a.equals(b))){var e=null;b=null;if(c.isSome(a)&&c.isSome(a.position)){e=a.position.spatialReference;const d=q.projectAndElevationAlignShape(a,this.view);c.isNone(d)&&E.logFailedGeometryProjectionError(this.analysis,e,t);e=q.projectedShapeToPlane(d,this.view,{tiltEnabled:this.analysis.tiltEnabled},C.create());c.isSome(e)&&(b={heading:a.heading,tilt:a.tilt,position:a.position,width:a.width,height:a.height})}this._currentSlicePlane=b;this._internalChange=
!0;this.analysisViewData.plane=e;this._internalChange=!1}};h._updateSlicePlaneFromBoundedPlane=function(){const a=q.planeToShape(this.analysisViewData.plane,this.view,this.view.spatialReference,new x);let b=null;c.isSome(a)&&(b={heading:a.heading,tilt:a.tilt,position:a.position,width:a.width,height:a.height});this._currentSlicePlane=b;this._internalChange=!0;this.analysis.shape=a;this._internalChange=!1;this._updateViewSlicePlane()};h._updateActiveController=function(){if(!u){var a=g.get(this.view);
this.analysisViewData.active?(c.isSome(a.activeController)&&a.activeController!==this?(u=!0,u=a.activeController.analysisViewData.active=!1):c.isSome(a.activeController),this._updateLayerViews(),a.activeController=this):c.isSome(a.activeController)&&a.activeController!==this||!c.isSome(a.activeController)||a.activeController!==this||(a.activeController=null,this._updateLayerViews())}};h._updateViewSlicePlane=function(){if("ready"===this.state){{var a=this.view;const b=g.get(a).activeController;c.isSome(b)&&
c.isSome(b.analysisViewData.plane)&&b.analysisViewData.visible?a.slicePlane=b.analysisViewData.plane:a.slicePlane=null}}};h._updateLayerViews=function(){const a=c.isSome(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,b=[],e=d=>{"layers"in d?d.layers.forEach(e):b.push(d)};this.analysis.excludedLayers.forEach(e);this.view.allLayerViews.forEach(d=>{d.destroyed||("slicePlaneEnabled"in d&&(d.slicePlaneEnabled=a&&!b.includes(d.layer)),"sublayerViews"in d&&d.sublayerViews.forEach(w=>
{w.slicePlaneEnabled=a&&!b.includes(w.sublayer)}))});null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=a&&!this.analysis.excludeGroundSurface)};r._createClass(p,[{key:"ready",get:function(){return"ready"===this.state}},{key:"_allLayerAndSubLayerViews",get:function(){const a=this.view.allLayerViews.items;return a.concat(a.filter(q.isIBuildingSceneLayerView3D).flatMap(({sublayerViews:b})=>b.items))}}]);return p}(y);k.__decorate([m.property({readOnly:!0})],f.SliceController.prototype,
"state",void 0);k.__decorate([m.property()],f.SliceController.prototype,"view",void 0);k.__decorate([m.property()],f.SliceController.prototype,"analysis",void 0);k.__decorate([m.property()],f.SliceController.prototype,"analysisViewData",void 0);k.__decorate([m.property()],f.SliceController.prototype,"ready",null);k.__decorate([m.property()],f.SliceController.prototype,"_allLayerAndSubLayerViews",null);f.SliceController=k.__decorate([B.subclass("esri.views.3d.analysis.Slice.SliceController")],f.SliceController);
const g=new Map;let u=!1;Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});