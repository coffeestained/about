// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/mathUtils ../../../core/maybe ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../chunks/vec3f32 ../../../chunks/vec3f64 ../../../core/support/WatchUpdatingTracking ../../../geometry/projectionEllipsoid ./PrecipitationTechnique ./PrecipitationTechniqueConfiguration ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/AnimationTimer ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums ../../webgl/Util ../../webgl/VertexArrayObject".split(" "),
function(f,v,l,F,w,d,G,p,N,O,P,H,h,t,x,I,J,m,q,y,z,K,A,B,u,C,L){f.Precipitation=function(D){function r(a){var b=D.call(this,a)||this;b._numParticles=25E4;b._rainSpeed=.1;b._snowSpeed=.01;b._opacity=1;b._width=500;b._offset=x.create();b._tile=x.create();b._particleColor=t.create();b._particleColorAtNight=t.create();b._nightMultiplier=.7;b._cameraDirection=t.create();b._renderParameters=new m.PrecipitationPassParameters;b._animation=new K.AnimationTimer;b._updatingTracking=new I.WatchUpdatingTracking;
b._renderParameters.time=0;b._renderParameters.radius=J.getReferenceEllipsoid(a.view.spatialReference).radius;b._shaderTechniqueRepository=a.context.shaderTechniqueRepository;return b}v._inheritsLoose(r,D);var g=r.prototype;g.destroy=function(){this._updatingTracking.destroy();this._numParticles=0;this._snowTechnique=d.releaseMaybe(this._snowTechnique);this._rainTechnique=d.releaseMaybe(this._rainTechnique);this._vao=d.disposeMaybe(this._vao);this._instanceIdBuffer=d.disposeMaybe(this._instanceIdBuffer)};
g.update=function(a){return this._animation.advance(a)};g.render=function(a,b,e){const n="rainy"===e;var c=n?this.rainTechnique:this.snowTechnique;if(c.compiled){var k=a.rctx;this._ensureResources(k);d.isNone(c)||d.isNone(this._vao)||d.isNone(this._instanceIdBuffer)||(d.isSome(a.bindParameters.clouds.data)&&(this._opacity=1-a.bindParameters.clouds.fadeInOutHeight.factor),0>=this._opacity||(b=.5>b?w.lerp(0,.35,2*b):w.lerp(.35,1,2*(b-.5)),c=k.bindTechnique(c),this._renderParameters.camera=a.bindParameters.camera,
this._renderParameters.time=(n?this._rainSpeed:this._snowSpeed)*G.secondsFromMilliseconds(this._animation.time),this._renderParameters.time%=1E5,this._update(c,e,a),k.bindVAO(this._vao),a=m.PrecipitationTechnique.attributeLocation,c.assertCompatibleVertexAttributeLocations(this._vao),C.bindVertexBufferLayout(k,a,this._instanceIdBuffer,E,0),k.capabilities.instancing.drawArraysInstanced(u.PrimitiveType.TRIANGLES,0,3,this._numParticles*b),C.unbindVertexBufferLayout(k,a,this._instanceIdBuffer,E)))}else this.context.requestRender()};
g._update=function(a,b,e){const n=e.bindParameters.camera,c=n.eye;this._tile[0]=Math.floor((c[0]+.5*this._width)/this._width);this._tile[1]=Math.floor((c[1]+.5*this._width)/this._width);this._tile[2]=Math.floor((c[2]+.5*this._width)/this._width);this._offset[0]=c[0]-this._tile[0]*this._width;this._offset[1]=c[1]-this._tile[1]*this._width;this._offset[2]=c[2]-this._tile[2]*this._width;a.setUniform1f("width",this._width);a.setUniform3fv("offset",this._offset);a.setUniformMatrix4fv("view",n.viewMatrix);
a.setUniform3fv("cameraPosition",c);a.bindPass(null,e.bindParameters);a.setUniform1f("time",this._renderParameters.time);"rainy"===b?h.set(this._particleColor,.85,.85,.85):h.set(this._particleColor,1,1,1);h.scale(this._particleColorAtNight,this._particleColor,this._nightMultiplier);h.normalize(this._cameraDirection,c);b=Math.max(0,h.dot(this._cameraDirection,e.bindParameters.lighting.lightingMainDirection));h.lerp(this._particleColor,this._particleColorAtNight,this._particleColor,b);a.setUniform3fv("particleColor",
this._particleColor);a.setUniform1f("opacity",this._opacity)};g._ensureResources=function(a){d.isNone(this._vao)&&(this._vao=this._createVertexArrayObject(a));d.isNone(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(a))};g._createInstanceIndices=function(a){const b=[];for(let e=0;e<this._numParticles;e++)b.push(e);return B.BufferObject.createVertex(a,u.Usage.STATIC_DRAW,new Float32Array(b))};g._createVertexArrayObject=function(a){const b=new Float32Array([-1,0,1,1,0,-1,
1,0,1]);return new L.VertexArrayObject(a,m.PrecipitationTechnique.attributeLocation,{geometry:y.glLayout(M)},{geometry:B.BufferObject.createVertex(a,u.Usage.STATIC_DRAW,b)})};v._createClass(r,[{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"rainTechnique",get:function(){if(d.isNone(this._rainTechnique)){const a=new q.PrecipitationTechniqueConfiguration;a.type=q.PrecipitationType.Rain;this._rainTechnique=this._shaderTechniqueRepository.acquire(m.PrecipitationTechnique,
a)}return this._rainTechnique}},{key:"snowTechnique",get:function(){if(d.isNone(this._snowTechnique)){const a=new q.PrecipitationTechniqueConfiguration;a.type=q.PrecipitationType.Snow;this._snowTechnique=this._shaderTechniqueRepository.acquire(m.PrecipitationTechnique,a)}return this._snowTechnique}}]);return r}(F);l.__decorate([p.property({constructOnly:!0})],f.Precipitation.prototype,"context",void 0);l.__decorate([p.property({constructOnly:!0})],f.Precipitation.prototype,"view",void 0);l.__decorate([p.property({readOnly:!0})],
f.Precipitation.prototype,"updating",null);l.__decorate([p.property()],f.Precipitation.prototype,"_updatingTracking",void 0);f.Precipitation=l.__decorate([H.subclass("esri.views.3d.environment.Precipitation")],f.Precipitation);const M=z.newLayout().vec3f(A.VertexAttribute.POSITION),E=y.glLayout(z.newLayout().f32(A.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});