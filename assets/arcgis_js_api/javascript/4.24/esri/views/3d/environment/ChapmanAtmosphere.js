// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../geometry/support/Ellipsoid ./atmosphereUtils ./ChapmanAtmosphereTechnique ./ChapmanAtmosphereTechniqueConfiguration ../webgl-engine/core/shaderModules/interfaces ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/enums".split(" "),
function(n,u,p,e,q,v,w,k,l,r,h,b,t,x,y,z,A,B){let E=function(){function m(a){this._view=a;this.type="realistic";this.canRender=!0;this._cameraPosition=l.create();this._heightParameters=r.create();this._betasRayleigh=l.create();this._betasCombined=l.create();this._scaleHeight=0;this._radii=w.create();this._lowerElevationBoundRadius=this._altitudeFade=this._innerFadeDistance=this._cAtmosphere=this._cameraHeightSq=this._cameraHeight=0;this._lowerBoundEarthRadius=h.earth.radius;this._hazeStrength=1;this._darkenHaze=
!1;this._updateRadius(h.earth.radius)}var c=m.prototype;c.destroy=function(){this._atmosphereTechnique=e.releaseMaybe(this._atmosphereTechnique);this._atmosphereHazeTechnique=e.releaseMaybe(this._atmosphereHazeTechnique);this._vao=e.disposeMaybe(this._vao);this._handles=e.destroyMaybe(this._handles)};c.when=function(){return Promise.resolve()};c.initializeRenderContext=function(a){const d=a.renderContext.rctx;var f=this._handles=new u;const g=this._view.basemapTerrain;e.isSome(g.rootTiles)&&this._updateElevation({spatialReference:g.spatialReference,
tile:g.rootTiles[0],extent:g.rootTiles[0].extent,context:"ground"});f.add(q.on(()=>this._view.basemapTerrain,"elevation-change",C=>this._updateElevation(C),{onListenerAdd:()=>this._updateElevation()}));f.add(q.on(()=>this._view.basemapTerrain,"elevation-bounds-change",()=>this._updateVisibleElevationBounds()));f=new x.ChapmanAtmosphereTechniqueConfiguration;f.haze=!1;this._atmosphereTechnique=a.shaderTechniqueRepository.acquire(t.ChapmanAtmosphereTechnique,f);f.haze=!0;this._atmosphereHazeTechnique=
a.shaderTechniqueRepository.acquire(t.ChapmanAtmosphereTechnique,f);this._vao=A.createQuadVAO(d,z.Pos2Tex);this._scaleHeight=b.rayLeighScaleHeight*b.atmosphereHeight;k.set(this._betasRayleigh,b.betaRayleigh[0],b.betaRayleigh[1],b.betaRayleigh[2]);k.set(this._betasCombined,b.betaRayleigh[0]+b.betaOzone[0],b.betaRayleigh[1]+b.betaOzone[1],b.betaRayleigh[2]+b.betaOzone[2])};c.render=function(a){this._render(a,this._atmosphereTechnique,a.offscreenRenderingHelper.depthTexture)};c.renderHaze=function(a,
d){this._darkenHaze=d;this._render(a,this._atmosphereHazeTechnique,a.offscreenRenderingHelper.linearDepthTexture)};c._render=function(a,d,f){this._update(a.bindParameters.camera);const g=a.rctx.bindTechnique(d,D,a.bindParameters);a.offscreenRenderingHelper.renderDepthDetached(()=>{g.bindTexture("depthTex",f);this._renderCommon(d.program,a)})};c._renderCommon=function(a,d){e.isNone(this._vao)||(d=d.rctx,a.setUniform4fv("heightParameters",this._heightParameters),a.setUniform3fv("cameraPosition",this._cameraPosition),
a.setUniform2fv("radii",this._radii),a.setUniform1f("scaleHeight",this._scaleHeight),a.setUniform1f("betaMie",b.betaMie),a.setUniform3fv("betaRayleigh",this._betasRayleigh),a.setUniform3fv("betaCombined",this._betasCombined),a.setUniform1f("innerFadeDistance",this._innerFadeDistance),a.setUniform1f("altitudeFade",this._altitudeFade),a.setUniform1f("hazeStrength",this._hazeStrength),d.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),d.drawArrays(B.PrimitiveType.TRIANGLE_STRIP,
0,4))};c._adjustRadiusForTesselation=function(a){return a*Math.cos(Math.PI/16/16)};c._updateElevation=function(a){a=a?a.tile:e.unwrapOr(this._view.basemapTerrain.rootTiles,[null])[0];e.isNone(a)||0!==a.level||(a=this._adjustRadiusForTesselation(h.earth.radius+a.elevationBounds[0]),a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds()))};c._updateVisibleElevationBounds=function(){const a=this._adjustRadiusForTesselation(h.earth.radius+
this._view.basemapTerrain.elevationBounds.min);(0>this._lowerBoundEarthRadius||a<this._lowerBoundEarthRadius)&&this._updateRadius(a)};c._updateRadius=function(a){this._lowerBoundEarthRadius=a;v.set(this._radii,a,a+b.atmosphereHeight);this._innerFadeDistance=2*Math.sqrt((2*a-b.innerAtmosphereDepth)*b.innerAtmosphereDepth)};c._update=function(a){e.isNone(a)||(this._cameraHeight=k.length(a.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*
this._radii[1],this._heightParameters=r.fromValues(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/b.atmosphereHeight))),k.copy(this._cameraPosition,a.eye),this._altitudeFade=b.computeInnerAltitudeFade(this._cameraHeight-this._lowerBoundEarthRadius),this._hazeStrength=this._darkenHaze?p.lerp(.6,1,p.smoothstep(9500,10500,this._cameraHeight-h.earth.radius)):1)};m.isSupported=function(a){return a.renderContext.rctx.capabilities.depthTexture};
return m}();const D=new y.NoParameters;n.ChapmanAtmosphere=E;Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});