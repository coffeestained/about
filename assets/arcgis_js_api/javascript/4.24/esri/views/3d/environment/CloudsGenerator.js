// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2f32 ../../../chunks/vec3 ../../../chunks/vec3f32 ../../../chunks/vec3f64 ../../../geometry/projectionEllipsoid ../../../chunks/Clouds.glsl ./CloudsCompositionParameters ./CloudsPresets ./CloudsTechnique ./CloudsTechniqueConfiguration ./NoiseTextureAtlas ../webgl-engine/lib/BindParameters ../webgl-engine/lib/glUtil3D ../../support/Scheduler ../../webgl/enums ../../webgl/FramebufferObject".split(" "),
function(c,v,h,A,B,C,f,l,w,k,V,W,D,E,F,G,u,x,n,H,I,J,y,K,L,M,N,O,P,Q,q,R){c.CloudsGenerator=function(z){function r(a){a=z.call(this,a)||this;a._frameTask=null;a._handles=new B;a._cubeMapSize=C("esri-mobile")?1024:2048;a._techniques=[];a._techniqueConfiguration=new M.CloudsTechniqueConfiguration;a._bindParameters=new O.BindParameters(null,null,null);a._drawParameters=new J.CloudsDrawParameters;a._weatherTile=u.fromValues(0,0);a._weatherTileCount=128;a.coverage=f.lerp(g.coverage[0],g.coverage[1],.5);
a.density=f.lerp(g.density[0],g.density[1],.5);a.absorption=f.lerp(g.absorption[0],g.absorption[1],.5);a.cloudSize=f.lerp(g.cloudSize[0],g.cloudSize[1],.5);a.detailSize=f.lerp(g.detailSize[0],g.detailSize[1],.5);a.smoothness=f.lerp(g.smoothness[0],g.smoothness[1],.5);a.cloudHeight=f.lerp(g.cloudHeight[0],g.cloudHeight[1],.5);a.raymarchingStepType=g.raymarchingStepType;a._cloudRadius=0;a._viewMatrix=G.create();a._cameraPositionLastFrame=H.create();a.running=!1;return a}v._inheritsLoose(r,z);var p=
r.prototype;p._getTechnique=function(a){const b=this._techniques[a];if(b)return b;this._techniqueConfiguration.steps=a;this._techniques[a]=new L.CloudsTechnique({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration);return this._techniques[a]};p._getWeatherTile=function(){let a=u.fromValues((this.view.camera.position.latitude+90)/180,(this.view.camera.position.longitude+180)/360);a=u.fromValues(Math.floor(2*this._weatherTileCount*a[0]),Math.floor(4*
(this._weatherTileCount-Math.floor(this._weatherTileCount*Math.abs(2*a[0]-1)))*a[1]));let b=0;var d=0;l.isSome(this.view.environment)&&"sun"===this.view.environment.lighting.type&&l.isSome(this.view.environment.lighting.date)&&(d=new Date(this.view.environment.lighting.date),d.setUTCHours(this.view.environment.lighting.date.getUTCHours()+this.view.environment.lighting.displayUTCOffset),b=31*d.getUTCMonth()+d.getUTCDate(),d=d.getUTCFullYear());a[0]=(a[0]+b)%(2*this._weatherTileCount);a[1]=(a[1]+d%
100)%(4*this._weatherTileCount);return a};p.initialize=function(){this._vao=P.createQuadVAO(this.context.renderContext.rctx);this._cloudRadius=.5*I.getReferenceEllipsoid(this.view.spatialReference).radius;this.setDirty();this._weatherTile=this._getWeatherTile();this._frameTask=this.view.resourceController.scheduler.registerTask(Q.TaskPriority.CLOUDS_GENERATOR,this);this._handles.add(this._frameTask);this._handles.add(w.watch(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,
this.smoothness,this.cloudHeight,this.raymarchingStepType],()=>this.setDirty(),w.initial))};p.destroy=function(){this._handles.destroy();this._techniques.forEach(a=>l.releaseMaybe(a));this._techniques=null;this._frameBufferCube=l.disposeMaybe(this._frameBufferCube);this._vao=l.disposeMaybe(this._vao);this._noiseTexture=l.destroyMaybe(this._noiseTexture)};p._ensureNoiseTexture=function(){l.isNone(this._noiseTexture)&&(this._noiseTexture=new N.NoiseTextureAtlas({context:this.context}),this._noiseTexture.updateWeatherMap(this._weatherTile));
return this._noiseTexture.textureAtlas};p.ensureWeatherTile=function(){const a=this._getWeatherTile();l.isSome(this._noiseTexture)&&l.isSome(this.context)&&this._noiseTexture.updateWeatherMap(a);if(a[0]!==this._weatherTile[0]||a[1]!==this._weatherTile[1])this._weatherTile=a,this.setDirty()};p.isFading=function(a){return a.crossFade.enabled||a.fadeInOut.stage===y.FadeInOutStages.FADE_OUT||a.fadeInOutHeight.stage!==y.FadeHeightStages.FINISHED};p.applyPreset=function(a,b){const d=a.median,e=m=>{const t=
f.lerp(m[0],m[1],d);return.5>b?f.lerp(m[0],t,2*b):f.lerp(t,m[1],2*(b-.5))};this.coverage=e(a.coverage);this.density=e(a.density);this.absorption=e(a.absorption);this.cloudSize=e(a.cloudSize);this.detailSize=e(a.detailSize);this.smoothness=e(a.smoothness);this.cloudHeight=e(a.cloudHeight);this.raymarchingStepType=a.raymarchingStepType};p.setDirty=function(){this.running=!0};p.runTask=function(a){if(0===this.coverage||l.isNone(this._vao))this.running=!1;else{var b=this._getTechnique(this.raymarchingStepType);
if(b.compiled)if(!x.equals(this._cameraPositionLastFrame,this.context.renderContext.bindParameters.camera.eye)||this.isFading(this.context.renderContext.bindParameters.clouds))x.copy(this._cameraPositionLastFrame,this.context.renderContext.bindParameters.camera.eye);else{this.ensureWeatherTile();var d=this._ensureNoiseTexture();if(!l.isNone(d)){var e=this.context.renderContext.rctx;b=e.bindTechnique(b);var m=1+this.absorption,t=f.lerp(35,120,this.absorption);b.bindTexture("cloudShapeTexture",d);b.setUniform1f("cloudRadius",
this._cloudRadius);b.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize);b.setUniform1f("power",t);b.setUniform1f("sigmaE",m);b.setUniform1f("density",f.lerp(0,.3,this.density));b.setUniform1f("cloudSize",f.lerp(0,.02,Math.max(.01,1-this.cloudSize)));b.setUniform1f("detailSize",f.lerp(0,.2,Math.max(.01,1-this.detailSize)));b.setUniform1f("smoothness",f.lerp(0,.5,1-this.smoothness));b.setUniform1f("cloudHeight",f.lerp(0,1500,this.cloudHeight));b.setUniform1f("coverage",this.coverage);e.bindVAO(this._vao);
b.assertCompatibleVertexAttributeLocations(this._vao);d=e.getViewport();e.setViewport(0,0,this._cubeMapSize,this._cubeMapSize);e.bindFramebuffer(this.frameBufferCube);for(m=0;5>m;m++)F.targetTo(this._viewMatrix,S,T[m],U[m]),E.fromMat4(this._drawParameters.viewMatrix,this._viewMatrix),this.frameBufferCube.setColorTextureTarget(q.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X+m),b.bindDraw(this._drawParameters,this._bindParameters),e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4),e.gl.flush();this.running=!1;e.setViewport(d.x,
d.y,d.width,d.height);this.requestRender();a.madeProgress()}}}};v._createClass(r,[{key:"frameBufferCube",get:function(){l.isNone(this._frameBufferCube)&&(this._frameBufferCube=new R.FramebufferObject(this.context.renderContext.rctx,{colorTarget:q.TargetType.CUBEMAP,width:this._cubeMapSize,height:this._cubeMapSize},{target:q.TextureType.TEXTURE_CUBE_MAP,pixelFormat:q.PixelFormat.RGBA,dataType:q.PixelType.UNSIGNED_BYTE,wrapMode:q.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:q.TextureSamplingMode.LINEAR,
hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize}));return this._frameBufferCube}},{key:"cubeMap",get:function(){return this._frameBufferCube}}]);return r}(A);h.__decorate([k.property({constructOnly:!0})],c.CloudsGenerator.prototype,"context",void 0);h.__decorate([k.property({constructOnly:!0})],c.CloudsGenerator.prototype,"view",void 0);h.__decorate([k.property({constructOnly:!0})],c.CloudsGenerator.prototype,"requestRender",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,
"_frameTask",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"coverage",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"density",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"absorption",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"cloudSize",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"detailSize",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"smoothness",void 0);h.__decorate([k.property()],
c.CloudsGenerator.prototype,"cloudHeight",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"raymarchingStepType",void 0);h.__decorate([k.property()],c.CloudsGenerator.prototype,"running",void 0);c.CloudsGenerator=h.__decorate([D.subclass("esri.views.3d.environment.CloudsGenerator")],c.CloudsGenerator);const T=[n.fromValues(1,0,0),n.fromValues(-1,0,0),n.fromValues(0,1,0),n.fromValues(0,-1,0),n.fromValues(0,0,1)],U=[n.fromValues(0,1,0),n.fromValues(0,1,0),n.fromValues(0,0,-1),n.fromValues(0,
0,1),n.fromValues(0,1,0)],S=n.zeros(),g=K.cloudPresets.sunny;Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});