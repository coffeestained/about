// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projectionEllipsoid ../../../geometry/support/spatialReferenceUtils ../../../support/requestImageUtils ./atmosphereUtils ../../../chunks/SimpleAtmosphere.glsl ./SimpleAtmosphereTechnique ./SimpleAtmosphereTechniqueConfiguration ./resources/MarsAtmosphereTexture ./resources/SimpleAtmosphereTexture ../support/mathUtils ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Util ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums ../../webgl/Texture ../../webgl/Util ../../webgl/VertexArrayObject".split(" "),
function(x,t,y,m,u,z,H,I,J,K,h,p,L,M,N,A,O,B,r,P,Q,R,S,T,U,V,C,W,X,n,Y,D,Z){function E(l,k,a,c,b){const f=h.length(l),d=c*Math.sqrt(f*f-c*c)/f,e=b.silCircleV1,g=b.silCircleV2;h.scale(b.silCircleCenter,l,Math.sqrt(c*c-d*d)/f);h.cross(e,l,k);1>h.squaredLength(e)&&h.cross(e,l,a);h.scale(e,e,d/h.length(e));h.cross(g,e,l);h.scale(g,g,d/h.length(g));return d}const aa=t.getLogger("esri.views.3d.environment.SimpleAtmosphere"),F=-A.innerAtmosphereDepth,ba=R.makePiecewiseLinearFunction([[50,.1015625],[500,
.21875],[5E3,.51171875],[5E4,.4140625]]);t=function(){function l(a){this.view=a;this.type="simple";this._renderData={texV:K.create(),silCircleCenter:p.create(),silCircleV1:p.create(),silCircleV2:p.create(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0};this._passParameters=new O.SimpleAtmospherePassParameters;this._fadeVaoCount=0;this._readyResolver=u.createResolver();this._readyController=new AbortController;this.texV1=1;this.canRender=!0;this.isOnMars=M.isMars(a.spatialReference);a=L.getReferenceEllipsoid(a.spatialReference);
this.planetRadius=a.radius;this.outerRimWidth=a.outerAtmosphereRimWidth;this.innerRimFactor=(this.planetRadius+F)/this.planetRadius;this.middleRimFactor=(this.planetRadius+0)/this.planetRadius;this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius;this.texV0=0/this.outerRimWidth;this.texVScale=this.texV1-this.texV0}var k=l.prototype;k.destroy=function(){this._readyResolver.reject();this._cameraChangeHandle=m.removeMaybe(this._cameraChangeHandle);this._passParameters.texture=
m.disposeMaybe(this._passParameters.texture);this._fadeVao=m.disposeMaybe(this._fadeVao);this._vao=m.disposeMaybe(this._vao);this._readyController=m.abortMaybe(this._readyController)};k.when=function(){return this._readyResolver.promise};k.initializeRenderContext=function(){var a=x._asyncToGenerator(function*(c){this._shaderTechniqueRepository=c.shaderTechniqueRepository;const b=c.renderContext.rctx;this._cameraChangeHandle=z.watch(()=>{var e;return null==(e=this.view.state)?void 0:e.camera},()=>
c.requestRender(),z.syncAndInitial);this._vao=this._createRibbon(b);this._vaoCount=D.vertexCount(this._vao,"geometry");this._fadeVao=V.createQuadVAO(b);this._fadeVaoCount=D.vertexCount(this._fadeVao,"geometry");const f=this.isOnMars?P:Q,d=this._readyController.signal;try{const e=yield N.requestImage(f,{signal:d});u.throwIfAborted(d);this._passParameters.texture=new Y.Texture(b,{pixelFormat:n.PixelFormat.RGBA,dataType:n.PixelType.UNSIGNED_BYTE,wrapMode:n.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:n.TextureSamplingMode.LINEAR,
flipped:!0},e);c.requestRender();this._readyController=null;this._readyResolver.resolve()}catch(e){u.isAbortError(e)||aa.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject(e)}});return function(c){return a.apply(this,arguments)}}();k.render=function(a){const c=a.bindParameters.camera;this._update(c);const b=a.rctx;if(1>this._renderData.undergroundFadeAlpha){const f=b.bindTechnique(this.coneTechnique,this._passParameters,a.bindParameters);f.setUniformMatrix4fv("proj",
c.projectionMatrix);f.setUniformMatrix4fv("view",c.viewMatrix);f.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter);f.setUniform3fv("silCircleV1",this._renderData.silCircleV1);f.setUniform3fv("silCircleV2",this._renderData.silCircleV2);f.setUniform2fv("texV",this._renderData.texV);f.setUniform1f("altitudeFade",this._renderData.altitudeFade);f.setUniform1f("innerScale",this._renderData.innerScale);b.bindVAO(this._vao);b.drawArrays(n.PrimitiveType.TRIANGLES,0,this._vaoCount)}0<this._renderData.undergroundFadeAlpha&&
(a=b.bindTechnique(this.undergroundTechnique,this._passParameters,a.bindParameters),a.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),a.setUniform3fv("cameraPosition",c.eye),b.bindVAO(this._fadeVao),b.drawArrays(n.PrimitiveType.TRIANGLE_STRIP,0,this._fadeVaoCount))};k.renderHaze=function(){return!1};k._update=function(a){var c=p.create();const b=this.planetRadius;var f=h.length(a.eye);const d=f-b;this._renderData.undergroundFadeAlpha=0>d?Math.min(-d/5E3,1):0;var e=b+F,g=
b+Math.max(50,d);this._renderData.innerScale=g*g/(Math.sqrt(g*g-b*b)*Math.sqrt(g*g-e*e)+b*e)-1;this._renderData.altitudeFade=A.computeInnerAltitudeFade(d);h.scale(c,a.eye,(b+50)/f);E(c,a.center,a.up,b,this._renderData);c=this._computeScreenRimWidth(a,c,a.up,this._renderData);f=ba(d);e=this.texV0+.001953125*this.texVScale;g=this.texV0+c*f*this.texVScale;50<d&&(E(a.eye,a.center,a.up,b,this._renderData),a=this._computeScreenRimWidth(a,a.eye,a.up,this._renderData),a=y.clamp((a-1.5)/(c-1.5),0,1),e=this.texV0+
.001953125*a*this.texVScale,g=this.texV0+y.lerp(this.texV1,c*f,a)*this.texVScale);J.set(this._renderData.texV,e,g)};k._createRibbon=function(a){const c=new Float32Array(1155),b=new Uint32Array(1920);c[0]=0;c[1]=0;c[2]=-1;for(var f=0;128>f;f++){var d=9*f+3;c[d+0]=f;c[d+1]=this.innerRimFactor;c[d+2]=-1;c[d+3]=f;c[d+4]=this.middleRimFactor;c[d+5]=0;c[d+6]=f;c[d+7]=this.outerRimFactor;c[d+8]=1;d=3*f+1;var e=127===f?1:d+3,g=15*f;b[g+0]=d;b[g+1]=d+1;b[g+2]=e+1;b[g+3]=e+1;b[g+4]=e;b[g+5]=d;b[g+6]=d+1;b[g+
7]=d+2;b[g+8]=e+2;b[g+9]=e+2;b[g+10]=e+1;b[g+11]=d+1;b[g+12]=d;b[g+13]=e;b[g+14]=0}f=G.createBuffer(b.length);d=f.position;for(e=0;e<b.length;++e)g=3*b[e],d.set(e,0,c[g]),d.set(e,1,c[g+1]),d.set(e,2,c[g+2]);return new Z.VertexArrayObject(a,U.Default3D,{geometry:S.glLayout(G)},{geometry:X.BufferObject.createVertex(a,n.Usage.STATIC_DRAW,f.buffer)})};k._computeScreenRimWidth=function(a,c,b,f){h.add(q,f.silCircleCenter,f.silCircleV2);h.scale(v,q,this.outerRimFactor);H.lookAt(w,c,q,b);C.project(q,w,a.projectionMatrix,
a.viewport);C.project(v,w,a.projectionMatrix,a.viewport);return h.distance(q,v)/a.height};x._createClass(l,[{key:"coneTechnique",get:function(){if(m.isNone(this._coneTechnique)){const a=new r.SimpleAtmosphereTechniqueConfiguration;a.geometry=r.SimpleAtmosphereGeometry.Cone;this._coneTechnique=this._shaderTechniqueRepository.acquire(B.SimpleAtmosphereTechnique,a)}return this._coneTechnique}},{key:"undergroundTechnique",get:function(){if(m.isNone(this._undergroundTechnique)){const a=new r.SimpleAtmosphereTechniqueConfiguration;
a.geometry=r.SimpleAtmosphereGeometry.Underground;this._undergroundTechnique=this._shaderTechniqueRepository.acquire(B.SimpleAtmosphereTechnique,a)}return this._undergroundTechnique}}]);return l}();const w=I.create(),q=p.create(),v=p.create(),G=T.newLayout().vec3f(W.VertexAttribute.POSITION);return t});