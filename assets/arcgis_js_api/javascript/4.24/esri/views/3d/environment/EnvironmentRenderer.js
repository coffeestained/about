// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/has ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../geometry/projectionEllipsoid ../../../geometry/support/spatialReferenceUtils ./ChapmanAtmosphere ./CloudsComposition ./CloudsData ./CloudsGenerator ./CloudsPresets ./Fog ./PanoramicAtmosphere ./Precipitation ./SimpleAtmosphere ./Stars ./weather ../webgl-engine/lib/RenderPass ../webgl-engine/lib/RenderSlot".split(" "),
function(d,q,f,y,O,z,r,b,k,h,P,Q,A,B,t,u,v,C,D,E,F,G,H,I,J,K,L,M,m){var l;const N=[m.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE,m.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];d.EnvironmentRenderer=l=function(w){function n(a){a=w.call(this,a)||this;a._handles=new z;a._context=null;a._pendingAtmosphere=null;a._atmosphere=null;return a}q._inheritsLoose(n,w);var g=n.prototype;g.initialize=function(){this.view._stage.addRenderPlugin(N,this)};g.destroy=function(){var a;this._pendingAtmosphere=b.destroyMaybe(this._pendingAtmosphere);
null!=(null==(a=this.view)?void 0:a._stage)&&this.view._stage.removeRenderPlugin(this);this._handles=b.destroyMaybe(this._handles);this._set("view",null)};g.updateAnimation=function(a){return b.isSome(this._precipitation)?this._precipitation.update(a):!1};g.initializeRenderContext=function(a=null){this._context=a;this._handles.add([k.when(()=>{var c;return null==(c=this.view)?void 0:c.basemapTerrain},()=>this._updateBasemapTerrain(),k.syncAndInitial),k.watch(()=>({viewingMode:this.view.viewingMode,
atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality}),()=>this._updateAtmosphere(),k.syncAndInitial),k.watch(()=>this._stars,()=>this._setNeedsRender()),k.watch(()=>this._clouds,()=>this._updateWeather(this._weatherUpdateParameters),k.initial),k.watch(()=>this._precipitation,()=>this._setNeedsRender()),k.watch(()=>this._fog,()=>this._updateFog(this._weatherUpdateParameters),k.initial),k.watch(()=>this._weatherUpdateParameters,c=>{this._updateWeather(c);
this._updateFog(c)},k.syncAndInitial)])};g.uninitializeRenderContext=function(){this._context=null;this._atmosphere=b.destroyMaybe(this._atmosphere);this._set("_stars",b.destroyMaybe(this._stars));this._set("_precipitation",b.destroyMaybe(this._precipitation));this._set("_clouds",b.destroyMaybe(this._clouds));this._set("_cloudsComposition",b.destroyMaybe(this._cloudsComposition));this._set("_fog",b.destroyMaybe(this._fog))};g.prepareRender=function(a){a.bindParameters.clouds.data=D.isReadyCloudsData(this._clouds)?
this._clouds:null};g.render=function(a){if(a.pass===M.RenderPass.MATERIAL)switch(a.bindParameters.slot){case m.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE:b.isSome(this._stars)&&this._stars.render(a);b.isSome(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(a),b.isSome(this._cloudsComposition)&&b.isSome(a.bindParameters.clouds.data)&&(this.weatherVisible&&b.isSome(this._clouds)&&this._clouds.ensureWeatherTile(),this._cloudsComposition.render(a,b.isSome(this.view.animation))));
break;case m.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(b.isSome(this._atmosphere)&&this._atmosphere.canRender){var c=this.weatherEnabled?this.view.environment.weather.type:"disabled";this._atmosphere.renderHaze(a,"rainy"===c);if(b.isSome(this._fog)){const e="foggy"===c||"rainy"===c||"snowy"===c;(e||"realistic"!==this._selectAtmosphereType())&&this._fog.render(a,e,"rainy"===c)}b.isSome(this._precipitation)&&(c=this.view.environment.weather,"rainy"!==c.type&&"snowy"!==c.type||this._precipitation.render(a,
c.precipitation,c.type))}}};g._updateWeather=function(a){b.isNone(a)||b.isNone(this._clouds)||(this._clouds.applyPreset(F.cloudPresets[a.type],a.weatherAdjustment),this._setNeedsRender())};g._setNeedsRender=function(){b.isSome(this._context)&&this._context.requestRender()};g._updateFog=function(a){if(!b.isNone(this._fog)&&!b.isNone(a))switch(a.type){case "foggy":this._fog.strength=r.lerp(3E-5,.005,a.weatherAdjustment**3);this._setNeedsRender();break;case "rainy":case "snowy":this._fog.strength=r.lerp(4E-6,
2E-4,a.effect**3);this._setNeedsRender();break;default:this._fog.strength=4E-6,this._setNeedsRender()}};g._updateAtmosphere=function(){var a=this._selectAtmosphereType();if(this.atmosphereType!==a)if(b.isSome(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null),a=this._getAtmosphereClass()){var c=new a(this.view);b.isSome(this._context)&&c.initializeRenderContext(this._context);b.isNone(this._atmosphere)&&(this._atmosphere=
c,this._setNeedsRender());this._pendingAtmosphere=c;c.when().then(()=>{b.isSome(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere);this._pendingAtmosphere=null;this._setNeedsRender();this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===c&&(this._pendingAtmosphere=null)})}else b.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),
this._updateBasemapTerrain()};g._getAtmosphereClass=function(){switch(this._selectAtmosphereType()){case "none":return null;case "realistic":return v.ChapmanAtmosphere;case "panoramic":return H.PanoramicAtmosphere;case "simple":return J}};g._selectAtmosphereType=function(){const a=this.view.get("environment.atmosphereEnabled"),c=this.view.get("environment.atmosphere.quality"),e=this.view.viewingMode;return!a||null==c||u.isMoon(this.view.spatialReference)?"none":"local"===e?"panoramic":"high"===c&&
b.isSome(this._context)&&v.ChapmanAtmosphere.isSupported(this._context)&&u.isEarth(this.view.spatialReference)?"realistic":"simple"};g._updateBasemapTerrain=function(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=b.isSome(this._atmosphere)&&"simple"===this.atmosphereType)};q._createClass(n,[{key:"atmosphereType",get:function(){return b.isSome(this._pendingAtmosphere)?this._pendingAtmosphere.type:b.isSome(this._atmosphere)?this._atmosphere.type:"none"}},{key:"canRender",get:function(){var a;
return!(null==(a=this.view.basemapTerrain)||!a.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"needsLinearDepth",get:function(){return"realistic"===this._selectAtmosphereType()}},{key:"updating",get:function(){return b.isSome(this._pendingAtmosphere)||b.isSome(this._stars)&&this._stars.updating||b.isSome(this._clouds)&&this._clouds.running}},{key:"weatherVisible",get:function(){return B.length(this.view.state.camera.eye)-t.getReferenceEllipsoid(this.view.spatialReference).radius<=L.weatherHeightLimit}},
{key:"_stars",get:function(){var a,c;const e=this.view,p=null!=(a=null==(c=e.environment)?void 0:c.starsEnabled)?a:!1;a=this._get("_stars");return!p||b.isNone(this._context)?(b.destroyMaybe(a),null):b.isSome(a)?a:new K.Stars({view:e,requestRender:()=>this._setNeedsRender()})}},{key:"_precipitation",get:function(){const a=this._get("_precipitation");if(!this._precipitationEnabled||b.isNone(this._context))return b.destroyMaybe(a),null;const c=this.view,e=this._context;if(b.isSome(a)&&a.context===e)return a;
b.destroyMaybe(a);return new I.Precipitation({context:e,view:c})}},{key:"_clouds",get:function(){const a=this._get("_clouds");if(!this.weatherEnabled||b.isNone(this._context))return b.destroyMaybe(a),null;if(b.isSome(a))return a;const c=this.view,e=this._context;b.destroyMaybe(a);return new E.CloudsGenerator({context:e,view:c,requestRender:()=>this._setNeedsRender()})}},{key:"_cloudsComposition",get:function(){const a=this._get("_cloudsComposition");if(!this.weatherEnabled||b.isNone(this._context))return b.destroyMaybe(a),
null;const c=this.view.state.viewingMode,e=this._context.renderContext.rctx,p=t.getReferenceEllipsoid(this.view.spatialReference).radius;if(b.isSome(a)&&a.viewingMode===c&&a.planetRadius===p)return a;b.destroyMaybe(a);return new C.CloudsComposition({rctx:e,viewingMode:c,planetRadius:p,requestRender:()=>this._setNeedsRender()})}},{key:"_fog",get:function(){const a=this._get("_fog");if(!this.weatherEnabled||b.isNone(this._context))return b.destroyMaybe(a),null;if(b.isSome(a))return a;const c=this.view,
e=this._context;b.destroyMaybe(a);return new G.Fog({context:e,view:c})}},{key:"weatherEnabled",get:function(){var a,c;return!(null==(a=this.view)||null==(c=a.environmentManager)||!c.weatherEnabled)}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"_weatherUpdateParameters",get:function(){const a=this.weatherEnabled?this.view.environment.weather:null;return b.isNone(a)?null:
"rainy"===a.type||"snowy"===a.type?{type:a.type,weatherAdjustment:a.cloudCover,effect:a.precipitation}:{type:a.type,weatherAdjustment:"foggy"===a.type?a.fogStrength:a.cloudCover}}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType(),stubGetAtmosphereClass:a=>{x=l.prototype._getAtmosphereClass;l.prototype._getAtmosphereClass=a},restoreGetAtmosphereClass:()=>{l.prototype._getAtmosphereClass=x}}}}]);return n}(y);f.__decorate([h.property({constructOnly:!0})],
d.EnvironmentRenderer.prototype,"view",void 0);f.__decorate([h.property({type:Boolean,readOnly:!0})],d.EnvironmentRenderer.prototype,"updating",null);f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"weatherVisible",null);f.__decorate([h.property()],d.EnvironmentRenderer.prototype,"_context",void 0);f.__decorate([h.property()],d.EnvironmentRenderer.prototype,"_pendingAtmosphere",void 0);f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_stars",null);
f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_precipitation",null);f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_clouds",null);f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_cloudsComposition",null);f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_fog",null);f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"weatherEnabled",null);f.__decorate([h.property({readOnly:!0})],
d.EnvironmentRenderer.prototype,"_precipitationEnabled",null);f.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null);d.EnvironmentRenderer=l=f.__decorate([A.subclass("esri.views.3d.environment.EnvironmentRenderer")],d.EnvironmentRenderer);let x;Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});