// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Logger ../../../core/maybe ../../../chunks/vec2f64 ../../2d/engine/imagery/enums ../../2d/engine/vectorTiles/VectorTileRendererHelper3D ./BlendLayersTechnique ./LayerClass ./RasterColorizerTechnique ./support/FBOPool ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/TileBlendInput ../../../chunks/BlendLayers.glsl ../webgl-engine/lib/BindParameters ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(x,E,q,g,F,y,G,z,A,B,C,n,r,f,H,I,J,k,D,K){const L=q.getLogger("esri.views.3d.terrain");q=function(){function t(a,b){this._rctx=a;this._techniqueRepository=b;this._fboPools=[];this._doubleBufferFbo=[];this._vectorTileHelper=new G.VectorTileRendererHelper3D;this._bindParameters=new H.BindParameters(null,null,null);this._blendLayersTechniqueConfig=new z.BlendLayersTechniqueConfiguration;this._poolToWrite=0;this._vaoQuad=J.createQuadVAO(this._rctx,I.Pos2Tex);this._fboPools.push(new C.FBOPool(this._rctx));
this._fboPools.push(new C.FBOPool(this._rctx))}var e=t.prototype;e.dispose=function(){this._fboPools.forEach(a=>{a.clear();a=null});this._fboPools=null;this._doubleBufferFbo.forEach(a=>a=g.disposeMaybe(a));this._vaoQuad=g.disposeMaybe(this._vaoQuad);this._vectorTileHelper=g.disposeMaybe(this._vectorTileHelper);this._backgroundTechnique=g.releaseMaybe(this._backgroundTechnique);this._applyOpacityTechnique=g.releaseMaybe(this._applyOpacityTechnique);this._blendLayersTechnique=g.releaseMaybe(this._blendLayersTechnique)};
e._getBlendLayersTechnique=function(a,b,d,c=!1){this._blendLayersTechniqueConfig.output=b;this._blendLayersTechniqueConfig.blendMode=a;this._blendLayersTechniqueConfig.baseOpacityMode=d?b===f.BlendLayersOutput.Composite?f.BaseOpacityMode.OnBaseLayer:f.BaseOpacityMode.OnBackground:f.BaseOpacityMode.One;this._blendLayersTechniqueConfig.premultipliedSource=c;return this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(z.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._blendLayersTechnique)};
e.drawBackground=function(a,b){b=this._getBlendLayersTechnique(n.LayerBlendMode.Normal,b,!1);a=this._rctx.bindTechnique(b,a,this._bindParameters);this._render(a)};e._render=function(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(k.PrimitiveType.TRIANGLE_STRIP,0,K.vertexCount(this._vaoQuad,"geometry"))};e.drawRasterData=function(a,b,d=!1){if(!g.isNone(b.texture)){var c=1>b.baseOpacity;b.blendMode!==n.LayerBlendMode.Normal||c||d?
(b.fboTexture=this._currentFBO.colorTexture,this._switchPool(this._currentFBO.width)):b.fboTexture=null;a=this._getBlendLayersTechnique(b.blendMode,a,c,d);b=this._rctx.bindTechnique(a,b,this._bindParameters);this._render(b)}};e.drawImageryTileData=function(a,b,d){var c=a.sourceLayerInfo.data;if(c.source){a.tile.surface.layerViewByIndex(a.layerIndex,A.LayerClass.MAP).ensureSymbolizerParameters(c);var h=1>d.baseOpacity;d.blendMode!==n.LayerBlendMode.Normal||h?(d.fboTexture=this._currentFBO.colorTexture,
this._switchPool(this._currentFBO.width)):d.fboTexture=null;b=this._getRasterColorizerTechnique(c,b,d.blendMode,h);h=this._rctx.bindTechnique(b);c.bind(this._rctx)&&(c.opacity=d.opacity,c=c.getUniforms(),c.scale=a.scale,c.offset=a.offset,c.backgroundColor=d.backgroundColor,c.fboTexture=d.fboTexture,c.baseOpacity=d.baseOpacity,b.bindPass(c,null),this._render(h))}};e._getRasterColorizerTechnique=function(a,b,d,c){const h=a.symbolizerParameters,p=["stretch","lut","hillshade"].indexOf(h.type);g.isNone(this._rasterColorizerConfig)&&
(this._rasterColorizerConfig=new B.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.tileBlendInput=b===f.BlendLayersOutput.ColorComposite?r.TileBlendInput.ColorComposite:b===f.BlendLayersOutput.GridComposite?r.TileBlendInput.GridComposite:r.TileBlendInput.LayerOnly;this._rasterColorizerConfig.blendMode=d;this._rasterColorizerConfig.baseOpacityMode=c?b===f.BlendLayersOutput.Composite?
f.BaseOpacityMode.OnBaseLayer:f.BaseOpacityMode.OnBackground:f.BaseOpacityMode.One;this._rasterColorizerConfig.colorizerType=p;this._rasterColorizerConfig.applyColormap=!!h.colormap;this._rasterColorizerConfig.stretchType=a.hasStretchTypeNone()?y.RasterColorizerStretchType.Noop:y.RasterColorizerStretchType.PerBand;return this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(B.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique)};e.drawVectorData=
function(a,b,d,c,h,p,u){const l=this._rctx,M=b.sourceLayerInfo.data,v=b.tile.surface.layerViewByIndex(b.layerIndex,A.LayerClass.MAP),w=1>a.baseOpacity||1>a.opacity||a.blendMode!==n.LayerBlendMode.Normal||u!==f.BlendLayersOutput.Composite;this._getBlendLayersTechnique(a.blendMode,u,1>a.baseOpacity,w).bindPipelineState(l);let m;w?(m=this._acquire(h),l.bindFramebuffer(m),l.setClearColor(0,0,0,0),l.clearSafe(k.ClearBufferBit.COLOR_BUFFER_BIT|k.ClearBufferBit.DEPTH_BUFFER_BIT)):p&&l.clearSafe(k.ClearBufferBit.DEPTH_BUFFER_BIT);
try{this._vectorTileHelper.render(l,b.sourceLod,M,v.painter,v.layer.styleRepository,v.schemaHelper,Math.round(1/b.scale),b.offset,c,d)}catch(N){L.warnOnce("A render call containing vector tiles did not resolve correctly.",N)}return g.isSome(m)?(l.bindFramebuffer(this._currentFBO),a.texture=m.colorTexture,a.offset=F.ZEROS,a.scale=1,this.drawRasterData(u,a,w),m.release(),p):!0};e.copyFBOToTexture=function(a){const b=this._rctx,d=b.bindTexture(a.texture,D.Texture.TEXTURE_UNIT_FOR_UPDATES),c=a.descriptor;
b.gl.copyTexImage2D(k.TextureType.TEXTURE_2D,0,c.pixelFormat,0,0,c.width,c.height,0);a.generateMipmap();b.bindTexture(d,D.Texture.TEXTURE_UNIT_FOR_UPDATES)};e._initFBO=function(a,b){this._rctx.bindFramebuffer(a);this._rctx.setViewport(0,0,b,b);this._rctx.setClearColor(0,0,0,0);this._rctx.setClearDepth(1);this._rctx.clearSafe(k.ClearBufferBit.COLOR_BUFFER_BIT|k.ClearBufferBit.DEPTH_BUFFER_BIT)};e._acquire=function(a){return this._fboPools[this._poolToWrite].acquire(a)};e.bindPool=function(a,b){this._poolToWrite=
a;null==this._doubleBufferFbo[a]&&(this._doubleBufferFbo[a]=this._acquire(b),this._initFBO(this._doubleBufferFbo[a],b))};e._switchPool=function(a){this._releaseCurrentFBO();this._doubleBufferFbo[this._poolToWrite]=null;this._poolToWrite=0===this._poolToWrite?1:0;this.bindPool(this._poolToWrite,a)};e._releaseCurrentFBO=function(){this._doubleBufferFbo[this._poolToWrite].release();this._doubleBufferFbo[this._poolToWrite]=null};e.releasePool=function(){this._rctx.bindFramebuffer(null);this._releaseCurrentFBO()};
e.cleanupFBOPool=function(a,b){if(a!==this._lastPixelRatio||b!==this._lastNumLayers)this._fboPools.forEach(d=>d.clear()),this._lastPixelRatio=a,this._lastNumLayers=b};E._createClass(t,[{key:"_currentFBO",get:function(){return this._doubleBufferFbo[this._poolToWrite]}}]);return t}();x.TileCompositor=q;Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});