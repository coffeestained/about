// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/mathUtils ../../../core/maybe ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../layers/support/layerUtils ../support/StreamDataLoader ./BlendLayersTechnique ./interfaces ./LayerClass ./terrainUtils ./TextureFader ./TextureReference ./TileCompositor ./TileTexture ./TileUpdate ../webgl-engine/core/shaderLibrary/output/BlendOptions ../../../chunks/BlendLayers.glsl ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture".split(" "),
function(K,Q,R,p,L,S,T,U,V,M,D,w,G,H,W,z,E,F,A,N,x,B){function I(h,f){l.layerIndex=f;const a=h.layerInfo[D.LayerClass.MAP][f];if(p.isSome(a.data))return L.set(l.offset,0,0),l.tile=h,l.scale=1,l.sourceLod=h.lij,l.sourceLayerInfo=a,l;h=a.upsampleInfo;return p.isSome(h)?(f=h.tile.layerInfo[D.LayerClass.MAP][f],l.tile=h.tile,L.copy(l.offset,h.offset),l.scale=h.scale,l.sourceLod=h.tile.lij,l.sourceLayerInfo=f,l):null}let X=function(){function h(a,c,b){this._rctx=a;this.tileSize=c;this._techniqueRepository=
b;this._passParameters=new V.BlendLayersPassParameters;this._backgroundColor=this._backgroundTexture=null;this._backgroundDirty=!1;this._blackTex=null;this._numTexturedLayer=0;this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy;this._composition=new W.TileCompositor(this._rctx,this._techniqueRepository);this._blackTex=new z(N.createColorTexture(this._rctx,[0,0,0,1]));this._ensureBackgroundTexture(this.tileSize)}var f=h.prototype;f.dispose=function(){this._composition=p.disposeMaybe(this._composition);
this._backgroundTexture=p.releaseMaybe(this._backgroundTexture);this._blackTex=p.releaseMaybe(this._blackTex)};f.updateTileTexture=function(a,c){if(a.renderData){for(var b=a.surface,d=b.baseOpacity,m=this._numTexturedLayer=0,g=this.tileSize,u=!1,n=b.view.state.pixelRatio,C=!1,q=a.layerInfo[D.LayerClass.MAP],v=q.length,e=0;e<q.length;e++){const t=b.layerViewByIndex(e,D.LayerClass.MAP),r=t.fullOpacity;J[e]=r;T.isBaseLayer(t.layer)&&v>=q.length&&(v=e);if(0===r){q[e].pendingUpdates&=~(E.TileUpdate.TEXTURE_NOFADING&
E.TileUpdate.TEXTURE_FADING);continue}++m;const k=I(a,e);if(k){q[e].pendingUpdates&=~(E.TileUpdate.TEXTURE_NOFADING&E.TileUpdate.TEXTURE_FADING);if(w.isBlendableLayerView(t)){var y=w.isGroupLayer(t.layer.parent)?"normal":t.layer.blendMode;O[e]=y;if(y="normal"!==y)C=y,u=!1}w.isVectorTileLayerView(t)?g=Math.max(g,this.tileSize*n):1===d&&1===r&&(t.isOpaque||this._dataToTexture(k)&&k.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0);++this._numTexturedLayer}}this._composition.cleanupFBOPool(n,q.length);
n=g;g=R.nextHighestPowerOfTwo(n);b=g*g;d=n*n;b===d?g=n:(n=g/2,g=b-d<d-n*n?g:n);b=g/this.tileSize;--e;this._ensureBackgroundTexture(this.tileSize);0===this._numTexturedLayer?this._useBackgroundTexture(a,m):(1!==this._numTexturedLayer||C||!this._useLayerTexture(a,e,v,J[e]))&&this._composeMapLayers(a,c,e,v,J,O,g,b,!u||C)}};f._ensureBackgroundTexture=function(a){p.isNone(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(a),this._backgroundDirty=!0);this._backgroundDirty&&(this._composition.bindPool(0,
a),this._passParameters.offset=S.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,this._passParameters.blendMode=F.LayerBlendMode.Normal,p.isSome(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,p.isSome(this.backgroundColor)?A.BlendLayersOutput.ColorOnly:A.BlendLayersOutput.GridOnly),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.releasePool(),this._backgroundDirty=
!1)};f._useBackgroundTexture=function(a,c){let b=G.ActivationTime.Immediate;if(a.surface.view.layerViewManager.updating||0<c)b=G.ActivationTime.Delayed;this._backgroundTexture&&p.isNone(a.renderData.textureReference)&&(b=G.ActivationTime.Immediate);a.renderData.setTextureReference(p.isSome(this._backgroundTexture)?new H.TextureReference(this._backgroundTexture,M.TextureUpdate.FADING,P,a.surface.baseOpacity,1,0):null,b)};f._useLayerTexture=function(a,c,b,d){var m=c<b;b=m?1:a.surface.baseOpacity;m=
m?a.surface.baseOpacity:1;c=I(a,c);return this._dataToTexture(c)?(a.renderData.setTextureReference(new H.TextureReference(c.sourceLayerInfo.data,M.TextureUpdate.FADING,c,b,d,m)),!0):!1};f._composeMapLayers=function(a,c,b,d,m,g,u,n,C){this._composition.bindPool(0,u);const q=a.surface.baseOpacity;let v=!1,e=x.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,y=!1,t=0;for(;0<=b;b--){const k=I(a,b);if(k&&0!==m[b]){var r=b<d&&1>q&&!v;this._passParameters.baseOpacity=r?q:1;r&&(v=!0);r=0===t;r=C&&r?this.backgroundIsGrid?
A.BlendLayersOutput.GridComposite:A.BlendLayersOutput.ColorComposite:A.BlendLayersOutput.Composite;w.isVectorTileRenderInfo(k)?(this._passParameters.opacity=m[b],this._passParameters.blendMode=F.blendModeFromString[g[b]],y=this._composition.drawVectorData(this._passParameters,k,n,this.tileSize,u,y,r)):w.isImageryTileRenderInfo(k)?(this._passParameters.opacity=m[b],this._passParameters.blendMode=F.blendModeFromString[g[b]],this._composition.drawImageryTileData(k,r,this._passParameters),this._hasNearestInterpolation(k)&&
(e=x.TextureSamplingMode.NEAREST)):this._dataToTexture(k)&&(this._passParameters.texture=k.sourceLayerInfo.data.texture,this._passParameters.offset=k.offset,this._passParameters.scale=k.scale,this._passParameters.opacity=m[b],this._passParameters.blendMode=F.blendModeFromString[g[b]],this._composition.drawRasterData(r,this._passParameters));t++}}d=a.renderData.ensureTexture(u,()=>this._buildTexture(u,e));this._composition.copyFBOToTexture(d);this._composition.releasePool();a.renderData.setTextureReference(new H.TextureReference(d,
c,P,v?1:q,1,0))};f._hasNearestInterpolation=function(a){a=a.sourceLayerInfo.data;return a.source?"nearest"===a.interpolation:!1};f._dataToTexture=function(a){w.isRasterTileRenderInfo(a)&&this._rasterDataToTexture(a);return w.isTextureTileRenderInfo(a)};f._rasterDataToTexture=function(a){const c=a.sourceLayerInfo;c.data=this._buildTexture(c.data);a.tile.setMemoryDirty()};f.setBackground=function(a){this._backgroundColor!==a&&(this._backgroundColor=a,this._backgroundDirty=!0)};f._buildTexture=function(a,
c=x.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(p.isNone(a))return null;const b={target:x.TextureType.TEXTURE_2D,pixelFormat:x.PixelFormat.RGBA,dataType:x.PixelType.UNSIGNED_BYTE,wrapMode:x.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:c,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0};c=this._rctx;let d;if("number"===typeof a)b.width=b.height=a,d=new z(new B.Texture(c,b));else if(a instanceof U.ImageWithType)b.isOpaque=a.isOpaque,d=new z(new B.Texture(c,b,a.image)),a.release();else try{d=
new z(new B.Texture(c,b,a))}catch(m){d=new z(N.createEmptyTexture(c)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}a=c.bindTexture(d.texture,B.Texture.TEXTURE_UNIT_FOR_UPDATES);d.generateMipmap();c.bindTexture(a,B.Texture.TEXTURE_UNIT_FOR_UPDATES);return d};Q._createClass(h,[{key:"backgroundIsGrid",get:function(){return p.isNone(this._backgroundColor)}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]);
return h}();const J=[],O=[],l={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},P={offset:[0,0],scale:1};K.TileRenderer=X;Object.defineProperties(K,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});