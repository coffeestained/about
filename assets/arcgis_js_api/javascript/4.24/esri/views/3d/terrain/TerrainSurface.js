// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/aliasOf ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../core/support/WatchUpdatingTracking ../../../geometry/projection ../../../geometry/projectionEllipsoid ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../geometry/support/spatialReferenceUtils ../../../layers/mixins/RefreshableLayer ../../../layers/support/ElevationQueryTileCache ../../../layers/support/layerUtils ../../../layers/support/LercDecoder ../../2d/engine/vectorTiles/VectorTile ../support/cameraUtils ../support/debugFlags ../support/extentUtils ../support/index ../support/updatingProperties ./ElevationBounds ./ElevationData ./ExtentHelper ./interfaces ./LayerClass ./OverlayManager ./PlanarPatch ./RenderOrder ./SphericalPatch ./TerrainConst ./TerrainRenderer ./TerrainSurfacePerformanceInfo ./terrainUtils ./Tile ./TilePerLayerInfo ./TileUpdate ./tileUtils ./TilingSchemeLogic ./UpsampleInfo ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/lib/basicInterfaces ../../support/Scheduler".split(" "),
function(ca,Q,m,da,k,ea,fa,ha,ia,ja,ka,p,I,R,D,q,N,Ma,Na,n,la,ma,na,oa,S,pa,qa,G,ra,z,J,sa,ta,ua,va,wa,xa,T,U,ya,V,za,Aa,W,Ba,E,x,Ca,Da,Ea,Fa,C,Ga,Ha,t,X,Ia,u,H,Ja,Ka,Y,Z,O){function aa(B,y){return B[0]===y[0]&&B[1]===y[1]&&B[2]===y[2]}function ba(B){return B.isLeaf?!1:B.children.some(y=>y.shouldLoad)||B.children.some(y=>ba(y))}const A=ja.getLogger("esri.views.3d.terrain.TerrainSurface");k=function(B){function y(a){var b,c;var d=B.call(this,a)||this;d._elevationBounds=new Aa.ElevationBounds;d._iteratorPool=
new I(H.IteratorPreorder,e=>e.remove=()=>d._iteratorPool.release(e));d._postorderIterator=new H.IteratorPostorder;d._hasPendingUpdates=!1;d._pendingUpdates=0;d._asyncWorkItems=0;d._allTilesDirty=!0;d._allTilesSorted=!0;d._visible=!1;d._usedMemory=null;d._performanceInfo=new Ha;d._viewChanged=!1;d._inFrameTask=!1;d._viewChangeUpdateDirty=!1;d._eyePosRenderSR=S.create();d._eyePosSurfaceSR=S.create();d._splitLimits=new X.SplitLimits;d._snapLevel=Infinity;d._frustum=J.create();d._viewProjectionMatrix=
na.create();d._layerViews=[[],[]];d._layerIndexByUid=[new Map,new Map];d._basemapLayerViewHandles=new Map;d._handles=new ia;d._watchUpdatingTracking=new qa.WatchUpdatingTracking;d._frameTask=O.ImmediateTask;d._allTiles=new R;d._upsampleInfoPool=new I(Ka.UpsampleInfo);d._rootTilesExtent=z.create();d._maxNumUpdating=1;d.maxTextureScale=1.2;d.backgroundColor=null;d._updatingRootTiles=!1;d.deferTileNeighborUpdate=!1;d.neighborTilesToUpdate=new Set;d.totalGeometryUpdates=0;d.totalTileUpdates=0;d._layerViewsDirty=
!1;d._isGlobal=!(null!=(b=a.view)&&null!=(c=b.state)&&c.isLocal);return d}Q._inheritsLoose(y,B);var f=y.prototype;f.initialize=function(){this._lercDecoder=wa.acquireDecoder(this.view.resourceController);this._tilePool=this.view.state.isLocal?new I(Da.PlanarPatch):new I(Fa.SphericalPatch);var a=this.view.resourceController.memoryController;this._upsampleMapCache=a.newCache("esri.views.3d.terrain.upsample",b=>b.unloadMapData());this._elevationQueryCache=new ua.ElevationQueryTileCache(a.newCache("elevation-query"));
this._set("overlayManager",new Ca.OverlayManager({surface:this}));this._handles.add([q.watch(()=>this.overlayManager.hasHighlights,b=>this._renderer.setNeedsHighlight(b)),q.watch(()=>this.overlayManager.rendersOccluded,b=>this._renderer.setRenderOccludedOverlay(b))],"overlayManager");this._renderer=new Ga({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:ra.getReferenceEllipsoid(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles});this._handles.add([q.watch(()=>
this.baseOpacity,b=>{this._handleLayerViewChanges();this._updateBaseOpacity(b)},q.syncAndInitial),q.watch(()=>this.hasCompositeBlendMode,()=>{this._updateBaseOpacity(this.baseOpacity)},q.syncAndInitial),q.watch(()=>this.renderingDisabled,()=>this._updateTransparentTerrain(),q.sync),q.watch(()=>this.backgroundColor,b=>{this._handleLayerViewChanges();this._renderer.updateTileBackground(b)},q.syncAndInitial),q.watch(()=>this.view.pointsOfInterest,b=>{this._renderer.pointsOfInterest=b;this._watchUpdatingTracking.removeAll();
b&&this._watchUpdatingTracking.add(()=>b.focus.renderLocation,()=>()=>this._allTilesSorted=!1)}),q.watch(()=>U.TERRAIN_TILE_TREE_SHOW_TILES,b=>{b&&!this._treeDebugger?(new Promise((c,d)=>ca(["../layers/support/TerrainTileTree3DDebugger"],c,d))).then(({TerrainTileTree3DDebugger:c})=>{!this._treeDebugger&&U.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new c({view:this.view}))}):b||(this._treeDebugger=p.destroyMaybe(this._treeDebugger))},q.initial)]);this._extentHelper=Ba.create(this.viewingMode,
{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});a=this.view.defaultsFromMap?new fa({getCollections:()=>{var b,c,d;return null==(b=this.view)?void 0:null==(c=b.defaultsFromMap)?void 0:null==(d=c.mapCollections)?void 0:d.map(({layers:e})=>e)},getChildrenFunction:b=>b&&"layers"in b?b.layers:null}):this.view.map.allLayers;a=new Ja.TilingSchemeLogic({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});
this._set("tilingSchemeLogic",a);this._updateTilingScheme();this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(V.ClientType.ELEVATION);this._mapDataRequester=this.view.resourceController.createStreamDataRequester(V.ClientType.BASEMAP);this._frameTask=this.view.resourceController.scheduler.registerTask(O.TaskPriority.TERRAIN_SURFACE,this);this._handles.add([q.watch(()=>this._extentHelper.stencilEnabledExtents,b=>this._renderer.setStencilEnabledLayerExtents(b),q.initial),
q.watch(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),q.sync),q.watch(()=>this.extent,()=>this._updateRootTiles(),q.initial),this.view.on("resize",()=>this._viewChangeUpdate()),q.watch(()=>{var b,c;const d=this.view,e=d.state;return[this.lodBias,this.lodSnapping,null==(b=d.resourceController)?void 0:null==(c=b.memoryController)?void 0:c.memoryFactor,e.camera,e.contentCamera,e.fixedContentCamera]},()=>this._viewChangeUpdate(),q.syncAndInitial),q.watch(()=>{var b,c;return null==
(b=this.view.qualitySettings)?void 0:null==(c=b.tiledSurface)?void 0:c.textureFadeDuration},b=>this._renderer.textureFadingEnabled=0<b,q.initial),q.watch(()=>this._userClippingExtent,()=>this._updateClippingExtent(),q.sync)]);this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0));this._layerViewsDirty=!0;this._handleLayerViewChanges()};f.destroy=function(){this._frameTask.remove();this._handles.destroy();this._watchUpdatingTracking.destroy();this._lercDecoder=
p.releaseMaybe(this._lercDecoder);this._removeAllTiles();this._upsampleMapCache=p.destroyMaybe(this._upsampleMapCache);this._elevationQueryCache=p.destroyMaybe(this._elevationQueryCache);this._set("tilingSchemeLogic",p.destroyMaybe(this.tilingSchemeLogic));this._extentHelper=p.destroyMaybe(this._extentHelper);this._basemapLayerViewHandles.forEach((a,b)=>this._unregisterTiledLayerView(b));this._mapDataRequester=this._elevationDataRequester=null;this._set("overlayManager",p.destroyMaybe(this.overlayManager));
this._tilePool=p.destroyMaybe(this._tilePool);X.Tile.prune();this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null);this._renderer=p.destroyMaybe(this._renderer);this._iteratorPool=p.destroyMaybe(this._iteratorPool);this._set("view",null);this._upsampleInfoPool=p.destroyMaybe(this._upsampleInfoPool);xa.printAllocations();Ia.printAllocations()};f._updateTransparentTerrain=function(){var a,b;const c=!this.renderingDisabled&&!this.opaque;null==(a=this.view)?void 0:null==(b=a._stage)?
void 0:b.renderView.setRenderParameters({transparentTerrain:c})};f.intersect=function(a,b,c,d){this._renderer.intersect(a,b,c,d)};f.getElevation=function(a,b,c,d){a=this.getTileWithElevation(a,b,c,d,w);return p.isNone(a)?null:W.sampleElevation(w[0],w[1],a.renderData.geometryState.samplerData)};f.getTileWithElevation=function(a,b,c,d,e=w){var g;const h=this.rootTiles;if(p.isNone(h)||!h.length||0===h[0].layerInfo[x.LayerClass.ELEVATION].length)return null;e[0]=a;e[1]=b;e[2]=c;if(!G.projectVectorToVector(e,
d,e,null==(g=this.tilingScheme)?void 0:g.spatialReference))return A.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let l of h)if(l.containsPoint(e)){for(;l&&!l.rendered&&!l.isLeaf;)a=0,e[0]>.5*(l.extent[0]+l.extent[2])&&(a+=1),e[1]<.5*(l.extent[1]+l.extent[3])&&(a+=2),l=l.children[a];if((e=l.renderData)&&e.geometryState.samplerData)return l;break}return null};f.getScale=function(a){if(this.tilingScheme){if(!G.projectPointToVector(a,
w,this.spatialReference))return A.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;a=this.rootTiles;if(p.isSome(a))for(let c of a){var b;if(null!=(b=c)&&b.containsPoint(w)){for(;!c.isLeaf&&!c.rendered;)b=0,w[0]>c.children[0].extent[2]&&(b+=1),w[1]<c.children[0].extent[1]&&(b+=2),c=c.children[b];return this._getLodBiasCorrectedScale(c.level)}}}return 1E100};f.getSphereElevationBounds=function(a,b,c,d,e){var g;w[0]=a;w[1]=b;w[2]=c;w[3]=d;if(!G.projectVectorToVector(w,
e,w,null==(g=this.tilingScheme)?void 0:g.spatialReference))return A.error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let h=Infinity,l=-Infinity;const r=v=>{if(v&&z.intersectsSphere(v.extent,w))if(v.isLeaf||v.rendered)h=Math.min(h,v.elevationBounds[0]),l=Math.max(l,v.elevationBounds[1]);else for(const F of v.children)r(F)};a=this.rootTiles;if(p.isSome(a))for(const v of a)r(v);return{min:h,max:l}};f.getSphereScale=function(a,b){if(!this.tilingScheme)return null;
if(!G.projectPointToVector(a,w,this.spatialReference))return A.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;w[3]=b;let c=null;const d=e=>{if(e&&z.intersectsSphere(e.extent,w))if(e.isLeaf||e.rendered)e=this._getLodBiasCorrectedScale(e.level),c=null==c?e:Math.min(c,e);else for(const g of e.children)d(g)};a=this.rootTiles;if(p.isSome(a))for(const e of a)d(e);return c};f.queryVisibleScaleRange=function(a,b,c,d){b=b?this.tilingScheme.levelAtScale(b):
0;c=c?this.tilingScheme.levelAtScale(c):Infinity;const e=this.lodBias;this._renderer.queryVisibleLevelRange(a,b+e,c+e,d)};f._updateBaseOpacity=function(a){const b=this._renderer.opaque;this._renderer.opaque=1<=a&&!this.hasCompositeBlendMode;this._renderer.isTransparent=this._allSurfaceLayersTransparent();(a=b!==this._renderer.opaque)&&this._updateTransparentTerrain();this._updateTileTextures(a?E.TextureUpdate.UNFADED:E.TextureUpdate.IMMEDIATE)};f._updateTilingScheme=function(){var a,b;const c=this.tilingSchemeLogic.tilingScheme;
c!==this.tilingScheme&&(t.weakAssert(!!c,"tiling scheme cannot be reset to undefined"),this._isGlobal=!(null!=(a=this.view)&&null!=(b=a.state)&&b.isLocal),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",c),this._updateClippingExtent(),c&&(this._updateTiledLayers(),this._renderer.setTileSize(c.pixelSize),this.overlayManager.setSpatialReference(c.spatialReference),this._updateRootTiles()))};f._acquireTile=function(a,b,c,d){const e=this._tilePool.acquire();K[0]=a;K[1]=b;K[2]=c;e.init(K,
d,this);return e};f._updateRootTiles=function(){const {extent:a,tilingScheme:b}=this;if(b){var c=La,d=b.rootTilesInExtent(a,c,5*C.MAX_ROOT_TILES);if(p.isSome(this.rootTiles)){if(d.length>C.MAX_ROOT_TILES){A.warn(C.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}const e=this.rootTiles.map(h=>h.lij),g=ea.difference(e,d,aa);this._updatingRootTiles=!0;if(0<g.removed.length||0<g.added.length){const h=this.rootTiles.filter(l=>-1<g.removed.findIndex(r=>aa(r,l.lij))?(this._purgeTile(l,!0),!1):!0);g.added.forEach(l=>
h.push(this._newRootTile(l)));this._setRootTiles(h)}}else this._updatingRootTiles=!0,d.length>C.MAX_ROOT_TILES&&(A.warn(C.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),d=b.rootTilesInExtent(a,c,C.MAX_ROOT_TILES)),this._setRootTiles(d.map(e=>this._newRootTile(e)));z.equals(c,this._rootTilesExtent)||(this._rootTilesExtent=z.create(c));this.visible=!0;this._viewChangeUpdate();this.overlayManager.setPlacementDirty();this.notifyChange("ready");this._allTiles.forEach(e=>{e.isLoaded&&this._prepareToLoadTile(e)});
this._allTiles.forAll(e=>{e.isLoaded&&(this._updateTileGeometry(e),this._updateTileNeighborsAfterGeometryChange(e))});this._updatingRootTiles=!1;this.checkAllTileWaterproofness()}};f._newRootTile=function(a){a=this._acquireTile(0,a[1],a[2],null);a.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===u.TileUpdate.SPLIT&&a.setPendingUpdate(u.TileUpdate.SPLIT);this._loadTile(a);this.deferTileNeighborUpdate||a.checkGeometryWaterproofness();return a};f._setRootTiles=function(a){this._set("rootTiles",
a);this._allTiles.clear();if(p.isSome(a)){const b=this._iteratorPool.acquire();for(b.reset(a);!b.done;)this._allTiles.push(b.next());b.remove()}this._renderer.setRootTiles(this.rootTiles);this._updateTilesVisibility(a)};f._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())};f._viewChangeUpdate=function(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=
!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this.rootTiles)))};f._updateClippingStatus=function(a){a.updateClippingStatus(this.extent)&&a.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&this._updateTileGeometry(a)};f._updateTilesVisibility=function(a){if(!p.isNone(a)){var b=H.hasLoadableSiblings(a),c=b?this._elevationBounds.min:Infinity;b=b?this._elevationBounds.max:-Infinity;var d=this.view.state.fixedContentCamera,e=this.extent,g=this._viewProjectionMatrix;this.setTileTreeDirty();
var h=this._iteratorPool.acquire();for(h.reset(a);!h.done;){a=h.next();a.updateClippingStatus(e)&&a.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&this._updateTileGeometry(a);a.setPendingUpdate(u.TileUpdate.RENDERDATA);const l=a.computeVisibility();d||l?(a.updateScreenDepth(g),a.renderData&&(c=Math.min(a.elevationBounds[0],c),b=Math.max(a.elevationBounds[1],b))):h.skipSubtree()}h.remove();this._allTilesDirty=this._viewChanged=!0;isFinite(c)&&isFinite(b)&&(this._elevationBounds.min!==c||this._elevationBounds.max!==
b)&&(this._elevationBounds.min=c,this._elevationBounds.max=b,this.emit("elevation-bounds-change",null))}};f._updateViewDependentParameters=function(){const a=this.view.state.camera,b=this.view.state.contentCamera,c=Math.tan(.5*b.fovX),d=Math.tan(.5*b.fovY),e=this.tilingScheme.pixelSize,g=2**-this.lodBias*a.pixelRatio;this._splitLimits.aboveGround=a.aboveGround;this._splitLimits.fovX=c;this._splitLimits.fovY=d;this._splitLimits.relativeWidthLimit=e/a.width*this.maxTextureScale*g;this._splitLimits.relativeHeightLimit=
e/a.height*this.maxTextureScale*g;this._splitLimits.maxLod=this.tilingScheme.getMaxLod();this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias;this.view.state.fixedContentCamera?(p.isNone(this._splitLimits.frustum)&&(this._splitLimits.frustum=J.create()),J.copy(this._splitLimits.frustum,b.frustum)):this._splitLimits.frustum=null;J.copy(this._frustum,a.frustum);ma.multiply(this._viewProjectionMatrix,b.projectionMatrix,b.viewMatrix);oa.copy(this._eyePosRenderSR,b.eye);
G.projectVectorToVector(a.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};f._updateRenderData=function(a){a.rendered&&!a.shouldLoad&&(ba(a)?(this._loadChildren(a),this.deferTileNeighborUpdate||(this._checkTileNeighborsWaterproofness(a),a.children.forEach(b=>b.checkGeometryWaterproofness()))):a.isLeaf&&a.parent&&a.parent.shouldLoad&&this._loadParent(a))};f._updateTileGeometry=function(a){a.updateVisibility();this._renderer.updateTileGeometry(a);this._updateTileNeighborsAfterGeometryChange(a);
this._elevationUpdate(a);this._usedMemory=null;this.deferTileNeighborUpdate&&this.neighborTilesToUpdate.delete(a)};f._updateTileNeighborsAfterGeometryChange=function(a,b){if(this.deferTileNeighborUpdate){const c=this.neighborTilesToUpdate;a.forEachLoadedNeighbor(d=>{c.add(d)})}else a.updateNeighborsAfterGeometryChange(b)};f._updateTileTexture=function(a,b){const c=a.resetPendingUpdate(u.TileUpdate.TEXTURE_FADING)?u.TileUpdate.TEXTURE_FADING:a.resetPendingUpdate(u.TileUpdate.TEXTURE_NOFADING)?u.TileUpdate.TEXTURE_NOFADING:
!1;c&&(this._renderer.updateTileTexture(a,c),this._usedMemory=null,b.madeProgress())};f._elevationUpdate=function(a){L.spatialReference=this.spatialReference;L.tile=a;L.extent=a.extent;this.emit("elevation-change",L)};f.runTask=function(a){this._handleLayerViewChanges(a);this._frameTask.processQueue(a);this._inFrameTask=!0;this._pendingUpdates=0;this._hasPendingUpdates=!1;this._updateTileStatus(a);this._sortTiles(a);const b=!this.view.state.fixedContentCamera;this._mergeAndSplit(a,b);a.run(()=>this._updateElevation(a));
a.run(()=>this._updateTextures(a));b||this._mergeAndSplit(a,!0);this._inFrameTask=!1;this._runViewChangeUpdateIfDirty();a.done?this.requestUpdate():this._usedMemory=this._recalculateUsedMemory();this.notifyChange("updatingProgressValue")};f._updateTileStatus=function(a){if(this._viewChanged&&this.rootTiles&&!a.done){this._viewChanged=!1;var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();if(c.loadable){var d=c.shouldSplit(this._splitLimits,this._eyePosRenderSR,
this.lodSnapping);if(d===u.TileUpdate.SPLIT){c.resetPendingUpdate(u.TileUpdate.MERGE);c.isLeaf&&(c.setPendingUpdate(u.TileUpdate.SPLIT),b.skipSubtree());continue}c.resetPendingUpdate(u.TileUpdate.SPLIT)&&c.updateAgentSuspension();d===u.TileUpdate.VSPLITMERGE&&c.updateAgents(x.LayerClass.ELEVATION)}b.skipSubtree();if(!c.isLeaf){c.setPendingUpdate(u.TileUpdate.MERGE);c.resetPendingUpdate(u.TileUpdate.SPLIT);d=this._iteratorPool.acquire();d.resetOne(c);for(c=d.next();!d.done;c=d.next())this._updateClippingStatus(c),
c.updateVisibility(),c.loadable&&c.updateScreenDepth(this._viewProjectionMatrix);d.remove()}}b.remove();this.requestUpdate();a.madeProgress()}};f._sortTiles=function(a){a.done||this._allTilesSorted||(H.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),a.madeProgress())};f._prepareBatchTileGeometryUpdate=function(){t.internalAssert(0===this.neighborTilesToUpdate.size);this.deferTileNeighborUpdate=!0};
f._batchUpdateUpdatedTileNeighbors=function(){this.deferTileNeighborUpdate=!1;const a=this.neighborTilesToUpdate;(()=>{(()=>{for(const b of a)b.updateNeighborDataAndGeometryIfNeeded()})();(()=>{for(const b of a)b.updateNeighborsWithChangedEdgeResolution()})();a.clear()})()};f._mergeAndSplit=function(a,b){if(!this.suspended&&!a.done&&this._allTilesDirty){this._allTilesDirty=!1;this.requestUpdate();this._prepareBatchTileGeometryUpdate();for(var c=!1;!a.done;){c=!0;let d=!1;const e=!this._allTiles.some(g=>
{if(g.resetPendingUpdate(u.TileUpdate.MERGE)){if(!b)return g.setPendingUpdate(u.TileUpdate.MERGE),a.done;this._mergeTile(g);d=!0;a.madeProgress()}else g.resetPendingUpdate(u.TileUpdate.SPLIT)&&(this._splitTile(g),d=!0,a.madeProgress());!a.done&&g.resetPendingUpdate(u.TileUpdate.RENDERDATA)&&(this._updateRenderData(g),a.madeProgress());return a.done});d&&(this._allTilesSorted=!1,this._allTilesDirty=!0);if(e){if(!d)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}c||(this._allTilesDirty=
!0);this._batchUpdateUpdatedTileNeighbors();this._sortTiles(a)}};f._updateElevation=function(a){this._prepareBatchTileGeometryUpdate();this._allTiles.some(b=>{b.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&(this._updateTileGeometry(b),this._updateTileTexture(b,a),a.madeProgress());return a.done});this._batchUpdateUpdatedTileNeighbors();return a.hasProgressed};f._updateTextures=function(a){this._allTiles.some(b=>{this._updateTileTexture(b,a);return a.done});return a.hasProgressed};f._updateClippingExtent=
function(){this.spatialReference&&(this.updateTileOverlayParams(Z.RenderRequestType.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())};f._getLodBiasCorrectedScale=function(a){const b=this.tilingScheme.levels;a=ka.clamp(a-this.lodBias,0,b.length-1);const c=a-Math.floor(a);return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};f._removeAllTiles=function(){p.isSome(this.rootTiles)&&(this.rootTiles.forEach(a=>this._purgeTile(a,!1)),this._setRootTiles(null),this.notifyChange("ready"));
this._allTiles.clear();this.visible=!1};f._purgeDescendantTiles=function(a){if(a.isLeaf)return!1;let b=!1;for(let c=0;4>c;++c)b=this._purgeTile(a.children[c],!1)||b;a.unsetChildren();return b};f._purgeTile=function(a,b){const c=this._purgeDescendantTiles(a)||a.rendered;this._allTiles.removeUnordered(a);this._unloadTile(a);b&&this._updateTileNeighborsAfterGeometryChange(a);this._tilePool.release(a);return c};f._unloadTile=function(a){this.deferTileNeighborUpdate&&this.neighborTilesToUpdate.delete(a);
a.unload(this._renderer)};f._splitTile=function(a){t.weakAssert(a.isLeaf,"tile that is already split should not be split again!");const b=a.level+1,c=2*a.lij[1],d=2*a.lij[2];a.setChildren(this._createTile(b,c,d,a),this._createTile(b,c,d+1,a),this._createTile(b,c+1,d,a),this._createTile(b,c+1,d+1,a));a.setPendingUpdate(u.TileUpdate.RENDERDATA);a.updateAgentSuspension();this._allTiles.pushArray(a.children);this._allTilesDirty=!0;this._emitTileScaleChange(a,b);++this._performanceInfo.numSplit};f._emitTileScaleChange=
function(a,b=a.level){M.spatialReference=this.spatialReference;M.extent=a.extent;M.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",M)};f._createTile=function(a,b,c,d){t.weakAssert(!!d,"_createTile sanity check");a=this._acquireTile(a,b,c,d);a.updateClippingStatus(this.extent);a.loadable&&(a.updateScreenDepth(this._viewProjectionMatrix),a.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===u.TileUpdate.SPLIT&&a.setPendingUpdate(u.TileUpdate.SPLIT));return a};f._mergeTile=
function(a){t.weakAssert(!a.hasPendingUpdate(u.TileUpdate.SPLIT),"_mergeTile sanity check");this._purgeDescendantTiles(a)&&(t.weakAssert(!a.renderData,"_mergeTile sanity check"),this._loadTile(a),this._updateTileNeighborsAfterGeometryChange(a),this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(a));this._allTilesDirty=!0;++this._performanceInfo.numMerged;this._emitTileScaleChange(a)};f._checkTileAndNeighborsWaterproofness=function(a){a.checkGeometryWaterproofness();this._checkTileNeighborsWaterproofness(a)};
f._checkTileNeighborsWaterproofness=function(a){t.ENABLE_WATERPROOFNESS_TESTS&&a.forallNeighbors(b=>b.isLoaded?(b.checkGeometryWaterproofness(),!0):!1)};f._loadChildren=function(a){this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(a);t.weakAssert(a.rendered,"parent should be rendered");this._unloadTile(a);const b=a.children;b.forEach(c=>this._prepareToLoadTile(c));b.forEach(c=>this._loadTilePrepared(c));this._updateTileNeighborsAfterGeometryChange(a,a.level+1);this.deferTileNeighborUpdate||
(b.forEach(c=>c.updateNeighborsWithChangedEdgeResolution()),b.forEach(c=>c.checkGeometryWaterproofness()),this._checkTileNeighborsWaterproofness(a))};f._loadParent=function(a){this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(a);a=a.parent;this._unloadChildren(a);this._loadTile(a);this._updateTileNeighborsAfterGeometryChange(a);this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(a)};f._unloadChildren=function(a){if(!a.isLeaf)for(let b=0;4>b;++b){const c=a.children[b];
this._unloadChildren(c);this._unloadTile(c)}};f._postLoadTile=function(a){a.setPendingUpdate(u.TileUpdate.RENDERDATA);this.requestUpdate();this._allTilesDirty=!0;this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(a);this._elevationUpdate(a)};f._loadTile=function(a){a.load(this._renderer);this._postLoadTile(a)};f._loadTilePrepared=function(a){a.loadPrepared(this._renderer);this._postLoadTile(a)};f._prepareToLoadTile=function(a){a.prepareToLoad(this._renderer)};
f._elevationDataArrived=function(a,b,c){c=new W.ElevationData(a.lij,a.extent,c);a.dataArrived(b,x.LayerClass.ELEVATION,c);c=[a];a=a.level;const d=this._iteratorPool.acquire();for(d.reset(c);!d.done;){const e=d.next();e.findElevationBoundsForLayer(b,a);e.computeElevationBounds()}d.remove();this._updateTilesVisibility(c)};f._handleLayerViewChanges=function(a=O.noBudget){if(this._layerViewsDirty){var b=this._layerViewsDirty=!1,c=new Set,d=-1;for(const g of this.view.allLayerViews.items)if(c.add(g.uid),
t.isSurfaceLayerView(g))if(this._basemapLayerViewHandles.has(g.uid)){var e=this._layerClassFromLayerView(g);e=this._getLayerIdxByUID(e,g.uid);if(p.isSome(e)){if(e<d||p.isNone(d))b=!0;d=e}}else this._registerTiledLayerView(g),g.layer.loaded&&(b=!0);this._basemapLayerViewHandles.forEach((g,h)=>{c.has(h)||(this._unregisterTiledLayerView(h),b=!0)});b&&this._updateTiledLayers();this._renderer.isTransparent=this._allSurfaceLayersTransparent();this.hasCompositeBlendMode=this._hasCompositeBlendMode();a.madeProgress()}};
f._allSurfaceLayersTransparent=function(){var a,b;let c=0===(null==(a=this.view.map)?void 0:null==(b=a.ground)?void 0:b.opacity);for(const d of this.view.allLayerViews.items)if(t.isMapTileLayerView(d)&&!va.isBaseLayer(d.layer)&&0!==d.fullOpacity){c=!1;break}return c};f._hasCompositeBlendMode=function(){for(const a of this.view.allLayerViews.items)if(t.isBlendableLayerView(a)){const b=t.isGroupLayer(a.layer.parent)?"normal":a.layer.blendMode;if(Y.isCompositeBlendMode(Y.blendModeFromString[b]))return!0}return!1};
f._layerClassFromLayerView=function(a){return t.isElevationLayerView(a)?x.LayerClass.ELEVATION:x.LayerClass.MAP};f._registerTiledLayerView=function(a){const b=[],c=this._layerClassFromLayerView(a);b.push(q.watch(()=>a.suspended,()=>this._updateTiledLayers()));b.push(q.watch(()=>a.fullOpacity,()=>this._updateTileTextures(E.TextureUpdate.UNFADED)));b.push(q.watch(()=>"effectiveScaleRange"in a.layer?a.layer.effectiveScaleRange:null,()=>this._restartAllAgents(c)));t.isBlendableLayerView(a)&&b.push(q.watch(()=>
a.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode();this._updateTileTextures(E.TextureUpdate.UNFADED)}));a.on("data-changed",()=>{const d=this._getLayerIdxByUID(c,a.uid);p.isSome(d)&&this._invalidateLayerData(d,c)});this._basemapLayerViewHandles.set(a.uid,b)};f._unregisterTiledLayerView=function(a){const b=this._basemapLayerViewHandles.get(a);if(b){for(let c=0;c<b.length;c++)b[c].remove();this._basemapLayerViewHandles.delete(a)}};f._updateTiledLayers=function(){if(this.tilingScheme&&
!this.view.suspended){var a=[[],[]],b=null;this.view.allLayerViews.forEach(d=>{if(d.layer&&!d.suspended&&t.isSurfaceLayerView(d)&&d.fullExtent){var e=this._layerClassFromLayerView(d);if(e===x.LayerClass.MAP){const g=d.displayLevelRange.maxLevel;Infinity!==g&&(null===b||g>b)&&(b=g)}a[e].push(d)}});for(const d of x.LayerClasses){var c=this._layerViews[d];const e=a[d];e.reverse();const g=e.length;let h=c.length!==g;const l=Array(g),r=Array(c.length);this._layerIndexByUid[d].clear();for(let v=0;v<g;v++){this._layerIndexByUid[d].set(e[v].uid,
v);const F=c.indexOf(e[v]);l[v]=F;v!==F&&(h=!0);-1<F&&(r[F]=v)}if(h){c=this._postorderIterator;for(c.reset(this.rootTiles);!c.done;)c.next().modifyLayers(r,l,d);this._layerViews[d]=e;this._restartAllAgents(d);this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(b)&&this._viewChangeUpdate()}};f._restartAllAgents=function(a){const b=this._postorderIterator;for(b.reset(this.rootTiles);!b.done;){const c=b.next();c.restartAgents(a);a===x.LayerClass.ELEVATION&&c.computeElevationBounds()}};
f.layerViewByIndex=function(a,b){return this._layerViews[b][a]};f.numLayers=function(a){return this._layerViews[a].length};f._updateTileTextures=function(a){this._allTiles.forAll(b=>{b.updateAgents(x.LayerClass.MAP);a===E.TextureUpdate.IMMEDIATE?this.renderer.updateTileTexture(b,u.TileUpdate.TEXTURE_NOFADING):b.updateRenderData(x.LayerClass.MAP,a)});this._renderer.isTransparent=this._allSurfaceLayersTransparent()};f._invalidateLayerData=function(a,b){this._allTiles.forAll(c=>c.removeLayerAgent(a,
b));this._allTiles.forAll(c=>c.invalidateLayerData(a,b))};f.setTileTreeDirty=function(){this._allTilesDirty=!0};f.requestRender=function(a=Z.RenderRequestType.UPDATE){this.renderer.setNeedsRender(a)};f.requestUpdate=function(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)};f.requestTileData=function(a,b,c,d){const e=this.layerViewByIndex(b,c);b=e.layer;if(!b.tilemapCache||t.isVectorTileLayerView(e))return this._requestTileData(a,c,e,d);++this._asyncWorkItems;return b.tilemapCache.fetchAvailability(a.lij[0],
a.lij[1],a.lij[2],{...d,timeout:6E3}).then(()=>--this._asyncWorkItems).catch(g=>{--this._asyncWorkItems;D.isAbortError(g)||this._dataMissing(a,c,e,{notInTilemap:!0});throw g;}).then(()=>this._frameTask.schedule(()=>this._requestTileData(a,c,e,d),d.signal))};f._requestTileData=function(a,b,c,d){return b===x.LayerClass.ELEVATION?t.isElevationLayerView(c)?this._requestElevationTileData(a,c,d):Promise.reject():t.isMapTileLayerView(c)?this._requestMapTileData(a,c,d):Promise.reject()};f._requestElevationTileData=
function(a,b,c){++this._asyncWorkItems;const d=h=>{if(!D.isAborted(c)){var l=this._layerIndexByUid[x.LayerClass.ELEVATION].get(b.uid);null==l?A.warn("TerrainSurface: received data from unknown layer %d %s",x.LayerClass.ELEVATION,a.lij.toString()):(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(a,l,h))}},e=h=>{D.isAbortError(h)||(this._dataMissing(a,x.LayerClass.ELEVATION,b,h),this.requestUpdate())};if(t.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],
a.lij[2],{noDataValue:C.ELEVATION_NODATA_VALUE,signal:c.signal}).then(h=>{if(D.isAborted(c))A.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.");else return this._frameTask.schedule(()=>d(h),c.signal,e)},e).finally(()=>{--this._asyncWorkItems});const g=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._elevationDataRequester.request(g,"binary",c).then(h=>this._lercDecoder.decode(h,{noDataValue:C.ELEVATION_NODATA_VALUE},
c.signal)).then(h=>{h?d({values:h.pixelData,width:h.width,height:h.height,noDataValue:h.noDataValue,minValue:h.minValue,maxValue:h.maxValue}):e(Error("LERC decoding failed"))},e).finally(()=>{--this._asyncWorkItems})};f._requestMapTileData=function(a,b,c){++this._asyncWorkItems;const d=(r,v)=>{--this._asyncWorkItems;t.releaseTileData(v);D.isAborted(c)||(this._dataMissing(a,x.LayerClass.MAP,b,r),this.requestUpdate())},e=r=>v=>d(v,r),g=r=>this._frameTask.schedule(()=>{--this._asyncWorkItems;this.requestUpdate();
D.isAborted(c)?t.releaseTileData(r):this._mapTileDataArrived(a,b,r)},c.signal,e(r)).catch(e(r)),h=(r,v=null)=>this._frameTask.schedule(()=>d(r,v));if(t.isVectorTileLayerView(b)){var l=b.schemaHelper.getLevelRowColumn(a.lij);return b.fetchTile(l[0],l[1],l[2],c).then(g,h)}if(t.isImageryTileLayerView(b))return b.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(g,h);if(t.isTileLayerView(b)&&t.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(r=>{D.isAborted(c)?(A.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),
h(D.createAbortError())):g(r)},h);l=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);ta.isRefreshableLayer(b.layer)&&b.layer.refreshTimestamp&&(l+=`${l.includes("?")?"\x26":"?"}_ts=${b.layer.refreshTimestamp}`);return this._mapDataRequester.request(l,b.hasMixedImageFormats?"image+type":"image",c).then(g,h)};f._mapTileDataArrived=function(a,b,c){b=this._getLayerIdxByUID(x.LayerClass.MAP,b.uid);p.isSome(b)?a.dataArrived(b,x.LayerClass.MAP,c):(t.releaseTileData(c),A.warn("TerrainSurface: received data from unknown layer"))};
f._getLayerIdxByUID=function(a,b){return this._layerIndexByUid[a].get(b)};f._dataMissing=function(a,b,c,d){c=this._getLayerIdxByUID(b,c.uid);p.isSome(c)?a.dataMissing(c,b,d):A.warn("TerrainSurface: received data from unknown layer")};f.updateTileOverlayParams=function(a){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(b=>{b.renderData&&this.overlayManager.setTileParameters(b)}),this._renderer.setNeedsRender(a))};f.getUsedMemory=function(){if(!this.tilingScheme)return 0;p.isNone(this._usedMemory)&&
(this._usedMemory=this._recalculateUsedMemory());return p.isSome(this._usedMemory)?this._usedMemory:0};f._recalculateUsedMemory=function(){return this.tilingScheme?this._allTiles.reduce((a,b)=>a+b.usedMemory,0):null};f.getUsedMemoryForLayerView=function(a){let b=0;const c=this._layerClassFromLayerView(a),d=this._getLayerIdxByUID(c,a.uid);p.isSome(d)&&this._allTiles.forAll(e=>b+=e.getUsedMemoryForLayer(c,d));return b};f.getTile=function(a){if(p.isNone(a)||p.isNone(this.rootTiles))return null;const b=
a.split("/").map(g=>+g);if(0===b[0])return this.rootTiles.find(g=>g.lij[1]===b[1]&&g.lij[2]===b[2]);a=2**b[0];const c=Math.floor(b[1]/a),d=Math.floor(b[2]/a);let e;this.rootTiles.some(g=>g.lij[1]===c&&g.lij[2]===d?(e=g,!0):!1);if(e){for(a=1<<b[0]-1;e.lij[0]<b[0];){let g=b[1]&a?2:0;0<(b[2]&a)&&g++;if(!e.children[g])return null;e=e.children[g];a>>=1}t.weakAssert(e.lij[0]===b[0]&&e.lij[1]===b[1]&&e.lij[2]===b[2],"not the right tile?");return e}return null};f.checkAllTileWaterproofness=function(){if(t.ENABLE_WATERPROOFNESS_TESTS){var a=
this.rootTiles;if(!p.isNone(a)){var b=e=>{var g,h,l,r;return null!=(g=0<(null==e?void 0:null==(h=e.renderData)?void 0:null==(l=h.geometryInfo)?void 0:null==(r=l.indices)?void 0:r.length))?g:!1},c=e=>{var g,h,l;e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState");e.renderData&&!e.renderData.geometryInfo&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo");null==(g=e.renderData)||!g.geometryInfo||0<(null!=(h=null==(l=e.renderData.geometryInfo.indices)?
void 0:l.length)?h:0)||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometryInfo);if(b(e)){e.checkGeometryWaterproofness();for(const r of e.children)g=r,h=e,b(g)&&console.error("Tile[",g.lij,"] has geometry although parent[",h.lij,"] has geom")}else if(e.isLeaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const r of e.children)c(r)},d=e=>{var g,h;const l=null!=(g=null==(h=e.parent)?void 0:h.visible)?g:!0;
g=e.visible;e.computeVisibility();h=e.visible;g!==h&&l&&console.error(" Tile[",e.lij,"] has out of date visibility: ",g," instead of ",h);if(!e.isLeaf)for(const r of e.children)d(r)};for(const e of a)c(e),d(e)}}};f.isEastEndWrap=function(a){return this.isGlobal&&a[2]===this.lijEastEnd(a[0])-1};f.isWestEndWrap=function(a){return this.isGlobal&&0===a[2]};f.lijEastEnd=function(a){return 2**(a+(this.spatialReference.isGeographic?1:0))};f.wrapEastWest=function(a){const b=this.lijEastEnd(a[0]),c=a[2];return 0<=
c&&c<b?a:this.isGlobal?[a[0],a[1],(c+(0>c?b:0))%b]:null};Q._createClass(y,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){var a,b,c=null==(a=this.view.pointsOfInterest)?void 0:null==(b=a.contentCameraOnSurface)?void 0:b.scale;c&&(a=this.view.state.contentCamera,a=T.directionToHeadingTilt(this.view,a.eye,a.viewForward,a.up).tilt,90<a&&(a=180-a),a=2*(a/90)**2,c=T.scaleToZoom(this.view,c)-a,.25<Math.abs(this._snapLevel-
c)&&(Math.round(c)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=c));return Math.round(this._snapLevel)}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?E.LODSnapping.ON:E.LODSnapping.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",
get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){var {spatialReference:a}=this,{clippingArea:b}=this.view;if(p.isNone(b)||p.isNone(a))return null;const c=z.create();a=ya.toBoundingRect(b,c,a)?c:null;b=this._get("extent");return z.equals(a,b)?b:a}},{key:"rootTilesExtent",get:function(){return this._rootTilesExtent}},{key:"extent",get:function(){const a=z.intersection(this.groundExtent,this._userClippingExtent,z.create()),b=this._get("extent");return z.equals(a,
b)?b:a}},{key:"groundExtent",get:function(){return p.isSome(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){var a;return null==(a=this.tilingSchemeLogic)?void 0:a.extent}},{key:"updating",get:function(){this._hasPendingUpdates||(this._maxNumUpdating=1);return!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||0<this._asyncWorkItems||!this._allTilesSorted||this._layerViewsDirty)&&
this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}},{key:"updatingProgressValue",get:function(){this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating);return 1-this._pendingUpdates/this._maxNumUpdating}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return p.isSome(this.rootTiles)}},{key:"renderOrder",set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)}},{key:"spatialReference",
get:function(){var a,b;return null!=(a=null==(b=this.tilingScheme)?void 0:b.spatialReference)?a:null}},{key:"slicePlaneEnabled",set:function(a){this._renderer.slicePlaneEnabled=a;this._set("slicePlaneEnabled",a);this._updateTransparentTerrain()}},{key:"velvetOverground",set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOverground=a);this._set("velvetOverground",a)}},{key:"visible",set:function(a){a!==this._visible&&(this._visible=a,this._renderer.setVisibility(a),this.suspended=!a)}},
{key:"opaque",get:function(){return this._renderer.opaque}},{key:"suspended",set:function(a){this._set("suspended",a);this._viewChangeUpdate()}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"updatingRootTiles",get:function(){return this._updatingRootTiles}},{key:"running",get:function(){return this.updating&&this.ready&&!this.suspended}},{key:"lodBias",get:function(){return this.view.qualitySettings.tiledSurface.lodBias-(1-this.view.resourceController.memoryController.memoryFactor)*
C.MAX_MEMORY_LOD_BIAS}},{key:"performanceInfo",get:function(){const a=this._performanceInfo;a.numNodes=this._allTiles.length;a.numLeaves=a.numVisible=a.numRendered=a.numLoadedPerLevel.length=a.numRenderedPerLevel.length=0;this._allTiles.forAll(b=>{b.isLeaf&&a.numLeaves++;const c=b.level;b.renderData&&(a.numLoadedPerLevel[c]=(a.numLoadedPerLevel[c]||0)+1);b.visible&&(a.numVisible++,b.rendered&&(a.numRenderedPerLevel[c]=(a.numRenderedPerLevel[c]||0)+1,a.numRendered++))});return a}},{key:"test",get:function(){const a=
this;return{renderer:a._renderer,lercDecoder:a._lercDecoder,forceReload:()=>{p.isSome(a.rootTiles)&&(a._mergeTile(a.rootTiles[0]),a._viewChangeUpdate())},getTiles:()=>a._allTiles.toArray(),getRenderedTiles(){P.clear();a._allTiles.forAll(c=>{c.visible&&c.rendered&&P.push(c)});const b=P.toArray();H.sortTiles(a.renderOrder,b);return b},lockTilingScheme(b,c){a._extentHelper.defaultTiledLayersExtent=c;a.tilingSchemeLogic.test.lockTilingScheme(b)}}}},{key:"isGlobal",get:function(){return this._isGlobal}},
{key:"shadingEnabled",get:function(){return this._renderer.shadingEnabled}},{key:"isWebMercator",get:function(){var a;return!(null==(a=this.tilingScheme)||!a.spatialReference.isWebMercator)}},{key:"isWebMercatorOnPlateeCarree",get:function(){var a;return this.isWebMercator&&sa.isPlateCarree(null==(a=this.view)?void 0:a.renderSpatialReference)}}]);return y}(ha.EventedMixin(k));m.__decorate([n.property()],k.prototype,"_renderer",void 0);m.__decorate([n.property()],k.prototype,"_hasPendingUpdates",void 0);
m.__decorate([n.property()],k.prototype,"_asyncWorkItems",void 0);m.__decorate([n.property()],k.prototype,"_allTilesDirty",void 0);m.__decorate([n.property()],k.prototype,"_allTilesSorted",void 0);m.__decorate([n.property()],k.prototype,"_viewChanged",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0);m.__decorate([n.property()],k.prototype,"_frameTask",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"snapLevel",null);m.__decorate([n.property({readOnly:!0})],
k.prototype,"lodSnapping",null);m.__decorate([n.property({constructOnly:!0})],k.prototype,"view",void 0);m.__decorate([n.property()],k.prototype,"_userClippingExtent",null);m.__decorate([n.property()],k.prototype,"_rootTilesExtent",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"extent",null);m.__decorate([n.property({readOnly:!0})],k.prototype,"groundExtent",null);m.__decorate([n.property({readOnly:!0})],k.prototype,"_tilingSchemeExtent",null);m.__decorate([n.property({readOnly:!0})],
k.prototype,"updating",null);m.__decorate([n.property(za.updatingProgress)],k.prototype,"updatingProgress",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"updatingProgressValue",null);m.__decorate([n.property()],k.prototype,"_maxNumUpdating",void 0);m.__decorate([n.property({aliasOf:"view.map.ground.opacity"})],k.prototype,"baseOpacity",void 0);m.__decorate([n.property()],k.prototype,"hasCompositeBlendMode",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"overlayManager",
void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"viewingMode",null);m.__decorate([n.property()],k.prototype,"maxTextureScale",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"ready",null);m.__decorate([n.property({value:Ea.RenderOrder.FRONT_TO_BACK})],k.prototype,"renderOrder",null);m.__decorate([n.property({readOnly:!0})],k.prototype,"rootTiles",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"spatialReference",null);m.__decorate([n.property({type:da,aliasOf:"view.map.ground.surfaceColor"})],
k.prototype,"backgroundColor",void 0);m.__decorate([n.property({value:!1})],k.prototype,"slicePlaneEnabled",null);m.__decorate([n.property({readOnly:!0})],k.prototype,"tilingScheme",void 0);m.__decorate([n.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],k.prototype,"tilingSchemeLocked",void 0);m.__decorate([n.property({readOnly:!0})],k.prototype,"tilingSchemeLogic",void 0);m.__decorate([n.property({value:!0})],k.prototype,"velvetOverground",null);m.__decorate([N.aliasOf("_renderer.wireframe")],
k.prototype,"wireframe",void 0);m.__decorate([n.property({value:!1})],k.prototype,"suspended",null);m.__decorate([n.property({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],k.prototype,"textureFadeDuration",void 0);m.__decorate([n.property()],k.prototype,"_layerViewsDirty",void 0);m.__decorate([N.aliasOf("_renderer.renderPatchBorders")],k.prototype,"renderPatchBorders",void 0);m.__decorate([N.aliasOf("_renderer.renderingDisabled")],k.prototype,"renderingDisabled",void 0);
m=k=m.__decorate([la.subclass("esri.views.3d.terrain.TerrainSurface")],k);const w=pa.create(),La=z.create(),K=[0,0,0],P=new R,L={spatialReference:null,tile:null,extent:null,context:"ground"},M={spatialReference:null,extent:null,scale:0};return m});