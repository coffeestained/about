// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Evented ../../../core/Handles ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/reactiveUtils ../../../core/SetUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/vec3f64 ../../ViewingMode ../layers/interfaces ../support/debugFlags ./interfaces ./Overlay ./OverlayFramebufferObject ./OverlayRenderTarget ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/AutoDisposable ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/Camera ../webgl-engine/lib/GLMaterialRepository ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/Material ../webgl-engine/lib/RenderContext ../webgl-engine/lib/RenderPass ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/ShadowMap ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/SSAOHelper ../webgl-engine/lib/TextureTechnique ../webgl-engine/lib/TextureTechniqueConfiguration ../webgl-engine/lighting/Lightsources ../webgl-engine/materials/StippleTextureRepository ../webgl-engine/shaders/CompositingTechniqueConfiguration ../../support/Scheduler ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(f,C,n,R,S,T,z,g,U,t,D,u,ta,ua,va,V,K,W,X,A,L,y,M,Y,Z,aa,E,N,ba,ca,O,da,ea,fa,B,F,ha,ia,ja,ka,la,ma,na,P,G,p,oa,pa){f.OverlayRenderer=function(l){function v(a){a=l.call(this,a)||this;a._overlays=null;a._overlayRenderTarget=null;a._hasHighlights=!1;a._rendersOccluded=!1;a._hasWater=!1;a._handles=new T;a._frameTask=G.ImmediateTask;a._drapeSourceRenderers=new Map;a._sortedDrapeSourceRenderersDirty=!1;a._sortedDrapeSourceRenderers=new U;a._rctx=null;a._materialRepository=null;a._screenToWorldRatio=
1;a._localOriginFactory=null;a.worldToPCSRatio=1;a.events=new S;a.longitudeCyclical=null;return a}C._inheritsLoose(v,l);var d=v.prototype;d.initialize=function(){const a=this.view._stage.renderView;this._rctx=a.renderingContext;const b=a.waterTextureRepository;this._stippleTextureRepository=new na.StippleTextureRepository(a.renderingContext);this._shaderTechniqueRepository=new aa.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:X.ViewingMode.Local,stippleTextureRepository:this._stippleTextureRepository,
waterTextureRepository:b});this._renderContext=new fa.OverlayRenderContext(this._rctx,new ha.ShadowMap(this._rctx,this.view.state.viewingMode),new ja.SSAOHelper(this._shaderTechniqueRepository,this._rctx,()=>{}));this._handles.add([t.watch(()=>b.updating,()=>this.events.emit("content-changed"),t.syncAndInitial),t.watch(()=>this.spatialReference,c=>this._localOriginFactory=new da.GridLocalOriginFactory(c),t.syncAndInitial),t.on(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=
!0)]);this._materialRepository=new ca.GLMaterialRepository(a.textureRepository,this._shaderTechniqueRepository,c=>{0<(c.renderOccluded&H)!==this._rendersOccluded&&this._updateRendersOccluded();this.events.emit("content-changed");this.notifyChange("updating")},()=>this.events.emit("content-changed"));this._bindParameters.slot=F.RenderSlot.DRAPED_MATERIAL;this._bindParameters.highlightDepthTexture=O.createEmptyDepthTexture(this._rctx);this._bindParameters.camera=q;this._bindParameters.transparencyPassType=
N.TransparencyPassType.NONE;this._bindParameters.lighting.groundLightingFactor=1;this._bindParameters.lighting.globalFactor=0;this._bindParameters.lighting.set([new ma.AmbientLight(W.fromValues(1,1,1))]);this._frameTask=this.view.resourceController.scheduler.registerTask(G.TaskPriority.STAGE,this);this._handles.add(this._frameTask)};d.dispose=function(){this._handles.destroy();this._drapeSourceRenderers.forEach(a=>a.destroy());this._drapeSourceRenderers.clear();this._debugTextureTechnique=g.releaseMaybe(this._debugTextureTechnique);
this._debugPatternTexture=g.disposeMaybe(this._debugPatternTexture);this._bindParameters.highlightDepthTexture=g.disposeMaybe(this._bindParameters.highlightDepthTexture);this._shaderTechniqueRepository=g.disposeMaybe(this._shaderTechniqueRepository);this._temporaryFBO=g.disposeMaybe(this._temporaryFBO);this._quadVAO=g.disposeMaybe(this._quadVAO);this.disposeOverlays()};d.createGeometryDrapeSourceRenderer=function(a){return this.createDrapeSourceRenderer(a,ia.SortedRenderGeometryRenderer)};d.createDrapeSourceRenderer=
function(a,b,c){const e=this._drapeSourceRenderers.get(a);g.isSome(e)&&e.destroy();b=new b({...c,rendererContext:this,drapeSource:a});this._drapeSourceRenderers.set(a,b);this._sortedDrapeSourceRenderersDirty=!0;"fullOpacity"in a&&this._handles.add(t.watch(()=>a.fullOpacity,()=>this.events.emit("content-changed")),a);return b};d.removeDrapeSourceRenderer=function(a){if(!g.isNone(a)){var b=this._drapeSourceRenderers.get(a);g.isNone(b)||(this._sortedDrapeSourceRenderersDirty=!0,this._drapeSourceRenderers.delete(a),
this._handles.remove(a),b.destroy())}};d.collectUnusedRenderTargetMemory=function(a){let b=!1;if(g.isSome(this._overlayRenderTarget))for(const c of this._overlayRenderTarget.renderTargets)b=this._overlayRenderTarget.validateUsageForTarget(this.overlays[0].validTargets[c.type]||!this.overlays[1].validTargets[c.type],c,a)||b;return b};d.ensureDrapeTargets=function(a){g.isSome(this._overlays)&&this._overlays.forEach(b=>{b.hasTargetWithoutRasterImage=D.someSet(a,c=>c.drapeTargetType===A.DrapeTargetType.WithoutRasterImage)})};
d.ensureDrapeSources=function(a){g.isSome(this._overlays)&&this._overlays.forEach(b=>{b.hasDrapedFeatureSource=D.someSet(a,c=>c.drapeSourceType===A.DrapeSourceType.Features);b.hasDrapedRasterSource=D.someSet(a,c=>c.drapeSourceType===A.DrapeSourceType.RasterImage)})};d.ensureOverlays=function(a,b){g.isNone(this._overlays)&&(this._overlayRenderTarget=new Z.OverlayRenderTarget(this._rctx),this._overlays=[new M.Overlay(y.OverlayIndex.INNER,this._overlayRenderTarget),new M.Overlay(y.OverlayIndex.OUTER,
this._overlayRenderTarget)]);this.ensureDrapeTargets(a);this.ensureDrapeSources(b)};d.disposeOverlays=function(){this._overlays=null;this._overlayRenderTarget=g.disposeMaybe(this._overlayRenderTarget);this.events.emit("textures-disposed")};d.runTask=function(a,b=()=>!0){this._frameTask.processQueue(a);a.done||this._processDrapeSources(a,b)};d._processDrapeSources=function(a,b){let c=!1;for(const [e,h]of this._drapeSourceRenderers){if(a.done)break;(e.destroyed||b(e))&&h.commitChanges()&&(c=!0,a.madeProgress())}this._updateSortedDrapeSourceRenderers();
c&&(g.isSome(this._overlays)&&0===this._drapeSourceRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())};d.processSyncDrapeSources=function(){this._processDrapeSources(G.noBudget,a=>a.updatePolicy===N.UpdatePolicy.SYNC)};d.isEmpty=function(){if(L.OVERLAY_DRAW_DEBUG_TEXTURE)return!1;for(const a of this._drapeSourceRenderers.values())if(!a.isEmpty)return!1;return!0};
d.updateAnimation=function(a){let b=!1;this._drapeSourceRenderers.forEach(c=>b=c.updateAnimation(a)||b);return b};d.updateDrapeSourceOrder=function(){this._sortedDrapeSourceRenderersDirty=!0};d.drawTarget=function(a,b,c){const e=a.canvasGeometries;if(0===e.numViews)return!1;this._screenToWorldRatio=c*a.mapUnitsPerPixel;const h=b.renderPass;if(this.isEmpty()||h===B.RenderPass.MATERIAL_HIGHLIGHT&&!this.hasHighlights||h===B.RenderPass.MATERIAL_NORMAL&&!this.hasWater||!a.hasSomeSizedView())return!1;const k=
b.fbo;if(!k.isValid())return!1;const m=2*a.resolution,r=a.resolution;k.resize(m,r);const w=this._rctx;q.pixelRatio=a.pixelRatio*c;this._renderContext.pass=h;this._bindParameters.screenToWorldRatio=this._screenToWorldRatio;this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio;this._bindParameters.slot=h===B.RenderPass.MATERIAL_NORMAL?F.RenderSlot.DRAPED_WATER:F.RenderSlot.DRAPED_MATERIAL;a.applyViewport(this._rctx);k.bind(w);a.index===y.OverlayIndex.INNER&&(w.setClearColor(0,
0,0,0),w.clearSafe(p.ClearBufferBit.COLOR_BUFFER_BIT));const I=b.type===y.RenderTargetType.ColorNoRasterImage?f.DrawPassOption.ExcludeRasterImage:b.type===y.RenderTargetType.Occluded?f.DrawPassOption.OccludedOnly:f.DrawPassOption.Normal;I===f.DrawPassOption.OccludedOnly&&(this._renderContext.renderOccludedMask=H);if(L.OVERLAY_DRAW_DEBUG_TEXTURE&&I!==f.DrawPassOption.OccludedOnly)for(b=0;b<e.numViews;b++)this._setViewParameters(e.extents[b],a,q),this._drawDebugTexture(a.resolution,qa[a.index]);0<this._drapeSourceRenderers.size&&
this._sortedDrapeSourceRenderers.forAll(({drapeSource:x,renderer:ra})=>{if(I!==f.DrawPassOption.ExcludeRasterImage||x.drapeSourceType!==A.DrapeSourceType.RasterImage){({fullOpacity:x}=x);var Q=g.isSome(x)&&1>x&&h===B.RenderPass.MATERIAL;Q&&(this.bindTemporaryFramebuffer(this._rctx,m,r),w.clearSafe(p.ClearBufferBit.COLOR_BUFFER_BIT));for(let J=0;J<e.numViews;J++)this._setViewParameters(e.extents[J],a,q),ra.render(this._renderContext,this._bindParameters);Q&&g.isSome(this._temporaryFBO)&&(k.bind(w),
this.view._stage.renderView.compositingHelper.composite(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),P.AlphaMode.PremultipliedAlpha,x,P.CompositingFunction.OverlayWithTransparency,a.index))}});w.bindFramebuffer(null);k.generateMipMap();this._renderContext.resetRenderOccludedMask();return!0};d.bindTemporaryFramebuffer=function(a,b,c){g.isNone(this._temporaryFBO)&&(this._temporaryFBO=new Y.OverlayFramebufferObject(a,!1));this._temporaryFBO.resize(b,c);this._temporaryFBO.bind(a)};
d.reloadShaders=function(){var a=C._asyncToGenerator(function*(){yield this._shaderTechniqueRepository.reloadAll()});return function(){return a.apply(this,arguments)}}();d.notifyContentChanged=function(){this.events.emit("content-changed")};d.intersect=function(a,b,c,e){let h=0;for(const m of this._drapeSourceRenderers.values()){var k;h=null!=(k=null==m.intersect?void 0:m.intersect(a,b,c,e,h))?k:h}};d._updateSortedDrapeSourceRenderers=function(){if(this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=
!1,this._sortedDrapeSourceRenderers.clear(),0!==this._drapeSourceRenderers.size)){var a=this.view.map.allLayers;this._drapeSourceRenderers.forEach((b,c)=>{const e=a.indexOf(c.layer);this._sortedDrapeSourceRenderers.push(new sa(c,b,0>e?Infinity:e))});this._sortedDrapeSourceRenderers.sort((b,c)=>b.index-c.index)}};d._setViewParameters=function(a,b,c){c.viewport[0]=c.viewport[1]=0;c.viewport[2]=c.viewport[3]=b.resolution;K.ortho(c.projectionMatrix,0,a[2]-a[0],0,a[3]-a[1],c.near,c.far);K.fromTranslation(c.viewMatrix,
[-a[0],-a[1],0]);this._bindParameters.camera=c};d._updateHasWater=function(){const a=z.someMap(this._drapeSourceRenderers,b=>b.hasWater);a!==this._hasWater&&(this._hasWater=a,this.events.emit("has-water",a))};d._updateHasHighlights=function(){const a=z.someMap(this._drapeSourceRenderers,b=>b.hasHighlights);a!==this._hasHighlights&&(this._hasHighlights=a,this.events.emit("has-highlights",a))};d._updateRendersOccluded=function(){const a=z.someMap(this._drapeSourceRenderers,b=>b.rendersOccluded);a!==
this._rendersOccluded&&(this._rendersOccluded=a,this.events.emit("renders-occluded",a))};d._drawDebugTexture=function(a,b){this._ensureDebugPatternResources(a,a);a=this._rctx;const c=a.bindTechnique(this._debugTextureTechnique);c.setUniform4f("uColor",b[0],b[1],b[2],1);c.bindTexture("tex",this._debugPatternTexture);a.bindVAO(this._quadVAO);a.drawArrays(p.PrimitiveType.TRIANGLE_STRIP,0,pa.vertexCount(this._quadVAO,"geometry"))};d._ensureDebugPatternResources=function(a,b){if(!this._debugPatternTexture){var c=
new Uint8Array(a*b*4),e=0;for(let h=0;h<b;h++)for(let k=0;k<a;k++){const m=Math.floor(k/10),r=Math.floor(h/10);2>m||2>r||10*m>a-20||10*r>b-20?(c[e++]=255,c[e++]=255,c[e++]=255,c[e++]=255):(c[e++]=255,c[e++]=255,c[e++]=255,m&1&&r&1?c[e++]=k&1^h&1?0:255:c[e++]=m&1^r&1?0:128)}this._debugPatternTexture=new oa.Texture(this._rctx,{target:p.TextureType.TEXTURE_2D,pixelFormat:p.PixelFormat.RGBA,dataType:p.PixelType.UNSIGNED_BYTE,samplingMode:p.TextureSamplingMode.NEAREST,width:a,height:b},c);a=new la.TextureTechniqueConfiguration;
a.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(ka.TextureTechnique,a);this._quadVAO=O.createQuadVAO(this._rctx)}};C._createClass(v,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"rctx",get:function(){return this._rctx}},{key:"materialRepository",get:function(){return this._materialRepository}},{key:"screenToWorldRatio",get:function(){return this._screenToWorldRatio}},{key:"localOriginFactory",get:function(){return this._localOriginFactory}},
{key:"updating",get:function(){return this._sortedDrapeSourceRenderersDirty||this._frameTask.updating||z.someMap(this._drapeSourceRenderers,a=>a.updating)}},{key:"hasOverlays",get:function(){return g.isSome(this._overlays)&&g.isSome(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return g.isSome(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return g.unwrapOr(this._overlays,[])}},{key:"running",get:function(){return this.updating}},
{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{drapeSourceRenderers:this._drapeSourceRenderers,getDrapeSourceRenderer:a=>this._drapeSourceRenderers.get(a)}}}]);return v}(E.AutoDisposableMixin(R));n.__decorate([u.property()],f.OverlayRenderer.prototype,"_frameTask",void 0);n.__decorate([u.property()],f.OverlayRenderer.prototype,
"_sortedDrapeSourceRenderersDirty",void 0);n.__decorate([E.autoDispose()],f.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0);n.__decorate([E.autoDispose()],f.OverlayRenderer.prototype,"_stippleTextureRepository",void 0);n.__decorate([u.property({constructOnly:!0})],f.OverlayRenderer.prototype,"view",void 0);n.__decorate([u.property()],f.OverlayRenderer.prototype,"worldToPCSRatio",void 0);n.__decorate([u.property()],f.OverlayRenderer.prototype,"spatialReference",void 0);n.__decorate([u.property({type:Boolean,
readOnly:!0})],f.OverlayRenderer.prototype,"updating",null);f.OverlayRenderer=n.__decorate([V.subclass("esri.views.3d.terrain.OverlayRenderer")],f.OverlayRenderer);f.DrawPassOption=void 0;(function(l){l[l.Normal=0]="Normal";l[l.OccludedOnly=1]="OccludedOnly";l[l.ExcludeRasterImage=2]="ExcludeRasterImage"})(f.DrawPassOption||(f.DrawPassOption={}));let sa=function(l,v,d){this.drapeSource=l;this.renderer=v;this.index=d};const qa=[[1,.5,.5],[.5,.5,1]],q=new ba.Camera;q.near=1;q.far=1E4;q.relativeElevation=
null;const H=ea.RenderOccludedFlag.OccludeAndTransparent;f.DRAPED_Z=-2;f.overlayRenderOccludedFlag=H;Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});