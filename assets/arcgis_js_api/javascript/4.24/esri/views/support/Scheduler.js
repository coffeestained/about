// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/Handles ../../core/Logger ../../core/maybe ../../core/PerformanceSampler ../../core/PooledArray ../../core/promiseUtils ../../core/reactiveUtils ../../core/time ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/support/PromiseQueue ./debugFlags".split(" "),function(c,
q,t,G,M,N,u,x,y,z,A,m,B,S,T,U,H,O,P){function C(d){return D.has(d)?D.get(d):"number"===typeof d?d:1}const Q=N.getLogger("esri.views.support.Scheduler");c.TaskPriority=void 0;(function(d){d.RESOURCE_CONTROLLER="schedule";d.SLIDE="slide";d.STREAM_DATA_LOADER="stream loader";d.ELEVATION_QUERY="elevation query";d.TERRAIN_SURFACE="terrain";d.SURFACE_GEOMETRY_UPDATES="surface geometry updates";d.GRAPHICS_CORE="Graphics3D";d.I3S_CONTROLLER="I3S";d.POINT_CLOUD_LAYER="point cloud";d.FEATURE_TILE_FETCHER="feature fetcher";
d.OVERLAY="overlay";d.STAGE="stage";d.GRAPHICS_DECONFLICTOR="graphics deconflictor";d.FILTER_VISIBILITY="Graphics3D filter visibility";d.SCALE_VISIBILITY="Graphics3D scale visibility";d.FRUSTUM_VISIBILITY="Graphics3D frustum visibility";d.POINT_OF_INTEREST_FREQUENT="POI frequent";d.POINT_OF_INTEREST_INFREQUENT="POI infrequent";d.LABELER="labeler";d.FEATURE_QUERY_ENGINE="feature query";d.FEATURE_TILE_TREE="feature tile tree";d.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree";d.ELEVATION_ALIGNMENT=
"elevation alignment";d.TEXT_TEXTURE_ATLAS="text texture atlas";d.TEXTURE_UNLOAD="texture unload";d.LINE_OF_SIGHT_TOOL="line of sight tool";d.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool";d.ELEVATION_PROFILE="elevation profile";d.SNAPPING="snapping";d.SHADOW_ACCUMULATOR="shadow accumulator";d.CLOUDS_GENERATOR="cloud generator";d[d.TEST_PRIO=1]="TEST_PRIO"})(c.TaskPriority||(c.TaskPriority={}));const D=new Map([[c.TaskPriority.RESOURCE_CONTROLLER,0],[c.TaskPriority.SLIDE,0],[c.TaskPriority.STREAM_DATA_LOADER,
0],[c.TaskPriority.ELEVATION_QUERY,0],[c.TaskPriority.TERRAIN_SURFACE,1],[c.TaskPriority.SURFACE_GEOMETRY_UPDATES,1],[c.TaskPriority.GRAPHICS_CORE,2],[c.TaskPriority.I3S_CONTROLLER,2],[c.TaskPriority.POINT_CLOUD_LAYER,2],[c.TaskPriority.FEATURE_TILE_FETCHER,2],[c.TaskPriority.OVERLAY,4],[c.TaskPriority.STAGE,4],[c.TaskPriority.GRAPHICS_DECONFLICTOR,4],[c.TaskPriority.FILTER_VISIBILITY,4],[c.TaskPriority.SCALE_VISIBILITY,4],[c.TaskPriority.FRUSTUM_VISIBILITY,4],[c.TaskPriority.POINT_OF_INTEREST_FREQUENT,
6],[c.TaskPriority.POINT_OF_INTEREST_INFREQUENT,30],[c.TaskPriority.LABELER,8],[c.TaskPriority.FEATURE_QUERY_ENGINE,8],[c.TaskPriority.FEATURE_TILE_TREE,16],[c.TaskPriority.FEATURE_TILE_TREE_ACTIVE,0],[c.TaskPriority.ELEVATION_ALIGNMENT,12],[c.TaskPriority.TEXT_TEXTURE_ATLAS,12],[c.TaskPriority.CLOUDS_GENERATOR,12],[c.TaskPriority.TEXTURE_UNLOAD,12],[c.TaskPriority.LINE_OF_SIGHT_TOOL,16],[c.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[c.TaskPriority.SNAPPING,0],[c.TaskPriority.SHADOW_ACCUMULATOR,
30]]);c.State=void 0;(function(d){d[d.ANIMATING=0]="ANIMATING";d[d.INTERACTING=1]="INTERACTING";d[d.IDLE=2]="IDLE"})(c.State||(c.State={}));const I=m.Milliseconds(6.5),J=m.Milliseconds(1),R=m.Milliseconds(30),K=m.Milliseconds(1E3/30),L=m.Milliseconds(100);var v;(function(d){let p=function(l){function h(){var a=l.call(this)||this;a.updating=!0;a._microTaskQueued=!1;a.performanceInfo={total:new x("total"),tasks:new Map};a._frameTaskTimes=new Map;a._budget=new r;a._state=c.State.INTERACTING;a._tasks=
new y;a._runQueue=new y;a._load=0;a._idleStateCallbacks=new y;a._idleUpdatesStartFired=!1;a._maxReschedule=w;a._forceTask=!1;a._debug=!1;a._debugHandle=A.watch(()=>P.SCHEDULER_LOG_SLOW_TASKS,g=>a._debug=g,A.initial);for(const g of Object.keys(c.TaskPriority))a.performanceInfo.tasks.set(c.TaskPriority[g],new x(c.TaskPriority[g]));let e;const b=q._assertThisInitialized(a);a._test={get state(){return u.unwrapOr(e,b._state)},set state(g){e=g},FRAME_SAFETY_BUDGET:I,INTERACTING_BUDGET:K,IDLE_BUDGET:L,get availableBudget(){return b._budget.budget},
usedBudget:0,getBudget:()=>b._budget,setBudget:g=>b._budget=g,updateTask:g=>a._updateTask(g),getState:g=>a._getState(g),getRuntime:g=>a._getRuntime(g),frameTaskTimes:a._frameTaskTimes,resetRuntimes:()=>a._resetRuntimes(),getRunning:()=>a._getRunning()};return a}q._inheritsLoose(h,l);var f=h.prototype;f.destroy=function(){this._tasks.toArray().forEach(a=>a.remove());this._tasks.clear();u.removeMaybe(this._debugHandle);this.updating=this._microTaskQueued=!1};f.activate=function(){this._budget.done||
this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=w,this._schedule(),this.frame()))}))};f.registerTask=function(a,e){const b=C(a);e=new n(this,a,e,b);this._tasks.push(e);this.performanceInfo.tasks.has(a)||this.performanceInfo.tasks.set(a,new x(a));return e};f.registerIdleStateCallbacks=function(a,e){const b={idleBegin:a,idleEnd:e};this._idleStateCallbacks.push(b);this.state===c.State.IDLE&&
this._idleUpdatesStartFired&&b.idleBegin();const g=this;return{remove:()=>this._removeIdleStateCallbacks(b),set idleBegin(k){g._idleUpdatesStartFired&&(b.idleEnd(),g._state===c.State.IDLE&&k());b.idleBegin=k},set idleEnd(k){b.idleEnd=k}}};f.updateBudget=function(a){this._test.usedBudget=0;let e=I,b=a.frameDuration,g=J;switch(this.state){case c.State.IDLE:e=m.Milliseconds(0);b=m.Milliseconds(Math.max(L,a.frameDuration));g=R;break;case c.State.INTERACTING:b=m.Milliseconds(Math.max(K,a.frameDuration))}b=
m.Milliseconds(b-a.elapsedFrameTime-e);if(this.state!==c.State.IDLE&&b<J&&!this._forceTask)return this._forceTask=!0,!1;b=m.Milliseconds(Math.max(b,g));this._budget.reset(b,this.state);this._maxReschedule=w;this._updateLoad();return this._schedule()};f.frame=function(){this._microTaskQueued=this._forceTask=!1;switch(this.state){case c.State.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(a=>a.idleBegin()));this._runIdle();break;case c.State.INTERACTING:this._runInteracting();
break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed};f.stopFrame=function(){this._budget.reset(m.Milliseconds(0),this._state);this._budget.madeProgress()};f._removeIdleStateCallbacks=function(a){this._idleUpdatesStartFired&&a.idleEnd();this._idleStateCallbacks.removeUnordered(a)};f.removeTask=function(a){this._tasks.removeUnordered(a);this._runQueue.removeUnordered(a)};f._updateTask=function(a){this._tasks.forAll(e=>{e.name===a&&e.setPriority(a)})};f._getState=function(a){if(this._runQueue.some(b=>
b.name===a))return c.TaskState.SCHEDULED;let e=c.TaskState.IDLE;this._tasks.forAll(b=>{b.name===a&&b.needsUpdate&&(1>=b.schedulePriority?e=c.TaskState.READY:e!==c.TaskState.READY&&(e=c.TaskState.WAITING))});return e};f._getRuntime=function(a){let e=0;this._tasks.forAll(b=>{b.name===a&&(e+=b.runtime)});return e};f._resetRuntimes=function(){this._tasks.forAll(a=>a.runtime=0)};f._getRunning=function(){const a=new Map;this._tasks.forAll(b=>{b.needsUpdate&&a.set(b.name,(a.get(b.name)||0)+1)});if(0===a.size)return null;
let e="";a.forEach((b,g)=>{e=1<b?e+` ${b}x ${g}`:e+` ${g}`});return e};f._runIdle=function(){this._run()};f._runInteracting=function(){this._run()};f._runAnimating=function(){this._run()};f._updateLoad=function(){const a=this._tasks.reduce((e,b)=>b.needsUpdate?++e:e,0);this._load=.9*this._load+a*(1-.9)};f._schedule=function(){if(0>=this._maxReschedule)return!1;this._runQueue.filterInPlace(a=>{if(a.needsUpdate)return!0;a.schedulePriority=a.basePriority;return!1});for(this._tasks.forAll(a=>{0===a.basePriority&&
a.needsUpdate&&!this._runQueue.includes(a)&&this._runQueue.unshift(a)});0===this._runQueue.length;){let a=!1,e=0;this._tasks.forAll(b=>{if(b.needsUpdate&&0!==b.schedulePriority&&0!==b.basePriority)switch(a=!0,e=Math.max(e,b.basePriority),b.schedulePriority){case 1:b.schedulePriority=0;this._runQueue.push(b);break;default:--b.schedulePriority}});if(!a)return this.updating=!1;this._maxReschedule===w&&(this._maxReschedule=e);--this._maxReschedule}return this.updating=!0};f._run=function(){const a=this._budget.now();
this._startFrameTaskTimes();do for(;0<this._runQueue.length;){var e=this._budget.now();const b=this._runQueue.pop();this._budget.resetProgress();try{b.task.runTask(this._budget)}catch(g){Q.error(`Exception in task "${b.name}"`,g)}b.schedulePriority=b.basePriority;e=this._budget.now()-e;b.runtime+=e;this._frameTaskTimes.set(b.priority,this._frameTaskTimes.get(b.priority)+e);this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",b.name,"used",this._budget.elapsed,"of max",this._budget.budget,
"ms");if(0>=this._budget.remaining){this.updating=this._tasks.some(g=>g.needsUpdate);this._recordFrameTaskTimes(this._budget.now()-a);return}}while(this._schedule());this.updating=this._tasks.some(b=>b.needsUpdate);this._recordFrameTaskTimes(this._budget.now()-a)};f._startFrameTaskTimes=function(){for(const a of Object.keys(c.TaskPriority))this._frameTaskTimes.set(c.TaskPriority[a],0)};f._recordFrameTaskTimes=function(a){this._frameTaskTimes.forEach((e,b)=>this.performanceInfo.tasks.get(b).record(e));
this.performanceInfo.total.record(a)};q._createClass(h,[{key:"load",get:function(){return this._load}},{key:"state",get:function(){return u.isNone(this._test.state)?this._state:this._test.state},set:function(a){this._state!==a&&(this._state=a,this.state!==c.State.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(e=>e.idleEnd())))}},{key:"test",get:function(){return this._test}}]);return h}(G);t.__decorate([B.property()],p.prototype,"updating",void 0);
p=t.__decorate([H.subclass("esri.views.support.Scheduler")],p);d.Scheduler=p;let n=function(l){function h(a,e,b,g){var k=l.call(this,{})||this;k._scheduler=a;k.name=e;k._basePriority=g;k.runtime=0;k._queue=new O.PromiseQueue;k._handles=new M;k.schedulePriority=k._basePriority;k.task=u.isSome(b)?b:k._queue;k._handles.add(A.when(()=>k.task.running,()=>a.activate()));return k}q._inheritsLoose(h,l);var f=h.prototype;f.normalizeCtorArgs=function(){return{}};f.remove=function(){this.processQueue(E);this._scheduler.removeTask(this);
this.schedule=F.schedule;this.reschedule=F.reschedule;this._handles.destroy()};f.setPriority=function(a){this.name=a;a=C(a);if(0===this._basePriority||0!==this.schedulePriority)this.schedulePriority=a;this._basePriority=a};f.schedule=function(a,e,b){return this._queue.push(a,e,b)};f.reschedule=function(a,e,b){return this._queue.unshift(a,e,b)};f.processQueue=function(a){this._queue.runTask(a)};q._createClass(h,[{key:"updating",get:function(){return this._queue.running}},{key:"basePriority",get:function(){return this._basePriority}},
{key:"priority",get:function(){return this.name},set:function(a){this.setPriority(a)}},{key:"needsUpdate",get:function(){return this.updating||this.task.running}}]);return h}(G);t.__decorate([B.property({constructOnly:!0})],n.prototype,"task",void 0);t.__decorate([B.property({readOnly:!0})],n.prototype,"updating",null);n=t.__decorate([H.subclass("esri.views.support.SchedulerTask")],n);let r=function(){function l(){this._begin="undefined"!==typeof performance?performance.now():0;this._budget=0;this._state=
c.State.IDLE;this._didWork=!1;this._enabled=!0}var h=l.prototype;h.run=function(f){if(this.done)return!1;!0===f()&&(this._didWork=!0);return!0};h.madeProgress=function(){this._didWork=!0};h.reset=function(f,a){this._begin=this.now();this._budget=f;this._state=a;this._didWork=!1};h.now=function(){return performance.now()};h.resetProgress=function(){this._didWork=!1};q._createClass(l,[{key:"done",get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}},{key:"budget",get:function(){return this._budget}},
{key:"state",get:function(){return this._state}},{key:"enabled",get:function(){return this._enabled},set:function(f){this._enabled=f}},{key:"remaining",get:function(){return Math.max(this._budget-this.elapsed,0)}},{key:"elapsed",get:function(){return performance.now()-this._begin}},{key:"hasProgressed",get:function(){return this._didWork}}]);return l}();d.Budget=r})(v||(v={}));c.TaskState=void 0;(function(d){d.SCHEDULED="s";d.READY="r";d.WAITING="w";d.IDLE="i"})(c.TaskState||(c.TaskState={}));const E=
(()=>{const d=new v.Budget;d.enabled=!1;return d})(),F=new (function(){function d(){}var p=d.prototype;p.remove=function(){};p.processQueue=function(){};p.schedule=function(n,r,l){try{if(z.isAborted(r)){const h=z.createAbortError();return l?Promise.resolve(l(h)):Promise.reject(h)}return z.when(n(E))}catch(h){return Promise.reject(h)}};p.reschedule=function(n,r,l){return this.schedule(n,r,l)};return d}()),w=Number.MAX_SAFE_INTEGER;c.ImmediateTask=F;c.getTaskPriority=C;c.newScheduler=function(){return new v.Scheduler};
c.noBudget=E;c.taskPriorities=D;Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});