// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../chunks/rbush ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/createConnection ./DataTileSource ../support/FeatureSetReaderJSON ../support/UpdateToken".split(" "),function(t,m,
u,k,v,y,p,w,z,A,B,C,D){function E(e,d){const c=e.weakClone();if(k.isSome(e.geometry)){const a=p.quantizeX(d,e.geometry.coords[0]);e=p.quantizeY(d,e.geometry.coords[1]);c.geometry=new w([],[a,e])}return c}function F(e){switch(e){case "esriGeometryPoint":return E;default:return(d,c)=>{const a=d.weakClone(),b=new w;d=p.quantizeOptimizedGeometry(b,d.geometry,!1,!1,e,c,!1,!1);a.geometry=d;return a}}}function G(e){switch(e){case "esriGeometryPoint":return d=>k.isSome(d.geometry)?{minX:d.geometry.coords[0],
minY:d.geometry.coords[1],maxX:d.geometry.coords[0],maxY:d.geometry.coords[1]}:{minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};default:return d=>{let c=Infinity,a=Infinity,b=-Infinity,f=-Infinity;k.isSome(d.geometry)&&d.geometry.forEachVertex((g,l)=>{c=Math.min(c,g);a=Math.min(a,l);b=Math.max(b,g);f=Math.max(f,l)});return{minX:c,minY:a,maxX:b,maxY:f}}}}let H=function(){function e(c,a){this.onUpdate=c;this._geometryType=a;this._objectIdToFeature=new Map}var d=e.prototype;d.add=function(c){this._objectIdToFeature.set(c.objectId,
c);this._index=null};d.get=function(c){return this._objectIdToFeature.has(c)?this._objectIdToFeature.get(c):null};d.forEach=function(c){this._objectIdToFeature.forEach(c)};d.search=function(c){if(!this._index){{var a=this._features;const b=y.rbush(9,G(this._geometryType));b.load(a);a=b}this._index=a}return this._index.search({minX:c.bounds[0],minY:c.bounds[1],maxX:c.bounds[2],maxY:c.bounds[3]})};d.removeById=function(c){const a=this._objectIdToFeature.get(c);return a?(this._objectIdToFeature.delete(c),
this._index=null,a):null};d.update=function(c,a){this.onUpdate(c,a)};m._createClass(e,[{key:"_features",get:function(){const c=[];this._objectIdToFeature.forEach(a=>c.push(a));return c}},{key:"size",get:function(){return this._objectIdToFeature.size}}]);return e}();u=function(e){function d(a){var b=e.call(this,a)||this;b.type="geoevent";b._dataReceiveEventEnabled=!1;b._level=0;b._updateInfo={websocket:0,client:0};const {outSR:f}=a,{geometryType:g,objectIdField:l,timeInfo:I,purgeOptions:J,source:K,
spatialReference:L,serviceFilter:M,maxReconnectionAttempts:N,maxReconnectionInterval:O,updateInterval:P,enableDataReceived:Q,customParameters:R}=a.serviceInfo,x=new H(b._onUpdate.bind(m._assertThisInitialized(b)),g),S=new z.StreamFeatureManager(x,l,I,J),r=A.createConnection(K,L,f,g,M,N,O,R);b._store=x;b._manager=S;b._connection=r;b._quantize=F(g);b._dataReceiveEventEnabled=Q;b._handles=[b._connection.on("feature",h=>b._onFeature(h)),v.watch(()=>r.connectionStatus,h=>b.events.emit("connectionStatus",
h)),v.watch(()=>r.errorString,h=>b.events.emit("errorString",h))];b._initUpdateInterval=()=>{let h=performance.now();b._updateIntervalId=setInterval(()=>{var q=performance.now(),n=q-h;2500<n&&(h=q,q=Math.round(b._updateInfo.client/(n/1E3)),n=Math.round(b._updateInfo.websocket/(n/1E3)),b._updateInfo.client=0,b._updateInfo.websocket=0,b.events.emit("updateRate",{client:q,websocket:n}));a.canAcceptRequest()&&b._manager.checkForUpdates()},P)};b._initUpdateInterval();return b}m._inheritsLoose(d,e);var c=
d.prototype;c.destroy=function(){e.prototype.destroy.call(this);this._clearUpdateInterval();this._handles.forEach(a=>a.remove());this._connection.destroy()};c._fetchDataTile=function(){};c.pauseStream=function(){this._clearUpdateInterval()};c.resumeStream=function(){this._initUpdateInterval()};c.enableEvent=function(a,b){"data-received"===a&&(this._dataReceiveEventEnabled=b)};c.subscribe=function(a,b){e.prototype.subscribe.call(this,a,b);b=this._subscriptions.get(a.id);this._level=a.level;const f=
this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:f,end:!0});b.didSend=!0};c.unsubscribe=function(a){e.prototype.unsubscribe.call(this,a)};c.readers=function*(a){a=this._subscriptions.get(a);const {tile:b}=a;yield this._getTileFeatures(b);for(const f of a.requests.stream.entries)k.isSome(f)&&k.isSome(f.addOrUpdate)&&(yield f.addOrUpdate)};c.createTileQuery=function(a){throw Error("Service does not support tile  queries");};c.resend=function(){var a=m._asyncToGenerator(function*(){this._subscriptions.forEach(b=>
{({tile:b}=b);b={type:"append",id:b.id,addOrUpdate:this._getTileFeatures(b),end:!0};this._onMessage(b)})});return function(){return a.apply(this,arguments)}}();c._getTileFeatures=function(a){const b=this._store.search(a).map(f=>this._quantize(f,a.transform));return C.FeatureSetReaderJSON.fromOptimizedFeatures(b,this._serviceInfo,a.transform)};c._onFeature=function(a){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",a);const b=p.convertFromFeature(a,this._serviceInfo.geometryType,
!1,!1,this._serviceInfo.objectIdField);this._manager.add(b)}catch(b){}};c._clearUpdateInterval=function(){clearInterval(this._updateIntervalId);this._updateIntervalId=0};c._onUpdate=function(a,b){k.isSome(a)&&(this._updateInfo.client+=a.length);this._subscriptions.forEach((f,g)=>{f.didSend&&f.tile.level===this._level&&this._onMessage({type:"append",id:g,addOrUpdate:null,clear:!0,end:!1})});this._subscriptions.forEach((f,g)=>{if(f.didSend&&f.tile.level===this._level){var l=this._getTileFeatures(f.tile);
g={type:"append",id:g,addOrUpdate:l,remove:[],end:!0,status:D.UpdateToken.empty()};f.requests.stream.enqueue(g);this._onMessage(g)}})};m._createClass(d,[{key:"updating",get:function(){return!1}}]);return d}(B.DataTileSource);t.GeoEventSource=u;Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});