// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/Error ../../../../core/has ../../../../core/lang ../../../../core/Logger ../../../../core/maybe ../../../../core/screenUtils ../../../../core/sql ../../engine/webgl/enums ../../engine/webgl/Utils ../../engine/webgl/techniques/utils ../../engine/webgl/util/vvFlagUtils ./createSymbolSchema ./support/pixelBuffering ./support/rendererUtils ../support/clusterUtils ../support/util".split(" "),function(w,m,Q,R,S,n,I,T,q,U,V,W,p,X,D,J,K){function t(a){let b=0,c=0,d=q.WGLSymbologyType.DEFAULT;
if(n.isSome(a)){c=X.getPtMaxVVSize(a);"visualVariables"in a&&(b=W.getVVFlags(a.visualVariables||[]),"dot-density"===a.type&&(d=q.WGLSymbologyType.DOT_DENSITY));"heatmap"===a.type&&(d=q.WGLSymbologyType.HEATMAP);if("dictionary"===a.type)return{maxVVSize:c,vvFlags:b,symbologyType:q.WGLSymbologyType.DEFAULT};if("pie-chart"===a.type)return{maxVVSize:c,vvFlags:b,symbologyType:q.WGLSymbologyType.PIE_CHART};if(d!==q.WGLSymbologyType.DOT_DENSITY&&d!==q.WGLSymbologyType.HEATMAP){var e=a.getSymbols();"backgroundFillSymbol"in
a&&a.backgroundFillSymbol&&e.push(a.backgroundFillSymbol);let g=a=!0;for(const h of e)if("cim"===h.type&&(g=!1),"simple-fill"===h.type||"picture-fill"===h.type){e=(e=h.outline)&&"none"!==e.style&&"solid"!==e.style;var k="simple-fill"===h.type&&"none"!==h.style&&"solid"!==h.style;k="picture-fill"===h.type||k||e;e&&(a=!1);k&&(g=!1)}a?d=g?q.WGLSymbologyType.OUTLINE_FILL_SIMPLE:q.WGLSymbologyType.OUTLINE_FILL:g&&(d=q.WGLSymbologyType.SIMPLE)}}return{vvFlags:b,maxVVSize:c,symbologyType:d}}function L(a,
b){a=R.clone(a);return a.some(c=>{{const e=c.labelPlacement;var d=Y[b];c.symbol?d?(d.includes(e)||(d=d[0],e&&z.warn(`Found invalid label placement type ${e} for ${b}. Defaulting to ${d}`),c.labelPlacement=d),c=!1):(z.error(new m("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${b} is not supported`)),c=!0):(z.warn("No ILabelClass symbol specified."),c=!0)}return c})?[]:a}function M(a,b=!1){try{var c,d;const e=Z(a,b),k=aa(a),g={};e.map(f=>{a:{switch(f.target){case "feature":E(g,
F(a),f);f=void 0;break a;case "aggregate":if(!("featureReduction"in a)){f=void 0;break a}var l=a.featureReduction;switch(l.type){case "selection":throw new m("ValidationError","Mapview does not support `selection` reduction type",l);case "binning":E(g,F(a),f);g.aggregate||(g.aggregate={name:"aggregate",type:"bin",filters:null,input:"feature",params:{fixedBinLevel:l.fixedBinLevel},attributes:{}});G(g.aggregate,f.attributes.fields);f=void 0;break a;case "cluster":E(g,F(a),f);g.aggregate||(g.aggregate=
{name:"aggregate",type:"cluster",input:"feature",filters:null,attributes:{},params:{clusterRadius:I.pt2px(l.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(I.pt2px(l.clusterMaxSize)/64),fields:f.aggregateFields}});G(g.aggregate,f.attributes.fields);f=void 0;break a}}f=void 0}return f});const h=n.isSome(a.subtypeCode)?`${a.subtypeField} = ${a.subtypeCode}`:null;return{source:{definitionExpression:T.sqlAnd(a.definitionExpression,h),fields:a.fields.map(f=>f.toJSON()),gdbVersion:a.gdbVersion,historicMoment:null==
(c=a.historicMoment)?void 0:c.getTime(),outFields:a.availableFields,pixelBuffer:a.pixelBuffer,spatialReference:a.spatialReference.toJSON(),timeExtent:null==(d=a.timeExtent)?void 0:d.toJSON(),customParameters:a.customParameters},attributes:{fields:{},indexCount:0},processors:e,tileRenderer:k,targets:g}}catch(e){if("ValidationError"===e.fieldName)return z.error(e),null;throw e;}}function G(a,b){for(const c in b){const d=b[c];if(d.target!==a.name)continue;const e=a.attributes[c];e?(e.context.mesh=e.context.mesh||
d.context.mesh,e.context.storage=e.context.storage||d.context.storage):a.attributes[c]=d}return a}function F(a){var b,c,d,e,k;return[null!=(b=null==(c=n.unwrap(a.filter))?void 0:c.toJSON())?b:null,null!=(d=null==(e=n.unwrap(null==(k=n.unwrap(a.featureEffect))?void 0:k.filter))?void 0:e.toJSON())?d:null]}function E(a,b,c){a.feature||(a.feature={name:"feature",input:"source",filters:b,attributes:{}});G(a.feature,c.attributes.fields);return a}function r(a,b){return b.field?u(a,{...b,type:"field",field:b.field}):
b.valueExpression?u(a,{...b,type:"expression",valueExpression:b.valueExpression}):{field:null,fieldIndex:null}}function u(a,b){switch(b.type){case "expression":var c=b.valueExpression;if(!a.fields[c]){var d=a.indexCount++;a.fields[c]={...b,name:c,fieldIndex:d}}return{fieldIndex:a.fields[c].fieldIndex};case "label-expression":return c=JSON.stringify(b.label),a.fields[c]||(d=a.indexCount++,a.fields[c]={...b,name:c,fieldIndex:d}),{fieldIndex:a.fields[c].fieldIndex};case "field":c=b.field;if("aggregate"===
b.target&&a.fields[c])return{field:c};a.fields[c]={...b,name:c};return{field:c};case "statistic":return a.fields[b.name]={...b},{field:b.name}}}function Z(a,b=!1){const c=[];let d=0;c.push(ba(a,d++,b));return c}function H(a,b,c,d,e,k=!1){b=u(b,{type:"label-expression",target:d,context:{mesh:!0},resultType:"string",label:{labelExpression:c.labelExpression,labelExpressionInfo:c.labelExpressionInfo?{expression:c.labelExpressionInfo.expression}:null,symbol:!!c.symbol,where:c.where}});({fieldIndex:b}=
b);a=t(a);return{...p.createSymbolSchema(c,a,k),fieldIndex:b,target:d,index:e}}function ca(a,b,c){const d="featureReduction"in b&&b.featureReduction;if(!d)return{fields:[],labels:[],matcher:null,rendererOverride:null};const e=[];let k=null,g=K.toJSONGeometryType(b.geometryType),h=[],f=null;if(d)switch(d.type){case "selection":throw new m("ValidationError","Mapview does not support `selection` reduction type",d);case "cluster":case "binning":if("cluster"===d.type?g="esriGeometryPoint":"binning"===
d.type&&(g="esriGeometryPolygon"),d.renderer){for(const l of d.fields)J.convertAggregateFieldFromPublic(e,l);f=d.renderer;k=C(null,"aggregate",d.renderer,c);h=d&&d.labelsVisible&&d.labelingInfo||[]}else"cluster"===d.type&&(f=J.createClusterRenderer(e,b.renderer,d,null),d.symbol&&(b=t(f),k={type:"simple",symbol:p.createSymbolSchema(d.symbol,b,c),symbologyType:b.symbologyType}),h=d&&d.labelsVisible&&d.labelingInfo||[])}N(a,e);return{labels:L(h,"binning"===d.type?"esriGeometryPolygon":g),matcher:k,fields:e,
rendererOverride:f}}function ba(a,b,c=!1){const d={indexCount:0,fields:{}};b="featureReduction"in a&&a.featureReduction?"aggregate":"feature";if("sublayers"in a){var e={type:"subtype",subtypeField:a.subtypeField,renderers:{},symbologyType:q.WGLSymbologyType.DEFAULT},k={type:"subtype",mapping:{},target:"feature"};var g={type:"subtype",classes:{}};var h={type:"symbol",target:"feature",aggregateFields:[],attributes:d,storage:k,mesh:{matcher:e,aggregateMatcher:null,labels:g,sortKey:null}},f=new Set;let x=
0;for(const {renderer:v,subtypeCode:y,labelingInfo:da,labelsVisible:ea}of a.sublayers){a=C(d,b,v,c);const B=O(d,b,v),P=ea&&da;if("visualVariables"in v&&v.visualVariables&&v.visualVariables.length)throw new m("ValidationError","Visual variables are currently not supported for subtype layers");if("dictionary"===a.type)throw new m("ValidationError","Dictionary renderer is not supported in subtype layers");if("subtype"===a.type)throw new m("ValidationError","Nested subtype renderers is not supported");
if(n.isSome(B)&&"subtype"===B.type)throw new m("ValidationError","Nested subtype storage is not supported");if(n.isSome(B)&&n.isSome(B.attributeMapping))throw new m("ValidationError","Non-visual-variable attributes are not supported in subtype layers");if("heatmap"===a.type)throw new m("ValidationError","Heatmaps are not supported in subtype layers");if("pie-chart"===a.type)throw new m("ValidationError","Pie-charts are not supported in subtype layers");if(f.has(y))throw new m("ValidationError","Subtype codes for sublayers must be unique");
f.add(y);e.renderers[y]=a;k.mapping[y]=B;P&&(g.classes[y]=P.map(fa=>H(v,d,fa,"feature",x++,c)))}return h}if("heatmap"===a.renderer.type&&"raster"===D.getSupportedHeatmapRenderer()){const {radius:x,fieldOffset:v,field:y}=a.renderer;return{type:"heatmap",aggregateFields:[],attributes:d,target:b,storage:null,mesh:{radius:x,fieldOffset:v,field:r(d,{target:b,field:y,resultType:"numeric"}).field}}}e=ca(d,a,c);k=K.toJSONGeometryType(a.geometryType);const l=null!=(g=e.rendererOverride)?g:a.renderer;g=C(d,
b,l,c);h=O(d,b,l);f=ha(d,a.orderBy);let A=0;a=[...L(a.labelsVisible&&a.labelingInfo||[],k).map(x=>H(l,d,x,"feature",A++,c)),...e.labels.map(x=>H(l,d,x,"aggregate",A++,c))];return{type:"symbol",target:b,attributes:d,aggregateFields:e.fields,storage:h,mesh:{matcher:g,labels:{type:"simple",classes:a},aggregateMatcher:e.matcher,sortKey:f}}}function aa(a){var b;return"heatmap"===(null==(b=a.renderer)?void 0:b.type)&&"raster"===D.getSupportedHeatmapRenderer()?{type:"heatmap"}:{type:"symbol"}}function ha(a,
b){if(n.isNone(b)||!b.length)return null;1<b.length&&z.warn(`Layer rendering currently only supports ordering by 1 orderByInfo, but found ${b.length}. All but the first will be discarded`);b=b[0];const c="ascending"===b.order?"asc":"desc";if(b.field)return{field:b.field,order:c};if(b.valueExpression)return{fieldIndex:u(a,{type:"expression",target:"feature",valueExpression:b.valueExpression,resultType:"numeric"}).fieldIndex,order:c};z.error(new m("ValidationError","Expected to find a field or valueExpression for OrderByInfo",
b));return null}function N(a,b){const c={mesh:!0,storage:!0};for(const d of b){const {name:e,outStatistic:k}=d,{statisticType:g,onStatisticField:h}=k;let f=b=null,l=null;"onStatisticValueExpression"in k?f=u(a,{type:"expression",target:"feature",valueExpression:k.onStatisticValueExpression,resultType:"numeric"}).fieldIndex:"onStatisticNormalizationField"in k?(b=u(a,{type:"field",target:"feature",field:h,resultType:"numeric"}).field,l=k.onStatisticNormalizationField):b=u(a,{type:"field",target:"feature",
field:h,resultType:"numeric"}).field;u(a,{type:"statistic",target:"aggregate",name:e,context:c,inField:b,inNormalizationField:l,inFieldIndex:f,statisticType:g})}}function O(a,b,c){let d;switch(c.type){case "simple":case "class-breaks":case "unique-value":case "dictionary":d={visualVariables:!0,attributes:null};break;default:d=V.getTechniqueFromRenderer(c).getStorageSpec(c)}return ia(a,b,d,c)}function ia(a,b,c,d){if(n.isNone(c))return null;const {visualVariables:e,attributes:k}=c;c=null;e&&"visualVariables"in
d&&(c=ja(a,b,d.visualVariables));const g=n.isSome(c)?4:0;d=null;n.isSome(k)&&(d=k.map((h,f)=>{const {field:l,fieldIndex:A}=r(a,{valueExpression:h.valueExpression,field:h.field,resultType:"numeric",target:b});return{binding:f+g,field:l,fieldIndex:A}}));return{type:"simple",target:b,attributeMapping:d,vvMapping:c}}function ja(a,b,c){if(!c||!c.length)return[];const d={storage:!0};return D.simplifyVisualVariables(c).map(e=>{var k;const g=U.getVVType(e.type),{field:h,fieldIndex:f}=r(a,{target:b,valueExpression:e.valueExpression,
field:e.field,context:d,resultType:"numeric"});switch(e.type){case "size":return"$view.scale"===e.valueExpression?null:{type:"size",binding:g,field:h,fieldIndex:f,normalizationField:r(a,{target:b,field:e.normalizationField,context:d,resultType:"numeric"}).field,valueRepresentation:null!=(k=e.valueRepresentation)?k:null};case "color":return{type:"color",binding:g,field:h,fieldIndex:f,normalizationField:r(a,{target:b,field:e.normalizationField,context:d,resultType:"numeric"}).field};case "opacity":return{type:"opacity",
binding:g,field:h,fieldIndex:f,normalizationField:r(a,{target:b,field:e.normalizationField,context:d,resultType:"numeric"}).field};case "rotation":return{type:"rotation",binding:g,field:h,fieldIndex:f}}}).filter(e=>e)}function C(a,b,c,d=!1){a=n.unwrapOr(a,{indexCount:0,fields:{}});switch(c.type){case "simple":case "dot-density":return ka(a,c,d);case "class-breaks":return la(a,b,c,d);case "unique-value":return ma(a,b,c,d);case "dictionary":return b=t(c),c={type:"dictionary",config:c.config,fieldMap:c.fieldMap,
scaleExpression:c.scaleExpression,url:c.url,symbolOptions:b,symbologyType:b.symbologyType};case "heatmap":return na(a,c,d);case "pie-chart":return oa(a,c,d)}}function ka(a,b,c=!1){a=b.getSymbols();a=a.length?a[0]:null;b=t(b);return{type:"simple",symbol:p.createSymbolSchema(a,b,c),symbologyType:b.symbologyType}}function oa(a,b,c=!1){var d=b.getSymbols();a=d[0];d=1<d.length?d[1]:null;b=t(b);return{type:"pie-chart",markerSymbol:p.createSymbolSchema(a,b,c),fillSymbol:p.createSymbolSchema(d,b,c),symbologyType:b.symbologyType}}
function la(a,b,c,d=!1){const e=c.backgroundFillSymbol,{field:k,fieldIndex:g}=r(a,{target:b,field:c.field,valueExpression:c.valueExpression,resultType:"numeric",context:{mesh:!0,use:"renderer.field"}});b=c.normalizationType;b="log"===b?"esriNormalizeByLog":"percent-of-total"===b?"esriNormalizeByPercentOfTotal":"field"===b?"esriNormalizeByField":null;const h=t(c),f=c.classBreakInfos.map(l=>({symbol:p.createSymbolSchema(l.symbol,h,d),min:l.minValue,max:l.maxValue})).sort((l,A)=>l.min-A.min);return{type:"interval",
attributes:a.fields,field:k,fieldIndex:g,backgroundFillSymbol:p.createSymbolSchema(e,h,d),defaultSymbol:p.createSymbolSchema(c.defaultSymbol,h,d),intervals:f,normalizationField:c.normalizationField,normalizationTotal:c.normalizationTotal,normalizationType:b,isMaxInclusive:c.isMaxInclusive,symbologyType:h.symbologyType}}function ma(a,b,c,d=!1){const e=[],k=c.backgroundFillSymbol;b={target:b,context:{mesh:!0},resultType:"string"};if(c.field&&"string"!==typeof c.field)throw new m("ValidationError","Expected renderer.field to be a string",
c);const {field:g,fieldIndex:h}=r(a,{...b,field:c.field,valueExpression:c.valueExpression}),f=t(c);for(const l of c.uniqueValueInfos)e.push({value:""+l.value,symbol:p.createSymbolSchema(l.symbol,f,d)});return{type:"map",attributes:a.fields,field:g,fieldIndex:h,field2:r(a,{...b,field:c.field2}).field,field3:r(a,{...b,field:c.field3}).field,fieldDelimiter:c.fieldDelimiter,backgroundFillSymbol:p.createSymbolSchema(k,f),defaultSymbol:p.createSymbolSchema(c.defaultSymbol,f),map:e,symbologyType:f.symbologyType}}
function na(a,b,c=!1){a=b.getSymbols();a=a.length?a[0]:null;b=t(b);return{type:"heatmap",symbol:p.createSymbolSchema(a,b,c),symbologyType:b.symbologyType}}const z=S.getLogger("esri.views.2d.layers.features.schemaUtils"),Y={esriGeometryPoint:"above-right above-center above-left center-center center-left center-right below-center below-left below-right".split(" "),esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};w.createSymbolSchema=p.createSymbolSchema;
w.addAggregateFields=N;w.createMatcherSchema=C;w.createRendererAttributeSchema=r;w.createSchema=function(a){Q("esri-2d-update-debug")&&console.debug("Created new schema",M(a,!0));return M(a)};w.createSymbolSchemaOptions=t;Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});