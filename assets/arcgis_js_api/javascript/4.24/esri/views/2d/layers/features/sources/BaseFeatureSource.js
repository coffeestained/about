// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../request ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../controllers/support/sourceAdapters ./DataTileSource ../../../../support/QueueProcessor".split(" "),function(t,h,w,x,l,r,k,n,y,z,u){const A=r.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");r=function(m){function p(b){var a=m.call(this,b)||this;a.type="feature";
a.mode="on-demand";a._adapter=y.createSourceAdapter(b.serviceInfo);a._queue=new u.QueueProcessor({concurrency:8,process:function(){var e=h._asyncToGenerator(function*(c){n.throwIfAborted(c);if(k.isSome(c.tile)){var d=c.tile.key.id,{signal:g}=c;d=l("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:c.depth}:void 0;g=yield a._adapter.executeQuery(c.query,{signal:g,query:{...d,...a._schema.customParameters}});g.level=c.tile.key.level;return g}return a._adapter.executeQuery(c.query,{...c,query:a._schema.customParameters})});
return function(c){return e.apply(this,arguments)}}()});a._patchQueue=new u.QueueProcessor({concurrency:8,process:function(){var e=h._asyncToGenerator(function*(c){n.throwIfAborted(c);if(k.isSome(c.tile)){var d=c.tile.key.id,{signal:g}=c;d=l("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:c.depth}:void 0;g=yield a._adapter.executeQuery(c.query,{signal:g,query:{...d,...a._schema.customParameters}});g.level=c.tile.key.level;return g}return a._adapter.executeQuery(c.query,{...c,query:a._schema.customParameters})});
return function(c){return e.apply(this,arguments)}}()});return a}h._inheritsLoose(p,m);var f=p.prototype;f.destroy=function(){m.prototype.destroy.call(this);this._adapter.destroy();this._queue.destroy();this._patchQueue.destroy()};f.enableEvent=function(b,a){};f.subscribe=function(b,a){m.prototype.subscribe.call(this,b,a);const e=this._subscriptions.get(b.id);this._fetchDataTile(b).catch(c=>{n.isAbortError(c)||A.error(new x("mapview-query-error","Encountered error when fetching tile",{tile:b,error:c}))}).then(()=>
e.end())};f.unsubscribe=function(b){m.prototype.unsubscribe.call(this,b)};f.readers=function(b){return this._subscriptions.get(b).readers()};f.query=function(){var b=h._asyncToGenerator(function*(a){return this._adapter.executeQuery(a,{query:this._schema.customParameters})});return function(a){return b.apply(this,arguments)}}();f.queryLastEditDate=function(){var b=h._asyncToGenerator(function*(){const a=this._serviceInfo.source;return(yield w(a.path,{query:{...a.query,f:"json"},responseType:"json"})).data.editingInfo.lastEditDate});
return function(){return b.apply(this,arguments)}}();f.createTileQuery=function(b,a={}){var e;const c=this._serviceInfo.geometryType,d=this.createQuery(a);d.quantizationParameters=null!=(e=a.quantizationParameters)?e:b.getQuantizationParameters();d.resultType="tile";d.geometry=b.extent;if(this._serviceInfo.capabilities.query.supportsQuantization)"esriGeometryPolyline"===c&&(d.maxAllowableOffset=b.resolution*l("feature-polyline-generalization-factor"));else if("esriGeometryPolyline"===c||"esriGeometryPolygon"===
c)d.maxAllowableOffset=b.resolution,"esriGeometryPolyline"===c&&(d.maxAllowableOffset*=l("feature-polyline-generalization-factor"));b=this._serviceInfo.capabilities.query;d.defaultSpatialReferenceEnabled=b.supportsDefaultSpatialReference;d.compactGeometryEnabled=b.supportsCompactGeometry;return d};f._executePatchQuery=function(){var b=h._asyncToGenerator(function*(a,e,c,d){e=e.clone();e.outFields=[this._serviceInfo.objectIdField,...c];e.returnCentroid=!1;e.returnGeometry=!1;c=k.isSome(e.start)?e.start/
8E3:0;return this._patchQueue.push({tile:a,query:e,signal:d.signal,depth:c})});return function(a,e,c,d){return b.apply(this,arguments)}}();f._resend=function(){var b=h._asyncToGenerator(function*(a,e){const {query:c,message:d}=a,g=k.isSome(c.outFields)?c.outFields:[];a=this._queryInfo.outFields;const v=a.filter(q=>!g.includes(q));if(k.isNone(d.addOrUpdate))this._onMessage({...d,type:"append"});else if(v.length)try{const q=this._subscriptions.get(d.id).tile,B=yield this._executePatchQuery(q,c,v,e);
n.throwIfAborted(e);c.outFields=a;d.addOrUpdate.joinAttributes(B);this._onMessage({...d,end:d.end,type:"append"})}catch(q){}else this._onMessage({...d,type:"append"})});return function(a,e){return b.apply(this,arguments)}}();f._resendSubscription=function(){var b=h._asyncToGenerator(function*(a){l("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription");if(a.empty)return this._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const e=a.signal;for(const c of a.requests.done)yield this._resend(c,
{signal:e});if(k.isSome(a.edits))return this._onMessage(a.edits)});return function(a){return b.apply(this,arguments)}}();f.resend=function(){var b=h._asyncToGenerator(function*(){const a=Array.from(this._subscriptions.values());yield Promise.all(a.map(e=>this._resendSubscription(e)))});return function(){return b.apply(this,arguments)}}();h._createClass(p,[{key:"updating",get:function(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(b=>!b.done)}},{key:"maxRecordCountFactor",
get:function(){const {query:b}=this._serviceInfo.capabilities;return b.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){var b,{query:a}=this._serviceInfo.capabilities;a=null!=(b=a.maxRecordCount)?b:8E3;b=k.unwrapOr(this.maxRecordCountFactor,1);return a*b}},{key:"pageSize",get:function(){return Math.min(8E3,this.maxPageSize)}}]);return p}(z.DataTileSource);t.BaseFeatureSource=r;Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});