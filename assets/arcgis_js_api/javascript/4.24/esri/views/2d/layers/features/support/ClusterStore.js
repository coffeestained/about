// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../geometry ../../../../../core/Evented ../../../../../core/has ../../../../../core/maybe ../../../../../core/accessorSupport/diffUtils ../../../../../geohash/GeohashTree ../../../../../geohash/geohashUtils ../../../../../geometry/support/Ellipsoid ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/projectionSupport ../../../engine/webgl/definitions ../../../engine/webgl/DisplayId ../Store2D ./FeatureSetReaderJSON ../../../../../geometry/SpatialReference".split(" "),
function(H,B,J,R,K,w,L,S,C,x,T,M,N,U,D,p,O,V,W,E){let P=function(y){function q(b,a,c,e,d){a=new U([],[a,c]);b=y.call(this,a,e,null,b)||this;b.geohashBoundsInfo=d;return b}B._inheritsLoose(q,y);q.create=function(b,a,c,e,d,g,l,m){a=new q(a,c,e,g,l);a.displayId=b.createDisplayId(!0);a.referenceId=m;a.tileLevel=d;return a};var f=q.prototype;f.update=function(b,a,c,e,d,g){this.geometry.coords[0]=b;this.geometry.coords[1]=a;this.tileLevel=c;this.attributes=e;this.geohashBoundsInfo=d;this.referenceId=null;
this.referenceId=g;return this};f.toJSON=function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}};B._createClass(q,[{key:"count",get:function(){return this.attributes.cluster_count}}]);return q}(N.OptimizedFeatureWithGeometry);J=function(y){function q(b,a,c,e){var d=y.call(this,b,c)||this;d.events=new R;d._geohashLevel=0;d._tileLevel=
0;d._aggregateValueRanges={};d._aggregateValueRangesChanged=!1;d._geohashBuf=[];d._clusters=new Map;d._tiles=new Map;d._serviceInfo=e;d.geometryInfo=b.geometryInfo;d._spatialReference=a;d._projectionSupportCheck=D.checkProjectionSupport(a,E.WGS84);d._bitsets.geohash=c.getBitset(c.createBitset());d._bitsets.inserted=c.getBitset(c.createBitset());return d}B._inheritsLoose(q,y);var f=q.prototype;f.destroy=function(){this._tree.destroy()};f.updateSchema=function(){var b=B._asyncToGenerator(function*(a,
c){const e=this._schema;try{yield y.prototype.updateSchema.call(this,a,c),yield this._projectionSupportCheck}catch(g){}const d=L.diff(e,c);if(!c||w.isNone(d)&&!a.source&&!a.storage.filters)e&&(a.mesh=!0);else{if(L.hasDiff(d,"params.fields")||!this._tree||a.source)this._tree&&this._tree.destroy(),this._tree=new S.GeohashTree(this._statisticFields,this._serviceInfo),this._rebuildTree(),K("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing");K("esri-2d-update-debug")&&
console.debug("Applying Update - ClusterStore:",d);a.targets[c.name]=!0;a.mesh=!1;this._aggregateValueRanges={}}});return function(a,c){return b.apply(this,arguments)}}();f.clear=function(){this._rebuildTree()};f.sweepFeatures=function(b,a){this._bitsets.inserted.forEachSet(c=>{b.has(c)||(c=a.lookupByDisplayIdUnsafe(c),this._remove(c))})};f.sweepAggregates=function(b,a,c){this._clusters.forEach((e,d)=>{e&&e.tileLevel!==c&&(b.releaseDisplayId(e.displayId),a.unsetAttributeData(e.displayId),this._clusters.delete(d))})};
f.onTileData=function(b,a,c,e,d=!0){if(!this._schema||w.isNone(a.addOrUpdate))return a;var g=this._getTransforms(b,this._spatialReference);{const l=a.addOrUpdate.getCursor();for(;l.next();)this._update(l,e)}if(a.status.mesh||!d)return a;e=[];this._getClustersForTile(e,b,this._schema.params.clusterRadius,c,g);a.addOrUpdate=W.FeatureSetReaderJSON.fromOptimizedFeatures(e,this._serviceInfo);a.addOrUpdate.attachStorage(c);a.clear=!0;a.end=!0;for(g=a.addOrUpdate.getCursor();g.next();)e=g.getDisplayId(),
this._bitsets.computed.unset(e),this.setComputedAttributes(c,g,e,b.scale);this._aggregateValueRangesChanged&&a.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1);return a};f.onTileUpdate=function({added:b,removed:a}){b.length&&(this._tileLevel=b=b[0].level,this._setGeohashLevel(b));if(this._schema){var c=this._schema.params.clusterRadius;a.forEach(e=>{this._tiles.delete(e.key.id);this._markTileClustersForDeletion(e,c)})}};f.getAggregate=
function(b){for(const a of this._clusters.values())if(((null==a?NaN:a.displayId)&O.DISPLAY_ID_TEXEL_MASK)===(b&O.DISPLAY_ID_TEXEL_MASK))return a.toJSON();return null};f.getAggregates=function(){const b=[];for(const a of this._clusters.values())(null==a?void 0:a.tileLevel)===this._tileLevel&&b.push(a.toJSON());return b};f.getDisplayId=function(b){return(b=this._clusters.get(b))?b.displayId:null};f.getFeatureDisplayIdsForAggregate=function(b){b=this._clusters.get(b);if(!b)return[];b=b.geohashBoundsInfo;
return this._tree.getRegionDisplayIds(b.xLL,b.yLL,b.xTR,b.yTR,b.level)};f.getDisplayIdForReferenceId=function(b){for(const a of this._clusters.values())if((null==a?void 0:a.referenceId)===b)return a.displayId;return null};f.getAggregateValueRanges=function(){return this._aggregateValueRanges};f.forEach=function(b){for(const [a,c]of this._clusters)c&&b(c,a)};f.size=function(){let b=0;this.forEach(a=>b++);return b};f._rebuildTree=function(){this._bitsets.computed.clear();this._bitsets.inserted.clear();
this._tree&&this._tree.clear()};f._remove=function(b){const a=b.getDisplayId(),c=b.getXHydrated(),e=b.getYHydrated(),d=this._geohashBuf[2*a],g=this._geohashBuf[2*a+1];this._bitsets.inserted.has(a)&&(this._bitsets.inserted.unset(a),this._tree.removeCursor(b,c,e,d,g,this._geohashLevel))};f._update=function(b,a){const c=b.getDisplayId(),e=this._bitsets.inserted;a=a.isVisible(c);var d=e.has(c);a!==d&&(a?(a=b.getXHydrated(),d=b.getYHydrated(),this._setGeohash(c,a,d)&&(this._tree.insertCursor(b,c,a,d,this._geohashBuf[2*
c],this._geohashBuf[2*c+1],this._geohashLevel),e.set(c))):this._remove(b))};f._setGeohash=function(b,a,c){if(this._bitsets.geohash.has(b))return!0;const e=this._geohashBuf;if(this._spatialReference.isWebMercator)a=a/x.earth.radius*57.29577951308232,C.setGeohashBuf(e,b,57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-c/x.earth.radius))),a-360*Math.floor((a+180)/360),12);else{c=D.project({x:a,y:c},this._spatialReference,E.WGS84);if(!c)return!1;C.setGeohashBuf(e,b,c.y,c.x,12)}this._bitsets.geohash.set(b);
return!0};f._getClustersForTile=function(b,a,c,e,d,g=!0){var l=this._schema.params.clusterPixelBuffer,m=2*c;c=this._getGeohashLevel(a.key.level);const z=Math.ceil(2**a.key.level*p.TILE_SIZE/m);var t=Math.ceil(l/m)+0,r=Math.ceil(p.TILE_SIZE/m);const {row:F,col:u}=a.key;var h=Math.floor(u*p.TILE_SIZE/m)-t;m=Math.floor(F*p.TILE_SIZE/m)-t;l=h+r+2*t;t=m+r+2*t;for(r=a.tileInfoView.getLODInfoAt(a.key.level);h<=l;h++)for(let A=m;A<=t;A++){var k=h;r.wrap&&(k=0>h?h+z:h%z);const I=r.wrap&&0>h,G=r.wrap&&h%z!==
h;k=this._lookupCluster(e,r,a.key.level,k,A,c);if(w.isSome(k)){var n=w.applySome(d,v=>I?v.left:G?v.right:v.tile);if((!g||!w.isNone(n))&&k.count&&w.isSome(n)&&g){const v=k.geometry.clone();let Q=k.attributes;v.coords[0]=M.quantizeX(n,v.coords[0]);v.coords[1]=M.quantizeY(n,v.coords[1]);1===k.count&&w.isSome(k.referenceId)&&(Q={...k.attributes,referenceId:k.referenceId});n=new N.OptimizedFeature(v,Q);n.displayId=k.displayId;b.push(n)}}}};f._getGeohashLevel=function(b){return Math.min(Math.ceil(b/2+2),
12)};f._setGeohashLevel=function(b){b=this._getGeohashLevel(b);b=1*(Math.floor(b/1)+1)-1;this._geohashLevel!==b&&(this._geohashLevel=b,this._rebuildTree(),this._bitsets.geohash.clear())};f._getTransforms=function(b,a){const c={originPosition:"upperLeft",scale:[b.resolution,b.resolution],translate:[b.bounds[0],b.bounds[3]]};a=T.getInfo(a);if(!a)return{tile:c,left:null,right:null};const [e,d]=a.valid;return{tile:c,left:{...c,translate:[d,b.bounds[3]]},right:{...c,translate:[e-d+b.bounds[0],b.bounds[3]]}}};
f._getClusterId=function(b,a,c){return(b&15)<<28|(a&16383)<<14|c&16383};f._markForDeletion=function(b,a,c){b=this._getClusterId(b,a,c);this._clusters.delete(b)};f._getClusterBounds=function(b,a,c){var e=this._schema.params.clusterRadius,d=2*e;a=c%2?a*d:a*d-e;const g=c*d;e=a+d;c=2**b.level*p.TILE_SIZE;b.wrap&&0>a&&(a=0);b.wrap&&e>c&&(e=c);c=g/p.TILE_SIZE;e/=p.TILE_SIZE;d=(g-d)/p.TILE_SIZE;a=b.getXForColumn(a/p.TILE_SIZE);c=b.getYForRow(c);e=b.getXForColumn(e);b=b.getYForRow(d);return[a,c,e,b]};f._lookupCluster=
function(b,a,c,e,d,g){const l=this._getClusterId(c,e,d),m=this._clusters.get(l),[z,t,r,F]=this._getClusterBounds(a,e,d);var u={x:z,y:t};d={x:r,y:F};var h=e=a=0,k=0;if(this._spatialReference.isWebMercator)a=u.x/x.earth.radius*57.29577951308232,a-=360*Math.floor((a+180)/360),e=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-u.y/x.earth.radius))),h=d.x/x.earth.radius*57.29577951308232,h-=360*Math.floor((h+180)/360),k=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-d.y/x.earth.radius)));else{e=
D.project(u,this._spatialReference,E.WGS84);d=D.project(d,this._spatialReference,E.WGS84);if(!e||!d)return null;a=e.x;e=e.y;h=d.x;k=d.y}u={geohashX:0,geohashY:0};d={geohashX:0,geohashY:0};C.setGeohashXY(u,e,a,g);C.setGeohashXY(d,k,h,g);e=u.geohashX;h=u.geohashY;k=d.geohashX;d=d.geohashY;a={xLL:e,yLL:h,xTR:k,yTR:d,level:g};d=this._tree.getRegionStatistics(e,h,k,d,g);const {count:n,xTotal:A,yTotal:I,referenceId:G}=d;g=n?A/n:0;e=n?I/n:0;if(0===n)return this._clusters.set(l,null),null;d={cluster_count:n,
...d.attributes};b=w.isSome(m)?m.update(g,e,c,d,a,G):P.create(b,l,g,e,c,d,a,G);0===n&&(b.geometry.coords[0]=(z+r)/2,b.geometry.coords[1]=(t+F)/2);this._clusters.set(l,b);this._updateAggregateValueRangeForCluster(b,b.tileLevel);return b};f._updateAggregateValueRangeForCluster=function(b,a){const c=this._aggregateValueRanges[a]||{minValue:Infinity,maxValue:0},e=c.minValue,d=c.maxValue;c.minValue=Math.min(e,b.count);c.maxValue=Math.max(d,b.count);this._aggregateValueRanges[a]=c;if(e!==c.minValue||d!==
c.maxValue)this._aggregateValueRangesChanged=!0};f._markTileClustersForDeletion=function(b,a){var c=2*a;a=Math.ceil(p.TILE_SIZE/c);const {row:e,col:d}=b.key,g=Math.floor(d*p.TILE_SIZE/c);c=Math.floor(e*p.TILE_SIZE/c);for(let l=g;l<g+a;l++)for(let m=c;m<c+a;m++)this._markForDeletion(b.key.level,l,m)};return q}(V.Store2D);H.ClusterInfo=P;H.ClusterStore=J;Object.defineProperties(H,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});