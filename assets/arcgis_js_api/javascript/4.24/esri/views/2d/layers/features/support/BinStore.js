// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../geometry ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/accessorSupport/diffUtils ../../../../../geohash/GeohashTree ../../../../../geohash/geohashUtils ../../../../../geometry/support/Ellipsoid ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/projectionSupport ../../../engine/webgl/DisplayId ../Store2D ./FeatureSetReaderJSON ../../../../../geometry/SpatialReference ../../../../../geometry/Polygon ../../../../../geometry/Extent".split(" "),
function(w,x,y,z,C,k,m,D,n,A,E,B,F,G,p,H,I,J,q,K,L){const r=C.getLogger("esri.view.2d.layers.features.support.BinStore");y=function(t){function u(a,c,b,e){var d=t.call(this,a,b)||this;d._geohashLevel=5;d._geohashBuf=[];d._serviceInfo=e;d.geometryInfo=a.geometryInfo;d._spatialReference=c;d._projectionSupportCheck=p.checkProjectionSupport(c,q.WGS84);d._bitsets.geohash=b.getBitset(b.createBitset());d._bitsets.inserted=b.getBitset(b.createBitset());return d}x._inheritsLoose(u,t);var f=u.prototype;f.destroy=
function(){this._tree&&this._tree.destroy()};f.updateSchema=function(){var a=x._asyncToGenerator(function*(c,b){const e=this._schema;try{yield t.prototype.updateSchema.call(this,c,b),yield this._projectionSupportCheck}catch(g){}const d=m.diff(e,b);if(!b||k.isNone(d)&&!c.source&&!c.storage.filters)e&&(c.mesh=!0);else{if(m.hasDiff(d,"params.fields")||m.hasDiff(d,"params")||!this._tree||c.source)this._tree&&this._tree.destroy(),this._tree=new D.GeohashTree(this._statisticFields,this._serviceInfo),this._tree.onRelease=
g=>g.displayId&&this._storage.releaseDisplayId(g.displayId),this._geohashLevel=this._schema.params.fixedBinLevel,this._rebuildTree(),z("esri-2d-update-debug")&&r.info("Aggregate mesh needs update due to tree changing");z("esri-2d-update-debug")&&r.info("Aggregate mesh needs update due to tree changing");c.targets[b.name]=!0;c.mesh=!1}});return function(c,b){return a.apply(this,arguments)}}();f.clear=function(){this._rebuildTree()};f.sweepFeatures=function(a,c){this._bitsets.inserted.forEachSet(b=>
{a.has(b)||(b=c.lookupByDisplayIdUnsafe(b),this._remove(b))})};f.sweepAggregates=function(a,c,b){};f.onTileData=function(a,c,b,e,d=!0){if(!this._schema||k.isNone(c.addOrUpdate))return c;var g=this._getTransforms(a,this._spatialReference);{const h=c.addOrUpdate.getCursor();for(;h.next();)this._update(h,e)}if(c.status.mesh||!d)return c;e=[];this._getBinsForTile(e,a,g,b);c.addOrUpdate=J.FeatureSetReaderJSON.fromOptimizedFeatures(e,{...this._serviceInfo,geometryType:"esriGeometryPolygon"});c.addOrUpdate.attachStorage(b);
c.clear=!0;c.end=!0;for(g=c.addOrUpdate.getCursor();g.next();)e=g.getDisplayId(),this._bitsets.computed.unset(e),this.setComputedAttributes(b,g,e,a.scale);return c};f.forEach=function(a){this._tree.forEach(a)};f.onTileUpdate=function(a){};f.getAggregate=function(a){const c=H.createDisplayId(a,!0);a=this._tree.findIf(b=>b.displayId===c);return k.applySome(a,b=>this._toAggregateGraphic(b))};f.getAggregates=function(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toAggregateGraphic.bind(this))};
f.getDisplayId=function(a){const c=this._tree.findIf(b=>b.id===a);return k.applySome(c,b=>b.displayId)};f.getFeatureDisplayIdsForAggregate=function(a){const c=this._tree.findIf(b=>b.id===a);return k.mapOr(c,[],b=>Array.from(b.displayIds))};f.getDisplayIdForReferenceId=function(a){const c=this._tree.findIf(b=>1===b.displayIds.size&&b.displayIds.has(a));return k.applySome(c,b=>b.displayId)};f._toAggregateGraphic=function(a){const c=this._spatialReference;return{referenceId:null,objectId:a.id,displayId:a.displayId,
attributes:a.getAttributes(),geometry:B.convertToGeometry(a.getGeometry(c),"esriGeometryPolygon",!1,!1),centroid:null}};f._rebuildTree=function(){this._bitsets.computed.clear();this._bitsets.inserted.clear();this._tree&&this._tree.clear()};f._remove=function(a){const c=a.getDisplayId(),b=a.getXHydrated(),e=a.getYHydrated(),d=this._geohashBuf[2*c],g=this._geohashBuf[2*c+1];this._bitsets.inserted.has(c)&&(this._bitsets.inserted.unset(c),this._tree.removeCursor(a,b,e,d,g,this._geohashLevel))};f._update=
function(a,c){const b=a.getDisplayId(),e=this._bitsets.inserted;c=c.isVisible(b);var d=e.has(b);c!==d&&(c?(c=a.getXHydrated(),d=a.getYHydrated(),this._setGeohash(b,c,d)&&(this._tree.insertCursor(a,b,c,d,this._geohashBuf[2*b],this._geohashBuf[2*b+1],this._geohashLevel),e.set(b))):this._remove(a))};f._setGeohash=function(a,c,b){if(this._bitsets.geohash.has(a))return!0;const e=this._geohashBuf;if(this._spatialReference.isWebMercator)c=c/A.earth.radius*57.29577951308232,n.setGeohashBuf(e,a,57.29577951308232*
(Math.PI/2-2*Math.atan(Math.exp(-b/A.earth.radius))),c-360*Math.floor((c+180)/360),12);else{b=p.project({x:c,y:b},this._spatialReference,q.WGS84);if(!b)return!1;n.setGeohashBuf(e,a,b.y,b.x,12)}this._bitsets.geohash.set(a);return!0};f._getBinsForTile=function(a,c,b,e){try{const {xLL:d,yLL:g,xTR:h,yTR:M,level:N}=this._getGeohashBounds(c),O=this._tree.getBins(d,g,h,M,N);for(const l of O){l.displayId||(l.displayId=e.createDisplayId(!0));const P=l.getGeometry(this._spatialReference,b.tile),v=new F.OptimizedFeature(P,
l.getAttributes());v.objectId=l.id;v.displayId=l.displayId;a.push(v)}}catch(d){r.error("Unable to get bins for tile",c.key.id)}};f._getGeohash=function(a,c,b){const e={geohashX:0,geohashY:0};n.setGeohashXY(e,c,a,b);return e};f._getGeohashBounds=function(a){const c=this._getGeohashLevel(a.key.level);var b=K.fromExtent(L.fromBounds([a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],this._spatialReference));a=p.project(b,this._spatialReference,q.WGS84,{densificationStep:64*a.resolution});a=B.convertFromPolygon(new G,
a,!1,!1);var e=a.coords.filter((g,h)=>!(h%2)),d=a.coords.filter((g,h)=>h%2);a=Math.min(...e);b=Math.min(...d);e=Math.max(...e);d=Math.max(...d);a=this._getGeohash(a,b,c);b=this._getGeohash(e,d,c);return{xLL:a.geohashX,yLL:a.geohashY,xTR:b.geohashX,yTR:b.geohashY,level:c}};f._getGeohashLevel=function(a){return this._schema.params.fixedBinLevel};f._getTransforms=function(a,c){const b={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};c=E.getInfo(c);if(!c)return{tile:b,
left:null,right:null};const [e,d]=c.valid;return{tile:b,left:{...b,translate:[d,a.bounds[3]]},right:{...b,translate:[e-d+a.bounds[0],a.bounds[3]]}}};return u}(I.Store2D);w.BinStore=y;Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});