// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/mat3f32","./config","./util","../style/StyleDefinition"],function(C,G,H,I,l){let N=function(){function D(m,c,k,e,f,d){this._symbols=m;this._styleRepository=e;this._zoom=f;this._currentSymbolCursor=this._currentLayerCursor=0;this._styleProps=new Map;this._allNeededMatrices=new Map;this._gridIndex=new I.GridIndex(c,k,H.COLLISION_GRID_CELL_SIZE);this._si=Math.sin(Math.PI*d/180);this._co=Math.cos(Math.PI*d/180);for(const g of m)for(const h of g.symbols)this._allNeededMatrices.has(h.tile)||
this._allNeededMatrices.set(h.tile,G.clone(h.tile.transforms.tileUnitsToPixels))}var E=D.prototype;E.work=function(m){const c=this._gridIndex,k=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const B=this._symbols[this._currentLayerCursor],F=this._getProperties(B.styleLayerUID);for(;this._currentSymbolCursor<B.symbols.length;this._currentSymbolCursor++){if(99===this._currentSymbolCursor%100&&performance.now()-k>m)return!1;
var e=B.symbols[this._currentSymbolCursor];if(!e.unique.show)continue;{var f=e,d=this._si,g=this._co,h=this._allNeededMatrices.get(e.tile),p=this._zoom;const {iconRotationAlignment:b,textRotationAlignment:r,iconTranslate:t,iconTranslateAnchor:u,textTranslate:v,textTranslateAnchor:n}=F;var w=0;for(const a of f.colliders){const [x,y]=0===a.partIndex?t:v;var z=0===a.partIndex?u:n,q=a.minLod<=p&&p<=a.maxLod;w+=q?0:1;a.enabled=q;a.xScreen=a.xTile*h[0]+a.yTile*h[3]+h[6];a.yScreen=a.xTile*h[1]+a.yTile*h[4]+
h[7];z===l.TranslateAnchor.MAP?(a.xScreen+=g*x-d*y,a.yScreen+=d*x+g*y):(a.xScreen+=x,a.yScreen+=y);l.RotationAlignment.VIEWPORT===(0===a.partIndex?b:r)?(a.dxScreen=a.dxPixels,a.dyScreen=a.dyPixels):(a.dxScreen=g*(a.dxPixels+a.width/2)-d*(a.dyPixels+a.height/2)-a.width/2,a.dyScreen=d*(a.dxPixels+a.width/2)+g*(a.dyPixels+a.height/2)-a.height/2)}0<f.colliders.length&&w===f.colliders.length&&(f.unique.show=!1)}f=e.unique;if(!f.show)continue;const {iconAllowOverlap:J,iconIgnorePlacement:K,textAllowOverlap:L,
textIgnorePlacement:M}=F;for(const b of e.colliders)if(b.enabled&&(d=f.parts[b.partIndex],d.show)){if(g=!(b.partIndex?L:J))a:{g=b.xScreen+b.dxScreen;h=b.yScreen+b.dyScreen;p=g+b.width;w=h+b.height;const [r,t,u,v]=c.getCellSpan(g,h,p,w);for(z=t;z<=v;z++)for(q=r;q<=u;q++){var A=c.cells[z][q];for(const n of A){A=n.xScreen+n.dxScreen;const a=n.yScreen+n.dyScreen,x=A+n.width,y=a+n.height;if(!(p<A||g>x||w<a||h>y)){g=!0;break a}}}g=!1}g&&(b.hard?f.show=!1:d.show=!1)}if(f.show)for(const b of e.colliders){if(!b.enabled)continue;
if(b.partIndex?M:K)continue;if(!f.parts[b.partIndex].show)continue;e=b.xScreen+b.dxScreen;d=b.yScreen+b.dyScreen;const [r,t,u,v]=this._gridIndex.getCellSpan(e,d,e+b.width,d+b.height);for(e=t;e<=v;e++)for(d=r;d<=u;d++)this._gridIndex.cells[e][d].push(b)}}}return!0};E._getProperties=function(m){var c=this._styleProps.get(m);if(c)return c;c=this._zoom;const k=this._styleRepository.getStyleLayerByUID(m);var e=k.getLayoutValue("symbol-placement",c)!==l.SymbolPlacement.POINT;let f=k.getLayoutValue("icon-rotation-alignment",
c);f===l.RotationAlignment.AUTO&&(f=e?l.RotationAlignment.MAP:l.RotationAlignment.VIEWPORT);let d=k.getLayoutValue("text-rotation-alignment",c);d===l.RotationAlignment.AUTO&&(d=e?l.RotationAlignment.MAP:l.RotationAlignment.VIEWPORT);e=k.getPaintValue("icon-translate",c);const g=k.getPaintValue("icon-translate-anchor",c),h=k.getPaintValue("text-translate",c),p=k.getPaintValue("text-translate-anchor",c);c={iconAllowOverlap:k.getLayoutValue("icon-allow-overlap",c),iconIgnorePlacement:k.getLayoutValue("icon-ignore-placement",
c),textAllowOverlap:k.getLayoutValue("text-allow-overlap",c),textIgnorePlacement:k.getLayoutValue("text-ignore-placement",c),iconRotationAlignment:f,textRotationAlignment:d,iconTranslateAnchor:g,iconTranslate:e,textTranslateAnchor:p,textTranslate:h};this._styleProps.set(m,c);return c};return D}();C.CollisionJob=N;Object.defineProperties(C,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});