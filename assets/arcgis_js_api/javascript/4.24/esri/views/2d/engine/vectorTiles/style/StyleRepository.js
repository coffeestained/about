// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define(["./StyleDefinition","./StyleLayer"],function(k,n){return function(){function p(a){this._style=a;this.backgroundBucketIds=[];this._uidToLayer=new Map;this._layerByName={};this._runningId=0;a.layers||(a.layers=[]);this.version=parseFloat(a.version);if(this.layers=a.layers.map((b,c,g)=>this._create(b,c,g)).filter(b=>!!b))for(let b=0;b<this.layers.length;b++)a=this.layers[b],this._layerByName[a.id]=a,this._uidToLayer.set(a.uid,a),a.type===k.StyleLayerType.BACKGROUND&&this.backgroundBucketIds.push(a.id);
this._identifyRefLayers()}var h=p.prototype;h.isPainterDataDriven=function(a){return(a=this._layerByName[a])?a.isPainterDataDriven():!1};h.getStyleLayerId=function(a){return a>=this.layers.length?null:this.layers[a].id};h.getStyleLayerByUID=function(a){a=this._uidToLayer.get(a);return null!=a?a:null};h.getStyleLayerIndex=function(a){return(a=this._layerByName[a])?this.layers.indexOf(a):-1};h.setStyleLayer=function(a,b){if(a&&a.id){var c=this._style;null!=b&&b>=this.layers.length&&(b=this.layers.length-
1);var g=!0,f;if(f=this._layerByName[a.id]){const e=this.layers.indexOf(f);b||(b=e);b===e?(g=!1,f=p._recreateLayer(a,f),this.layers[b]=f,c.layers[b]=a):(this.layers.splice(e,1),c.layers.splice(e,1),f=this._create(a,b,this.layers),this.layers.splice(b,0,f),c.layers.splice(b,0,a))}else f=this._create(a,b,this.layers),!b||b>=this.layers.length?(this.layers.push(f),c.layers.push(a)):(this.layers.splice(b,0,f),c.layers.splice(b,0,a));this._layerByName[a.id]=f;this._uidToLayer.set(f.uid,f);g&&this._recomputeZValues();
this._identifyRefLayers()}};h.getStyleLayer=function(a){return(a=this._layerByName[a])?{type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:a.layout,paint:a.paint}:null};h.deleteStyleLayer=function(a){const b=this._layerByName[a];b&&(delete this._layerByName[a],this._uidToLayer.delete(b.uid),a=this.layers.indexOf(b),this.layers.splice(a,1),this._style.layers.splice(a,1),this._recomputeZValues(),this._identifyRefLayers())};
h.getLayerById=function(a){return this._layerByName[a]};h.getLayoutProperties=function(a){return(a=this._layerByName[a])?a.layout:null};h.getPaintProperties=function(a){return(a=this._layerByName[a])?a.paint:null};h.setPaintProperties=function(a,b){if(a=this._layerByName[a]){var c=p._recreateLayer({type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:a.layout,paint:b},a),g=this.layers.indexOf(a);this.layers[g]=c;this._style.layers[g].paint=
b;this._layerByName[a.id]=c;this._uidToLayer.set(a.uid,c)}};h.setLayoutProperties=function(a,b){if(a=this._layerByName[a]){var c=p._recreateLayer({type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:b,paint:a.paint},a),g=this.layers.indexOf(a);this.layers[g]=c;this._style.layers[g].layout=b;this._layerByName[a.id]=c;this._uidToLayer.set(a.uid,c)}};h.setStyleLayerVisibility=function(a,b){if(a=this._layerByName[a]){var c=a.layout||
{};c.visibility=b;b=p._recreateLayer({type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:c,paint:a.paint},a);var g=this.layers.indexOf(a);this.layers[g]=b;this._style.layers[g].layout=c;this._layerByName[a.id]=b;this._uidToLayer.set(a.uid,b)}};h.getStyleLayerVisibility=function(a){var b;a=this._layerByName[a];if(!a)return"none";a=a.layout;return null!=(b=null==a?void 0:a.visibility)?b:"visible"};h._recomputeZValues=function(){const a=
this.layers,b=1/(a.length+1);for(let c=0;c<a.length;c++)a[c].z=1-(1+c)*b};h._identifyRefLayers=function(){const a=[],b=[];let c=0;for(const d of this.layers){const l=d.layout;if(d.type===k.StyleLayerType.FILL){var g,f=d,e=d.source+"|"+d.sourceLayer;e+=null!=(g="|"+(null==l?void 0:l.visibility))?g:"";e+="|"+d.minzoom;e+="|"+d.maxzoom;e+="|"+JSON.stringify(d.filter);if(f.hasDataDrivenFill||f.hasDataDrivenOutline)e+="|"+c;a.push({key:e,layer:d})}else if(d.type===k.StyleLayerType.LINE){var m;f=d;e=d.source+
"|"+d.sourceLayer;e+=null!=(m="|"+(null==l?void 0:l.visibility))?m:"";e+="|"+d.minzoom;e+="|"+d.maxzoom;e+="|"+JSON.stringify(d.filter);e+="|"+(void 0!==l?l["line-cap"]:"");e+="|"+(void 0!==l?l["line-join"]:"");f.hasDataDrivenLine&&(e+="|"+c);b.push({key:e,layer:d})}++c}this._assignRefLayers(a);this._assignRefLayers(b)};h._assignRefLayers=function(a){a.sort((m,d)=>m.key<d.key?-1:m.key>d.key?1:0);let b,c;const g=a.length;for(let m=0;m<g;m++){const d=a[m];if(d.key===b)d.layer.refLayerId=c;else if(b=
d.key,c=d.layer.id,d.layer.type===k.StyleLayerType.FILL){if(!d.layer.getPaintProperty("fill-outline-color"))for(var f=m+1;f<g;f++){var e=a[f];if(e.key===b){if(e.layer.getPaintProperty("fill-outline-color")){a[m]=e;a[f]=d;c=e.layer.id;break}}else break}}else if(d.layer.type===k.StyleLayerType.LINE)for(f=d.layer,e=m+1;e<g;e++){const l=a[e];if(l.key!==b)break;const q=l.layer;if(f.canUseThinTessellation&&!q.canUseThinTessellation||!f.canUseThinTessellation&&(q.getPaintProperty("line-pattern")||q.getPaintProperty("line-dasharray")))f=
q,a[m]=l,a[e]=d,c=l.layer.id}}};h._create=function(a,b,c){b=1-1/(c.length+1)*(1+b);c=this._runningId++;switch(a.type){case "background":return new n.BackgroundStyleLayer(k.StyleLayerType.BACKGROUND,a,b,c);case "fill":return new n.FillStyleLayer(k.StyleLayerType.FILL,a,b,c);case "line":return new n.LineStyleLayer(k.StyleLayerType.LINE,a,b,c);case "symbol":return new n.SymbolStyleLayer(k.StyleLayerType.SYMBOL,a,b,c);case "raster":console.warn(`Unsupported vector tile raster layer ${a.id}`);case "circle":return new n.CircleStyleLayer(k.StyleLayerType.CIRCLE,
a,b,c)}};p._recreateLayer=function(a,b){switch(a.type){case "background":return new n.BackgroundStyleLayer(k.StyleLayerType.BACKGROUND,a,b.z,b.uid);case "fill":return new n.FillStyleLayer(k.StyleLayerType.FILL,a,b.z,b.uid);case "line":return new n.LineStyleLayer(k.StyleLayerType.LINE,a,b.z,b.uid);case "symbol":return new n.SymbolStyleLayer(k.StyleLayerType.SYMBOL,a,b.z,b.uid);case "raster":console.warn(`Unsupported vector tile raster layer ${a.id}`);case "circle":return new n.CircleStyleLayer(k.StyleLayerType.CIRCLE,
a,b.z,b.uid)}};return p}()});