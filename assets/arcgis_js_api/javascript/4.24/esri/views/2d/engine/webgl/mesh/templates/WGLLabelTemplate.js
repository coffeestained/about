// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/mathUtils ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../../../symbols/cim/enums ../../alignmentUtils ../../color ../../definitions ../../enums ../../number ../../materialKey/MaterialKey ./segmentUtils ./WGLTextTemplate".split(" "),function(w,D,E,x,v,y,z,r,A,F,G,t,H,B,I){const J=E.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),
K=(n,l="mapview-labeling")=>J.error(new D(l,n)),L=function(n){const l=new Map;return k=>{l.has(k)||l.set(k,n(k));return l.get(k)}}(n=>{let l=0;if(0===n)return Infinity;for(;!(n%2);)l++,n/=2;return l});return function(n){function l(a,c,b,e){var f,d,g;var h=n.call(this,a,b.font.size,b.haloSize||0,b.font.size,b.color&&A.premultiplyAlphaRGBAArray(b.color)||0,b.haloColor&&A.premultiplyAlphaRGBAArray(b.haloColor)||0,b.horizontalAlignment,b.verticalAlignment,r.isMapAligned(c.labelPlacement)?z.Alignment.MAP:
z.Alignment.SCREEN,b.font.decoration,!1,b.angle||0,b.xoffset,b.yoffset,b.lineWidth,b.lineHeight,null,null,null,null,null)||this;h._outLineLabelAngle=0;h._refPlacementPadding=0;h._refPlacementDirX=0;h._refPlacementDirY=0;h._refOffsetX=0;h._refOffsetY=0;h._zoomLevel=0;h.geometryType=G.WGLGeometryType.LABEL;h._allowOverrun=null!=(f=c.allowOverrun)?f:!1;h._repeatLabel=null!=(d=c.repeatLabel)?d:!0;h._labelPosition=null!=(g=c.labelPosition)?g:"curved";f=!!c.minScale&&e.scaleToZoom(c.minScale)||0;f=x.clamp(f,
0,25.5);e=!!c.maxScale&&e.scaleToZoom(c.maxScale)||255;e=x.clamp(e,0,25.5);const [q,m]=r.getAlignmentFromPlacement(c.labelPlacement);h._xAlignD=q;h._yAlignD=m;h._minZoom=f;h._maxZoom=e;h._refPlacementPadding=y.pt2px(b.haloSize)+F.TEXT_PLACEMENT_PADDING;h._repeatLabelDistance=c.repeatLabelDistance?y.pt2px(c.repeatLabelDistance):128;a=H.LabelMaterialKey.load(a);a.sdf=!0;h._materialKey=a.data;return h}w._inheritsLoose(l,n);l.fromLabelClass=function(a,c){if("esriServerLinePlacementCenterAlong"===a.labelPlacement){const b=
a.symbol;b.xoffset=0;b.yoffset=0;b.angle=0;b.font.decoration="none"}return new l(a.materialKey,a,a.symbol,c)};var k=l.prototype;k.setZoomLevel=function(a){this._zoomLevel=a};k.bindReferenceTemplate=function(a){let c=r.getXDirection(this._xAlignD),b=r.getYDirection(this._yAlignD);this._refOffsetY=this._refOffsetX=0;if(v.isNone(a))this._refSymbolAndPlacementOffset=t.i8888to32(0,0,Math.floor(127*c+127),Math.floor(127*b+127));else{if("circle"===a.boundsType&&(c||b)){var e=Math.sqrt(c*c+b*b);c/=e;b/=e}e=
Math.max(a.height,a.width);this._refSymbolAndPlacementOffset=t.i8888to32(4*this._refPlacementPadding,e,Math.floor(127*c+127),Math.floor(127*b+127));this._referenceSize=e;this._refPlacementDirX=c;this._refPlacementDirY=b;this._refOffsetX=a.xOffset;this._refOffsetY=a.yOffset}};k._write=function(a,c){if(!v.isNone(this._shapingInfo)){var b=this._shapingInfo,e=c.getDisplayId(),f="esriGeometryPolygon"===c.geometryType?c.readLegacyCentroid():c.readLegacyGeometry();if(f)switch(this.current={out:a,inId:e,
inShaping:b,zoomLevel:this._zoomLevel},c.geometryType){case "esriGeometryPolyline":this._placeLineLabels(f);break;case "esriGeometryPoint":case "esriGeometryPolygon":this._placePointLabels(f);break;default:K("mapview-labeling",`Geometry of type ${c.geometryType} is not supported`)}}};k._isVisible=function(a,c){const b=Math.floor(10*this.current.zoomLevel);return Math.floor(10*a)<=b&&b<=Math.floor(10*c)};k._placePointLabels=function(a){const {out:c,inId:b,inShaping:e}=this.current;this._writeGlyphs(c,
b,a,e)};k._placeLineLabels=function(a){a=B.smoothPaths(a.paths,this.current.inShaping.bounds.width);const c=this._placeSubdivGlyphs.bind(this),b=(this._shapedBox.width+this._repeatLabelDistance)/2;for(const e of a)B.pathDivide(e,b,c,this._repeatLabel)};k._placeSubdivGlyphs=function(a,c,b,e){var f=L(c),d=this._shapedBox.width/2,g=Math.sqrt(this._repeatLabelDistance)/2;b=Math.min(b,e-b);d=this.current.inShaping.isMultiline?25:Math.log2(b/(g+d/2));f=Math.max(this._minZoom,this.current.zoomLevel+1-(0===
c?d:Math.min(f,d)));d=this.current.zoomLevel-f;g=this._shapedBox.width/2*2**d;this.current.inShaping.isMultiline?0===c&&this._placeStraight(a,f):this._allowOverrun&&0>d?this._placeStraightAlong(a,this._minZoom):"parallel"===this._labelPosition?this._placeStraightAlong(a,f):"curved"===this._labelPosition&&this._placeCurved(a,f,g)};k._placeStraight=function(a,c){const {out:b,inId:e,inShaping:f}=this.current,d=Math.ceil((180/Math.PI*a.angle+180)%360);this._outLineLabelAngle=Math.round(254/360*Math.ceil(180/
Math.PI*a.angle%360));this._writeGlyphs(b,e,a,f,c);this._outLineLabelAngle=Math.round(254/360*d);this._writeGlyphs(b,e,a,f,c)};k._placeCurved=function(a,c,b){const {out:e,inId:f}=this.current;e.metricStart(f,c,a.x,a.y,0,0,0,0);const d=a.clone(),g=(180/Math.PI*a.angle+180)%360;this._outLineLabelAngle=Math.round(180/Math.PI*a.angle%360*(254/360));this._placeFirst(d,c,1);this._placeBack(a,d,c,b,1);this._placeForward(a,d,c,b,1);this._outLineLabelAngle=Math.round(254/360*g);this._placeFirst(d,c,0);this._placeBack(a,
d,c,b,0);this._placeForward(a,d,c,b,0);e.metricEnd()};k._placeStraightAlong=function(a,c){const {out:b,inId:e}=this.current;b.metricStart(e,c,a.x,a.y,0,0,0,0);const f=a.clone(),d=(180/Math.PI*a.angle+180)%360;this._outLineLabelAngle=Math.round(180/Math.PI*a.angle%360*(254/360));this._placeFirst(f,c,1,!0);this._outLineLabelAngle=Math.round(254/360*d);this._placeFirst(f,c,0,!0);b.metricEnd()};k._placeBack=function(a,c,b,e,f){const d=a.clone();for(a=a.backwardLength+0;d.prev()&&!(a>=e);)this._placeOnSegment(d,
c,a,b,-1,f),a+=d.length+0};k._placeForward=function(a,c,b,e,f){const d=a.clone();for(a=a.remainingLength+0;d.next()&&!(a>=e);)this._placeOnSegment(d,c,a,b,1,f),a+=d.length+0};k._placeFirst=function(a,c,b,e=!1){const f=this.current.inShaping;var d=f.glyphs;const g=this.current.zoomLevel,{out:h,inId:q}=this.current;for(const m of d)d=m.x>f.bounds.x?b:1-b,d=Math.max(0,g+Math.log2(Math.abs(m.x+m.width/2-f.bounds.x)/(d*a.remainingLength+(1-d)*a.backwardLength))),d=Math.max(c,e?0:d),m.maxZoom=25,m.angle=
a.angle+(1-b)*Math.PI,m.minZoom=d,this._writeGlyph(h,q,a.x,a.y,m),b&&this._isVisible(m.minZoom,m.maxZoom)&&(d=m.bounds,h.metricBoxWrite(d.center[0],d.center[1],d.width,d.height))};k._placeOnSegment=function(a,c,b,e,f,d){var g=this.current.inShaping.glyphs;const {out:h,inId:q}=this.current,m=this.current.inShaping,C=this.current.zoomLevel;var M=a.x+a.dx/a.length*-f*b,N=a.y+a.dy/a.length*-f*b;for(const p of g)if((g=p.x>m.bounds.x?d:1-d)&&1===f||!g&&-1===f){var u=Math.abs(p.x+p.width/2-m.bounds.x);g=
Math.max(0,C+Math.log2(u/b)-.1);u=Math.max(e,C+Math.log2(u/(b+a.length+0)));0!==g&&(p.angle=a.angle+(1-d)*Math.PI,p.minZoom=u,p.maxZoom=g,this._writeGlyph(h,q,M,N,p),d&&this._isVisible(p.minZoom,p.maxZoom)&&(g=p.bounds,h.metricBoxWrite(g.center[0]+(a.x-c.x),g.center[1]+(a.y-c.y),g.width,g.height)))}};k._writeGlyphs=function(a,c,b,e,f=this._minZoom){if(!(0>b.x||512<=b.x||0>b.y||512<=b.y)){var d=b.x+this._refOffsetX;b=b.y-this._refOffsetY;for(const g of e.glyphs)g.minZoom=f,g.maxZoom=this._maxZoom,
this._writeGlyph(a,c,d,b,g);e=e.boundsT;a.metricStart(c,f,d,b,this._refPlacementDirX,this._refPlacementDirY,this._referenceSize,this._materialKey);a.metricBoxWrite(e.center[0],e.center[1],e.width,e.height);a.metricEnd()}};k._writeVertexCommon=function(a,c,b,e){const f=this._color,d=this._haloColor,g=t.i8888to32(0,0,this._size,this._haloSize);e=t.i8888to32(Math.floor(10*Math.max(e.minZoom,this._minZoom)),Math.floor(10*Math.min(e.maxZoom,this._maxZoom)),this._outLineLabelAngle,0);a.vertexWrite(b);a.vertexWrite(c);
a.vertexWrite(f);a.vertexWrite(d);a.vertexWrite(g);a.vertexWrite(this._refSymbolAndPlacementOffset);a.vertexWrite(e)};w._createClass(l,[{key:"_shapedBox",get:function(){return v.unwrap(this._shapingInfo).bounds}}]);return l}(I)});