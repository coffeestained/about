// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/maybe ../../../../../core/screenUtils ../definitions ./CollisionGrid ./visualVariableSimpleUtils".split(" "),function(A,y,D,B,x,E){function v(k,g){const e=[];k.forEachTile(c=>e.push(c));e.sort((c,f)=>c.instanceId-f.instanceId);e.forEach(c=>{y.isSome(c.labelMetrics)&&c.isReady&&g(c,c.labelMetrics.getCursor())})}function F(k){return g=>D.pt2px(E.getSizeForValueSimple(g,k))}function G(k){for(const g of k)if(k="featureReduction"in g&&g.featureReduction&&"labelingInfo"in
g.featureReduction&&g.featureReduction,k=(null==k?void 0:k.labelingInfo)||[],k=[...g.labelingInfo||[],...k],g.labelsVisible&&k.length&&k.some(e=>"none"===e.deconflictionStrategy))return!0;return!1}let I=function(){function k(){}var g=k.prototype;g.run=function(e,c,f){const h=[];for(let t=e.length-1;0<=t;t--)a:{var d=void 0,b=h,a=e[t];if(!a.layer||"feature"!==a.layer.type&&"csv"!==a.layer.type&&"geojson"!==a.layer.type&&"ogc-feature"!==a.layer.type&&"stream"!==a.layer.type&&"subtype-group"!==a.layer.type&&
"wfs"!==a.layer.type)break a;const u=a.layer.geometryType,w=!G("subtype-group"===a.layer.type?a.layer.sublayers.items:[a.layer]),p={};if("subtype-group"!==a.layer.type){if("heatmap"===(null==(d=a.tileRenderer)?void 0:d.type))break a;b:{d=a.layer.renderer;if(d="visualVariables"in d&&d.visualVariables)for(const q of d)if("size"===q.type){d=F(q);break b}d=null}p[0]=d}d=a.tileRenderer;y.isNone(d)||b.push({tileRenderer:d,vvEvaluators:p,deconflictionEnabled:w,geometryType:u,visible:a.layer.visible&&!a.suspended})}this._transformMetrics(h,
c);this._runCollision(h,c,f)};g._runCollision=function(e,c,f){const [h,d]=c.state.size;c=new x.CollisionBitsetGrid(h*c.pixelRatio,d*c.pixelRatio);for(const {tileRenderer:b,deconflictionEnabled:a,visible:t}of e){const u=b.featuresView.attributeView;a?t?(this._prepare(b),this._collideVisible(c,b,f),this._collideInvisible(c,b)):v(b,(w,p)=>{for(;p.nextId();)u.setLabelMinZoom(p.id,255)}):v(b,(w,p)=>{for(;p.nextId();)u.setLabelMinZoom(p.id,0)})}};g._isFiltered=function(e,c,f){c=c.getFilterFlags(e);e=!f.hasFilter||
!!(c&B.FILTER_FLAG_0);f=y.isNone(f.featureEffect)||f.featureEffect.excludedLabelsVisible||!!(c&B.EFFECT_FLAG_0);return!(e&&f)};g._prepare=function(e){const c=e.featuresView.attributeView,f=new Set;v(e,(h,d)=>{for(;d.nextId();)f.has(d.id)||(f.add(d.id),this._isFiltered(d.id,c,e.layerView)?c.setLabelMinZoom(d.id,254):0!==c.getLabelMinZoom(d.id)?c.setLabelMinZoom(d.id,255):c.setLabelMinZoom(d.id,0))})};g._collideVisible=function(e,c,f){const h=c.featuresView.attributeView,d=new Set;v(c,(b,a)=>{for(;a.nextId();)if(!d.has(a.id))if(b.key.level!==
f)h.setLabelMinZoom(a.id,254);else if(0===h.getLabelMinZoom(a.id))switch(e.insertMetrics(a)){case x.HAS_COLLISION:h.setLabelMinZoom(a.id,254);d.add(a.id);break;case x.NONE:h.setLabelMinZoom(a.id,0),d.add(a.id)}})};g._collideInvisible=function(e,c){const f=c.featuresView.attributeView,h=new Set;v(c,(d,b)=>{for(;b.nextId();)if(!h.has(b.id)&&255===f.getLabelMinZoom(b.id))switch(e.insertMetrics(b)){case x.HAS_COLLISION:f.setLabelMinZoom(b.id,255);h.add(b.id);break;case x.NONE:f.setLabelMinZoom(b.id,0),
h.add(b.id)}})};g._transformMetrics=function(e,c){for(const {tileRenderer:f,geometryType:h,vvEvaluators:d}of e)v(f,(b,a)=>{const t=f.featuresView.attributeView;b=b.transforms.labelMat2d;b[4]=Math.round(b[4]);b[5]=Math.round(b[5]);const u=b[4],w=b[5],p="polyline"===h;for(;a.next();){const H=a.boundsCount,z=a.anchorX,C=a.anchorY;var q=a.size,r=d[0];if(y.isSome(r)){var l=t.getVVSize(a.id);r=r(l);q=isNaN(r)||null==r||Infinity===r?q:r}r=q/2*a.directionX;q=q/2*a.directionY;for(l=0;l<H;l++){var m=z,n=a.anchorY;
p?(m=m+a.boundsX(l)+r,n=n+a.boundsY(l)+q,c.state.rotation?(m=b[0]*m+b[2]*n+b[4],n=b[1]*m+b[3]*n+b[5]):(m+=u,n+=w),a.setBoundsComputedAnchorX(l,Math.floor(m)),a.setBoundsComputedAnchorY(l,Math.floor(n))):(c.state.rotation?(m=b[0]*z+b[2]*C+b[4],n=b[1]*z+b[3]*C+b[5]):(m+=u,n+=w),m=m+a.boundsX(l)+r,n=n+a.boundsY(l)+q,a.setBoundsComputedAnchorX(l,m),a.setBoundsComputedAnchorY(l,n))}}})};return k}();A.CollisionEngine=I;Object.defineProperties(A,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});