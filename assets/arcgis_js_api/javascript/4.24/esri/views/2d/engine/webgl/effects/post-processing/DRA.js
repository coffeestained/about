// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/Logger ../../VertexStream ../../../../../webgl/enums ../../../../../webgl/FramebufferObject ../../../../../webgl/Texture".split(" "),function(z,v,D,b,E,F){const G=v.getLogger("esri.views.2d.engine.webgl.effects.post-processing.DRA");v=function(){function A(){this._fbos=null;this._colorAttachmentsPoints=[b.ColorAttachment.COLOR_ATTACHMENT0,b.ColorAttachment.COLOR_ATTACHMENT1];this._size=[0,0];this._programDesc={"min-max":{vsPath:"post-processing/pp",fsPath:"post-processing/dra/min-max",
attributes:new Map([["a_position",0]])},dra:{vsPath:"post-processing/pp",fsPath:"post-processing/dra",attributes:new Map([["a_position",0]])}}}var q=A.prototype;q.dispose=function(){this._disposeFBOs();this._layerTexture&&(this._layerTexture.dispose(),this._layerTexture=null)};q.draw=function(c,d,l){this._createOrResizeResources(c);const {context:a,state:f,painter:g,pixelRatio:h}=c;({materialManager:c}=g);l=this._programDesc;var {size:m}=f;const B=this._fbos,k=[h*m[0],h*m[1]],C=a.capabilities.drawBuffers;
if(C){this._quad||(this._quad=new D(a,[-1,-1,1,-1,-1,1,1,1]));m=this._layerTexture;d.copyToTexture(0,0,k[0],k[1],0,0,m);var r=this._quad;r.bind();var n=c.getProgram(l["min-max"]);a.useProgram(n);a.setBlendingEnabled(!1);var w=d.colorTexture,x=d.colorTexture,y=[k[0],k[1]],p=[0,0];for(let t=0;t<B.length;t++){const u=B[t];var e=u.descriptor;p[0]=e.width;p[1]=e.height;a.bindFramebuffer(u);C.drawBuffers(this._colorAttachmentsPoints);a.setViewport(0,0,e.width,e.height);e=t;6<e&&(e=6);a.bindTexture(w,e);
a.bindTexture(x,e+1);n.setUniform1i("u_minTexture",e);n.setUniform1i("u_maxTexture",e+1);n.setUniform2fv("u_srcResolution",y);n.setUniform2fv("u_dstResolution",p);r.draw();w=u.getColorTexture(b.ColorAttachment.COLOR_ATTACHMENT0);x=u.getColorTexture(b.ColorAttachment.COLOR_ATTACHMENT1);y[0]=p[0];y[1]=p[1]}a.setViewport(0,0,k[0],k[1]);a.bindFramebuffer(d);d=c.getProgram(l.dra);a.useProgram(d);a.bindTexture(w,5);a.bindTexture(x,6);a.bindTexture(m,7);d.setUniform1i("u_minColor",5);d.setUniform1i("u_maxColor",
6);d.setUniform1i("u_texture",7);a.setStencilWriteMask(0);a.setStencilTestEnabled(!1);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);r.draw();a.setBlendingEnabled(!0);a.setBlendFunction(b.BlendFactor.ONE,b.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setStencilTestEnabled(!0);r.unbind()}else G.error("esri.DRA","WebGL Extension WEBGL_draw_buffers isn't supported!")};q._createOrResizeResources=function(c){const {context:d,state:l,pixelRatio:a}=c;({size:c}=l);let f=Math.round(a*c[0]),g=Math.round(a*c[1]);
if(this._size[0]!==f||this._size[1]!==g){this._size[0]=f;this._size[1]=g;this._disposeFBOs();for(this._fbos=[];1<f||1<g;){f=Math.max(1,Math.floor((f+2-1)/2)|0);g=Math.max(1,Math.floor((g+2-1)/2)|0);var h={pixelFormat:b.PixelFormat.RGBA,internalFormat:b.PixelFormat.RGBA,dataType:b.PixelType.UNSIGNED_BYTE,samplingMode:b.TextureSamplingMode.NEAREST,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,flipped:!1,width:f,height:g};h=new E.FramebufferObject(d,{depthStencilTarget:b.DepthStencilTargetType.NONE,width:f,
height:g},[h,h]);this._fbos.push(h)}this._layerTexture?this._layerTexture.resize(Math.round(a*c[0]),Math.round(a*c[1])):this._layerTexture=new F.Texture(d,{target:b.TextureType.TEXTURE_2D,pixelFormat:b.PixelFormat.RGBA,internalFormat:b.PixelFormat.RGBA,dataType:b.PixelType.UNSIGNED_BYTE,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:b.TextureSamplingMode.LINEAR,flipped:!1,width:Math.round(a*c[0]),height:Math.round(a*c[1])})}};q._disposeFBOs=function(){if(this._fbos){for(const c of this._fbos)c.dispose();
this._fbos.length=0;this._fbos=null}};return A}();z.DRA=v;Object.defineProperties(z,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});