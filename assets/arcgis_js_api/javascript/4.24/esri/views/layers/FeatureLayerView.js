// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/deprecate ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/FeatureEffect ../../layers/support/FeatureFilter ../../layers/support/fieldUtils ../../layers/support/floorFilterUtils ../../rest/support/Query ../../support/arcadeOnDemand ./support/popupUtils".split(" "),
function(u,n,C,A,F,p,D,w,r,M,N,O,G,H,I,J,e,E,K,L,x){const y=F.getLogger("esri.views.layers.FeatureLayerView");return g=>{g=function(B){function z(...a){a=B.call(this,...a)||this;a._updatingRequiredFieldsPromise=null;a.filter=null;a.timeExtent=null;a.layer=null;a.requiredFields=[];a.view=null;return a}u._inheritsLoose(z,B);var k=z.prototype;k.initialize=function(){this.handles.add([w.watch(()=>{var a;const c=this.layer;return[null==c?void 0:null==(a=c.elevationInfo)?void 0:a.featureExpressionInfo,
null==c?void 0:c.displayField,null==c?void 0:c.timeInfo,c&&"renderer"in c&&c.renderer,c&&"labelingInfo"in c&&c.labelingInfo,c&&"floorInfo"in c&&c.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),w.syncAndInitial),w.on(()=>{var a;return null==(a=this.view)?void 0:a.floors},"change",()=>this._handleRequiredFieldsChange()),w.on(()=>{const a=this.layer;return a&&"sublayers"in a&&a.sublayers},"change",()=>this._handleRequiredFieldsChange())])};k.highlight=
function(a){throw Error("missing implementation");};k.createQuery=function(){var a={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};a=p.isSome(this.filter)?this.filter.createQuery(a):new K(a);if("feature"===this.layer.type){const c=E.getFloorFilterClause(this);p.isSome(c)&&(a.where=a.where?`(${a.where}) AND (${c})`:c)}p.isSome(this.timeExtent)&&(a.timeExtent=p.isSome(a.timeExtent)?a.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return a};k.queryFeatures=
function(a,c){throw Error("missing implementation");};k.queryObjectIds=function(a,c){throw Error("missing implementation");};k.queryFeatureCount=function(a,c){throw Error("missing implementation");};k.queryExtent=function(a,c){throw Error("missing implementation");};k.fetchPopupFeatures=function(){var a=u._asyncToGenerator(function*(c,b){if(c=this.validateFetchPopupFeatures(b))throw c;return this.fetchClientPopupFeatures(b)});return function(c,b){return a.apply(this,arguments)}}();k._loadArcadeModules=
function(a){if(a.get("expressionInfos.length")||Array.isArray(a.content)&&a.content.some(c=>"expression"===c.type))return L.loadArcade()};k._handleRequiredFieldsChange=function(){const a=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a);a.then(()=>{this._updatingRequiredFieldsPromise===a&&this._set("_updatingRequiredFieldsPromise",null)})};k._updateRequiredFields=function(){var a=u._asyncToGenerator(function*(){if(this.layer&&this.view){var c="3d"===this.view.type,{layer:b,
layer:{fieldsIndex:m,objectIdField:l}}=this,f="renderer"in b&&b.renderer,h="orderBy"in b&&b.orderBy,q=b.featureReduction,d=new Set;f=yield D.eachAlways([f?f.collectRequiredFields(d,m):null,e.collectLabelingFields(d,b),c?e.collectElevationFields(d,b):null,p.isSome(this.filter)?e.collectFilterFields(d,b,this.filter):null,p.isSome(this.featureEffect)?e.collectFilterFields(d,b,this.featureEffect.filter):null,q?e.collectFeatureReductionFields(d,b,q):null,h?e.collectOrderByInfos(d,b,h):null]);b.timeInfo&&
this.timeExtent&&e.collectFields(d,b.fieldsIndex,[b.timeInfo.startField,b.timeInfo.endField]);"feature"===b.type&&b.floorInfo&&e.collectFields(d,b.fieldsIndex,[b.floorInfo.floorField]);"subtype-group"===b.type&&(e.collectField(d,m,b.subtypeField),h=b.sublayers.map(t=>{var v;return Promise.all([null==(v=t.renderer)?void 0:v.collectRequiredFields(d,m),e.collectLabelingFields(d,t)])}),yield D.eachAlways(h));for(const t of f)t.error&&y.error(t.error);e.collectField(d,m,l);c&&"displayField"in b&&b.displayField&&
e.collectField(d,m,b.displayField);c=Array.from(d).sort();this._set("requiredFields",c)}});return function(){return a.apply(this,arguments)}}();k.validateFetchPopupFeatures=function(a){if(p.isNone(a))return null;for(const c of a.clientGraphics){const b=c.layer;if("popupEnabled"in b&&!b.popupEnabled)return new A("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:b});if(c.isAggregate){if(!(b.featureReduction&&"popupTemplate"in b.featureReduction&&b.featureReduction.popupEnabled&&b.featureReduction.popupTemplate))return new A("featurelayerview:fetchPopupFeatures",
"Popups are disabled",{layer:b})}else if("popupTemplate"in b&&!x.getFetchPopupTemplate(b,a))return new A("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:b})}};k.fetchClientPopupFeatures=function(){var a=u._asyncToGenerator(function*(c){const b=p.isSome(c)?c.clientGraphics:null;if(!b||0===b.length)return[];const m=Array(b.length),l=new Map,f=yield this.createPopupQuery(c);for(let q=0;q<b.length;q++){const d=b[q];if(d.isAggregate){m[q]=d;continue}var {layer:h}=
d;if(!("popupEnabled"in h))continue;const t=e.unpackFieldNames(this.layer.fieldsIndex,f.outFields);h=x.getFetchPopupTemplate(h,c);if(p.isNone(h))continue;const v=yield this._loadArcadeModules(h);v&&v.arcadeUtils.hasGeometryOperations(h)||!e.featureHasFields(t,d)?l.set(d.getObjectId(),q):m[q]=d}if("stream"===this.layer.type||0===l.size)return m.filter(Boolean);f.objectIds=Array.from(l.keys());try{const q=yield this.layer.queryFeatures(f);for(const d of q.features){const t=l.get(d.getObjectId());m[t]=
d}}catch{}return m.filter(Boolean)});return function(c){return a.apply(this,arguments)}}();k.createPopupQuery=function(){var a=u._asyncToGenerator(function*(c){const b=this.layer.createQuery(),m=new Set;var l=!1,f=p.isSome(c)&&c.clientGraphics?c.clientGraphics.map(h=>h.layer):[this.layer];for(const h of f)if("popupEnabled"in h&&(f=x.getFetchPopupTemplate(h,c),!p.isNone(f))){l=(l=yield this._loadArcadeModules(f))&&l.arcadeUtils.hasGeometryOperations(f);l=!("point"!==this.layer.geometryType&&!l);f=
yield x.getRequiredFields(this.layer,f);for(const q of f)m.add(q)}b.returnGeometry=l;b.returnZ=l;b.returnM=l;b.outFields=Array.from(m);b.outSpatialReference=this.view.spatialReference;"feature"===this.layer.type&&(c=E.getFloorFilterClause(this),p.isSome(c)&&(b.where=b.where?`(${b.where}) AND (${c})`:c));return b});return function(c){return a.apply(this,arguments)}}();k.canResume=function(){return!B.prototype.canResume.call(this)||p.isSome(this.timeExtent)&&this.timeExtent.isEmpty?!1:!0};u._createClass(z,
[{key:"availableFields",get:function(){const {layer:a,layer:{fieldsIndex:c},requiredFields:b}=this;return"outFields"in a&&a.outFields?e.fixFields(c,[...e.unpackFieldNames(c,a.outFields),...b]):e.fixFields(c,b)}},{key:"effect",get:function(){C.deprecatedProperty(y,"effect",{replacement:"featureEffect",version:"4.22"});return this.featureEffect},set:function(a){C.deprecatedProperty(y,"effect",{replacement:"featureEffect",version:"4.22"});this.featureEffect=a}},{key:"featureEffect",get:function(){return this.layer&&
"featureEffect"in this.layer?this.layer.featureEffect:null},set:function(a){void 0===a?this._clearOverride("featureEffect"):this._override("featureEffect",a)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(a){y.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]);return z}(g);n.__decorate([r.property()],g.prototype,"_updatingRequiredFieldsPromise",void 0);n.__decorate([r.property({readOnly:!0})],
g.prototype,"availableFields",null);n.__decorate([r.property()],g.prototype,"effect",null);n.__decorate([r.property({type:I})],g.prototype,"featureEffect",null);n.__decorate([r.property({type:J})],g.prototype,"filter",void 0);n.__decorate([r.property(H.combinedViewLayerTimeExtentProperty)],g.prototype,"timeExtent",void 0);n.__decorate([r.property()],g.prototype,"layer",void 0);n.__decorate([r.property({type:Number})],g.prototype,"maximumNumberOfFeatures",null);n.__decorate([r.property({readOnly:!0,
type:Boolean})],g.prototype,"maximumNumberOfFeaturesExceeded",null);n.__decorate([r.property({readOnly:!0})],g.prototype,"requiredFields",void 0);n.__decorate([r.property()],g.prototype,"suspended",void 0);n.__decorate([r.property()],g.prototype,"view",void 0);return g=n.__decorate([G.subclass("esri.views.layers.FeatureLayerView")],g)}});