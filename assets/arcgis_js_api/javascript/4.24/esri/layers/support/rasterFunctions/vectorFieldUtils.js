// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/jsonMap","../../../core/maybe","../PixelBlock","./pixelUtils"],function(B,da,N,I,O){function J(a,c){return C.get(a)/C.get(c)||1}function P(a,c="geographic"){const [b,d]=a;a=Math.sqrt(b*b+d*d);let e=Math.atan2(d,b)*Q;e=(360+e)%360;"geographic"===c&&(e=(450-e)%360);return[a,e]}function Z(a,c="geographic"){let b=a[1];"geographic"===c&&(b=(450-b)%360);b%=360;a=a[0];return[a*Math.cos(b/Q),a*Math.sin(b/Q)]}function R(a,c,b="geographic",d=1){if(!O.isValidPixelBlock(a))return a;
const {pixels:e,width:h,height:q}=a;var n=h*q;const l=e[0],v=e[1],k=a.pixelType.startsWith("f")?a.pixelType:"f32",m=I.createEmptyBand(k,n);n=I.createEmptyBand(k,n);let g=0;for(let f=0;f<q;f++)for(let r=0;r<h;r++)"vector-uv"===c?([m[g],n[g]]=P([l[g],v[g]],b),m[g]*=d):([m[g],n[g]]=Z([l[g],v[g]],b),m[g]*=d,n[g]*=d),g++;a=new I({pixelType:k,width:a.width,height:a.height,mask:a.mask,validPixelCount:a.validPixelCount,maskIsAlpha:a.maskIsAlpha,pixels:[m,n]});a.updateStatistics();return a}function ea(a=0,
c=Math.PI,b=!0){b&&(c=(2*Math.PI-c)%(2*Math.PI));var d=b?-1:1;b=5*d;const e=20*d,h=25*d;d*=2;let [q,n]=[5,0-e],[l,v]=[q+2,n],[k,m]=[l-0,v+d],[g,f]=[-5,0-h],[r,p]=[g+0,f-d];a=Math.ceil(a/5);let x=Math.floor(a/10);a-=8*x;const t=[],u=[];for(let G=0;G<a/2;G++,x--){0>=x&&1===a%2&&G===(a-1)/2&&(g=0,r=g+0,f=(f+n)/2,p=f-d);const [aa,ba]=y(g,f,c,45);if(0<x){const [S,T]=y(l,f,c,45),[U,V]=y(q,n,c,45);t.push(S);t.push(T);t.push(aa);t.push(ba);t.push(U);t.push(V)}else{const [S,T]=y(l,v,c,45),[U,V]=y(k,m,c,45),
[fa,ha]=y(r,p,c,45);u.push(aa);u.push(ba);u.push(fa);u.push(ha);u.push(U);u.push(V);u.push(S);u.push(T)}f+=b;n+=b;v+=b;m+=b;p+=b}const [w,A]=y(5,0+e,c,45),[z,K]=y(7,0+e,c,45),[L,D]=y(5,0-h,c,45),[E,W]=y(7,0-h,c,45);return{pennants:t,barbs:u,shaft:[w,A,z,K,L,D,E,W]}}function y(a,c,b,d=1){return[Math.sqrt(a*a+c*c)/d,(2*Math.PI+(2*Math.PI+Math.atan2(c,a))%(2*Math.PI)-b)%(2*Math.PI)]}function F(a,c,b,d){b=J(d||"knots",b);for(d=1;d<c.length;d++)if(d===c.length-1){if(a<c[d]*b)break}else if(a<=c[d]*b)break;
return Math.min(d-1,c.length-2)}function ia(a,c,b,d,e){let h=0;switch(c){case "beaufort_kn":h=F(a,M,"knots",b);break;case "beaufort_km":h=F(a,M,"kilometer-per-hour",b);break;case "beaufort_ft":h=F(a,M,"feet-per-second",b);break;case "beaufort_m":h=F(a,M,"meter-per-second",b);break;case "classified_arrow":h=F(a,e,d,b);break;case "ocean_current_m":h=F(a,ja,"meter-per-second",b);break;case "ocean_current_kn":h=F(a,ka,"knots",b)}return h}function la(a,c){const {style:b,inputUnit:d,outputUnit:e,breakValues:h}=
c;c=H.fromJSON(d);const q=H.fromJSON(e);let n=0,l=0;const {width:v,height:k,mask:m}=a,g=a.pixels[0];a=a.pixels[1];var f=m?m.filter(t=>0<t).length:v*k;const r=new Float32Array(42*f);f=new Uint32Array(15*f);for(let t=0;t<k;t++)for(let u=0;u<v;u++){var p=t*v+u;if(!m||m[t*v+u]){var x;const w=null!=(x=(a[p]+360)%360/180*Math.PI)?x:2*Math.PI*Math.random(),A=ia(g[p],b,c,q,h);for(let z=0;z<X.length;z+=2)r[n++]=(u+.5)/v,r[n++]=(t+.5)/k,r[n++]=X[z],r[n++]=X[z+1]+w,r[n++]=A,r[n++]=g[p];p=7*(n/42-1);f[l++]=p;
f[l++]=p+1;f[l++]=p+2;f[l++]=p+0;f[l++]=p+4;f[l++]=p+3;f[l++]=p+0;f[l++]=p+2;f[l++]=p+3;f[l++]=p+2;f[l++]=p+5;f[l++]=p+3;f[l++]=p+5;f[l++]=p+6;f[l++]=p+3}}return{vertexData:r,indexData:f}}function ca(a,c){let b=0,d=0;const {width:e,height:h,mask:q}=a;a=a.pixels[0];const n=[],l=[];var v=H.fromJSON(c.inputUnit);v=J(v,"knots");c="wind_speed"===c.style?5:Number.MAX_VALUE;for(let m=0;m<h;m++)for(let g=0;g<e;g++){var k=a[m*e+g]*v;if((!q||q[m*e+g])&&k<c){for(let f=0;4>f;f++)n[b++]=(g+.5)/e,n[b++]=(m+.5)/
h,n[b++]=2>f?-.5:.5,n[b++]=0===f%2?-.5:.5,n[b++]=0,n[b++]=k;k=4*(b/24-1);l[d++]=k;l[d++]=k+1;l[d++]=k+2;l[d++]=k+1;l[d++]=k+2;l[d++]=k+3}}return{vertexData:new Float32Array(n),indexData:new Uint32Array(l)}}const C=new Map;C.set("meter-per-second",1);C.set("kilometer-per-hour",.277778);C.set("knots",.514444);C.set("feet-per-second",.3048);C.set("mile-per-hour",.44704);const Q=180/Math.PI,H=new da.JSONMap({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",
esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"}),X=function(a=0,c=0,b=Math.PI,d=!0){d&&(b=(2*Math.PI-b)%(2*Math.PI));d=d?-1:1;const e=-7*d,h=-2*d,q=-16*d,[n,l]=y(0,c+13*d,b,21.75),[v,k]=y(a-5.5,c+e,b,21.75),[m,g]=y(a+5.5,c+e,b,21.75),[f,r]=y(a-1.5,c+h,b,21.75),[p,x]=y(a+1.5,c+h,b,21.75),[t,u]=y(a-1.5,c+q,b,21.75),[w,A]=y(a+1.5,c+q,b,21.75);return[n,l,v,k,f,r,p,x,m,g,t,u,w,A]}(0,0,0),M=[0,1,3,6,10,16,21,27,33,40,47,55,63],ja=[0,.5,1,1.5,2],ka=[0,.25,.5,1,1.5,2,2.5,3,3.5,4],Y=
[];B.convertToLocalDirections=function(a,c,b,d="geographic"){if(!O.isValidPixelBlock(a)||N.isNone(b))return a;a="vector-magdir"===c?a.clone():N.unwrap(R(a,c));const e=a.pixels[1];for(let h=0;h<e.length;h++)e[h]="geographic"===d?(e[h]+b[h]+270)%360:(e[h]+360-b[h])%360;return"vector-magdir"===c?a:R(a,"vector-magdir")};B.convertVectorFieldData=R;B.convertVectorFieldUnit=function(a,c,b=1){if(1===b||!O.isValidPixelBlock(a))return a;a=a.clone();const {pixels:d,width:e,height:h}=a,q=d[0],n=d[1];let l=0;
for(let v=0;v<h;v++)for(let k=0;k<e;k++)"vector-uv"===c?(q[l]*=b,n[l]*=b):q[l]*=b,l++;a.updateStatistics();return a};B.createVFMesh=function(a,c){if("simple_scalar"===c.style)var b=ca(a,c);else if("wind_speed"===c.style){{if(0===Y.length)for(var d=0;30>d;d++)Y.push(ea(5*d,0));c=H.fromJSON(c.inputUnit);c=J(c,"knots");const {width:n,height:l,mask:v}=a;d=a.pixels[0];a=a.pixels[1];const k=[],m=[];let g=0,f=0;for(let r=0;r<l;r++)for(let p=0;p<n;p++){var e=r*n+p,h=d[e]*c;if((!v||v[r*n+p])&&5<=h){const x=
null!=(b=(a[e]+360)%360/180*Math.PI)?b:2*Math.PI*Math.random(),{pennants:t,barbs:u,shaft:w}=Y[Math.min(Math.floor(h/5),29)];if(0===t.length+u.length)continue;e=k.length/6;const A=(p+.5)/n,z=(r+.5)/l;for(var q=0;q<t.length;q+=2)k[g++]=A,k[g++]=z,k[g++]=t[q],k[g++]=t[q+1]+x,k[g++]=0,k[g++]=h;for(q=0;q<u.length;q+=2)k[g++]=A,k[g++]=z,k[g++]=u[q],k[g++]=u[q+1]+x,k[g++]=0,k[g++]=h;for(q=0;q<w.length;q+=2)k[g++]=A,k[g++]=z,k[g++]=w[q],k[g++]=w[q+1]+x,k[g++]=0,k[g++]=h;for(h=0;h<t.length/6;h++)m[f++]=e,
m[f++]=e+1,m[f++]=e+2,e+=3;for(h=0;h<u.length/8;h++)m[f++]=e,m[f++]=e+1,m[f++]=e+2,m[f++]=e+1,m[f++]=e+2,m[f++]=e+3,e+=4;m[f++]=e+0;m[f++]=e+1;m[f++]=e+2;m[f++]=e+1;m[f++]=e+3;m[f++]=e+2;e+=4}}b={vertexData:new Float32Array(k),indexData:new Uint32Array(m)}}}else b=la(a,c);return b};B.createVFMeshScalar=ca;B.getUnitConversionFactor=J;B.sampleVectorField=function(a,c,b,d=[0,0],e=.5){const {width:h,height:q,mask:n}=a,[l,v]=a.pixels,[k,m]=d;a=Math.round((h-k)/b);d=Math.round((q-m)/b);var g=a*d;const f=
new Float32Array(g),r=new Float32Array(g);g=new Uint8Array(g);c="vector-uv"===c;for(let x=0;x<d;x++)for(let t=0;t<a;t++){let u=0;const w=x*a+t,A=Math.max(0,x*b+m),z=Math.max(0,t*b+k),K=Math.min(q,A+b),L=Math.min(h,z+b);for(let D=A;D<K;D++)for(let E=z;E<L;E++){var p=D*h+E;if(!n||n[p]){u++;p=c?[l[p],v[p]]:[l[p],(360+v[p])%360];const [W,G]=c?p:Z(p);f[w]+=W;r[w]+=G}}if(u>=(K-A)*(L-z)*(1-e)){g[w]=1;const [D,E]=P([f[w]/u,r[w]/u]);f[w]=D;r[w]=E}else g[w]=0,f[w]=0,r[w]=0}b=new I({width:a,height:d,pixels:[f,
r],mask:g});b.updateStatistics();return b};B.snapImageToSymbolTile=function(a,c,b,d,e){if(N.isNone(e)||!e.spatialReference.equals(a.spatialReference))return{extent:a,width:Math.round(c/d),height:Math.round(b/d),resolution:a.width/c};const h=e.xmin;e=e.ymax;c=(a.xmax-a.xmin)/c*d;b=(a.ymax-a.ymin)/b*d;a.xmin=h+Math.floor((a.xmin-h)/c)*c;a.xmax=h+Math.ceil((a.xmax-h)/c)*c;a.ymin=e+Math.floor((a.ymin-e)/b)*b;a.ymax=e+Math.ceil((a.ymax-e)/b)*b;return{extent:a,width:Math.round(a.width/c),height:Math.round(a.height/
b),resolution:(c+b)/2}};B.unitKebabDict=H;B.uvComponentToVector=P;Object.defineProperties(B,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});