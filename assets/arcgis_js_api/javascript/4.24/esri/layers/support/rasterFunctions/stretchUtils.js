// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe"],function(x,z){function A(d,f=256){f=Math.min(f,256);const {size:b,counts:g}=d;d=new Uint8Array(b);var h=g.reduce((a,c)=>a+c/f,0);let m=0;var k=0;let n=0,e=h;for(let a=0;a<b;a++)if(n+=g[a],!(a<b-1&&n+g[a+1]<e)){for(;m<f-1&&e<n;)m++,e+=h;for(;k<=a;k++)d[k]=m;k=a+1}for(h=k;h<b;h++)d[h]=f-1;return d}function B(d,f){d=Math.min(Math.max(d,-100),100);f=Math.min(Math.max(f,-100),100);let b,g;const h=new Uint8Array(256);for(b=0;256>b;b++)0<d&&100>d?g=(200*b-25500+510*
f)/(2*(100-d))+128:0>=d&&-100<d?g=(200*b-25500+510*f)*(100+d)/2E4+128:100===d?(g=200*b-25500+256*(100-d)+510*f,g=0<g?255:0):-100===d&&(g=128),h[b]=255<g?255:0>g?0:g;return h}function E(d){if(0>=d||255<=d)return 1;var f=0;150!==d&&(f=150>=d?45*Math.cos(.01047*d):17*Math.sin(.021*d));f=Math.log((d+f)/255);if(0===f)return 1;d=Math.log(d/255)/f;return isNaN(d)?1:Math.min(9.9,Math.max(.01,d))}function C(d){var f;if(z.isNone(d)||null==(f=d.pixels)||!f.length)return null;d.statistics||d.updateStatistics();
const {pixels:b,mask:g,pixelType:h,statistics:m}=d;d=d.width*d.height;f=b.length;let k,n;let e;var a;const c=[],p=[];for(e=0;e<f;e++){var t=new Uint32Array(256);var q=b[e];if("u8"===h)if(k=-.5,n=255.5,g)for(a=0;a<d;a++)g[a]&&t[q[a]]++;else for(a=0;a<d;a++)t[q[a]]++;else{k=m[e].minValue;n=m[e].maxValue;var u=(n-k)/256;var r=new Uint32Array(257);if(g)for(a=0;a<d;a++)g[a]&&r[Math.floor((q[a]-k)/u)]++;else for(a=0;a<d;a++)r[Math.floor((q[a]-k)/u)]++;for(a=0;255>a;a++)t[a]=r[a];t[255]=r[255]+r[256]}c.push({min:k,
max:n,size:256,counts:t});for(a=q=r=u=0;256>a;a++)u+=t[a],r+=a*t[a];r/=u;for(a=0;256>a;a++)q+=t[a]*(a-r)**2;t=Math.sqrt(q/(u-1));u=(n-k)/256;a=(r+.5)*u+k;t*=u;p.push({min:k,max:n,avg:a,stddev:t})}return{statistics:p,histograms:c}}function F(d,f){if(null==f||0===f.length)return d;const b=Math.max.apply(null,f),{minCutOff:g,maxCutOff:h,outMin:m,outMax:k,histogramLut:n}=d;return g.length===f.length||g.length<=b?d:{minCutOff:f.map(e=>g[e]),maxCutOff:f.map(e=>h[e]),histogramLut:n?f.map(e=>n[e]):null,outMin:m,
outMax:k}}const D={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-3.4*1E39,3.4*1E39],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},G=[.299,.587,.114];x.computeGammaValues=function(d,f,b){const g=[];for(let m=0;m<f.length;m++){let k=0,n=0;var h=0;"min"in f[m]?{min:k,max:n,avg:h}=f[m]:[k,n,h]=f[m];"u8"!==d&&(h=255*(h-k)/(n-k));b&&(h*=G[m]);g.push(E(h))}return g};x.createContrastBrightnessLUT=B;x.createHistogramEqualizationLUT=
A;x.createStretchLUT=function(d){const {minCutOff:f,maxCutOff:b,gamma:g,pixelType:h}=d,m=d.outMin||0,k=d.outMax||255;if(!["u8","u16","s8","s16"].includes(h))return null;const n=f.length;let e;let a=0;"s8"===h?a=-127:"s16"===h&&(a=-32767);let c=256;["u16","s16"].includes(h)&&(c=65536);const p=[],t=k-m;for(e=0;e<n;e++)p[e]=b[e]-f[e],t/(b[e]-f[e]);var q=g&&g.length>=n;const u=[];if(q)for(e=0;e<n;e++)u[e]=1<g[e]?2<g[e]?6.5+(g[e]-2)**2.5:6.5+100*(2-g[e])**4:1;let r;const l=[];let v,w,y;if(q)for(e=0;e<
n;e++){y=[];for(q=0;q<c;q++)v=q+a,r=(v-f[e])/p[e],w=1,1<g[e]&&(w-=(1/t)**(r*u[e])),y[q]=v<b[e]&&v>f[e]?Math.floor(w*t*r**(1/g[e]))+m:v>=b[e]?k:m;l[e]=y}else for(e=0;e<n;e++){y=[];for(q=0;q<c;q++)v=q+a,y[q]=v<=f[e]?m:v>=b[e]?k:Math.floor((v-f[e])/p[e]*t)+m;l[e]=y}if(null!=d.contrastOffset)for(d=B(d.contrastOffset,d.brightnessOffset),e=0;e<n;e++)for(y=l[e],q=0;q<c;q++)y[q]=d[y[q]];return{lut:l,offset:a}};x.estimateStatisticsFromHistograms=function(d){const f=[];for(let m=0;m<d.length;m++){const {min:k,
max:n,size:e,counts:a}=d[m];let c=0;var b=0;for(var g=0;g<e;g++)c+=a[g],b+=g*a[g];b/=c;g=0;for(var h=0;h<e;h++)g+=a[h]*(h-b)**2;h=(n-k)/e;f.push({min:k,max:n,avg:(b+.5)*h+k,stddev:Math.sqrt(g/(c-1))*h})}return f};x.estimateStatisticsHistograms=C;x.getStretchCutoff=function(d,f){var b,g,h;const {pixelBlock:m,bandIds:k,returnHistogramLut:n,rasterInfo:e}=f;f=d.stretchType;if(d.dra)if("minMax"===f&&z.isSome(m)&&m.statistics)var a=m.statistics.map(w=>[w.minValue,w.maxValue,0,0]);else{var c=C(m);a=z.isSome(c)?
c.statistics:null;c=z.isSome(c)?c.histograms:null}else{var p;a=0<(null==(p=d.statistics)?void 0:p.length)?d.statistics:z.unwrap(e.statistics);c=d.histograms||z.unwrap(e.histograms)}"percentClip"!==f&&"histogramEqualization"!==f||null!=(b=c)&&b.length||(f="minMax");p=(null==(g=a)?void 0:g.length)||(null==(h=c)?void 0:h.length)||e.bandCount;g=[];h=[];let t;let q,u,r;a&&!Array.isArray(a[0])&&(a=a.map(w=>[w.min,w.max,w.avg,w.stddev]));switch(f){case "none":a=D[e.pixelType]||D.f32;for(b=0;b<p;b++)g[b]=
a[0],h[b]=a[1];break;case "minMax":for(b=0;b<p;b++)g[b]=a[b][0],h[b]=a[b][1];break;case "standardDeviation":for(b=0;b<p;b++)g[b]=a[b][2]-d.numberOfStandardDeviations*a[b][3],h[b]=a[b][2]+d.numberOfStandardDeviations*a[b][3],g[b]<a[b][0]&&(g[b]=a[b][0]),h[b]>a[b][1]&&(h[b]=a[b][1]);break;case "histogramEqualization":for(b=0;b<p;b++)g[b]=c[b].min,h[b]=c[b].max;break;case "percentClip":for(b=0;b<c.length;b++){a=c[b];q=new Uint32Array(a.size);var l=[...a.counts];20<=l.length&&(l[0]=l[1]=l[2]=l[l.length-
1]=l[l.length-2]=0);t=0;p=(a.max-a.min)/a.size;u=-.5===a.min&&1===p?.5:0;for(r=0;r<a.size;r++)t+=l[r],q[r]=t;l=(d.minPercent||0)*t/100;for(r=0;r<a.size;r++)if(q[r]>l){g[b]=a.min+p*(r+u);break}l=(1-(d.maxPercent||0)/100)*t;for(r=a.size-2;0<=r;r--)if(q[r]<l){h[b]=a.min+p*(r+2-u);break}}break;default:for(b=0;b<p;b++)g[b]=a[b][0],h[b]=a[b][1]}let v;"histogramEqualization"===f?(f=c[0].size||256,d=0,n&&(v=c.map(w=>A(w)))):(f=d.max||255,d=d.min||0);return F({minCutOff:g,maxCutOff:h,outMax:f,outMin:d,histogramLut:v},
k)};x.stretch=function(d,f){var b;if(z.isNone(d)||null==(b=d.pixels)||!b.length)return d;d=d.clone();const {pixels:g,mask:h}=d,{minCutOff:m,maxCutOff:k,gamma:n}=f;b=f.outMin||0;f=f.outMax||255;const e=d.width*d.height,a=g.length;let c;let p,t,q;const u=f-b,r=[];for(c=0;c<a;c++)r[c]=k[c]-m[c],u/(k[c]-m[c]);var l=n&&n.length>=a;const v=[];if(l)for(c=0;c<a;c++)v[c]=1<n[c]?2<n[c]?6.5+(n[c]-2)**2.5:6.5+100*(2-n[c])**4:1;if(l)if(null!=h)for(l=0;l<e;l++){if(h[l])for(c=0;c<a;c++)p=g[c][l],q=(p-m[c])/r[c],
t=1,1<n[c]&&(t-=(1/u)**(q*v[c])),g[c][l]=p<k[c]&&p>m[c]?Math.floor(t*u*q**(1/n[c]))+b:p>=k[c]?f:b}else for(l=0;l<e;l++)for(c=0;c<a;c++)p=g[c][l],q=(p-m[c])/r[c],t=1,1<n[c]&&(t-=(1/u)**(q*v[c])),g[c][l]=p<k[c]&&p>m[c]?Math.floor(t*u*q**(1/n[c]))+b:p>=k[c]?f:b;else if(null!=h)for(l=0;l<e;l++){if(h[l])for(c=0;c<a;c++)p=g[c][l],g[c][l]=p<k[c]&&p>m[c]?Math.floor((p-m[c])/r[c]*u)+b:p>=k[c]?f:b}else for(l=0;l<e;l++)for(c=0;c<a;c++)p=g[c][l],g[c][l]=p<k[c]&&p>m[c]?Math.floor((p-m[c])/r[c]*u)+b:p>=k[c]?f:
b;d.pixelType="u8";d.updateStatistics();return d};Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});