// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../RasterInfo ../RasterStorageInfo ../TileInfo ./BaseRaster ./DBFParser ../rasterTransforms/utils ../../../rest/support/FeatureSet ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(w,A,v,B,C,J,Z,aa,ba,N,O,P,Q,R,S,K,T,U,V,L){const p=new Map;p.set("int16","esriFieldTypeSmallInteger");p.set("int32","esriFieldTypeInteger");p.set("int64","esriFieldTypeInteger");p.set("float32","esriFieldTypeSingle");p.set("float64","esriFieldTypeDouble");p.set("text","esriFieldTypeString");v=function(M){function D(){var a=M.apply(this,arguments)||this;a.storageInfo=null;a.datasetFormat="CRF";return a}w._inheritsLoose(D,M);var l=D.prototype;l.open=function(){var a=w._asyncToGenerator(function*(b){yield this.init();
({data:b}=yield this.request(this.url+"/conf.json",{signal:null==b?void 0:b.signal}));if(!this._validateHeader(b))throw new B("cloudraster:open","Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const {storageInfo:c,rasterInfo:d}=this._parseHeader(b);"thematic"===d.dataType&&(b=yield this._fetchAuxiliaryInformation(),d.attributeTable=b);this._set("storageInfo",c);this._set("rasterInfo",d);this.ioConfig.retryCount=this.ioConfig.retryCount||0});return function(b){return a.apply(this,
arguments)}}();l.fetchRawTile=function(){var a=w._asyncToGenerator(function*(b,c,d,f={}){var {transposeInfo:h}=this.rasterInfo.storageInfo,{transposedVariableName:e}=f;b=(h=!(!h||!e))?0:this.rasterInfo.storageInfo.maximumPyramidLevel-b;if(0>b)return null;e=this._buildCacheFilePath(b,c,d,f.multidimensionalDefinition,e);c=this._getIndexRecordFromBundle(c,d,h);d=yield this.request(e,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:f.signal});if(!d)return null;d=new Uint8Array(d.data);
c=this._getTileEndAndContentType(d,c);if(0===c.recordSize)return null;f=yield this.request(e,{range:{from:c.position,to:c.position+c.recordSize},responseType:"array-buffer",signal:f.signal});if(!f)return null;const [n,q]=this._getTileSize(h);return this.decodePixelBlock(f.data,{width:n,height:q,planes:null,pixelType:null,returnPixelInterleavedDims:h})});return function(b,c,d){return a.apply(this,arguments)}}();l._validateHeader=function(a){const b="origin extent geodataXform LODInfos blockWidth blockHeight bandCount pixelType pixelSizeX pixelSizeY format packetSize".split(" ");
return a&&"RasterInfo"===a.type&&!b.some(c=>!a[c])};l._parseHeader=function(a){var b,c,d="u1 u2 u4 u8 s8 u16 s16 u32 s32 f32 f64".split(" ")[a.pixelType];const {bandCount:f,histograms:h,colormap:e,blockWidth:n,blockHeight:q,firstPyramidLevel:W,maximumPyramidLevel:E}=a,X=a.statistics&&a.statistics.map(u=>({min:u.min,max:u.max,avg:u.mean,stddev:u.standardDeviation,median:u.median,mode:u.mode}));var k=a.extent.spatialReference,r=null==(b=a.geodataXform)?void 0:b.spatialReference;b=new U(null!=k&&k.wkid||
null!=k&&k.wkt?k:r);k=new V({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,spatialReference:b});r=new L({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:b});const x=Math.round((k.xmax-k.xmin)/r.x),y=Math.round((k.ymax-k.ymin)/r.y),z=this._parseTransform(a.geodataXform),Y=z?k:null;z&&(k=z.forwardTransform(k),r.x=(k.xmax-k.xmin)/x,r.y=(k.ymax-k.ymin)/y);const F=null!=(c=a.properties)?c:{};var G=a.format.toLowerCase().replace("cache/","");c=new L(a.origin.x,a.origin.y,b);
let H;var g;if(e&&e.colors)for(H=[],g=0;g<e.colors.length;g++){var m=e.colors[g];var t=e.values?e.values[g]:g;H.push([t,m&255,m<<16>>>24,m<<8>>>24,m>>>24])}m=a.LODInfos;t=[];for(g=0;g<m.levels.length;g++)t.push({level:m.levels[g],resolution:m.resolutions[g],scale:96/.0254*m.resolutions[g]});m=new Q({dpi:96,lods:t,format:G,origin:c,size:[n,q],spatialReference:b});G={recordSize:8,packetSize:a.packetSize,headerSize:a.packetSize*a.packetSize*8+64};t=[{maxCol:Math.ceil(x/n)-1,maxRow:Math.ceil(y/q)-1,minCol:0,
minRow:0}];let I=2;if(0<E)for(g=0;g<E;g++)t.push({maxCol:Math.ceil(x/I/n)-1,maxRow:Math.ceil(y/I/q)-1,minCol:0,minRow:0}),I*=2;a=a.mdInfo;g=null;a&&F._yxs&&(g=F._yxs,g={packetSize:g.PacketSize,tileSize:[g.TileXSize,g.TileYSize]});d=new O({width:x,height:y,pixelType:d,bandCount:f,extent:k,nativeExtent:Y,transform:z,spatialReference:b,pixelSize:r,keyProperties:F,statistics:X,histograms:h,multidimensionalInfo:a,colormap:H,storageInfo:new P({blockWidth:n,blockHeight:q,pyramidBlockWidth:n,pyramidBlockHeight:q,
origin:c,tileInfo:m,transposeInfo:g,firstPyramidLevel:W,maximumPyramidLevel:E,blockBoundary:t})});return{storageInfo:G,rasterInfo:d}};l._parseTransform=function(a){var b,c;if(!K.isTransformSupported(a))throw new B("cloudraster:open","the data contains unsupported geodata transform types");a=K.readTransform(a);if("identity"===a.type)return null;if("polynomial"!==a.type||null==(b=a.forwardCoefficients)||!b.length||null==(c=a.inverseCoefficients)||!c.length)throw new B("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");
return a};l._fetchAuxiliaryInformation=function(){var a=w._asyncToGenerator(function*(b){var c=this.request(this.url+"/conf.vat.json",{signal:b}).then(f=>f.data).catch(()=>null);b=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:b}).then(f=>f.data).catch(()=>null);c=yield Promise.all([c,b]);let d;if(c[0]){b=c[0].fields;const f=c[0].values;if(b&&f){b=b.map(e=>({type:"OID"===e.name?"esriFieldTypeOID":p.get(e.type),name:e.name,alias:e.alias||e.name}));const h=f.map(e=>({attributes:e}));
b&&f&&(d={fields:b,features:h})}}!d&&c[1]&&(d=S.parse(c[1]).recordSet);return T.fromJSON(d)});return function(b){return a.apply(this,arguments)}}();l._buildCacheFilePath=function(a,b,c,d,f){var h=this._getPackageSize(!!f);c=Math.floor(c/h)*h;b="R"+this._toHexString4(Math.floor(b/h)*h)+"C"+this._toHexString4(c);h="L";h=10<=a?h+a.toString():h+("0"+a.toString());({multidimensionalInfo:a}=this.rasterInfo);const e=null==d?void 0:d[0];if(C.isNone(a)||!e)return`${this.url}/_alllayers/${h}/${b}.bundle`;d=
"_yxs";if(!f){d=a.variables.find(n=>n.name===e.variableName).dimensions[0].values.indexOf(e.values[0]).toString(16);a=4-d.length;for(c=0;c<a;c++)d="0"+d;d="S"+d}f=this._getVariableFolderName(f||e.variableName);return`${this.url}/_alllayers/${f}/${d}/${h}/${b}.bundle`};l._getPackageSize=function(a=!1){const {transposeInfo:b}=this.rasterInfo.storageInfo;return a&&C.isSome(b)?b.packetSize:this.storageInfo.packetSize};l._getTileSize=function(a=!1){const {storageInfo:b}=this.rasterInfo,{transposeInfo:c}=
b;return a&&C.isSome(c)?c.tileSize:b.tileInfo.size};l._getVariableFolderName=function(a){a=a.trim();return""===a?"_v":a.replace(/[\{|\}\-]/g,"_").replace("\\*","_v")};l._getIndexRecordFromBundle=function(a,b,c=!1){c=this._getPackageSize(c);a=a%c*c+b%c;if(0>a)throw"Invalid level / row / col";return a*this.storageInfo.recordSize+64};l._getTileEndAndContentType=function(a,b){a=a.subarray(b,b+8);b=0;let c;for(c=0;5>c;c++)b|=(a[c]&255)<<8*c;const d=b&0xffffffffff;b=0;for(c=5;8>c;c++)b|=(a[c]&255)<<8*(c-
5);return{position:d,recordSize:b&0xffffffffff}};l._toHexString4=function(a){a=a.toString(16);if(4!==a.length){let b=4-a.length;for(;0<b--;)a="0"+a}return a};return D}(R);A.__decorate([J.property({readOnly:!0})],v.prototype,"storageInfo",void 0);A.__decorate([J.property({type:String,json:{write:!0}})],v.prototype,"datasetFormat",void 0);return v=A.__decorate([N.subclass("esri.layers.support.rasterDatasets.CloudRaster")],v)});