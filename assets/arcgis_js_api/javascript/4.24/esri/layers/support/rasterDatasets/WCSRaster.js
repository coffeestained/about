// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../ogc/crsUtils ../DimensionalDefinition ./BaseRaster ./multipartParser ./wcsCapabilitiesParser ./wcsCoverageParser ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../../../geometry/Extent".split(" "),
function(D,I,E,C,P,B,M,J,ba,ca,da,Q,R,S,T,U,V,N,W,X,Y){const Z=["nearest neighbor","bilinear","bicubic"],aa=["nearest","linear","cubic"],K=P.getLogger("esri.layers.support.rasterDatasets.WCSRaster");E=function(O){function L(){var a=O.apply(this,arguments)||this;a.datasetFormat="WCSServer";return a}D._inheritsLoose(L,O);var z=L.prototype;z.open=function(){var a=D._asyncToGenerator(function*(d){yield this.init();d=null==d?void 0:d.signal;var b=yield this._getCapabilities(d);this.capabilities=b;if(!this.version){var e;
let h=null==(e=b.capabilitiesVersion)?void 0:e.slice(0,3);this.version="2.0"===h||"1.1"===h||"1.0"===h?b.capabilitiesVersion:h=b.supportedVersions.find(k=>"2.0.1"===k)||b.supportedVersions.find(k=>"2.0"===k.slice(0,3))||b.supportedVersions.find(k=>"1.1"===k.slice(0,3))||b.supportedVersions.find(k=>"1.0"===k.slice(0,3))||"1.0.0"}e=b.coverages.filter(h=>{var k;return null==h.coverageSubType||""===h.coverageSubType||(null==(k=h.coverageSubType)?void 0:k.toLowerCase().startsWith("rectifiedgrid"))});null==
this.coverageId&&(this.coverageId=e[0].id);e=e.find(h=>h.id===this.coverageId);if(null==e)throw new C("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);this.coverageInfo=(yield this._describeCoverage(d))[0];"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=e.lonLatEnvelope,this.coverageInfo.supportedInterpolations=N.standardizeInterpolations(b.supportedInterpolations));this.datasetName=this.coverageInfo.title;({rasterInfo:b}=this.coverageInfo);this.createRemoteDatasetStorageInfo(b,
512,512);this._set("rasterInfo",b);if(null==b.spatialReference)throw new C("wcsraster-open",`coverage without spatial referernce is not supported: ${this.coverageId}`);const {pixelType:f,bandCount:c}=yield this._getPixelTypeAndBandCount(d);b.pixelType=f;1===b.bandCount&&1<c&&(b.bandCount=c);this.updateTileInfo()});return function(d){return a.apply(this,arguments)}}();z.fetchRawTile=function(){var a=D._asyncToGenerator(function*(d,b,e,f={}){if(this.isBlockOutside(d,b,e))return null;const {nativePixelSize:c,
spatialReference:h}=this.rasterInfo;var k=2**d,g=c.x*k;const v=c.y*k,{blockWidth:m,blockHeight:p}=this.getBlockWidthHeight(d);({origin:d}=this.rasterInfo.storageInfo.tileInfo);const n=this.getTileExtent({x:g,y:v},b,e,d,h,[m,p]),r=this.rasterInfo.extent,w=n.xmax>r.xmax,t=n.ymin<r.ymin;b=w||t;let l=n;e=m;d=p;b&&(l=n.clone().intersection(r),B.isSome(l)&&(w&&(e=Math.floor((l.xmax-l.xmin)/g),l.xmax=l.xmin+g*e),t&&(d=Math.floor((l.ymax-l.ymin)/v),l.ymin=l.ymax-v*d)));if(B.isNone(l)||1>=e||1>=d)return null;
k=yield this._getCoverage(l,e,d,k,f);if(!k)return null;({coverageDescription:g}=this.coverageInfo);let {noDataValue:A,multidimensionalInfo:x}=this.rasterInfo;({multidimensionalDefinition:f}=f);if(B.isSome(x)&&B.isSome(f)&&f.length){const u=f[0].variableName;"2.0"===g.version?(f=g.rangeType[0].find(q=>q.name===u),A=null==f?void 0:f.nilValue):"1.1"===g.version&&(f=g.range.find(q=>q.identifier===u),A=null==f?void 0:f.nullValues)}if((f=yield this.decodePixelBlock(k,{width:e,height:d,planes:null,pixelType:null,
noDataValue:Array.isArray(A)?A[0]:A}))&&(f.width!==e||f.height!==d))throw new C("wcsraster-fetch",`the reponse has unexpected dimension width: ${f.width}, height: {pixelBlock.height}`);return b?X.clip(f,{x:0,y:0},{width:p,height:p}):f});return function(d,b,e){return a.apply(this,arguments)}}();z._getCapabilities=function(){var a=D._asyncToGenerator(function*(d){const b={service:"WCS",request:"GetCapabilities"};this.version&&(b.version=this.version,b.acceptVersions=this.version);try{const {data:e}=
yield this.request(this.url,{query:b,responseType:"xml",signal:d});return V.parseCapabilities(e)}catch(e){if(!M.isAbortError(e))throw new C("wcslayer:open","wcs capabilities is not valid or supported");throw e;}});return function(d){return a.apply(this,arguments)}}();z._describeCoverage=function(){var a=D._asyncToGenerator(function*(d){const b={service:"WCS",request:"DescribeCoverage",version:this.version},e=this.version.slice(0,3);"1.0"===e?b.coverage=this.coverageId:"1.1"===e?b.identifiers=this.coverageId:
"2.0"===e&&(b.coverageId=this.coverageId);try{const {data:f}=yield this.request(this.url,{query:b,responseType:"xml",signal:d});return N.parseCoverages(f,this.version)}catch(f){if(!M.isAbortError(f))throw new C("wcslayer:open","wcs coverage description is not valid or supported");throw f;}});return function(d){return a.apply(this,arguments)}}();z._getPixelTypeAndBandCount=function(){var a=D._asyncToGenerator(function*(d){const {pixelSize:b,extent:e,multidimensionalInfo:f}=this.rasterInfo;var c=e.center;
c=new Y({xmin:c.x-b.x,xmax:c.x+b.x,ymin:c.y-b.y,ymax:c.y+b.y,spatialReference:e.spatialReference});let h;if(B.isSome(f)){const n=f.variables[0];h=[];n.dimensions.forEach(r=>{h.push(new S({variableName:n.name,dimensionName:r.name,values:r.hasRegularIntervals?r.extent[0]:r.values[0],isSlice:!0}))})}var {coverageDescription:k}=this.coverageInfo;d={interpolation:"nearest",multidimensionalDefinition:h,signal:B.unwrap(d)};({version:k}=k);const {ioConfig:g}=this,v="2.0"===k&&null==g.allowAnyMediaType||"1.1"===
k&&null==g.use2GridOffsets;try{var m=yield this._getCoverage(c,2,2,1,d,!0)}catch(n){if(!v)throw n;if("1.1"===k){var p;if(null!=(p=n.details)&&p.isResolutionMismatch)g.use2GridOffsets=!0;else throw n;}}!m&&v&&("2.0"===k&&(g.allowAnyMediaType=!0),(m=yield this._getCoverage(c,2,2,1,d))&&K.warn("wcsraster:getcoverage","response is not a supported multipart/related mediaType with inline tiff,  switching to compability mode"));if(!m)throw new C("wcsraster-open","unable to determine pixel type");m=yield this.decodePixelBlock(m,
{width:2,height:2,planes:null,pixelType:null});return{pixelType:m.pixelType,bandCount:m.getPlaneCount()}});return function(d){return a.apply(this,arguments)}}();z._getCoverage=function(){var a=D._asyncToGenerator(function*(d,b,e,f,c,h=!1){const {coverageDescription:k}=this.coverageInfo;var {version:g}=k;d="2.0"===g?this._getCoverage201Parameters(d,b,e,f,c,k):"1.1"===g?this._getCoverage110Parameters(d,b,e,c,k):this._getCoverage100Parameters(d,b,e,c);c="2.0"===g?yield this.request(this._constructWCS201Url(d),
{signal:c.signal,responseType:"array-buffer"}):yield this.request(this.url,{query:d,signal:c.signal,responseType:"array-buffer"});if("1.0"===g)return c.data;if("2.0"===g&&!1!==this.ioConfig.allowAnyMediaType&&"tiff"===W.getFormat(c.data))return h&&(this.ioConfig.allowAnyMediaType=!0,K.warn("wcsraster:getcoverage","response is not a supported multipart/related mediaType with inline tiff,  switching to compability mode")),c.data;g=U.parse(c);if(g.isMultipart&&g.data)return g=g.data.find(v=>{var m;return(null==
(m=v.contentType)?void 0:m.toLowerCase().includes("image"))&&null!=v.contentData}),h&&"base64"===g.contentTransferEncoding&&K.warn("wcsraster:getcoverage","response is base64 encoded which may impact layer display performance"),null==g?void 0:g.contentData;g=new Uint8Array(c.data,0,Math.min(c.data.byteLength,2E3));g=(h=String.fromCharCode.apply(null,g).toLowerCase().includes("exception"))&&String.fromCharCode.apply(null,g).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");
if(h)throw new C("wcsraster:getcoverage","server returns an exception",{isResolutionMismatch:g});throw new C("wcsraster:getcoverage","response is not a supported multipart mediaType with inline tiff");});return function(d,b,e,f,c){return a.apply(this,arguments)}}();z._getInterpolationIndex=function(a){return this.coverageInfo.supportedInterpolations.includes(a)?"nearest"===a?0:"bilinear"===a?1:"cubic"===a?2:0:0};z._getCoverage100Parameters=function(a,d,b,e){const f=`${a.xmin},${a.ymin},${a.xmax},${a.ymax}`;
a=a.spatialReference.wkid;const c=(this.coverageInfo.supportedFormats||[]).find(n=>n.toLowerCase().includes("tiff"))||"GEOTIFF",{bandIds:h,interpolation:k}=e;var g=this._getInterpolationIndex(k);const v=h?h.map(n=>this.coverageInfo.bandNames[n]):null;g=Z[g];({multidimensionalDefinition:e}=e);if(B.isSome(e)&&B.isSome(this.rasterInfo.multidimensionalInfo)){var m;e=e.find(n=>"StdTime"===n.dimensionName);if(0<(null==e?void 0:null==(m=e.values)?void 0:m.length)){var p=e.values;p[0]instanceof Array&&(p=
p[0]);p=p.map(n=>this._convertToISOTime(n)).join(",")}}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:c,crs:`EPSG:${a}`,bbox:f,width:d,height:b,time:p,interpolation:g,band:null==v?void 0:v.join(",")}};z._getCoverage110Parameters=function(a,d,b,e,f){var c;const {multidimensionalDefinition:h,bandIds:k,interpolation:g}=e;e=a.spatialReference.wkid;const v=`urn:ogc:def:crs:EPSG::${e}`,m=(this.coverageInfo.supportedFormats||[]).find(x=>x.toLowerCase().includes("tiff"))||
"image/tiff";var p=this._getInterpolationIndex(g);p=aa[p];const n=null==g||0===(null==(c=this.coverageInfo.supportedInterpolations)?void 0:c.indexOf(g));c=f.domain.spatialDomain;var r=c.origin.x<=c.envelope.xmin&&c.origin.y<=c.envelope.ymin,w=a.width/d,t=a.height/b*(r?1:-1);b=r?[a.xmin,a.ymin]:[a.xmin,a.ymax];b=(c=c.useEPSGAxis&&R.isAxesOrderReversedForWkid(e))?`${b[1]},${b[0]}`:`${b[0]},${b[1]}`;d=this.ioConfig.use2GridOffsets;d=c?d?`${t},${w}`:`${t},0,0,${w}`:d?`${w},${t}`:`${w},0,0,${t}`;r=w/2;
w=a.xmin+r;r=a.xmax-r;var l=Math.abs(t)/2;t=a.ymin+l;a=a.ymax-l;a=c?`${t},${w},${a},${r},${v}`:`${w},${t},${r},${a},${v}`;c=(c=f.range.find(x=>x.axis.some(u=>u.identifier.toLowerCase().includes("band"))))&&p&&k?n?`${c.identifier}[${c.axis[0].identifier}[${k.join(",")}]]`:`${c.identifier}:${p}[${c.axis[0].identifier}[${k.join(",")}]]`:null;let A;if(B.isSome(h)&&h.length)for(t=0;t<h.length;t++){w=h[t].values;const x=h[t].dimensionName.toLowerCase(),u=h[t].variableName.toLowerCase();0<w.length&&(w[0]instanceof
Array&&(w=w[0]),"stdtime"===x?A=w.map(q=>this._convertToISOTime(q)).join(","):(r=f.range.find(q=>q.identifier.toLowerCase()===u))&&(l=r.axis.find(q=>q.identifier.toLowerCase()===x))&&(c=n?r.identifier+"["+l.identifier+"["+w.join(",")+"]]":r.identifier+":"+p+"["+l.identifier+"["+w.join(",")+"]]"))}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:m,crs:`EPSG:${e}`,boundingbox:a,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",
gridOrigin:b,gridOffsets:d,gridBaseCRS:v,timeSequence:A,rangeSubset:c}};z._convertToISOTime=function(a,d=!1){return(d?new Date(864E5*(a-25569)):new Date(a)).toISOString()};z._getCoverage201Parameters=function(a,d,b,e,f,c){const {multidimensionalDefinition:h,interpolation:k}=f;var g=this._getInterpolationIndex(k);let v=null;var {supportedInterpolations:m}=this.capabilities;if(null!=m&&m.length)switch(g){case 0:v=m.find(y=>y.toLowerCase().includes("nearest"));break;case 1:v=m.find(y=>y.toLowerCase().includes("linear"));
break;case 2:v=m.find(y=>y.toLowerCase().includes("cubic")||y.toLowerCase().includes("quadratic"))}g=(this.coverageInfo.supportedFormats||[]).find(y=>y.toLowerCase().includes("tiff"))||"image/tiff";const {bandNames:p}=this.coverageInfo,{boundedBy:n,domainSet:r,rangeType:w}=c;var t=n.isEastFirst?0:1,{axisLabels:l}=n;m=l[t];t=l[1-t];const A=`http://www.opengis.net/def/crs/EPSG/0/${a.spatialReference.wkid}`,x=[];x.push(`${m}(${a.xmin},${a.xmax})`);x.push(`${t}(${a.ymin},${a.ymax})`);a=[];if(2<l.length)for(var u=
2;u<l.length;u++){var q=r.origin[u];if(l[u].toLowerCase().includes("time")){let y=q.toString();n.uomLabels[u].toLowerCase().includes("ole")&&(a.push(l[u]),y=this._convertToISOTime(q,!0));x.push(l[u]+",http://www.opengis.net("+y+")")}else x.push(l[u]+",http://www.opengis.net("+q+")")}a=null;if(B.isSome(h)&&h.length){const y=[];w.forEach(F=>F.forEach(G=>y.push(G.name)));f=[];for(let F=0;F<h.length;F++){const G=l.find(H=>H===h[F].dimensionName);u=y.find(H=>H===h[F].variableName);f.includes(u)||f.push(u);
G&&(q=h[F].values,0<q.length&&(Array.isArray(q[0])&&(q=q[0]),u="",u=G.toLowerCase().includes("time")?q.map(H=>this._convertToISOTime(H)).join(","):q.join(","),q=x.findIndex(H=>0===H.indexOf(G+",http://www.opengis.net")),-1===q&&x.push(G+",http://www.opengis.net("+u+")"),-1===q||x[q].includes("("+u+")")||x.splice(q,1,G+",http://www.opengis.net("+u+")")))}f.length&&(a=f.join(","))}else 2<=(null==p?void 0:p.length)&&(a=(f.bandIds?f.bandIds.map(y=>p[y]):p).join(","));l=x.join("\x26subset\x3d");c=!c.domainSet.hasSameAxisLabelsAsBoundedBy&&
!1!==this.ioConfig.allowScaleFactor;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:a,interpolation:v,scaleSize:c?null:`${m}(${d}),${t}(${b})`,scaleFactor:c?1/e:null,subset:l,format:g,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:A,subsettingcrs:A}};z._constructWCS201Url=function(a){const d={...this.ioConfig.customFetchParameters,...a},b=[];Object.keys(d).forEach(f=>{const c=d[f];null!=c&&("subset"!==f?b.push(`${f}=${encodeURIComponent(c)}`):
c.split("\x26subset\x3d").forEach(h=>{h&&b.push(`subset=${encodeURIComponent(h)}`)}))});a=encodeURI(this.url);const e=b.join("\x26");return`${a}?${e}`};return L}(T);I.__decorate([J.property({type:String,json:{write:!0}})],E.prototype,"datasetFormat",void 0);I.__decorate([J.property()],E.prototype,"tileType",void 0);I.__decorate([J.property({type:String,json:{write:!0}})],E.prototype,"version",void 0);I.__decorate([J.property({type:String,json:{write:!0}})],E.prototype,"coverageId",void 0);return E=
I.__decorate([Q.subclass("esri.layers.support.rasterDatasets.WCSRaster")],E)});