// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../RasterInfo ../RasterStorageInfo ./BaseRaster ./pamParser ../rasterFormats/TiffDecoder ../rasterFormats/TiffTags ../rasterFunctions/stretchUtils ../rasterTransforms/PolynomialTransform ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(A,D,y,N,O,J,ca,da,ea,R,S,T,U,P,E,K,V,W,X,Q,F){const L=(B,G)=>(B=B.get(G))&&B.values[0];y=function(B){function G(){var g=B.apply(this,arguments)||this;g._files=null;g._headerInfo=null;g._bufferSize=1048576;g.datasetFormat="TIFF";return g}A._inheritsLoose(G,B);var C=G.prototype;C.open=function(){var g=A._asyncToGenerator(function*(d){var b,c,f;yield this.init();var e=d?O.unwrap(d.signal):null,{data:a}=yield this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",
signal:e});if(!a)throw new N("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const {littleEndian:h,firstIFD:k,isBigTiff:l}=E.parseSignature(a),q=[];yield this._readIFDs(q,a,h,k,0,l?8:4,e);e=E.getImageInfo(q);const {width:m,height:n,tileWidth:t,tileHeight:r,planes:w,pixelType:u,compression:p,firstPyramidLevel:M,maximumPyramidLevel:z,pyramidBlockWidth:Y,pyramidBlockHeight:Z,tileBoundary:aa,affine:v,metadata:H}=e;a=(null==(b=e.extent.spatialReference)?
void 0:b.wkt)||(null==(c=e.extent.spatialReference)?void 0:c.wkid);b=P.parseSpatialReference(a);a=!1;null==b&&(a=!0,b=new X({wkid:3857}));var I=(c=new Q({...e.extent,spatialReference:b}),new F({x:c.xmin,y:c.ymax,spatialReference:b}));I=new T({blockWidth:t,blockHeight:r,pyramidBlockWidth:Y,pyramidBlockHeight:Z,compression:p,origin:I,firstPyramidLevel:M,maximumPyramidLevel:z,blockBoundary:aa});const ba=new F({x:(c.xmax-c.xmin)/m,y:(c.ymax-c.ymin)/n,spatialReference:b});a=new S({width:m,height:n,bandCount:w,
pixelType:u,compression:p,pixelSize:ba,storageInfo:I,spatialReference:b,isPseudoSpatialReference:a,keyProperties:H?{BandProperties:H.bandProperties,DataType:H.dataType}:{},extent:c,statistics:H?H.statistics:null});null!=v&&v.length&&(a.nativeExtent=new Q({xmin:-.5,ymin:.5-n,xmax:m-.5,ymax:.5,spatialReference:b}),a.transform=new W({polynomialOrder:1,forwardCoefficients:[v[2]+v[0]/2,v[5]-v[3]/2,v[0],v[3],-v[1],-v[4]]}),a.extent=a.transform.forwardTransform(a.nativeExtent),a.pixelSize=new F({x:(c.xmax-
c.xmin)/m,y:(c.ymax-c.ymin)/n,spatialReference:b}),I.origin.x=-.5,I.origin.y=.5);if(null==(f=this.ioConfig.skipExtensions)||!f.includes("aux.xml"))if(d=yield this._fetchAuxiliaryData(d),null!=d){var x;a.statistics=null!=(x=d.statistics)?x:a.statistics;(a.histograms=d.histograms)&&O.isNone(a.statistics)&&(a.statistics=V.estimateStatisticsFromHistograms(d.histograms));d.transform&&!v&&(a.transform=d.transform,a.nativeExtent=a.extent,x=a.transform.forwardTransform(a.nativeExtent),a.pixelSize=new F({x:(x.xmax-
x.xmin)/m,y:(x.ymax-x.ymin)/n,spatialReference:b}),a.extent=x);a.spatialReference||(a.spatialReference=d.spatialReference)}this._set("rasterInfo",a);this._headerInfo={littleEndian:h,isBigTiff:l,ifds:q,...e};if(!this._headerInfo.isSupported)throw new N("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);this.updateTileInfo()});return function(d){return g.apply(this,arguments)}}();C.fetchRawTile=function(){var g=A._asyncToGenerator(function*(d,b,c,f={}){var e;if(null==(e=this._headerInfo)||
!e.isSupported||this.isBlockOutside(d,b,c))return null;b=this._getTileLocation(d,b,c);if(!b)return null;const {ranges:a,actualTileWidth:h,actualTileHeight:k,ifd:l}=b;b=a.map(t=>this.request(this.url,{range:t,responseType:"array-buffer",signal:f.signal}));b=yield Promise.all(b);c=b.map(t=>t.data.byteLength).reduce((t,r)=>t+r);c=1===b.length?b[0].data:new ArrayBuffer(c);e=[0];var q=[0];if(1<b.length){const t=new Uint8Array(c);for(let r=0,w=0;r<b.length;r++){const u=b[r].data;t.set(new Uint8Array(u),
w);e[r]=w;w+=u.byteLength;q[r]=u.byteLength}}const {blockWidth:m,blockHeight:n}=this.getBlockWidthHeight(d);d=yield this.decodePixelBlock(c,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:l,offsets:e,sizes:q},width:m,height:n,planes:null,pixelType:null});if(h!==m||k!==n)if(q=d.mask)for(b=0;b<n;b++)for(e=b*m,c=b<k?h:0;c<m;c++)q[e+c]=0;else for(q=new Uint8Array(m*n),d.mask=q,b=0;b<k;b++)for(e=b*m,c=0;c<h;c++)q[e+c]=1;return d});return function(d,b,c){return g.apply(this,arguments)}}();
C._readIFDs=function(){var g=A._asyncToGenerator(function*(d,b,c,f,e,a=4,h){if(!f)return null;if(f>=b.byteLength||0>f)b=(yield this.request(this.url,{range:{from:f+e,to:f+e+this._bufferSize},responseType:"array-buffer",signal:h})).data,e=f+e,f=0;f=yield this._readIFD(b,c,f,e,K.TIFF_TAGS,a,h);d.push(f.ifd);if(!f.nextIFD)return null;yield this._readIFDs(d,b,c,f.nextIFD-e,e,a,h)});return function(d,b,c,f,e){return g.apply(this,arguments)}}();C._readIFD=function(){var g=A._asyncToGenerator(function*(d,
b,c,f,e=K.TIFF_TAGS,a=4,h){if(!d)return null;c=E.parseIFD(d,b,c,f,e,a);if(c.success){const k=[];c.ifd.forEach(l=>{l.values||k.push(l)});0<k.length&&(a=k.map(l=>l.offlineOffsetSize),e=Math.min.apply(null,a.map(l=>l[0])),Math.min.apply(null,a.map(l=>l[0]+l[1]))-e<=this._bufferSize&&({data:a}=yield this.request(this.url,{range:{from:e,to:e+this._bufferSize},responseType:"array-buffer",signal:h}),d=a,f=e,k.forEach(l=>E.parseFieldValues(d,b,l,f))));c.ifd.has("GEOKEYDIRECTORY")&&(e=c.ifd.get("GEOKEYDIRECTORY"),
(a=e.values)&&4<a.length&&(a=a[0]+"."+a[1]+"."+a[2],h=yield this._readIFD(d,b,e.valueOffset+6-f,f,K.GEO_KEYS,2,h),e.data=h.ifd,e.data&&e.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[a]})));return c}if(c.requiredBufferSize&&c.requiredBufferSize!==d.byteLength)return d=(yield this.request(this.url,{range:{from:f,to:f+c.requiredBufferSize+4},responseType:"array-buffer",signal:h})).data,d.byteLength<c.requiredBufferSize?null:this._readIFD(d,b,0,f,K.TIFF_TAGS,4,h)});return function(d,
b,c,f){return g.apply(this,arguments)}}();C._getTileLocation=function(g,d,b){const {firstPyramidLevel:c,blockBoundary:f}=this.rasterInfo.storageInfo;var e=0===g?0:g-(c-1);g=this._headerInfo.ifds[e];if(!g)return null;var a=E.isBSQConfig(g,this._headerInfo);var h=(h=g.get("TILEOFFSETS"))&&h.values;if(void 0===h)return null;var k=(k=g.get("TILEBYTECOUNTS"))&&k.values;const {minRow:l,minCol:q,maxRow:m,maxCol:n}=f[e];if(d>m||b>n||d<l||b<q)return null;e=L(g,"IMAGEWIDTH");const t=L(g,"IMAGELENGTH"),r=L(g,
"TILEWIDTH"),w=L(g,"TILELENGTH"),u=a?this.rasterInfo.bandCount:1,p=u*d*(n+1)+b,M=[{from:h[p],to:h[p+u-1]+k[p+u-1]-1}];if(a){a=!0;for(let z=0;z<u;z++)if(h[p+z]+k[p+z]!==h[p+z+1]){a=!1;break}if(!a)for(a=0;a<u;a++)M[a]={from:h[p+a],to:h[p+a]+k[p+a]-1}}k=k[p];return null==h[p]||null==k?null:{ranges:M,ifd:g,actualTileWidth:b===n?e%r:r,actualTileHeight:d===m?t%w:w}};C._fetchAuxiliaryData=function(){var g=A._asyncToGenerator(function*(d){try{const {data:b}=yield this.request(this.url+".aux.xml",{responseType:"xml",
signal:null==d?void 0:d.signal});return P.parsePAMInfo(b)}catch{return null}});return function(d){return g.apply(this,arguments)}}();return G}(U);D.__decorate([J.property()],y.prototype,"_files",void 0);D.__decorate([J.property()],y.prototype,"_headerInfo",void 0);D.__decorate([J.property()],y.prototype,"_bufferSize",void 0);D.__decorate([J.property({type:String,json:{write:!0}})],y.prototype,"datasetFormat",void 0);return y=D.__decorate([R.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],
y)});