// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../core/maybe ../../geometry/Extent ../../geometry/Point ../../geometry/projectionEllipsoid ../../geometry/support/WKIDUnitConversion ../ogc/crsUtils ../ogc/xmlUtils ./TileInfo".split(" "),function(w,H,Q,I,J,R,C,D,K,S){function p(b,a){for(let d=0;d<a.childNodes.length;d++){const c=a.childNodes[d];if(c.nodeType===Node.ELEMENT_NODE&&c.nodeName===b)return c}return null}function v(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const e=a.childNodes[c];e.nodeType===
Node.ELEMENT_NODE&&e.nodeName===b&&d.push(e)}return d}function x(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const e=a.childNodes[c];e.nodeType===Node.ELEMENT_NODE&&e.nodeName===b&&d.push(e)}return d.map(c=>c.textContent)}function n(b,a){b.split("\x3e").forEach(d=>{a&&(a=p(d,a))});return a&&a.textContent}function z(b,a,d,c){let e;Array.prototype.slice.call(c.childNodes).some(f=>{if(f.nodeName.includes(b)){var h=p(a,f);h=h&&h.textContent;if(h===d||d.split(":")&&d.split(":")[1]===h)return e=
f,!0}return!1});return e}function L(b,a){var d;const c=[];var e=null==(d=b.layerMap)?void 0:d.get(a);if(e){d=v("ResourceURL",e);e=v("Dimension",e);if(e.length){var f=n("Identifier",e[0]);var h=x("Default",e[0])||x("Value",e[0])}if(1<e.length){var g=n("Identifier",e[1]);var q=x("Default",e[1])||x("Value",e[1])}b.dimensionMap.set(a,{dimensions:h,dimensions2:q});d.forEach(m=>{let k=m.getAttribute("template");if("tile"===m.getAttribute("resourceType")){if(f&&h.length)if(k.includes("{"+f+"}"))k=k.replace("{"+
f+"}","{dimensionValue}");else{var l=k.toLowerCase().indexOf("{"+f.toLowerCase()+"}");-1<l&&(k=k.substring(0,l)+"{dimensionValue}"+k.substring(l+f.length+2))}g&&q.length&&(k.includes("{"+g+"}")?k=k.replace("{"+g+"}","{dimensionValue2}"):(l=k.toLowerCase().indexOf("{"+g.toLowerCase()+"}"),-1<l&&(k=k.substring(0,l)+"{dimensionValue2}"+k.substring(l+g.length+2))));c.push({template:k,format:m.getAttribute("format"),resourceType:"tile"})}});return c}}function M(b,a,d){b=L(b,a);a=b.filter(c=>c.format===
d);return a.length?a:b}function T(b){const a=[];K.visitXML(b,{BoundingBox:d=>{if(d.getAttribute("crs")){var c=d.getAttribute("crs").toLowerCase(),e=E(c),f=c.includes("epsg")&&D.isAxesOrderReversedForWkid(e.wkid),h,g,q,m;K.visitXML(d,{LowerCorner:k=>{[h,g]=k.textContent.split(" ").map(l=>Number.parseFloat(l));f&&([h,g]=[g,h])},UpperCorner:k=>{[q,m]=k.textContent.split(" ").map(l=>Number.parseFloat(l));f&&([q,m]=[m,q])}});a.push({xmin:h,ymin:g,xmax:q,ymax:m,spatialReference:e})}}});return a}function U(b,
a){return v("Style",b).map(d=>{var c=p("LegendURL",d),e=p("Keywords",d);e=e&&x("Keyword",e);c=c&&c.getAttribute("xlink:href");a&&(c=c&&c.replace(/^http:/i,"https:"));return{abstract:n("Abstract",d),id:n("Identifier",d),isDefault:"true"===d.getAttribute("isDefault"),keywords:e,legendUrl:c,title:n("Title",d)}})}function V(b,a,d){return v("TileMatrixSetLink",a).map(c=>W(b,c,d))}function W(b,a,d){const c=p("TileMatrixSet",a).textContent;var e=x("TileMatrix",a);const f=d.find(k=>{k=(k=p("Identifier",k))&&
k.textContent;return k===c||c.split(":")&&c.split(":")[1]===k?!0:!1});a=(a=p("TileMatrixSetLimits",a))&&v("TileMatrixLimits",a);const h=new Map;if(null!=a&&a.length)for(var g of a){a=p("TileMatrix",g).textContent;d=+p("MinTileRow",g).textContent;const k=+p("MaxTileRow",g).textContent,l=+p("MinTileCol",g).textContent,y=+p("MaxTileCol",g).textContent;h.set(a,{minCol:l,maxCol:y,minRow:d,maxRow:k})}const q=n("SupportedCRS",f).toLowerCase();g=X(f,q);a=g.spatialReference;d=p("TileMatrix",f);d=[parseInt(n("TileWidth",
d),10),parseInt(n("TileHeight",d),10)];const m=[];e.length?e.forEach((k,l)=>{k=z("TileMatrix","Identifier",k,f);m.push(N(k,q,l,c,h))}):v("TileMatrix",f).forEach((k,l)=>{m.push(N(k,q,l,c,h))});b=Y(b,f,g,d,m[0]).toJSON();e=(new S({dpi:96,spatialReference:a,size:d,origin:g,lods:m})).toJSON();return{id:c,fullExtent:b,tileInfo:e}}function E(b){b=b.toLowerCase();let a=parseInt(b.split(":").pop(),10);if(900913===a||3857===a)a=102100;b=b.includes("crs84")||b.includes("crs:84")?A.CRS84:b.includes("crs83")||
b.includes("crs:83")?A.CRS83:b.includes("crs27")||b.includes("crs:27")?A.CRS27:null;Q.isSome(b)&&(a=b);return{wkid:a}}function X(b,a){b=p("TileMatrix",b);return O(b,a)}function O(b,a){const d=E(a),[c,e]=n("TopLeftCorner",b).split(" ").map(f=>parseFloat(f));return a.includes("epsg")&&D.isAxesOrderReversedForWkid(d.wkid)?new J({x:e,y:c,spatialReference:d}):new J({x:c,y:e,spatialReference:d})}function Y(b,a,d,c,e){var f=p("BoundingBox",a);if(f){var h=n("LowerCorner",f).split(" ");var g=n("UpperCorner",
f).split(" ")}h&&1<h.length&&g&&1<g.length?(a=parseFloat(h[0]),c=parseFloat(h[1]),h=parseFloat(g[0]),g=parseFloat(g[1])):(a=p("TileMatrix",a),h=parseInt(n("MatrixWidth",a),10),f=parseInt(n("MatrixHeight",a),10),a=d.x,g=d.y,h=a+h*c[0]*e.resolution,c=g-f*c[1]*e.resolution);return"1.0.0"===b&&D.isAxesOrderReversedForWkid(d.spatialReference.wkid)?new I(c,a,g,h,d.spatialReference):new I(a,c,h,g,d.spatialReference)}function N(b,a,d,c,e){var f,h=E(a);const g=n("Identifier",b);let q=parseFloat(n("ScaleDenominator",
b));c=P(h.wkid,q,c);q*=1.058267716535433;h=+n("MatrixWidth",b);const m=+n("MatrixHeight",b),{maxCol:k=h-1,maxRow:l=m-1,minCol:y=0,minRow:F=0}=null!=(f=e.get(g))?f:{},{x:G,y:r}=O(b,a);return{cols:[y,k],level:d,levelValue:g,origin:[G,r],scale:q,resolution:c,rows:[F,l]}}function P(b,a,d){b=C.hasOwnProperty(""+b)?C.values[C[b]]:"default028mm"===d?6370997*Math.PI/180:R.getReferenceEllipsoidFromWKID(b).metersPerDegree;return 7*a/25E3/b}var A;(function(b){b[b.CRS84=4326]="CRS84";b[b.CRS83=4269]="CRS83";
b[b.CRS27=4267]="CRS27"})(A||(A={}));w.getTileUrlFromResourceUrls=function(b,a,d,c,e,f,h,g){var q,m;c=M(b,a,c);if(!(0<(null==c?void 0:c.length)))return"";const {dimensionMap:k}=b;b=null==(q=k.get(a).dimensions)?void 0:q[0];a=null==(m=k.get(a).dimensions2)?void 0:m[0];return c[h%c.length].template.replace(/\{Style\}/gi,e).replace(/\{TileMatrixSet\}/gi,d).replace(/\{TileMatrix\}/gi,f).replace(/\{TileRow\}/gi,""+h).replace(/\{TileCol\}/gi,""+g).replace(/\{dimensionValue\}/gi,b).replace(/\{dimensionValue2\}/gi,
a)};w.getTileUrlTemplateFromResourceUrls=function(b,a,d,c){const {dimensionMap:e}=b;b=L(b,a);let f="";if(b&&0<b.length){const h=e.get(a).dimensions&&e.get(a).dimensions[0];a=e.get(a).dimensions2&&e.get(a).dimensions2[0];f=b[0].template;f.indexOf(".xxx")===f.length-4&&(f=f.slice(0,f.length-4));f=f.replace(/\{Style\}/gi,c);f=f.replace(/\{TileMatrixSet\}/gi,d);f=f.replace(/\{TileMatrix\}/gi,"{level}");f=f.replace(/\{TileRow\}/gi,"{row}");f=f.replace(/\{TileCol\}/gi,"{col}");f=f.replace(/\{dimensionValue\}/gi,
h);f=f.replace(/\{dimensionValue2\}/gi,a)}return f};w.getTileUrlTemplates=M;w.parseCapabilities=function(b,a){var d,c;b=b.replace(/ows:/gi,"");var e=(new DOMParser).parseFromString(b,"text/xml").documentElement;const f=new Map;b=new Map;var h=p("Contents",e);if(!h)throw new H("wmtslayer:wmts-capabilities-xml-is-not-valid");var g=p("OperationsMetadata",e);g=null==g?void 0:g.querySelector("[name\x3d'GetTile']");g=(g=null==g?void 0:g.getElementsByTagName("Get"))&&Array.prototype.slice.call(g);const q=
null!=(d=-1<(null==a?void 0:null==(c=a.url)?void 0:c.indexOf("https")))?d:!1;let m=a.serviceMode,k,l=a&&a.url,y;g&&g.length&&g.some(r=>{const t=p("Constraint",r);if(!t||z("AllowedValues","Value",m,t))return l=r.attributes[0].nodeValue,!0;if(!t||z("AllowedValues","Value","RESTful",t)||z("AllowedValues","Value","REST",t))y=r.attributes[0].nodeValue;else if(!t||z("AllowedValues","Value","KVP",t))k=r.attributes[0].nodeValue;return!1});l||(y?(l=y,m="RESTful"):k?(l=k,m="KVP"):l=(a=p("ServiceMetadataURL",
e))&&a.getAttribute("xlink:href"));a=l.indexOf("1.0.0/");-1===a&&"RESTful"===m?l+="/":-1<a&&(l=l.substring(0,a));"KVP"===m&&(l+=-1<a?"":"?");q&&(l=l.replace(/^http:/i,"https:"));const F=n("ServiceIdentification\x3eServiceTypeVersion",e);e=n("ServiceIdentification\x3eAccessConstraints",e);e=/^none$/i.test(e)?null:e;a=v("Layer",h);const G=v("TileMatrixSet",h);h=a.map(r=>{var t=n("Identifier",r);f.set(t,r);{const Z=n("Abstract",r),aa=x("Format",r);var u=p("WGS84BoundingBox",r);var B=u?n("LowerCorner",
u).split(" "):["-180","-90"];u=u?n("UpperCorner",u).split(" "):["180","90"];B={xmin:parseFloat(B[0]),ymin:parseFloat(B[1]),xmax:parseFloat(u[0]),ymax:parseFloat(u[1]),spatialReference:{wkid:4326}};u=T(r);const ba=U(r,q),ca=n("Title",r);r=V(F,r,G);t={id:t,fullExtent:B,fullExtents:u,description:Z,formats:aa,styles:ba,title:ca,tileMatrixSets:r}}return t});return{copyright:e,dimensionMap:b,layerMap:f,layers:h,serviceMode:m,tileUrl:l}};w.parseResourceInfo=function(b){b.layers.forEach(a=>{a.tileMatrixSets.forEach(d=>
{const c=d.tileInfo;96!==c.dpi&&(c.lods.forEach(e=>{e.scale=96*e.scale/c.dpi;e.resolution=P(c.spatialReference.wkid,90.71428571428571*e.scale/96,d.id)}),c.dpi=96)})});return b};w.validateCapabilities=function(b){var a=b.replace(/ows:/gi,"");a=(new DOMParser).parseFromString(a,"text/xml").documentElement;if(!p("Contents",a))throw new H("wmtslayer:wmts-capabilities-xml-is-not-valid","the wmts get capabilities response is not compliant",{text:b});};Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});