// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/JSONSupport ../../core/Loadable ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ./arcgisLayerUrl ./Contingency ./ContingencyConstraintViolation ./ContingentValue ./ContingentValuesResult ./FieldGroup ./Subtype".split(" "),function(u,C,A,x,M,E,D,P,Q,R,N,F,H,I,t,O,G,J){var y;
x=y=function(K){function B(c){c=K.call(this,c)||this;c.request=A;c.fieldGroups=null;c.fieldGroupDefinitions=null;return c}u._inheritsLoose(B,K);var m=B.prototype;m.initialize=function(){};B.createLoadedLayerContingentValuesCache=function(){var c=u._asyncToGenerator(function*(b){yield b.load();if(void 0===b.layerId)return null;var a=b.sourceJSON.hasContingentValuesDefinition;if(a)return(new y({layer:b})).load();if(void 0===a){a=F.parse(b.url);if(E.isNone(a))return null;a=a.url.path;if((yield y._staticFetchEnterpriseFeatureRoot(a)).supportsQueryDataElements&&
(a=yield y._staticFetchEnterpriseFieldGroup(a,b.layerId.toString())))return a=a.map(d=>({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fieldNames.names})),(new y({layer:b,fieldGroupDefinitions:a})).load()}return null});return function(b){return c.apply(this,arguments)}}();m.load=function(){var c=u._asyncToGenerator(function*(b){const a=this.layer.load(b).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,b));this.addResolvingPromise(a);return this});return function(b){return c.apply(this,
arguments)}}();m.validateContingencyConstraints=function(c,b){const a=this.layer.typeIdField,d=Object.keys(c),e=[],f=[];for(const g of this.fieldGroups){const n=g.isEditingRestrictive?"error":"warning";if(b&&!g.fields.some(p=>b.includes(p)))continue;if(!g.fields.every(p=>d.includes(p))){f.push(new I({fieldGroup:g,type:n}));continue}let q=!1;const k=c[a];var l=g.contingencies.filter(p=>!p.isRetired&&p.subtype?p.subtype.code===k:!0);for(const p of l){l=!0;for(const r in p.values){const h=p.values[r];
if("any"!==h.objectType)if("null"===h.objectType){if(null!=c[r]){l=!1;break}}else if("code"===h.objectType){if(c[r]!==h.codedValue.code){l=!1;break}}else if("range"===h.objectType){const v=c[r];if(v<h.minValue||v>h.maxValue){l=!1;break}}}if(l){q=!0;break}}q||e.push(new I({fieldGroup:g,type:n}))}return{invalid:e,incomplete:f}};m.getContingentValues=function(c,b,a=!1){const d=c[this.layer.typeIdField],e=void 0!==d&&null!==d,f={};let l=[];const g=this.fieldGroups.filter(q=>q.fields.includes(b));l.push(new t({objectType:"any"}));
for(const q of g){let k=[];var n=q.contingencies.filter(h=>!h.isRetired&&(h.subtype&&e?h.subtype.code===d:!0));let p=!1;const r={};for(const h of n){let v;n=!0;for(const z in h.values){const w=h.values[z];if(b===z)v=w,p=p||"range"===w.objectType;else if(void 0!==c[z]&&"any"!==w.objectType)if("null"===w.objectType)null!==c[z]&&(n=!1);else if("code"===w.objectType)c[z]!==w.codedValue.code&&(n=!1);else if("range"===w.objectType){const L=c[z];if(L<w.minValue||L>w.maxValue)n=!1}}if(v&&n){if("any"===v.objectType){k.length=
0;k.push(v);break}n=this._generateKey(v);r[n]||k.push(v);r[n]=!0}}p&&(k=this._joinRange(k));f[q.name]=k;l=a?this._filterIntersection(l,k):null}1===g.length&&a&&(l=[]);return new O({contingentValuesAllGroups:l,contingentValuesByFieldGroup:f})};m._generateKey=function(c){switch(c.objectType){case "any":return"@any@";case "null":return"@null@";case "code":return c.codedValue.name+c.codedValue.code.toString();case "range":return c.minValue.toString()+"-"+c.maxValue.toString()}};m._joinRange=function(c){c.sort((e,
f)=>"null"===e.objectType?-1:"null"===f.objectType?1:e.minValue-f.minValue);let b,a;const d=[];for(const e of c)"null"===e.objectType?d.push(e):void 0===b?(b=e.minValue,a=e.maxValue):a<e.minValue?(d.push(new t({objectType:"range",minValue:b,maxValue:a})),b=e.minValue,a=e.maxValue):a<e.maxValue&&(a=e.maxValue);d.push(new t({objectType:"range",minValue:b,maxValue:a}));return d};m._filterIntersection=function(c,b){var a,d;if(0===c.length||0===b.length)return[];if("any"===c[0].objectType)return b;if("any"===
b[0].objectType)return c;const e="range"===c[0].objectType||"range"===(null==(a=c[1])?void 0:a.objectType);a="range"===b[0].objectType||"range"===(null==(d=b[1])?void 0:d.objectType);return e||a?this._intersectRanges(c,b):this._intersectValues(c,b)};m._intersectRanges=function(c,b){const a=[];let d=0;for(const e of c)for(;d<b.length;d++){const f=b[d];if("null"===e.objectType&&"null"===f.objectType)a.push(new t({objectType:"null"}));else if("null"===e.objectType)break;else if("null"===f.objectType)continue;
if(e.maxValue<f.minValue)break;if(e.maxValue===f.minValue){a.push(new t({objectType:"range",minValue:e.maxValue,maxValue:f.minValue}));break}if(!(e.minValue>f.maxValue))if(e.minValue===f.maxValue)a.push(new t({objectType:"range",minValue:e.minValue,maxValue:f.maxValue}));else{c=e.minValue>f.minValue?e.minValue:f.minValue;if(e.maxValue<f.maxValue){a.push(new t({objectType:"range",minValue:c,maxValue:e.maxValue}));break}a.push(new t({objectType:"range",minValue:c,maxValue:f.maxValue}))}}return a};m._intersectValues=
function(c,b){const a=[];for(const d of c)b.some(e=>{if(d.objectType===e.objectType)switch(d.objectType){case "any":case "null":return!0;case "code":return d.codedValue.code===e.codedValue.code&&d.codedValue.name===e.codedValue.name}return!1})&&a.push(d);return a};B._staticFetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(b,a){return A(b,{responseType:"json",query:{f:"json"},...a}).then(d=>d.data)});return function(b,a){return c.apply(this,arguments)}}();B._staticFetchEnterpriseFieldGroup=
function(){var c=u._asyncToGenerator(function*(b,a,d){return A(`${b}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([a]),f:"json"},...d}).then(e=>{var f;return null==(f=e.data.layerDataElements)?void 0:f[0].dataElement.fieldGroups})});return function(b,a,d){return c.apply(this,arguments)}}();m._initializeContingentValues=function(){var c=u._asyncToGenerator(function*(b,a){b=b?b:yield this._fetchFieldGroupDefs(a);this.fieldGroups=0===b.length?[]:yield this._fetchContingentValues(b,
a)});return function(b,a){return c.apply(this,arguments)}}();m._fetchFieldGroupDefs=function(){var c=u._asyncToGenerator(function*(b){var a=this;if(void 0===this.layer.layerId)return[];const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=E.unwrap(F.parse(this.layer.url)).url.path;return d.hasContingentValuesDefinition?(yield this._fetchAGOLFieldGroup(f,e,b)).map(l=>({name:l.name,isEditingRestrictive:l.restrictive,fields:l.fields.map(g=>this.layer.fieldsIndex.normalizeFieldName(g))})):void 0!==
d.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(f,b).then(function(){var l=u._asyncToGenerator(function*(g){return g.supportsQueryDataElements?(yield a._fetchEnterpriseFieldGroup(f,e,b)).map(n=>({name:n.name,isEditingRestrictive:n.isEditingRestrictive,fields:n.fieldNames.names.map(q=>a.layer.fieldsIndex.normalizeFieldName(q))})):[]});return function(g){return l.apply(this,arguments)}}())});return function(b){return c.apply(this,arguments)}}();m._fetchAGOLFieldGroup=function(){var c=
u._asyncToGenerator(function*(b,a,d){return A(`${b}/${a}/fieldgroups`,{responseType:"json",query:{f:"json"},...d}).then(e=>e.data.fieldGroups)});return function(b,a,d){return c.apply(this,arguments)}}();m._fetchEnterpriseFieldGroup=function(){var c=u._asyncToGenerator(function*(b,a,d){return y._staticFetchEnterpriseFieldGroup(b,a,d)});return function(b,a,d){return c.apply(this,arguments)}}();m._fetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(b,a){return y._staticFetchEnterpriseFeatureRoot(b,
a)});return function(b,a){return c.apply(this,arguments)}}();m._fetchContingentValues=function(){var c=u._asyncToGenerator(function*(b,a){if(void 0===this.layer.layerId)return[];const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=E.unwrap(F.parse(this.layer.url)).url.path;if(d.hasContingentValuesDefinition)return a=yield this._fetchAGOLContingentValues(f,e,a),this._constructFieldGroupsAGOL(b,a);a=yield this._fetchEnterpriseContingentValues(f,e,a);return this._constructFieldGroupsEnterprise(b,
a)});return function(b,a){return c.apply(this,arguments)}}();m._constructFieldGroupsAGOL=function(c,b){return c.map(a=>{const d=b.contingentValuesDefinition.fieldGroups.find(e=>e.name===a.name);if(d){let e=[];e=b.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(a,b,d.subTypes):this._parseAGOLFieldGroup(a,b,d.contingentValues);return new G({name:a.name,isEditingRestrictive:a.isEditingRestrictive,fields:a.fields,contingencies:e})}return null}).filter(a=>null!==a)};m._parseAGOLFieldGroupSubtype=
function(c,b,a){let d=[];a.forEach(e=>{const f=this._getSubtypeAGOL(e.name);d=d.concat(this._parseAGOLFieldGroup(c,b,e.contingentValues,f))});return d};m._parseAGOLFieldGroup=function(c,b,a,d=null){const e=[];for(const f of a)a=this._parseAGOLContingency(f,c,b,d),e.push(a);return e};m._parseAGOLContingency=function(c,b,a,d){const e=c.id,f=c.retired?1===c.retired:!1,l={};for(let n=0,q=0;n<b.fields.length;n++){const k=b.fields[n];var g=a.typeCodes[c.types[n]];if("Code"===g){let p=c.values[q];q++;const r=
this._getDomain(d,k);"string"===this.layer.getField(k).type&&(g=a.stringDicts.find(h=>h.domain===r.name))&&(p=g.entries[p]);g=r.codedValues.find(h=>h.code===p);g=new t({codedValue:g,objectType:"code"});l[k]=g}else"Range"===g?(g=c.values[q],q++,g=new t({minValue:g.range[0],maxValue:g.range[1],objectType:"range"}),l[k]=g):"Any"===g?(g=new t({objectType:"any"}),l[k]=g):(g=new t({objectType:"null"}),l[k]=g)}return new H({id:e,isRetired:f,subtype:d,values:l})};m._constructFieldGroupsEnterprise=function(c,
b){const a=b.fieldGroups;return c.map(d=>{var e=a.find(f=>f.name===d.name);return e?(e=e.contingencies.map(f=>{const l=f.id,g=f.isRetired||!1,n=this._getSubtypeEnterprise(f.subtypeCode),q={};for(let p=0;p<d.fields.length;p++){const r=d.fields[p];let h=f.values[p];if("number"===typeof h||"string"===typeof h){var k=this._getDomain(n,r);const v=this.layer.getField(r);"string"===v.type?h=b.stringDictionary[h]:"date"===v.type&&(h=(new Date(`${h}+00:00`)).getTime());k=k.codedValues.find(z=>z.code===h);
k=new t({codedValue:k,objectType:"code"});q[r]=k}else"object"===typeof h?(k=new t({minValue:h.minValue,maxValue:h.maxValue,objectType:"range"}),q[r]=k):h?(k=new t({objectType:"any"}),q[r]=k):(k=new t({objectType:"null"}),q[r]=k)}return new H({id:l,isRetired:g,subtype:n,values:q})}),new G({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fields,contingencies:e})):null}).filter(d=>null!==d)};m._fetchEnterpriseContingentValues=function(){var c=u._asyncToGenerator(function*(b,a,d){return A(`${b}/queryContingentValues`,
{responseType:"json",query:{layers:JSON.stringify([a]),f:"json"},...d}).then(e=>{var f;return null==(f=e.data.contingentValueSets)?void 0:f[0]})});return function(b,a,d){return c.apply(this,arguments)}}();m._fetchAGOLContingentValues=function(){var c=u._asyncToGenerator(function*(b,a,d){return A(`${b}/${a}/contingentValues`,{responseType:"json",query:{f:"json"},...d}).then(e=>e.data)});return function(b,a,d){return c.apply(this,arguments)}}();m._getSubtypeEnterprise=function(c){var b=this.layer.sourceJSON;
let a;b.subtypes&&(b=b.subtypes.find(d=>d.code===c),a=J.fromJSON(b));return a?a:null};m._getSubtypeAGOL=function(c){var b=this.layer.sourceJSON;let a;b.subtypes&&(b=b.subtypes.find(d=>d.name===c),a=J.fromJSON(b));return a?a:null};m._getDomain=function(c,b){c=c?c.domains[b]:this.layer.getFieldDomain(b);return"inherited"===c.type?this.layer.getFieldDomain(b):c};return B}(x.JSONSupportMixin(M));C.__decorate([D.property({constructOnly:!0})],x.prototype,"layer",void 0);C.__decorate([D.property({constructOnly:!0})],
x.prototype,"request",void 0);C.__decorate([D.property({type:[G]})],x.prototype,"fieldGroups",void 0);C.__decorate([D.property()],x.prototype,"fieldGroupDefinitions",void 0);return x=y=C.__decorate([N.subclass("esri.layers.support.LayerContingentValuesCache")],x)});