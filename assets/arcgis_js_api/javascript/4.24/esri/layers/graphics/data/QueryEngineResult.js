// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../geometry/support/centroid ../../../geometry/support/extentUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ./AttributesBuilder ./projectionSupport ./utils ../../support/fieldUtils ../../../statistics/utils ../../../support/arcadeOnDemand".split(" "),function(Y,G,C,O,S,P,T,Q,N,U,F,V,z,Z){function aa(x,p,c,a,b,e){b-=c;e-=a;x=Math.min(1,Math.max(0,((x-c)*b+(p-
a)*e)/(b*b+e*e)));return{x:c+b*x,y:a+e*x}}function ba(x,p){return x?p?4:3:p?3:2}let ea=function(){function x(c,a,b){this.items=c;this.query=a;this.geometryType=b.geometryType;this.hasM=b.hasM;this.hasZ=b.hasZ;this.fieldsIndex=b.fieldsIndex;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.featureAdapter=b.featureAdapter}var p=x.prototype;p.createQueryResponseForCount=function(){const c=new N(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return c.countDistinctValues(this.items);
const {groupByFieldsForStatistics:a,having:b,outStatistics:e}=this.query;if(null==a||!a.length)return 1;const d=new Map,f=new Map,k=new Set;for(const n of e){var {statisticType:g}=n;g="exceedslimit"!==g?n.onStatisticField:void 0;if(!f.has(g)){var h=[];for(const l of a){const m=this._getAttributeValues(c,l,d);h.push(m)}f.set(g,this._calculateUniqueValues(h,c.returnDistinctValues))}g=f.get(g);for(const l in g){const {data:m,items:q}=g[l];h=m.join(",");b&&!c.validateItems(q,b)||k.add(h)}}return k.size};
p.createQueryResponse=function(){var c=C._asyncToGenerator(function*(){let a;a=this.query.outStatistics?this.query.outStatistics.some(b=>"exceedslimit"===b.statisticType)?this._createExceedsLimitQueryResponse(this.query):yield this._createStatisticsQueryResponse(this.query):this._createFeatureQueryResponse(this.query);this.query.returnQueryGeometry&&(Q.isValid(this.query.outSR)&&!Q.equals(this.query.geometry.spatialReference,this.query.outSR)?a.queryGeometry=F.cleanFromGeometryEngine({spatialReference:this.query.outSR,
...U.project(this.query.geometry,this.query.geometry.spatialReference,this.query.outSR)}):a.queryGeometry=F.cleanFromGeometryEngine({spatialReference:this.query.outSR,...this.query.geometry}));return a});return function(){return c.apply(this,arguments)}}();p.createSnappingResponse=function(c,a){const b=this.featureAdapter,e=ba(this.hasZ,this.hasM),{x:d,y:f}=c.point,k="number"===typeof c.distance?c.distance:c.distance.x,g="number"===typeof c.distance?c.distance:c.distance.y,h={candidates:[]},n="esriGeometryPolygon"===
this.geometryType;a=this._getPointCreator(c.point,this.spatialReference,a);for(const v of this.items){var l=b.getGeometry(v);if(O.isNone(l))continue;const {coords:u,lengths:w}=l;if(c.types&G.SnappingTypes.EDGE){l=0;for(var m=0;m<w.length;m++){var q=w[m];for(var t=0;t<q;t++,l+=e){var y=u[l],A=u[l+1];if(t!==q-1){const D=u[l+e],B=u[l+e+1],{x:E,y:K}=aa(d,f,y,A,D,B);var r=(d-E)/k;const L=(f-K)/g;r=r*r+L*L;1>=r&&h.candidates.push({type:"edge",objectId:b.getObjectId(v),distance:Math.sqrt(r),target:a(E,K),
start:a(y,A),end:a(D,B)})}}}}if(c.types&G.SnappingTypes.VERTEX)for(l=n?u.length-e:u.length,m=0;m<l;m+=e)q=u[m],t=u[m+1],y=(d-q)/k,A=(f-t)/g,y=y*y+A*A,1>=y&&h.candidates.push({type:"vertex",objectId:b.getObjectId(v),distance:Math.sqrt(y),target:a(q,t)})}h.candidates.sort((v,u)=>v.distance-u.distance);return h};p._getPointCreator=function(c,a,b){const e=O.isSome(b)&&!Q.equals(a,b)?d=>U.project(d,a,b):d=>d;return null!=c.z&&null!=c.m?(d,f)=>e({x:d,y:f,z:c.z,m:c.m}):null!=c.z?(d,f)=>e({x:d,y:f,z:c.z}):
null!=c.m?(d,f)=>e({x:d,y:f,m:c.m}):(d,f)=>e({x:d,y:f})};p.createSummaryStatisticsResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:k,minValue:g,maxValue:h,scale:n}=a;a=this.fieldsIndex.isDateField(b);var l=yield this._getDataValues({field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:k,scale:n});const m=z.isNullCountSupported({normalizationType:f,normalizationField:d,
minValue:g,maxValue:h}),q=this.fieldsIndex.get(b),t={value:.5,fieldType:null==q?void 0:q.type};l=V.isStringField(q)?z.calculateStringStatistics({values:l,supportsNullCount:m,percentileParams:t}):z.calculateStatistics({values:l,minValue:g,maxValue:h,useSampleStdDev:!f,supportsNullCount:m,percentileParams:t});return z.processSummaryStatisticsResult(l,a)});return function(a){return c.apply(this,arguments)}}();p.createUniqueValuesResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,
valueExpression:e,domain:d,returnAllCodedValues:f,scale:k}=a;a=yield this._getDataValues({field:b,valueExpression:e,scale:k});a=z.calculateUniqueValuesCount(a);return z.createUVResult(a,d,f)});return function(a){return c.apply(this,arguments)}}();p.createClassBreaksResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:k,classificationMethod:g,standardDeviationInterval:h,minValue:n,maxValue:l,numClasses:m,
scale:q}=a;a=yield this._getDataValues({field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:k,scale:q});a=z.calculateClassBreaks(a,{field:b,normalizationField:d,normalizationType:f,normalizationTotal:k,classificationMethod:g,standardDeviationInterval:h,minValue:n,maxValue:l,numClasses:m});return z.resolveCBResult(a,g)});return function(a){return c.apply(this,arguments)}}();p.createHistogramResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,
valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:k,classificationMethod:g,standardDeviationInterval:h,minValue:n,maxValue:l,numBins:m,scale:q}=a;a=yield this._getDataValues({field:b,valueExpression:e,normalizationField:d,normalizationType:f,normalizationTotal:k,scale:q});return z.calculateHistogram(a,{field:b,normalizationField:d,normalizationType:f,normalizationTotal:k,classificationMethod:g,standardDeviationInterval:h,minValue:n,maxValue:l,numBins:m})});return function(a){return c.apply(this,
arguments)}}();p._sortFeatures=function(c,a,b){if(1<c.length&&a&&a.length)for(const e of a.reverse()){a=e.split(" ");const d=a[0],f=this.fieldsIndex.get(d);a=a[1]&&"desc"===a[1].toLowerCase();const k=z.getAttributeComparator(null==f?void 0:f.type,a);c.sort((g,h)=>{g=b(g,d,f);h=b(h,d,f);return k(g,h)})}};p._createFeatureQueryResponse=function(c){const a=this.items,{geometryType:b,hasM:e,hasZ:d,objectIdField:f,spatialReference:k}=this,{outFields:g,outSR:h,quantizationParameters:n,resultRecordCount:l,
resultOffset:m,returnZ:q,returnM:t}=c,y=null!=l?a.length>(m||0)+l:!1,A=g&&(g.includes("*")?[...this.fieldsIndex.fields]:g.map(r=>this.fieldsIndex.get(r)));return{exceededTransferLimit:y,features:this._createFeatures(c,a),fields:A,geometryType:b,hasM:e&&t,hasZ:d&&q,objectIdFieldName:f,spatialReference:F.cleanFromGeometryEngine(h?h:k),transform:n&&T.toQuantizationTransform(n)||null}};p._createFeatures=function(c,a){const b=new N(c,this.featureAdapter,this.fieldsIndex),{hasM:e,hasZ:d}=this,{orderByFields:f,
quantizationParameters:k,returnGeometry:g,returnCentroid:h,maxAllowableOffset:n,resultOffset:l,resultRecordCount:m,returnZ:q=!1,returnM:t=!1}=c,y=d&&q,A=e&&t;c=[];var r=0;a=[...a];this._sortFeatures(a,f,(w,D,B)=>b.getFieldValue(w,D,B));if(g||h){var v=T.toQuantizationTransform(k);if(g&&!h)for(var u of a)c[r++]={attributes:b.getAttributes(u),geometry:F.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(u),n,v,y,A)};else if(!g&&h)for(const w of a)c[r++]={attributes:b.getAttributes(w),
centroid:F.transformCentroid(this,this.featureAdapter.getCentroid(w,this),v)};else for(const w of a)c[r++]={attributes:b.getAttributes(w),centroid:F.transformCentroid(this,this.featureAdapter.getCentroid(w,this),v),geometry:F.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(w),n,v,y,A)}}else for(v of a)(u=b.getAttributes(v))&&(c[r++]={attributes:u});r=l||0;null!=m&&(c=c.slice(r,Math.min(c.length,r+m)));return c};p._createExceedsLimitQueryResponse=function(c){var a=
!1;let b=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY;a=Number.POSITIVE_INFINITY;for(const d of c.outStatistics)if("exceedslimit"===d.statisticType){b=null!=d.maxPointCount?d.maxPointCount:Number.POSITIVE_INFINITY;e=null!=d.maxRecordCount?d.maxRecordCount:Number.POSITIVE_INFINITY;a=null!=d.maxVertexCount?d.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)a=this.items.length>b;else if(this.items.length>e)a=!0;else{c=this.hasZ?this.hasM?4:3:this.hasM?3:
2;const d=this.featureAdapter;a=this.items.reduce((f,k)=>{k=d.getGeometry(k);return f+(O.isSome(k)&&k.coords.length||0)},0)/c>a}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(a)}}]}};p._createStatisticsQueryResponse=function(){var c=C._asyncToGenerator(function*(a){var b={attributes:{}};const e=[],d=new Map,f=new Map,k=new Map,g=new Map,h=new N(a,this.featureAdapter,
this.fieldsIndex);var n=a.outStatistics;const {groupByFieldsForStatistics:l,having:m,orderByFields:q}=a;a=l&&l.length;const t=!!a,y=t&&l[0],A=t&&!this.fieldsIndex.get(y);for(const D of n){const {outStatisticFieldName:B,statisticType:E}=D;n=D;var r="exceedslimit"!==E?D.onStatisticField:void 0;const K="percentile_disc"===E||"percentile_cont"===E,L="EnvelopeAggregate"===E||"CentroidAggregate"===E||"ConvexHullAggregate"===E,ca=t&&1===a&&(r===y||A)&&"count"===E;if(t){if(!k.has(r)){var v=[];for(const M of l){var u=
this._getAttributeValues(h,M,d);v.push(u)}k.set(r,this._calculateUniqueValues(v,h.returnDistinctValues))}v=k.get(r);for(const M in v){const {count:R,data:W,items:X,itemPositions:da}=v[M];u=W.join(",");if(!m||h.validateItems(X,m)){const H=g.get(u)||{attributes:{}};if(L){H.aggregateGeometries||(H.aggregateGeometries={});const {aggregateGeometries:I,outStatisticFieldName:J}=yield this._getAggregateGeometry(n,X);H.aggregateGeometries[J]=I}else{var w=null;if(ca)w=R;else{const I=this._getAttributeValues(h,
r,d);w=da.map(J=>I[J]);w=K&&"statisticParameters"in n?this._getPercentileValue(n,w):this._getStatisticValue(n,w,null,h.returnDistinctValues)}H.attributes[B]=w}l.forEach((I,J)=>H.attributes[this.fieldsIndex.get(I)?I:`EXPR_${J+1}`]=W[J]);g.set(u,H)}}}else if(L){b.aggregateGeometries||(b.aggregateGeometries={});const {aggregateGeometries:M,outStatisticFieldName:R}=yield this._getAggregateGeometry(n,this.items);b.aggregateGeometries[R]=M}else r=this._getAttributeValues(h,r,d),b.attributes[B]=K&&"statisticParameters"in
n?this._getPercentileValue(n,r):this._getStatisticValue(n,r,f,h.returnDistinctValues);e.push({name:B,alias:B,type:"esriFieldTypeDouble"})}b=t?Array.from(g.values()):[b];this._sortFeatures(b,q,(D,B)=>D.attributes[B]);return{fields:e,features:b}});return function(a){return c.apply(this,arguments)}}();p._getAggregateGeometry=function(){var c=C._asyncToGenerator(function*(a,b){var e=yield new Promise((q,t)=>Y(["../../../geometry/geometryEngineJSON"],q,t));const {statisticType:d,outStatisticFieldName:f}=
a,{featureAdapter:k,spatialReference:g,geometryType:h,hasZ:n,hasM:l}=this;b=b.map(q=>F.getGeometry(h,n,l,k.getGeometry(q)));const m=e.convexHull(g,b,!0)[0];a={aggregateGeometries:null,outStatisticFieldName:null};"EnvelopeAggregate"===d?(e=m?P.getPolygonExtent(m):P.getGeometryExtent(e.union(g,b)),a.aggregateGeometries={...e,spatialReference:g},a.outStatisticFieldName=f||"extent"):"CentroidAggregate"===d?(e=m?S.polygonCentroid(m):S.extentCentroid(P.getGeometryExtent(e.union(g,b))),a.aggregateGeometries=
{x:e[0],y:e[1],spatialReference:g},a.outStatisticFieldName=f||"centroid"):"ConvexHullAggregate"===d&&(a.aggregateGeometries=m,a.outStatisticFieldName=f||"convexHull");return a});return function(a,b){return c.apply(this,arguments)}}();p._getStatisticValue=function(c,a,b,e){const {onStatisticField:d,statisticType:f}=c;c=null;c=null!=b&&b.has(d)?b.get(d):V.isStringField(this.fieldsIndex.get(d))?z.calculateStringStatistics({values:a,returnDistinct:e}):z.calculateStatistics({values:a,minValue:null,maxValue:null,
useSampleStdDev:!0});b&&b.set(d,c);return c["var"===f?"variance":f]};p._getPercentileValue=function(c,a){const {onStatisticField:b,statisticParameters:e,statisticType:d}=c,{value:f,orderBy:k}=e;c=this.fieldsIndex.get(b);return z.calculatePercentile(a,{value:f,orderBy:k,fieldType:null==c?void 0:c.type,isDiscrete:"percentile_disc"===d})};p._getAttributeValues=function(c,a,b){if(b.has(a))return b.get(a);const e=this.fieldsIndex.get(a),d=this.items.map(f=>c.getFieldValue(f,a,e));b.set(a,d);return d};
p._getAttributeNormalizedValues=function(c,a){return this.items.map(b=>c.getNormalizedValue(b,{field:a.field,fieldInfo:this.fieldsIndex.get(a.field),normalizationField:a.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(a.normalizationField),normalizationType:a.normalizationType,normalizationTotal:a.normalizationTotal}))};p._getAttributeExpressionValues=function(){var c=C._asyncToGenerator(function*(a,b,e){const {arcadeUtils:d}=yield Z.loadArcade();b=d.createFunction(b);e=e&&d.getViewInfo(e);
return a.getExpressionValues(this.items,b,e,d)});return function(a,b,e){return c.apply(this,arguments)}}();p._calculateUniqueValues=function(c,a){const b={},e=this.items,d=e.length;for(let f=0;f<d;f++){const k=e[f],g=[];for(const n of c)g.push(n[f]);const h=g.join(",");a?null==b[h]&&(b[h]={count:1,data:g,items:[k],itemPositions:[f]}):null==b[h]?b[h]={count:1,data:g,items:[k],itemPositions:[f]}:(b[h].count++,b[h].items.push(k),b[h].itemPositions.push(f))}return b};p._getDataValues=function(){var c=
C._asyncToGenerator(function*(a){const b=new N(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:e,field:d,normalizationField:f,normalizationType:k,normalizationTotal:g,scale:h}=a;a=e?{viewingMode:"map",scale:h,spatialReference:this.query.outSR||this.spatialReference}:null;return e?this._getAttributeExpressionValues(b,e,a):this._getAttributeNormalizedValues(b,{field:d,normalizationField:f,normalizationType:k,normalizationTotal:g})});return function(a){return c.apply(this,arguments)}}();
C._createClass(x,[{key:"size",get:function(){return this.items.length}}]);return x}();G.SnappingTypes=void 0;(function(x){x[x.NONE=0]="NONE";x[x.EDGE=1]="EDGE";x[x.VERTEX=2]="VERTEX"})(G.SnappingTypes||(G.SnappingTypes={}));G.QueryEngineResult=ea;Object.defineProperties(G,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});