// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/arrayUtils ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/MemCache ../../../core/unitUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/normalizeUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/FieldsIndex ../../../support/arcadeOnDemand ../../../views/support/Scheduler".split(" "),
function(M,n,Q,C,R,p,S,N,J,O,X,K,T,D,Y,y,z,Z,t,E,U,u,aa,ba,V){function ca(H){return H.every(l=>"exceedslimit"!==l.statisticType)}const da=new S.MemCacheStorage(2E6);let ea=0,ka=function(){function H(b){this.capabilities={query:Z.queryCapabilities};this.geometryType=b.geometryType;this.hasM=b.hasM;this.hasZ=b.hasZ;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.definitionExpression=b.definitionExpression;this.featureStore=b.featureStore;this.aggregateAdapter=b.aggregateAdapter;
this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache());this.timeInfo=b.timeInfo;b.cacheSpatialQueries&&(this._geometryQueryCache=new S.MemCache(ea++ +"$$",da));this.fieldsIndex=new aa(b.fields);b.scheduler&&b.priority&&(this._frameTask=b.scheduler.registerTask(b.priority))}var l=H.prototype;l.destroy=function(){this._frameTask=p.removeMaybe(this._frameTask);this.clearCache();p.destroyMaybe(this._geometryQueryCache);this._changeHandle=p.removeMaybe(this._changeHandle);p.destroyMaybe(this.fieldsIndex)};
l.clearCache=function(){var b;null==(b=this._geometryQueryCache)?void 0:b.clear();this._timeExtent=this._allItems=null};l.executeQuery=function(){var b=n._asyncToGenerator(function*(a,c){try{return(yield this._executeQuery(a,{},c)).createQueryResponse()}catch(d){if(d!==u.QUERY_ENGINE_EMPTY_RESULT)throw d;return(new t.QueryEngineResult([],a,this)).createQueryResponse()}});return function(a,c){return b.apply(this,arguments)}}();l.executeQueryForCount=function(){var b=n._asyncToGenerator(function*(a=
{},c){try{return(yield this._executeQuery(a,{returnGeometry:!1,returnCentroid:!1,outSR:null},c)).createQueryResponseForCount()}catch(d){if(d!==u.QUERY_ENGINE_EMPTY_RESULT)throw d;return 0}});return function(){return b.apply(this,arguments)}}();l.executeQueryForExtent=function(){var b=n._asyncToGenerator(function*(a,c){const d=a.outSR;try{const e=yield this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},c),g=e.size;if(!g)return{count:0,extent:null};J.set(x,J.NEGATIVE_INFINITY);this.featureStore.forEachBounds(e.items,
h=>J.expandWithAABB(x,h),fa);const k={xmin:x[0],ymin:x[1],xmax:x[3],ymax:x[4],spatialReference:u.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(x[2])&&isFinite(x[5])&&(k.zmin=x[2],k.zmax=x[5]);const f=z.project(k,e.spatialReference,d);f.spatialReference=u.cleanFromGeometryEngine(d||this.spatialReference);if(0===f.xmax-f.xmin){const h=N.getMetersPerUnitForSR(f.spatialReference);f.xmin-=h;f.xmax+=h}if(0===f.ymax-f.ymin){const h=N.getMetersPerUnitForSR(f.spatialReference);f.ymin-=
h;f.ymax+=h}if(this.hasZ&&null!=f.zmin&&null!=f.zmax&&0===f.zmax-f.zmin){const h=N.getMetersPerUnitForSR(f.spatialReference);f.zmin-=h;f.zmax+=h}return{count:g,extent:f}}catch(e){if(e===u.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw e;}});return function(a,c){return b.apply(this,arguments)}}();l.executeQueryForIds=function(){var b=n._asyncToGenerator(function*(a,c){return this.executeQueryForIdSet(a,c).then(d=>Array.from(d))});return function(a,c){return b.apply(this,arguments)}}();
l.executeQueryForIdSet=function(){var b=n._asyncToGenerator(function*(a,c){try{const d=yield this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},c),e=d.items,g=new Set;yield this._reschedule(()=>{for(const k of e)g.add(d.featureAdapter.getObjectId(k))},c);return g}catch(d){if(d===u.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw d;}});return function(a,c){return b.apply(this,arguments)}}();l.executeQueryForSnapping=function(){var b=n._asyncToGenerator(function*(a,c){const {point:d,
distance:e,types:g}=a;if(g===t.SnappingTypes.NONE)return{candidates:[]};const k=yield this._reschedule(()=>this._checkQuerySupport(a.query),c),f=!D.equals(d.spatialReference,this.spatialReference);f&&(yield z.checkProjectionSupport(d.spatialReference,this.spatialReference));var h="number"===typeof e?e:e.x,q="number"===typeof e?e:e.y;h={xmin:d.x-h,xmax:d.x+h,ymin:d.y-q,ymax:d.y+q,spatialReference:d.spatialReference};h=f?z.project(h,this.spatialReference):h;if(!h)return{candidates:[]};q=(yield T.normalizeCentralMeridian(K.fromJSON(d),
null,{signal:c}))[0];const m=(yield T.normalizeCentralMeridian(K.fromJSON(h),null,{signal:c}))[0];if(p.isNone(q)||p.isNone(m))return{candidates:[]};const r=new t.QueryEngineResult(this._searchFeatures(this._getQueryBBoxes(m.toJSON())),k,this);yield this._reschedule(()=>this._executeObjectIdsQuery(r),c);yield this._reschedule(()=>this._executeTimeQuery(r),c);yield this._reschedule(()=>this._executeAttributesQuery(r),c);c=q.toJSON();c=f?z.project(c,this.spatialReference):c;return r.createSnappingResponse({...a,
point:c,distance:f?Math.max(h.xmax-h.xmin,h.ymax-h.ymin)/2:e},d.spatialReference)});return function(a,c){return b.apply(this,arguments)}}();l.executeQueryForLatestObservations=function(){var b=n._asyncToGenerator(function*(a,c){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new C("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:a,timeInfo:this.timeInfo});try{const d=yield this._executeQuery(a,{},c);yield this._reschedule(()=>this._filterLatest(d),c);return d.createQueryResponse()}catch(d){if(d!==
u.QUERY_ENGINE_EMPTY_RESULT)throw d;return(new t.QueryEngineResult([],a,this)).createQueryResponse()}});return function(a,c){return b.apply(this,arguments)}}();l.executeQueryForSummaryStatistics=function(){var b=n._asyncToGenerator(function*(a={},c,d){const {field:e,normalizationField:g,valueExpression:k}=c;return(yield this._getQueryEngineResultForStats(a,{field:e,normalizationField:g,valueExpression:k},d)).createSummaryStatisticsResponse(c)});return function(){return b.apply(this,arguments)}}();
l.executeQueryForUniqueValues=function(){var b=n._asyncToGenerator(function*(a={},c,d){const {field:e,valueExpression:g}=c;return(yield this._getQueryEngineResultForStats(a,{field:e,valueExpression:g},d)).createUniqueValuesResponse(c)});return function(){return b.apply(this,arguments)}}();l.executeQueryForClassBreaks=function(){var b=n._asyncToGenerator(function*(a={},c,d){const {field:e,normalizationField:g,valueExpression:k}=c;return(yield this._getQueryEngineResultForStats(a,{field:e,normalizationField:g,
valueExpression:k},d)).createClassBreaksResponse(c)});return function(){return b.apply(this,arguments)}}();l.executeQueryForHistogram=function(){var b=n._asyncToGenerator(function*(a={},c,d){const {field:e,normalizationField:g,valueExpression:k}=c;return(yield this._getQueryEngineResultForStats(a,{field:e,normalizationField:g,valueExpression:k},d)).createHistogramResponse(c)});return function(){return b.apply(this,arguments)}}();l._schedule=function(){var b=n._asyncToGenerator(function*(a,c){return p.isSome(this._frameTask)?
this._frameTask.schedule(a,c):a(V.noBudget)});return function(a,c){return b.apply(this,arguments)}}();l._reschedule=function(){var b=n._asyncToGenerator(function*(a,c){return p.isSome(this._frameTask)?this._frameTask.reschedule(a,c):a(V.noBudget)});return function(a,c){return b.apply(this,arguments)}}();l._getAll=function(b){p.isNone(this._allItems)&&(this._allItems=this.featureStore.toArray());return new t.QueryEngineResult(this._allItems,b,this)};l._executeQuery=function(){var b=n._asyncToGenerator(function*(a,
c,d){a=R.clone(a);a=yield this._schedule(()=>u.normalizeQuery(a,this.definitionExpression,this.spatialReference),d);a=yield this._reschedule(()=>this._checkQuerySupport(a),d);a={...a,...c};const e=yield this._reschedule(()=>this._executeSceneFilterQuery(a,d),d),g=yield this._reschedule(()=>this._executeGeometryQuery(a,e,d),d);yield this._reschedule(()=>this._executeAggregateIdsQuery(g),d);yield this._reschedule(()=>this._executeObjectIdsQuery(g),d);yield this._reschedule(()=>this._executeTimeQuery(g),
d);yield this._reschedule(()=>this._executeAttributesQuery(g),d);return g});return function(a,c,d){return b.apply(this,arguments)}}();l._executeSceneFilterQuery=function(){var b=n._asyncToGenerator(function*(a,c){var d=this;if(p.isNone(a.sceneFilter))return null;const {outSR:e,returnGeometry:g,returnCentroid:k}=a;var f=this.featureStore.featureSpatialReference,h=a.sceneFilter.geometry;const q=p.isNone(f)||D.equals(f,h.spatialReference)?h:z.project(h,f);if(!q)return null;f=g||k;f=D.isValid(e)&&!D.equals(this.spatialReference,
e)&&f?function(){var w=n._asyncToGenerator(function*(v){return d._project(v,e)});return function(v){return w.apply(this,arguments)}}():w=>w;const m=this.featureAdapter;h=this._searchFeatures(this._getQueryBBoxes(q));if("disjoint"===a.sceneFilter.spatialRelationship){if(!h.length)return null;const w=new Set;for(var r of h)w.add(m.getObjectId(r));const v=yield this._reschedule(()=>this.featureStore.toArray(),c);r=yield this._reschedule(n._asyncToGenerator(function*(){const I=yield E.getSpatialQueryOperator("esriSpatialRelDisjoint",
q,d.geometryType,d.hasZ,d.hasM),A=yield d._runSpatialFilter(v,F=>!w.has(m.getObjectId(F))||I(m.getGeometry(F)),c);return new t.QueryEngineResult(A,a,d)}),c);return f(r)}if(!h.length)return new t.QueryEngineResult([],a,this);if(this._canExecuteSinglePass(q,a))return f(new t.QueryEngineResult(h,a,this));const L=yield E.getSpatialQueryOperator("esriSpatialRelContains",q,this.geometryType,this.hasZ,this.hasM);r=yield this._runSpatialFilter(h,w=>L(m.getGeometry(w)),c);return f(new t.QueryEngineResult(r,
a,this))});return function(a,c){return b.apply(this,arguments)}}();l._executeGeometryQuery=function(){var b=n._asyncToGenerator(function*(a,c,d){var e=this;if(p.isSome(c)&&0===c.items.length)return c;a=p.isSome(c)?c.query:a;const {geometry:g,outSR:k,spatialRel:f,returnGeometry:h,returnCentroid:q}=a;var m=this.featureStore.featureSpatialReference;const r=!g||p.isNone(m)||D.equals(m,g.spatialReference)?g:z.project(g,m),L=h||q,w=D.isValid(k)&&!D.equals(this.spatialReference,k),v=this._geometryQueryCache&&
p.isNone(c)?w&&L?JSON.stringify({originalFilterGeometry:g,spatialRelationship:f,outSpatialReference:k}):JSON.stringify({originalFilterGeometry:g,spatialRelationship:f}):null;m=v?this._geometryQueryCache.get(v):null;if(p.isSome(m))return new t.QueryEngineResult(m,a,this);m=function(){var G=n._asyncToGenerator(function*(B){w&&L&&(yield e._project(B,k));v&&e._geometryQueryCache.put(v,B.items,B.items.length+1);return B});return function(B){return G.apply(this,arguments)}}();if(!r)return m(p.isSome(c)?
c:this._getAll(a));const I=this.featureAdapter;let A=this._searchFeatures(this._getQueryBBoxes(g));if("esriSpatialRelDisjoint"===f){if(!A.length)return m(p.isSome(c)?c:this._getAll(a));const G=new Set;for(var F of A)G.add(I.getObjectId(F));const B=p.isSome(c)?c.items:yield this._reschedule(()=>this.featureStore.toArray(),d);F=yield this._reschedule(n._asyncToGenerator(function*(){const ha=yield E.getSpatialQueryOperator(f,r,e.geometryType,e.hasZ,e.hasM),ia=yield e._runSpatialFilter(B,W=>!G.has(I.getObjectId(W))||
ha(I.getGeometry(W)),d);return new t.QueryEngineResult(ia,a,e)}),d);return m(F)}if(p.isSome(c)){const G=new Q.PositionHint;A=A.filter(B=>0<=Q.indexOf(c.items,B,c.items.length,G))}if(!A.length)return m=new t.QueryEngineResult([],a,this),v&&this._geometryQueryCache.put(v,m.items,1),m;if(this._canExecuteSinglePass(r,a))return m(new t.QueryEngineResult(A,a,this));const ja=yield E.getSpatialQueryOperator(f,r,this.geometryType,this.hasZ,this.hasM);F=yield this._runSpatialFilter(A,G=>ja(I.getGeometry(G)),
d);return m(new t.QueryEngineResult(F,a,this))});return function(a,c,d){return b.apply(this,arguments)}}();l._executeAggregateIdsQuery=function(b){if(0!==b.items.length&&b.query.aggregateIds&&b.query.aggregateIds.length&&!p.isNone(this.aggregateAdapter)){var a=new Set;for(const d of b.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(d).forEach(e=>a.add(e));var c=this.featureAdapter.getObjectId;b.items=b.items.filter(d=>a.has(c(d)))}};l._executeObjectIdsQuery=function(b){if(0!==b.items.length&&
b.query.objectIds&&b.query.objectIds.length){var a=new Set(b.query.objectIds),c=this.featureAdapter.getObjectId;b.items=b.items.filter(d=>a.has(c(d)))}};l._executeTimeQuery=function(b){if(0!==b.items.length){var a=U.getTimeOperator(this.timeInfo,b.query.timeExtent,this.featureAdapter);p.isNone(a)||(b.items=b.items.filter(a))}};l._executeAttributesQuery=function(b){if(0!==b.items.length){var a=y.getWhereClause(b.query.where,this.fieldsIndex);if(a){if(!a.isStandardized)throw new TypeError("Where clause is not standardized");
b.items=b.items.filter(c=>a.testFeature(c,this.featureAdapter))}}};l._runSpatialFilter=function(){var b=n._asyncToGenerator(function*(a,c,d){var e=this;if(!c)return a;if(p.isNone(this._frameTask))return a.filter(h=>c(h));let g=0;const k=[],f=function(){var h=n._asyncToGenerator(function*(q){for(;g<a.length;){const m=a[g++];c(m)&&(k.push(m),q.madeProgress());q.done&&(yield e._reschedule(r=>f(r),d))}});return function(q){return h.apply(this,arguments)}}();return this._reschedule(h=>f(h),d).then(()=>
k)});return function(a,c,d){return b.apply(this,arguments)}}();l._filterLatest=function(b){const {trackIdField:a,startTimeField:c,endTimeField:d}=this.timeInfo,e=d||c,g=new Map,k=this.featureAdapter.getAttribute;for(const f of b.items){const h=k(f,a),q=k(f,e),m=g.get(h);(!m||q>k(m,e))&&g.set(h,f)}b.items=Array.from(g.values())};l._canExecuteSinglePass=function(b,a){({spatialRel:a}=a);return E.canQueryWithRBush(b)&&("esriSpatialRelEnvelopeIntersects"===a||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===
a||"esriSpatialRelContains"===a||"esriSpatialRelWithin"===a))};l._project=function(){var b=n._asyncToGenerator(function*(a,c){if(!c||D.equals(this.spatialReference,c))return a;const d=this.featureAdapter;c=yield z.projectMany(a.items.map(e=>u.getGeometry(this.geometryType,this.hasZ,this.hasM,d.getGeometry(e))),this.spatialReference,c);a.items=c.map((e,g)=>d.cloneWithGeometry(a.items[g],Y.convertFromGeometry(e,this.hasZ,this.hasM)));return a});return function(a,c){return b.apply(this,arguments)}}();
l._getQueryBBoxes=function(b){if(E.canQueryWithRBush(b)){if(K.isExtent(b))return[O.fromValues(b.xmin,b.ymin,b.xmax,b.ymax)];if(K.isPolygon(b))return b.rings.map(a=>O.fromValues(Math.min(a[0][0],a[2][0]),Math.min(a[0][1],a[2][1]),Math.max(a[0][0],a[2][0]),Math.max(a[0][1],a[2][1])))}return[X.getBoundsXY(O.create(),b)]};l._searchFeatures=function(b){for(const a of b)this.featureStore.forEachInBounds(a,c=>P.add(c));b=Array.from(P.values());P.clear();return b};l._checkStatisticsSupport=function(){var b=
n._asyncToGenerator(function*(a,c){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text||a.outStatistics||a.groupByFieldsForStatistics||a.having||a.orderByFields)throw new C("feature-store:unsupported-query","Unsupported query options",{query:a});this._checkAttributesQuerySupport(a);return Promise.all([this._checkStatisticsParamsSupport(c),E.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),z.checkProjectionSupport(this.spatialReference,
a.outSR)]).then(()=>a)});return function(a,c){return b.apply(this,arguments)}}();l._checkStatisticsParamsSupport=function(){var b=n._asyncToGenerator(function*(a){var c=[];a.valueExpression&&({arcadeUtils:c}=yield ba.loadArcade(),c=c.extractFieldNames(a.valueExpression));a.field&&c.push(a.field);a.normalizationField&&c.push(a.normalizationField);if(!c.length)throw new C("feature-store:unsupported-query","params should have at least a field or valueExpression",{params:a});y.validateFields(this.fieldsIndex,
c,"params contains missing fields")});return function(a){return b.apply(this,arguments)}}();l._checkQuerySupport=function(){var b=n._asyncToGenerator(function*(a){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text)throw new C("feature-store:unsupported-query","Unsupported query options",{query:a});this._checkAttributesQuerySupport(a);this._checkStatisticsQuerySupport(a);return Promise.all([E.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),
z.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)});return function(a){return b.apply(this,arguments)}}();l._checkAttributesQuerySupport=function(b){const {outFields:a,orderByFields:c,returnDistinctValues:d,outStatistics:e}=b,g=e?e.map(k=>k.outStatisticFieldName&&k.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if(c&&0<c.length){const k=c.map(f=>{const h=f.toLowerCase();return h.includes(" asc")?h.split(" asc")[0]:h.includes(" desc")?h.split(" desc")[0]:f}).filter(f=>
!g.includes(f));y.validateFields(this.fieldsIndex,k,"orderByFields contains missing fields")}if(a&&0<a.length)y.validateFields(this.fieldsIndex,a,"outFields contains missing fields");else if(d)throw new C("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:b});y.validateWhere(this.fieldsIndex,b.where)};l._checkStatisticsQuerySupport=function(b){const {outStatistics:a,groupByFieldsForStatistics:c,having:d}=b;var e=c&&c.length,g=a&&a.length;if(d){if(!e||
!g)throw new C("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:b});y.validateHaving(this.fieldsIndex,d,a)}if(g&&ca(a)){g=a.map(k=>k.onStatisticField).filter(Boolean);y.validateFields(this.fieldsIndex,g,"onStatisticFields contains missing fields");e&&y.validateFields(this.fieldsIndex,c,"groupByFieldsForStatistics contains missing fields");for(const k of a){const {onStatisticField:f,statisticType:h}=k;if(("percentile_disc"===h||
"percentile_cont"===h)&&"statisticParameters"in k){if({statisticParameters:e}=k,!e)throw new C("feature-store:unsupported-query","statisticParamters should be set for percentile type",{definition:k,query:b});}else if("count"!==h&&f&&y.hasInvalidFieldType(f,this.fieldsIndex))throw new C("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:k,query:b});}}};l._getQueryEngineResultForStats=function(){var b=n._asyncToGenerator(function*(a,c,d){a=R.clone(a);try{a=yield this._schedule(()=>
u.normalizeQuery(a,this.definitionExpression,this.spatialReference),d);a=yield this._reschedule(()=>this._checkStatisticsSupport(a,c),d);const e=yield this._reschedule(()=>this._executeSceneFilterQuery(a,d),d),g=yield this._reschedule(()=>this._executeGeometryQuery(a,e,d),d);yield this._reschedule(()=>this._executeAggregateIdsQuery(g),d);yield this._reschedule(()=>this._executeObjectIdsQuery(g),d);yield this._reschedule(()=>this._executeTimeQuery(g),d);yield this._reschedule(()=>this._executeAttributesQuery(g),
d);return g}catch(e){if(e!==u.QUERY_ENGINE_EMPTY_RESULT)throw e;return new t.QueryEngineResult([],a,this)}});return function(a,c,d){return b.apply(this,arguments)}}();n._createClass(H,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){const b=this.featureStore.fullBounds;return p.isNone(b)?null:{xmin:b[0],ymin:b[1],xmax:b[2],ymax:b[3],spatialReference:u.cleanFromGeometryEngine(this.spatialReference)}}},{key:"timeExtent",get:function(){if(!this.timeInfo)return null;
this._timeExtent||(this._timeExtent=U.getTimeExtent(this.timeInfo,this.featureStore));return this._timeExtent}}]);return H}();const fa=J.create(),x=J.create(),P=new Set;M.Feature=function(H,l=null,b,a,c){this.attributes=H;this.geometry=b;this.centroid=a;this.filterFlags=c;this.groupId=-1;this.displayId=l};M.QueryEngine=ka;Object.defineProperties(M,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});