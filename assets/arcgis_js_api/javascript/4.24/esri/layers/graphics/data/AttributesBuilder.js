// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define(["../../../core/maybe","./attributeSupport","../../../statistics/utils"],function(l,h,m){return function(){function k(b,a,c){this._fieldDataCache=new Map;this._returnDistinctMap=new Map;this.returnDistinctValues=b.returnDistinctValues;this.fieldsIndex=c;this.featureAdapter=a;if((a=b.outFields)&&!a.includes("*")){this.outFields=a;b=0;for(const e of a){var d=h.getExpressionFromFieldName(e);d=(a=this.fieldsIndex.get(d))?null:h.getWhereClause(d,c);a=a?a.name:h.getAliasFromFieldName(e)||`FIELD_EXP_${b++}`;
this._fieldDataCache.set(e,{alias:a,clause:d})}}}var f=k.prototype;f.countDistinctValues=function(b){if(!this.returnDistinctValues)return b.length;b.forEach(a=>this.getAttributes(a));return this._returnDistinctMap.size};f.getAttributes=function(b){b=this._processAttributesForOutFields(b);return this._processAttributesForDistinctValues(b)};f.getFieldValue=function(b,a,c){const d=c?c.name:a;let e=null;this._fieldDataCache.has(d)?e=this._fieldDataCache.get(d).clause:c||(e=h.getWhereClause(a,this.fieldsIndex),
this._fieldDataCache.set(d,{alias:d,clause:e}));return c?this.featureAdapter.getAttribute(b,d):e.calculateValue(b,this.featureAdapter)};f.getNormalizedValue=function(b,a){const c=a.normalizationType,d=a.normalizationTotal;let e=this.getFieldValue(b,a.field,a.fieldInfo);c&&Number.isFinite(e)&&(b=this.getFieldValue(b,a.normalizationField,a.normalizationFieldInfo),e=m.getNormalizedValue(e,c,b,d));return e};f.getExpressionValue=function(b,a,c,d){b={attributes:this.featureAdapter.getAttributes(b),layer:{fields:this.fieldsIndex.fields}};
c=d.createExecContext(b,c);return d.executeFunction(a,c)};f.getExpressionValues=function(b,a,c,d){const e={fields:this.fieldsIndex.fields};return b.map(g=>{g={attributes:this.featureAdapter.getAttributes(g),layer:e};g=d.createExecContext(g,c);return d.executeFunction(a,g)})};f.validateItem=function(b,a){this._fieldDataCache.has(a)||this._fieldDataCache.set(a,{alias:a,clause:h.getWhereClause(a,this.fieldsIndex)});return this._fieldDataCache.get(a).clause.testFeature(b,this.featureAdapter)};f.validateItems=
function(b,a){this._fieldDataCache.has(a)||this._fieldDataCache.set(a,{alias:a,clause:h.getWhereClause(a,this.fieldsIndex)});return this._fieldDataCache.get(a).clause.testSet(b,this.featureAdapter)};f._processAttributesForOutFields=function(b){const a=this.outFields;if(!a||!a.length)return this.featureAdapter.getAttributes(b);const c={};for(const d of a){const {alias:e,clause:g}=this._fieldDataCache.get(d);c[e]=g?g.calculateValue(b,this.featureAdapter):this.featureAdapter.getAttribute(b,e)}return c};
f._processAttributesForDistinctValues=function(b){if(l.isNone(b)||!this.returnDistinctValues)return b;var a=this.outFields,c=[];if(a)for(const e of a){var {alias:d}=this._fieldDataCache.get(e);c.push(b[d])}else for(d in b)c.push(b[d]);a=`${(a||["*"]).join(",")}=${c.join(",")}`;c=this._returnDistinctMap.get(a)||0;this._returnDistinctMap.set(a,++c);return 1<c?null:b};return k}()});