// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Evented ../../core/HandleOwner ../../core/handleUtils ../../core/Logger ../../core/maybe ../../core/Promise ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../form/FormTemplate ../../layers/support/ContingentValue ../../layers/support/LayerContingentValuesCache ../../support/arcadeOnDemand ./InputField ./InputFieldGroup ../../intl/locale ../../intl/messages".split(" "),
function(x,t,p,V,I,J,D,K,r,L,w,u,W,X,Y,M,N,E,O,P,F,Q,R,S){const C=new p({attributes:{}}),G=K.getLogger("esri.widgets.FeatureForm.FeatureFormViewModel"),T=["editable","required","value","visibility"];p=function(H){function y(a){a=H.call(this,a)||this;a._arcade=null;a._compiledExpressionLookup=new Map;a._expressionLookup=new Map;a._expressionInvalidationCallbacks=new Set;a._contingentValuesCache=null;a._featureClone=C.clone();a._initialFeature=C.clone();a._arcadeGeometryOperationsEnabled=!1;a._inputFieldCache=
[];a.contingencyConstraintViolations=new Map;a.messages=null;a.strict=!1;return a}x._inheritsLoose(y,H);var m=y.prototype;m.initialize=function(){var a=this;const b=function(){var d=x._asyncToGenerator(function*(){return a.messages=yield S.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")});return function(){return d.apply(this,arguments)}}();b();const e=w.watch(()=>this.layer,d=>{"feature"===(null==d?void 0:d.type)&&this.addResolvingPromise(O.createLoadedLayerContingentValuesCache(d).then(g=>
{this._contingentValuesCache=g;this.notifyChange("fieldsWithContingentValues")}))},{initial:!0}),c=w.watch(()=>{var d;return null==(d=this.feature)?void 0:d.geometry},d=>{this._featureClone.geometry=d;for(const g of this._expressionInvalidationCallbacks)g()});this.handles.add([R.onLocaleChange(b),e,c])};m.destroy=function(){this.layer=this.feature=null;this._contingentValuesCache=r.destroyMaybe(this._contingentValuesCache)};m.findField=function(a){return this.allInputFields.find(b=>b.name===a)};m.getValue=
function(a){var b;const {_featureClone:e,layer:c}=this,d=!(null==c||!c.getField(a));return null!=(b=e.getAttribute(a))?b:d?null:void 0};m.setValue=function(a,b){const {_featureClone:e,strict:c}=this,d=this.findField(a);b=""===b?null:b;d&&e.getAttribute(a)!==b&&(d.value=b,c&&!d.valid||this._afterValueChange(d))};m.getValues=function(){return{...this._featureClone.attributes}};m.submit=function(){var a=this.allInputFields;const b=new Set(a.filter(c=>c.valid).map(({name:c})=>c));a=a.filter(c=>!c.valid).map(({name:c})=>
c);const e=this.getValues();if(0<this.validateContingencyConstraints(e,{includeIncompleteViolations:!0}).length)for(const [c,d]of this.contingencyConstraintViolations.entries())"error"===d.type&&(b.delete(c),a.push(c));this.emit("submit",{valid:[...b],invalid:a,values:e})};m.validateContingencyConstraints=function(a,b){const {_contingentValuesCache:e}=this,c=new Map;this.contingencyConstraintViolations=c;if(r.isNone(e))return[];const {invalid:d,incomplete:g}=e.validateContingencyConstraints(a);a=
[...d,...null!=b&&b.includeIncompleteViolations?g:[]];for(const f of a)for(const h of f.fieldGroup.fields)c.set(h,f);return a};m._emitChangeEvent=function({name:a,valid:b,value:e}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:a,value:e,valid:b})};m._updateInputFieldsFromElements=function(a,b,e){const c=new Map;for(const f of a)if(f.inputFields){a=c;var d=f.groupElement,g=f;r.isSome(d)&&a.set(d,g);for(const h of f.inputFields)a=c,d=h.fieldElement,g=h,r.isSome(d)&&a.set(d,
g)}else a=c,d=f.fieldElement,g=f,r.isSome(d)&&a.set(d,g);b=this._updateInputFieldsRecursive(c,b.filter(this._isSupportedElement),e);for(const [f,h]of c.entries())c.delete(f),h.destroy();return b};m._updateInputFieldsRecursive=function(a,b,e,c=null){const d=[];for(const f of b){var g=a.has(f);b=g?a.get(f):"group"===f.type?this._makeInputFieldGroupFromGroupElement(f,e):this._makeInputFieldFromFieldElement(f,e,c);d.push(b);if(g)if(a.delete(f),b.inputFields){const {arcade:h,feature:k,expressionTrackingProvider:n,
spatialReference:l}=e;b.set({arcade:h,feature:k,expressionTrackingProvider:n,spatialReference:l})}else b.set(e);"group"===f.type&&(g=f.elements.filter(h=>this._isSupportedElement(h)),b.inputFields=this._updateInputFieldsRecursive(a,g,e,b))}return d};m._updateInputFieldsFromLayerFields=function(a,b,e){if(!Array.isArray(b))return G.warn("esri.widgets.FeatureForm.FeatureFormViewModel","No attribute fields found."),[];const c=new Map;for(const l of a)if(l.inputFields){for(const q of l.inputFields)q.destroy();
l.inputFields.length=0;l.destroy()}else c.set(l.field,l);a=[];const {feature:d,initialFeature:g,layer:f,messages:h,spatialReference:k}=e;for(const l of b){var n;b=null!=(n=c.get(l))?n:new F({field:l,feature:d,initialFeature:g,layer:f,messages:h,spatialReference:k,value:d.getAttribute(l.name)});b.set({fieldElement:null,requiredFunction:null,visibilityFunction:null,valueFunction:null,editableFunction:null});a.push(b);c.delete(l)}for(const [l,q]of c.entries())c.delete(l),q.destroy();return a};m._makeInputFieldFromFieldElement=
function(a,b,e=null){var c=this;const {arcade:d,expressionTrackingProvider:g,feature:f,initialFeature:h,layer:k,messages:n,spatialReference:l}=b,q=new F({fieldElement:a,field:this._layerFieldsByName.get(a.fieldName),requiredFunction:this._getCompiledExpression(a.requiredExpression),visibilityFunction:this._getCompiledExpression(a.visibilityExpression),valueFunction:this._getCompiledExpression(a.valueExpression),editableFunction:this._getCompiledExpression(a.editableExpression),group:e,arcade:d,expressionTrackingProvider:g,
feature:f,initialFeature:h,layer:k,messages:n,spatialReference:l,value:f.getAttribute(a.fieldName)}),v=`watch-expression-field-${q.id}`;a=w.watch(()=>q.fieldElement,z=>{this.handles.remove(v);r.isSome(z)&&this.handles.add(T.map(A=>w.watch(()=>z[`${A}Expression`],function(){var U=x._asyncToGenerator(function*(B){B&&""!==B&&(q[`${A}Function`]=yield c._getOrMakeCompiledExpression(B),q.arcade=c._arcade)});return function(B){return U.apply(this,arguments)}}(),{initial:!0,sync:!0})),v)},{initial:!0,sync:!0});
b=D.makeHandle(()=>this.handles.remove(v));e=w.watch(()=>q.value,()=>this._afterValueChange(q));q.own([a,b,e]);return q};m._makeInputFieldGroupFromGroupElement=function(a,b){var e=this;const {arcade:c,feature:d,expressionTrackingProvider:g,spatialReference:f}=b,h=new Q({groupElement:a,visibilityFunction:this._getCompiledExpression(a.visibilityExpression),inputFields:[],arcade:c,feature:d,expressionTrackingProvider:g,spatialReference:f});h.own(w.watch(()=>h.groupElement,k=>r.isSome(k)&&k.own(w.watch(()=>
k.visibilityExpression,function(){var n=x._asyncToGenerator(function*(l){l&&""!==l&&(h.visibilityFunction=yield e._getOrMakeCompiledExpression(l),h.arcade=e._arcade)});return function(l){return n.apply(this,arguments)}}(),{initial:!0})),{initial:!0}));return h};m._clearInputFieldCache=function(){for(const a of this._inputFieldCache){if(a.inputFields)for(const b of a.inputFields)b.destroy();a.destroy()}this._inputFieldCache=[]};m._afterValueChange=function(a){const {name:b,value:e}=a;if(this.get("layer.typeIdField")===
b&&"types"in this.layer){const c=new Set;this.layer.types.forEach(d=>Object.keys(d.domains).forEach(g=>c.add(g)));c.forEach(d=>{(d=this.findField(d))&&d.notifyChange("domain")})}this._featureClone.setAttribute(b,e);for(const c of this._expressionInvalidationCallbacks)c();this._emitChangeEvent(a)};m._registerExpression=function(a){const {_expressionInvalidationCallbacks:b}=this;b.add(a);return D.makeHandle(()=>b.delete(a))};m._getCompiledExpression=function(a){return this._compiledExpressionLookup.get(this._expressionLookup.get(a))};
m._getOrMakeCompiledExpression=function(){var a=x._asyncToGenerator(function*(b){var e;if(r.isNone(b)||""===b)return null;b=null!=(e=this._expressionLookup.get(b))?e:this._addToExpressionLookup(b);if(this._compiledExpressionLookup.has(b))return this._compiledExpressionLookup.get(b);this._arcade||(this._arcade=yield P.loadArcade());e=this._arcade.arcadeUtils;!this._arcadeGeometryOperationsEnabled&&e.hasGeometryOperations(b)&&(yield e.enableGeometryOperations(),this._arcadeGeometryOperationsEnabled=
!0);return this._addToCompiledExpressionLookup(b)});return function(b){return a.apply(this,arguments)}}();m._addToCompiledExpressionLookup=function(a){const {_arcade:{arcadeUtils:b},_compiledExpressionLookup:e}=this,c=b.createFunction(a);e.set(a,c);return c};m._addToExpressionLookup=function(a){var b;const {_expressionLookup:e,formTemplate:c}=this;var d=r.isSome(c)&&r.isSome(c.expressionInfos)?Object.values(c.expressionInfos).find(g=>g.name===a):null;d=null!=(b=null==d?void 0:d.expression)?b:a;e.set(a,
d);a!==d&&e.set(d,d);return d};m._isSupportedElement=function(a){if("field"===a.type||"group"===a.type)return!0;G.warn("form-info::unsupported-element-type","Only element types 'field' and 'group' are supported",`Element ${a.label} has unsupported type '${a.type}'`);return!1};m._joinContingentValues=function(){var a=this._contingentValuesCache;if(r.isNone(a))return[];var b="typeIdField"in this.layer?this.layer.typeIdField:null;b=b?this.getValue(b):null;const e=[];for(var c of a.fieldGroups){const {contingencies:h,
fields:k,name:n}=c;a=[];for(var d of h)d.isRetired||r.isSome(d.subtype)&&d.subtype.code!==b||a.push({values:d.values});0<a.length&&e.push({name:n,fields:k,contingencies:a})}const [g,f]=this._generateJoinPlan(e);c=g.flatMap(h=>this._joinFieldGroupContingencies(h));d=f.flatMap(h=>h.contingencies);return[...c,...d]};m._generateJoinPlan=function(a){var b=new Map,e=[],c=new Set;for(var d of a)for(const k of d.fields)if(b.has(k)){const n=b.get(k),l=d,q=[n.name,l.name].sort().join("|");c.has(q)||(e.push([n,
l]),c.add(q),b.set(k,l))}else b.set(k,d);b=new Set(e.flat());a=new Set(a);for(var g of b)a.delete(g);g=new Map;b=new Map;for(var f of new Set(e.flat()))c=Symbol(f.name),g.set(c,new Set([f])),b.set(f,c);for(const [k,n]of e)if(e=b.get(k),f=b.get(n),e!==f){c=g.get(e);d=g.get(f);for(var h of d)c.add(h),b.set(h,e);g.delete(f)}h=[...g.values()].map(k=>[...k]);e=[...a];return[h,e]};m._joinFieldGroupContingencies=function(a){const b=a.slice();var e=b.shift(),c=b.shift();a=this._generateJoinKey(e.fields,c.fields);
let d=new Set([...e.fields,...c.fields]),g=new Map;for(var f of e.contingencies)[e]=this._hashContingency(f,a.codedValueFields,!0),g.has(e)?g.get(e).push(f):g.set(e,[f]);for(;0<b.length;){f=new Map;e=b.shift();const n=this._generateJoinKey(d,e.fields);for(var h of c.contingencies){const [l,q]=this._hashContingency(h,a.codedValueFields);c=q?this._findMatchingContingenciesWithAnyHashMask(g,l):g.get(l);g.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&c.push(...this._findMatchingContingenciesContainingAny(h,
g.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),a.codedValueFields));if(!r.isNone(c))for(var k of c){c=0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(k,h,a.rangeFields):this._joinContingencies(k,h);if(r.isNone(c))break;const [v]=this._hashContingency(c,n.codedValueFields,!0);f.has(v)?f.get(v).push(c):f.set(v,[c])}}g=f;c=e;a=n;d=new Set([...d,...c.fields])}h=[];for(const n of c.contingencies){const [l,q]=this._hashContingency(n,a.codedValueFields);k=q?this._findMatchingContingenciesWithAnyHashMask(g,
l):g.get(l);g.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&k.push(...this._findMatchingContingenciesContainingAny(n,g.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),a.codedValueFields));if(!r.isNone(k))for(const v of k)k=0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(v,n,a.rangeFields):this._joinContingencies(v,n),r.isSome(k)&&h.push(k)}return h};m._joinContingencies=function(a,b){b={values:{...a.values,...b.values}};for(const [e,c]of Object.entries(b.values))"any"===c.objectType&&r.isSome(a.values[e])&&
(b.values[e]=a.values[e]);return b};m._joinContingenciesWithRangeDomains=function(a,b,e){const c=this._joinContingencies(a,b);for(const g of e){var d=a.values[g];const f=b.values[g],{leftIsNull:h,rightIsNull:k,bothAreNull:n,leftIsAny:l,rightIsAny:q,bothAreAny:v,leftIsRange:z,rightIsRange:A}=this._compareObjectTypes(d.objectType,f.objectType);if(!n&&!v)if(h&&q||k&&l)c.values[g]=new E({objectType:"null"});else{if(h&&A||k&&z)return null;l?(d.minValue=-Infinity,d.maxValue=Infinity):q&&(f.minValue=-Infinity,
f.maxValue=Infinity);e=Math.max(d.minValue,f.minValue);d=Math.min(d.maxValue,f.maxValue);if(e>d)return null;c.values[g]=new E({objectType:"range",minValue:e,maxValue:d})}}return c};m._findMatchingContingenciesContainingAny=function(a,b,e){return b.filter(c=>e.every(d=>{var g,f;const h=c.values[d];d=a.values[d];return"any"===h.objectType||"any"===d.objectType||(null==(g=h.codedValue)?void 0:g.code)===(null==(f=d.codedValue)?void 0:f.code)}))};m._findMatchingContingenciesWithAnyHashMask=function(a,
b){b=RegExp(`${b}$`);const e=[];for(const [c,d]of a){if("#JSAPI_CONTINGENT_VALUE_ANY_HASH"===c)break;b.test(c)&&e.push(...d)}return e};m._generateJoinKey=function(a,b){a=Array.isArray(a)?new Set(a):a;var e=Array.isArray(b)?new Set(b):b;b=a.size<e.size?a:e;a=b===a?e:a;e=new Set;const c=new Set;for(const d of b)if(a.has(d)&&(b=this.layer.getFieldDomain(d,{feature:this.feature}),!r.isNone(b)))switch(b.type){case "coded-value":e.add(d);break;case "range":c.add(d)}return{codedValueFields:[...e],rangeFields:[...c]}};
m._hashContingency=function(a,b,e=!1){if(1>b.length)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",!1];const c=[];let d=!1;for(const f of b)if(b=a.values[f],"any"===b.objectType){if(e)return["#JSAPI_CONTINGENT_VALUE_ANY_HASH",!0];d=!0;c.push(`${f}:.*`)}else if("null"===b.objectType)c.push(`${f}:${"#JSAPI_CONTINGENT_VALUE_NULL_HASH"}`);else{var g;c.push(`${f}:${null==(g=b.codedValue)?void 0:g.code}`)}return[c.sort().join("\x26"),d]};m._compareObjectTypes=function(a,b){return{leftIsNull:"null"===a,rightIsNull:"null"===
b,bothAreNull:"null"===a&&"null"===b,leftIsAny:"any"===a,rightIsAny:"any"===b,bothAreAny:"any"===a&&"any"===b,leftIsRange:"range"===a,rightIsRange:"range"===b}};x._createClass(y,[{key:"allInputFields",get:function(){return this.inputFields.reduce((a,b)=>b.inputFields?[...a,...b.inputFields]:[...a,b],[])}},{key:"_layerFieldsByName",get:function(){return new Map(this.layer.fields.map(a=>[a.name,a]))}},{key:"feature",get:function(){return this._get("feature")},set:function(a){this._featureClone=a?a.clone():
C.clone();this._initialFeature=this._featureClone.clone();this.contingencyConstraintViolations.clear();this._clearInputFieldCache();this._set("feature",a)}},{key:"fieldsWithContingentValues",get:function(){if(r.isNone(this._contingentValuesCache))return new Set;const a=this._contingentValuesCache.fieldGroups.flatMap(b=>b.fields);return new Set(a)}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(a){null!=a?this._override("formTemplate",
a):this._clearOverride("formTemplate")}},{key:"inputFields",get:function(){const {_arcade:a,_featureClone:b,_initialFeature:e,_inputFieldCache:c,formTemplate:d,messages:g,layer:f,state:h,spatialReference:k}=this;if("ready"!==h)return[];var n={arcade:a,feature:b,initialFeature:e,layer:f,messages:g,expressionTrackingProvider:{registerExpression:this._registerExpression.bind(this)},spatialReference:k};return this._inputFieldCache=n=r.isSome(d)&&0<d.elements.length?this._updateInputFieldsFromElements(c,
d.elements,n):this._updateInputFieldsFromLayerFields(c,null==f?void 0:f.fields,n)}},{key:"joinedContingentValues",get:function(){return this._joinContingentValues()}},{key:"layer",get:function(){var a;return null!=(a=this.feature)&&a.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(a){a?this._override("layer",a):this._clearOverride("layer")}},{key:"spatialReference",get:function(){var a;return(null==(a=this.layer)?void 0:a.spatialReference)||null},set:function(a){void 0===
a?this._clearOverride("spatialReference"):this._override("spatialReference",a)}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"submittable",get:function(){return this.valid?!0:this.allInputFields.filter(a=>!a.valid).every(({submittable:a})=>a)}},{key:"valid",get:function(){const a=this.allInputFields;return 0<a.length&&a.every(({valid:b})=>b)}}]);return y}(J.HandleOwnerMixin(L.EsriPromiseMixin(I.EventedAccessor)));t.__decorate([u.property({readOnly:!0})],
p.prototype,"allInputFields",null);t.__decorate([u.property()],p.prototype,"_layerFieldsByName",null);t.__decorate([u.property()],p.prototype,"_inputFieldCache",void 0);t.__decorate([u.property()],p.prototype,"contingencyConstraintViolations",void 0);t.__decorate([u.property()],p.prototype,"feature",null);t.__decorate([u.property()],p.prototype,"fieldsWithContingentValues",null);t.__decorate([u.property({type:N})],p.prototype,"formTemplate",null);t.__decorate([u.property({readOnly:!0})],p.prototype,
"inputFields",null);t.__decorate([u.property()],p.prototype,"joinedContingentValues",null);t.__decorate([u.property()],p.prototype,"layer",null);t.__decorate([u.property()],p.prototype,"messages",void 0);t.__decorate([u.property()],p.prototype,"spatialReference",null);t.__decorate([u.property()],p.prototype,"state",null);t.__decorate([u.property()],p.prototype,"strict",void 0);t.__decorate([u.property()],p.prototype,"submittable",null);t.__decorate([u.property()],p.prototype,"valid",null);t.__decorate([u.property()],
p.prototype,"getValues",null);t.__decorate([u.property()],p.prototype,"submit",null);return p=t.__decorate([M.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],p)});