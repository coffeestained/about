// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/Logger ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/set ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./Edits ./UpdateWorkflowData ./Workflow ./workflowUtils".split(" "),function(k,J,B,C,x,D,y,P,Q,R,S,K,L,M,N,O,r){var z;y=z=function(E){function v(c){c=
E.call(this,c)||this;c.type="update";return c}k._inheritsLoose(v,E);v.create=function(c,q,a){c=new z({data:new N({edits:new M.Edits,viewModel:c}),onCommit:function(){var h=k._asyncToGenerator(function*(t){const d=t.edits.feature,g=d.sourceLayer,b=d.clone();if(!t.edits.attributesModified){const {objectIdField:e}=g;b.attributes={[e]:d.getAttribute(e)}}t.edits.geometryModified||(b.geometry=null);yield a(g,{updateFeatures:[b]})});return function(t){return h.apply(this,arguments)}}()});c._set("steps",
this._createWorkflowSteps(c,q));return c};var F=v.prototype;F.highlight=function(c){var {data:{viewModel:{view:q}}}=this;q=c&&q.allLayerViews.items.find(({layer:a})=>a===c.layer);L.highlightsSupported(q)&&this.handles.add(q.highlight(c),"candidate-highlight")};F.unhighlight=function(){this.handles.remove("candidate-highlight")};v._createWorkflowSteps=function(c,q="awaiting-feature-to-update"){const {data:a,handles:h}=c,t=new Map;return r.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate",
"editing-existing-feature","adding-attachment","editing-attachment"],q,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){var d=this;return k._asyncToGenerator(function*(){const {spinnerViewModel:g,view:b}=a.viewModel;let e=null;h.add({remove(){e&&(e.abort(),e=null)}},d.id);a.edits.feature=null;const n=b.on("immediate-click",p=>{g.location=p.mapPoint;g.visible=!0;e&&e.abort();const {editableItems:l}=a.viewModel;e=new AbortController;(new Promise((u,m)=>{x.onAbort(e.signal,
()=>m(x.createAbortError()));u(r.fetchCandidates(l,b,p,e.signal))})).then(u=>{x.throwIfAborted(e);a.candidates=u.reduce((m,f)=>f.error?m:[...m,...f.value],[]);a.viewModel.spinnerViewModel.visible=1===a.candidates.length;0!==a.candidates.length&&(1===a.candidates.length?(a.edits.feature=a.candidates[0],a.viewModel.activeWorkflow.go("editing-existing-feature").catch(()=>{}).then(()=>a.viewModel.spinnerViewModel.visible=!1)):a.viewModel.activeWorkflow.next())})});b.focus();h.add(n,d.id)})()},tearDown(){var d=
this;return k._asyncToGenerator(function*(){h.remove(d.id)})()}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){var d=this;return k._asyncToGenerator(function*(){const {edits:g}=a;g.feature=null;h.add(D.watch(()=>g.feature,b=>{c.unhighlight();c.highlight(b)}),d.id)})()},tearDown(){var d=this;return k._asyncToGenerator(function*(){c.unhighlight();h.remove(d.id)})()}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){var d=this;return k._asyncToGenerator(function*(){if(!h.has("editing-existing-feature")){var g=
a.edits.feature,b=a.viewModel;a.editableItem=b.editableItems.find(f=>f.layer===g.layer);var e=new AbortController;h.add({remove:()=>e.abort()},d.id);var n=b.view.whenLayerView(g.layer),p=r.fetchFullFeature(g,b.view,e.signal);n=yield n;var l=yield p;if(!x.isAborted(e)){a.edits.updateGeometry(l.geometry);a.edits.updateAttributes(l.attributes);a.edits.trackChanges();b.attachmentsViewModel.set({graphic:l,mode:"view"});p=l.sourceLayer;var u=r.findLayerInfo(b.layerInfos,p);b.featureFormViewModel.set({feature:l,
formTemplate:null==u?void 0:u.formTemplate,spatialReference:b.view.spatialReference});var m="createInteractiveEditSession"in n?n.createInteractiveEditSession(g):null;n=[b.featureFormViewModel.on("value-change",f=>{a.edits.updateAttributes(b.featureFormViewModel.getValues());l.attributes=a.edits.feature.attributes;m&&m.setAttribute(f.fieldName,f.value)}),D.watch(()=>b.attachmentsViewModel.mode,f=>{"add"===f&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===f&&a.viewModel.activeWorkflow.go("editing-attachment")})];
m&&(n.push(B.makeHandle(()=>m.rollback())),h.add(B.makeHandle(()=>m.commit()),c._handleKeys.afterCommit));({supportsGeometryUpdate:p}=p.capabilities.editing);if(p){b.sketchViewModel.allowDeleteKey=!1;const f=r.getVisualVariableAttributes(l),{interactive:G,visual:H}=yield r.setUpGeometryUpdate(l,f,b.sketchViewModel,b.view,({geometry:I,attributes:A})=>{if(C.isSome(f.rotation)){var {field:w}=f.rotation;b.featureFormViewModel.setValue(w,A[w])}C.isSome(f.size)&&({field:w}=f.size,b.featureFormViewModel.setValue(w,
A[w]));a.edits.updateAttributes(A);a.edits.updateGeometry(I);b.featureFormViewModel.feature.geometry=I},t);n.push(G,H);h.add(G,c._handleKeys.beforeCommit);h.add(H,c._handleKeys.afterCommit)}else c.highlight(l);h.add(n,d.id)}}})()},tearDown({cancelled:d}){var g=this;return k._asyncToGenerator(function*(){d&&(c.unhighlight(),h.remove(g.id))})()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp(){return k._asyncToGenerator(function*(){})()},tearDown(){return k._asyncToGenerator(function*(){a.viewModel.attachmentsViewModel.mode=
"view"})()}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",setUp(){return k._asyncToGenerator(function*(){})()},tearDown(){return k._asyncToGenerator(function*(){a.viewModel.attachmentsViewModel.mode="view"})()}})})};return v}(O);return y=z=J.__decorate([K.subclass("esri.widgets.Editor.UpdateWorkflow")],y)});