// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/aliasOf ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../views/interactive/sketch/SketchLabelOptions ../../views/interactive/sketch/SketchTooltipOptions ../../views/interactive/snapping/SnappingOptions ../Attachments/AttachmentsViewModel ./CreateFeaturesWorkflow ./CreateWorkflow ./deprecationUtils ./UpdateWorkflow ../FeatureForm/FeatureFormViewModel ../FeatureTemplates/FeatureTemplatesViewModel ../Sketch/SketchViewModel ../Spinner/SpinnerViewModel".split(" "),
function(k,g,D,z,e,E,F,r,w,V,W,X,l,G,H,I,J,K,L,M,N,x,O,P,Q,R,S){function m(p,n,d){t.error(new z(p,n,d))}function T(p,n){return p&&p.find(d=>d.layer===n)}const t=F.getLogger("esri.widgets.Editor.EditorViewModel"),A=["create","create-features","update"];e=function(p){function n(a){a=p.call(this,a)||this;a._sketchGraphicsLayer=new H({listMode:"hide",internal:!0});a.activeWorkflow=null;a.activityQueue=[];a.failures=[];a.attachmentsViewModel=new L({abilities:{editing:!0}});a.featureFormViewModel=new P;
a.featureTemplatesViewModel=new Q;a.labelOptions=new I;a.layerInfos=null;a.sketchViewModel=new R({layer:a._sketchGraphicsLayer});a.snappingOptions=new K;a.spinnerViewModel=new S;a.tooltipOptions=new J;return a}k._inheritsLoose(n,p);var d=n.prototype;d.initialize=function(){this.handles.add([r.on(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),r.on(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),r.when(()=>{var a;return null==(a=this.view)?void 0:a.map},a=>{a.add(this._sketchGraphicsLayer)},
r.initial),r.watch(()=>this.editableItems.toArray(),()=>{const {activeWorkflow:a}=this;this.refreshCreationTemplates();if(a){var {stepId:b}=a;"create"===a.type?"awaiting-feature-creation-info"!==b||this.canCreate||this._cancelWorkflow():"update"===a.type&&("awaiting-feature-to-update"===b&&!this.canUpdate||"awaiting-update-feature-candidate"===b&&!a.data.candidates.some(c=>{const h=this.editableItems.find(q=>q.layer===c.layer);return h&&h.supports.includes("update")}))&&this._cancelWorkflow()}})])};
d.destroy=function(){this._cancelWorkflow().then(()=>{var a;null!=(a=this.view)&&a.map&&this.view.map.remove(this._sketchGraphicsLayer);this.view=null})};d.startCreateWorkflowAtFeatureTypeSelection=function(){var a=k._asyncToGenerator(function*(){x.workflowDeprecation(t,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection");if(this.canCreate){yield this._cancelWorkflow();var b=this._createCreateWorkflow();yield b.start();this._set("activeWorkflow",b)}else m("editing:unsupported-workflow",
"Create workflow is unsupported or disabled.")});return function(){return a.apply(this,arguments)}}();d.startCreateFeaturesWorkflowAtFeatureTypeSelection=function(){var a=k._asyncToGenerator(function*(){return this.startCreateFeaturesWorkflow()});return function(){return a.apply(this,arguments)}}();d.startCreateWorkflowAtFeatureCreation=function(){var a=k._asyncToGenerator(function*(b){x.workflowDeprecation(t,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation");if(this.canCreate){yield this._cancelWorkflow();
var c=this._createCreateWorkflow("awaiting-feature-to-create");c.data.creationInfo=b;yield c.start();this._set("activeWorkflow",c)}else m("editing:unsupported-workflow","Create workflow is unsupported or disabled.")});return function(b){return a.apply(this,arguments)}}();d.startCreateFeaturesWorkflowAtFeatureCreation=function(){var a=k._asyncToGenerator(function*(b){return this.startCreateFeaturesWorkflow(b,"creating-features")});return function(b){return a.apply(this,arguments)}}();d.startCreateFeaturesWorkflow=
function(){var a=k._asyncToGenerator(function*(b,c="awaiting-feature-creation-info"){if(!this.canCreate)throw new z("editing:unsupported-workflow","Creating features is unsupported or disabled.");yield this._cancelWorkflow();b=this._createCreateFeaturesWorkflow(b,c);yield b.start();this._set("activeWorkflow",b)});return function(b){return a.apply(this,arguments)}}();d.startCreateWorkflowAtFeatureEdit=function(){var a=k._asyncToGenerator(function*(b){x.workflowDeprecation(t,"startCreateWorkflowAtFeatureEdit");
if(this.canCreate){yield this._cancelWorkflow();var c=this._createCreateWorkflow("editing-new-feature");c.data.edits.feature=b;yield c.start();this._set("activeWorkflow",c)}else m("editing:unsupported-workflow","Create workflow is unsupported or disabled.")});return function(b){return a.apply(this,arguments)}}();d.startUpdateWorkflowAtFeatureSelection=function(){var a=k._asyncToGenerator(function*(){if(this.canUpdate){yield this._cancelWorkflow();var b=this._createUpdateWorkflow();yield b.start();
this._set("activeWorkflow",b)}else m("editing:unsupported-workflow","Update workflow is unsupported or disabled.")});return function(){return a.apply(this,arguments)}}();d.startUpdateWorkflowAtMultipleFeatureSelection=function(){var a=k._asyncToGenerator(function*(b){if(this.canUpdate){yield this._cancelWorkflow();var c=this._createUpdateWorkflow("awaiting-update-feature-candidate");c.data.candidates=b;yield c.start();this._set("activeWorkflow",c)}else m("editing:unsupported-workflow","Update workflow is unsupported or disabled.")});
return function(b){return a.apply(this,arguments)}}();d.startUpdateWorkflowAtFeatureEdit=function(){var a=k._asyncToGenerator(function*(b){if(this.canUpdate){yield this._cancelWorkflow();var c=this._createUpdateWorkflow("editing-existing-feature");c.data.edits.feature=b;yield c.start();this._set("activeWorkflow",c)}else m("editing:unsupported-workflow","Update workflow is unsupported or disabled.")});return function(b){return a.apply(this,arguments)}}();d.deleteFeatureFromWorkflow=function(){var a=
k._asyncToGenerator(function*(){const {activeWorkflow:b}=this;b&&"update"===b.type?(yield this._delete(b.data.edits.feature),yield b.reset()):m("editing:unsupported-workflow","Deleting requires an active update workflow.")});return function(){return a.apply(this,arguments)}}();d.cancelWorkflow=function(){var a=k._asyncToGenerator(function*(b){return this._cancelWorkflow({warn:!0,...b})});return function(b){return a.apply(this,arguments)}}();d.refreshCreationTemplates=function(){const a=[];for(const {layer:b,
supports:c}of this.editableItems)b.loaded&&c.includes("create")&&a.push(b);this.featureTemplatesViewModel.layers=a};d._cancelWorkflow=function(){var a=k._asyncToGenerator(function*(b){const c=this.activeWorkflow;c?b&&!1===b.force?(yield c.cancel(b),this._set("activeWorkflow",null)):(this.emit("workflow-cancel"),this._set("activeWorkflow",null),yield c.cancel(b)):b&&b.warn&&m("editing:no-active-workflow","There is no active workflow to cancel.")});return function(b){return a.apply(this,arguments)}}();
d._createCreateFeaturesWorkflow=function(a,b){return M.create(this,a,b,(c,h)=>this._applyEdits(c,h))};d._createCreateWorkflow=function(a){return N.create(this,a,(b,c)=>this._applyEdits(b,c))};d._createUpdateWorkflow=function(a){return O.create(this,a,(b,c)=>this._applyEdits(b,c))};d._delete=function(){var a=k._asyncToGenerator(function*(b){const c=b.sourceLayer;"applyEdits"in c&&(yield this._applyEdits(c,{deleteFeatures:[b]}))});return function(b){return a.apply(this,arguments)}}();d._applyEdits=
function(){var a=k._asyncToGenerator(function*(b,c){var h=this;yield this._queueOperation(k._asyncToGenerator(function*(){const q=yield h.view.whenLayerView(b),f=yield b.applyEdits(c);yield r.whenOnce(()=>!q.updating);return f}))});return function(b,c){return a.apply(this,arguments)}}();d._queueOperation=function(a){this.activityQueue.push(a);this.notifyChange("syncing");const b=(c,h)=>{c=h.indexOf(c);-1<c&&h.splice(c,1)};return a().then(({addFeatureResults:c,deleteFeatureResults:h,updateFeatureResults:q})=>
{if(c=c.find(f=>!!f.error)||q.find(f=>!!f.error)||h.find(f=>!!f.error))throw c.error;}).catch(c=>{m("editing:operation-error","An error occurred.",{error:c});const h={error:c,retry:()=>{b(h,this.failures);return this._queueOperation(a)},cancel:()=>{b(h,this.failures)}};this._set("failures",[...this.failures,h])}).then(()=>{b(a,this.activityQueue);this.notifyChange("syncing")})};k._createClass(n,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(a){a&&0!==a.length||
(a=[...A]);this._set("allowedWorkflows",a)}},{key:"canCreate",get:function(){return this.editableItems.some(a=>a.supports.includes("create"))}},{key:"canUpdate",get:function(){return this.editableItems.some(a=>a.supports.includes("update"))}},{key:"editableItems",get:function(){var a,b,c;const h=null==(a=this.view)?void 0:a.allLayerViews;if(!h)return new D;const q=new Set(null==(b=this.view)?void 0:null==(c=b.map)?void 0:c.editableLayers);return h.filter(f=>q.has(f.layer)).map(f=>{const {layer:u,
suspended:U}=f,{data:B,operations:y}=u.capabilities;f=T(this.layerInfos,u);const C="supportsAttachment"in B&&B.supportsAttachment&&(!f||!1!==f.allowAttachments);if(U)return{hasAttachments:C,layer:u,supports:[]};const v=[];y.supportsAdd&&(this.allowedWorkflows.includes("create")||this.allowedWorkflows.includes("create-features"))&&(!f||!1!==f.enabled&&!1!==f.addEnabled)&&v.push("create");y.supportsUpdate&&this.allowedWorkflows.includes("update")&&(!f||!1!==f.enabled&&!1!==f.updateEnabled)&&v.push("update");
!1!==(f&&f.deleteEnabled)&&y.supportsDelete&&v.push("delete");return{hasAttachments:C,layer:u,supports:v}}).reverse()}},{key:"state",get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";var a=this.attachmentsViewModel.mode;if("add"===a)return"adding-attachment";if("edit"===a)return"editing-attachment";({activeWorkflow:a}=this);return a?a.stepId:"ready"}},{key:"syncing",get:function(){return 0<this.activityQueue.length}},{key:"view",set:function(a){this.sketchViewModel.view=
a;this.spinnerViewModel.view=a;this._set("view",a)}}]);return n}(E.HandleOwnerMixin(e.EventedAccessor));g.__decorate([l.property({readOnly:!0})],e.prototype,"activeWorkflow",void 0);g.__decorate([l.property({readOnly:!0})],e.prototype,"activityQueue",void 0);g.__decorate([l.property({value:[...A]})],e.prototype,"allowedWorkflows",null);g.__decorate([l.property({readOnly:!0})],e.prototype,"canCreate",null);g.__decorate([l.property({readOnly:!0})],e.prototype,"canUpdate",null);g.__decorate([l.property({readOnly:!0})],
e.prototype,"editableItems",null);g.__decorate([l.property({readOnly:!0})],e.prototype,"failures",void 0);g.__decorate([l.property()],e.prototype,"attachmentsViewModel",void 0);g.__decorate([l.property()],e.prototype,"featureFormViewModel",void 0);g.__decorate([l.property()],e.prototype,"featureTemplatesViewModel",void 0);g.__decorate([w.aliasOf("sketchViewModel.labelOptions")],e.prototype,"labelOptions",void 0);g.__decorate([l.property()],e.prototype,"layerInfos",void 0);g.__decorate([l.property()],
e.prototype,"sketchViewModel",void 0);g.__decorate([w.aliasOf("sketchViewModel.snappingOptions")],e.prototype,"snappingOptions",void 0);g.__decorate([l.property()],e.prototype,"spinnerViewModel",void 0);g.__decorate([l.property()],e.prototype,"state",null);g.__decorate([l.property({readOnly:!0})],e.prototype,"syncing",null);g.__decorate([w.aliasOf("sketchViewModel.tooltipOptions")],e.prototype,"tooltipOptions",void 0);g.__decorate([l.property()],e.prototype,"view",null);return e=g.__decorate([G.subclass("esri.widgets.Editor.EditorViewModel")],
e)});