// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/arrayUtils ../../core/handleUtils ../../core/maybe ../../core/reactiveUtils ../../core/Logger ../../core/accessorSupport/ensureType ../../core/has ../../core/accessorSupport/set ../../core/accessorSupport/decorators/subclass ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./Workflow ./workflowUtils".split(" "),function(f,D,z,A,h,B,x,O,P,Q,E,F,G,H,r){var y;x=y=function(C){function v(a){a=
C.call(this,a)||this;a.type="create-features";a.createFeatureState="create-new";a.featureFormHandle=null;a.visualVariableAttributes={rotation:null,size:null};a.highlightHandles=new Map;a.preventDefaultActionOnCancel=!1;return a}f._inheritsLoose(v,C);var w=v.prototype;w.updatePendingFeature=function(){var a=f._asyncToGenerator(function*(c,d){this.preventDefaultActionOnCancel=!0;this.data.viewModel.sketchViewModel.cancel();z.remove(this.lastActiveGraphics,c);return this._startUpdating(c,d)});return function(c,
d){return a.apply(this,arguments)}}();v.create=function(a,c,d,k){a=new y({data:new G.CreateFeaturesWorkflowData({creationInfo:h.unwrap(c),viewModel:a}),onCommit:function(){var t=f._asyncToGenerator(function*(p){yield k(p.creationInfo.layer,{addFeatures:p.viewModel.sketchViewModel.layer.graphics.toArray()})});return function(p){return t.apply(this,arguments)}}()});a._set("steps",this._createWorkflowSteps(a,d));return a};w._fadeExistingFeatures=function(a){if("effect"in a){const d=a.effect;a.effect=
"saturate(0.6) opacity(0.8)";return A.makeHandle(()=>a.effect=d)}const c=a.opacity;a.opacity=.7;return A.makeHandle(()=>a.opacity=c)};w._highlight=function(a){const c=this.data.viewModel.view;"3d"===c.type&&this.highlightHandles.set(a,c.highlight(a))};w._removeHighlight=function(a){h.removeMaybe(this.highlightHandles.get(a));this.highlightHandles.delete(a)};w._startCreating=function(){var a=f._asyncToGenerator(function*(c){this.createFeatureState="create-new";return r.startCreatingNewFeature(this.data.viewModel.sketchViewModel,
this.data.creationInfo,c)});return function(c){return a.apply(this,arguments)}}();w._startUpdating=function(){var a=f._asyncToGenerator(function*(c,d){const k=this.data.viewModel,t=k.sketchViewModel,p=this.data.creationInfo.layer,n=r.findLayerInfo(k.layerInfos,p);k.featureFormViewModel.set({feature:c,formTemplate:null==n?void 0:n.formTemplate,spatialReference:k.view.spatialReference});h.removeMaybe(this.featureFormHandle);this.featureFormHandle=k.featureFormViewModel.on("value-change",f._asyncToGenerator(function*(){c.attributes=
k.featureFormViewModel.getValues();yield r.updateGraphicSymbolWhenRequired(c,d)}));this._removeHighlight(c);this.createFeatureState="update-pending";this.visualVariableAttributes=r.getVisualVariableAttributes(c);return r.startUpdatingFeature(t,c,p,this.visualVariableAttributes,d)});return function(c,d){return a.apply(this,arguments)}}();v._createWorkflowSteps=function(a,c="awaiting-feature-creation-info"){const {data:d,handles:k}=a;let t=null,p=!0;const n=new Map;c=r.createWorkflowSteps(["awaiting-feature-creation-info",
"creating-features"],c,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var u=this;return f._asyncToGenerator(function*(){d.creationInfo=null;k.add(d.viewModel.featureTemplatesViewModel.on("select",({item:q})=>{d.creationInfo={layer:q.layer,template:q.template};d.viewModel.activeWorkflow.next()}),u.id)})()},tearDown(){var u=this;return f._asyncToGenerator(function*(){k.remove(u.id)})()}}),"creating-features":()=>({id:"creating-features",setUp(){var u=this;return f._asyncToGenerator(function*(){const q=
d.viewModel.view,g=d.viewModel.sketchViewModel;p=g.updateOnGraphicClick;g.updateOnGraphicClick=!1;a.lastActiveGraphics=[];a.featureFormHandle=h.removeMaybe(a.featureFormHandle);a.visualVariableAttributes={rotation:null,size:null};const I="2d"===q.type?a._fadeExistingFeatures(d.creationInfo.layer):null,J=g.on("create",function(){var l=f._asyncToGenerator(function*(b){if("cancel"===b.state){if(a.preventDefaultActionOnCancel){a.preventDefaultActionOnCancel=!1;return}if(1>a.lastActiveGraphics.length)return a._startCreating(n);
b=a.lastActiveGraphics.pop();return a._startUpdating(b,n)}if("complete"===b.state)return a._startUpdating(b.graphic,n)});return function(b){return l.apply(this,arguments)}}()),K=g.on("update",function(){var l=f._asyncToGenerator(function*(b){var e=b.graphics[0];if("complete"===b.state){e!==t&&(a.lastActiveGraphics.push(e),a._highlight(e));t=null;if(b.aborted&&a.preventDefaultActionOnCancel){a.preventDefaultActionOnCancel=!1;return}return a._startCreating(n)}"start"===b.state&&a._removeHighlight(e);
yield r.visualVariableInteractiveUpdate(q,e,b,a.visualVariableAttributes,n);b=e.attributes;h.isSome(a.visualVariableAttributes.rotation)&&({field:e}=a.visualVariableAttributes.rotation,d.viewModel.featureFormViewModel.setValue(e,b[e]));h.isSome(a.visualVariableAttributes.size)&&({field:e}=a.visualVariableAttributes.size,d.viewModel.featureFormViewModel.setValue(e,b[e]))});return function(b){return l.apply(this,arguments)}}()),L=g.on("delete",function(){var l=f._asyncToGenerator(function*(b){b=b.graphics[0];
z.remove(a.lastActiveGraphics,b);t=b});return function(b){return l.apply(this,arguments)}}());let m=null;const M=B.watch(()=>{var l;const b=g.snappingOptions.featureSources.find(e=>e.layer===d.creationInfo.layer);return{hasFeatureLayerSource:!!b,enabled:null!=(l=null==b?void 0:b.enabled)?l:!1}},({hasFeatureLayerSource:l,enabled:b})=>{const e=g.snappingOptions.featureSources;l?(h.isNone(m)&&(m=new F({layer:g.layer,enabled:b}),e.add(m)),m.enabled=b):(h.isSome(m)&&e.remove(m),m=h.destroyMaybe(m))},B.syncAndInitial),
N=q.on("immediate-click",function(){var l=f._asyncToGenerator(function*(b){({results:b}=yield q.hitTest(b,{include:g.layer}));if(b=b.find(e=>"graphic"===e.type))b=b.graphic,"transform"!==g.activeTool&&"reshape"!==g.activeTool||g.updateGraphics.getItemAt(0)===b||(yield a.updatePendingFeature(b,n))});return function(b){return l.apply(this,arguments)}}());yield a._startCreating(n);k.add({remove:()=>{h.removeMaybe(a.featureFormHandle);J.remove();K.remove();L.remove();M.remove();h.isSome(m)&&g.snappingOptions.featureSources.remove(m);
m=h.destroyMaybe(m);g.cancel();N.remove();h.removeMaybe(I)}},u.id)})()},tearDown(u){var q=this;return f._asyncToGenerator(function*(){u.cancelled&&d.viewModel.sketchViewModel.layer.removeAll();k.remove(q.id);d.viewModel.sketchViewModel.updateOnGraphicClick=p})()}})});return r.avoidFeatureTemplateSelectionWithOnlyOneItem(d,c)};f._createClass(v,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]);
return v}(H);return x=y=D.__decorate([E.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],x)});