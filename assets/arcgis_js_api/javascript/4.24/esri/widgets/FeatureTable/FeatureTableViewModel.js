// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Collection ../../core/HandleOwner ../../core/Handles ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Column ./Grid/Grid ./Grid/GridViewModel ./Grid/GroupColumn ./support/FeatureStore ../../intl/locale ../../intl/messages".split(" "),
function(r,h,K,f,C,L,M,N,G,w,k,Y,Z,aa,O,P,Q,D,R,S,T,U,H,V,I){f=function(J){function A(a){var b=J.call(this,a)||this;b._debounceRefresh=G.debounce(()=>b._refresh());b._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"];b._highlights=new M;b.activeFilters=new C;b.autoRefreshEnabled=!0;b.cellClassNameGenerator=(l,m)=>l.path||null;b.columns=new C;b.dataProvider=function(){var l=r._asyncToGenerator(function*(m,p){const {store:q}=r._assertThisInitialized(b),{page:x,pageSize:t,
sortOrders:u}=m;m=b._sortOrdersToLayerOrderByFields(u);p&&(q?(yield q.set({orderByFields:m}),"loaded"!==q.state&&"loading"!==q.state&&(yield q.load()),p&&p(yield q.fetchItems({page:x,pageSize:t}))):p&&p([]))});return function(m,p){return l.apply(this,arguments)}}();b.editingEnabled=!1;b.fieldConfigs=null;b.grid=null;b.hiddenFields=new C;b.highlightOnRowSelectEnabled=!0;b.itemIdPath="objectId";b.messagesCommon=null;b.relatedRecordsEnabled=!1;b.store=null;b.tableTemplate=null;b.view=null;const {hiddenFields:c,
itemIdPath:d}=r._assertThisInitialized(b);c.addMany(b._defaultHiddenFields);b._onLayerRefresh=b._onLayerRefresh.bind(r._assertThisInitialized(b));b._set("store",new H);b._set("grid",new S({itemIdPath:d,viewModel:r._assertThisInitialized(b)}));return b}r._inheritsLoose(A,J);var e=A.prototype;e.initialize=function(){var a=this;const b=function(){var c=r._asyncToGenerator(function*(){a.messages=yield I.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable");a.messagesCommon=yield I.fetchMessageBundle("esri/t9n/common")});
return function(){return c.apply(this,arguments)}}();b();this.handles.add([V.onLocaleChange(b),w.on(()=>this.grid.selectedItems,"change",c=>this._onSelectionChange(c)),w.watch(()=>this.relatedRecordsEnabled,c=>this.store.relatedRecordsEnabled=c),w.watch(()=>{var c;return null==(c=this.layer)?void 0:c.loaded},c=>c&&this._onLayerLoad()),w.watch(()=>this.store.state,c=>{if("loaded"===c){var d;null==(d=this.grid)?void 0:d.scrollToTop()}}),w.watch(()=>[this.editingEnabled,this.messages,this.tableTemplate,
this.fieldConfigs],()=>{var c;return(null==(c=this.layer)?void 0:c.loaded)&&this._generateColumns()}),w.watch(()=>{var c;return null==(c=this.layer)?void 0:c.definitionExpression},(c,d)=>(c||d)&&"loaded"===this.store.state&&this.reset()),w.on(()=>this.layer,"refresh",c=>this._onLayerRefresh(c))])};e.destroy=function(){var a,b;this._resetColumns();this.handles.removeAll();this._highlights.removeAll();this._highlights.destroy();null==(a=this.grid)?void 0:a.destroy();null==(b=this.columns)?void 0:b.destroy();
this.view=this.layer=null};e.clearHighlights=function(){this._highlights.removeAll()};e.clearSelection=function(){var a;null==(a=this.grid)?void 0:a.clearSelection()};e.deselectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid.deselectRows(a)};e.filterBySelection=function(){const a=this.grid.getSelectedRowIds();a.length&&(this.clearSelectionFilter(),this.store.objectIds=a,this.activeFilters.add({type:"selection",objectIds:a}))};e.getObjectIdIndex=function(a){var b;return null==
(b=this.store)?void 0:b.getObjectIdIndex(a)};e.getValue=function(a,b){var c;a=this.store.getItemByObjectId(a);return null==a?void 0:null==(c=a.feature)?void 0:c.attributes[b]};e.refresh=function(){var a=r._asyncToGenerator(function*(){return G.ignoreAbortErrors(this._debounceRefresh())});return function(){return a.apply(this,arguments)}}();e.reset=function(){this.grid.reset()};e.selectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid.selectRows(a)};e.scrollToIndex=function(a){var b;
null==(b=this.grid)?void 0:b.scrollToIndex(a)};e.clearSelectionFilter=function(){this.store.objectIds=null;const a=this.activeFilters.find(b=>"selection"===b.type);a&&this.activeFilters.remove(a)};e.zoomToSelection=function(){const {layer:a,view:b}=this,c=this.grid.getSelectedRowIds();if(a&&b&&c.length){var d=a.createQuery();d.objectIds=c;d.returnGeometry=!0;a.queryFeatures(d).then(l=>{b.goTo(l.features).catch(m=>{"AbortError"!==m.name&&console.error(m)})})}};e._refresh=function(){var a=r._asyncToGenerator(function*(){yield this.store.refreshLayerInfo();
const b=this.grid.getSelectedRowIds();b.length&&(yield this.store.verifyFeaturesByObjectId(b)).forEach((c,d)=>{c||this.deselectRows(b[d])});this.grid.refreshPageCache()});return function(){return a.apply(this,arguments)}}();e._onLayerLoad=function(){const a=this.layer.capabilities.query.maxRecordCount;a&&a<this.pageSize&&this.grid&&(this.grid.pageSize=a);this._generateColumns()};e._onLayerRefresh=function(a){this.autoRefreshEnabled&&a.dataChanged&&this.refresh()};e._generateColumns=function(){var a,
b;this._resetColumns();const c=[],d=null!=(a=this.tableTemplate)&&a.columnTemplates?this._generateColumnsFromTemplates(this.tableTemplate.columnTemplates):null!=(b=this.fieldConfigs)&&b.length?this._generateColumnsFromConfigs():this._generateDefaultFieldColumns();c.push(...d);this.attachmentsEnabled&&c.push(this._generateDefaultAttachmentColumn());this.columns.addMany([...c])};e._generateColumnsFromTemplates=function(a){var b,c;const {editingEnabled:d,grid:l,hiddenFields:m,layer:p,messages:q,messagesCommon:x,
store:t,tableTemplate:u}=this,n=null!=(b=null==(c=this.layer)?void 0:c.fields)?b:[];return a.filter(g=>(n||[]).find(v=>"fieldName"in g&&g.fieldName===v.name)||"group"===g.type&&"columnTemplates"in g).map(g=>{if("fieldName"in g){var v=(n||[]).find(W=>g.fieldName===W.name),y=!1===g.visible||!0!==g.visible&&m.includes(v.name);const {direction:z,formatFunction:B,initialSortPriority:E,menuConfig:F,textAlign:X}=g;return new D({direction:z,editingEnabled:d,expressionInfos:u.expressionInfos||null,field:v,
formatFunction:B,grid:l,hidden:y,initialSortPriority:E,layer:p,messages:q,messagesCommon:x,menuConfig:F,store:t,template:g,textAlign:X})}if("group"===g.type&&"columnTemplates"in g){v=this._generateColumnsFromTemplates(g.columnTemplates);y=!1===g.visible||!0!==g.visible&&m.includes(g.label);const {label:z}=g;return new U({header:z,columns:v,hidden:y})}return new R({...g})})};e._generateColumnsFromConfigs=function(){var a,b;const {editingEnabled:c,fieldConfigs:d,grid:l,hiddenFields:m,layer:p,messages:q,
messagesCommon:x,store:t}=this,u=null!=(a=null==(b=this.layer)?void 0:b.fields)?a:[];return d.filter(n=>(u||[]).find(g=>n.name===g.name)).map(n=>{const g=n.direction||null,v=n.formatFunction||null,y=n.textAlign||null,z=N.isSome(n.initialSortPriority)?n.initialSortPriority:null,B=(u||[]).find(F=>n.name===F.name),E=!1===n.visible||!0!==n.visible&&m.includes(B.name);return new D({config:n,direction:g,editingEnabled:c,field:B,formatFunction:v,grid:l,hidden:E,layer:p,store:t,messages:q,messagesCommon:x,
menuConfig:n.menuConfig||null,textAlign:y,initialSortPriority:z})})};e._generateDefaultFieldColumns=function(){var a,b;const {editingEnabled:c,grid:d,hiddenFields:l,layer:m,messages:p,messagesCommon:q,store:x}=this;return(null!=(a=null==(b=this.layer)?void 0:b.fields)?a:[]).map(t=>{const u=l.includes(t.name);return new D({editingEnabled:c,field:t,grid:d,hidden:u,layer:m,store:x,messages:p,messagesCommon:q})})};e._generateDefaultAttachmentColumn=function(){var a;return new Q({header:null==(a=this.messages)?
void 0:a.attachments})};e._sortOrdersToLayerOrderByFields=function(a){return a&&a.length?a.filter((b,c,d)=>d.map(l=>l.path).indexOf(b.path)===c).filter(({direction:b})=>!!b).map(({direction:b,path:c})=>c+" "+b.toUpperCase()):[]};e._highlight=function(a){var {view:b}=this;b=b&&a&&b.allLayerViews.items.find(({layer:c})=>c===a.layer);P.highlightsSupported(b)&&this._highlights.add(b.highlight(a),`feature-${a.getObjectId()}`)};e._unhighlight=function(a){a&&this._highlights.remove(`feature-${a.getObjectId()}`)};
e._getStoreItemsFromSelectionParams=function(a){const b=[];a=a instanceof Array?a:[a];a.forEach(c=>{let d=c instanceof K?c:null;c=d?d.getObjectId():c;if("number"===typeof c||"string"===typeof c){if(!d){const l=this.store.getItemByObjectId(c);l&&(d=l.feature)}b.push({objectId:c,feature:d})}});return b};e._onSelectionChange=function(a){const {highlightOnRowSelectEnabled:b}=this,{added:c,removed:d}=a;b&&c.forEach(l=>this._highlight(l.feature));b&&d.forEach(l=>this._unhighlight(l.feature))};e._resetColumns=
function(){this.columns.items.forEach(a=>a.destroy());this.columns.removeAll()};r._createClass(A,[{key:"activeSortOrders",get:function(){var a;return(null==(a=this.grid)?void 0:a.sortOrders)||[]}},{key:"attachmentsEnabled",set:function(a){this.attachmentsEnabled!==a&&(this._set("attachmentsEnabled",a),this._generateColumns(),this.store.attachmentsEnabled=a)}},{key:"filterGeometry",set:function(a){if(this.filterGeometry||a){var b=this.activeFilters.find(c=>"geometry"===c.type);b&&this.activeFilters.remove(b);
this.clearSelection();this._set("filterGeometry",a);(this.store.filterGeometry=a)&&this.activeFilters.add({type:"geometry",geometry:a})}}},{key:"layer",set:function(a){var b;this._set("layer",a);null==(b=this.grid)?void 0:b.clearSort();this._resetColumns();(this.store.layer=a)&&(a.loaded?this._onLayerLoad():a.load());this.notifyChange("state")}},{key:"messages",set:function(a){var b;null==(b=this.grid)?void 0:b.set("messages",a);this._set("messages",a)}}]);return A}(L.HandleOwnerMixin(T));h.__decorate([k.property({readOnly:!0})],
f.prototype,"activeFilters",void 0);h.__decorate([k.property({readOnly:!0})],f.prototype,"activeSortOrders",null);h.__decorate([k.property()],f.prototype,"attachmentsEnabled",null);h.__decorate([k.property()],f.prototype,"autoRefreshEnabled",void 0);h.__decorate([k.property()],f.prototype,"cellClassNameGenerator",void 0);h.__decorate([k.property({readOnly:!0})],f.prototype,"columns",void 0);h.__decorate([k.property()],f.prototype,"dataProvider",void 0);h.__decorate([k.property()],f.prototype,"editingEnabled",
void 0);h.__decorate([k.property()],f.prototype,"fieldConfigs",void 0);h.__decorate([k.property()],f.prototype,"filterGeometry",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"grid",void 0);h.__decorate([k.property()],f.prototype,"hiddenFields",void 0);h.__decorate([k.property()],f.prototype,"highlightOnRowSelectEnabled",void 0);h.__decorate([k.property({readOnly:!0})],f.prototype,"itemIdPath",void 0);h.__decorate([k.property()],f.prototype,"layer",null);h.__decorate([k.property()],f.prototype,
"messages",null);h.__decorate([k.property()],f.prototype,"messagesCommon",void 0);h.__decorate([k.property()],f.prototype,"relatedRecordsEnabled",void 0);h.__decorate([k.property({readOnly:!0,type:H})],f.prototype,"store",void 0);h.__decorate([k.property()],f.prototype,"tableTemplate",void 0);h.__decorate([k.property()],f.prototype,"view",void 0);return f=h.__decorate([O.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],f)});