// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../rest/support/AttachmentQuery".split(" "),function(g,l,C,h,v,y,r,D,E,m,J,F,G){function z(w,q,e){H.error(new r(w,q,e))}const H=
E.getLogger("esri.widgets.FeatureTable.support.FeatureStore");h=function(w){function q(b){b=w.call(this,b)||this;b._loaded=!1;b._loadError=!1;b._loading=!1;b._editOperationQueue=[];b._queryOperationQueue=[];b._objectIdCache=new y;b._hasStaleCache=!1;b.count=0;b.failures=new y;b.itemCache=new y;b.relatedRecordsEnabled=!1;return b}g._inheritsLoose(q,w);var e=q.prototype;e.destroy=function(){this.layer=null;this.itemCache&&this.itemCache.destroy();this.failures&&this.failures.destroy();this._set("itemCache",
null)};e.load=function(){var b=g._asyncToGenerator(function*(){this._reset();const {layer:a}=this;if(a){this._loading=!0;this.notifyChange("state");try{yield a.when(),yield this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(c){throw this._reset(),this._loadError=!0,this.notifyChange("state"),z("store:load-error","An error ocurred.",{error:c}),c;}}});return function(){return b.apply(this,arguments)}}();e.refreshLayerInfo=function(){var b=g._asyncToGenerator(function*(){return this._syncLayerInfo()});
return function(){return b.apply(this,arguments)}}();e.addItems=function(){var b=g._asyncToGenerator(function*(a){});return function(a){return b.apply(this,arguments)}}();e.fetchItems=function(){var b=g._asyncToGenerator(function*(a){const {page:c,pageSize:d}=a;a=c*d;const f=a+d,{layer:k,state:p}=this;if(!k||"loaded"!==p)return[];this.notifyChange("querying");a=yield this._query({start:a,num:f,page:c,pageSize:d});this.notifyChange("state");return a});return function(a){return b.apply(this,arguments)}}();
e.verifyFeaturesByObjectId=function(){var b=g._asyncToGenerator(function*(a){const {layer:c,state:d}=this;if(!c||"loaded"!==d)return[];const {features:f}=yield this._verifyFeaturesByObjectId(a);return a.map(k=>f.some(p=>(null==p?void 0:p.getObjectId())===k))});return function(a){return b.apply(this,arguments)}}();e.query=function(){var b=g._asyncToGenerator(function*(a){const {layer:c,state:d}=this;if(!c||"loaded"!==d)return[];this.notifyChange("querying");a=yield this._query(a);this.notifyChange("state");
return a});return function(a){return b.apply(this,arguments)}}();e.removeItemAt=function(){var b=g._asyncToGenerator(function*(a){});return function(a){return b.apply(this,arguments)}}();e.reset=function(){var b=g._asyncToGenerator(function*(){this._reset()});return function(){return b.apply(this,arguments)}}();e.updateItem=function(){var b=g._asyncToGenerator(function*(a){return this._update(a)});return function(a){return b.apply(this,arguments)}}();e.getItemByObjectId=function(b){const {itemCache:a,
layer:{objectIdField:c}}=this;return a.find(d=>d.feature.attributes[c]===b)};e.getLocalItemAt=function(b){return this.itemCache.getItemAt(b)};e.getItemAt=function(b){return Promise.resolve(this.itemCache.getItemAt(b))};e.getObjectIdIndex=function(b){const {itemCache:a,layer:{objectIdField:c}}=this;return a.findIndex(d=>d.feature.attributes[c]===b)};e._reset=function(){this.itemCache.removeAll();this.failures.removeAll();this._editOperationQueue=[];this._queryOperationQueue=[];this._loadError=this._loaded=
this._loading=this._hasStaleCache=!1;this._set("count",0);this._objectIdCache.removeAll();this.notifyChange("querying");this.notifyChange("syncing");this.notifyChange("state")};e._getIdsFromFeatures=function(b){return b.map(a=>a.attributes[this.layer.objectIdField])};e._toFeatureData=function(b,a){const {layer:{objectIdField:c}}=this;return b.map(d=>{var {attributes:f}=d;f=f[c];return{objectId:f,feature:d,attachments:a?a[f]:null,relatedRecords:null}})};e._update=function(){var b=g._asyncToGenerator(function*(a){const {layer:c}=
this,{operations:d}=c.capabilities;if(!(d.supportsUpdate&&"applyEdits"in c))throw new r("store:update-error","Update is not supported.");const {index:f,name:k,value:p}=a;a=yield this.getItemAt(f);if(!a||!a.feature)throw new r("store:update-error","Feature with provided 'objectId' not found.");const {feature:n}=a,t=D.clone(n.attributes);t[k]=p;a=new C({attributes:t});const x=c.applyEdits({updateFeatures:[a]}).then(u=>{const {updateFeatureResults:A}=u,B=A.find(I=>!!I.error);if(B)throw B.error;A.length&&
(n.attributes=t);return u});return this._queueEditOperation(()=>x)});return function(a){return b.apply(this,arguments)}}();e._query=function(){var b=g._asyncToGenerator(function*(a){const {refresh:c}=a;if(!0===c)return this.itemCache.removeAll(),this._syncLayerInfo().then(()=>this._queryFeatureData(a));this._hasStaleCache&&(yield this._updateIds(),this._hasStaleCache=!1);return this._queryFeatureData(a)});return function(a){return b.apply(this,arguments)}}();e._queryFeatureData=function(){var b=g._asyncToGenerator(function*(a){var c=
this;return this._queueQueryOperation(g._asyncToGenerator(function*(){const {features:d}=yield c._queryFeatures(a);var f=c._getIdsFromFeatures(d);f=yield c._queryAttachments(f);return c._toFeatureData(d,f)||[]}))});return function(a){return b.apply(this,arguments)}}();e._syncLayerInfo=function(){var b=g._asyncToGenerator(function*(){yield this._updateCount();yield this._updateIds()});return function(){return b.apply(this,arguments)}}();e._updateCount=function(){var b=g._asyncToGenerator(function*(){yield this._queryCount().then(a=>
this._set("count",a))});return function(){return b.apply(this,arguments)}}();e._updateIds=function(){var b=g._asyncToGenerator(function*(){var a,c,d;null!=(a=this.layer)&&null!=(c=a.capabilities)&&null!=(d=c.query)&&d.supportsPagination||(this._objectIdCache.removeAll(),yield this._queryForObjectIds().then(f=>this._objectIdCache.addMany(f)))});return function(){return b.apply(this,arguments)}}();e._queryCount=function(){const {filterGeometry:b,layer:a}=this,{capabilities:{query:{supportsCacheHint:c}}}=
a,d=a.createQuery();d.geometry=b;d.returnGeometry=!1;d.where=this._getWhere();d.objectIds=this.objectIds;c&&(d.cacheHint=!0);return a.queryFeatureCount(d)};e._queryForObjectIds=function(){const {filterGeometry:b,layer:a,orderByFields:c}=this,{capabilities:{query:{supportsCacheHint:d,supportsOrderBy:f}}}=a,k=a.createQuery();k.geometry=b;k.outFields=[a.objectIdField];k.returnGeometry=!1;k.where=this._getWhere();k.objectIds=this.objectIds;f&&(k.orderByFields=c);d&&(k.cacheHint=!0);return a.queryObjectIds(k)};
e._queryFeatures=function(){var b=g._asyncToGenerator(function*(a){const {layer:c}=this;if(!c.capabilities.operations.supportsQuery)throw new r("store:query-error","Layer does not support query operation.");const {filterGeometry:d,layer:{capabilities:{query:{supportsCacheHint:f,supportsOrderBy:k,supportsPagination:p}}},orderByFields:n,returnGeometry:t}=this,{start:x,pageSize:u}=a;a=c.createQuery();a.returnGeometry=t;p?(a.start=x,a.num=u,a.where=this._getWhere(),a.objectIds=this.objectIds):a.objectIds=
this.objectIds||this._getObjectIdsForPage(x,u);k&&(a.orderByFields=n);d&&(a.geometry=d);f&&(a.cacheHint=!0);return c.queryFeatures(a)});return function(a){return b.apply(this,arguments)}}();e._verifyFeaturesByObjectId=function(){var b=g._asyncToGenerator(function*(a){const {layer:c}=this;if(!c.capabilities.operations.supportsQuery)throw new r("store:query-error","Layer does not support query operation.");const {filterGeometry:d,layer:{capabilities:{query:{supportsCacheHint:f,supportsOrderBy:k}}},
orderByFields:p}=this,n=c.createQuery();n.where=this._getWhere();n.returnGeometry=!1;n.objectIds=a;n.outFields=[c.objectIdField];k&&(n.orderByFields=p);d&&(n.geometry=d);f&&(n.cacheHint=!0);return c.queryFeatures(n)});return function(a){return b.apply(this,arguments)}}();e._getObjectIdsForPage=function(b,a){const c=this._objectIdCache.toArray();return c.length>=b+a?c.slice(b,b+a):c.slice(b)};e._queryAttachments=function(b){const {attachmentsEnabled:a,layer:c}=this,{capabilities:{data:{supportsAttachment:d},
operations:{supportsQueryAttachments:f}}}=c;return a&&d&&f&&"queryAttachments"in c?c.queryAttachments(new G({objectIds:b,where:this._getWhere()})):Promise.resolve(null)};e._queueQueryOperation=function(b){this._queryOperationQueue.push(b);this.notifyChange("querying");return b().then(a=>this._queryOperationQueue.includes(b)?(this.itemCache.addMany(a),a):[]).catch(a=>{z("store:query-error","An error ocurred.",{error:a});const c={error:a,retry:()=>{this.failures.remove(c);this._queueQueryOperation(b)},
cancel:()=>this.failures.remove(c)};this.failures.add(c);return[]}).then(a=>{v.remove(this._queryOperationQueue,b);this.notifyChange("querying");return a})};e._queueEditOperation=function(b){this._editOperationQueue.push(b);this.notifyChange("syncing");return b().then(()=>{v.remove(this._editOperationQueue,b);this.notifyChange("syncing")}).catch(a=>{z("store:edit-error","An error ocurred.",{error:a});const c={error:a,retry:()=>{this.failures.remove(c);this._queueEditOperation(b)},cancel:()=>this.failures.remove(c)};
this.failures.add(c);v.remove(this._editOperationQueue,b);this.notifyChange("syncing");throw a;})};e._getWhere=function(){return this.where||this.layer.definitionExpression||"1\x3d1"};g._createClass(q,[{key:"attachmentsEnabled",set:function(b){this._reset();this._set("attachmentsEnabled",b);this.notifyChange("state")}},{key:"filterGeometry",set:function(b){this._reset();this._set("filterGeometry",b);this.notifyChange("state")}},{key:"layer",set:function(b){this._reset();this._set("layer",b);this.notifyChange("state")}},
{key:"objectIds",set:function(b){this._reset();this._set("objectIds",b||null);this.notifyChange("state")}},{key:"orderByFields",get:function(){return this._get("orderByFields")||[]},set:function(b){v.equals(b,this.orderByFields)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",b))}},{key:"querying",get:function(){return 0<this._queryOperationQueue.length}},{key:"returnGeometry",set:function(b){this._reset();this._set("returnGeometry",b);this.notifyChange("state")}},{key:"state",
get:function(){const {layer:b,_loaded:a,_loadError:c,_loading:d}=this;return c?"error":!b||this.get("layer.loadError")?"disabled":d?"loading":"loaded"===this.get("layer.loadStatus")&&a?"loaded":"ready"}},{key:"syncing",get:function(){return 0<this._editOperationQueue.length}},{key:"where",get:function(){return this._get("where")||null},set:function(b){this._reset();this._set("where",b);this.notifyChange("state")}}]);return q}(h);l.__decorate([m.property()],h.prototype,"attachmentsEnabled",null);l.__decorate([m.property({readOnly:!0})],
h.prototype,"count",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"failures",void 0);l.__decorate([m.property()],h.prototype,"filterGeometry",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"itemCache",void 0);l.__decorate([m.property({value:null})],h.prototype,"layer",null);l.__decorate([m.property({value:null})],h.prototype,"objectIds",null);l.__decorate([m.property()],h.prototype,"orderByFields",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"querying",null);
l.__decorate([m.property()],h.prototype,"relatedRecordsEnabled",void 0);l.__decorate([m.property({value:!1})],h.prototype,"returnGeometry",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"state",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"syncing",null);l.__decorate([m.property()],h.prototype,"where",null);return h=l.__decorate([F.subclass("esri.widgets.FeatureTable.support.FeatureStore")],h)});