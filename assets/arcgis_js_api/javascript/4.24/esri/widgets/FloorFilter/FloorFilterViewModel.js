// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/HandleOwner ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/time ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/FloorFilter ../support/GoTo".split(" "),function(A,m,V,Y,l,W,X,I,Z,n,ea,fa,ha,
aa,ba,ca,da){function P(Q){return"esri.WebMap"===Q.declaredClass}l=function(Q){function R(b){b=Q.call(this,b)||this;b.filterMenuOpen=!1;b.filterMenuType="site";b.filterMode="base-floors";b.levelsExpanded=!0;b.searchTerm=null;b.view=null;b._updateFloorFilterTask=null;return b}A._inheritsLoose(R,Q);var k=R.prototype;k.initialize=function(){var b=this;this.handles.add([I.watch(()=>{var a;return null==(a=this.view)?void 0:a.map},a=>{W.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),
this._updateFloorFilterTask=null);this._updateFloorFilterTask=X.createTask(function(){var c=A._asyncToGenerator(function*(d){yield b._updateFloorFilterFromMap(a);X.throwIfAborted(d);b._setInitialViewState(a)});return function(d){return c.apply(this,arguments)}}())},I.initial),I.watch(()=>this.view,(a,c)=>{this._unregisterWidget(c);this._registerWidget(a);this._watchSearchResults(a)},I.syncAndInitial),I.watch(()=>{var a;return null==(a=this.view)?void 0:a.widthBreakpoint},a=>{this._viewWidthBreakpoint=
a}),I.watch(()=>{var a;return null==(a=this.view)?void 0:a.heightBreakpoint},a=>{this._viewHeightBreakpoint=a})])};k.destroy=function(){this._unregisterWidget(this.view);this.view=null;W.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)};k.filterFacilities=function(b){let a=b;this.searchTerm&&(a=b.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));this.site&&(a=a.filter(c=>c.siteId===this.site));return a.sort((c,
d)=>{c=c.name;d=d.name;return c>d?1:c===d?0:-1})};k.filterSites=function(b){let a=b;this.searchTerm&&(a=b.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));return a.sort((c,d)=>{c=c.name;d=d.name;return c>d?1:c===d?0:-1})};k.getBaseLevel=function(b){var a,c;const d=null==(a=this.filterFeatures)?void 0:null==(c=a.levels)?void 0:c.levelsInfo;let e=null;if(b){const {id:g}=b;if(d&&0<d.length&&(d.forEach(f=>{0===f.verticalOrder&&f.facilityId===g&&(e=f)}),!e)){let f=
null;d.forEach(h=>{if(h.facilityId===g)if(f)if(0<=h.verticalOrder){if(0>f.verticalOrder||h.verticalOrder<f.verticalOrder)f=h}else 0>f.verticalOrder&&h.verticalOrder>f.verticalOrder&&(f=h);else f=h});f&&(e=f)}}return e};k.getFacility=function(b){var a,c,d,e;return null!=(a=null==(c=this.filterFeatures)?void 0:null==(d=c.facilities)?void 0:null==(e=d.facilitiesInfo)?void 0:e.find(g=>g.id===b))?a:null};k.getFacilityLevels=function(b){var a,c;return b&&null!=(a=this.filterFeatures)&&null!=(c=a.levels)&&
c.levelsInfo?this.filterFeatures.levels.levelsInfo.filter(d=>d.facilityId===b).sort((d,e)=>{d=d.verticalOrder;e=e.verticalOrder;return d>e?-1:d===e?0:1}):[]};k.getLevel=function(b){var a,c,d,e;return null!=(a=null==(c=this.filterFeatures)?void 0:null==(d=c.levels)?void 0:null==(e=d.levelsInfo)?void 0:e.find(g=>g.id===b))?a:null};k.getSite=function(b){var a,c,d,e;return null!=(a=null==(c=this.filterFeatures)?void 0:null==(d=c.sites)?void 0:null==(e=d.sitesInfo)?void 0:e.find(g=>g.id===b))?a:null};
k.goTo=function(b){var {view:a}=this;a&&b&&({geometry:b}=b,b&&b.extent&&(a={duration:Z.Milliseconds(1E3),easing:"out-back"},this.callGoTo({target:b.extent,options:a})))};k.setFloors=function(b){var a,c,d;null==(a=this.view)?void 0:null==(c=a.map)?void 0:null==(d=c.allLayers)?void 0:d.forEach(e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)});this.view.floors=new V(this._computeFloors(b))};k.updateWebDocument=function(b){if(P(b)){var a,c,d;const e=new ca({enabled:this.enabled,longNames:this.longNames,
minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:null!=(a=this.site)?a:null,facility:null!=(c=this.facility)?c:null,level:null!=(d=this.level)?d:null});b.widgets?b.widgets.floorFilter=e:b.widgets=new ba({floorFilter:e})}};k._computeFloors=function(b){if("single-floor"===this.filterMode)this._computeSingleFloor(b);else if("base-floors"===this.filterMode)return"3d"===this.view.type?this._computeBaseFloors3D(b):this._computeBaseFloors(b);return this._computeEmptyFloors()};k._computeSingleFloor=
function(b){if(!b)return this._computeEmptyFloors();const a=[];"all"===(null==b?void 0:b.id)?this.getFacilityLevels(b.facilityId).forEach(c=>{c.id&&a.push(c.id)}):b&&a.push(b.id);return a};k._computeBaseFloors=function(b){var a,c;const d=null==(a=this.filterFeatures)?void 0:null==(c=a.levels)?void 0:c.levelsInfo;if(!d||!d.length)return this._computeEmptyFloors();const e=[];"all"===(null==b?void 0:b.id)?this.getFacilityLevels(b.facilityId).forEach(f=>{f.id&&e.push(f.id)}):b&&e.push(b.id);const g=null==
b?void 0:b.facilityId;d.forEach(f=>{const {id:h,facilityId:q,verticalOrder:p}=f;g||0!==p||e.includes(h)?q===g||0!==p||e.includes(h)||e.push(h):e.push(h)});return e};k._computeBaseFloors3D=function(b){var a,c;const d=null==(a=this.filterFeatures)?void 0:null==(c=a.levels)?void 0:c.levelsInfo;if(!d||!d.length)return this._computeEmptyFloors();const e=[];a=null==b?void 0:b.id.split("--");1<(null==a?void 0:a.length)&&"all"===a[0]?this.getFacilityLevels(b.facilityId).forEach(f=>{f.id&&e.push(f.id)}):b&&
e.push(b.id);const g=null==b?void 0:b.facilityId;d.forEach(f=>{const {id:h,facilityId:q}=f;g||e.includes(h)?q===g||e.includes(h)||e.push(h):e.push(h)});return e};k._computeEmptyFloors=function(){return[]};k._setFilterLayers=function(){var b=A._asyncToGenerator(function*(){var {view:a}=this;if(!this._isOverridden("filterLayers"))if(P(a.map)||"esri.WebScene"===a.map.declaredClass){var c;a=a.map;const J=null==a?void 0:a.allLayers;if(0<(null==J?void 0:null==(c=J.items)?void 0:c.length)){var d,e,g,f,h,
q,p,r,z,B,C,w;const F={siteLayer:null,facilityLayer:null,levelLayer:null},L=null==(d=a.floorInfo)?void 0:null==(e=d.siteLayer)?void 0:e.layerId,M=null==(g=a.floorInfo)?void 0:null==(f=g.facilityLayer)?void 0:f.layerId,N=null==(h=a.floorInfo)?void 0:null==(q=h.levelLayer)?void 0:q.layerId;c=(null==(p=a.floorInfo)?void 0:null==(r=p.siteLayer)?void 0:r.sublayerId)||(null==(z=a.floorInfo)?void 0:null==(B=z.facilityLayer)?void 0:B.sublayerId)||(null==(C=a.floorInfo)?void 0:null==(w=C.levelLayer)?void 0:
w.sublayerId);if(M&&N){p=J.items.filter(t=>"feature"===t.type||"scene"===t.type);r=J.items.filter(t=>"map-image"===t.type);if(0<(null==r?void 0:r.length)&&c){var v,D,E,x,G,K;yield Promise.all(r.map(y=>y.load()));const t=null==(v=a.floorInfo)?void 0:null==(D=v.siteLayer)?void 0:D.sublayerId,u=null==(E=a.floorInfo)?void 0:null==(x=E.facilityLayer)?void 0:x.sublayerId,S=null==(G=a.floorInfo)?void 0:null==(K=G.levelLayer)?void 0:K.sublayerId;r.forEach(y=>{const H=y.id;y=null==y?void 0:y.allSublayers;
const O=null==y?void 0:y.items;(H===L||H===M||H===N)&&0<(null==O?void 0:O.length)&&y.items.forEach(T=>{const U=T.id;H===L&&U===t?F.siteLayer=T:U===u?F.facilityLayer=T:U===S&&(F.levelLayer=T)})})}0<(null==p?void 0:p.length)&&p.forEach(t=>{const u=t.id;u===L?F.siteLayer=t:u===M?F.facilityLayer=t:u===N&&(F.levelLayer=t)});this.filterLayers=F}}}else throw new Y("Map must be a webmap or webscene");});return function(){return b.apply(this,arguments)}}();k._getFilterFeatures=function(){var b=A._asyncToGenerator(function*(){if(this._isOverridden("filterFeatures"))return this.filterFeatures;
const a={sites:null,facilities:null,levels:null};var c=yield this._getSites();a.sites=c;c=yield this._getFacilities();a.facilities=c;c=yield this._getLevels();a.levels=c;return a});return function(){return b.apply(this,arguments)}}();k._getSites=function(){var b=A._asyncToGenerator(function*(){var a,c;const {filterLayers:d,view:e}=this;var g=e.map;const {siteLayer:f}=d,h={sitesInfo:[]};if(!f||null==g||null==(a=g.floorInfo)||!a.siteLayer)return h;a=f.createQuery();a.returnGeometry=!0;a.outFields=["*"];
a.returnZ=!0;"type"in f&&"scene"===f.type&&(a.multipatchOption="xyFootprint");const {siteIdField:q,nameField:p}=g.floorInfo.siteLayer;g=yield f.queryFeatures(a);if(0<(null==g?void 0:null==(c=g.features)?void 0:c.length)){var r,z;c=g.features;const B=(null==f?void 0:null==(r=f.fieldsIndex.get(q))?void 0:r.name)||q,C=(null==f?void 0:null==(z=f.fieldsIndex.get(p))?void 0:z.name)||p;c.forEach(w=>{var v=w.attributes;w=w.geometry;const D=v[B];v=v[C];D&&v&&h.sitesInfo.push({id:D,name:v,geometry:w})})}return h});
return function(){return b.apply(this,arguments)}}();k._getFacilities=function(){var b=A._asyncToGenerator(function*(){var a,c;const {filterLayers:d,view:e}=this;var g=e.map;const {facilityLayer:f}=d,h={facilitiesInfo:[]};if(!f||null==g||null==(a=g.floorInfo)||!a.facilityLayer)return h;a=f.createQuery();a.returnGeometry=!0;a.outFields=["*"];a.returnZ=!0;"type"in f&&"scene"===f.type&&(a.multipatchOption="xyFootprint");const {facilityIdField:q,siteIdField:p,nameField:r}=g.floorInfo.facilityLayer;g=
yield f.queryFeatures(a);if(0<(null==g?void 0:null==(c=g.features)?void 0:c.length)){var z,B,C;c=g.features;const w=(null==f?void 0:null==(z=f.fieldsIndex.get(q))?void 0:z.name)||q,v=(null==f?void 0:null==(B=f.fieldsIndex.get(p))?void 0:B.name)||p,D=(null==f?void 0:null==(C=f.fieldsIndex.get(r))?void 0:C.name)||r;c.forEach(E=>{var x=E.attributes;E=E.geometry;const G=x[w],K=x[v];x=x[D];G&&x&&h.facilitiesInfo.push({id:G,siteId:K,name:x,geometry:E})})}return h});return function(){return b.apply(this,
arguments)}}();k._getLevels=function(){var b=A._asyncToGenerator(function*(){var a,c;const {filterLayers:d,view:e}=this;var g=e.map;const {levelLayer:f}=d,h={levelsInfo:[]};if(!f||null==g||null==(a=g.floorInfo)||!a.levelLayer)return h;a=f.createQuery();a.returnGeometry=!0;a.outFields=["*"];a.returnZ=!0;const {levelIdField:q,facilityIdField:p,longNameField:r,shortNameField:z,levelNumberField:B,verticalOrderField:C}=g.floorInfo.levelLayer;g=yield f.queryFeatures(a);if(0<(null==g?void 0:null==(c=g.features)?
void 0:c.length)){var w,v,D,E,x,G;c=g.features;const K=(null==f?void 0:null==(w=f.fieldsIndex.get(q))?void 0:w.name)||q,J=(null==f?void 0:null==(v=f.fieldsIndex.get(p))?void 0:v.name)||p,F=(null==f?void 0:null==(D=f.fieldsIndex.get(r))?void 0:D.name)||r,L=(null==f?void 0:null==(E=f.fieldsIndex.get(z))?void 0:E.name)||z,M=(null==f?void 0:null==(x=f.fieldsIndex.get(B))?void 0:x.name)||B,N=(null==f?void 0:null==(G=f.fieldsIndex.get(C))?void 0:G.name)||C;c.forEach(t=>{var u=t.attributes;t=u[K];const S=
u[J],y=u[F],H=u[L],O=u[M];u=u[N];t&&S&&y&&H&&"number"===typeof O&&"number"===typeof u&&h.levelsInfo.push({id:t,facilityId:S,longName:y,shortName:H,levelNumber:O,verticalOrder:u})})}return h});return function(){return b.apply(this,arguments)}}();k._registerWidget=function(b){(null==b?0:b.persistableViewModels.includes(this))||(null==b?void 0:b.persistableViewModels.add(this))};k._unregisterWidget=function(b){null==b?void 0:b.persistableViewModels.remove(this)};k._watchSearchResults=function(b){null==
b?void 0:b.on("select-result-floor",a=>{const c=this.getLevel(a);c&&this.level!==a&&(this.level=a,this.setFloors(c))})};k._setInitialViewState=function(){var b=A._asyncToGenerator(function*(a){if(this.view)try{yield this.view.when();yield this._setFilterLayers();const d=yield this._getFilterFeatures();if(d)if(this.filterFeatures=d,this.hasFacilities&&this.hasLevels)if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),
g=this.getLevel(this.level);this.site||(this.site=e.siteId||void 0);this.setFloors(g)}else if(this.facility&&!this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),g=this.getBaseLevel(e);this.site||(this.site=e.siteId||void 0);this.level=(null==g?void 0:g.id)||void 0;this.setFloors(g)}else if(!this.facility&&this.level){this.filterMenuType="facility";const e=this.getLevel(this.level),g=this.getFacility(null==e?void 0:e.facilityId);this.facility=(null==g?void 0:g.id)||
void 0;this.site||(this.site=(null==g?void 0:g.siteId)||void 0);this.setFloors(e)}else{if(!this.site||this.facility||this.level){var c;if(!a||!P(a)){this.setFloors(null);return}const e=null==a?void 0:null==(c=a.widgets)?void 0:c.floorFilter;if(!e){this.setFloors(null);return}e.site&&!this.site&&(this.site=e.site,this.filterMenuType="facility")}else this.filterMenuType="site";this.setFloors(null)}else console.error("Facilities and Levels are required for the Floor Filter widget")}catch(d){console.error("Couldn't retrieve sites, facilities, and levels",
d)}});return function(a){return b.apply(this,arguments)}}();k._callOverride=function(b,a){this._override(b,a)};k._updateFloorFilterFromMap=function(){var b=A._asyncToGenerator(function*(a){var c;a&&P(a)&&(a=null==a?void 0:null==(c=a.widgets)?void 0:c.floorFilter)&&(this._isOverridden("enabled")||(this.enabled=a.enabled),this._isOverridden("longNames")||(this.longNames=a.longNames),this._isOverridden("minimized")||(this.minimized=a.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=
a.pinnedLevels),this._isOverridden("site")||(this.site=a.site),this._isOverridden("facility")||(this.facility=a.facility),this._isOverridden("level")||(this.level=a.level))});return function(a){return b.apply(this,arguments)}}();k._computeViewAllModeFloors=function(b){var a;const {filterFeatures:c}=this;if(null!=(a=b.floorInfo)&&a.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const {level:d,facility:e}=this,g=[];c.levels.levelsInfo.forEach(f=>{const {id:h,facilityId:q}=
f;e&&q===e?d&&h===d&&g.push(h):g.push(h)});b.floorInfo.viewAllLevelIds=new V(g)}};A._createClass(R,[{key:"enabled",set:function(b){this._callOverride("enabled",b)}},{key:"facility",set:function(b){if(b&&this._isOverridden("facility")){const a=this.getFacility(b);this.hasMultipleSites&&(this.site=(null==a?void 0:a.siteId)||void 0)}this._callOverride("facility",b)}},{key:"filterFeatures",set:function(b){this._callOverride("filterFeatures",b)}},{key:"filterLayers",set:function(b){this._callOverride("filterLayers",
b)}},{key:"hasFacilities",get:function(){var b,a,c,d;return(null==(b=this.filterLayers)?void 0:b.facilityLayer)&&0<(null==(a=this.filterFeatures)?void 0:null==(c=a.facilities)?void 0:null==(d=c.facilitiesInfo)?void 0:d.length)}},{key:"hasLevels",get:function(){var b,a,c,d;return(null==(b=this.filterLayers)?void 0:b.levelLayer)&&0<(null==(a=this.filterFeatures)?void 0:null==(c=a.levels)?void 0:null==(d=c.levelsInfo)?void 0:d.length)}},{key:"hasMultipleSites",get:function(){var b,a,c,d;return(null==
(b=this.filterLayers)?void 0:b.siteLayer)&&1<(null==(a=this.filterFeatures)?void 0:null==(c=a.sites)?void 0:null==(d=c.sitesInfo)?void 0:d.length)}},{key:"isNormalMode",get:function(){let b=!0;const a=this._viewWidthBreakpoint;if("xsmall"===this._viewHeightBreakpoint||"xsmall"===a)b=!1;return b}},{key:"level",set:function(b){if(b){var a=null,c=null;a=null==b?void 0:b.split("--");if(1<(null==a?void 0:a.length)&&"all"===a[0])c=a[1],a={id:b,facilityId:c,shortName:null,longName:null,levelNumber:null,
verticalOrder:null};else{var d;a=this.getLevel(b);c=null==(d=a)?void 0:d.facilityId}if(this.level!==b||this.isNormalMode||this.levelsExpanded){if(a&&this.hasFacilities&&this.hasLevels){this.facility=c;if(this.hasMultipleSites){var e;this.site=null==(e=this.getFacility(c))?void 0:e.siteId}this.setFloors(a)}else this._isOverridden("level")&&(this.site=this.facility=void 0,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null));this._callOverride("level",b)}else b=this.getFacilityLevels(c),
1<(null==b?void 0:b.length)&&(this.levelsExpanded=!0)}else this._callOverride("level",b),this.site=this.facility=void 0,this.setFloors(null)}},{key:"longNames",set:function(b){this._callOverride("longNames",b)}},{key:"minimized",set:function(b){this._callOverride("minimized",b)}},{key:"pinnedLevels",set:function(b){this._callOverride("pinnedLevels",b)}},{key:"site",set:function(b){this._callOverride("site",b)}},{key:"state",get:function(){return this.view&&this.filterFeatures&&this.hasFacilities&&
this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}}]);return R}(da.GoToMixin(l.HandleOwner));m.__decorate([n.property({value:!1})],l.prototype,"enabled",null);m.__decorate([n.property({value:void 0})],l.prototype,"facility",null);m.__decorate([n.property({value:null})],l.prototype,"filterFeatures",null);m.__decorate([n.property({value:null})],l.prototype,"filterLayers",null);m.__decorate([n.property()],l.prototype,"filterMenuOpen",void 0);m.__decorate([n.property()],l.prototype,
"filterMenuType",void 0);m.__decorate([n.property()],l.prototype,"filterMode",void 0);m.__decorate([n.property()],l.prototype,"hasFacilities",null);m.__decorate([n.property()],l.prototype,"hasLevels",null);m.__decorate([n.property()],l.prototype,"hasMultipleSites",null);m.__decorate([n.property({readOnly:!0})],l.prototype,"isNormalMode",null);m.__decorate([n.property({value:void 0})],l.prototype,"level",null);m.__decorate([n.property({value:!1})],l.prototype,"longNames",null);m.__decorate([n.property()],
l.prototype,"levelsExpanded",void 0);m.__decorate([n.property({value:!1})],l.prototype,"minimized",null);m.__decorate([n.property({value:!1})],l.prototype,"pinnedLevels",null);m.__decorate([n.property()],l.prototype,"searchTerm",void 0);m.__decorate([n.property({value:void 0})],l.prototype,"site",null);m.__decorate([n.property({readOnly:!0})],l.prototype,"state",null);m.__decorate([n.property()],l.prototype,"view",void 0);m.__decorate([n.property()],l.prototype,"_viewHeightBreakpoint",void 0);m.__decorate([n.property()],
l.prototype,"_viewWidthBreakpoint",void 0);m.__decorate([n.property()],l.prototype,"updateWebDocument",null);return l=m.__decorate([aa.subclass("esri/widgets/FloorFilter/FloorFilterViewModel")],l)});