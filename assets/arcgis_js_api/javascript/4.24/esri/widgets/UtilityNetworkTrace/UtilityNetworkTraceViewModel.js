// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../geometry/Point ../../networks/support/utils ../../rest/networks/trace ../../rest/networks/support/TraceLocation ../../rest/networks/support/TraceParameters ./support/GeometryHandler ./support/GraphicHandler".split(" "),
function(q,n,y,z,k,A,B,C,D,p,L,M,N,E,F,t,G,v,H,I,J){const K=B.getLogger("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel");k=function(w){function r(b){b=w.call(this,b)||this;b._activeProgress=!1;b._clickHandler=null;b._flags=[];b._geometryHandler=null;b._graphicHandler=null;b._highlightHandler=[];b._traces=[];b._traceResults=[];b._unObject=null;b._watchHandler=null;b.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"};b.flags=[];b.gdbVersion="sde.DEFAULT";
b.selectedTraces=[];b.selectOnComplete=!0;b.showGraphicsOnComplete=!0;b.showSelectionAttributes=!0;return b}q._inheritsLoose(r,w);var g=r.prototype;g.initialize=function(){this._geometryHandler=new I.GeometryHandler;this._graphicHandler=new J.GraphicHandler};g.destroy=function(){this.view=null};g.addFlagByHit=function(b,a){return new Promise((c,d)=>{this.view.popup.autoOpenEnabled=!1;this._clickHandler&&this._clickHandler.remove();this.emit("add-flag",{type:b});this._clickHandler=this.view.on("click",
f=>{this.queryFlagByHitTest(f,b,a).then(e=>{this.view.popup.autoOpenEnabled=!0;this._clickHandler.remove();this.emit("add-flag-complete",{type:b,symbol:a});c(e)}).catch(e=>{this.view.popup.autoOpenEnabled=!0;this._clickHandler.remove();this.emit("add-flag-error",{type:b,symbol:a});d(e)})})})};g.addFlagsOnLoad=function(){var b=q._asyncToGenerator(function*(){var a=this;return new Promise(c=>{const d=[];this._watchHandler=D.when(()=>!this.view.updating,q._asyncToGenerator(function*(){if(!(0<a._flags.length)){const f=
a.flags.map(function(){var e=q._asyncToGenerator(function*(l){if(l.mapPoint){var h=new F({x:l.mapPoint.x,y:l.mapPoint.y,spatialReference:l.mapPoint.spatialReference.wkid});h={screenPoint:a.view.toScreen(h),mapPoint:h};(yield a.queryFlagByHitTest(h,l.type))||("barrier"===l.type?d.push("barrier"):d.push("starting-point"))}});return function(l){return e.apply(this,arguments)}}());yield Promise.all(f)}c(d)}),{initial:!0})})});return function(){return b.apply(this,arguments)}}();g.addResultGraphicToView=
function(){var b=q._asyncToGenerator(function*(a,c){for(const f in a.results.aggregatedGeometry)if("line,multipoint,polygon".includes(f)&&null!==a.results.aggregatedGeometry[f]){a.results.aggregatedGeometry[f].spatialReference=this._unObject.spatialReference;a.graphicEnabled=!0;var d=yield this._geometryHandler.projectGeometry(a.results.aggregatedGeometry[f],this.view.spatialReference);const e={globalid:a.trace.globalId};null!==d&&(d=this._graphicHandler.makeGraphic(d,c.color,e,this.view.spatialReference),
this.view.graphics.add(d))}});return function(a,c){return b.apply(this,arguments)}}();g.addTerminal=function(b,a){const c=[...this._flags];c.forEach(d=>{d.globalId===a.globalId&&(a.selectedTerminals.includes(parseInt(b,10))||d.selectedTerminals.push(parseInt(b,10)))});this._flags=c};g.callTrace=function(){var b=q._asyncToGenerator(function*(){var a=this;const c=this._traces.filter(d=>d.selected);return 0<c.length?(0<this._traceResults.length&&this._traceResults.forEach(d=>{this.removeResultGraphicFromView(d)}),
this._traceResults=[],this.removeSelection(),yield Promise.all(c.map(function(){var d=q._asyncToGenerator(function*(f,e){const l=new H({gdbVersion:a.gdbVersion,moment:null,traceType:f.traceType,traceLocations:a._flags,namedTraceConfigurationGlobalId:f.globalId,traceConfiguration:null,outSpatialReference:null,resultTypes:null});yield a.executeTrace(f,a._unObject.networkServiceUrl,l).then(h=>{if(h.hasOwnProperty("results")){var m={...h};if(null!==m.results){h=[...m.results.elements];m.results.elements.length=
0;const x=new Map;for(const u of h)x.has(u.globalId)||(x.set(u.globalId,!0),m.results.elements.push(u));h=[...a._traceResults];h.splice(e,0,m);a._traceResults=h;null!==m.results&&(a.selectOnComplete&&a.mergeSelection(!0,m.trace),a.showGraphicsOnComplete&&a.addResultGraphicToView(m,m.graphicColor))}else m=[...a._traceResults],m.splice(e,0,h),a._traceResults=m;a._activeProgress=!1}else a._activeProgress=!1,m=[...a._traceResults],m.splice(e,0,h),a._traceResults=m}).catch(h=>{a._activeProgress=!1;throw h;
})});return function(f,e){return d.apply(this,arguments)}}())),!0):!1});return function(){return b.apply(this,arguments)}}();g.changeResultGraphicColor=function(b,a){const c=[...this._traceResults];0<c.length&&c.forEach(d=>{d.trace.globalId===a.trace.globalId&&(d.graphicColor=b,d.graphicEnabled=!0)});this._traceResults=c;this.removeResultGraphicFromView(a);this.addResultGraphicToView(a,b)};g.changeFlagSymbol=function(b,a){0<this._flags.length&&this._flags.forEach(c=>{c.type===b&&a&&(c.mapGraphic.symbol=
a)})};g.checkCanTrace=function(){const b={status:!0,issues:[]};let a=[];this._flags.some(c=>"starting-point"===c.type)?(a=this._traces.filter(c=>c.selected),0>=a.length&&(b.status=!1,b.issues=["noTrace"])):(a=this._traces.filter(c=>!0===c.selected),0<a.length?(b.status=!1,b.issues=["noStart"]):(b.status=!1,b.issues=["noStart","noTrace"]));return b};g.checkSelectionExist=function(){let b=!1;this._highlightHandler.some(a=>{a&&(b=!0)});return b};g.clearResult=function(b){let a=this._traceResults;if(0<
a.length){const c=a.filter(d=>d.trace.globalId===b.globalId);0<c.length&&this.removeResultGraphicFromView(c[0]);a=a.filter(d=>d.trace.globalId!==b.globalId)}this._traceResults=a;0===a.length?(this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,b)};g.executeTrace=function(b,a,c){const d=this._processFlags(c.traceLocations);c.traceLocations=d;return G.trace(a,c).then(f=>({trace:b,results:f,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,
status:"success"})).catch(f=>({trace:b,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:f.message}))};g.getValidSources=function(){let b=[];const a=this._unObject.dataElement.domainNetworks;for(const c of a)b=b.concat(c.junctionSources),b=b.concat(c.edgeSources);return b};g.loadUtilityNetwork=function(){var b=q._asyncToGenerator(function*(){var a;yield this.view.when();const c=this.view.map;if(null!=(a=c.utilityNetworks)&&a.length){a=c.utilityNetworks.getItemAt(0);
yield a.load();this._unObject=a;try{yield c.loadAll(),this._populateOutfields()}catch(d){this._populateOutfields()}return a}return null});return function(){return b.apply(this,arguments)}}();g.manageFilterBarrier=function(b,a){const c=[...this._flags];c.forEach(d=>{d.globalId===a.globalId&&"barrier"===a.type&&d.id===a.id&&(d.isFilterBarrier=b)});this._flags=c};g.mergeSelection=function(b,a){let c=[];const d=[...this._traceResults],f=a.globalId;d.forEach(e=>{f===e.trace.globalId&&(e.selectionEnabled=
b);e.selectionEnabled&&null!==e.results.elements&&(c=c.concat(e.results.elements))});this.selectResults([...new Set(c)])};g.queryFeaturesById=function(){var b=q._asyncToGenerator(function*(a){var c=this;const d=t.getObjectIdsFromElements(this._unObject,a);a=this._getUniqueMapLayerViews(this.view);const f={layerUrl:d[0].layerUrl,objectIds:d[0].objectIds,outFields:["*"]};a=a.filter(e=>{var l,h;return(null==(l=e.layer)?void 0:null==(h=l.parsedUrl)?void 0:h.path)===d[0].layerUrl});return 0<a.length&&
(a=(yield Promise.all(a.map(function(){var e=q._asyncToGenerator(function*(l){const h=new y;h.add(l.layer);return(yield t.getFeaturesFromLayers({layers:h,layerInfos:[f],returnGeometry:!0,outSpatialReference:c.view.spatialReference}))[0]});return function(l){return e.apply(this,arguments)}}()))).filter(e=>0<e.featureSet.features.length),0<a.length)?a:null});return function(a){return b.apply(this,arguments)}}();g.queryFlagByHitTest=function(b,a,c){return this._lookupFlagByHit(b).then(d=>{if(0<d.length){const f=
[...this._flags];d.forEach(e=>{e=e.graphic;const l=e.attributes.hasOwnProperty("GLOBALID")?e.attributes.GLOBALID:e.attributes.globalid;if(0>=f.filter(m=>m.globalId===l).length){var h=this._graphicHandler.getFlagGraphic(e.mapPoint,a,e,c);this.view.graphics.add(h);f.push({...e,type:a,globalId:e.attributes.globalid?e.attributes.globalid:e.attributes.GLOBALID,details:e,mapGraphic:h,id:f.length+1})}else null!==e.percentAlong&&(h=this._graphicHandler.getFlagGraphic(e.mapPoint,a,e,c),this.view.graphics.add(h),
f.push({...e,type:a,globalId:e.attributes.globalid?e.attributes.globalid:e.attributes.GLOBALID,details:e,mapGraphic:h,id:f.length+1}))});this._flags=f;return!0}return!1})};g.removeResultGraphicFromView=function(b){const a=this.view.graphics;b.graphicEnabled=!1;a.filter(c=>c.attributes[c.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===b.trace.globalId).forEach(c=>{this.view.graphics.remove(c)})};g.removeFlag=function(b){const a=this._flags.filter(c=>{if(c.id!==b.id)return c});this._removeGraphic(b);
this._flags=a};g.removeSelection=function(){this._highlightHandler.forEach(b=>{b&&b.remove()});this._highlightHandler=[]};g.removeTerminal=function(b,a){const c=[...this._flags];c.forEach(d=>{if(d.globalId===a.globalId&&a.selectedTerminals.includes(parseInt(b,10))){const f=a.selectedTerminals.indexOf(parseInt(b,10));d.selectedTerminals.splice(f,1)}});this._flags=c};g.removeFlagsOnLoadWatcher=function(){this._watchHandler&&null!==this._watchHandler&&this._watchHandler.remove()};g.reset=function(){this._flags=
[];this._traceResults=[];const b=[...this._traces];b.forEach(a=>{a.selected=!1});this._traces=b;this.view&&(this.view.graphics.removeAll(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}))};g.selectFeaturesById=function(b){const a=t.getObjectIdsFromElements(this._unObject,b);this._getUniqueMapLayerViews(this.view).forEach(c=>{var d,f;(null==(d=c.layer)?void 0:null==(f=d.parsedUrl)?void 0:f.path)===a[0].layerUrl&&this._highlightHandler.push(c.highlight(a[0].objectIds))})};g.selectResults=
function(b){if(0<b.length){this.removeSelection();b=this._groupResultsByNetworkSource(b);const a=[];for(const c in b)this.selectFeaturesById(b[c]),a.push(this.queryFeaturesById(b[c]));Promise.all(a).then(c=>{this.emit("select-features",{resultSet:c})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})};g.selectTraces=function(b,a){const c=[...this._traces];c.forEach(d=>{a===d.globalId&&(d.selected=b)});this._traces=c};g.selectTracesOnLoad=function(){this._unObject.hasOwnProperty("sharedNamedTraceConfigurations")&&
(this._traces=[...this._unObject.sharedNamedTraceConfigurations],this._traces.forEach(b=>{b.selected=!1;this.selectedTraces.includes(b.globalId)&&(b.selected=!0)}))};g.zoomToAsset=function(b){this.view.goTo(b).catch(a=>{console.error(a)})};g._getUniqueMapLayerViews=function(b){const a=[];b.layerViews.filter(c=>"feature"===c.layer.type||"group"===c.layer.type).forEach(c=>{"group"===c.type?c.layerViews.forEach(d=>{a.push(d)}):a.some(d=>d.layer.layerId===c.layer.layerId)||a.push(c)});return a};g._processFlags=
function(b){const a=[];b.forEach(c=>{if(null!==c.selectedTerminals&&0<c.selectedTerminals.length)c.selectedTerminals.forEach(d=>{d=new v({globalId:c.globalId,percentAlong:c.percentAlong,terminalId:d,type:c.type,isFilterBarrier:c.isFilterBarrier});a.push(d)});else{const d=new v({globalId:c.globalId,percentAlong:c.percentAlong,terminalId:null,type:c.type,isFilterBarrier:c.isFilterBarrier});a.push(d)}});return a};g._getDisplayField=function(b){const a=b.layer;let c=a.displayField;var d="";for(const f in b.attributes){const e=
f.toLowerCase();e===c.toLowerCase()&&(d=b.attributes[f],"assetgroup"===e||"assettype"===e?((d=b.attributes[a.typeIdField.toUpperCase()])||(d=b.attributes[a.typeIdField.toLowerCase()]),c=a.typeIdField,d=this._checkSubtype(a,d)):d=this._checkDomain(a.fields,f,d))}return{field:c,value:d}};g._checkSubtype=function(b,a){let c=a;null!==b.types&&0<b.types.length&&(b=b.types.filter(d=>d.id===a),0<b.length&&(c=b[0].name));return c};g._checkDomain=function(b,a,c){let d=c;b=b.filter(f=>f.name.toLowerCase()===
a.toLowerCase());0<b.length&&null!==b[0].domain&&(b=b[0].domain.codedValues.filter(f=>f.code===c),0<b.length&&(d=b[0].name));return d};g._groupBy=function(b,a){return b.reduce((c,d)=>{(c[d[a]]=c[d[a]]||[]).push(d);return c},{})};g._groupResultsByNetworkSource=function(b){return 0<b.length?b[0].hasOwnProperty("results")?this._groupBy(b[0].results.elements,"networkSourceId"):this._groupBy(b,"networkSourceId"):b.hasOwnProperty("results")?this._groupBy(b.results.elements,"networkSourceId"):[]};g._lookupFlagByHit=
function(b){return this.view.hitTest(b.screenPoint).then(a=>{const c=[];if(0<a.results.length&&(a=a.results.find(e=>null!==e.layer),a.graphic&&C.isSome(a.graphic.geometry)))if("polyline"===a.graphic.geometry.type){var d=this._geometryHandler.getPercentageAlong(a.graphic.geometry,b.mapPoint,a.graphic.geometry.spatialReference),f=this._getDisplayField(a.graphic);a.graphic.terminalId=null;a.graphic.isFilterBarrier=!1;a.graphic.allTerminals=null;a.graphic.selectedTerminals=null;a.graphic.percentAlong=
d;a.graphic.displayValue=f;a.graphic.mapPoint=a.mapPoint;c.push(a)}else"point"!==a.graphic.geometry.type&&"polygon"!==a.graphic.geometry.type||null===this._unObject||(d=this._unObject.getTerminalConfiguration(a.graphic),f=this._getDisplayField(a.graphic),a.graphic.terminalId=d?d.terminals[0].id?d.terminals[0].id:null:1,a.graphic.isFilterBarrier=!1,a.graphic.allTerminals=d?d:null,a.graphic.selectedTerminals=[d?d.terminals[0].id?d.terminals[0].id:null:1],a.graphic.percentAlong=null,a.graphic.displayValue=
f,a.graphic.mapPoint=a.mapPoint,c.push(a));return c})};g._populateOutfields=function(){var b=q._asyncToGenerator(function*(){const a=this.view.map,c=this.getValidSources();a.layers.forEach(d=>{"group"===d.type?d.layers.forEach(f=>{c.some(e=>e.layerId===f.layerId)&&f.fields.some(e=>"assetgroup"===e.name.toLowerCase())&&(f.outFields=["assetgroup","assettype","globalid","objectid"])}):c.some(f=>f.layerId===d.layerId)&&d.fields.some(f=>"assetgroup"===f.name.toLowerCase())&&(d.outFields=["assetgroup",
"assettype","globalid","objectid"])})});return function(){return b.apply(this,arguments)}}();g._removeGraphic=function(b){this.view.graphics.remove(b.mapGraphic)};q._createClass(r,[{key:"state",get:function(){var b;return null!=(b=this.view)&&b.ready?"ready":"loading"}},{key:"view",get:function(){return this._get("view")},set:function(b){b&&"2d"!==b.type&&K.error(new z("view:invalid-view","SceneView is not supported",{view:b}));this._set("view",b)}}]);return r}(A.HandleOwnerMixin(k.EventedAccessor));
n.__decorate([p.property()],k.prototype,"_activeProgress",void 0);n.__decorate([p.property()],k.prototype,"_flags",void 0);n.__decorate([p.property()],k.prototype,"_traces",void 0);n.__decorate([p.property()],k.prototype,"_traceResults",void 0);n.__decorate([p.property()],k.prototype,"defaultGraphicColor",void 0);n.__decorate([p.property()],k.prototype,"flags",void 0);n.__decorate([p.property()],k.prototype,"gdbVersion",void 0);n.__decorate([p.property()],k.prototype,"selectedTraces",void 0);n.__decorate([p.property()],
k.prototype,"selectOnComplete",void 0);n.__decorate([p.property()],k.prototype,"showGraphicsOnComplete",void 0);n.__decorate([p.property()],k.prototype,"showSelectionAttributes",void 0);n.__decorate([p.property({readOnly:!0})],k.prototype,"state",null);n.__decorate([p.property({value:null})],k.prototype,"view",null);return k=n.__decorate([E.subclass("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],k)});