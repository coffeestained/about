// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.24/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../core/CircularArray ../core/maybe ./geohashUtils ../geometry/SpatialReference ../layers/graphics/featureConversionUtils ../layers/graphics/OptimizedGeometry ../layers/graphics/data/projectionSupport ../views/2d/layers/features/support/FeatureSetReaderJSON".split(" "),function(F,G,M,B,N,O,H,I,P,J){let Q=function(){function y(b=[],a,f=8096){this.onRelease=g=>{};this._nodes=0;this._root=new E(this,0,0,0);this._statisticFields=b;this._pool=f?new M(8096):
null;this._serviceInfo=a}var u=y.prototype;u.destroy=function(){this.clear()};u._acquire=function(b,a,f){this._nodes++;let g=null;B.isSome(this._pool)&&(g=this._pool.dequeue());B.isSome(g)?g.realloc(b,a,f):g=new E(this,b,a,f);return g};u._release=function(b){this.onRelease(b);this._nodes--;B.isSome(this._pool)&&this._pool.enqueue(b)};u.dropLevels=function(b){this.forEach(a=>{if(a.depth>=b)for(let f=0;f<a.children.length;f++){const g=a.children[f];g&&this._release(g)}});this.forEach(a=>{if(a.depth>=
b)for(let f=0;f<a.children.length;f++)a.children[f]=null})};u.clear=function(){this.forEach(b=>this._release(b));this._root=new E(this,0,0,0)};u.insert=function(b,a,f=0){const g=J.FeatureSetReaderJSON.fromOptimizedFeatures([b],this._serviceInfo).getCursor();g.next();const m=g.readGeometry();if(m){var [c,e]=m.coords;this.insertCursor(g,b.displayId,c,e,b.geohashX,b.geohashY,a,f)}};u.insertCursor=function(b,a,f,g,m,c,e,d=0){let h=this._root,k=0,n=0,l=0;for(;null!==h;){h.depth>=d&&(h.count+=1,h.xTotal+=
f,h.yTotal+=g,h.xGeohashTotal+=m,h.yGeohashTotal+=c,h.referenceId=a,this._updateStatisticsCursor(b,h,1));if(k>=e){h.add(a);break}var r=Math.ceil((k+1)/2),t=Math.floor((k+1)/2);const p=1-k%2;var q=30-(3*r+2*t);r=30-(2*r+3*t);q=(m&7*p+3*(1-p)<<q)>>q;r=(c&3*p+7*(1-p)<<r)>>r;t=q+r*(8*p+4*(1-p));const v=2*p+3*(1-p);n=n<<3*p+2*(1-p)|q;l=l<<v|r;null==h.children[t]&&(h.children[t]=this._acquire(n,l,k+1));k+=1;h=h.children[t]}};u.remove=function(b,a){const f=J.FeatureSetReaderJSON.fromOptimizedFeatures([b],
this._serviceInfo).getCursor();f.next();const g=f.readGeometry();if(g){var [m,c]=g.coords;this.removeCursor(f,m,c,b.geohashX,b.geohashY,a)}};u.removeCursor=function(b,a,f,g,m,c){let e=this._root,d=0;for(;null!==e;){--e.count;e.xTotal-=a;e.yTotal-=f;e.xGeohashTotal-=g;e.yGeohashTotal-=m;this._updateStatisticsCursor(b,e,-1);if(d>=c){e.remove(b.getDisplayId());break}var h=Math.ceil((d+1)/2);const l=Math.floor((d+1)/2);var k=1-d%2,n=30-(3*h+2*l);h=30-(2*h+3*l);k=((g&7*k+3*(1-k)<<n)>>n)+((m&3*k+7*(1-k)<<
h)>>h)*(8*k+4*(1-k));n=e.children[k];1===n.count&&(this._release(n),e.children[k]=null);d+=1;e=n}};u.forEach=function(b){let a=this._root;for(;null!==a;){const f=this._linkChildren(a)||a.next;b(a);a=f}};u.find=function(b,a,f){return this._root.find(b,a,f,0,0,0)};u.findIf=function(b){let a=null;this.forEach(f=>{b(f)&&(a=f)});return a};u.findAllIf=function(b){const a=[];this.forEach(f=>{b(f)&&a.push(f)});return a};u.findSingleOccupancyNode=function(b,a,f,g,m){let c=this._root;for(;null!==c;){var e=
c.depth,d=c.xNode,h=c.yNode;const q=1-e%2;var k=c.xGeohashTotal/c.count,n=c.yGeohashTotal/c.count;if(1===c.count&&b<k&&k<=f&&a<n&&n<=g)return c;if(e>=m)c=c.next;else{n=Math.ceil((e+1)/2);e=Math.floor((e+1)/2);k=30-(3*n+2*e);var l=30-(2*n+3*e),r=~((1<<k)-1),t=~((1<<l)-1);d<<=3*q+2*(1-q);h<<=2*q+3*(1-q);e=Math.max(d,(b&r)>>k);n=Math.max(h,(a&t)>>l);k=Math.min(d+8*q+4*(1-q),(f&r)>>k);l=Math.min(h+4*q+8*(1-q),(g&t)>>l);for(r=t=null;n<=l;n++)for(let p=e;p<=k;p++){const v=c.children[p-d+(n-h)*(8*q+4*(1-
q))];v&&(t||(t=v,t.next=c.next),r&&(r.next=v),r=v,v.next=c.next)}c=t||c.next}}return null};u.getRegionDisplayIds=function(b,a,f,g,m){let c=this._root;const e=[];for(;null!==c;){var d=c.depth,h=c.xNode,k=c.yNode;if(d>=m)d=c.xGeohashTotal/c.count,h=c.yGeohashTotal/c.count,b<=d&&d<=f&&a<=h&&h<=g&&c.displayIds.forEach(v=>e.push(v)),c=c.next;else{var n=Math.ceil((d+1)/2),l=Math.floor((d+1)/2);d=1-d%2;var r=30-(3*n+2*l),t=30-(2*n+3*l),q=~((1<<r)-1),p=~((1<<t)-1);h<<=3*d+2*(1-d);k<<=2*d+3*(1-d);n=Math.max(h,
(b&q)>>r);l=Math.max(k,(a&p)>>t);r=Math.min(h+8*d+4*(1-d),(f&q)>>r);t=Math.min(k+4*d+8*(1-d),(g&p)>>t);for(q=p=null;l<=t;l++)for(let v=n;v<=r;v++){const w=c.children[v-h+(l-k)*(8*d+4*(1-d))];w&&(p||(p=w,p.next=c.next),q&&(q.next=w),q=w,w.next=c.next)}c=p||c.next}}return e};u.getRegionStatistics=function(b,a,f,g,m){let c=this._root,e=0,d=0,h=0;const k={};let n=0;for(;null!==c;){var l=c.depth,r=c.xNode,t=c.yNode;if(l>=m)l=c.xGeohashTotal/c.count,r=c.yGeohashTotal/c.count,b<l&&l<=f&&a<r&&r<=g&&(e+=c.count,
d+=c.xTotal,h+=c.yTotal,1===c.count&&(n=c.referenceId),this._aggregateStatistics(k,c.statistics)),c=c.next;else{var q=Math.ceil((l+1)/2),p=Math.floor((l+1)/2);l=1-l%2;var v=30-(3*q+2*p),w=30-(2*q+3*p),A=~((1<<v)-1),z=~((1<<w)-1);r<<=3*l+2*(1-l);t<<=2*l+3*(1-l);q=Math.max(r,(b&A)>>v);p=Math.max(t,(a&z)>>w);v=Math.min(r+8*l+4*(1-l),(f&A)>>v);w=Math.min(t+4*l+8*(1-l),(g&z)>>w);A=z=null;for(let C=p;C<=w;C++)for(let D=q;D<=v;D++){const x=c.children[D-r+(C-t)*(8*l+4*(1-l))];if(x)if(C!==p&&C!==w&&D!==q&&
D!==v){const K=x.xGeohashTotal/x.count,L=x.yGeohashTotal/x.count;b<K&&K<=f&&a<L&&L<=g&&(e+=x.count,d+=x.xTotal,h+=x.yTotal,1===c.count&&(n=c.referenceId),this._aggregateStatistics(k,x.statistics))}else z||(z=x,z.next=c.next),A&&(A.next=x),A=x,x.next=c.next}c=z||c.next}}b=this.normalizeStatistics(k,e);return{count:e,attributes:b,xTotal:d,yTotal:h,referenceId:n}};u.getBins=function(b,a,f,g,m){const c=[];let e=this._root;for(;null!==e;){var d=e.depth,h=e.xNode,k=e.yNode;if(d>=m)c.push(e),e=e.next;else{var n=
Math.ceil((d+1)/2),l=Math.floor((d+1)/2);d=1-d%2;var r=30-(3*n+2*l),t=30-(2*n+3*l),q=~((1<<r)-1),p=~((1<<t)-1);h<<=3*d+2*(1-d);k<<=2*d+3*(1-d);n=Math.max(h,(b&q)>>r);l=Math.max(k,(a&p)>>t);r=Math.min(h+8*d+4*(1-d),(f&q)>>r);t=Math.min(k+4*d+8*(1-d),(g&p)>>t);for(q=p=null;l<=t;l++)for(let v=n;v<=r;v++){const w=e.children[v-h+(l-k)*(8*d+4*(1-d))];w&&(p||(p=w,p.next=e.next),q&&(q.next=w),q=w,w.next=e.next)}e=p||e.next}}return c};u._linkChildren=function(b){let a=null,f=null;for(let g=0;g<=b.children.length;g++){const m=
b.children[g];m&&(a||(a=m,a.next=b.next),f&&(f.next=m),f=m,m.next=b.next)}return a};u._updateStatisticsCursor=function(b,a,f){for(const e of this._statisticFields){const d=e.name,h=e.inField?b.readAttribute(e.inField):b.getComputedNumericAtIndex(e.inFieldIndex);switch(e.statisticType){case "norm":a.statistics[d]||(a.statistics[d]={});var g=b.readAttribute(e.inNormalizationField),m=a.statistics[d].onStatisticField||0,c=a.statistics[d].onStatisticNormalizationField||0;null==h||isNaN(h)||null==g||0===
g||isNaN(g)||(a.statistics[d].onStatisticField=m+f*h,a.statistics[d].onStatisticNormalizationField=c+f*g);break;case "sum":case "avg":a.statistics[d]||(a.statistics[d]={value:0,nanCount:0});g=a.statistics[d].value;m=a.statistics[d].nanCount;null==h||isNaN(h)?a.statistics[d].nanCount=m+f:a.statistics[d].value=g+f*h;break;case "avg_angle":{a.statistics[d]||(a.statistics[d]={x:0,y:0,nanCount:0});g=a.statistics[d].x;m=a.statistics[d].y;c=a.statistics[d].nanCount;const k=Math.PI/180;null==h||isNaN(h)?
a.statistics[d].nanCount=c+f:(a.statistics[d].x=g+f*Math.cos(h*k),a.statistics[d].y=m+f*Math.sin(h*k));break}case "mode":a.statistics[d]||(a.statistics[d]={}),a.statistics[d][h]=(a.statistics[d][h]||0)+f}}};u._aggregateStatistics=function(b,a){for(const f of this._statisticFields){const g=f.name;switch(f.statisticType){case "sum":case "avg":case "avg_angle":case "mode":case "norm":b[g]||(b[g]={});for(const m in a[g])b[g][m]=(b[g][m]||0)+a[g][m]}}};u.normalizeStatistics=function(b,a){const f={};for(const m of this._statisticFields){const c=
m.name;switch(m.statisticType){case "norm":var g=b[c];if(a&&null==g.onStatisticNormalizationField)break;if(a&&g.onStatisticNormalizationField){f[c]=g.onStatisticField/g.onStatisticNormalizationField;break}f[c]=0;break;case "sum":{if(!a)break;const {value:e,nanCount:d}=b[c];if(!(a-d))break;f[c]=e;break}case "avg":{if(!a)break;const {value:e,nanCount:d}=b[c];if(!(a-d))break;f[c]=e/(a-d);break}case "avg_angle":{if(!a)break;const {x:e,y:d,nanCount:h}=b[c];if(!(a-h))break;f[c]=180/Math.PI*Math.atan2(d/
(a-h),e/(a-h));break}case "mode":{g=b[c];let e=0,d=null;for(const h in g){const k=g[h];k>e&&(e=k,d=h)}f[c]="null"===d?null:d}}}return f};G._createClass(y,[{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return B.mapOr(this._pool,0,b=>b.size)}},{key:"depth",get:function(){let b=0;this.forEach(a=>b=Math.max(b,a.depth));return b}}]);return y}(),E=function(){function y(b,a,f,g){this.yTotal=this.xTotal=this.count=0;this.statistics=
{};this.referenceId=this.displayId=0;this.displayIds=new Set;this.next=null;this.yGeohashTotal=this.xGeohashTotal=this.yNode=this.xNode=this.depth=0;this._tree=b;this.children=Array(32);for(b=0;b<this.children.length;b++)this.children[b]=null;this.xNode=a;this.yNode=f;this.depth=g}var u=y.prototype;u.realloc=function(b,a,f){for(let g=0;g<this.children.length;g++)this.children[g]=null;this.xNode=b;this.yNode=a;this.depth=f;this.next=null;this.count=this.yTotal=this.xTotal=this.referenceId=this.displayId=
this.yGeohashTotal=this.xGeohashTotal=0;this.statistics={};this.displayIds.clear();return this};u.add=function(b){this.displayIds.add(b)};u.remove=function(b){this.displayIds.delete(b)};u.getAttributes=function(){const b=this._tree.normalizeStatistics(this.statistics,this.count);b.aggregateId=this.id;b.aggregateCount=this.count;return b};u.getGeometry=function(b,a){const f=this.getLngLatBounds(),[g,m,c,e]=f;b=P.project({rings:[[[g,m],[g,e],[c,e],[c,m],[g,m]]]},O.WGS84,b);b=H.convertFromPolygon(new I,
b,!1,!1);return B.isSome(a)?H.quantizeOptimizedGeometry(new I,b,!1,!1,"esriGeometryPolygon",a,!1,!1):b};u.getLngLatBounds=function(){var b=this.depth;const a=Math.ceil(b/2);b=Math.floor(b/2);return N.decodeGeohashXY({geohashX:this.xNode<<30-(3*a+2*b),geohashY:this.yNode<<30-(2*a+3*b)},this.depth)};u.find=function(b,a,f,g,m,c){if(g>=f)return this;var e=1-g%2;const d=3*e+2*(1-e),h=2*e+3*(1-e),k=30-m-d,n=30-c-h;e=this.children[((b&7*e+3*(1-e)<<k)>>k)+((a&3*e+7*(1-e)<<n)>>n)*(8*e+4*(1-e))];return null==
e?null:e.find(b,a,f,g+1,m+d,c+h)};G._createClass(y,[{key:"id",get:function(){return`${this.xNode}.${this.yNode}`}}]);return y}();F.GeohashNode=E;F.GeohashTree=Q;Object.defineProperties(F,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});